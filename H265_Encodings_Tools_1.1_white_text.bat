@ECHO OFF


:puliziainiziale
cls
setLocal EnableExtensions EnableDelayedExpansion

for /f "tokens=1,2 delims=|" %%a in (.\saved\settings.dat) do  (
                                                                rem echo %%a
                                                                rem echo %%b
                                                                set /a "shst=%%b"
                                                                if !shst!==0 ( 
                                                                                set "status=Disattivato" 
                                                                                set "statuse=Deactivated" 
                                                                                )
                                                                if !shst!==1 (  
                                                                                set "status=Attivato"
                                                                                set "statuse=Activated"
                                                                                )
                                                                )

if exist ".\saved\language.dat" (
    goto leggilingua
) else (
    goto menuselezionelingua
)


@REM goto menuiniziale


:menuselezionelingua
cls
echo -----------------------------------------------------------------------------------------------------------------------
echo Selezione Lingua Programma - Selection Language Software  Autore: Licdom
echo -----------------------------------------------------------------------------------------------------------------------
echo 1) Italiano
echo 2) English
echo -----------------------------------------------------------------------------------------------------------------------

CHOICE /N /C:12 /M "Scegliere Lingua - Choose Language (1/2):"

if errorlevel 2 goto linguainglese
if errorlevel 1 goto linguaitaliano

:linguainglese
echo inglese > .\saved\language.dat
goto caricalinguainglese

:linguaitaliano
echo italiano > .\saved\language.dat
goto caricalinguaitaliano


:leggilingua
:menuiniziale

for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitaliano
)

if %lingua%==inglese (
    goto caricalinguainglese
)

:caricalinguainglese
set t1=H265 Encoding Tools  Author: Licdom
set t2=1) Extraction HDR10 Metadata 
set t3=2) Convert DV Metadata from textual format .xml to binary format .bin
set t4=3) Inject DV Metadata
set t5=4) Inject HDR10+ Metadata
set t6=5) Extract Dolby Vision Metadata from video file .mkv
set t7=6) Extract HDR10+ Metadata from video file .mkv
set t8=7) Delete Dolby Vision Metadata from video track .hevc
set t9=8) Delete HDR10+ Metadata from video track .hevc
set t10=9) Extract video/audio/sub tracks from video file .mkv
set t11=a) Detection crop for file video .mkv
set t12=b) Convert audio track .thd/.flac/.wav/.dts/.eac3/.ac3 ext/.aac in AC3 or AAC format
set t13=c) FFmpeg Video Clip Cutting
set t14=d) Improvements, UpScaling, Upgrading, DownScaling and DownGrading with Hardware Encoding Nvidia/Intel 
set t15=e) Hardware Encoding with GPU Nvidia/Intel 
set t16=f) Software Encoding with CPU FFmpeg
set t17=g) Insert, Read, Delete, Start Queued Encodings and Saving to Disk 
set t18=s) Settings to Shut Down Your PC When Encodings Are Completed - Status: !statuse!  
set t19=0) Exit
set t20=Choose an operation (1/2/3/4/5/6/7/8/9/a/b/c/d/e/f/g/s/0):
set t47=Choose (1/2/0):
set t57=Improvements, UpScaling, Upgrading, DownScaling and DownGrading with Hardware Encoding Intel  Author: Licdom
goto v_menuiniziale






:caricalinguaitaliano
set t1=H265 Encoding Tools  Autore: Licdom
set t2=1) Estrazione Metadati HDR10
set t3=2) Convertire Metadati DV da format testo .xml a formato binario .bin
set t4=3) Iniettare Metadati DV
set t5=4) Iniettare Metadati HDR10+
set t6=5) Estrarre Metadati Dolby Vision da file video .mkv
set t7=6) Estrarre Metadati HDR10+ da file video .mkv
set t8=7) Cancellazione Metadati Dolby Vision da traccia video .hevc
set t9=8) Cancellazione Metadati HDR10+ da traccia video .hevc
set t10=9) Estrarre tracce video/audio/sub da file video .mkv
set t11=a) Rilevazione crop per file video .mkv
set t12=b) Convertire tracce audio .thd/.flac/.wav/.dts/.eac3/.ac3 ext/.aac in formato AC3 o AAC
set t13=c) FFmpeg Taglio Spezzone Video
set t14=d) Miglioramenti, UpScaling, Upgrading, DownScaling e DownGrading con Codifica Hardware Nvidia/Intel 
set t15=e) Codifica Hardware con GPU Nvidia/Intel 
set t16=f) Codifica Software con CPU FFmpeg 
set t17=g) Inserimento, Lettura, Cancellazione, Avvio Codifiche in Coda e Salvataggio sul Disco. 
set t18=s) Impostazioni Spegnimento PC a Codifiche Terminate - Status: !status!  
set t19=0) Uscire
set t20=Scegliere un'operazione (1/2/3/4/5/6/7/8/9/a/b/c/d/e/f/g/s/0):
set t47=Scegliere (1/2/0):
set t57=Miglioramenti, UpScaling, Upgrading, DownScaling e DownGraded con Codifica Hardware Intel  Autore: Licdom
goto v_menuiniziale




:v_menuiniziale
cls
echo -----------------------------------------------------------------------------------------------------------------------
echo !t1!
echo -----------------------------------------------------------------------------------------------------------------------
echo HDR Scripts
echo -----------
echo !t2!
echo !t3!
echo !t4!
echo !t5!
echo !t6!
echo !t7!
echo !t8!
echo !t9!
echo !t10!
echo.
echo Encoding Scripts
echo ----------------
echo !t11!
echo !t12!
echo !t13!
echo !t14!
echo !t15!
echo !t16!
echo !t17!
echo -----------------------------------------------------------------------------------------------------------------------
echo !t18!
echo -----------------------------------------------------------------------------------------------------------------------
echo !t19!
echo -----------------------------------------------------------------------------------------------------------------------

CHOICE /N /C:123456789abcdefgs0 /M "!t20!"


if errorlevel 18 goto finescript
if errorlevel 17 goto ImpostazioniSpegnimentoPC

if errorlevel 16 goto InsertMoviesInSpoolMenu
if errorlevel 15 goto FFmpegSempliceCodifica
if errorlevel 14 goto HardwareEncodingMenu
if errorlevel 13 goto UpScalingDownScalingUpGradingDownGradedMenu

if errorlevel 12 goto TaglioSpezzoneVideo
if errorlevel 11 goto conversioneaudio
if errorlevel 10 goto detectcrop

if errorlevel 9 goto avviaregmkv
if errorlevel 8 goto deleteHDR10plus
if errorlevel 7 goto deleteDV
if errorlevel 6 goto estrazioneHDR10plusdaMKV
if errorlevel 5 goto estrazioneDVdaMKV
if errorlevel 4 goto iniettarehdr10plus
if errorlevel 3 goto iniettaredv
if errorlevel 2 goto convertdv
if errorlevel 1 goto hdr10reader



:InsertMoviesInSpoolMenu

for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoInsertMoviesInSpoolMenu
)

if %lingua%==inglese (
    goto caricalinguaingleseInsertMoviesInSpoolMenu
)

:caricalinguaingleseInsertMoviesInSpoolMenu
set t21=Insert, Read, Delete, Start Queued Encodings and Saving to Disk  Author: Licdom
set t22=Select Operation to Perform
set t23=1) Inserting Encoding into the Queue and Saving to Disk
set t24=2) Reading Encodings Saved on Disk
set t25=3) Erasing Encodings Saved on Disk
set t26=4) Start Encodings Saved to Disk
set t27=0) Back to Main Menu
set t28=Choose (1/2/3/4/0):
goto visualizzaInsertMoviesInSpoolMenu

:caricalinguaitalianoInsertMoviesInSpoolMenu
set t21=Inserimento, Lettura, Cancellazione, Avvio Codifiche in Coda  e Salvataggio sul Disco.  Autore: Licdom
set t22=Selezionare Operazione da Eseguire
set t23=1) Inserimento Codifiche in Coda e Salvattaggio su Disco
set t24=2) Lettura Codifiche Salvate su Disco
set t25=3) Cancellazione Codifiche Salvate su Disco
set t26=4) Avvio Codifiche Salvate su Disco
set t27=0) Tornare al Menu' Principale
set t28=Scegliere (1/2/3/4/0):
goto visualizzaInsertMoviesInSpoolMenu


:visualizzaInsertMoviesInSpoolMenu
cls
echo -----------------------------------------------------------------------------------------------------------------------
echo !t21!
echo -----------------------------------------------------------------------------------------------------------------------
echo !t22!
echo ----------------------------------
echo !t23!
echo !t24!
echo !t25!
echo !t26!
echo -----------------------------------------------------------------------------------------------------------------------
echo !t27!
echo -----------------------------------------------------------------------------------------------------------------------

CHOICE /N /C:12340 /M "!t28!"

if errorlevel 5 goto menuiniziale

if errorlevel 4 goto AvvioCodificheSalvatesuDisco
if errorlevel 3 goto CancellazioneCodificheSalvatesuDisco
if errorlevel 2 goto LetturaCodificheSalvatesuDisco
if errorlevel 1 goto InserimentoCodifcaInCodaeSalvataggioSuDisco




:InserimentoCodifcaInCodaeSalvataggioSuDisco

for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoInserimentoCodifcaInCodaeSalvataggioSuDisco
)

if %lingua%==inglese (
    goto caricalinguaingleseInserimentoCodifcaInCodaeSalvataggioSuDisco
)

:caricalinguaingleseInserimentoCodifcaInCodaeSalvataggioSuDisco
set t27=0) Back to Main Menu
set t32=Inserting Encoding into the Queue and Saving to Disk  Author: Licdom
set t33=Select Encoding Type to Save to Disk
set t34=1) FFmpeg Software Encoding with CPU 2160p and 1080p from Video 2160p
set t35=2) FFmpeg Software Encoding with CPU H265
set t36=3) Hardware Encoding with GPU 2160p Light Cleaning and Detail Enhancement
set t37=4) Hardware Encoding with GPU H265
set t38=5) Hardware Encoding with GPU UpScaling and UpGrading from 1080p 8/10 bit SDR to 2160p 10 bit HDR10
set t39=6) Hardware Encoding with GPU UpScaling from 1080p 10 bit HDR to 2160p 10 bit HDR10
set t40=7) Hardware Encoding with GPU UpGrading from 2160p 8/10 bit SDR to 2160p 10 bit HDR10
set t41=8) Hardware Encoding with GPU Downgrading from 2160p/1080p 10 bit HDR10 to 8 bit SDR
set t42=9) Hardware Encoding with GPU Downgrading and Downscaling from 2160p 10 bit HDR to 1080p 8 bit SDR
set t43=a) Hardware Encoding with GPU Downgrading from 1080p 10 bit SDR to 1080p 8 bit SDR
set t44=b) Back to Menu Insert, Read, Delete, Start Queued Encodings and Saving to Disk
set t45=Choose (1/2/3/4/5/6/7/8/9/a/b/0):
goto visualizzaInserimentoCodifcaInCodaeSalvataggioSuDisco

:caricalinguaitalianoInserimentoCodifcaInCodaeSalvataggioSuDisco
set t27=0) Tornare al Menu' Principale
set t32=Inserimento Codifiche in Coda e Salvataggio sul Disco  Autore: Licdom
set t33=Selezionare Tipo di Codifica da Salvare sul Disco
set t34=1) FFmpeg Codifica Software con CPU 2160p e 1080p da Video 2160p
set t35=2) FFmpeg Codifica Software con CPU H265
set t36=3) Codifica Hardware con GPU 2160p Pulizia Leggera e Miglioramento Dettagli
set t37=4) Codifica Hardware con GPU H265
set t38=5) Codifica Hardware UpScaling e UpGrading da 1080p 8/10 bit SDR a 2160p 10 bit HDR10
set t39=6) Codifica Hardware UpScaling da 1080p 10 bit HDR a 2160p 10 bit HDR10
set t40=7) Codifica Hardware UpGrading da 2160p 8/10 bit SDR a 2160p 10 bit HDR10
set t41=8) Codifica Hardware Downgrading da 2160p/1080p 10 bit HDR10 a 8 bit SDR
set t42=9) Codifica Hardware Downgrading e Downscaling da 2160p 10 bit HDR a 1080p 8 bit SDR
set t43=a) Codifica Hardware Downgrading da 1080p 10 bit SDR a 1080p 8 bit SDR
set t44=b) Torna al Menu' Inserimento, Lettura, Cancellazione, Avvio Codifiche in Coda e Salvataggio sul Disco. 
set t45=Scegliere (1/2/3/4/5/6/7/8/9/a/b/0):
goto visualizzaInserimentoCodifcaInCodaeSalvataggioSuDisco



:visualizzaInserimentoCodifcaInCodaeSalvataggioSuDisco
cls
echo -----------------------------------------------------------------------------------------------------------------------
echo !t32!
echo -----------------------------------------------------------------------------------------------------------------------
echo !t33!
echo -------------------------------------------------
echo !t34!
echo !t35!
echo !t36!
echo !t37!
echo !t38!
echo !t39!
echo !t40!
echo !t41!
echo !t42!
echo !t43!
echo -----------------------------------------------------------------------------------------------------------------------
echo !t44!
echo -----------------------------------------------------------------------------------------------------------------------
echo !t27!
echo -----------------------------------------------------------------------------------------------------------------------


CHOICE /N /C:123456789ab0 /M "!t45!"

if errorlevel 12 goto menuiniziale
if errorlevel 11 goto InsertMoviesInSpoolMenu

if errorlevel 10 goto InserimentoCodificaHardwareDowngradingda1080p10bitSDRa1080p8bitSDR
if errorlevel 9 goto InserimentoCodificaHardwareDowngradingPiuDownscalingda2160p10bitHDRa1080p8bitSDR
if errorlevel 8 goto InserimentoCodificaHardwareDowngradingda2160p1080p10bitHDR10a8bitSDR
if errorlevel 7 goto InserimentoCodificaHardwareUpGradingda2160p810bitSDRa2160p10bitHDR10
if errorlevel 6 goto InserimentoCodificaHardwareUpScalingda1080p10bitHDRa2160p10bitHDR10
if errorlevel 5 goto InserimentoCodificaHardwareUpScalingPiuUpGradingda1080p810bitSDRa2160p10bitHDR10
if errorlevel 4 goto InserimentoCodificaHardwareH265
if errorlevel 3 goto InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
if errorlevel 2 goto InserimentoFFmpegCodificaSoftwareH265
if errorlevel 1 goto InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p






:HardwareEncodingMenu

for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoHardwareEncodingMenu
)

if %lingua%==inglese (
    goto caricalinguaingleseHardwareEncodingMenu
)

:caricalinguaingleseHardwareEncodingMenu
set t27=0) Back to Main Menu
set t29=Hardware Encoding with GPU Nvidia/Intel  Author: Licdom
set t30=Select GPU for Hardware Encoding
set t31=Choosee (1/2/0):
goto visualizzaHardwareEncodingMenu

:caricalinguaitalianoHardwareEncodingMenu
set t27=0) Tornare al Menu' Principale
set t29=Codifica Hardware con GPU Nvidia/Intel  Autore: Licdom
set t30=Selezionare Scheda Grafica per Coodifica Hardware
set t31=Scegliere (1/2/0):
goto visualizzaHardwareEncodingMenu

:visualizzaHardwareEncodingMenu
cls
echo -----------------------------------------------------------------------------------------------------------------------
echo !t29!
echo -----------------------------------------------------------------------------------------------------------------------
echo !t30!
echo -------------------------------------------------
echo 1) Nvidia
echo 2) Intel
echo -----------------------------------------------------------------------------------------------------------------------
echo !t27!
echo -----------------------------------------------------------------------------------------------------------------------

CHOICE /N /C:120 /M "!t31!"

if errorlevel 3 goto menuiniziale
if errorlevel 2 goto SempliceCodificaHardwareIntel
if errorlevel 1 goto SempliceCodificaHardwareNVidia





:UpScalingDownScalingUpGradingDownGradedMenu

for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoUpScalingDownScalingUpGradingDownGradedMenu
)

if %lingua%==inglese (
    goto caricalinguaingleseUpScalingDownScalingUpGradingDownGradedMenu
)

:caricalinguaingleseUpScalingDownScalingUpGradingDownGradedMenu
set t27=0) Back to Main Menu
set t30=Select GPU for Hardware Encoding
set t46=Improvements, UpScaling, Upgrading, DownScaling and DownGrading with Hardware Encoding Nvidia/Intel  Author: Licdom
goto visualizzaUpScalingDownScalingUpGradingDownGradedMenu

:caricalinguaitalianoUpScalingDownScalingUpGradingDownGradedMenu
set t27=0) Tornare al Menu' Principale
set t30=Selezionare Scheda Grafica per Coodifica Hardware
set t46=Miglioramenti, UpScaling, Upgrading, DownScaling e DownGraded con Codifica Hardware Nvidia/Intel  Autore: Licdom
goto visualizzaUpScalingDownScalingUpGradingDownGradedMenu

:visualizzaUpScalingDownScalingUpGradingDownGradedMenu
cls
echo -----------------------------------------------------------------------------------------------------------------------
echo !t46!
echo -----------------------------------------------------------------------------------------------------------------------
echo !t30!
echo -------------------------------------------------
echo 1) Nvidia
echo 2) Intel
echo -----------------------------------------------------------------------------------------------------------------------
echo !t27!
echo -----------------------------------------------------------------------------------------------------------------------

CHOICE /N /C:120 /M "!t47!"

if errorlevel 3 goto menuiniziale
if errorlevel 2 goto IntelUpScalingMenu
if errorlevel 1 goto NvidiaUpScalingMenu




:NvidiaUpScalingMenu

for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoNvidiaUpScalingMenu
)

if %lingua%==inglese (
    goto caricalinguaingleseNvidiaUpScalingMenu
)

:caricalinguaingleseNvidiaUpScalingMenu
set t27=0) Back to Main Menu
set t48=Improvements, UpScaling, Upgrading, DownScaling and DownGrading with Hardware Encoding Nvidia  Author: Licdom
set t49=1) NVEnc UpScaling and UpGrading from 1080p 8bit or 10bit SDR to 2160p 10bit HDR10
set t50=2) NVEnc UpGrading from 2160p 8bit or 10bit SDR to 2160p 10bit HDR10 
set t51=3) NVEnc UpScaling from 1080p 10bit HDR10 to 2160p 10bit HDR10
set t52=4) NVEnc DownGrading from 2160p or 1080p 10bit HDR to 8bit SDR
set t53=5) NVEnc DownGrading and DownScaling from 2160p 10bit HDR to 1080p 8bit SDR
set t54=6) NVEnc DownGrading from 1080p 10bit SDR to 1080p 8bit SDR
set t55=7) NVEnc Denoiser and Detail Enhancement 2160p 10bit HDR
set t56=Select encoding to perform (1/2/3//4/5/6/7/0):
goto visualizzaNvidiaUpScalingMenu

:caricalinguaitalianoNvidiaUpScalingMenu
set t27=0) Tornare al Menu' Principale
set t48=Miglioramenti, UpScaling, Upgrading, DownScaling e DownGraded con Codifica Hardware Nvidia  Autore: Licdom
set t49=1) NVEnc UpScaling e UpGrading da 1080p 8bit o 10bit SDR a 2160p 10bit HDR10
set t50=2) NVEnc UpGrading da 2160p 8bit o 10bit SDR a 2160p 10bit HDR10 
set t51=3) NVEnc UpScaling da 1080p 10bit HDR10 a 2160p 10bit HDR10
set t52=4) NVEnc DownGrading da 2160p o 1080p 10bit HDR a 8bit SDR
set t53=5) NVEnc DownGrading DownScaling da 2160p 10bit HDR a 1080p 8bit SDR
set t54=6) NVEnc DownGrading da 1080p 10bit SDR a 1080p 8bit SDR
set t55=7) NVEnc Denoiser e Miglioramento Dettagli 2160p 10bit HDR
set t56=Scegliere codifica da eseguire (1/2/3//4/5/6/7/0):
goto visualizzaNvidiaUpScalingMenu

:visualizzaNvidiaUpScalingMenu
cls
echo -----------------------------------------------------------------------------------------------------------------------
echo !t48!
echo -----------------------------------------------------------------------------------------------------------------------
echo !t49!
echo !t50!
echo !t51!
echo !t52!
echo !t53!
echo !t54!
echo !t55!
echo -----------------------------------------------------------------------------------------------------------------------
echo !t27!
echo -----------------------------------------------------------------------------------------------------------------------


CHOICE /N /C:12345670 /M "!t56!"

if errorlevel 8 goto menuiniziale

if errorlevel 7 goto NVEncPuliziaLeggeraDettagliMigliorati
if errorlevel 6 goto NVEncDownGrade1080p10bitSDRto1080p8bitSDR
if errorlevel 5 goto NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if errorlevel 4 goto NVEncDownGrade2160p10bitHDRto2160p8bitSDR
if errorlevel 3 goto NVEncUpScaling1080p10bitHDR
if errorlevel 2 goto NVEncUpGrading
if errorlevel 1 goto NVEncUpScaling




:IntelUpScalingMenu

for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoIntelUpScalingMenu
)

if %lingua%==inglese (
    goto caricalinguaingleseIntelUpScalingMenu
)

:caricalinguaingleseIntelUpScalingMenu
set t27=0) Back to Main Menu
set t56=Select encoding to perform (1/2/3//4/5/6/7/0):
set t58=1) QSVEnc UpScaling and UpGrading from 1080p 8bit or 10bit SDR to 2160p 10bit HDR10
set t59=2) QSVEnc UpGrading from 2160p 8bit or 10bit SDR to 2160p 10bit HDR10 
set t60=3) QSVEnc UpScaling from 1080p 10bit HDR10 to 2160p 10bit HDR10
set t61=4) QSVEnc DownGrading from 2160p or 1080p 10bit HDR to 8bit SDR
set t62=5) QSVEnc DownGrading and DownScaling from 2160p 10bit HDR to 1080p 8bit SDR
set t63=6) QSVEnc DownGrading from 1080p 10bit SDR to 1080p 8bit SDR
set t64=7) QSVEnc Denoiser and Detail Enhancement 2160p 10bit HDR
goto visualizzaIntelUpScalingMenu

:caricalinguaitalianoIntelUpScalingMenu
set t27=0) Tornare al Menu' Principale
set t56=Scegliere codifica da eseguire (1/2/3//4/5/6/7/0):
set t58=1) QSVEnc UpScaling e UpGrading da 1080p 8bit o 10bit SDR a 2160p 10bit HDR10
set t59=2) QSVEnc UpGrading da 2160p 8bit o 10bit SDR a 2160p 10bit HDR10 
set t60=3) QSVEnc UpScaling da 1080p 10bit HDR10 a 2160p 10bit HDR10
set t61=4) QSVEnc DownGrading da 2160p o 1080p 10bit HDR a 8bit SDR
set t62=5) QSVEnc DownGrading DownScaling da 2160p 10bit HDR a 1080p 8bit SDR
set t63=6) QSVEnc DownGrading da 1080p 10bit SDR a 1080p 8bit SDR
set t64=7) QSVEnc Denoiser e Miglioramento Dettagli 2160p 10bit HDR
goto visualizzaIntelUpScalingMenu

:visualizzaIntelUpScalingMenu
cls
echo -----------------------------------------------------------------------------------------------------------------------
echo !t57!
echo -----------------------------------------------------------------------------------------------------------------------
echo !t58!
echo !t59!
echo !t60!
echo !t61!
echo !t62!
echo !t63!
echo !t64!
echo -----------------------------------------------------------------------------------------------------------------------
echo !t27!
echo -----------------------------------------------------------------------------------------------------------------------


CHOICE /N /C:12345670 /M "!t56!"

if errorlevel 8 goto menuiniziale

if errorlevel 7 goto QSVEncPuliziaLeggeraDettagliMigliorati
if errorlevel 6 goto QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
if errorlevel 5 goto QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if errorlevel 4 goto QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
if errorlevel 3 goto QSVEncUpScaling1080p10bitHDR
if errorlevel 2 goto QSVEncUpGrading
if errorlevel 1 goto QSVEncUpScaling



Endlocal






rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:AvvioCodificheSalvatesuDisco

cls

setLocal EnableExtensions EnableDelayedExpansion

for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoAvvioCodificheSalvatesuDisco
)

if %lingua%==inglese (
    goto caricalinguaingleseAvvioCodificheSalvatesuDisco
)



:caricalinguaingleseAvvioCodificheSalvatesuDisco
set t1=Start Encodings Saved to Disk...
set t2=Encoding
set t3=Started...
set t4=Encoding Type:
set t5=Software Enconding with CPU FFmpeg
set t6=Input Video File:
set t7=Output Video File:
set t8=Encoding Type:
set t9=Encoding Quality:
set t10=Encoding Quantization Type:
set t11=Intensity Encoding Quantization:
set t12=Output Video Format:
set t13=Output 2160p Video File:
set t14=Output 1080p Video File:
set t15=Output 2160p Video Resolution:
set t16=Output 1080p Video Resolution:
set t17=Video Encoding Type 2160p:
set t18=Video Encoding Type 1080p:
set t19=Output 2160p Video Format:
set t20=Output 1080p Video Format:
set t21=Detail Enhancement:
set t22=Motion Vector Precision:
set t23=Output Video Resolution:
set t24=1-Pass UpScaling:
set t25=Input 1080p Video Resolution:
set t26=Software Encoding FFmpeg 2160p and 1080p from 2160p
set t27=Hardware Encoding Nvidia NVEnc 2160p Light Cleaning and Detail Enhancement
set t28=Hardware Encoding Intel QSVEnc 2160p Light Cleaning and Detail Enhancement
set t29=Hardware Encoding with GPU NVidia NVEnc
set t30=Hardware Encoding with GPU Intel QSVEnc
set t31=Hardware Encoding with GPU NVidia NVEnc UpScaling and UpGrading from 1080p SDR to 2160p HDR
set t32=Hardware Encoding with GPU Intel QSVEnc UpScaling and UpGrading from 1080p SDR to 2160p HDR
set t33=Hardware Encoding with GPU NVidia NVEnc UpScaling from 1080p 10bit HDR to 2160p 10bit HDR
set t34=Hardware Encoding with GPU Intel QSVEnc UpScaling from 1080p 10bit HDR to 2160p 10bit HDR
set t35=Hardware Encoding with GPU NVidia NVEnc UpGrading from 2160p 8bit or 10bit SDR to 2160p 10bit HDR
set t36=Hardware Encoding with GPU Intel QSVEnc UpGrading from 2160p 8bit or 10bit SDR to 2160p 10bit HDR
set t37=Hardware Encoding with GPU NVidia NVEnc DownGrading from 2160p o 1080p 10bit HDR to 8bit SDR
set t38=Hardware Encoding with GPU Intel QSVEnc DownGrading from 2160p o 1080p 10bit HDR to 8bit SDR
set t39=Hardware Encoding with GPU NVidia NVEnc DownGrading and DownScaling from 2160p 10bit HDR to 1080p 8bit SDR
set t40=Hardware Encoding with GPU Intel QSVEnc DownGrading and DownScaling from 2160p 10bit HDR to 1080p 8bit SDR
set t41=Hardware Encoding with GPU NVidia NVEnc DownGrading from 1080p 10bit SDR to 1080p 8bit SDR
set t42=Hardware Encoding with GPU Intel QSVEnc DownGrading from 1080p 10bit SDR to 1080p 8bit SDR
set t43=FFmpeg Software Encoding Completed.... 
set t44=2160p Encoding Started... 
set t45=2160p Video Encoding Completed.
set t46=1080p Encoding Started... 
set t47=1080p Video Encoding Completed.
set t48=Nvidia NVEnc 2160p Hardware Encoding Light Cleaning and Detail Enhancement Completed.
set t49=Intel QSVEnc 2160p Hardware Encoding Light Cleaning and Detail Enhancement Completed.
set t50=Hardware Encoding NVidia Completed.
set t51=Hardware Encoding Intel Completed.
set t52=UpScaling Started.... 
set t53=Denoiser and Detail Enhancement Application Started.... 
set t54=UpScaling, Denoiser and Detail Enhancement Started.... 
set t55=NVidia Hardware Encoding UpScaling and UpGrading from 1080p 8bit SDR to 2160p 10bit HDR Completed.
set t56=Intel Hardware Encoding UpScaling and UpGrading from 1080p 8bit SDR to 2160p 10bit HDR Completed.
set t57=NVidia Hardware Encoding UpScaling from 1080p 10bit HDR to 2160p 10bit HDR Completed.
set t58=Intel Hardware Encoding UpScaling from 1080p 10bit HDR to 2160p 10bit HDR Completed.
set t59=NVidia Hardware Encoding UpgGrading from 2160p 8-bit or 10-bit SDR to 2160p 10-bit HDR Completed.
set t60=Intel Hardware Encoding UpgGrading from 2160p 8-bit or 10-bit SDR to 2160p 10-bit HDR Completed.
set t61=NVidia Hardware Encoding Downgrading from 2160p or 1080p 10-bit HDR to 8-bit SDR Completed.
set t62=Intel Hardware Encoding Downgrading from 2160p or 1080p 10-bit HDR to 8-bit SDR Completed.
set t63=NVidia Hardware Encoding DownScaling and DownGrading from 2160p 10-bit HDR to 1080p 8-bit SDR Completed.
set t64=Intel Hardware Encoding DownScaling and DownGrading from 2160p 10-bit HDR to 1080p 8-bit SDR Completed.
set t65=NVidia Hardware Encoding Downgrading from 1080p 10-bit SDR to 1080p 8-bit SDR Completed.
set t66=Intel Hardware Encoding Downgrading from 1080p 10-bit SDR to 1080p 8-bit SDR Completed.
set t67=Now the PC will be turned off... 
set t68=Press Enter to back to Menu Insert, Read, Delete, Start Queued Encodings and Saving to Disk 
set t1000=Now the PC will be turned off... 

goto avvio_codifiche_salvate_su_disco_script




:caricalinguaitalianoAvvioCodificheSalvatesuDisco
set t1=Avvio Codifiche Salvate su Disco...
set t2=Codifica
set t3=Avviata...
set t4=Tipo di Codifica:
set t5=Codifica Software con CPU FFmpeg
set t6=Video File di Input:
set t7=Video File di Output:
set t8=Tipo Codifica:
set t9=Qualita' Codifica:
set t10=Tipo Quantizzazione Codifica:
set t11=Intensita' Quantizzazione Codifica:
set t12=Formato Video di Output:
set t13=Video File 2160p di Output:
set t14=Video File 1080p di Output:
set t15=Risoluzione Video 2160p di Output:
set t16=Risoluzione Video 1080p di Output:
set t17=Tipo Codifica Video 2160p:
set t18=Tipo Codifica Video 1080p:
set t19=Formato Video 2160p di Output:
set t20=Formato Video 1080p di Output:
set t21=Miglioramento Dettagli:
set t22=Precisione Vettore Movimento:
set t23=Risoluzione Video di Output:
set t24=UpScaling in 1 Passaggio:
set t25=Risoluzione Video 1080p di Input:
set t26=Codifica Software FFmpeg 2160p e 1080p da 2160p
set t27=Codifica Hardware Nvidia NVEnc 2160p Pulizia Leggera e Miglioramento Dettagli
set t28=Codifica Hardware Intel QSVEnc 2160p Pulizia Leggera e Miglioramento Dettagli
set t29=Codifica Hardware con GPU NVidia NVEnc
set t30=Codifica Hardware con GPU Intel QSVEnc
set t31=Codifica Hardware NVidia NVEnc UpScaling e UpGrading da 1080p SDR a 2160p HDR
set t32=Codifica Hardware Intel QSVEnc UpScaling e UpGrading da 1080p SDR a 2160p HDR
set t33=Codifica Hardware NVidia NVEnc UpScaling da 1080p 10bit HDR a 2160p 10bit HDR
set t34=Codifica Hardware Intel QsVEnc UpScaling da 1080p 10bit HDR a 2160p 10bit HDR
set t35=Codifica Hardware NVidia NVEnc UpGrading da 2160p 8bit o 10bit SDR a 2160p 10bit HDR
set t36=Codifica Hardware Intel QSVEnc UpGrading da 2160p 8bit o 10bit SDR a 2160p 10bit HDR
set t37=Codifica Hardware NVidia NVEnc DownGrading da 2160p o 1080p 10bit HDR a 8bit SDR
set t38=Codifica Hardware Intel QSVEnc DownGrading da 2160p o 1080p 10bit HDR a 8bit SDR
set t39=Codifica Hardware NVidia NVEnc DownGrading e DownScaling da 2160p 10bit HDR a 1080p 8bit SDR
set t40=Codifica Hardware Intel QSVEnc DownGrading e DownScaling da 2160p 10bit HDR a 1080p 8bit SDR
set t41=Codifica Hardware NVidia NVEnc DownGrading da 1080p 10bit SDR a 1080p 8bit SDR
set t42=Codifica Hardware Intel QSVEnc DownGrading da 1080p 10bit SDR a 1080p 8bit SDR
set t43=Codifica Software FFmpeg Terminata.... 
set t44=Codifica 2160p Avviata... 
set t45=Codifica Video 2160p Terminata.
set t46=Codifica 1080p Avviata... 
set t47=Codifica Video 1080p Terminata.
set t48=Codifica Hardware Nvidia NVEnc 2160p Pulizia Leggera e Miglioramento Dettagli Terminata.
set t49=Codifica Hardware Intel QSVEnc 2160p Pulizia Leggera e Miglioramento Dettagli Terminata.
set t50=Codifica Hardware NVidia Terminata.
set t51=Codifica Hardware Intel Terminata.
set t52=UpScaling Iniziato.... 
set t53=Applicazione Denoiser e Miglioramento Dettagli Iniziati.... 
set t54=UpScaling, Denoiser e Miglioramento Dettagli Iniziati.... 
set t55=Codifica Hardware NVidia UpScaling e UpGrading da 1080p 8bit SDR a 2160p 10bit HDR Terminata.
set t56=Codifica Hardware Intel UpScaling e UpGrading da 1080p 8bit SDR a 2160p 10bit HDR Terminata.
set t57=Codifica Hardware NVidia UpScaling da 1080p 10bit HDR a 2160p 10bit HDR Terminata.
set t58=Codifica Hardware Intel UpScaling da 1080p 10bit HDR a 2160p 10bit HDR Terminata.
set t59=Codifica Hardware NVidia UpGrading da 2160p 8 bit o 10bit SDR a 2160p 10bit HDR Terminata.
set t60=Codifica Hardware Intel UpGrading da 2160p 8 bit o 10bit SDR a 2160p 10bit HDR Terminata.
set t61=Codifica Hardware NVidia DownGrading da 2160p o 1080p 10 bit HDR a 8bit SDR Terminata.
set t62=Codifica Hardware Intel DownGrading da 2160p o 1080p 10 bit HDR a 8bit SDR Terminata.
set t63=Codifica Hardware NVidia DownScaling e DownGrading da 2160p 10 bit HDR a 1080p 8bit SDR Terminata.
set t64=Codifica Hardware Intel DownScaling e DownGrading da 2160p 10 bit HDR a 1080p 8bit SDR Terminata.
set t65=Codifica Hardware NVidia DownGrading da 1080p 10 bit SDR a 1080p 8bit SDR Terminata.
set t66=Codifica Hardware Intel DownGrading da 1080p 10 bit SDR a 1080p 8bit SDR Terminata.
set t67=Il PC ora verra' Spento... 
set t68=Premi Invio per tornare al menu' Inserimento, Lettura, Cancellazione, Avvio Codifiche in Coda e Salvataggio sul Disco.  
set t1000=Il PC ora verra' Spento... 

goto avvio_codifiche_salvate_su_disco_script




:avvio_codifiche_salvate_su_disco_script

echo !t1!
echo.

if exist ".\saved\savedmoviesallencodings.dat" (

                                                set /A "numeroriga=1"
                                                @REM echo I Video da Codificare Salvati sul Disco sono questi: 
                                                @REM echo.

                                                for /f "tokens=1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22 delims=|" %%a in (.\saved\savedmoviesallencodings.dat) do  (
                                                                                                                                                                                    echo !t2! !numeroriga! !t3!
                                                                                                                                                                                    echo.

                                                                                                                                                                                    if %%a==semplice_codifica_ffmpeg (
                                                                                                                                                                                        echo !t4! !t5!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo Video File di Output 2: %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t23! %%f
                                                                                                                                                                                        @REM echo Risoluzione Video di Output 2: %%g
                                                                                                                                                                                        echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        echo !t10! %%n
                                                                                                                                                                                        echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo.

                                                                                                                                                                                        set "NomeFile=%%b"
                                                                                                                                                                                        @REM echo NomeFile = !NomeFile!
                                                                                                                                                                                        set "NomeFileOutput=%%c"
                                                                                                                                                                                        @REM echo NomeFileOutput = !NomeFileOutput!
                                                                                                                                                                                        set "cropff=%%e"
                                                                                                                                                                                        @REM echo cropff = !cropff!
                                                                                                                                                                                        set "RisoluzioneVideo=%%f"
                                                                                                                                                                                        @REM echo RisoluzioneVideo = !RisoluzioneVideo!
                                                                                                                                                                                        set "hdrsettings=%%h"
                                                                                                                                                                                        @REM echo hdrsettings = !hdrsettings!
                                                                                                                                                                                        set "ColorPrimary=%%i"
                                                                                                                                                                                        @REM echo ColorPrimary = !ColorPrimary!
                                                                                                                                                                                        set "ColorTransfer=%%j"
                                                                                                                                                                                        @REM echo ColorTransfer = !ColorTransfer!
                                                                                                                                                                                        set "ColorMatrix=%%k"
                                                                                                                                                                                        @REM echo ColorMatrix = !ColorMatrix!
                                                                                                                                                                                        set "TipoCodifica=%%l"
                                                                                                                                                                                        @REM echo TipoCodifica = !TipoCodifica!
                                                                                                                                                                                        set "QualitaCodifica=%%m"
                                                                                                                                                                                        @REM echo QualitaCodifica = !QualitaCodifica!
                                                                                                                                                                                        set "TipoQuantizzazione=%%n"
                                                                                                                                                                                        @REM echo TipoQuantizzazione = !TipoQuantizzazione!
                                                                                                                                                                                        set "IntensitaQuantizzazione=%%o"
                                                                                                                                                                                        @REM echo IntensitaQuantizzazione = !IntensitaQuantizzazione!
                                                                                                                                                                                        set "Denoiser=%%p"
                                                                                                                                                                                        @REM echo Denoiser = !Denoiser!
                                                                                                                                                                                        set "FormatoVideo=%%q"
                                                                                                                                                                                        @REM echo FormatoVideo = !FormatoVideo!

                                                                                                                                                                                        call:Avvio_Semplice_Codifca_FFmpeg
                                                                                                                                                                                        @REM echo.
                                                                                                                                                                                        @REM echo ritorno indietro ok
                                                                                                                                                                                        @REM echo.
                                                                                                                                                                                        @REM pause

                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==codifica_ffmpeg_2160p_piu_1080p_da_2160p (
                                                                                                                                                                                        echo !t4! !t26!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t13! %%c
                                                                                                                                                                                        echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        echo !t16! %%g
                                                                                                                                                                                        echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        set "TipoCodificaDoppio=%%l"
                                                                                                                                                                                        @REM echo TipoCodificaDoppio = !TipoCodificaDoppio!
                                                                                                                                                                                        for /f "tokens=1,2 delims=x" %%a in ("!TipoCodificaDoppio!") do  (
                                                                                                                                                                                                                                                        echo !t17! %%a
                                                                                                                                                                                                                                                        set "TipoCodifica2160p=%%a"
                                                                                                                                                                                                                                                        echo !t18! %%b
                                                                                                                                                                                                                                                        set "TipoCodifica1080p=%%b"
                                                                                                                                                                                                                                                        )
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        echo !t10! %%n
                                                                                                                                                                                        echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t19! %%q
                                                                                                                                                                                        echo !t20! yuv420p
                                                                                                                                                                                        echo.
                                                                                                                                                                                    
                                                                                                                                                                                        set "NomeFile=%%b"
                                                                                                                                                                                        @REM echo NomeFile = !NomeFile!
                                                                                                                                                                                        set "NomeFileOutput4k=%%c"
                                                                                                                                                                                        @REM echo NomeFileOutput4k = !NomeFileOutput4k!
                                                                                                                                                                                        set "NomeFileOutput2k=%%d"
                                                                                                                                                                                        @REM echo NomeFileOutput2k = !NomeFileOutput2k!
                                                                                                                                                                                        set "cropff=%%e"
                                                                                                                                                                                        @REM echo cropff = !cropff!
                                                                                                                                                                                        set "RisoluzioneVideo4k=%%f"
                                                                                                                                                                                        @REM echo RisoluzioneVideo4k = !RisoluzioneVideo4k!
                                                                                                                                                                                        set "RisoluzioneVideo2k=%%g"
                                                                                                                                                                                        @REM echo RisoluzioneVideo2k = !RisoluzioneVideo2k!
                                                                                                                                                                                        set "hdrsettings=%%h"
                                                                                                                                                                                        @REM echo hdrsettings = !hdrsettings!
                                                                                                                                                                                        set "ColorPrimary=%%i"
                                                                                                                                                                                        @REM echo ColorPrimary = !ColorPrimary!
                                                                                                                                                                                        set "ColorTransfer=%%j"
                                                                                                                                                                                        @REM echo ColorTransfer = !ColorTransfer!
                                                                                                                                                                                        set "ColorMatrix=%%k"
                                                                                                                                                                                        @REM echo ColorMatrix = !ColorMatrix!
                                                                                                                                                                                        @REM set "TipoCodifica=%%l"
                                                                                                                                                                                        @REM echo TipoCodifica = !TipoCodifica!
                                                                                                                                                                                        @REM echo TipoCodifica2160p = !TipoCodifica2160p!
                                                                                                                                                                                        @REM echo TipoCodifica1080p = !TipoCodifica1080p!
                                                                                                                                                                                        set "QualitaCodifica=%%m"
                                                                                                                                                                                        @REM echo QualitaCodifica = !QualitaCodifica!
                                                                                                                                                                                        set "TipoQuantizzazione=%%n"
                                                                                                                                                                                        @REM echo TipoQuantizzazione = !TipoQuantizzazione!
                                                                                                                                                                                        set "IntensitaQuantizzazione=%%o"
                                                                                                                                                                                        @REM echo IntensitaQuantizzazione = !IntensitaQuantizzazione!
                                                                                                                                                                                        set "Denoiser=%%p"
                                                                                                                                                                                        @REM echo Denoiser = !Denoiser!
                                                                                                                                                                                        set "FormatoVideo2160p=%%q"
                                                                                                                                                                                        @REM echo FormatoVideo2160p = !FormatoVideo2160p!
                                                                                                                                                                                        set "FormatoVideo1080p=yuv420p"
                                                                                                                                                                                        @REM echo FormatoVideo1080p = !FormatoVideo1080p!

                                                                                                                                                                                        call:Avvio_Codifca_Software_FFmpeg_2160p_e_1080p_da_2160p

                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.

                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==NVEnc_2160p_denoier_pulizia (
                                                                                                                                                                                        echo !t4! !t27!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t13! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        @REM echo !t16! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t19! %%q
                                                                                                                                                                                        echo.

                                                                                                                                                                                        set "NomeFile=%%b"
                                                                                                                                                                                        set "NomeFileOutput4k=%%c"
                                                                                                                                                                                        @REM set "NomeFileOutput2k=%%d"
                                                                                                                                                                                        set "cropff=%%e"
                                                                                                                                                                                        set "RisoluzioneVideo4k=%%f"
                                                                                                                                                                                        @REM set "RisoluzioneVideo2k=%%g"
                                                                                                                                                                                        @REM set "hdrsettings=%%h"
                                                                                                                                                                                        set "ColorPrimary=%%i"
                                                                                                                                                                                        set "ColorTransfer=%%j"
                                                                                                                                                                                        set "ColorMatrix=%%k"
                                                                                                                                                                                        set "TipoCodifica=%%l"
                                                                                                                                                                                        set "QualitaCodifica=%%m"
                                                                                                                                                                                        @REM set "TipoQuantizzazione=%%n"
                                                                                                                                                                                        @REM set "IntensitaQuantizzazione=%%o"
                                                                                                                                                                                        set "Denoiser=%%p"
                                                                                                                                                                                        set "FormatoVideo2160p=%%q"

                                                                                                                                                                                        @REM echo NomeFile = !NomeFile!
                                                                                                                                                                                        @REM echo NomeFileOutput4k = !NomeFileOutput4k!
                                                                                                                                                                                        @REM echo NomeFileOutput2k = !NomeFileOutput2k!
                                                                                                                                                                                        @REM echo cropff = !cropff!
                                                                                                                                                                                        @REM echo RisoluzioneVideo4k = !RisoluzioneVideo4k!
                                                                                                                                                                                        @REM echo RisoluzioneVideo2k = !RisoluzioneVideo2k!
                                                                                                                                                                                        @REM echo hdrsettings = !hdrsettings!
                                                                                                                                                                                        @REM echo ColorPrimary = !ColorPrimary!
                                                                                                                                                                                        @REM echo ColorTransfer = !ColorTransfer!
                                                                                                                                                                                        @REM echo ColorMatrix = !ColorMatrix!
                                                                                                                                                                                        @REM echo TipoCodifica = !TipoCodifica!
                                                                                                                                                                                        @REM echo QualitaCodifica = !QualitaCodifica!
                                                                                                                                                                                        @REM echo TipoQuantizzazione = !TipoQuantizzazione!
                                                                                                                                                                                        @REM echo IntensitaQuantizzazione = !IntensitaQuantizzazione!
                                                                                                                                                                                        @REM echo Denoiser = !Denoiser!
                                                                                                                                                                                        @REM echo FormatoVideo2160p = !FormatoVideo2160p!
                                                                                                                                                                                        
                                                                                                                                                                                        call:Avvio_Codifca_Hardware_NVidia_2160p_Pulizia_Leggera_Miglioramento_Dettagli

                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==QSVEnc_2160p_denoier_pulizia (
                                                                                                                                                                                        echo !t4! !t28!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t13! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        @REM echo !t16! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t19! %%q
                                                                                                                                                                                        echo.

                                                                                                                                                                                        set "NomeFile=%%b"
                                                                                                                                                                                        set "NomeFileOutput4k=%%c"
                                                                                                                                                                                        @REM set "NomeFileOutput2k=%%d"
                                                                                                                                                                                        set "cropff=%%e"
                                                                                                                                                                                        set "RisoluzioneVideo4k=%%f"
                                                                                                                                                                                        @REM set "RisoluzioneVideo2k=%%g"
                                                                                                                                                                                        @REM set "hdrsettings=%%h"
                                                                                                                                                                                        set "ColorPrimary=%%i"
                                                                                                                                                                                        set "ColorTransfer=%%j"
                                                                                                                                                                                        set "ColorMatrix=%%k"
                                                                                                                                                                                        set "TipoCodifica=%%l"
                                                                                                                                                                                        set "QualitaCodifica=%%m"
                                                                                                                                                                                        @REM set "TipoQuantizzazione=%%n"
                                                                                                                                                                                        @REM set "IntensitaQuantizzazione=%%o"
                                                                                                                                                                                        set "Denoiser=%%p"
                                                                                                                                                                                        set "FormatoVideo2160p=%%q"

                                                                                                                                                                                        @REM echo NomeFile = !NomeFile!
                                                                                                                                                                                        @REM echo NomeFileOutput4k = !NomeFileOutput4k!
                                                                                                                                                                                        @REM echo NomeFileOutput2k = !NomeFileOutput2k!
                                                                                                                                                                                        @REM echo cropff = !cropff!
                                                                                                                                                                                        @REM echo RisoluzioneVideo4k = !RisoluzioneVideo4k!
                                                                                                                                                                                        @REM echo RisoluzioneVideo2k = !RisoluzioneVideo2k!
                                                                                                                                                                                        @REM echo hdrsettings = !hdrsettings!
                                                                                                                                                                                        @REM echo ColorPrimary = !ColorPrimary!
                                                                                                                                                                                        @REM echo ColorTransfer = !ColorTransfer!
                                                                                                                                                                                        @REM echo ColorMatrix = !ColorMatrix!
                                                                                                                                                                                        @REM echo TipoCodifica = !TipoCodifica!
                                                                                                                                                                                        @REM echo QualitaCodifica = !QualitaCodifica!
                                                                                                                                                                                        @REM echo TipoQuantizzazione = !TipoQuantizzazione!
                                                                                                                                                                                        @REM echo IntensitaQuantizzazione = !IntensitaQuantizzazione!
                                                                                                                                                                                        @REM echo Denoiser = !Denoiser!
                                                                                                                                                                                        @REM echo FormatoVideo2160p = !FormatoVideo2160p!

                                                                                                                                                                                        call:Avvio_Codifca_Hardware_Intel_2160p_Pulizia_Leggera_Miglioramento_Dettagli

                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==NVEnc_semplice_codifica_hardware (
                                                                                                                                                                                        echo !t4! !t29!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t23! %%f
                                                                                                                                                                                        @REM echo !t16! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        echo !t10! %%n
                                                                                                                                                                                        echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        @REM echo Color Correction: %%s
                                                                                                                                                                                        @REM echo UpScaling in 2 Passaggi: %%t
                                                                                                                                                                                        echo Lookahead: %%u
                                                                                                                                                                                        echo !t22! %%u
                                                                                                                                                                                        echo.

                                                                                                                                                                                        set "NomeFile=%%b"
                                                                                                                                                                                        set "NomeFileOutput4k=%%c"
                                                                                                                                                                                        @REM set "NomeFileOutput2k=%%d"
                                                                                                                                                                                        set "cropff=%%e"
                                                                                                                                                                                        set "RisoluzioneVideo4k=%%f"
                                                                                                                                                                                        @REM set "RisoluzioneVideo2k=%%g"
                                                                                                                                                                                        @REM set "hdrsettings=%%h"
                                                                                                                                                                                        set "ColorPrimary=%%i"
                                                                                                                                                                                        set "ColorTransfer=%%j"
                                                                                                                                                                                        set "ColorMatrix=%%k"
                                                                                                                                                                                        set "TipoCodifica=%%l"
                                                                                                                                                                                        set "QualitaCodifica=%%m"
                                                                                                                                                                                        set "TipoQuantizzazione=%%n"
                                                                                                                                                                                        set "IntensitaQuantizzazione=%%o"
                                                                                                                                                                                        set "Denoiser=%%p"
                                                                                                                                                                                        set "FormatoVideo2160p=%%q"
                                                                                                                                                                                        set "Val_Edgelevel=%%r"
                                                                                                                                                                                        set "Val_Lookahead=%%u"
                                                                                                                                                                                        set "Val_Precisione_Vettore_Movimento=%%u"

                                                                                                                                                                                        @REM echo NomeFile = !NomeFile!
                                                                                                                                                                                        @REM echo NomeFileOutput4k = !NomeFileOutput4k!
                                                                                                                                                                                        @REM echo NomeFileOutput2k = !NomeFileOutput2k!
                                                                                                                                                                                        @REM echo cropff = !cropff!
                                                                                                                                                                                        @REM echo RisoluzioneVideo4k = !RisoluzioneVideo4k!
                                                                                                                                                                                        @REM echo RisoluzioneVideo2k = !RisoluzioneVideo2k!
                                                                                                                                                                                        @REM echo hdrsettings = !hdrsettings!
                                                                                                                                                                                        @REM echo ColorPrimary = !ColorPrimary!
                                                                                                                                                                                        @REM echo ColorTransfer = !ColorTransfer!
                                                                                                                                                                                        @REM echo ColorMatrix = !ColorMatrix!
                                                                                                                                                                                        @REM echo TipoCodifica = !TipoCodifica!
                                                                                                                                                                                        @REM echo QualitaCodifica = !QualitaCodifica!
                                                                                                                                                                                        @REM echo TipoQuantizzazione = !TipoQuantizzazione!
                                                                                                                                                                                        @REM echo IntensitaQuantizzazione = !IntensitaQuantizzazione!
                                                                                                                                                                                        @REM echo Denoiser = !Denoiser!
                                                                                                                                                                                        @REM echo FormatoVideo2160p = !FormatoVideo2160p!
                                                                                                                                                                                        @REM echo Val_Edgelevel = !Val_Edgelevel!
                                                                                                                                                                                        @REM echo Val_Lookahead = !Val_Lookahead!
                                                                                                                                                                                        @REM echo Val_Precisione_Vettore_Movimento = !Val_Precisione_Vettore_Movimento!

                                                                                                                                                                                        call:Avvio_Semplice_Codifca_Hardware_NVidia

                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==QSVEnc_semplice_codifica_hardware (
                                                                                                                                                                                        echo !t4! !t30!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t23! %%f
                                                                                                                                                                                        @REM echo !t16! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        @REM echo Color Correction: %%s
                                                                                                                                                                                        @REM echo UpScaling in 2 Passaggi: %%t
                                                                                                                                                                                        echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.

                                                                                                                                                                                        set "NomeFile=%%b"
                                                                                                                                                                                        set "NomeFileOutput4k=%%c"
                                                                                                                                                                                        @REM set "NomeFileOutput2k=%%d"
                                                                                                                                                                                        set "cropff=%%e"
                                                                                                                                                                                        set "RisoluzioneVideo4k=%%f"
                                                                                                                                                                                        @REM set "RisoluzioneVideo2k=%%g"
                                                                                                                                                                                        @REM set "hdrsettings=%%h"
                                                                                                                                                                                        set "ColorPrimary=%%i"
                                                                                                                                                                                        set "ColorTransfer=%%j"
                                                                                                                                                                                        set "ColorMatrix=%%k"
                                                                                                                                                                                        set "TipoCodifica=%%l"
                                                                                                                                                                                        set "QualitaCodifica=%%m"
                                                                                                                                                                                        set "TipoQuantizzazione=%%n"
                                                                                                                                                                                        set "IntensitaQuantizzazione=%%o"
                                                                                                                                                                                        set "Denoiser=%%p"
                                                                                                                                                                                        set "FormatoVideo2160p=%%q"
                                                                                                                                                                                        set "Val_Edgelevel=%%r"
                                                                                                                                                                                        set "Val_Lookahead=%%u"
                                                                                                                                                                                        set "Val_Precisione_Vettore_Movimento=%%u"

                                                                                                                                                                                        @REM echo NomeFile = !NomeFile!
                                                                                                                                                                                        @REM echo NomeFileOutput4k = !NomeFileOutput4k!
                                                                                                                                                                                        @REM echo NomeFileOutput2k = !NomeFileOutput2k!
                                                                                                                                                                                        @REM echo cropff = !cropff!
                                                                                                                                                                                        @REM echo RisoluzioneVideo4k = !RisoluzioneVideo4k!
                                                                                                                                                                                        @REM echo RisoluzioneVideo2k = !RisoluzioneVideo2k!
                                                                                                                                                                                        @REM echo hdrsettings = !hdrsettings!
                                                                                                                                                                                        @REM echo ColorPrimary = !ColorPrimary!
                                                                                                                                                                                        @REM echo ColorTransfer = !ColorTransfer!
                                                                                                                                                                                        @REM echo ColorMatrix = !ColorMatrix!
                                                                                                                                                                                        @REM echo TipoCodifica = !TipoCodifica!
                                                                                                                                                                                        @REM echo QualitaCodifica = !QualitaCodifica!
                                                                                                                                                                                        @REM echo TipoQuantizzazione = !TipoQuantizzazione!
                                                                                                                                                                                        @REM echo IntensitaQuantizzazione = !IntensitaQuantizzazione!
                                                                                                                                                                                        @REM echo Denoiser = !Denoiser!
                                                                                                                                                                                        @REM echo FormatoVideo2160p = !FormatoVideo2160p!
                                                                                                                                                                                        @REM echo Val_Edgelevel = !Val_Edgelevel!
                                                                                                                                                                                        @REM echo Val_Lookahead = !Val_Lookahead!
                                                                                                                                                                                        @REM echo Val_Precisione_Vettore_Movimento = !Val_Precisione_Vettore_Movimento!

                                                                                                                                                                                        call:Avvio_Semplice_Codifca_Hardware_Intel

                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )


                                                                                                                                                                                    if %%a==NVEnc_UpScaling_UpGrading_da_1080p_a_2160p (
                                                                                                                                                                                        echo !t4! !t31!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        echo Color Correction: %%s
                                                                                                                                                                                        if %%t==1 ( set "unicopassaggiow=Si" ) else ( set "unicopassaggiow=No" )
                                                                                                                                                                                        echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.

                                                                                                                                                                                        set "NomeFile=%%b"
                                                                                                                                                                                        set "NomeFileOutput4k=%%c"
                                                                                                                                                                                        @REM set "NomeFileOutput2k=%%d"
                                                                                                                                                                                        set "cropff=%%e"
                                                                                                                                                                                        set "RisoluzioneVideo4k=%%f"
                                                                                                                                                                                        set "RisoluzioneVideo2k=%%g"
                                                                                                                                                                                        @REM set "hdrsettings=%%h"
                                                                                                                                                                                        set "ColorPrimary=%%i"
                                                                                                                                                                                        set "ColorTransfer=%%j"
                                                                                                                                                                                        set "ColorMatrix=%%k"
                                                                                                                                                                                        set "TipoCodifica=%%l"
                                                                                                                                                                                        set "QualitaCodifica=%%m"
                                                                                                                                                                                        @REM set "TipoQuantizzazione=%%n"
                                                                                                                                                                                        @REM set "IntensitaQuantizzazione=%%o"
                                                                                                                                                                                        set "Denoiser=%%p"
                                                                                                                                                                                        set "FormatoVideo2160p=%%q"
                                                                                                                                                                                        set "Val_Edgelevel=%%r"
                                                                                                                                                                                        set "ColorCorrectionVal=%%s"
                                                                                                                                                                                        set "UnicoPassaggio=!unicopassaggiow!"
                                                                                                                                                                                        @REM set "Val_Lookahead=%%u"
                                                                                                                                                                                        @REM set "Val_Precisione_Vettore_Movimento=%%u"

                                                                                                                                                                                        @REM echo NomeFile = !NomeFile!
                                                                                                                                                                                        @REM echo NomeFileOutput4k = !NomeFileOutput4k!
                                                                                                                                                                                        @REM echo NomeFileOutput2k = !NomeFileOutput2k!
                                                                                                                                                                                        @REM echo cropff = !cropff!
                                                                                                                                                                                        @REM echo RisoluzioneVideo4k = !RisoluzioneVideo4k!
                                                                                                                                                                                        @REM echo RisoluzioneVideo2k = !RisoluzioneVideo2k!
                                                                                                                                                                                        @REM echo hdrsettings = !hdrsettings!
                                                                                                                                                                                        @REM echo ColorPrimary = !ColorPrimary!
                                                                                                                                                                                        @REM echo ColorTransfer = !ColorTransfer!
                                                                                                                                                                                        @REM echo ColorMatrix = !ColorMatrix!
                                                                                                                                                                                        @REM echo TipoCodifica = !TipoCodifica!
                                                                                                                                                                                        @REM echo QualitaCodifica = !QualitaCodifica!
                                                                                                                                                                                        @REM echo TipoQuantizzazione = !TipoQuantizzazione!
                                                                                                                                                                                        @REM echo IntensitaQuantizzazione = !IntensitaQuantizzazione!
                                                                                                                                                                                        @REM echo Denoiser = !Denoiser!
                                                                                                                                                                                        @REM echo FormatoVideo2160p = !FormatoVideo2160p!
                                                                                                                                                                                        @REM echo Val_Edgelevel = !Val_Edgelevel!
                                                                                                                                                                                        @REM echo ColorCorrectionVal = !ColorCorrectionVal!
                                                                                                                                                                                        @REM echo UnicoPassaggio= !unicopassaggiow!
                                                                                                                                                                                        @REM echo Val_Lookahead = !Val_Lookahead!
                                                                                                                                                                                        @REM echo Val_Precisione_Vettore_Movimento = !Val_Precisione_Vettore_Movimento!

                                                                                                                                                                                        call:Avvio_Codifica_Hardware_NVidia_UpScaling_UpGrading_da_1080p_a_2160p

                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==QSVEnc_UpScaling_UpGrading_da_1080p_a_2160p (
                                                                                                                                                                                        echo !t4! !t32!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        echo Color Correction: %%s
                                                                                                                                                                                        if %%t==1 ( set "unicopassaggiow=Si" ) else ( set "unicopassaggiow=No" )
                                                                                                                                                                                        echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.

                                                                                                                                                                                        set "NomeFile=%%b"
                                                                                                                                                                                        set "NomeFileOutput4k=%%c"
                                                                                                                                                                                        @REM set "NomeFileOutput2k=%%d"
                                                                                                                                                                                        set "cropff=%%e"
                                                                                                                                                                                        set "RisoluzioneVideo4k=%%f"
                                                                                                                                                                                        set "RisoluzioneVideo2k=%%g"
                                                                                                                                                                                        @REM set "hdrsettings=%%h"
                                                                                                                                                                                        set "ColorPrimary=%%i"
                                                                                                                                                                                        set "ColorTransfer=%%j"
                                                                                                                                                                                        set "ColorMatrix=%%k"
                                                                                                                                                                                        set "TipoCodifica=%%l"
                                                                                                                                                                                        set "QualitaCodifica=%%m"
                                                                                                                                                                                        @REM set "TipoQuantizzazione=%%n"
                                                                                                                                                                                        @REM set "IntensitaQuantizzazione=%%o"
                                                                                                                                                                                        set "Denoiser=%%p"
                                                                                                                                                                                        set "FormatoVideo2160p=%%q"
                                                                                                                                                                                        set "Val_Edgelevel=%%r"
                                                                                                                                                                                        set "ColorCorrectionVal=%%s"
                                                                                                                                                                                        set "UnicoPassaggio=!unicopassaggiow!"
                                                                                                                                                                                        @REM set "Val_Lookahead=%%u"
                                                                                                                                                                                        @REM set "Val_Precisione_Vettore_Movimento=%%u"

                                                                                                                                                                                        @REM echo NomeFile = !NomeFile!
                                                                                                                                                                                        @REM echo NomeFileOutput4k = !NomeFileOutput4k!
                                                                                                                                                                                        @REM echo NomeFileOutput2k = !NomeFileOutput2k!
                                                                                                                                                                                        @REM echo cropff = !cropff!
                                                                                                                                                                                        @REM echo RisoluzioneVideo4k = !RisoluzioneVideo4k!
                                                                                                                                                                                        @REM echo RisoluzioneVideo2k = !RisoluzioneVideo2k!
                                                                                                                                                                                        @REM echo hdrsettings = !hdrsettings!
                                                                                                                                                                                        @REM echo ColorPrimary = !ColorPrimary!
                                                                                                                                                                                        @REM echo ColorTransfer = !ColorTransfer!
                                                                                                                                                                                        @REM echo ColorMatrix = !ColorMatrix!
                                                                                                                                                                                        @REM echo TipoCodifica = !TipoCodifica!
                                                                                                                                                                                        @REM echo QualitaCodifica = !QualitaCodifica!
                                                                                                                                                                                        @REM echo TipoQuantizzazione = !TipoQuantizzazione!
                                                                                                                                                                                        @REM echo IntensitaQuantizzazione = !IntensitaQuantizzazione!
                                                                                                                                                                                        @REM echo Denoiser = !Denoiser!
                                                                                                                                                                                        @REM echo FormatoVideo2160p = !FormatoVideo2160p!
                                                                                                                                                                                        @REM echo Val_Edgelevel = !Val_Edgelevel!
                                                                                                                                                                                        @REM echo ColorCorrectionVal = !ColorCorrectionVal!
                                                                                                                                                                                        @REM echo UnicoPassaggio= !unicopassaggiow!
                                                                                                                                                                                        @REM echo Val_Lookahead = !Val_Lookahead!
                                                                                                                                                                                        @REM echo Val_Precisione_Vettore_Movimento = !Val_Precisione_Vettore_Movimento!

                                                                                                                                                                                        call:Avvio_Codifica_Hardware_Intel_UpScaling_UpGrading_da_1080p_a_2160p

                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==NVEnc_UpScaling_da_1080p_10bit_hdr_a_2160p_10bit_hdr (
                                                                                                                                                                                        echo !t4! !t33!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        @REM echo Color Correction: %%s
                                                                                                                                                                                        if %%t==1 ( set "unicopassaggiow=Si" ) else ( set "unicopassaggiow=No" )
                                                                                                                                                                                        echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.

                                                                                                                                                                                        set "NomeFile=%%b"
                                                                                                                                                                                        set "NomeFileOutput4k=%%c"
                                                                                                                                                                                        @REM set "NomeFileOutput2k=%%d"
                                                                                                                                                                                        set "cropff=%%e"
                                                                                                                                                                                        set "RisoluzioneVideo4k=%%f"
                                                                                                                                                                                        set "RisoluzioneVideo2k=%%g"
                                                                                                                                                                                        @REM set "hdrsettings=%%h"
                                                                                                                                                                                        set "ColorPrimary=%%i"
                                                                                                                                                                                        set "ColorTransfer=%%j"
                                                                                                                                                                                        set "ColorMatrix=%%k"
                                                                                                                                                                                        set "TipoCodifica=%%l"
                                                                                                                                                                                        set "QualitaCodifica=%%m"
                                                                                                                                                                                        @REM set "TipoQuantizzazione=%%n"
                                                                                                                                                                                        @REM set "IntensitaQuantizzazione=%%o"
                                                                                                                                                                                        set "Denoiser=%%p"
                                                                                                                                                                                        set "FormatoVideo2160p=%%q"
                                                                                                                                                                                        set "Val_Edgelevel=%%r"
                                                                                                                                                                                        @REM set "ColorCorrectionVal=%%s"
                                                                                                                                                                                        set "UnicoPassaggio=!unicopassaggiow!"
                                                                                                                                                                                        @REM set "Val_Lookahead=%%u"
                                                                                                                                                                                        @REM set "Val_Precisione_Vettore_Movimento=%%u"

                                                                                                                                                                                        @REM echo NomeFile = !NomeFile!
                                                                                                                                                                                        @REM echo NomeFileOutput4k = !NomeFileOutput4k!
                                                                                                                                                                                        @REM echo NomeFileOutput2k = !NomeFileOutput2k!
                                                                                                                                                                                        @REM echo cropff = !cropff!
                                                                                                                                                                                        @REM echo RisoluzioneVideo4k = !RisoluzioneVideo4k!
                                                                                                                                                                                        @REM echo RisoluzioneVideo2k = !RisoluzioneVideo2k!
                                                                                                                                                                                        @REM echo hdrsettings = !hdrsettings!
                                                                                                                                                                                        @REM echo ColorPrimary = !ColorPrimary!
                                                                                                                                                                                        @REM echo ColorTransfer = !ColorTransfer!
                                                                                                                                                                                        @REM echo ColorMatrix = !ColorMatrix!
                                                                                                                                                                                        @REM echo TipoCodifica = !TipoCodifica!
                                                                                                                                                                                        @REM echo QualitaCodifica = !QualitaCodifica!
                                                                                                                                                                                        @REM echo TipoQuantizzazione = !TipoQuantizzazione!
                                                                                                                                                                                        @REM echo IntensitaQuantizzazione = !IntensitaQuantizzazione!
                                                                                                                                                                                        @REM echo Denoiser = !Denoiser!
                                                                                                                                                                                        @REM echo FormatoVideo2160p = !FormatoVideo2160p!
                                                                                                                                                                                        @REM echo Val_Edgelevel = !Val_Edgelevel!
                                                                                                                                                                                        @REM echo ColorCorrectionVal = !ColorCorrectionVal!
                                                                                                                                                                                        @REM echo UnicoPassaggio= !unicopassaggiow!
                                                                                                                                                                                        @REM echo Val_Lookahead = !Val_Lookahead!
                                                                                                                                                                                        @REM echo Val_Precisione_Vettore_Movimento = !Val_Precisione_Vettore_Movimento!

                                                                                                                                                                                        call:NVEnc_UpScaling_da_1080p_10bit_HDR_a_2160p_10bit_hdr

                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==QSVEnc_UpScaling_da_1080p_10bit_hdr_a_2160p_10bit_hdr (
                                                                                                                                                                                        echo !t4! !t34!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        @REM echo Color Correction: %%s
                                                                                                                                                                                        if %%t==1 ( set "unicopassaggiow=Si" ) else ( set "unicopassaggiow=No" )
                                                                                                                                                                                        echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.

                                                                                                                                                                                        set "NomeFile=%%b"
                                                                                                                                                                                        set "NomeFileOutput4k=%%c"
                                                                                                                                                                                        @REM set "NomeFileOutput2k=%%d"
                                                                                                                                                                                        set "cropff=%%e"
                                                                                                                                                                                        set "RisoluzioneVideo4k=%%f"
                                                                                                                                                                                        set "RisoluzioneVideo2k=%%g"
                                                                                                                                                                                        @REM set "hdrsettings=%%h"
                                                                                                                                                                                        set "ColorPrimary=%%i"
                                                                                                                                                                                        set "ColorTransfer=%%j"
                                                                                                                                                                                        set "ColorMatrix=%%k"
                                                                                                                                                                                        set "TipoCodifica=%%l"
                                                                                                                                                                                        set "QualitaCodifica=%%m"
                                                                                                                                                                                        @REM set "TipoQuantizzazione=%%n"
                                                                                                                                                                                        @REM set "IntensitaQuantizzazione=%%o"
                                                                                                                                                                                        set "Denoiser=%%p"
                                                                                                                                                                                        set "FormatoVideo2160p=%%q"
                                                                                                                                                                                        set "Val_Edgelevel=%%r"
                                                                                                                                                                                        @REM set "ColorCorrectionVal=%%s"
                                                                                                                                                                                        set "UnicoPassaggio=!unicopassaggiow!"
                                                                                                                                                                                        @REM set "Val_Lookahead=%%u"
                                                                                                                                                                                        @REM set "Val_Precisione_Vettore_Movimento=%%u"

                                                                                                                                                                                        @REM echo NomeFile = !NomeFile!
                                                                                                                                                                                        @REM echo NomeFileOutput4k = !NomeFileOutput4k!
                                                                                                                                                                                        @REM echo NomeFileOutput2k = !NomeFileOutput2k!
                                                                                                                                                                                        @REM echo cropff = !cropff!
                                                                                                                                                                                        @REM echo RisoluzioneVideo4k = !RisoluzioneVideo4k!
                                                                                                                                                                                        @REM echo RisoluzioneVideo2k = !RisoluzioneVideo2k!
                                                                                                                                                                                        @REM echo hdrsettings = !hdrsettings!
                                                                                                                                                                                        @REM echo ColorPrimary = !ColorPrimary!
                                                                                                                                                                                        @REM echo ColorTransfer = !ColorTransfer!
                                                                                                                                                                                        @REM echo ColorMatrix = !ColorMatrix!
                                                                                                                                                                                        @REM echo TipoCodifica = !TipoCodifica!
                                                                                                                                                                                        @REM echo QualitaCodifica = !QualitaCodifica!
                                                                                                                                                                                        @REM echo TipoQuantizzazione = !TipoQuantizzazione!
                                                                                                                                                                                        @REM echo IntensitaQuantizzazione = !IntensitaQuantizzazione!
                                                                                                                                                                                        @REM echo Denoiser = !Denoiser!
                                                                                                                                                                                        @REM echo FormatoVideo2160p = !FormatoVideo2160p!
                                                                                                                                                                                        @REM echo Val_Edgelevel = !Val_Edgelevel!
                                                                                                                                                                                        @REM echo ColorCorrectionVal = !ColorCorrectionVal!
                                                                                                                                                                                        @REM echo UnicoPassaggio= !unicopassaggiow!
                                                                                                                                                                                        @REM echo Val_Lookahead = !Val_Lookahead!
                                                                                                                                                                                        @REM echo Val_Precisione_Vettore_Movimento = !Val_Precisione_Vettore_Movimento!

                                                                                                                                                                                        call:QSVEnc_UpScaling_da_1080p_10bit_HDR_a_2160p_10bit_hdr

                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==NVEnc_da_2160p_8bit_o_10bit_sdr_a_2160p_10bit_hdr (
                                                                                                                                                                                        echo !t4! !t35!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        @REM echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        echo Color Correction: %%s
                                                                                                                                                                                        @REM if %%t==1 ( set unicopassaggiow=Si ) else ( set unicopassaggiow=No )
                                                                                                                                                                                        @REM echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.

                                                                                                                                                                                        set "NomeFile=%%b"
                                                                                                                                                                                        set "NomeFileOutput4k=%%c"
                                                                                                                                                                                        @REM set "NomeFileOutput2k=%%d"
                                                                                                                                                                                        set "cropff=%%e"
                                                                                                                                                                                        set "RisoluzioneVideo4k=%%f"
                                                                                                                                                                                        @REM set "RisoluzioneVideo2k=%%g"
                                                                                                                                                                                        @REM set "hdrsettings=%%h"
                                                                                                                                                                                        set "ColorPrimary=%%i"
                                                                                                                                                                                        set "ColorTransfer=%%j"
                                                                                                                                                                                        set "ColorMatrix=%%k"
                                                                                                                                                                                        set "TipoCodifica=%%l"
                                                                                                                                                                                        set "QualitaCodifica=%%m"
                                                                                                                                                                                        @REM set "TipoQuantizzazione=%%n"
                                                                                                                                                                                        @REM set "IntensitaQuantizzazione=%%o"
                                                                                                                                                                                        set "Denoiser=%%p"
                                                                                                                                                                                        set "FormatoVideo2160p=%%q"
                                                                                                                                                                                        set "Val_Edgelevel=%%r"
                                                                                                                                                                                        set "ColorCorrectionVal=%%s"
                                                                                                                                                                                        @REM set "UnicoPassaggio=!unicopassaggiow!"
                                                                                                                                                                                        @REM set "Val_Lookahead=%%u"
                                                                                                                                                                                        @REM set "Val_Precisione_Vettore_Movimento=%%u"

                                                                                                                                                                                        @REM echo NomeFile = !NomeFile!
                                                                                                                                                                                        @REM echo NomeFileOutput4k = !NomeFileOutput4k!
                                                                                                                                                                                        @REM echo NomeFileOutput2k = !NomeFileOutput2k!
                                                                                                                                                                                        @REM echo cropff = !cropff!
                                                                                                                                                                                        @REM echo RisoluzioneVideo4k = !RisoluzioneVideo4k!
                                                                                                                                                                                        @REM echo RisoluzioneVideo2k = !RisoluzioneVideo2k!
                                                                                                                                                                                        @REM echo hdrsettings = !hdrsettings!
                                                                                                                                                                                        @REM echo ColorPrimary = !ColorPrimary!
                                                                                                                                                                                        @REM echo ColorTransfer = !ColorTransfer!
                                                                                                                                                                                        @REM echo ColorMatrix = !ColorMatrix!
                                                                                                                                                                                        @REM echo TipoCodifica = !TipoCodifica!
                                                                                                                                                                                        @REM echo QualitaCodifica = !QualitaCodifica!
                                                                                                                                                                                        @REM echo TipoQuantizzazione = !TipoQuantizzazione!
                                                                                                                                                                                        @REM echo IntensitaQuantizzazione = !IntensitaQuantizzazione!
                                                                                                                                                                                        @REM echo Denoiser = !Denoiser!
                                                                                                                                                                                        @REM echo FormatoVideo2160p = !FormatoVideo2160p!
                                                                                                                                                                                        @REM echo Val_Edgelevel = !Val_Edgelevel!
                                                                                                                                                                                        @REM echo ColorCorrectionVal = !ColorCorrectionVal!
                                                                                                                                                                                        @REM echo UnicoPassaggio= !unicopassaggiow!
                                                                                                                                                                                        @REM echo Val_Lookahead = !Val_Lookahead!
                                                                                                                                                                                        @REM echo Val_Precisione_Vettore_Movimento = !Val_Precisione_Vettore_Movimento!

                                                                                                                                                                                        call:Avvio_Codifica_UpGrading_NVEnc_da_2160p_8-10bit_SDR_a_2160p_10bit_HDR

                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==QSVEnc_da_2160p_8bit_o_10bit_sdr_a_2160p_10bit_hdr (
                                                                                                                                                                                        echo !t4! !t36!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        @REM echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        echo Color Correction: %%s
                                                                                                                                                                                        @REM if %%t==1 ( set unicopassaggiow=Si ) else ( set unicopassaggiow=No )
                                                                                                                                                                                        @REM echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.

                                                                                                                                                                                        set "NomeFile=%%b"
                                                                                                                                                                                        set "NomeFileOutput4k=%%c"
                                                                                                                                                                                        @REM set "NomeFileOutput2k=%%d"
                                                                                                                                                                                        set "cropff=%%e"
                                                                                                                                                                                        set "RisoluzioneVideo4k=%%f"
                                                                                                                                                                                        @REM set "RisoluzioneVideo2k=%%g"
                                                                                                                                                                                        @REM set "hdrsettings=%%h"
                                                                                                                                                                                        set "ColorPrimary=%%i"
                                                                                                                                                                                        set "ColorTransfer=%%j"
                                                                                                                                                                                        set "ColorMatrix=%%k"
                                                                                                                                                                                        set "TipoCodifica=%%l"
                                                                                                                                                                                        set "QualitaCodifica=%%m"
                                                                                                                                                                                        @REM set "TipoQuantizzazione=%%n"
                                                                                                                                                                                        @REM set "IntensitaQuantizzazione=%%o"
                                                                                                                                                                                        set "Denoiser=%%p"
                                                                                                                                                                                        set "FormatoVideo2160p=%%q"
                                                                                                                                                                                        set "Val_Edgelevel=%%r"
                                                                                                                                                                                        set "ColorCorrectionVal=%%s"
                                                                                                                                                                                        @REM set "UnicoPassaggio=!unicopassaggiow!"
                                                                                                                                                                                        @REM set "Val_Lookahead=%%u"
                                                                                                                                                                                        @REM set "Val_Precisione_Vettore_Movimento=%%u"

                                                                                                                                                                                        @REM echo NomeFile = !NomeFile!
                                                                                                                                                                                        @REM echo NomeFileOutput4k = !NomeFileOutput4k!
                                                                                                                                                                                        @REM echo NomeFileOutput2k = !NomeFileOutput2k!
                                                                                                                                                                                        @REM echo cropff = !cropff!
                                                                                                                                                                                        @REM echo RisoluzioneVideo4k = !RisoluzioneVideo4k!
                                                                                                                                                                                        @REM echo RisoluzioneVideo2k = !RisoluzioneVideo2k!
                                                                                                                                                                                        @REM echo hdrsettings = !hdrsettings!
                                                                                                                                                                                        @REM echo ColorPrimary = !ColorPrimary!
                                                                                                                                                                                        @REM echo ColorTransfer = !ColorTransfer!
                                                                                                                                                                                        @REM echo ColorMatrix = !ColorMatrix!
                                                                                                                                                                                        @REM echo TipoCodifica = !TipoCodifica!
                                                                                                                                                                                        @REM echo QualitaCodifica = !QualitaCodifica!
                                                                                                                                                                                        @REM echo TipoQuantizzazione = !TipoQuantizzazione!
                                                                                                                                                                                        @REM echo IntensitaQuantizzazione = !IntensitaQuantizzazione!
                                                                                                                                                                                        @REM echo Denoiser = !Denoiser!
                                                                                                                                                                                        @REM echo FormatoVideo2160p = !FormatoVideo2160p!
                                                                                                                                                                                        @REM echo Val_Edgelevel = !Val_Edgelevel!
                                                                                                                                                                                        @REM echo ColorCorrectionVal = !ColorCorrectionVal!
                                                                                                                                                                                        @REM echo UnicoPassaggio= !unicopassaggiow!
                                                                                                                                                                                        @REM echo Val_Lookahead = !Val_Lookahead!
                                                                                                                                                                                        @REM echo Val_Precisione_Vettore_Movimento = !Val_Precisione_Vettore_Movimento!

                                                                                                                                                                                        call:Avvio_Codifica_UpGrading_QSVEnc_da_2160p_8-10bit_SDR_a_2160p_10bit_HDR

                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==NVEnc_downgraded_da_2160p_o_1080p_10bit_hdr_a_8_bit_sdr (
                                                                                                                                                                                        echo !t4! !t37!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        @REM echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        echo Color Correction: %%s
                                                                                                                                                                                        @REM if %%t==1 ( set unicopassaggiow=Si ) else ( set unicopassaggiow=No )
                                                                                                                                                                                        @REM echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.

                                                                                                                                                                                        set "NomeFile=%%b"
                                                                                                                                                                                        set "NomeFileOutput4k=%%c"
                                                                                                                                                                                        @REM set "NomeFileOutput2k=%%d"
                                                                                                                                                                                        set "cropff=%%e"
                                                                                                                                                                                        set "RisoluzioneVideo4k=%%f"
                                                                                                                                                                                        @REM set "RisoluzioneVideo2k=%%g"
                                                                                                                                                                                        @REM set "hdrsettings=%%h"
                                                                                                                                                                                        set "ColorPrimary=%%i"
                                                                                                                                                                                        set "ColorTransfer=%%j"
                                                                                                                                                                                        set "ColorMatrix=%%k"
                                                                                                                                                                                        set "TipoCodifica=%%l"
                                                                                                                                                                                        set "QualitaCodifica=%%m"
                                                                                                                                                                                        @REM set "TipoQuantizzazione=%%n"
                                                                                                                                                                                        @REM set "IntensitaQuantizzazione=%%o"
                                                                                                                                                                                        set "Denoiser=%%p"
                                                                                                                                                                                        set "FormatoVideo2160p=%%q"
                                                                                                                                                                                        set "Val_Edgelevel=%%r"
                                                                                                                                                                                        set "ColorCorrectionVal=%%s"
                                                                                                                                                                                        @REM set "UnicoPassaggio=!unicopassaggiow!"
                                                                                                                                                                                        @REM set "Val_Lookahead=%%u"
                                                                                                                                                                                        @REM set "Val_Precisione_Vettore_Movimento=%%u"

                                                                                                                                                                                        @REM echo NomeFile = !NomeFile!
                                                                                                                                                                                        @REM echo NomeFileOutput4k = !NomeFileOutput4k!
                                                                                                                                                                                        @REM echo NomeFileOutput2k = !NomeFileOutput2k!
                                                                                                                                                                                        @REM echo cropff = !cropff!
                                                                                                                                                                                        @REM echo RisoluzioneVideo4k = !RisoluzioneVideo4k!
                                                                                                                                                                                        @REM echo RisoluzioneVideo2k = !RisoluzioneVideo2k!
                                                                                                                                                                                        @REM echo hdrsettings = !hdrsettings!
                                                                                                                                                                                        @REM echo ColorPrimary = !ColorPrimary!
                                                                                                                                                                                        @REM echo ColorTransfer = !ColorTransfer!
                                                                                                                                                                                        @REM echo ColorMatrix = !ColorMatrix!
                                                                                                                                                                                        @REM echo TipoCodifica = !TipoCodifica!
                                                                                                                                                                                        @REM echo QualitaCodifica = !QualitaCodifica!
                                                                                                                                                                                        @REM echo TipoQuantizzazione = !TipoQuantizzazione!
                                                                                                                                                                                        @REM echo IntensitaQuantizzazione = !IntensitaQuantizzazione!
                                                                                                                                                                                        @REM echo Denoiser = !Denoiser!
                                                                                                                                                                                        @REM echo FormatoVideo2160p = !FormatoVideo2160p!
                                                                                                                                                                                        @REM echo Val_Edgelevel = !Val_Edgelevel!
                                                                                                                                                                                        @REM echo ColorCorrectionVal = !ColorCorrectionVal!
                                                                                                                                                                                        @REM echo UnicoPassaggio= !unicopassaggiow!
                                                                                                                                                                                        @REM echo Val_Lookahead = !Val_Lookahead!
                                                                                                                                                                                        @REM echo Val_Precisione_Vettore_Movimento = !Val_Precisione_Vettore_Movimento!

                                                                                                                                                                                        call:Avvio_Codifica_Hardware_NVidia_DownGrading_2160p_1080p_10bit_HDR_a_8bit_SDR

                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==QSVEnc_downgraded_da_2160p_o_1080p_10bit_hdr_a_8_bit_sdr (
                                                                                                                                                                                        echo !t4! !t38!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        @REM echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        echo Color Correction: %%s
                                                                                                                                                                                        @REM if %%t==1 ( set unicopassaggiow=Si ) else ( set unicopassaggiow=No )
                                                                                                                                                                                        @REM echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.

                                                                                                                                                                                        set "NomeFile=%%b"
                                                                                                                                                                                        set "NomeFileOutput4k=%%c"
                                                                                                                                                                                        @REM set "NomeFileOutput2k=%%d"
                                                                                                                                                                                        set "cropff=%%e"
                                                                                                                                                                                        set "RisoluzioneVideo4k=%%f"
                                                                                                                                                                                        @REM set "RisoluzioneVideo2k=%%g"
                                                                                                                                                                                        @REM set "hdrsettings=%%h"
                                                                                                                                                                                        set "ColorPrimary=%%i"
                                                                                                                                                                                        set "ColorTransfer=%%j"
                                                                                                                                                                                        set "ColorMatrix=%%k"
                                                                                                                                                                                        set "TipoCodifica=%%l"
                                                                                                                                                                                        set "QualitaCodifica=%%m"
                                                                                                                                                                                        @REM set "TipoQuantizzazione=%%n"
                                                                                                                                                                                        @REM set "IntensitaQuantizzazione=%%o"
                                                                                                                                                                                        set "Denoiser=%%p"
                                                                                                                                                                                        set "FormatoVideo2160p=%%q"
                                                                                                                                                                                        set "Val_Edgelevel=%%r"
                                                                                                                                                                                        set "ColorCorrectionVal=%%s"
                                                                                                                                                                                        @REM set "UnicoPassaggio=!unicopassaggiow!"
                                                                                                                                                                                        @REM set "Val_Lookahead=%%u"
                                                                                                                                                                                        @REM set "Val_Precisione_Vettore_Movimento=%%u"

                                                                                                                                                                                        @REM echo NomeFile = !NomeFile!
                                                                                                                                                                                        @REM echo NomeFileOutput4k = !NomeFileOutput4k!
                                                                                                                                                                                        @REM echo NomeFileOutput2k = !NomeFileOutput2k!
                                                                                                                                                                                        @REM echo cropff = !cropff!
                                                                                                                                                                                        @REM echo RisoluzioneVideo4k = !RisoluzioneVideo4k!
                                                                                                                                                                                        @REM echo RisoluzioneVideo2k = !RisoluzioneVideo2k!
                                                                                                                                                                                        @REM echo hdrsettings = !hdrsettings!
                                                                                                                                                                                        @REM echo ColorPrimary = !ColorPrimary!
                                                                                                                                                                                        @REM echo ColorTransfer = !ColorTransfer!
                                                                                                                                                                                        @REM echo ColorMatrix = !ColorMatrix!
                                                                                                                                                                                        @REM echo TipoCodifica = !TipoCodifica!
                                                                                                                                                                                        @REM echo QualitaCodifica = !QualitaCodifica!
                                                                                                                                                                                        @REM echo TipoQuantizzazione = !TipoQuantizzazione!
                                                                                                                                                                                        @REM echo IntensitaQuantizzazione = !IntensitaQuantizzazione!
                                                                                                                                                                                        @REM echo Denoiser = !Denoiser!
                                                                                                                                                                                        @REM echo FormatoVideo2160p = !FormatoVideo2160p!
                                                                                                                                                                                        @REM echo Val_Edgelevel = !Val_Edgelevel!
                                                                                                                                                                                        @REM echo ColorCorrectionVal = !ColorCorrectionVal!
                                                                                                                                                                                        @REM echo UnicoPassaggio= !unicopassaggiow!
                                                                                                                                                                                        @REM echo Val_Lookahead = !Val_Lookahead!
                                                                                                                                                                                        @REM echo Val_Precisione_Vettore_Movimento = !Val_Precisione_Vettore_Movimento!

                                                                                                                                                                                        call:Avvio_Codifica_Hardware_Intel_DownGrading_2160p_1080p_10bit_HDR_a_8bit_SDR

                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==NVEnc_DownGraded_DownScaled_da_2160p_10bit_HDR_a_1080p_8bit_SDR (
                                                                                                                                                                                        echo !t4! !t39!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        @REM echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        echo Color Correction: %%s
                                                                                                                                                                                        @REM if %%t==1 ( set unicopassaggiow=Si ) else ( set unicopassaggiow=No )
                                                                                                                                                                                        @REM echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.

                                                                                                                                                                                        set "NomeFile=%%b"
                                                                                                                                                                                        set "NomeFileOutput4k=%%c"
                                                                                                                                                                                        @REM set "NomeFileOutput2k=%%d"
                                                                                                                                                                                        set "cropff=%%e"
                                                                                                                                                                                        set "RisoluzioneVideo4k=%%f"
                                                                                                                                                                                        @REM set "RisoluzioneVideo2k=%%g"
                                                                                                                                                                                        @REM set "hdrsettings=%%h"
                                                                                                                                                                                        set "ColorPrimary=%%i"
                                                                                                                                                                                        set "ColorTransfer=%%j"
                                                                                                                                                                                        set "ColorMatrix=%%k"
                                                                                                                                                                                        set "TipoCodifica=%%l"
                                                                                                                                                                                        set "QualitaCodifica=%%m"
                                                                                                                                                                                        @REM set "TipoQuantizzazione=%%n"
                                                                                                                                                                                        @REM set "IntensitaQuantizzazione=%%o"
                                                                                                                                                                                        set "Denoiser=%%p"
                                                                                                                                                                                        set "FormatoVideo2160p=%%q"
                                                                                                                                                                                        set "Val_Edgelevel=%%r"
                                                                                                                                                                                        set "ColorCorrectionVal=%%s"
                                                                                                                                                                                        @REM set "UnicoPassaggio=!unicopassaggiow!"
                                                                                                                                                                                        @REM set "Val_Lookahead=%%u"
                                                                                                                                                                                        @REM set "Val_Precisione_Vettore_Movimento=%%u"

                                                                                                                                                                                        @REM echo NomeFile = !NomeFile!
                                                                                                                                                                                        @REM echo NomeFileOutput4k = !NomeFileOutput4k!
                                                                                                                                                                                        @REM echo NomeFileOutput2k = !NomeFileOutput2k!
                                                                                                                                                                                        @REM echo cropff = !cropff!
                                                                                                                                                                                        @REM echo RisoluzioneVideo4k = !RisoluzioneVideo4k!
                                                                                                                                                                                        @REM echo RisoluzioneVideo2k = !RisoluzioneVideo2k!
                                                                                                                                                                                        @REM echo hdrsettings = !hdrsettings!
                                                                                                                                                                                        @REM echo ColorPrimary = !ColorPrimary!
                                                                                                                                                                                        @REM echo ColorTransfer = !ColorTransfer!
                                                                                                                                                                                        @REM echo ColorMatrix = !ColorMatrix!
                                                                                                                                                                                        @REM echo TipoCodifica = !TipoCodifica!
                                                                                                                                                                                        @REM echo QualitaCodifica = !QualitaCodifica!
                                                                                                                                                                                        @REM echo TipoQuantizzazione = !TipoQuantizzazione!
                                                                                                                                                                                        @REM echo IntensitaQuantizzazione = !IntensitaQuantizzazione!
                                                                                                                                                                                        @REM echo Denoiser = !Denoiser!
                                                                                                                                                                                        @REM echo FormatoVideo2160p = !FormatoVideo2160p!
                                                                                                                                                                                        @REM echo Val_Edgelevel = !Val_Edgelevel!
                                                                                                                                                                                        @REM echo ColorCorrectionVal = !ColorCorrectionVal!
                                                                                                                                                                                        @REM echo UnicoPassaggio= !unicopassaggiow!
                                                                                                                                                                                        @REM echo Val_Lookahead = !Val_Lookahead!
                                                                                                                                                                                        @REM echo Val_Precisione_Vettore_Movimento = !Val_Precisione_Vettore_Movimento!

                                                                                                                                                                                        call:Avvio_Codifica_NVidia_DownScaling_DownGrading_da_2160p_10bit_HDR_a_1080p_8bit_SDR

                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==QSVEnc_DownGraded_DownScaled_da_2160p_10bit_HDR_a_1080p_8bit_SDR (
                                                                                                                                                                                        echo !t4! !t40!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        @REM echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        echo Color Correction: %%s
                                                                                                                                                                                        @REM if %%t==1 ( set unicopassaggiow=Si ) else ( set unicopassaggiow=No )
                                                                                                                                                                                        @REM echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.

                                                                                                                                                                                        set "NomeFile=%%b"
                                                                                                                                                                                        set "NomeFileOutput4k=%%c"
                                                                                                                                                                                        @REM set "NomeFileOutput2k=%%d"
                                                                                                                                                                                        set "cropff=%%e"
                                                                                                                                                                                        set "RisoluzioneVideo4k=%%f"
                                                                                                                                                                                        @REM set "RisoluzioneVideo2k=%%g"
                                                                                                                                                                                        @REM set "hdrsettings=%%h"
                                                                                                                                                                                        set "ColorPrimary=%%i"
                                                                                                                                                                                        set "ColorTransfer=%%j"
                                                                                                                                                                                        set "ColorMatrix=%%k"
                                                                                                                                                                                        set "TipoCodifica=%%l"
                                                                                                                                                                                        set "QualitaCodifica=%%m"
                                                                                                                                                                                        @REM set "TipoQuantizzazione=%%n"
                                                                                                                                                                                        @REM set "IntensitaQuantizzazione=%%o"
                                                                                                                                                                                        set "Denoiser=%%p"
                                                                                                                                                                                        set "FormatoVideo2160p=%%q"
                                                                                                                                                                                        set "Val_Edgelevel=%%r"
                                                                                                                                                                                        set "ColorCorrectionVal=%%s"
                                                                                                                                                                                        @REM set "UnicoPassaggio=!unicopassaggiow!"
                                                                                                                                                                                        @REM set "Val_Lookahead=%%u"
                                                                                                                                                                                        @REM set "Val_Precisione_Vettore_Movimento=%%u"

                                                                                                                                                                                        @REM echo NomeFile = !NomeFile!
                                                                                                                                                                                        @REM echo NomeFileOutput4k = !NomeFileOutput4k!
                                                                                                                                                                                        @REM echo NomeFileOutput2k = !NomeFileOutput2k!
                                                                                                                                                                                        @REM echo cropff = !cropff!
                                                                                                                                                                                        @REM echo RisoluzioneVideo4k = !RisoluzioneVideo4k!
                                                                                                                                                                                        @REM echo RisoluzioneVideo2k = !RisoluzioneVideo2k!
                                                                                                                                                                                        @REM echo hdrsettings = !hdrsettings!
                                                                                                                                                                                        @REM echo ColorPrimary = !ColorPrimary!
                                                                                                                                                                                        @REM echo ColorTransfer = !ColorTransfer!
                                                                                                                                                                                        @REM echo ColorMatrix = !ColorMatrix!
                                                                                                                                                                                        @REM echo TipoCodifica = !TipoCodifica!
                                                                                                                                                                                        @REM echo QualitaCodifica = !QualitaCodifica!
                                                                                                                                                                                        @REM echo TipoQuantizzazione = !TipoQuantizzazione!
                                                                                                                                                                                        @REM echo IntensitaQuantizzazione = !IntensitaQuantizzazione!
                                                                                                                                                                                        @REM echo Denoiser = !Denoiser!
                                                                                                                                                                                        @REM echo FormatoVideo2160p = !FormatoVideo2160p!
                                                                                                                                                                                        @REM echo Val_Edgelevel = !Val_Edgelevel!
                                                                                                                                                                                        @REM echo ColorCorrectionVal = !ColorCorrectionVal!
                                                                                                                                                                                        @REM echo UnicoPassaggio= !unicopassaggiow!
                                                                                                                                                                                        @REM echo Val_Lookahead = !Val_Lookahead!
                                                                                                                                                                                        @REM echo Val_Precisione_Vettore_Movimento = !Val_Precisione_Vettore_Movimento!

                                                                                                                                                                                        call:Avvio_Codifica_Intel_DownScaling_DownGrading_da_2160p_10bit_HDR_a_1080p_8bit_SDR

                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==NVEnc_DownGrading_da_1080p_10bit_SDR_a_1080p_8bit_SDR (
                                                                                                                                                                                        echo !t4! !t41!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        @REM echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        @REM echo Color Correction: %%s
                                                                                                                                                                                        @REM if %%t==1 ( set unicopassaggiow=Si ) else ( set unicopassaggiow=No )
                                                                                                                                                                                        @REM echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.

                                                                                                                                                                                        set "NomeFile=%%b"
                                                                                                                                                                                        set "NomeFileOutput4k=%%c"
                                                                                                                                                                                        @REM set "NomeFileOutput2k=%%d"
                                                                                                                                                                                        set "cropff=%%e"
                                                                                                                                                                                        set "RisoluzioneVideo4k=%%f"
                                                                                                                                                                                        @REM set "RisoluzioneVideo2k=%%g"
                                                                                                                                                                                        @REM set "hdrsettings=%%h"
                                                                                                                                                                                        set "ColorPrimary=%%i"
                                                                                                                                                                                        set "ColorTransfer=%%j"
                                                                                                                                                                                        set "ColorMatrix=%%k"
                                                                                                                                                                                        set "TipoCodifica=%%l"
                                                                                                                                                                                        set "QualitaCodifica=%%m"
                                                                                                                                                                                        @REM set "TipoQuantizzazione=%%n"
                                                                                                                                                                                        @REM set "IntensitaQuantizzazione=%%o"
                                                                                                                                                                                        set "Denoiser=%%p"
                                                                                                                                                                                        set "FormatoVideo2160p=%%q"
                                                                                                                                                                                        set "Val_Edgelevel=%%r"
                                                                                                                                                                                        @REM set "ColorCorrectionVal=%%s"
                                                                                                                                                                                        @REM set "UnicoPassaggio=!unicopassaggiow!"
                                                                                                                                                                                        @REM set "Val_Lookahead=%%u"
                                                                                                                                                                                        @REM set "Val_Precisione_Vettore_Movimento=%%u"

                                                                                                                                                                                        @REM echo NomeFile = !NomeFile!
                                                                                                                                                                                        @REM echo NomeFileOutput4k = !NomeFileOutput4k!
                                                                                                                                                                                        @REM echo NomeFileOutput2k = !NomeFileOutput2k!
                                                                                                                                                                                        @REM echo cropff = !cropff!
                                                                                                                                                                                        @REM echo RisoluzioneVideo4k = !RisoluzioneVideo4k!
                                                                                                                                                                                        @REM echo RisoluzioneVideo2k = !RisoluzioneVideo2k!
                                                                                                                                                                                        @REM echo hdrsettings = !hdrsettings!
                                                                                                                                                                                        @REM echo ColorPrimary = !ColorPrimary!
                                                                                                                                                                                        @REM echo ColorTransfer = !ColorTransfer!
                                                                                                                                                                                        @REM echo ColorMatrix = !ColorMatrix!
                                                                                                                                                                                        @REM echo TipoCodifica = !TipoCodifica!
                                                                                                                                                                                        @REM echo QualitaCodifica = !QualitaCodifica!
                                                                                                                                                                                        @REM echo TipoQuantizzazione = !TipoQuantizzazione!
                                                                                                                                                                                        @REM echo IntensitaQuantizzazione = !IntensitaQuantizzazione!
                                                                                                                                                                                        @REM echo Denoiser = !Denoiser!
                                                                                                                                                                                        @REM echo FormatoVideo2160p = !FormatoVideo2160p!
                                                                                                                                                                                        @REM echo Val_Edgelevel = !Val_Edgelevel!
                                                                                                                                                                                        @REM echo ColorCorrectionVal = !ColorCorrectionVal!
                                                                                                                                                                                        @REM echo UnicoPassaggio= !unicopassaggiow!
                                                                                                                                                                                        @REM echo Val_Lookahead = !Val_Lookahead!
                                                                                                                                                                                        @REM echo Val_Precisione_Vettore_Movimento = !Val_Precisione_Vettore_Movimento!

                                                                                                                                                                                        call:Avvio_Codifica_Hardware_NVidia_DownGrading_da_1080p_10bit_SDR_a_1080_8bit_SDR

                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==QSVEnc_DownGrading_da_1080p_10bit_SDR_a_1080p_8bit_SDR (
                                                                                                                                                                                        echo !t4! !t42!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        @REM echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        @REM echo Color Correction: %%s
                                                                                                                                                                                        @REM if %%t==1 ( set unicopassaggiow=Si ) else ( set unicopassaggiow=No )
                                                                                                                                                                                        @REM echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.

                                                                                                                                                                                        set "NomeFile=%%b"
                                                                                                                                                                                        set "NomeFileOutput4k=%%c"
                                                                                                                                                                                        @REM set "NomeFileOutput2k=%%d"
                                                                                                                                                                                        set "cropff=%%e"
                                                                                                                                                                                        set "RisoluzioneVideo4k=%%f"
                                                                                                                                                                                        @REM set "RisoluzioneVideo2k=%%g"
                                                                                                                                                                                        @REM set "hdrsettings=%%h"
                                                                                                                                                                                        set "ColorPrimary=%%i"
                                                                                                                                                                                        set "ColorTransfer=%%j"
                                                                                                                                                                                        set "ColorMatrix=%%k"
                                                                                                                                                                                        set "TipoCodifica=%%l"
                                                                                                                                                                                        set "QualitaCodifica=%%m"
                                                                                                                                                                                        @REM set "TipoQuantizzazione=%%n"
                                                                                                                                                                                        @REM set "IntensitaQuantizzazione=%%o"
                                                                                                                                                                                        set "Denoiser=%%p"
                                                                                                                                                                                        set "FormatoVideo2160p=%%q"
                                                                                                                                                                                        set "Val_Edgelevel=%%r"
                                                                                                                                                                                        @REM set "ColorCorrectionVal=%%s"
                                                                                                                                                                                        @REM set "UnicoPassaggio=!unicopassaggiow!"
                                                                                                                                                                                        @REM set "Val_Lookahead=%%u"
                                                                                                                                                                                        @REM set "Val_Precisione_Vettore_Movimento=%%u"

                                                                                                                                                                                        @REM echo NomeFile = !NomeFile!
                                                                                                                                                                                        @REM echo NomeFileOutput4k = !NomeFileOutput4k!
                                                                                                                                                                                        @REM echo NomeFileOutput2k = !NomeFileOutput2k!
                                                                                                                                                                                        @REM echo cropff = !cropff!
                                                                                                                                                                                        @REM echo RisoluzioneVideo4k = !RisoluzioneVideo4k!
                                                                                                                                                                                        @REM echo RisoluzioneVideo2k = !RisoluzioneVideo2k!
                                                                                                                                                                                        @REM echo hdrsettings = !hdrsettings!
                                                                                                                                                                                        @REM echo ColorPrimary = !ColorPrimary!
                                                                                                                                                                                        @REM echo ColorTransfer = !ColorTransfer!
                                                                                                                                                                                        @REM echo ColorMatrix = !ColorMatrix!
                                                                                                                                                                                        @REM echo TipoCodifica = !TipoCodifica!
                                                                                                                                                                                        @REM echo QualitaCodifica = !QualitaCodifica!
                                                                                                                                                                                        @REM echo TipoQuantizzazione = !TipoQuantizzazione!
                                                                                                                                                                                        @REM echo IntensitaQuantizzazione = !IntensitaQuantizzazione!
                                                                                                                                                                                        @REM echo Denoiser = !Denoiser!
                                                                                                                                                                                        @REM echo FormatoVideo2160p = !FormatoVideo2160p!
                                                                                                                                                                                        @REM echo Val_Edgelevel = !Val_Edgelevel!
                                                                                                                                                                                        @REM echo ColorCorrectionVal = !ColorCorrectionVal!
                                                                                                                                                                                        @REM echo UnicoPassaggio= !unicopassaggiow!
                                                                                                                                                                                        @REM echo Val_Lookahead = !Val_Lookahead!
                                                                                                                                                                                        @REM echo Val_Precisione_Vettore_Movimento = !Val_Precisione_Vettore_Movimento!

                                                                                                                                                                                        call:Avvio_Codifica_Hardware_Intel_DownGrading_da_1080p_10bit_SDR_a_1080_8bit_SDR

                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )



                                                                                                                                                                                    set /a "numeroriga+=1"
                                                                                                                                                                    )
                                                goto fineletturaFFmpegCodifichesalvatesuDisco_AvvioCodificheSalvatesuDisco
                                                )

echo Nessun Video da Codificare Salvato sul Disco. 
                                    echo.

:fineletturaFFmpegCodifichesalvatesuDisco_AvvioCodificheSalvatesuDisco

goto file_avvio_docifiche_salvate_sul_disco





rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////

:Avvio_Semplice_Codifca_FFmpeg

set file_senza_virgolette=!NomeFileOutput:"=!
@REM echo %file_senza_virgolette%
@REM echo.

for %%i in ("!file_senza_virgolette!") do (  
                                                                set "solo_nome_file=%%~ni"
                                                                @REM echo Nome file: !solo_nome_file!
                                                                @REM echo.

                                                                set "solo_estensione_file=%%~xi"
                                                                @REM echo Estensione: !solo_estensione_file!
                                                                @REM echo.
                                                                )

@REM echo.
set solo_nome_fileoutput_rinominato="!solo_nome_file!_Rinominato.mkv"       
@REM echo solo_nome_fileoutput_rinominato = !solo_nome_fileoutput_rinominato!     
@REM echo.

@REM pause

if !hdrsettings!==nessuno ( 
    goto InizioCodifica8bitSDRFFmpegSempliceCodifica_Avvio_Semplice_Codifca_FFmpeg 
    ) else (
        goto InizioCodifica10bitHDRFFmpegSempliceCodifica_Avvio_Semplice_Codifca_FFmpeg
    )



:InizioCodifica10bitHDRFFmpegSempliceCodifica_Avvio_Semplice_Codifca_FFmpeg

if !Denoiser!==nessuno (
    set "Denoiser="
    )


start "Codifica Priorita' Alta" /d ".\bin" /high /affinity 0x00000000FFFFFFFF /Wait /b ".\bin\ffmpeg.exe" -y -i !NomeFile!  -max_muxing_queue_size 1024  !Denoiser!  -c:v libx265 -pix_fmt !FormatoVideo! -profile:v main10  -x265-params "!TipoQuantizzazione!:!IntensitaQuantizzazione!:repeat-headers=1:strong-intra-smoothing=1:bframes=4:b-adapt=2:frame-threads=0:colorprim=!ColorPrimary!:transfer=!ColorTransfer!:colormatrix=!ColorMatrix!:hdr10_opt=1:!hdrsettings!:hdr10=1:chromaloc=2"  !TipoCodifica!  !QualitaCodifica!  -hide_banner -stats -loglevel panic  -map_metadata -1 -map_chapters 0   -default_mode infer_no_subs   -threads 2  !NomeFileOutput!

ren !NomeFileOutput! !solo_nome_fileoutput_rinominato! 

echo.
echo !t43!
echo.

goto finerealehdrFmpegSempliceCodifica_Avvio_Semplice_Codifca_FFmpeg




:InizioCodifica8bitSDRFFmpegSempliceCodifica_Avvio_Semplice_Codifca_FFmpeg

if !Denoiser!==nessuno (
    set "Denoiser="
    )


start "Codifica Priorita' Alta" /d ".\bin" /high /affinity 0x00000000FFFFFFFF /Wait /b ".\bin\ffmpeg.exe" -y -i !NomeFile!  -max_muxing_queue_size 1024  !Denoiser!  -c:v libx265 -pix_fmt !FormatoVideo! -profile:v main  -x265-params "!TipoQuantizzazione!:!IntensitaQuantizzazione!:repeat-headers=1:strong-intra-smoothing=1:bframes=4:b-adapt=2:frame-threads=0:colorprim=!ColorPrimary!:transfer=!ColorTransfer!:colormatrix=!ColorMatrix!:chromaloc=0"  !TipoCodifica!  !QualitaCodifica!  -hide_banner -stats -loglevel panic  -map_metadata -1 -map_chapters 0   -default_mode infer_no_subs   -threads 2  !NomeFileOutput!

ren !NomeFileOutput! !solo_nome_fileoutput_rinominato! 

echo.
echo !t43!
echo.

:finerealehdrFmpegSempliceCodifica_Avvio_Semplice_Codifca_FFmpeg

goto:eof

rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////









rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////

:Avvio_Codifca_Software_FFmpeg_2160p_e_1080p_da_2160p

set file_senza_virgolette4k=!NomeFileOutput4k:"=!
@REM echo %file_senza_virgolette4k%
@REM echo.

for %%i in ("!file_senza_virgolette4k!") do (  
                                                                set "solo_nome_file4k=%%~ni"
                                                                @REM echo Nome file: !solo_nome_file!
                                                                @REM echo.

                                                                set "solo_estensione_file4k=%%~xi"
                                                                @REM echo Estensione: !solo_estensione_file!
                                                                @REM echo.
                                                                )

@REM echo.
set solo_nome_fileoutput_rinominato4k="!solo_nome_file4k!_Rinominato.mkv"       
@REM echo solo_nome_fileoutput_rinominato4k = !solo_nome_fileoutput_rinominato4k!     
@REM echo.


set file_senza_virgolette2k=!NomeFileOutput2k:"=!
@REM echo %file_senza_virgolette4k%
@REM echo.

for %%i in ("!file_senza_virgolette2k!") do (  
                                                                set "solo_nome_file2k=%%~ni"
                                                                @REM echo Nome file: !solo_nome_file!
                                                                @REM echo.

                                                                set "solo_estensione_file2k=%%~xi"
                                                                @REM echo Estensione: !solo_estensione_file!
                                                                @REM echo.
                                                                )

@REM echo.
set solo_nome_fileoutput_rinominato2k="!solo_nome_file2k!_Rinominato.mkv"       
@REM echo solo_nome_fileoutput_rinominato2k = !solo_nome_fileoutput_rinominato2k!     
@REM echo.

for /f "tokens=1,2 delims=x" %%a in ("!RisoluzioneVideo4k!") do  (
                                                                    set "Width4k=%%a"
                                                                    set "Height4k=%%b"
                                                                    @REM echo Width4k = !Width4k!
                                                                    @REM echo Height4k = !Height4k!
                                                                    @REM echo.
                                                                    )

if !Denoiser!==nessuno if not exist ".\logo_3840x2160.ass" (
    set "filter4k=!cropff!,scale=!Width4k!:!Height4k!:flags=lanczos"
    @REM echo filter4k = !filter4k!3
    @REM echo.
    ) 

if !Denoiser!==nessuno if exist ".\logo_3840x2160.ass" (
    set "filter4k=!cropff!,scale=!Width4k!:!Height4k!:flags=lanczos,ass=logo_3840x2160.ass"
    @REM echo filter4k = !filter4k!3
    @REM echo.
    ) 

if !Denoiser! NEQ nessuno if not exist ".\logo_3840x2160.ass" (
    set "filter4k=!cropff!,scale=!Width4k!:!Height4k!:flags=lanczos,!Denoiser!"
    @REM echo filter4k = !filter4k!
    @REM echo.
    ) 

if !Denoiser! NEQ nessuno if exist ".\logo_3840x2160.ass" (
    set "filter4k=!cropff!,scale=!Width4k!:!Height4k!:flags=lanczos,!Denoiser!,ass=logo_3840x2160.ass"
    @REM echo filter4k = !filter4k!
    @REM echo.
    )     


@REM pause


for /f "tokens=1,2 delims=x" %%a in ("!RisoluzioneVideo2k!") do  (
                                                                    set "Width2k=%%a"
                                                                    set "Height2k=%%b"
                                                                    @REM echo Width2k = !Width2k!
                                                                    @REM echo Height2k = !Height2k!
                                                                    @REM echo.
                                                                    )

if !Denoiser!==nessuno if not exist ".\logo_3840x2160.ass" (
    set "filter2k=!cropff!,libplacebo=upscaler=spline36:downscaler=spline36:w=!Width2k!:h=!Height2k!:peak_detect=true:tonemapping=spline:gamut_mode=perceptual:colorspace=bt709:color_trc=bt709:color_primaries=bt709:range=limited:dithering=blue:format=yuv420p,scale=!Width2k!:!Height2k!:flags=lanczos,setsar=1:1,sidedata=delete"
    @REM echo filter2k = !filter2k!
    @REM echo.
    ) 

if !Denoiser!==nessuno if exist ".\logo_3840x2160.ass" (
    set "filter2k=!cropff!,libplacebo=upscaler=spline36:downscaler=spline36:w=!Width2k!:h=!Height2k!:peak_detect=true:tonemapping=spline:gamut_mode=perceptual:colorspace=bt709:color_trc=bt709:color_primaries=bt709:range=limited:dithering=blue:format=yuv420p,scale=!Width2k!:!Height2k!:flags=lanczos,setsar=1:1,sidedata=delete,ass=logo_3840x2160.ass"
    @REM echo filter2k = !filter2k!
    @REM echo.
    ) 

if !Denoiser! NEQ nessuno if not exist ".\logo_3840x2160.ass" (
    set "filter2k=!cropff!,libplacebo=upscaler=spline36:downscaler=spline36:w=!Width2k!:h=!Height2k!:peak_detect=true:tonemapping=spline:gamut_mode=perceptual:colorspace=bt709:color_trc=bt709:color_primaries=bt709:range=limited:dithering=blue:format=yuv420p,scale=!Width2k!:!Height2k!:flags=lanczos,setsar=1:1,sidedata=delete,!Denoiser!"
    @REM echo filter2k = !filter2k!
    @REM echo.
    ) 

if !Denoiser! NEQ nessuno if exist ".\logo_3840x2160.ass" (
    set "filter2k=!cropff!,libplacebo=upscaler=spline36:downscaler=spline36:w=!Width2k!:h=!Height2k!:peak_detect=true:tonemapping=spline:gamut_mode=perceptual:colorspace=bt709:color_trc=bt709:color_primaries=bt709:range=limited:dithering=blue:format=yuv420p,scale=!Width2k!:!Height2k!:flags=lanczos,setsar=1:1,sidedata=delete,!Denoiser!,ass=logo_3840x2160.ass"
    @REM echo filter2k = !filter2k!
    @REM echo.
    )     

@REM pause

echo !t44!
echo.

@REM echo RisoluzioneVideo4k = !RisoluzioneVideo4k!
@REM echo.


@REM echo start "Codifica Priorita' Alta" /d ".\bin" /high /affinity 0x00000000FFFFFFFF /Wait /b ".\bin\ffmpeg.exe" -y -i !NomeFile!  -max_muxing_queue_size 1024  -filter_complex "[0:0]!cropff!!denoiser!ass=logo_3840x2160.ass[v]"  -map "[v]" -c:v libx265 -pix_fmt !FormatoVideo2160p! -profile:v main10  -x265-params "!TipoQuantizzazione!:!IntensitaQuantizzazione!:repeat-headers=1:strong-intra-smoothing=1:bframes=4:b-adapt=2:frame-threads=0:colorprim=!ColorPrimary!:transfer=!ColorTransfer!:colormatrix=!ColorMatrix!:hdr10_opt=1:!hdrsettings!:hdr10=1:chromaloc=2"  !TipoCodifica2160p!  !QualitaCodifica!  -hide_banner -stats -loglevel panic  -map_metadata -1 -map_chapters 0   -default_mode infer_no_subs   -threads 2  !NomeFileOutput4k!

start "Codifica Priorita' Alta" /d ".\bin" /high /affinity 0x00000000FFFFFFFF /Wait /b ".\bin\ffmpeg.exe" -y -i !NomeFile!  -max_muxing_queue_size 1024  -filter_complex "[0:0]!filter4k![v]" -map "[v]" -c:v libx265 -pix_fmt !FormatoVideo2160p! -profile:v main10  -x265-params "!TipoQuantizzazione!:!IntensitaQuantizzazione!:repeat-headers=1:strong-intra-smoothing=1:bframes=4:b-adapt=2:frame-threads=0:colorprim=!ColorPrimary!:transfer=!ColorTransfer!:colormatrix=!ColorMatrix!:hdr10_opt=1:!hdrsettings!:hdr10=1:chromaloc=2"  !TipoCodifica2160p!  !QualitaCodifica!  -hide_banner -stats -loglevel panic  -map_metadata -1 -map_chapters 0   -default_mode infer_no_subs   -threads 2  !NomeFileOutput4k!

ren !NomeFileOutput4k! !solo_nome_fileoutput_rinominato4k! 

echo.
echo !t45!
echo.

@REM pause


echo !t46!
echo.

@REM echo RisoluzioneVideo2k = !RisoluzioneVideo2k!
@REM echo.


@REM echo start "Codifica Priorita' Alta" /d ".\bin" /high /affinity 0x00000000FFFFFFFF /Wait /b ".\bin\ffmpeg.exe" -y -init_hw_device vulkan -i !NomeFile!  -max_muxing_queue_size 1024  -filter_complex "[0:0]!cropff!!denoiser!libplacebo=upscaler=spline36:downscaler=spline36:w=1920:h=-1:peak_detect=true:tonemapping=spline:gamut_mode=perceptual:colorspace=bt709:color_trc=bt709:color_primaries=bt709:range=limited:dithering=blue:format=yuv420p,scale=1920:-8:flags=lanczos,setsar=1:1,sidedata=delete,ass=logo_3840x2160.ass[v]" -map "[v]"  -c:v libx265 -pix_fmt !FormatoVideo1080p! -profile:v main  -x265-params "!TipoQuantizzazione!:!IntensitaQuantizzazione!:repeat-headers=1:strong-intra-smoothing=1:bframes=4:b-adapt=2:frame-threads=0:colorprim=bt709:transfer=bt709:colormatrix=bt709:chromaloc=0"  !TipoCodifica1080p!  !QualitaCodifica!  -hide_banner -stats -loglevel panic -map_metadata -1 -map_chapters 0   -default_mode infer_no_subs    -threads 2  !NomeFileOutput2k!

start "Codifica Priorita' Alta" /d ".\bin" /high /affinity 0x00000000FFFFFFFF /Wait /b ".\bin\ffmpeg.exe" -y -init_hw_device vulkan -i !NomeFile!  -max_muxing_queue_size 1024  -filter_complex "[0:0]!filter2k![v]" -map "[v]"  -c:v libx265 -pix_fmt !FormatoVideo1080p! -profile:v main  -x265-params "!TipoQuantizzazione!:!IntensitaQuantizzazione!:repeat-headers=1:strong-intra-smoothing=1:bframes=4:b-adapt=2:frame-threads=0:colorprim=bt709:transfer=bt709:colormatrix=bt709:chromaloc=0"  !TipoCodifica1080p!  !QualitaCodifica!  -hide_banner -stats -loglevel panic  -map_metadata -1 -map_chapters 0   -default_mode infer_no_subs   -threads 2  !NomeFileOutput2k!


@REM echo start "Codifica Priorita' Alta" /d ".\bin" /high /affinity 0x00000000FFFFFFFF /Wait /b ".\bin\ffmpeg.exe" -y -i !NomeFile!  -max_muxing_queue_size 1024  !Denoiser!  -c:v libx265 -pix_fmt !FormatoVideo! -profile:v main  -x265-params "!TipoQuantizzazione!:!IntensitaQuantizzazione!:repeat-headers=1:strong-intra-smoothing=1:bframes=4:b-adapt=2:frame-threads=0:colorprim=!ColorPrimary!:transfer=!ColorTransfer!:colormatrix=!ColorMatrix!:chromaloc=0"  !TipoCodifica!  !QualitaCodifica!  -hide_banner -stats -loglevel verbose  -map_metadata -1 -map_chapters 0   -default_mode infer_no_subs   -threads 2  !NomeFileOutput!

ren !NomeFileOutput2k! !solo_nome_fileoutput_rinominato2k! 

echo.
echo !t47!
echo.


goto:eof

rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////




rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////

:Avvio_Codifca_Hardware_NVidia_2160p_Pulizia_Leggera_Miglioramento_Dettagli


set fileoutput2160p_senza_virgolette=%NomeFileOutput4k:"=% 
rem echo %fileoutput2160p_senza_virgolette%

for %%i in ("%fileoutput2160p_senza_virgolette%") do (  
                                                        set "solo_nome_file=%%~ni"
                                                        rem echo Nome file: !solo_nome_file!

                                                        set "solo_estensione_file=%%~xi"
                                                        rem echo Estensione: !solo_estensione_file!
                                                    )

set fileoutput2160p_rinominato="!solo_nome_file!_rinominato!solo_estensione_file!"
@REM echo fileoutput2160p_rinominato = !fileoutput2160p_rinominato!
@REM echo.

if !Denoiser!==nessuno (
    set "Denoiser="
)

".\bin\nvenc\NVEncC64.exe" --avsw --device 0 -i !NomeFile!  !cropff!  --output-res !RisoluzioneVideo4k! --video-metadata clear --metadata clear --chapter-copy -c hevc !TipoCodifica! --bref-mode disabled !QualitaCodifica! --lookahead 32 --aq --aq-temporal --aq-strength 15 --profile main10 --level auto --tier high --chromaloc auto --colorrange auto --colormatrix !ColorMatrix! --transfer !ColorTransfer! --colorprim !ColorPrimary! --master-display copy --max-cll copy --output-depth 10 --multipass None --mv-precision Q-pel --avsync cfr --psnr --ssim     -m default_mode:infer_no_subs    !Denoiser!  --vpp-resize algo=lanczos4  --vpp-edgelevel strength=10.0,threshold=24.0,black=6.0  --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o !NomeFileOutput4k!

ren !NomeFileOutput4k! !fileoutput2160p_rinominato!

echo.
echo !t48!
echo.

goto:eof

rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////



rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////

:Avvio_Codifca_Hardware_Intel_2160p_Pulizia_Leggera_Miglioramento_Dettagli


set fileoutput2160p_senza_virgolette=%NomeFileOutput4k:"=% 
rem echo %fileoutput2160p_senza_virgolette%

for %%i in ("%fileoutput2160p_senza_virgolette%") do (  
                                                        set "solo_nome_file=%%~ni"
                                                        rem echo Nome file: !solo_nome_file!

                                                        set "solo_estensione_file=%%~xi"
                                                        rem echo Estensione: !solo_estensione_file!
                                                    )

set fileoutput2160p_rinominato="!solo_nome_file!_rinominato!solo_estensione_file!"
@REM echo fileoutput2160p_rinominato = !fileoutput2160p_rinominato!
@REM echo.

if !Denoiser!==nessuno (
    set "Denoiser="
)

".\bin\qsvencc\QSVEncC64.exe" --avsw --device auto -i !NomeFile!  !cropff!  --output-res !RisoluzioneVideo4k! --video-metadata clear --metadata clear --chapter-copy -c hevc !TipoCodifica! !QualitaCodifica! --la-depth 32  --level auto  --chromaloc auto --colorrange auto --colormatrix !ColorMatrix! --transfer !ColorTransfer! --colorprim !ColorPrimary! --master-display copy --max-cll copy --output-depth 10  --avsync cfr --psnr --ssim     -m default_mode:infer_no_subs    !Denoiser!  --vpp-resize algo=lanczos4  --vpp-edgelevel strength=10.0,threshold=24.0,black=6.0  --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o !NomeFileOutput4k!

ren !NomeFileOutput4k! !fileoutput2160p_rinominato!

echo.
echo !t49!
echo.

goto:eof

rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////



rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////

:Avvio_Semplice_Codifca_Hardware_NVidia

set fileoutput2160p_senza_virgolette=%NomeFileOutput4k:"=% 
rem echo %fileoutput2160p_senza_virgolette%

for %%i in ("%fileoutput2160p_senza_virgolette%") do (  
                                                        set "solo_nome_file=%%~ni"
                                                        rem echo Nome file: !solo_nome_file!

                                                        set "solo_estensione_file=%%~xi"
                                                        rem echo Estensione: !solo_estensione_file!
                                                    )

set fileoutput2160p_rinominato="!solo_nome_file!_rinominato!solo_estensione_file!"
@REM echo fileoutput2160p_rinominato = !fileoutput2160p_rinominato!
@REM echo.

if !FormatoVideo2160p!==yuv420p (
        set "tiervalue=--tier main"
        set "outputdepthvalue=--output-depth 8"
)

if !FormatoVideo2160p!==yuv420p10le (
        set "tiervalue=--tier high"
        set "outputdepthvalue=--output-depth 10"
)

if !Denoiser!==nessuno (
    set "Denoiser="
)

if !Val_Edgelevel!==nessuno (
    set "Val_Edgelevel="
)

".\bin\nvenc\NVEncC64.exe" --avsw --device 0 -i !NomeFile!  --output-res !RisoluzioneVideo4k!  !cropff! --video-metadata clear --metadata clear --chapter-copy -c hevc !TipoCodifica! --bref-mode disabled !QualitaCodifica! !TipoQuantizzazione! !IntensitaQuantizzazione! --profile auto --level auto !tiervalue! --chromaloc auto --colorrange auto --colormatrix auto --transfer auto --colorprim auto --master-display copy --max-cll copy  !outputdepthvalue! --multipass None !Val_Precisione_Vettore_Movimento! --avsync cfr --psnr --ssim     -m default_mode:infer_no_subs    --vpp-resize algo=lanczos4  !Val_Edgelevel! !Denoiser! --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o !NomeFileOutput4k!

ren !NomeFileOutput4k! !fileoutput2160p_rinominato!

echo.
echo !t50!
echo.


goto:eof

rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////



rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////

:Avvio_Semplice_Codifca_Hardware_Intel

set fileoutput2160p_senza_virgolette=%NomeFileOutput4k:"=% 
rem echo %fileoutput2160p_senza_virgolette%

for %%i in ("%fileoutput2160p_senza_virgolette%") do (  
                                                        set "solo_nome_file=%%~ni"
                                                        rem echo Nome file: !solo_nome_file!

                                                        set "solo_estensione_file=%%~xi"
                                                        rem echo Estensione: !solo_estensione_file!
                                                    )

set fileoutput2160p_rinominato="!solo_nome_file!_rinominato!solo_estensione_file!"
@REM echo fileoutput2160p_rinominato = !fileoutput2160p_rinominato!
@REM echo.

if !FormatoVideo2160p!==yuv420p (
        set "tiervalue=--tier main"
        set "outputdepthvalue=--output-depth 8"
)

if !FormatoVideo2160p!==yuv420p10le (
        set "tiervalue=--tier high"
        set "outputdepthvalue=--output-depth 10"
)

if !Denoiser!==nessuno (
    set "Denoiser="
)

if !Val_Edgelevel!==nessuno (
    set "Val_Edgelevel="
)


".\bin\qsvencc\QSVEncC64.exe" --avsw --device auto -i !NomeFile!  --output-res !RisoluzioneVideo4k!  !cropff! --video-metadata clear --metadata clear --chapter-copy -c hevc !TipoCodifica!  !QualitaCodifica! !Val_Lookahead! --profile auto --level auto --chromaloc auto --colorrange auto --colormatrix auto --transfer auto --colorprim auto --master-display copy --max-cll copy  !outputdepthvalue!  --avsync cfr --psnr --ssim     -m default_mode:infer_no_subs    --vpp-resize algo=lanczos4  !Val_Edgelevel! !Denoiser! --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o !NomeFileOutput4k!


ren !NomeFileOutput4k! !fileoutput2160p_rinominato!

echo.
echo !t51!
echo.



goto:eof

rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////



rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////

:Avvio_Codifica_Hardware_NVidia_UpScaling_UpGrading_da_1080p_a_2160p


set fileoutput2160p_solo_UpScaling_senza_virgolette=%NomeFile:"=% 
@REM echo fileoutput2160p_solo_UpScaling_senza_virgolette = %fileoutput2160p_solo_UpScaling_senza_virgolette%


for %%i in ("%fileoutput2160p_solo_UpScaling_senza_virgolette%") do (  
                                                                        
                                                                        set "solo_directory=%%~dpi"
                                                                        @REM echo Directory: "!solo_directory!"
                                                                       
                                                                        set "solo_nome_file=%%~ni"
                                                                        @REM echo Nome file: "!solo_nome_file!"
                                                                  
                                                                        set "solo_estensione_file=%%~xi"
                                                                        @REM echo Estensione: "!solo_estensione_file!"
                                                                   
                                                                    )


set "fileoutput2160p_solo_UpScaling_Finale=^"!solo_directory!!solo_nome_file!_UpScaled!solo_estensione_file!^""
@REM echo fileoutput2160p_solo_UpScaling_Finale = !fileoutput2160p_solo_UpScaling_Finale!



set fileoutput2160p_senza_virgolette=%NomeFileOutput4k:"=% 
@rem echo %fileoutput2160p_senza_virgolette%

for %%i in ("%fileoutput2160p_senza_virgolette%") do (  
                                                        set "solo_nome_file=%%~ni"
                                                        rem echo Nome file: !solo_nome_file!

                                                        set "solo_estensione_file=%%~xi"
                                                        rem echo Estensione: !solo_estensione_file!
                                                    )

set fileoutput2160p_rinominato="!solo_nome_file!_rinominato!solo_estensione_file!"
@REM echo fileoutput2160p_rinominato = !fileoutput2160p_rinominato!
@REM echo.


if !Denoiser!==nessuno (
    set "Denoiser="
)

if !Val_Edgelevel!==nessuno (
    set "Val_Edgelevel="
)

@REM echo unicopassaggiow = !unicopassaggiow!

if !unicopassaggiow!==Si ( 
    @REM echo dentro if
    goto codificaunicopassaggio_Avvio_Codifica_Hardware_NVidia_UpScaling_UpGrading_da_1080p_a_2160p 
)

echo.
echo !t52!
echo.

".\bin\nvenc\NVEncC64.exe" --avsw --device 0 -i !NomeFile!  --output-res !RisoluzioneVideo4k!  !cropff! --video-metadata clear --metadata clear --chapter-copy -c hevc !TipoCodifica! --bref-mode disabled !QualitaCodifica! --lookahead 32 --aq --aq-temporal --aq-strength 15 --profile main10 --level auto --tier high --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display "G(13250,34500)B(7500,3000)R(34000,16000)WP(15635,16450)L(10000000,1)" --max-cll "1000,400"  --output-depth 10 --multipass None --mv-precision Q-pel --avsync cfr --psnr --ssim     -m default_mode:infer_no_subs    !ColorCorrectionVal!   --vpp-resize algo=lanczos4  --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o !fileoutput2160p_solo_UpScaling_Finale!

echo.
echo !t53!
echo.

".\bin\nvenc\NVEncC64.exe" --avsw --device 0 -i !fileoutput2160p_solo_UpScaling_Finale!  --crop 0,0,0,0  --video-metadata clear --metadata clear --chapter-copy -c hevc !TipoCodifica! --bref-mode disabled !QualitaCodifica! --tier high --lookahead 32 --aq --aq-temporal --aq-strength 15 --level auto --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display copy --max-cll copy --output-depth 10 --multipass None --mv-precision Q-pel --avsync cfr     -m default_mode:infer_no_subs  !Denoiser! !Val_Edgelevel!  --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off  --log-level info --log ".\codifica_hardware_out_log.txt" -o !NomeFileOutput4k!

ren !NomeFileOutput4k! !fileoutput2160p_rinominato!

goto fine_Avvio_Codifica_Hardware_NVidia_UpScaling_UpGrading_da_1080p_a_2160p


:codificaunicopassaggio_Avvio_Codifica_Hardware_NVidia_UpScaling_UpGrading_da_1080p_a_2160p

echo.
echo !t54!
echo.

".\bin\nvenc\NVEncC64.exe" --avsw --device 0 -i !NomeFile!  --output-res !RisoluzioneVideo4k!  !cropff! --video-metadata clear --metadata clear --chapter-copy -c hevc !TipoCodifica! --bref-mode disabled !QualitaCodifica! --lookahead 32 --aq --aq-temporal --aq-strength 15 --profile main10 --level auto --tier high --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display "G(13250,34500)B(7500,3000)R(34000,16000)WP(15635,16450)L(10000000,1)" --max-cll "1000,400"  --output-depth 10 --multipass None --mv-precision Q-pel --avsync cfr --psnr --ssim     -m default_mode:infer_no_subs    !ColorCorrectionVal!  --vpp-resize algo=lanczos4  !Denoiser! !Val_Edgelevel!   --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o !NomeFileOutput4k!

ren !NomeFileOutput4k! !fileoutput2160p_rinominato!

:fine_Avvio_Codifica_Hardware_NVidia_UpScaling_UpGrading_da_1080p_a_2160p

echo.
echo !t55!
echo.

goto:eof

rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////




rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////

:Avvio_Codifica_Hardware_Intel_UpScaling_UpGrading_da_1080p_a_2160p

set fileoutput2160p_solo_UpScaling_senza_virgolette=%NomeFile:"=% 
@REM echo fileoutput2160p_solo_UpScaling_senza_virgolette = %fileoutput2160p_solo_UpScaling_senza_virgolette%


for %%i in ("%fileoutput2160p_solo_UpScaling_senza_virgolette%") do (  
                                                                        
                                                                        set "solo_directory=%%~dpi"
                                                                        @REM echo Directory: "!solo_directory!"
                                                                       
                                                                        set "solo_nome_file=%%~ni"
                                                                        @REM echo Nome file: "!solo_nome_file!"
                                                                  
                                                                        set "solo_estensione_file=%%~xi"
                                                                        @REM echo Estensione: "!solo_estensione_file!"
                                                                   
                                                                    )


set "fileoutput2160p_solo_UpScaling_Finale=^"!solo_directory!!solo_nome_file!_UpScaled!solo_estensione_file!^""
@REM echo fileoutput2160p_solo_UpScaling_Finale = !fileoutput2160p_solo_UpScaling_Finale!



set fileoutput2160p_senza_virgolette=%NomeFileOutput4k:"=% 
@rem echo %fileoutput2160p_senza_virgolette%

for %%i in ("%fileoutput2160p_senza_virgolette%") do (  
                                                        set "solo_nome_file=%%~ni"
                                                        rem echo Nome file: !solo_nome_file!

                                                        set "solo_estensione_file=%%~xi"
                                                        rem echo Estensione: !solo_estensione_file!
                                                    )

set fileoutput2160p_rinominato="!solo_nome_file!_rinominato!solo_estensione_file!"
@REM echo fileoutput2160p_rinominato = !fileoutput2160p_rinominato!
@REM echo.


if !Denoiser!==nessuno (
    set "Denoiser="
)

if !Val_Edgelevel!==nessuno (
    set "Val_Edgelevel="
)

@REM echo unicopassaggiow = !unicopassaggiow!

if !unicopassaggiow!==Si ( 
    @REM echo dentro if
    goto codificaunicopassaggio_Avvio_Codifica_Hardware_Intel_UpScaling_UpGrading_da_1080p_a_2160p 
)

echo.
echo !t52!
echo.

".\bin\qsvencc\QSVEncC64.exe" --avsw --device auto -i !NomeFile!  --output-res !RisoluzioneVideo4k!  !cropff! --video-metadata clear --metadata clear --chapter-copy -c hevc !TipoCodifica! !QualitaCodifica! --la-depth 32 --level auto --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display "G(13250,34500)B(7500,3000)R(34000,16000)WP(15635,16450)L(10000000,1)" --max-cll "1000,400"  --output-depth 10   --avsync cfr   --psnr --ssim     -m default_mode:infer_no_subs   !ColorCorrectionVal!  --vpp-resize algo=lanczos4  --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o !fileoutput2160p_solo_UpScaling_Finale!

echo.
echo !t53!
echo.

".\bin\qsvencc\QSVEncC64.exe" --avhw --device auto -i !fileoutput2160p_solo_UpScaling_Finale!  --crop 0,0,0,0  --video-metadata clear --metadata clear --chapter-copy -c hevc !TipoCodifica! !QualitaCodifica! --la-depth 32 --level auto --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display copy --max-cll copy --output-depth 10    --avsync cfr   --psnr --ssim   -m default_mode:infer_no_subs  !Denoiser! !Val_Edgelevel!  --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off  --log-level info --log ".\codifica_hardware_out_log.txt" -o !NomeFileOutput4k!

ren !NomeFileOutput4k! !fileoutput2160p_rinominato!

goto fine_Avvio_Codifica_Hardware_Intel_UpScaling_UpGrading_da_1080p_a_2160p


:codificaunicopassaggio_Avvio_Codifica_Hardware_Intel_UpScaling_UpGrading_da_1080p_a_2160p 

echo.
echo !t54!
echo.

".\bin\qsvencc\QSVEncC64.exe" --avsw --device auto -i !NomeFile!  --output-res !RisoluzioneVideo4k!  !croff! --video-metadata clear --metadata clear --chapter-copy -c hevc !TipoCodifica! !QualitaCodifica! --la-depth 32 --level auto --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display "G(13250,34500)B(7500,3000)R(34000,16000)WP(15635,16450)L(10000000,1)" --max-cll "1000,400"  --output-depth 10   --avsync cfr  --psnr --ssim     -m default_mode:infer_no_subs    !ColorCorrectionVal!   --vpp-resize algo=lanczos4 !Denoiser! !Val_Edgelevel!  --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o !NomeFileOutput4k!

ren !NomeFileOutput4k! !fileoutput2160p_rinominato!


:fine_Avvio_Codifica_Hardware_Intel_UpScaling_UpGrading_da_1080p_a_2160p

echo.
echo !t56!
echo.

goto:eof

rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////




rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////

:NVEnc_UpScaling_da_1080p_10bit_HDR_a_2160p_10bit_hdr

set fileoutput2160p_solo_UpScaling_senza_virgolette=%NomeFile:"=% 
@REM echo fileoutput2160p_solo_UpScaling_senza_virgolette = %fileoutput2160p_solo_UpScaling_senza_virgolette%


for %%i in ("%fileoutput2160p_solo_UpScaling_senza_virgolette%") do (  
                                                                        
                                                                        set "solo_directory=%%~dpi"
                                                                        @REM echo Directory: "!solo_directory!"
                                                                       
                                                                        set "solo_nome_file=%%~ni"
                                                                        @REM echo Nome file: "!solo_nome_file!"
                                                                  
                                                                        set "solo_estensione_file=%%~xi"
                                                                        @REM echo Estensione: "!solo_estensione_file!"
                                                                   
                                                                    )


set "fileoutput2160p_solo_UpScaling_Finale=^"!solo_directory!!solo_nome_file!_UpScaled!solo_estensione_file!^""
@REM echo fileoutput2160p_solo_UpScaling_Finale = !fileoutput2160p_solo_UpScaling_Finale!



set fileoutput2160p_senza_virgolette=%NomeFileOutput4k:"=% 
@rem echo %fileoutput2160p_senza_virgolette%

for %%i in ("%fileoutput2160p_senza_virgolette%") do (  
                                                        set "solo_nome_file=%%~ni"
                                                        rem echo Nome file: !solo_nome_file!

                                                        set "solo_estensione_file=%%~xi"
                                                        rem echo Estensione: !solo_estensione_file!
                                                    )

set fileoutput2160p_rinominato="!solo_nome_file!_rinominato!solo_estensione_file!"
@REM echo fileoutput2160p_rinominato = !fileoutput2160p_rinominato!
@REM echo.


if !Denoiser!==nessuno (
    set "Denoiser="
)

if !Val_Edgelevel!==nessuno (
    set "Val_Edgelevel="
)

@REM echo unicopassaggiow = !unicopassaggiow!

if !unicopassaggiow!==Si ( 
    @REM echo dentro if
    goto codificaunicopassaggio_NVEnc_UpScaling_da_1080p_10bit_HDR_a_2160p_10bit_hdr
)

echo.
echo !t52!
echo.

".\bin\nvenc\NVEncC64.exe" --avsw --device 0 -i !NomeFile!  --output-res !RisoluzioneVideo4k!  !cropff! --video-metadata clear --metadata clear --chapter-copy -c hevc !TipoCodifica! --bref-mode disabled !QualitaCodifica! --lookahead 32 --aq --aq-temporal --aq-strength 15  --profile main10 --level auto --tier high --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display copy --max-cll copy  --output-depth 10 --multipass None --mv-precision Q-pel --avsync cfr --psnr --ssim     -m default_mode:infer_no_subs      --vpp-resize algo=lanczos4  --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o !fileoutput2160p_solo_UpScaling_Finale!

echo.
echo !t53!
echo.

".\bin\nvenc\NVEncC64.exe" --avhw --device 0 -i !fileoutput2160p_solo_UpScaling_Finale!  --crop 0,0,0,0  --video-metadata clear --metadata clear --chapter-copy -c hevc !TipoCodifica! --bref-mode disabled !QualitaCodifica! --tier high --lookahead 32 --aq --aq-temporal --aq-strength 15 --level auto --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display copy --max-cll copy --output-depth 10 --multipass None --mv-precision Q-pel --avsync cfr     -m default_mode:infer_no_subs  !Denoiser! !Val_Edgelevel!  --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off  --log-level info --log ".\codifica_hardware_out_log.txt" -o !NomeFileOutput4k!

ren !NomeFileOutput4k! !fileoutput2160p_rinominato!

goto fine_NVEnc_UpScaling_da_1080p_10bit_HDR_a_2160p_10bit_hdr


:codificaunicopassaggio_NVEnc_UpScaling_da_1080p_10bit_HDR_a_2160p_10bit_hdr

echo.
echo !t54!
echo.

".\bin\nvenc\NVEncC64.exe" --avsw --device 0 -i !NomeFile!  --output-res !RisoluzioneVideo4k!  !cropff! --video-metadata clear --metadata clear --chapter-copy -c hevc !TipoCodifica! --bref-mode disabled !QualitaCodifica! --lookahead 32 --aq --aq-temporal --aq-strength 15  --profile main10 --level auto --tier high --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display copy --max-cll copy  --output-depth 10 --multipass None --mv-precision Q-pel --avsync cfr --psnr --ssim     -m default_mode:infer_no_subs      --vpp-resize algo=lanczos4  !Denoiser! !Val_Edgelevel!  --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o !NomeFileOutput4k!

ren !NomeFileOutput4k! !fileoutput2160p_rinominato!


:fine_NVEnc_UpScaling_da_1080p_10bit_HDR_a_2160p_10bit_hdr

echo.
echo !t57!
echo.

goto:eof

rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////



rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////

:QSVEnc_UpScaling_da_1080p_10bit_HDR_a_2160p_10bit_hdr


set fileoutput2160p_solo_UpScaling_senza_virgolette=%NomeFile:"=% 
@REM echo fileoutput2160p_solo_UpScaling_senza_virgolette = %fileoutput2160p_solo_UpScaling_senza_virgolette%


for %%i in ("%fileoutput2160p_solo_UpScaling_senza_virgolette%") do (  
                                                                        
                                                                        set "solo_directory=%%~dpi"
                                                                        @REM echo Directory: "!solo_directory!"
                                                                       
                                                                        set "solo_nome_file=%%~ni"
                                                                        @REM echo Nome file: "!solo_nome_file!"
                                                                  
                                                                        set "solo_estensione_file=%%~xi"
                                                                        @REM echo Estensione: "!solo_estensione_file!"
                                                                   
                                                                    )


set "fileoutput2160p_solo_UpScaling_Finale=^"!solo_directory!!solo_nome_file!_UpScaled!solo_estensione_file!^""
@REM echo fileoutput2160p_solo_UpScaling_Finale = !fileoutput2160p_solo_UpScaling_Finale!



set fileoutput2160p_senza_virgolette=%NomeFileOutput4k:"=% 
@rem echo %fileoutput2160p_senza_virgolette%

for %%i in ("%fileoutput2160p_senza_virgolette%") do (  
                                                        set "solo_nome_file=%%~ni"
                                                        rem echo Nome file: !solo_nome_file!

                                                        set "solo_estensione_file=%%~xi"
                                                        rem echo Estensione: !solo_estensione_file!
                                                    )

set fileoutput2160p_rinominato="!solo_nome_file!_rinominato!solo_estensione_file!"
@REM echo fileoutput2160p_rinominato = !fileoutput2160p_rinominato!
@REM echo.


if !Denoiser!==nessuno (
    set "Denoiser="
)

if !Val_Edgelevel!==nessuno (
    set "Val_Edgelevel="
)

@REM echo unicopassaggiow = !unicopassaggiow!

if !unicopassaggiow!==Si ( 
    @REM echo dentro if
    goto codificaunicopassaggio_QSVEnc_UpScaling_da_1080p_10bit_HDR_a_2160p_10bit_hdr
)

echo.
echo !t52!
echo.

".\bin\qsvencc\QSVEncC64.exe" --avsw --device auto -i !NomeFile!  --output-res !RisoluzioneVideo4k!  !cropff! --video-metadata clear --metadata clear --chapter-copy -c hevc !TipoCodifica!  !QualitaCodifica! --la-depth 32   --level auto --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display copy --max-cll copy  --output-depth 10  --avsync cfr --psnr --ssim     -m default_mode:infer_no_subs      --vpp-resize algo=lanczos4  --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o !fileoutput2160p_solo_UpScaling_Finale!

echo.
echo !t53!
echo.

".\bin\qsvencc\QSVEncC64.exe" --avhw --device auto -i !fileoutput2160p_solo_UpScaling_Finale!  --crop 0,0,0,0  --video-metadata clear --metadata clear --chapter-copy -c hevc !TipoCodifica!  !QualitaCodifica!  --la-depth 32  --level auto --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display copy --max-cll copy --output-depth 10   --avsync cfr     -m default_mode:infer_no_subs  !Denoiser! !Val_Edgelevel!  --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off  --log-level info --log ".\codifica_hardware_out_log.txt" -o !NomeFileOutput4k!

ren !NomeFileOutput4k! !fileoutput2160p_rinominato!

goto fine_QSVEnc_UpScaling_da_1080p_10bit_HDR_a_2160p_10bit_hdr

:codificaunicopassaggio_QSVEnc_UpScaling_da_1080p_10bit_HDR_a_2160p_10bit_hdr

echo.
echo !t54!
echo.

".\bin\qsvencc\QSVEncC64.exe" --avsw --device auto -i !NomeFile!  --output-res !RisoluzioneVideo4k!  !cropff! --video-metadata clear --metadata clear --chapter-copy -c hevc !TipoCodifica!  !QualitaCodifica! --la-depth 32  --level auto --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display copy --max-cll copy  --output-depth 10   --avsync cfr --psnr --ssim     -m default_mode:infer_no_subs      --vpp-resize algo=lanczos4  !Denoiser! !Val_Edgelevel!  --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o !NomeFileOutput4k!

ren !NomeFileOutput4k! !fileoutput2160p_rinominato!


:fine_QSVEnc_UpScaling_da_1080p_10bit_HDR_a_2160p_10bit_hdr

echo.
echo !t58!
echo.


goto:eof

rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////


rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////

:Avvio_Codifica_UpGrading_NVEnc_da_2160p_8-10bit_SDR_a_2160p_10bit_HDR


set fileoutput2160p_senza_virgolette=%NomeFileOutput4k:"=% 
@rem echo %fileoutput2160p_senza_virgolette%

for %%i in ("%fileoutput2160p_senza_virgolette%") do (  
                                                        set "solo_nome_file=%%~ni"
                                                        rem echo Nome file: !solo_nome_file!

                                                        set "solo_estensione_file=%%~xi"
                                                        rem echo Estensione: !solo_estensione_file!
                                                    )

set fileoutput2160p_rinominato="!solo_nome_file!_rinominato!solo_estensione_file!"
@REM echo fileoutput2160p_rinominato = !fileoutput2160p_rinominato!
@REM echo.


if !Denoiser!==nessuno (
    set "Denoiser="
)

if !Val_Edgelevel!==nessuno (
    set "Val_Edgelevel="
)


".\bin\nvenc\NVEncC64.exe" --avsw --device 0 -i !NomeFile!  !cropff!  --output-res !RisoluzioneVideo4k! --video-metadata clear --metadata clear --chapter-copy -c hevc !TipoCodifica! --bref-mode disabled !QualitaCodifica! --lookahead 32 --aq --aq-temporal --aq-strength 15 --profile main10 --level auto --tier high --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display "G(13250,34500)B(7500,3000)R(34000,16000)WP(15635,16450)L(10000000,1)" --max-cll "1000,400" --output-depth 10 --multipass None --mv-precision Q-pel --avsync cfr --psnr --ssim     -m default_mode:infer_no_subs    !Denoiser!  !ColorCorrectionVal!  --vpp-resize algo=lanczos4  !Val_Edgelevel!   --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o !NomeFileOutput4k!


ren !NomeFileOutput4k! !fileoutput2160p_rinominato!

echo.
echo !t59!
echo.



goto:eof

rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////


rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////

:Avvio_Codifica_UpGrading_QSVEnc_da_2160p_8-10bit_SDR_a_2160p_10bit_HDR

set fileoutput2160p_senza_virgolette=%NomeFileOutput4k:"=% 
@rem echo %fileoutput2160p_senza_virgolette%

for %%i in ("%fileoutput2160p_senza_virgolette%") do (  
                                                        set "solo_nome_file=%%~ni"
                                                        rem echo Nome file: !solo_nome_file!

                                                        set "solo_estensione_file=%%~xi"
                                                        rem echo Estensione: !solo_estensione_file!
                                                    )

set fileoutput2160p_rinominato="!solo_nome_file!_rinominato!solo_estensione_file!"
@REM echo fileoutput2160p_rinominato = !fileoutput2160p_rinominato!
@REM echo.


if !Denoiser!==nessuno (
    set "Denoiser="
)

if !Val_Edgelevel!==nessuno (
    set "Val_Edgelevel="
)

".\bin\qsvencc\QSVEncC64.exe" --avsw --device auto -i !NomeFile!  !cropff!  --output-res !RisoluzioneVideo4k! --video-metadata clear --metadata clear --chapter-copy -c hevc !TipoCodifica! !QualitaCodifica! --la-depth 32  --level auto  --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display "G(13250,34500)B(7500,3000)R(34000,16000)WP(15635,16450)L(10000000,1)" --max-cll "1000,400" --output-depth 10  --avsync cfr --psnr --ssim     -m default_mode:infer_no_subs    !Denoiser!  !ColorCorrectionVal!  --vpp-resize algo=lanczos4  !Val_Edgelevel!   --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o !NomeFileOutput4k!


ren !NomeFileOutput4k! !fileoutput2160p_rinominato!

echo.
echo !t60!
echo.

goto:eof

rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////




rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////

:Avvio_Codifica_Hardware_NVidia_DownGrading_2160p_1080p_10bit_HDR_a_8bit_SDR

set fileoutput2160p_senza_virgolette=%NomeFileOutput4k:"=% 
@rem echo %fileoutput2160p_senza_virgolette%

for %%i in ("%fileoutput2160p_senza_virgolette%") do (  
                                                        set "solo_nome_file=%%~ni"
                                                        rem echo Nome file: !solo_nome_file!

                                                        set "solo_estensione_file=%%~xi"
                                                        rem echo Estensione: !solo_estensione_file!
                                                    )

set fileoutput2160p_rinominato="!solo_nome_file!_rinominato!solo_estensione_file!"
@REM echo fileoutput2160p_rinominato = !fileoutput2160p_rinominato!
@REM echo.


if !Denoiser!==nessuno (
    set "Denoiser="
)

if !Val_Edgelevel!==nessuno (
    set "Val_Edgelevel="
)


".\bin\nvenc\NVEncC64.exe" --avhw --device 0 -i !NomeFile! --output-res !RisoluzioneVideo4k! !cropff! --output-depth 8 --video-metadata clear --metadata clear --chapter-copy -c hevc !TipoCodifica! --bref-mode disabled !QualitaCodifica! --tier high --lookahead 32 --aq --aq-temporal --aq-strength 15 --level auto --chromaloc auto --colorrange auto --colormatrix  bt709 --transfer bt709 --colorprim bt709 --multipass None --mv-precision Q-pel  --avsync cfr  !ColorCorrectionVal! !Denoiser!  !Val_Edgelevel! --vpp-resize algo=lanczos4   --log-level info --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off  --log ".\codifica_hardware_out_log.txt" -o !NomeFileOutput4k!

ren !NomeFileOutput4k! !fileoutput2160p_rinominato!

echo.
echo !t61!
echo.

goto:eof

rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////




rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////

:Avvio_Codifica_Hardware_Intel_DownGrading_2160p_1080p_10bit_HDR_a_8bit_SDR

set fileoutput2160p_senza_virgolette=%NomeFileOutput4k:"=% 
@rem echo %fileoutput2160p_senza_virgolette%

for %%i in ("%fileoutput2160p_senza_virgolette%") do (  
                                                        set "solo_nome_file=%%~ni"
                                                        rem echo Nome file: !solo_nome_file!

                                                        set "solo_estensione_file=%%~xi"
                                                        rem echo Estensione: !solo_estensione_file!
                                                    )

set fileoutput2160p_rinominato="!solo_nome_file!_rinominato!solo_estensione_file!"
@REM echo fileoutput2160p_rinominato = !fileoutput2160p_rinominato!
@REM echo.


if !Denoiser!==nessuno (
    set "Denoiser="
)

if !Val_Edgelevel!==nessuno (
    set "Val_Edgelevel="
)

".\bin\qsvencc\QSVEncC64.exe" --avhw --device auto -i !NomeFile!  --output-res !RisoluzioneVideo4k! !cropff! --output-depth 8 --video-metadata clear --metadata clear --chapter-copy -c hevc !TipoCodifica! !QualitaCodifica! --la-depth 32 --level auto --chromaloc auto --colorrange auto --colormatrix  bt709 --transfer bt709 --colorprim bt709   --avsync cfr  !ColorCorrectionVal!  !Denoiser! --vpp-resize algo=lanczos4  !Val_Edgelevel! --psnr --ssim  -m default_mode:infer_no_subs  --log-level info --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off  --log ".\codifica_hardware_out_log.txt" -o !NomeFileOutput4k!


ren !NomeFileOutput4k! !fileoutput2160p_rinominato!

echo.
echo !t62!
echo.



goto:eof

rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////




rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////

:Avvio_Codifica_NVidia_DownScaling_DownGrading_da_2160p_10bit_HDR_a_1080p_8bit_SDR

set fileoutput2160p_senza_virgolette=%NomeFileOutput4k:"=% 
@rem echo %fileoutput2160p_senza_virgolette%

for %%i in ("%fileoutput2160p_senza_virgolette%") do (  
                                                        set "solo_nome_file=%%~ni"
                                                        rem echo Nome file: !solo_nome_file!

                                                        set "solo_estensione_file=%%~xi"
                                                        rem echo Estensione: !solo_estensione_file!
                                                    )

set fileoutput2160p_rinominato="!solo_nome_file!_rinominato!solo_estensione_file!"
@REM echo fileoutput2160p_rinominato = !fileoutput2160p_rinominato!
@REM echo.


if !Denoiser!==nessuno (
    set "Denoiser="
)

if !Val_Edgelevel!==nessuno (
    set "Val_Edgelevel="
)

".\bin\nvenc\NVEncC64.exe" --avhw --device 0 -i !NomeFile!  --output-res !RisoluzioneVideo4k! !cropff! --output-depth 8 --video-metadata clear --metadata clear --chapter-copy -c hevc !TipoCodifica! --bref-mode disabled !QualitaCodifica! --tier high --lookahead 32 --aq --aq-temporal --aq-strength 15 --level auto --chromaloc auto --colorrange auto --colormatrix  bt709 --transfer bt709 --colorprim bt709 --multipass None --mv-precision Q-pel  --avsync cfr !ColorCorrectionVal! --vpp-resize algo=lanczos4 !Denoiser! !Val_Edgelevel! --log-level info --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off  --log ".\codifica_hardware_out_log.txt" -o !NomeFileOutput4k!


ren !NomeFileOutput4k! !fileoutput2160p_rinominato!

echo.
echo !t63!
echo.

goto:eof

rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////




rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////

:Avvio_Codifica_Intel_DownScaling_DownGrading_da_2160p_10bit_HDR_a_1080p_8bit_SDR

set fileoutput2160p_senza_virgolette=%NomeFileOutput4k:"=% 
@rem echo %fileoutput2160p_senza_virgolette%

for %%i in ("%fileoutput2160p_senza_virgolette%") do (  
                                                        set "solo_nome_file=%%~ni"
                                                        rem echo Nome file: !solo_nome_file!

                                                        set "solo_estensione_file=%%~xi"
                                                        rem echo Estensione: !solo_estensione_file!
                                                    )

set fileoutput2160p_rinominato="!solo_nome_file!_rinominato!solo_estensione_file!"
@REM echo fileoutput2160p_rinominato = !fileoutput2160p_rinominato!
@REM echo.


if !Denoiser!==nessuno (
    set "Denoiser="
)

if !Val_Edgelevel!==nessuno (
    set "Val_Edgelevel="
)

".\bin\qsvencc\QSVEncC64.exe" --avhw --device auto -i !NomeFile!  --output-res !RisoluzioneVideo4k! !cropff! --output-depth 8 --video-metadata clear --metadata clear --chapter-copy -c hevc !TipoCodifica! !QualitaCodifica! --la-depth 32  --level auto --chromaloc auto --colorrange auto --colormatrix  bt709 --transfer bt709 --colorprim bt709   --avsync cfr !ColorCorrectionVal! --vpp-resize algo=lanczos4 !Denoiser! !Val_Edgelevel! --log-level info --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off  --log ".\codifica_hardware_out_log.txt" -o !NomeFileOutput4k!


ren !NomeFileOutput4k! !fileoutput2160p_rinominato!

echo.
echo !t64!
echo.


goto:eof

rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////



rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////

:Avvio_Codifica_Hardware_NVidia_DownGrading_da_1080p_10bit_SDR_a_1080_8bit_SDR

set fileoutput2160p_senza_virgolette=%NomeFileOutput4k:"=% 
@rem echo %fileoutput2160p_senza_virgolette%

for %%i in ("%fileoutput2160p_senza_virgolette%") do (  
                                                        set "solo_nome_file=%%~ni"
                                                        rem echo Nome file: !solo_nome_file!

                                                        set "solo_estensione_file=%%~xi"
                                                        rem echo Estensione: !solo_estensione_file!
                                                    )

set fileoutput2160p_rinominato="!solo_nome_file!_rinominato!solo_estensione_file!"
@REM echo fileoutput2160p_rinominato = !fileoutput2160p_rinominato!
@REM echo.


if !Denoiser!==nessuno (
    set "Denoiser="
)

if !Val_Edgelevel!==nessuno (
    set "Val_Edgelevel="
)


".\bin\nvenc\NVEncC64.exe" --avhw --device 0 -i !NomeFile!  --output-res !RisoluzioneVideo4k! !cropff! --output-depth 8 --video-metadata clear --metadata clear --chapter-copy -c hevc !TipoCodifica! --bref-mode disabled !QualitaCodifica! --tier high --lookahead 32 --aq --aq-temporal --aq-strength 15 --level auto --chromaloc auto --colorrange auto --colormatrix  bt709 --transfer bt709 --colorprim bt709 --multipass None --mv-precision Q-pel  --avsync cfr   --vpp-resize algo=lanczos4  !Denoiser!  !Val_Edgelevel!  --log-level info --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off  --log ".\codifica_hardware_out_log.txt" -o !NomeFileOutput4k!


ren !NomeFileOutput4k! !fileoutput2160p_rinominato!

echo.
echo !t65!
echo.

goto:eof

rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////



rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////

:Avvio_Codifica_Hardware_Intel_DownGrading_da_1080p_10bit_SDR_a_1080_8bit_SDR

set fileoutput2160p_senza_virgolette=%NomeFileOutput4k:"=% 
@rem echo %fileoutput2160p_senza_virgolette%

for %%i in ("%fileoutput2160p_senza_virgolette%") do (  
                                                        set "solo_nome_file=%%~ni"
                                                        rem echo Nome file: !solo_nome_file!

                                                        set "solo_estensione_file=%%~xi"
                                                        rem echo Estensione: !solo_estensione_file!
                                                    )

set fileoutput2160p_rinominato="!solo_nome_file!_rinominato!solo_estensione_file!"
@REM echo fileoutput2160p_rinominato = !fileoutput2160p_rinominato!
@REM echo.


if !Denoiser!==nessuno (
    set "Denoiser="
)

if !Val_Edgelevel!==nessuno (
    set "Val_Edgelevel="
)


".\bin\qsvencc\QSVEncC64.exe" --avhw --device auto -i !NomeFile!  --output-res !RisoluzioneVideo4k! !cropff! --output-depth 8 --video-metadata clear --metadata clear --chapter-copy -c hevc !TipoCodifica!  !QualitaCodifica! --la-depth 32  --level auto --chromaloc auto --colorrange auto --colormatrix  bt709 --transfer bt709 --colorprim bt709   --avsync cfr   --vpp-resize algo=lanczos4  !Denoiser!  !Val_Edgelevel!  --log-level info --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off  --log ".\codifica_hardware_out_log.txt" -o !NomeFileOutput4k!


ren !NomeFileOutput4k! !fileoutput2160p_rinominato!

echo.
echo !t66!
echo.

goto:eof

rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////







:file_avvio_docifiche_salvate_sul_disco


if exist ".\saved\settings.dat" (
                                for /f "tokens=1,2 delims=|" %%a in (.\saved\settings.dat) do (
                                                                                                    rem echo %%a
                                                                                                    rem echo %%b
                                                                                                    set /a "shst=%%b"
                                                                                                    rem echo !shst!
                                                                                                    rem pause
                                                                                                    if !shst!==1 (
                                                                                                                echo !t67!
                                                                                                                echo.
                                                                                                                shutdown /s
                                                                                                                set /a "delay=10"
                                                                                                                timeout /t !delay!
                                                                                                                exit
                                                                                                                )
                                                                                                                            
                                                                                                    )                                                                                                  
                                                                                                )


set waitenter=
set /P waitenter=!t68!
Endlocal
goto InsertMoviesInSpoolMenu








rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:CancellazioneCodificheSalvatesuDisco

cls
setLocal EnableExtensions EnableDelayedExpansion


for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoavvio_cancellazione_codifiche_salvate_su_disco
)

if %lingua%==inglese (
    goto caricalinguaingleseavvio_cancellazione_codifiche_salvate_su_disco
)



:caricalinguaingleseavvio_cancellazione_codifiche_salvate_su_disco
set t1=Deleting Encodings Saved on Disk...
set t2=Encoding
set t3=Started...
set t4=Encoding Type:
set t5=Software Enconding with CPU FFmpeg
set t6=Input Video File:
set t7=Output Video File:
set t8=Encoding Type:
set t9=Encoding Quality:
set t10=Encoding Quantization Type:
set t11=Intensity Encoding Quantization:
set t12=Output Video Format:
set t13=Output 2160p Video File:
set t14=Output 1080p Video File:
set t15=Output 2160p Video Resolution:
set t16=Output 1080p Video Resolution:
set t17=Video Encoding Type 2160p:
set t18=Video Encoding Type 1080p:
set t19=Output 2160p Video Format:
set t20=Output 1080p Video Format:
set t21=Detail Enhancement:
set t22=Motion Vector Precision:
set t23=Output Video Resolution:
set t24=1-Pass UpScaling:
set t25=Input 1080p Video Resolution:
set t26=Software Encoding FFmpeg 2160p and 1080p from 2160p
set t27=Hardware Encoding Nvidia NVEnc 2160p Light Cleaning and Detail Enhancement
set t28=Hardware Encoding Intel QSVEnc 2160p Light Cleaning and Detail Enhancement
set t29=Hardware Encoding with GPU NVidia NVEnc
set t30=Hardware Encoding with GPU Intel QSVEnc
set t31=Hardware Encoding with GPU NVidia NVEnc UpScaling and UpGrading from 1080p SDR to 2160p HDR
set t32=Hardware Encoding with GPU Intel QSVEnc UpScaling and UpGrading from 1080p SDR to 2160p HDR
set t33=Hardware Encoding with GPU NVidia NVEnc UpScaling from 1080p 10bit HDR to 2160p 10bit HDR
set t34=Hardware Encoding with GPU Intel QSVEnc UpScaling from 1080p 10bit HDR to 2160p 10bit HDR
set t35=Hardware Encoding with GPU NVidia NVEnc UpGrading from 2160p 8bit or 10bit SDR to 2160p 10bit HDR
set t36=Hardware Encoding with GPU Intel QSVEnc UpGrading from 2160p 8bit or 10bit SDR to 2160p 10bit HDR
set t37=Hardware Encoding with GPU NVidia NVEnc DownGrading from 2160p o 1080p 10bit HDR to 8bit SDR
set t38=Hardware Encoding with GPU Intel QSVEnc DownGrading from 2160p o 1080p 10bit HDR to 8bit SDR
set t39=Hardware Encoding with GPU NVidia NVEnc DownGrading and DownScaling from 2160p 10bit HDR to 1080p 8bit SDR
set t40=Hardware Encoding with GPU Intel QSVEnc DownGrading and DownScaling from 2160p 10bit HDR to 1080p 8bit SDR
set t41=Hardware Encoding with GPU NVidia NVEnc DownGrading from 1080p 10bit SDR to 1080p 8bit SDR
set t42=Hardware Encoding with GPU Intel QSVEnc DownGrading from 1080p 10bit SDR to 1080p 8bit SDR
set t43=Reading Encodings Saved on Disk...
set t44=No Encoding Saved on Disk. 
set t45=Do you want Delete All Encondings Saved on Disk (Yes - All/No - Just One):
set t46=Deletion Completed, All Saved Encodings Deleted.
set t47=Insert Encoding Number to Delete between 1 and 
set t48=Error Inserting the Number of the Encoding to Delete... It is not a number. 
set t49=Error Inserting the Number of the Encoding to Delete... It's not between 1 e 
set t50=Deleted.
set t51=Press Enter to Back to Menu Insert, Read, Delete, Start Queued Encodings. 



goto avvio_cancellazione_codifiche_salvate_su_disco




:caricalinguaitalianoavvio_cancellazione_codifiche_salvate_su_disco
set t1=Cancellazione Codifiche Salvate sul Disco...
set t2=Codifica
set t3=Avviata...
set t4=Tipo di Codifica:
set t5=Codifica Software con CPU FFmpeg
set t6=Video File di Input:
set t7=Video File di Output:
set t8=Tipo Codifica:
set t9=Qualita' Codifica:
set t10=Tipo Quantizzazione Codifica:
set t11=Intensita' Quantizzazione Codifica:
set t12=Formato Video di Output:
set t13=Video File 2160p di Output:
set t14=Video File 1080p di Output:
set t15=Risoluzione Video 2160p di Output:
set t16=Risoluzione Video 1080p di Output:
set t17=Tipo Codifica Video 2160p:
set t18=Tipo Codifica Video 1080p:
set t19=Formato Video 2160p di Output:
set t20=Formato Video 1080p di Output:
set t21=Miglioramento Dettagli:
set t22=Precisione Vettore Movimento:
set t23=Risoluzione Video di Output:
set t24=UpScaling in 1 Passaggio:
set t25=Risoluzione Video 1080p di Input:
set t26=Codifica Software FFmpeg 2160p e 1080p da 2160p
set t27=Codifica Hardware Nvidia NVEnc 2160p Pulizia Leggera e Miglioramento Dettagli
set t28=Codifica Hardware Intel QSVEnc 2160p Pulizia Leggera e Miglioramento Dettagli
set t29=Codifica Hardware con GPU NVidia NVEnc
set t30=Codifica Hardware con GPU Intel QSVEnc
set t31=Codifica Hardware NVidia NVEnc UpScaling e UpGrading da 1080p SDR a 2160p HDR
set t32=Codifica Hardware Intel QSVEnc UpScaling e UpGrading da 1080p SDR a 2160p HDR
set t33=Codifica Hardware NVidia NVEnc UpScaling da 1080p 10bit HDR a 2160p 10bit HDR
set t34=Codifica Hardware Intel QsVEnc UpScaling da 1080p 10bit HDR a 2160p 10bit HDR
set t35=Codifica Hardware NVidia NVEnc UpGrading da 2160p 8bit o 10bit SDR a 2160p 10bit HDR
set t36=Codifica Hardware Intel QSVEnc UpGrading da 2160p 8bit o 10bit SDR a 2160p 10bit HDR
set t37=Codifica Hardware NVidia NVEnc DownGrading da 2160p o 1080p 10bit HDR a 8bit SDR
set t38=Codifica Hardware Intel QSVEnc DownGrading da 2160p o 1080p 10bit HDR a 8bit SDR
set t39=Codifica Hardware NVidia NVEnc DownGrading e DownScaling da 2160p 10bit HDR a 1080p 8bit SDR
set t40=Codifica Hardware Intel QSVEnc DownGrading e DownScaling da 2160p 10bit HDR a 1080p 8bit SDR
set t41=Codifica Hardware NVidia NVEnc DownGrading da 1080p 10bit SDR a 1080p 8bit SDR
set t42=Codifica Hardware Intel QSVEnc DownGrading da 1080p 10bit SDR a 1080p 8bit SDR
set t43=Lettura Codifiche Salvate sul Disco...
set t44=Nessuna Codifica Salvata sul Disco. 
set t45=Vuoi Cancellare Tutte le Codifiche Salvate su Disco (Si - Tutte/No - Solo Una):
set t46=Cancellazione Effettuata, tutte le Codifiche Salvate Cancellate.
set t47=Inserire Numero Codifica da Cancellare tra 1 e 
set t48=Errore nell'Inserimento del Numero della Codifica da Cancellare... Non e' un Numero. 
set t49=Errore nell'Inserimento del Numero della Codifica da Cancellare... Non e' tra 1 e 
set t50=Cancellata.
set t51=Premi Invio per tornare al menu' Inserimento, Lettura, Cancellazione, Avvio Codifiche in Coda e Salvataggio sul Disco.  

goto avvio_cancellazione_codifiche_salvate_su_disco


:avvio_cancellazione_codifiche_salvate_su_disco

echo !t1!
echo.

if not exist ".\saved\savedmoviesallencodings.dat" ( 
    echo !t44!
    echo.
    goto FineCancellazione_CancellazioneCodificheSalvatesuDisco
)

if %lingua%==inglese (
    CHOICE /N /C:yn /M "!t45!"
    echo.
    if errorlevel 2 goto CancellazioneSingola_CancellazioneCodificheSalvatesuDisco
    if errorlevel 1 goto CancellazioneCodifiche_CancellazioneCodificheSalvatesuDisco

)

CHOICE /N /C:sn /M "!t45!"
echo. 

if errorlevel 2 goto CancellazioneSingola_CancellazioneCodificheSalvatesuDisco
if errorlevel 1 goto CancellazioneCodifiche_CancellazioneCodificheSalvatesuDisco


:CancellazioneCodifiche_CancellazioneCodificheSalvatesuDisco
if exist ".\saved\savedmoviesallencodings.dat" ( del .\saved\savedmoviesallencodings.dat ) 

echo !t46!
echo.
goto FineCancellazione_CancellazioneCodificheSalvatesuDisco


:CancellazioneSingola_CancellazioneCodificheSalvatesuDisco


echo !t43!
echo.

if exist ".\saved\savedmoviesallencodings.dat" (
                                                set /a "contatoreCodifiche=0"
                                                set /A "numeroriga=1"
                                                @REM echo I Video da Codificare Salvati sul Disco sono questi: 
                                                @REM echo.

                                                for /f "tokens=1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22 delims=|" %%a in (.\saved\savedmoviesallencodings.dat) do  (
                                                                                                                                                                                    echo !t2! !numeroriga!
                                                                                                                                                                                    echo.

                                                                                                                                                                                    if %%a==semplice_codifica_ffmpeg (
                                                                                                                                                                                        echo !t4! !t5!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo Video File di Output 2: %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t23! %%f
                                                                                                                                                                                        @REM echo Risoluzione Video di Output 2: %%g
                                                                                                                                                                                        echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        echo !t10! %%n
                                                                                                                                                                                        echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                        set /a "contatoreCodifiche+=1"
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==codifica_ffmpeg_2160p_piu_1080p_da_2160p (
                                                                                                                                                                                        echo !t4! !t26!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t13! %%c
                                                                                                                                                                                        echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        echo !t16! %%g
                                                                                                                                                                                        echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        set "TipoCodificaDoppio=%%l"
                                                                                                                                                                                        @REM echo TipoCodificaDoppio = !TipoCodificaDoppio!
                                                                                                                                                                                        for /f "tokens=1,2 delims=x" %%a in ("!TipoCodificaDoppio!") do  (
                                                                                                                                                                                                                                                        echo !t17! %%a
                                                                                                                                                                                                                                                        set "TipoCodifica2160p=%%a"
                                                                                                                                                                                                                                                        echo !t18! %%b
                                                                                                                                                                                                                                                        set "TipoCodifica1080p=%%b"
                                                                                                                                                                                                                                                        )
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        echo !t10! %%n
                                                                                                                                                                                        echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t19! %%q
                                                                                                                                                                                        echo !t20! yuv420p
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                        set /a "contatoreCodifiche+=1"

                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==NVEnc_2160p_denoier_pulizia (
                                                                                                                                                                                        echo !t4! !t27!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t13! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        @REM echo !t16! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t19! %%q
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                        set /a "contatoreCodifiche+=1"
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==QSVEnc_2160p_denoier_pulizia (
                                                                                                                                                                                        echo !t4! !t28!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t13! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        @REM echo !t16! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t19! %%q
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                        set /a "contatoreCodifiche+=1"
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==NVEnc_semplice_codifica_hardware (
                                                                                                                                                                                        echo !t4! !t29!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t23! %%f
                                                                                                                                                                                        @REM echo !t16! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        echo !t10! %%n
                                                                                                                                                                                        echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        @REM echo Color Correction: %%s
                                                                                                                                                                                        @REM echo UpScaling in 2 Passaggi: %%t
                                                                                                                                                                                        echo Lookahead: %%u
                                                                                                                                                                                        echo !t22! %%u
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                        set /a "contatoreCodifiche+=1"
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==QSVEnc_semplice_codifica_hardware (
                                                                                                                                                                                        echo !t4! !t30!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t23! %%f
                                                                                                                                                                                        @REM echo !t16! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        @REM echo Color Correction: %%s
                                                                                                                                                                                        @REM echo UpScaling in 2 Passaggi: %%t
                                                                                                                                                                                        echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                        set /a "contatoreCodifiche+=1"
                                                                                                                                                                                    )


                                                                                                                                                                                    if %%a==NVEnc_UpScaling_UpGrading_da_1080p_a_2160p (
                                                                                                                                                                                        echo !t4! !t31!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        echo Color Correction: %%s
                                                                                                                                                                                        if %%t==1 ( set "unicopassaggiow=Si" ) else ( set "unicopassaggiow=No" )
                                                                                                                                                                                        echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                        set /a "contatoreCodifiche+=1"
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==QSVEnc_UpScaling_UpGrading_da_1080p_a_2160p (
                                                                                                                                                                                        echo !t4! !t32!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        echo Color Correction: %%s
                                                                                                                                                                                        if %%t==1 ( set "unicopassaggiow=Si" ) else ( set "unicopassaggiow=No" )
                                                                                                                                                                                        echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                        set /a "contatoreCodifiche+=1"
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==NVEnc_UpScaling_da_1080p_10bit_hdr_a_2160p_10bit_hdr (
                                                                                                                                                                                        echo !t4! !t33!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        @REM echo Color Correction: %%s
                                                                                                                                                                                        if %%t==1 ( set "unicopassaggiow=Si" ) else ( set "unicopassaggiow=No" )
                                                                                                                                                                                        echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                        set /a "contatoreCodifiche+=1"
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==QSVEnc_UpScaling_da_1080p_10bit_hdr_a_2160p_10bit_hdr (
                                                                                                                                                                                        echo !t4! !t34!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        @REM echo Color Correction: %%s
                                                                                                                                                                                        if %%t==1 ( set "unicopassaggiow=Si" ) else ( set "unicopassaggiow=No" )
                                                                                                                                                                                        echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                        set /a "contatoreCodifiche+=1"
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==NVEnc_da_2160p_8bit_o_10bit_sdr_a_2160p_10bit_hdr (
                                                                                                                                                                                        echo !t4! !t35!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        @REM echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        echo Color Correction: %%s
                                                                                                                                                                                        @REM if %%t==1 ( set unicopassaggiow=Si ) else ( set unicopassaggiow=No )
                                                                                                                                                                                        @REM echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                        set /a "contatoreCodifiche+=1"
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==QSVEnc_da_2160p_8bit_o_10bit_sdr_a_2160p_10bit_hdr (
                                                                                                                                                                                        echo !t4! !t36!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        @REM echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        echo Color Correction: %%s
                                                                                                                                                                                        @REM if %%t==1 ( set unicopassaggiow=Si ) else ( set unicopassaggiow=No )
                                                                                                                                                                                        @REM echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                        set /a "contatoreCodifiche+=1"
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==NVEnc_downgraded_da_2160p_o_1080p_10bit_hdr_a_8_bit_sdr (
                                                                                                                                                                                        echo !t4! !t37!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        @REM echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        echo Color Correction: %%s
                                                                                                                                                                                        @REM if %%t==1 ( set unicopassaggiow=Si ) else ( set unicopassaggiow=No )
                                                                                                                                                                                        @REM echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                        set /a "contatoreCodifiche+=1"
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==QSVEnc_downgraded_da_2160p_o_1080p_10bit_hdr_a_8_bit_sdr (
                                                                                                                                                                                        echo !t4! !t38!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        @REM echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        echo Color Correction: %%s
                                                                                                                                                                                        @REM if %%t==1 ( set unicopassaggiow=Si ) else ( set unicopassaggiow=No )
                                                                                                                                                                                        @REM echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                        set /a "contatoreCodifiche+=1"
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==NVEnc_DownGraded_DownScaled_da_2160p_10bit_HDR_a_1080p_8bit_SDR (
                                                                                                                                                                                        echo !t4! !t39!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        @REM echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        echo Color Correction: %%s
                                                                                                                                                                                        @REM if %%t==1 ( set unicopassaggiow=Si ) else ( set unicopassaggiow=No )
                                                                                                                                                                                        @REM echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                        set /a "contatoreCodifiche+=1"
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==QSVEnc_DownGraded_DownScaled_da_2160p_10bit_HDR_a_1080p_8bit_SDR (
                                                                                                                                                                                        echo !t4! !t40!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        @REM echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        echo Color Correction: %%s
                                                                                                                                                                                        @REM if %%t==1 ( set unicopassaggiow=Si ) else ( set unicopassaggiow=No )
                                                                                                                                                                                        @REM echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                        set /a "contatoreCodifiche+=1"
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==NVEnc_DownGrading_da_1080p_10bit_SDR_a_1080p_8bit_SDR (
                                                                                                                                                                                        echo !t4! !t41!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        @REM echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        @REM echo Color Correction: %%s
                                                                                                                                                                                        @REM if %%t==1 ( set unicopassaggiow=Si ) else ( set unicopassaggiow=No )
                                                                                                                                                                                        @REM echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                        set /a "contatoreCodifiche+=1"
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==QSVEnc_DownGrading_da_1080p_10bit_SDR_a_1080p_8bit_SDR (
                                                                                                                                                                                        echo !t4! !t42!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        @REM echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        @REM echo Color Correction: %%s
                                                                                                                                                                                        @REM if %%t==1 ( set unicopassaggiow=Si ) else ( set unicopassaggiow=No )
                                                                                                                                                                                        @REM echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                        set /a "contatoreCodifiche+=1"
                                                                                                                                                                                    )



                                                                                                                                                                                    set /a "numeroriga+=1"
                                                                                                                                                                    )
                                                goto inserireNumeroCodificaDaCancellare
                                                )



:inserireNumeroCodificaDaCancellare

set /p "NumeroCodificaDaCancellare=!t47!!contatoreCodifiche!: " 
SET "var="&for /f "delims=0123456789" %%i in ("!NumeroCodificaDaCancellare!") do set var=!NumeroCodificaDaCancellare!
if defined var (
                echo.
                echo !t48!
                echo.
                goto inserireNumeroCodificaDaCancellare
                ) 

@REM pause
set /a "NumeroCodificaDaCancellareN=!NumeroCodificaDaCancellare!"
@REM echo NumeroCodificaDaCancellareN = !NumeroCodificaDaCancellareN!
@REM echo contatoreCodifiche = !contatoreCodifiche!
@REM pause

if !NumeroCodificaDaCancellareN! GEQ 1 if !NumeroCodificaDaCancellareN! LEQ !contatoreCodifiche! (
    set /a "cont=1"
    for /f "tokens=1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22 delims=|" %%a in (.\saved\savedmoviesallencodings.dat) do  (
        set "rigo=%%a|%%b|%%c|%%d|%%e|%%f|%%g|%%h|%%i|%%j|%%k|%%l|%%m|%%n|%%o|%%p|%%q|%%r|%%s|%%t|%%u|%%v"
        if !cont! NEQ !NumeroCodificaDaCancellareN! (
            if exist ".\saved\savedmoviesallencodingssenzacancellati.dat" ( 
                echo !rigo! >> .\saved\savedmoviesallencodingssenzacancellati.dat              
                @REM echo cont = !cont!
                ) else (
                        echo !rigo! > .\saved\savedmoviesallencodingssenzacancellati.dat
                        @REM echo cont = !cont!
                        )                     
        ) 
        set /a "cont+=1" 
    )
if exist ".\saved\savedmoviesallencodings.dat" (del ".\saved\savedmoviesallencodings.dat")
if exist ".\saved\savedmoviesallencodingssenzacancellati.dat" (ren ".\saved\savedmoviesallencodingssenzacancellati.dat" "savedmoviesallencodings.dat")
) else (
    echo.
    echo !t49!!contatoreCodifiche!. 
    echo.
    goto inserireNumeroCodificaDaCancellare
)



echo.
echo !t2! !NumeroCodificaDaCancellareN! !t50!
echo.



:FineCancellazione_CancellazioneCodificheSalvatesuDisco




set waitenter=
set /P waitenter=!t51!
Endlocal
goto InsertMoviesInSpoolMenu










rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:LetturaCodificheSalvatesuDisco

cls

setLocal EnableExtensions EnableDelayedExpansion

for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoLetturaCodificheSalvatesuDisco
)

if %lingua%==inglese (
    goto caricalinguaingleseLetturaCodificheSalvatesuDisco
)



:caricalinguaingleseLetturaCodificheSalvatesuDisco
set t1=Reading Encodings Saved on Disk...
set t2=Encoding
set t3=Started...
set t4=Encoding Type:
set t5=Software Enconding with CPU FFmpeg
set t6=Input Video File:
set t7=Output Video File:
set t8=Encoding Type:
set t9=Encoding Quality:
set t10=Encoding Quantization Type:
set t11=Intensity Encoding Quantization:
set t12=Output Video Format:
set t13=Output 2160p Video File:
set t14=Output 1080p Video File:
set t15=Output 2160p Video Resolution:
set t16=Output 1080p Video Resolution:
set t17=Video Encoding Type 2160p:
set t18=Video Encoding Type 1080p:
set t19=Output 2160p Video Format:
set t20=Output 1080p Video Format:
set t21=Detail Enhancement:
set t22=Motion Vector Precision:
set t23=Output Video Resolution:
set t24=1-Pass UpScaling:
set t25=Input 1080p Video Resolution:
set t26=Software Encoding FFmpeg 2160p and 1080p from 2160p
set t27=Hardware Encoding Nvidia NVEnc 2160p Light Cleaning and Detail Enhancement
set t28=Hardware Encoding Intel QSVEnc 2160p Light Cleaning and Detail Enhancement
set t29=Hardware Encoding with GPU NVidia NVEnc
set t30=Hardware Encoding with GPU Intel QSVEnc
set t31=Hardware Encoding with GPU NVidia NVEnc UpScaling and UpGrading from 1080p SDR to 2160p HDR
set t32=Hardware Encoding with GPU Intel QSVEnc UpScaling and UpGrading from 1080p SDR to 2160p HDR
set t33=Hardware Encoding with GPU NVidia NVEnc UpScaling from 1080p 10bit HDR to 2160p 10bit HDR
set t34=Hardware Encoding with GPU Intel QSVEnc UpScaling from 1080p 10bit HDR to 2160p 10bit HDR
set t35=Hardware Encoding with GPU NVidia NVEnc UpGrading from 2160p 8bit or 10bit SDR to 2160p 10bit HDR
set t36=Hardware Encoding with GPU Intel QSVEnc UpGrading from 2160p 8bit or 10bit SDR to 2160p 10bit HDR
set t37=Hardware Encoding with GPU NVidia NVEnc DownGrading from 2160p o 1080p 10bit HDR to 8bit SDR
set t38=Hardware Encoding with GPU Intel QSVEnc DownGrading from 2160p o 1080p 10bit HDR to 8bit SDR
set t39=Hardware Encoding with GPU NVidia NVEnc DownGrading and DownScaling from 2160p 10bit HDR to 1080p 8bit SDR
set t40=Hardware Encoding with GPU Intel QSVEnc DownGrading and DownScaling from 2160p 10bit HDR to 1080p 8bit SDR
set t41=Hardware Encoding with GPU NVidia NVEnc DownGrading from 1080p 10bit SDR to 1080p 8bit SDR
set t42=Hardware Encoding with GPU Intel QSVEnc DownGrading from 1080p 10bit SDR to 1080p 8bit SDR
set t43=Video Encodings Saved on Disk are These: 
set t44=No Encoding Saved on Disk. 
set t45=Press Enter to Back to Menu Insert, Read, Delete, Start Queued Encodings. 




goto avvio_lettura_codifiche_salvate_su_disco




:caricalinguaitalianoLetturaCodificheSalvatesuDisco
set t1=Lettura Codifiche Salvate sul Disco...
set t2=Codifica
set t3=Avviata...
set t4=Tipo di Codifica:
set t5=Codifica Software con CPU FFmpeg
set t6=Video File di Input:
set t7=Video File di Output:
set t8=Tipo Codifica:
set t9=Qualita' Codifica:
set t10=Tipo Quantizzazione Codifica:
set t11=Intensita' Quantizzazione Codifica:
set t12=Formato Video di Output:
set t13=Video File 2160p di Output:
set t14=Video File 1080p di Output:
set t15=Risoluzione Video 2160p di Output:
set t16=Risoluzione Video 1080p di Output:
set t17=Tipo Codifica Video 2160p:
set t18=Tipo Codifica Video 1080p:
set t19=Formato Video 2160p di Output:
set t20=Formato Video 1080p di Output:
set t21=Miglioramento Dettagli:
set t22=Precisione Vettore Movimento:
set t23=Risoluzione Video di Output:
set t24=UpScaling in 1 Passaggio:
set t25=Risoluzione Video 1080p di Input:
set t26=Codifica Software FFmpeg 2160p e 1080p da 2160p
set t27=Codifica Hardware Nvidia NVEnc 2160p Pulizia Leggera e Miglioramento Dettagli
set t28=Codifica Hardware Intel QSVEnc 2160p Pulizia Leggera e Miglioramento Dettagli
set t29=Codifica Hardware con GPU NVidia NVEnc
set t30=Codifica Hardware con GPU Intel QSVEnc
set t31=Codifica Hardware NVidia NVEnc UpScaling e UpGrading da 1080p SDR a 2160p HDR
set t32=Codifica Hardware Intel QSVEnc UpScaling e UpGrading da 1080p SDR a 2160p HDR
set t33=Codifica Hardware NVidia NVEnc UpScaling da 1080p 10bit HDR a 2160p 10bit HDR
set t34=Codifica Hardware Intel QsVEnc UpScaling da 1080p 10bit HDR a 2160p 10bit HDR
set t35=Codifica Hardware NVidia NVEnc UpGrading da 2160p 8bit o 10bit SDR a 2160p 10bit HDR
set t36=Codifica Hardware Intel QSVEnc UpGrading da 2160p 8bit o 10bit SDR a 2160p 10bit HDR
set t37=Codifica Hardware NVidia NVEnc DownGrading da 2160p o 1080p 10bit HDR a 8bit SDR
set t38=Codifica Hardware Intel QSVEnc DownGrading da 2160p o 1080p 10bit HDR a 8bit SDR
set t39=Codifica Hardware NVidia NVEnc DownGrading e DownScaling da 2160p 10bit HDR a 1080p 8bit SDR
set t40=Codifica Hardware Intel QSVEnc DownGrading e DownScaling da 2160p 10bit HDR a 1080p 8bit SDR
set t41=Codifica Hardware NVidia NVEnc DownGrading da 1080p 10bit SDR a 1080p 8bit SDR
set t42=Codifica Hardware Intel QSVEnc DownGrading da 1080p 10bit SDR a 1080p 8bit SDR
set t43=I Video da Codificare Salvati sul Disco sono questi: 
set t44=Nessuna Codifica Salvata sul Disco. 
set t45=Premi Invio per tornare al menu' Inserimento, Lettura, Cancellazione, Avvio Codifiche in Coda e Salvataggio sul Disco.  


goto avvio_lettura_codifiche_salvate_su_disco


:avvio_lettura_codifiche_salvate_su_disco

echo !t1!
echo.

if exist ".\saved\savedmoviesallencodings.dat" (

                                                set /A "numeroriga=1"
                                                echo !t43!
                                                echo.

                                                for /f "tokens=1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22 delims=|" %%a in (.\saved\savedmoviesallencodings.dat) do  (
                                                                                                                                                                                    echo !t2! !numeroriga!
                                                                                                                                                                                    echo.

                                                                                                                                                                                    if %%a==semplice_codifica_ffmpeg (
                                                                                                                                                                                        echo !t4! !t5!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo Video File di Output 2: %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t23! %%f
                                                                                                                                                                                        @REM echo Risoluzione Video di Output 2: %%g
                                                                                                                                                                                        echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        echo !t10! %%n
                                                                                                                                                                                        echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==codifica_ffmpeg_2160p_piu_1080p_da_2160p (
                                                                                                                                                                                        echo !t4! !t26!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t13! %%c
                                                                                                                                                                                        echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        echo !t16! %%g
                                                                                                                                                                                        echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        set "TipoCodificaDoppio=%%l"
                                                                                                                                                                                        @REM echo TipoCodificaDoppio = !TipoCodificaDoppio!
                                                                                                                                                                                        for /f "tokens=1,2 delims=x" %%a in ("!TipoCodificaDoppio!") do  (
                                                                                                                                                                                                                                                        echo !t17! %%a
                                                                                                                                                                                                                                                        set "TipoCodifica2160p=%%a"
                                                                                                                                                                                                                                                        echo !t18! %%b
                                                                                                                                                                                                                                                        set "TipoCodifica1080p=%%b"
                                                                                                                                                                                                                                                        )
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        echo !t10! %%n
                                                                                                                                                                                        echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t19! %%q
                                                                                                                                                                                        echo !t20! yuv420p
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.

                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==NVEnc_2160p_denoier_pulizia (
                                                                                                                                                                                        echo !t4! !t27!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t13! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        @REM echo !t16! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t19! %%q
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==QSVEnc_2160p_denoier_pulizia (
                                                                                                                                                                                        echo !t4! !t28!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t13! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        @REM echo !t16! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t19! %%q
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==NVEnc_semplice_codifica_hardware (
                                                                                                                                                                                        echo !t4! !t29!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t23! %%f
                                                                                                                                                                                        @REM echo !t16! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        echo !t10! %%n
                                                                                                                                                                                        echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        @REM echo Color Correction: %%s
                                                                                                                                                                                        @REM echo UpScaling in 2 Passaggi: %%t
                                                                                                                                                                                        echo Lookahead: %%u
                                                                                                                                                                                        echo !t22! %%u
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==QSVEnc_semplice_codifica_hardware (
                                                                                                                                                                                        echo !t4! !t30!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t23! %%f
                                                                                                                                                                                        @REM echo !t16! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        @REM echo Color Correction: %%s
                                                                                                                                                                                        @REM echo UpScaling in 2 Passaggi: %%t
                                                                                                                                                                                        echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )


                                                                                                                                                                                    if %%a==NVEnc_UpScaling_UpGrading_da_1080p_a_2160p (
                                                                                                                                                                                        echo !t4! !t31!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        echo Color Correction: %%s
                                                                                                                                                                                        if %%t==1 ( set "unicopassaggiow=Si" ) else ( set "unicopassaggiow=No" )
                                                                                                                                                                                        echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==QSVEnc_UpScaling_UpGrading_da_1080p_a_2160p (
                                                                                                                                                                                        echo !t4! !t32!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        echo Color Correction: %%s
                                                                                                                                                                                        if %%t==1 ( set "unicopassaggiow=Si" ) else ( set "unicopassaggiow=No" )
                                                                                                                                                                                        echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==NVEnc_UpScaling_da_1080p_10bit_hdr_a_2160p_10bit_hdr (
                                                                                                                                                                                        echo !t4! !t33!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        @REM echo Color Correction: %%s
                                                                                                                                                                                        if %%t==1 ( set "unicopassaggiow=Si" ) else ( set "unicopassaggiow=No" )
                                                                                                                                                                                        echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==QSVEnc_UpScaling_da_1080p_10bit_hdr_a_2160p_10bit_hdr (
                                                                                                                                                                                        echo !t4! !t34!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        @REM echo Color Correction: %%s
                                                                                                                                                                                        if %%t==1 ( set "unicopassaggiow=Si" ) else ( set "unicopassaggiow=No" )
                                                                                                                                                                                        echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==NVEnc_da_2160p_8bit_o_10bit_sdr_a_2160p_10bit_hdr (
                                                                                                                                                                                        echo !t4! !t35!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        @REM echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        echo Color Correction: %%s
                                                                                                                                                                                        @REM if %%t==1 ( set unicopassaggiow=Si ) else ( set unicopassaggiow=No )
                                                                                                                                                                                        @REM echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==QSVEnc_da_2160p_8bit_o_10bit_sdr_a_2160p_10bit_hdr (
                                                                                                                                                                                        echo !t4! !t36!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        @REM echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        echo Color Correction: %%s
                                                                                                                                                                                        @REM if %%t==1 ( set unicopassaggiow=Si ) else ( set unicopassaggiow=No )
                                                                                                                                                                                        @REM echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==NVEnc_downgraded_da_2160p_o_1080p_10bit_hdr_a_8_bit_sdr (
                                                                                                                                                                                        echo !t4! !t37!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        @REM echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        echo Color Correction: %%s
                                                                                                                                                                                        @REM if %%t==1 ( set unicopassaggiow=Si ) else ( set unicopassaggiow=No )
                                                                                                                                                                                        @REM echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==QSVEnc_downgraded_da_2160p_o_1080p_10bit_hdr_a_8_bit_sdr (
                                                                                                                                                                                        echo !t4! !t38!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        @REM echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        echo Color Correction: %%s
                                                                                                                                                                                        @REM if %%t==1 ( set unicopassaggiow=Si ) else ( set unicopassaggiow=No )
                                                                                                                                                                                        @REM echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==NVEnc_DownGraded_DownScaled_da_2160p_10bit_HDR_a_1080p_8bit_SDR (
                                                                                                                                                                                        echo !t4! !t39!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        @REM echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        echo Color Correction: %%s
                                                                                                                                                                                        @REM if %%t==1 ( set unicopassaggiow=Si ) else ( set unicopassaggiow=No )
                                                                                                                                                                                        @REM echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==QSVEnc_DownGraded_DownScaled_da_2160p_10bit_HDR_a_1080p_8bit_SDR (
                                                                                                                                                                                        echo !t4! !t40!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        @REM echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        echo Color Correction: %%s
                                                                                                                                                                                        @REM if %%t==1 ( set unicopassaggiow=Si ) else ( set unicopassaggiow=No )
                                                                                                                                                                                        @REM echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==NVEnc_DownGrading_da_1080p_10bit_SDR_a_1080p_8bit_SDR (
                                                                                                                                                                                        echo !t4! !t41!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        @REM echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        @REM echo Color Correction: %%s
                                                                                                                                                                                        @REM if %%t==1 ( set unicopassaggiow=Si ) else ( set unicopassaggiow=No )
                                                                                                                                                                                        @REM echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )

                                                                                                                                                                                    if %%a==QSVEnc_DownGrading_da_1080p_10bit_SDR_a_1080p_8bit_SDR (
                                                                                                                                                                                        echo !t4! !t42!
                                                                                                                                                                                        echo.

                                                                                                                                                                                        echo !t6! %%b
                                                                                                                                                                                        echo !t7! %%c
                                                                                                                                                                                        @REM echo !t14! %%d
                                                                                                                                                                                        echo Crop: %%e
                                                                                                                                                                                        echo !t15! %%f
                                                                                                                                                                                        @REM echo !t25! %%g
                                                                                                                                                                                        @REM echo Master Display Settings: %%h
                                                                                                                                                                                        echo Color Primary: %%i
                                                                                                                                                                                        echo Color Transfer: %%j
                                                                                                                                                                                        echo Color Matrix: %%k
                                                                                                                                                                                        echo !t8! %%l
                                                                                                                                                                                        echo !t9! %%m
                                                                                                                                                                                        @REM echo !t10! %%n
                                                                                                                                                                                        @REM echo !t11! %%o
                                                                                                                                                                                        echo Denoiser: %%p
                                                                                                                                                                                        echo !t12! %%q
                                                                                                                                                                                        echo !t21! %%r
                                                                                                                                                                                        @REM echo Color Correction: %%s
                                                                                                                                                                                        @REM if %%t==1 ( set unicopassaggiow=Si ) else ( set unicopassaggiow=No )
                                                                                                                                                                                        @REM echo !t24! !unicopassaggiow!
                                                                                                                                                                                        @REM echo Lookahead: %%u
                                                                                                                                                                                        @REM echo !t22! %%v
                                                                                                                                                                                        echo.
                                                                                                                                                                                        echo ------------------------------------------------------------------------------------------
                                                                                                                                                                                        echo.
                                                                                                                                                                                    )



                                                                                                                                                                                    set /a "numeroriga+=1"
                                                                                                                                                                    )
                                                goto fineletturaFFmpegCodifichesalvatesuDisco
                                                )

echo !t44!
                                    echo.

:fineletturaFFmpegCodifichesalvatesuDisco



set waitenter=
set /P waitenter=!t45!
Endlocal
goto InsertMoviesInSpoolMenu





rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:InserimentoCodificaHardwareDowngradingda1080p10bitSDRa1080p8bitSDR

cls
setLocal EnableExtensions EnableDelayedExpansion


for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoInserimentoCodificaHardwareDowngradingda1080p10bitSDRa1080p8bitSDR
)

if %lingua%==inglese (
    goto caricalinguaingleseInserimentoCodificaHardwareDowngradingda1080p10bitSDRa1080p8bitSDR
)



:caricalinguaingleseInserimentoCodificaHardwareDowngradingda1080p10bitSDRa1080p8bitSDR
set t1=Insert Hardware Video Encoding Info DownGrading from 1080p 10 bit SDR to 1080p 8 bit SDR and Saving to Disk

set t2=Drag Here the
set t211=File 1080p 10 bit SDR to Convert to 8 bit:  

set t3=File does not exist 
set t4=Info Video:  
set t5=The Inserted Video is 1080p 10bit SDR 
set t6=The Inserted Video isn't 1080p 10bit SDR 
set t7=Video Duration in seconds:
set t8=Video Duration in Minutes:
set t9=Interval between Frames for Crop Detection:
set t10= seconds
set t11=Black Bands Detection Started....
set t12=Crop Detection to Frame
set t13=to seconds
set t14=Done...
set t15=Input Video 1080p Width: 
set t16=Input Video 1080p Height:
set t17=Output Video 1080p Width Without Black Bars:
set t18=Outout Video 1080p Height Without Black Bars:
set t19=Adapting Video Resolution to Full 1080p Format...
set t20=Final Output Video Width 1080p:
set t21=Final Output Video Height 1080p:
set t22=Settings of Black Bands to Crop are Correct (Yes/No):
set t23=Manually Entering Black Band Values to Crop... 
set t24=Enter the Upper Black Band Value: 
set t25=Error Entering Upper Black Band Value... It's Not a Number. 
set t26=Enter the Lower Black Band Value: 
set t27=Error Entering Lower Black Band Value... It's Not a Number.
set t28=Enter the Left Black Band Value: 
set t29=Error Entering Left Black Band Value... It's Not a Number.
set t30=Enter the Right Black Band Value: 
set t31=Error Entering Right Black Band Value... It's Not a Number.
set t32=Upper Black Band:
set t33=Lower Black Band:
set t34=Left Black Band:
set t35=Right Black Band:
set t36=Original Video Width 1080p Without Black Bars:
set t37=Original Video Height 1080p Without Black Bars:
set t38=Select Graphic Card you want to Encode with:
set t39=Choose (1/2):
set t40=Select Encoding Type:
set t41=Error Entering Quantization Value... Not a Number. 
set t42=Quantization Value Set to:
set t43=Encoding Settings:
set t44=Enter Quantization value Minimum 10 Maximum 28:
set t45=Quantization Value Out of  Limits  10 / 28  Re-enter^!
set t46=Enter BitRate Value kbs Minimum 100 Maximum 50000:
set t47=Error Entering BitRate Value... It's Not a Number. 
set t48=BitRate Value Set to:
set t49=BitRate Value Out of Limits  100 / 50000  Re-enter^!
set t50=Select Encoding Quality:
set t51=- Worst Quality
set t52=- Best Quality
set t53=Choose (1/2/3/4/5/6/7):
set t54=Quality Set to:
set t55=Apply Convolution3D denoiser Yes/No: 
set t56=Apply PMD denoiser Yes/No: 
set t57=Apply Detail Enhancement Yes/No:  
set t58=Enhancement Detail: Yes 
set t59=Enhancement Detail: No 
set t60=Info
set t61=Videos to Encode Saved!
set t62=Do You Want to Insert Another Video to Encode (Yes/No):
set t63=The dragged file is not a video!
set t64=Choose (1/2/3/4):
set t65=Press Enter toback to Menu Inserting Encoding into the Queue and Saving to Disk:  

set t66=Video Width
set t67=Video Height
set t68=Video Codec
set t69=Details Video Codec
set t70=Video Format 

goto avvio_InserimentoCodificaHardwareDowngradingda1080p10bitSDRa1080p8bitSDR




:caricalinguaitalianoInserimentoCodificaHardwareDowngradingda1080p10bitSDRa1080p8bitSDR
set t1=Inserimento Info Codifica Hardware Video DownGrading da 1080p 10 bit SDR a 1080p 8 bit SDR e Salvataggio su Disco.

set t2=Trascina Qui il
set t211=File Video 1080p 10 bit SDR da Convertire a 8 bit:  

set t3=File Inesistente 
set t4=Informazioni Video:  
set t5=Il Video inserito e' 1080p 10bit SDR 
set t6=Il Video inserito non e' 1080p 10bit SDR 
set t7=Durata del Video in secondi:
set t8=Durata del video in Minuti:
set t9=Intervallo tra i Fotogrammi per il Rilevamento del crop:
set t10= secondi
set t11=Rilevamento Bande Nere Iniziato....
set t12=Rilevazione crop fotogramma
set t13=a secondi
set t14=Eseguita...
set t15=Larghezza Video 1080p Originale: 
set t16=Altezza Video 1080p Originale:
set t17=Larghezza Video 1080p Senza Barre Nere:
set t18=Altezza Video 1080p Senza Barre Nere:
set t19=Adattamento della Risoluzione del Video al Pieno Formato 1080p..
set t20=Larghezza Finale Video di Output 1080p:
set t21=Altezza Finale Video di Output 1080p:
set t22=Le Impostazioni delle Bande Nere da Tagliare sono Corrette (Si/No):
set t23=Inserimento Manuale Valori Bande Nere da Tagliare.. 
set t24=Inserisci il Valore della Banda Nera Superiore: 
set t25=Errore nell'Inserimento del Valore della Banda Nera Superiore... Non e' un Numero. 
set t26=Inserisci il Valore della Banda Nera Inferiore: 
set t27=Errore nell'Inserimento del Valore della Banda Nera Inferiore... Non e' un Numero. 
set t28=Inserisci il Valore della Banda Nera Sinistra: 
set t29=Errore nell'Inserimento del Valore della Banda Nera Sinistra... Non e' un Numero. 
set t30=Inserisci il Valore della Banda Nera Destra: 
set t31=Errore nell'Inserimento del Valore della Banda Nera Destra... Non e' un Numero. 
set t32=Banda Nera Superiore:
set t33=Banda Nera Inferiore:
set t34=Banda Nera Sinistra:
set t35=Banda Nera Destra:
set t36=Larghezza Video Originale 1080p Senza Barre Nere:
set t37=Altezza Video Originale 1080p Senza Barre Nere:
set t38=Selezionare Scheda Grafica con cui Eseguire la Codifica:
set t39=Scegli (1/2):
set t40=Selezionare tipo di Codifica:
set t41=Errore nell'Inserimento del Valore della Quantizzazione... Non e' un Numero. 
set t42=Valore Quantizzazzione Impostato a:
set t43=Parametri per codifica:
set t44=Inserire Valore Quantizzazione Minimo 10 Massimo 28:
set t45=Valore Quantizzazzione al di fuori dei  Limiti  10 / 28  Reinserire^!
set t46=Inserire Valore BitRate kbs Minimo 100 Massimo 50000:
set t47=Errore nell'Inserimento del Valore del BitRate... Non e' un Numero. 
set t48=Valore BitRate Impostato a:
set t49=Valore  BitRate al di fuori dei  Limiti  100 / 50000  Reinserire^!
set t50=Selezionare Qualita' Codifica:
set t51=- Peggiore Qualita'
set t52=- Migliore Qualita'
set t53=Scegli (1/2/3/4/5/6/7):
set t54=Qualita' Impostata su:
set t55=Applicare il denoiser Convolution3D Si/No: 
set t56=Applicare il denoiser PMD Si/No: 
set t57=Applicare il Miglioramento Dettagli Si/No:  
set t58=Miglioramento Dettagli: Si 
set t59=Miglioramento Dettagli: No 
set t60=Informazioni
set t61=Video da Codificare Salvate!
set t62=Vuoi Inserire un altro Video da Codificare (Si/No):
set t63=Il file trascinato non e' un video!
set t64=Scegli (1/2/3/4):
set t65=Premi Invio per tornare al menu' Inserimento Codifiche in Coda e Salvataggio sul Disco:  

set t66=Larghezza Video
set t67=Altezza Video
set t68=Codec Video
set t69=Codec Video Dettagli
set t70=Format Video 

goto avvio_InserimentoCodificaHardwareDowngradingda1080p10bitSDRa1080p8bitSDR


:avvio_InserimentoCodificaHardwareDowngradingda1080p10bitSDRa1080p8bitSDR


set /a "numeromovie=1"


echo !t1!
echo.


:altrivideodainserireNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR


set NomeFile2160ppuliziadettaggli=
rem set MetadatiStreamHDR10=

set /P NomeFile2160ppuliziadettaggli=!t2! !numeromovie! !t211! 
rem echo Hai digitato: %NomeFile%
rem pause

set "NomeFileSorgente=!NomeFile2160ppuliziadettaggli:"=!"
@REM echo NomeFileSorgente = !NomeFileSorgente!
set "NomeFile=^"!NomeFileSorgente!^""
@REM echo NomeFile = !NomeFile!
rem pause


if exist !NomeFile! ( goto infovideo_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR ) else ( 
                                                        echo.
                                                        echo !t3!
                                                        echo.
                                                        goto fineinfovideo_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
                                                        )    



:infovideo_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

echo.
echo !t4!
echo.

.\bin\ffprobe -v error -hide_banner -select_streams v:0 -show_entries stream=width,height,codec_name,codec_long_name,pix_fmt,color_space,color_transfer,color_primaries -of default=noprint_wrappers=1 !NomeFile! > ".\temp\Temp_HDR10_Stream.txt"

set /A x1=1
set /A nohdrcs=0
set /A nohdrct=0
set /A nohdrcp=0
set /A wv=0
set /a hv=0
set /A fv=0
set def=
rem echo nohdr = %nohdr%

for /f "tokens=1,2 delims==" %%a in (.\temp\Temp_HDR10_Stream.txt) do (if !x1!==3 ( 
                                                                            echo !t66! "%%a" = %%b  
                                                                            set /A "widthvideo=%%b"
                                                                            @REM echo widthvideo = !widthvideo!

                                                                            if !widthvideo! LEQ 1920 if !widthvideo! GEQ 1000 (set /A "wv=1"
                                                                                                                                @REM echo wv = !wv!
                                                                                                                                set "def=1080p"
                                                                                                                                )
                                                                            )
                                                                if !x1!==4 ( 
                                                                            echo !t67! "%%a" = %%b  
                                                                            set /A "heightvideo=%%b"
                                                                            @REM echo heightvideo = !heightvideo!
          
                                                                            if !heightvideo! LEQ 1080 if !heightvideo! GEQ 700 (set /A "hv=1"
                                                                                                                                @REM echo hv = !hv!
                                                                                                                                )
                                                                            )                                                           
                                                                if !x1!==6 ( 
                                                                            echo Color Space "%%a" = %%b  
                                                                            set "colorsp=%%b"
                                                                            @REM echo colorsp = !colorsp!
                                                                            if !colorsp!==bt709 (set /A "nohdrcs=1"
                                                                                                    @REM echo nohdrcs = !nohdrcs!
                                                                                                    )
                                                                            if !colorsp!==unknown (set /A "nohdrcs=1"
                                                                                                    @REM echo nohdrcs = !nohdrcs!
                                                                                                    )
                                                                            if !colorsp!==reserved (set /A "nohdrcs=1"
                                                                                                    @REM echo nohdrcs = !nohdrcs!
                                                                                                    )                    
                                                                            ) 
                                                                if !x1!==7 ( 
                                                                            echo Color Transfer "%%a" = %%b  
                                                                            set "colortr=%%b"
                                                                            @REM echo colortr = !colortr!
                                                                            if !colortr!==bt709 (set /A "nohdrct=1"
                                                                                                    @REM echo nohdrct = !nohdrct!
                                                                                                    )
                                                                            if !colortr!==unknown (set /A "nohdrct=1"
                                                                                                    @REM echo nohdrct = !nohdrct!
                                                                                                    )
                                                                            if !colortr!==reserved (set /A "nohdrct=1"
                                                                                                    @REM echo nohdrct = !nohdrct!
                                                                                                    )
                                                                            ) 
                                                                if !x1!==8 ( 
                                                                            echo Color Primaries "%%a" = %%b  
                                                                            set "colorpr=%%b"
                                                                            @REM echo colorpr = !colorpr!
                                                                            if !colorpr!==bt709 (set /A "nohdrcp=1"
                                                                                                    @REM echo nohdrcp = !nohdrcp!
                                                                                                    )      
                                                                            if !colorpr!==unknown (set /A "nohdrcp=1"
                                                                                                    @REM echo nohdrcp = !nohdrcp!
                                                                                                    )
                                                                            if !colorpr!==reserved (set /A "nohdrcp=1"
                                                                                                    @REM echo nohdrcp = !nohdrcp!
                                                                                                    )     
                                                                            )    
                                                                if !x1!==1 ( 
                                                                            echo !t68! "%%a" = %%b  
                                                                            )       
                                                                if !x1!==2 ( 
                                                                            echo !t69! "%%a" = %%b  
                                                                            )   
                                                                if !x1!==5 ( 
                                                                            echo !t70! "%%a" = %%b  
                                                                            set "formatvideo=%%b"
                                                                            @REM echo formatvideo = !formatvideo!
                                                                            if !formatvideo!==yuv420p10le (set /A "fv=1"
                                                                                                            @REM echo fv = !fv!
                                                                                                            )
                                                                            )
                                                                set /A x1+=1                                                            
)
echo.

if !x1!==1 goto :novideofile1080p10bitSDR


if !nohdrcs!==1 if !nohdrct!==1 if !nohdrcp!==1 if !wv!==1 if !hv!==1 if !fv!==1 ( 
                                                                                   echo !t5!
                                                                                   echo. 
                                                                                   goto RilevazioneBandeNere_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR                                                                   
                                                                                   ) 


echo !t6!
echo.
goto fineinfovideo_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

echo.


:RilevazioneBandeNere_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

.\bin\ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 !NomeFile!  > ".\temp\durata_film.txt"

set /a contatore=1
for /f "tokens=1 delims=." %%a in (.\temp\durata_film.txt) do  (
                                                        echo. 
                                                        echo !t7! %%a
                                                        set /a "secondi=%%a"
                                                        set /a "minuti=!secondi!/60"
                                                        echo !t8! !minuti!
                                                        set /a "intervallo_tagli=!secondi!/11"
                                                        echo !t9! !intervallo_tagli!!t10!
                                                        echo.
                                                        echo !t11!
                                                        echo.

                                                        

                                                        FOR /L %%a IN (1, 1, 10) DO (
                                                                                    rem echo %%a
                                                                                    set /a "secondi=%%a*!intervallo_tagli!"
                                                                                    rem echo !secondi!

                                                                                    
                                                                                    set /a "ca=16"
                                                                                    rem echo !ca!
                                                                                                                    
                                                                                    set /a "cb=2"
                                                                                    rem echo !cb!
                                                                                                                    
                                                                                    set /a "cc=0"
                                                                                    rem echo !cc!

                                                                                    set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                    rem echo !cr!
        
                                                                                
                                                                                    .\bin\ffmpeg -ss !secondi! -hide_banner -nostats -i !NomeFile! -vframes 10 -vf !cr! -f null - 2> ".\temp\crop.txt"
                                                                                    
                                                                                    findstr /r "Parsed_cropdetect_0" .\temp\crop.txt >> .\temp\risultato_multiplo.txt   
                                                                                    
                                                                                    echo !t12! %%a !t13! !secondi! !t14!
                                                                                    
                                                                                    )       
                                                                                       

                                                                                    for /f "tokens=1,2 delims==" %%a in (.\temp\risultato_multiplo.txt) do ( echo %%b >> .\temp\crop_multiplo.txt )
                                                                                    
                                                                                    set /a "maxfrequenza=0"

                                                                                    for /f "delims=" %%a in (.\temp\crop_multiplo.txt) do ( 
                                                                                                                                    set "cropconfront=%%a"
                                                                                                                                    rem echo "!cropconfront!"
                                                                                                                                    
                                                                                                                                    set /a "contatorfrequenza=0"
                                                                                                                                    for /f "delims=" %%b in (.\temp\crop_multiplo.txt) do (
                                                                                                                                                                                    set "dato_da_verificare=%%b"
                                                                                                                                                                                    rem echo cropconfront = "!cropconfront!"
                                                                                                                                                                                    rem echo dato_da_verificare = "!dato_da_verificare!"
                                                                                                                                                                                    if !cropconfront!==!dato_da_verificare! ( set /a "contatorfrequenza+=1")
                                                                                                                                                                                    )
                                                                                                                                    if !maxfrequenza! LSS !contatorfrequenza! ( 
                                                                                                                                                                                set /a "maxfrequenza=!contatorfrequenza!"
                                                                                                                                                                                set "cropd=!cropconfront!"
                                                                                                                                                                                )
                                                                                                                                    

                                                                                                                                    rem if !cropconfront! in (elenco_crop_frequenza.txt) ()
                                                                                                                                    rem echo !cropconfront!:!contatorfrequenza! >> elenco_crop_frequenza.txt

                                                                                                                                    )

                                                                                    rem echo crop piu' frequente = !cropd! con grequenza = !maxfrequenza!
                                                                                    echo !cropd! > .\temp\crop_finale.txt

                                                                                    for /f "tokens=1,2,3,4 delims=:" %%a in (.\temp\crop_finale.txt) do  ( 
                                                                                                                                                    rem set /a "mwidth=%%a"
                                                                                                                                                    rem echo mwidth = !mwidth!

                                                                                                                                                    rem set /a "mheight=%%b"
                                                                                                                                                    rem echo mheight = !mheight!

                                                                                                                                                    rem set /a "mx=%%c"
                                                                                                                                                    rem echo mx = !mx!

                                                                                                                                                    rem set /a "my=%%d"
                                                                                                                                                    rem echo my = !my!

                                                                                                                                                    if !contatore!==1 ( 
                                                                                                                                                                set /a "wmax=%%a" 
                                                                                                                                                                set /a "hmax=%%b"
                                                                                                                                                                set /a "xmin=%%c"
                                                                                                                                                                set /a "ymin=%%d"
                                                                                                                                                                set /a "mwidth=%%a"
                                                                                                                                                                set /a "mheight=%%b"
                                                                                                                                                                set /a "mx=%%c"
                                                                                                                                                                set /a "my=%%d"
                                                                                                                                                                set /a "contatore+=1"
                                                                                                                                                                )
                                                                                                                                                    
                                                                                                                                                    rem if %%b gtr !hmax! if %%c gtr !xmin! if %%d gtr !ymin! 

                                                                                                                                                    if %%a geq !wmax! if %%b geq !hmax! ( 
                                                                                                                                                                        set /a "wmax=%%a" 
                                                                                                                                                                        set /a "hmax=%%b"
                                                                                                                                                                        set /a "xmin=%%c"
                                                                                                                                                                        set /a "ymin=%%d"
                                                                                                                                                                        set /a "mwidth=%%a"
                                                                                                                                                                        set /a "mheight=%%b"
                                                                                                                                                                        set /a "mx=%%c"
                                                                                                                                                                        set /a "my=%%d"
                                                                                                                                                                        )
                                                                                                                                                    )
                                                                                    echo.
                                                                                    set /a "csup=!my!"
                                                                                    rem echo csup = !csup!
                                                                                                                                    
                                                                                    set /a "csin=!mx!"
                                                                                    rem echo csin = !csin!

                                                                                    set /a "cinf=!heightvideo!-!mheight!-!my!"
                                                                                    rem echo movieheightreal = !movieheightreal!
                                                                                    rem echo cinf = !cinf!
                                                                                    set /a "cdes=!widthvideo!-!mwidth!-!mx!"
                                                                                    rem echo cdes = !cdes!

                                                                                    echo !t15! !widthvideo!  
                                                                                    echo !t16! !heightvideo!  
                                                                                    echo.

                                                                                    echo Crop Settings: --crop !csin!,!csup!,!cdes!,!cinf!  
                                                                                    set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"  
                                                                                    echo.  

                                                                                    set /a "height2k=(!heightvideo!-!csup!-!cinf!)/2*2"
                                                                                    set /a "width2k=(!widthvideo!-!csin!-!cdes!)/2*2"

                                                                                    echo !t17! !width2k!  
                                                                                    echo !t18! !height2k!  
                                                                                    echo.

                                                                                    @REM echo Larghezza Video Originale 1080p Senza Barre Nere:  !mwidth! 
                                                                                    @REM echo Altezza Video Originale 1080p Senza Barre Nere:  !mheight! 
                                                                                    @REM echo.

                                                                                    set /a "larghezza1080pnvenc=1920"
                                                                                    set /a "altezza1080pnvenc=1080"
                                                                                    @REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
                                                                                    @REM echo altezza1080pnvenc = !altezza1080pnvenc!                                    

                                                                                    set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!mwidth!"
                                                                                    set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!mheight!"
                                                                                    @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
                                                                                    @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

                                                                                    if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                                                                                                        @REM echo dentro il 1o if
                                                                                                                                                                        set /a "width2k=!mwidth!"
                                                                                                                                                                        set /a "height2k=!mheight!"
                                                                                                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                                                                                                set /a "width2k=!mwidth!"
                                                                                                                                                                                                                                                                set /a "height2k=!mheight!"
                                                                                                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                                                                                                        set /a "width2k=!mwidth!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        set /a "height2k=!mheight!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "width2k=!mwidth!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "height2k=!mheight!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                                                                                                                set /a "width2k=!mwidth!"
                                                                                                                                                                                                                                                                set /a "height2k=!mheight!"
                                                                                                                                                                                                                                                                )
                                                                                                                                                                        
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                                                                                                        set /a "width2k=!mwidth!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        set /a "height2k=!mheight!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.                         

                                                                                        echo !t20!  !width2k! 
                                                                                        echo !t21!  !height2k!    
                                                                                        echo.

                                                                                        @REM set /a "width4k=width2k*2"
                                                                                        @REM set /a "height4k=height2k*2"

                                                                                        @REM echo Larghezza Finale Video 2160p =  !width4k! 
                                                                                        @REM echo Altezza Finale Video 2160p =  !height4k!    
                                                                                        echo.

                                                                                    ) 
                                                        )                          

:cropmanuale_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set /a "csup=0"
set /a "cinf=0"
set /a "csin=0"
set /a "cdes=0"
set /a "bandasuperiore=0"
set /a "bandainferiore=0"
set /a "bandasinistra=0"
set /a "bandadestra=0"
set /a "differenzialelarghezza1080pnvenc=0"
set /a "differenzialealtezza1080pnvenc=0"
if exist ".\temp\Temp_HDR10_Stream.txt" ( del ".\temp\Temp_HDR10_Stream.txt" ) 
if exist ".\temp\durata_film.txt" ( del ".\temp\durata_film.txt" )
if exist ".\temp\crop.txt" ( del ".\temp\crop.txt" )
if exist ".\temp\risultato_multiplo.txt" ( del ".\temp\risultato_multiplo.txt" )
if exist ".\temp\crop_multiplo.txt" ( del ".\temp\crop_multiplo.txt" )
if exist ".\temp\crop_finale.txt" ( del ".\temp\crop_finale.txt" )


if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t22!"   
    if errorlevel 2 goto cropmanualeNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
    if errorlevel 1 goto finecropNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
)

CHOICE /N /C:SN /M "!t22!"   

if errorlevel 2 goto cropmanualeNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
if errorlevel 1 goto finecropNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR


:cropmanualeNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
echo.
echo !t23!
echo.

:banda_superiore_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set /p "bandasuperiore=!t24!"
SET "var="&for /f "delims=0123456789" %%i in ("!bandasuperiore!") do set var=!bandasuperiore!
if defined var (
                echo.
                echo !t25!
                echo.
                goto banda_superiore_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
                ) else (
                        set /a "csup=!bandasuperiore!/2*2"
                        )

echo.


:banda_inferiore_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set /p "bandainferiore=!t26!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandainferiore!") do set var=!bandainferiore!
if defined var (
                echo.
                echo !t27!
                echo.
                goto banda_inferiore_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
                ) else (
                        set /a "cinf=!bandainferiore!/2*2"
                        )


echo.
:banda_sinistra_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set /p "bandasinistra=!t28!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandasinistra!") do set var=!bandasinistra!
if defined var (
                echo.
                echo !t29!
                echo.
                goto banda_sinistra_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
                ) else (
                        set /a "csin=!bandasinistra!/2*2"
                        )

                        
echo.
:banda_destra_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set /p "bandadestra=!t30!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandadestra!") do set var=!bandadestra!
if defined var (
                echo.
                echo !t31!
                echo.
                goto banda_destra_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
                ) else (
                        set /a "cdes=!bandadestra!/2*2"
                        )


set /a "larghezza1080pnvenc=1920"
set /a "altezza1080pnvenc=1080"
@REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
@REM echo altezza1080pnvenc = !altezza1080pnvenc!                                    

set /a "mwidth=!widthvideo!/2*2"
set /a "mheight=!heightvideo!/2*2"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "mwidthc=!mwidth!-!csin!-!cdes!"
set /a "mheightc=!mheight!-!csup!-!cinf!"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "width2k=!mwidthc!"
set /a "height2k=!mheightc!"

set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!mwidthc!"
set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!mheightc!"
@REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
@REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

echo.
echo !t32!  !csup! 
echo !t33!  !cinf! 
echo !t34!  !csin! 
echo !t35!  !cdes! 
echo.


set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
echo Crop Settings: !cropff!
echo.

echo !t36!  !width2k! 
echo !t37!  !height2k! 
echo.



if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                        @REM echo dentro il 1o if
                                                                                        set /a "width2k=!mwidthc!"
                                                                                        set /a "height2k=!mheightc!"
                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                set /a "width2k=!mwidthc!"
                                                                                                                                                                                set /a "height2k=!mheightc!"
                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                        set /a "width2k=!mwidthc!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                        set /a "height2k=!mheightc!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                set /a "width2k=!mwidthc!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                set /a "height2k=!mheightc!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                )
                                                                                        if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                        set /a "width2k=!mwidthc!"
                                                                                                                                                                        set /a "height2k=!mheightc!"
                                                                                                                                                                        )
                                                                                                                                                                        
                                                                                        if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                set /a "width2k=!mwidthc!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                set /a "height2k=!mheightc!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.

                                                                                        echo !t20!  !width2k! 
                                                                                        echo !t21!  !height2k!    
                                                                                        echo.

                                                                                        @REM set /a "width4k=width2k*2"
                                                                                        @REM set /a "height4k=height2k*2"

                                                                                        @REM echo Larghezza Finale Video 2160p =  !width4k! 
                                                                                        @REM echo Altezza Finale Video 2160p =  !height4k!    
                                                                                        @REM echo.
                                                                                    ) 

goto cropmanuale_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:finecropNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR


echo.
echo !t38!
echo.
echo 1) NVidia 
echo 2) Intel 
echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto ChoosenIntel_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
if errorlevel 1 goto ChoosenNVidia_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:ChoosenIntel_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "SchedaGrafica=Intel"
@REM echo SchedaGrafica = !SchedaGrafica!
goto fineSceltaSchedaGrafica_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:ChoosenNVidia_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "SchedaGrafica=NVidia"
@REM echo SchedaGrafica = !SchedaGrafica!

:fineSceltaSchedaGrafica_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

@REM pause 

if !SchedaGrafica!==NVidia (
                                goto InserimentoImpostazioniNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
                                ) 





if !SchedaGrafica!==Intel (
                                goto InserimentoImpostazioniQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
                                 )


@REM pause 


rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


:InserimentoImpostazioniNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

echo.
echo !t40!
echo.
echo 1) CQP 
echo 2) VBR 
echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto CodificaVBRNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
if errorlevel 1 goto CodificaCQPNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:CodificaVBRNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "TipoCodificaNVEnc=--vbr "
set /a "quantizzazioneNVEnc=0"
goto inserimentoValoriCQPVBRNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:CodificaCQPNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "TipoCodificaNVEnc=--cqp "
set /a "quantizzazioneNVEnc=1"

:inserimentoValoriCQPVBRNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

if !quantizzazioneNVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneNVEnc=!t44! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneNVEnc!") do set var=!valoreQuantizzazioneNVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                echo.
                                                goto inserimentoValoriCQPVBRNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
                                                ) 

                                set /a "valoreQuantizzazioneNVEnc=!valoreQuantizzazioneNVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneNVEnc!
                                if !valoreQuantizzazioneNVEnc! GEQ 10 if !valoreQuantizzazioneNVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneNVEnc!
                                                                                                                set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreQuantizzazioneNVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                                goto fineQuantizzazioneNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
                                                                                                                        
                                )



if !quantizzazioneNVEnc!==0 (
                                echo.
                                set /p "valoreBitRateNVEnc=!t46! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateNVEnc!") do set var=!valoreBitRateNVEnc!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                echo.
                                                goto inserimentoValoriCQPVBRNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
                                                ) 
                                set /a "valoreBitRateNVEnc=!valoreBitRateNVEnc!"
                                @REM echo valoreBitRateNVEnc = !valoreBitRateNVEnc!
                                if !valoreBitRateNVEnc! GEQ 100 if !valoreBitRateNVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateNVEnc!
                                                                                                        set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreBitRateNVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                        goto fineQuantizzazioneNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
                                                                                                              
                                )


:fineQuantizzazioneNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR


echo.
echo !t50!
echo.
echo 1) P1 !t51!
echo 2) P2 
echo 3) P3 
echo 4) P4 
echo 5) P5 
echo 6) P6 
echo 7) P7 !t52!
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto P7NVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
if errorlevel 6 goto P6NVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
if errorlevel 5 goto P5NVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
if errorlevel 4 goto P4NVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
if errorlevel 3 goto P3NVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
if errorlevel 2 goto P2NVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
if errorlevel 1 goto P1NVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR


:P7NVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "SettaggioQualitaNVEnc=--preset P7"
set "QualitySetting=P7"
goto fineQualitCodificaNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:P6NVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "SettaggioQualitaNVEnc=--preset P6"
set "QualitySetting=P6"
goto fineQualitCodificaNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:P5NVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "SettaggioQualitaNVEnc=--preset P5"
set "QualitySetting=P5"
goto fineQualitCodificaNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:P4NVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "SettaggioQualitaNVEnc=--preset P4"
set "QualitySetting=P4"
goto fineQualitCodificaNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:P3NVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "SettaggioQualitaNVEnc=--preset P3"
set "QualitySetting=P3"
goto fineQualitCodificaNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:P2NVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "SettaggioQualitaNVEnc=--preset P2"
set "QualitySetting=P2"
goto fineQualitCodificaNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:P1NVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "SettaggioQualitaNVEnc=--preset P1"
set "QualitySetting=P1"
goto fineQualitCodificaNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR


:fineQualitCodificaNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaNVEnc!


set conv3d1080p=
set pmd1080p=

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t55!"
    if errorlevel 2 goto conv3dChoosenNoNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
    if errorlevel 1 goto conv3dChoosenYesNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
)

echo.
CHOICE /N /C:SN /M "!t55!"

if errorlevel 2 goto conv3dChoosenNoNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
if errorlevel 1 goto conv3dChoosenYesNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:conv3dChoosenNoNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "conv3d1080p=N"
goto sceltaDeniserPMDNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:conv3dChoosenYesNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "conv3d1080p=S"



:sceltaDeniserPMDNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t56!"
    if errorlevel 2 goto PMDChoosenNoNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
    if errorlevel 1 goto PMDChoosenYesNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
)

echo.
CHOICE /N /C:SN /M "!t56!"

if errorlevel 2 goto PMDChoosenNoNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
if errorlevel 1 goto PMDChoosenYesNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:PMDChoosenNoNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "pmd1080p=N"
goto assegnazioneDenoisesNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:PMDChoosenYesNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "pmd1080p=S"


:assegnazioneDenoisesNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set /A nvdenv=0

if !conv3d1080p!==S if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00 --vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==S if !pmd1080p!==N ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==N ( 
                                        set "nvdenoiser=nessuno" 
                                        set "nvdenv=1"
                                        set "unicopassaggio=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: Nessun Denoiser 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )

@REM pause


echo.

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t57!"
    if errorlevel 2 goto ApplicaMiglioramentoDettagliNVEncNo_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
    if errorlevel 1 goto ApplicaMiglioramentoDettagliNVEncSi_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
)

CHOICE /N /C:SN /M "!t57!"

if errorlevel 2 goto ApplicaMiglioramentoDettagliNVEncNo_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
if errorlevel 1 goto ApplicaMiglioramentoDettagliNVEncSi_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:ApplicaMiglioramentoDettagliNVEncNo_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "miglioramento1080p=N"
goto fineSceltaMigliaramentiNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:ApplicaMiglioramentoDettagliNVEncSi_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "miglioramento1080p=S"

:fineSceltaMigliaramentiNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
if !miglioramento1080p!==S ( 
                                set "edgeleveling=--vpp-edgelevel strength=10.0,threshold=24.0,black=6,white=0" 
                                echo.
                                echo NVEnc !t58!
                                echo.
                                )
if !miglioramento1080p!==N ( 
                                set "edgeleveling=nessuno" 
                                echo.
                                echo NVEnc !t59!
                                echo.
                                )


@REM pause


set file_senza_virgolette=!NomeFile:"=!
rem echo %file_senza_virgolette%

set file_senza_estensione=!file_senza_virgolette:.mkv=!
rem echo %file_senza_estensione%

set fileoutput2160p="!file_senza_estensione!_1080p_8bit_SDR.mkv"
rem echo fileoutput2160p = %fileoutput2160p%

echo.
set "VideoInfoCodifica=NVEnc_DownGrading_da_1080p_10bit_SDR_a_1080p_8bit_SDR|!NomeFile!|!fileoutput2160p!|nessuno|!cropff!|!width2k!x!height2k!|nessuna|nessuno|!colorpr!|!colortr!|!colorsp!|!tipoQuantizzazioneNVEnc!|!SettaggioQualitaNVEnc!|nessuno|nessuno|!nvdenoiser!|!formatvideo!|!edgeleveling!|no_color_correction|no_numero_passaggi_upscaling|no_lokahead|no_precisione_vettore_movimento"
@REM echo VideoInfoCodifica = !VideoInfoCodifica!
@REM echo.

if exist ".\saved\savedmoviesallencodings.dat" ( 
                                                echo !VideoInfoCodifica! >> .\saved\savedmoviesallencodings.dat
                                                goto finesalvataggioInserimentoNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
                                                ) 

echo !VideoInfoCodifica! > .\saved\savedmoviesallencodings.dat


:finesalvataggioInserimentoNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

echo !t60! !numeromovie! !t61!
echo.


if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t62!"
    if errorlevel 2 goto finesceltanuovovideodacodificareNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
    if errorlevel 1 goto altrivideodainserireMenuNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
)

CHOICE /N /C:SN /M "!t62!"
echo.

if errorlevel 2 goto finesceltanuovovideodacodificareNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
if errorlevel 1 goto altrivideodainserireMenuNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:altrivideodainserireMenuNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set /a "numeromovie+=1"
echo.
goto altrivideodainserireNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:finesceltanuovovideodacodificareNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
echo.
goto fineinfovideo_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////





rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


:InserimentoImpostazioniQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR


echo.
echo !t40!
echo.
echo 1) CQP 
echo 2) ICQ 
echo 3) LA-ICQ 
echo 4) VBR 
echo.
CHOICE /N /C:1234 /M "!t64!"

if errorlevel 4 goto CodificaVBRQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
if errorlevel 3 goto CodificaLAICQQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
if errorlevel 2 goto CodificaICQQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR 
if errorlevel 1 goto CodificaCQPQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR


:CodificaCQPQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "TipoCodificaQSVEnc=--cqp "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVCEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:CodificaICQQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "TipoCodificaQSVEnc=--icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVCEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:CodificaLAICQQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "TipoCodificaQSVEnc=--la-icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVCEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:CodificaVBRQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "TipoCodificaQSVEnc=--vbr "
set /a "quantizzazioneQSVEnc=0"
goto inserimentoValoriCQPVBRQSVCEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR


:inserimentoValoriCQPVBRQSVCEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

if !quantizzazioneQSVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneQSVEnc=!t44! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneQSVEnc!") do set var=!valoreQuantizzazioneQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                echo.
                                                goto inserimentoValoriCQPVBRQSVCEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
                                                ) 

                                set /a "valoreQuantizzazioneQSVEnc=!valoreQuantizzazioneQSVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneQSVEnc!
                                if !valoreQuantizzazioneQSVEnc! GEQ 10 if !valoreQuantizzazioneQSVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneQSVEnc!
                                                                                                                set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreQuantizzazioneQSVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                                goto fineQuantizzazioneQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRQSVCEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
                                                                                                                        
                                )



if !quantizzazioneQSVEnc!==0 (
                                echo.
                                set /p "valoreBitRateQSVEnc=!t46! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateQSVEnc!") do set var=!valoreBitRateQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                echo.
                                                goto inserimentoValoriCQPVBRQSVCEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
                                                ) 
                                set /a "valoreBitRateQSVEnc=!valoreBitRateQSVEnc!"
                                @REM echo valoreBitRateQSVEnc = !valoreBitRateQSVEnc!
                                if !valoreBitRateQSVEnc! GEQ 100 if !valoreBitRateQSVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateQSVEnc!
                                                                                                        set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreBitRateQSVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                        goto fineQuantizzazioneQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRQSVCEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
                                                                                                              
                                )


:fineQuantizzazioneQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR


echo.
echo !t50!
echo.
echo 1) Best 
echo 2) Higher 
echo 3) High 
echo 4) Balanced 
echo 5) Fast 
echo 6) Faster 
echo 7) Fastest 
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto QualitFastestQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
if errorlevel 6 goto QualitFasterQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
if errorlevel 5 goto QualitFastQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
if errorlevel 4 goto QualitBalancedtQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
if errorlevel 3 goto QualitHighQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
if errorlevel 2 goto QualitHigherQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
if errorlevel 1 goto QualitBestQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR


:QualitBestQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "SettaggioQualitaQSvenc=--quality best"
set "QualitySetting=best"
goto fineQualitCodificaQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:QualitHigherQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "SettaggioQualitaQSvenc=--quality higher"
set "QualitySetting=higher"
goto fineQualitCodificaQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:QualitHighQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "SettaggioQualitaQSvenc=--quality high"
set "QualitySetting=high"
goto fineQualitCodificaQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:QualitBalancedtQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "SettaggioQualitaQSvenc=--quality balanced"
set "QualitySetting=balanced"
goto fineQualitCodificaQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:QualitFastQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "SettaggioQualitaQSvenc=--quality fast"
set "QualitySetting=fast"
goto fineQualitCodificaQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:QualitFasterQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "SettaggioQualitaQSvenc=--quality faster"
set "QualitySetting=faster"
goto fineQualitCodificaQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:QualitFastestQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "SettaggioQualitaQSvenc=--quality fastest"
set "QualitySetting=fastest"
goto fineQualitCodificaQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR


:fineQualitCodificaQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaQSvenc!



set conv3d1080p=
set pmd1080p=

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t55!"
    if errorlevel 2 goto conv3dChoosenNoQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
    if errorlevel 1 goto conv3dChoosenYesQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
)
echo.
CHOICE /N /C:SN /M "!t55!"

if errorlevel 2 goto conv3dChoosenNoQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
if errorlevel 1 goto conv3dChoosenYesQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:conv3dChoosenNoQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "conv3d1080p=N"
goto sceltaDeniserPMDQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:conv3dChoosenYesQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "conv3d1080p=S"



:sceltaDeniserPMDQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t56!"
    if errorlevel 2 goto PMDChoosenNoQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
    if errorlevel 1 goto PMDChoosenYesQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
)
echo.
CHOICE /N /C:SN /M "!t56!"

if errorlevel 2 goto PMDChoosenNoQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
if errorlevel 1 goto PMDChoosenYesQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:PMDChoosenNoQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "pmd1080p=N"
goto assegnazioneDenoisesQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:PMDChoosenYesQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "pmd1080p=S"


:assegnazioneDenoisesQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set /A nvdenv=0

if !conv3d1080p!==S if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00 --vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==S if !pmd1080p!==N ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==N ( 
                                        set "nvdenoiser=nessuno" 
                                        set "nvdenv=1"
                                        set "unicopassaggio=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: Nessun Denoiser 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )

@REM pause

echo.

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t57!"
    if errorlevel 2 goto ApplicaMiglioramentoDettagliQSVEncNo_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
    if errorlevel 1 goto ApplicaMiglioramentoDettagliQSVEncSi_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
)
CHOICE /N /C:SN /M "!t57!"

if errorlevel 2 goto ApplicaMiglioramentoDettagliQSVEncNo_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
if errorlevel 1 goto ApplicaMiglioramentoDettagliQSVEncSi_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:ApplicaMiglioramentoDettagliQSVEncNo_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "miglioramento1080p=N"
goto fineSceltaMigliaramentiQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:ApplicaMiglioramentoDettagliQSVEncSi_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set "miglioramento1080p=S"

:fineSceltaMigliaramentiQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
if !miglioramento1080p!==S ( 
                                set "edgeleveling=--vpp-edgelevel strength=10.0,threshold=24.0,black=6,white=0" 
                                echo.
                                echo QSVEnc !t58!
                                echo.
                                )
if !miglioramento1080p!==N ( 
                                set "edgeleveling=nessuno" 
                                echo.
                                echo QSVEnc !t59!
                                echo.
                                )


@REM pause



set file_senza_virgolette=!NomeFile:"=!
rem echo %file_senza_virgolette%

set file_senza_estensione=!file_senza_virgolette:.mkv=!
rem echo %file_senza_estensione%

set fileoutput2160p="!file_senza_estensione!_1080p_8bit_SDR.mkv"
rem echo fileoutput2160p = %fileoutput2160p%

echo.
set "VideoInfoCodifica=QSVEnc_DownGrading_da_1080p_10bit_SDR_a_1080p_8bit_SDR|!NomeFile!|!fileoutput2160p!|nessuno|!cropff!|!width2k!x!height2k!|nessuna|nessuno|!colorpr!|!colortr!|!colorsp!|!tipoQuantizzazioneQSVEnc!|!SettaggioQualitaQSVEnc!|nessuno|nessuno|!nvdenoiser!|!formatvideo!|!edgeleveling!|no_color_correction|no_numero_passaggi_upscaling|no_lokahead|no_precisione_vettore_movimento"
@REM echo VideoInfoCodifica = !VideoInfoCodifica!
@REM echo.

if exist ".\saved\savedmoviesallencodings.dat" ( 
                                                echo !VideoInfoCodifica! >> .\saved\savedmoviesallencodings.dat
                                                goto finesalvataggioInserimentoNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
                                                ) 

echo !VideoInfoCodifica! > .\saved\savedmoviesallencodings.dat


:finesalvataggioInserimentoQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

echo !t60! !numeromovie! !t61!
echo.

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t62!"
    if errorlevel 2 goto finesceltanuovovideodacodificareQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
    if errorlevel 1 goto altrivideodainserireMenuQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
)

CHOICE /N /C:SN /M "!t62!"
echo.

if errorlevel 2 goto finesceltanuovovideodacodificareQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
if errorlevel 1 goto altrivideodainserireMenuQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:altrivideodainserireMenuQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
set /a "numeromovie+=1"
echo.
goto altrivideodainserireNVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR

:finesceltanuovovideodacodificareQSVEnc_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR
echo.
goto fineinfovideo_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR


rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



:novideofile2160p_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
echo !t63!
echo.


:fineinfovideo_InserimentoDowngradingda1080p10bitSDRa1080p8bitSDR



if exist ".\temp\Temp_HDR10_Stream.txt" ( del .\temp\Temp_HDR10_Stream.txt )
if exist ".\temp\durata_film.txt" ( del .\temp\durata_film.txt )
if exist ".\temp\crop.txt" ( del .\temp\crop.txt )
if exist ".\temp\risultato_multiplo.txt" ( del .\temp\risultato_multiplo.txt )
if exist ".\temp\crop_multiplo.txt" ( del .\temp\crop_multiplo.txt )
if exist ".\temp\crop_finale.txt" ( del .\temp\crop_finale.txt )
      




set waitenter=
set /P waitenter=!t65!
Endlocal
goto InserimentoCodifcaInCodaeSalvataggioSuDisco







rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:InserimentoCodificaHardwareDowngradingPiuDownscalingda2160p10bitHDRa1080p8bitSDR

cls
setLocal EnableExtensions EnableDelayedExpansion


for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoInserimentoCodificaHardwareDowngradingPiuDownscalingda2160p10bitHDRa1080p8bitSDR
)

if %lingua%==inglese (
    goto caricalinguaingleseInserimentoCodificaHardwareDowngradingPiuDownscalingda2160p10bitHDRa1080p8bitSDR
)



:caricalinguaingleseInserimentoCodificaHardwareDowngradingPiuDownscalingda2160p10bitHDRa1080p8bitSDR
set t1=Insert Hardware Video Encoding Info DownGrading and DownScaling from 2160p 10 bit HDR to  1080p 8 bit SDR and Saving to Disk

set t2=Drag Here the
set t211=Video File 2160p 10 bit HDR to Convert to  1080p 8 bit SDR:  

set t3=File does not exist 
set t4=Info Video:  
set t5=The Inserted Video is 2160p 10bit HDR 
set t6=The Inserted Video isn't 2160p 10bit HDR 
set t7=Video Duration in seconds:
set t8=Video Duration in Minutes:
set t9=Interval between Frames for Crop Detection:
set t10= seconds
set t11=Black Bands Detection Started....
set t12=Crop Detection to Frame
set t13=to seconds
set t14=Done...
set t15=Original 2160p Video Width: 
set t16=Original 2160p Video Height:
set t17=Output Video 2160p Width Without Black Bars:
set t18=Outout Video 2160p Height Without Black Bars:

set t171=Output Video 1080p Width Without Black Bars:
set t181=Outout Video 1080p Height Without Black Bars:

set t19=Adapting Video Resolution to Full 1080p Format...
set t20=Final 1080p Output Video Width:
set t21=Final 1080p Output Video Height:
set t22=Settings of Black Bands to Crop are Correct (Yes/No):
set t23=Manually Entering Black Band Values to Crop... 
set t24=Enter the Upper Black Band Value: 
set t25=Error Entering Upper Black Band Value... It's Not a Number. 
set t26=Enter the Lower Black Band Value: 
set t27=Error Entering Lower Black Band Value... It's Not a Number.
set t28=Enter the Left Black Band Value: 
set t29=Error Entering Left Black Band Value... It's Not a Number.
set t30=Enter the Right Black Band Value: 
set t31=Error Entering Right Black Band Value... It's Not a Number.
set t32=Upper Black Band:
set t33=Lower Black Band:
set t34=Left Black Band:
set t35=Right Black Band:
set t36=2160p Video Width without Black Bars:
set t37=2160p Video Height without Black Bars

set t361=1080p Video Width without Black Bars:
set t371=1080p Video Height without Black Bars

set t38=Select Graphic Card you want to Encode with:
set t39=Choose (1/2):
set t40=Select Encoding Type:
set t41=Error Entering Quantization Value... Not a Number. 
set t42=Quantization Value Set to:
set t43=Encoding Settings:
set t44=Enter Quantization value Minimum 10 Maximum 28:
set t45=Quantization Value Out of  Limits  10 / 28  Re-enter^!
set t46=Enter BitRate Value kbs Minimum 100 Maximum 50000:
set t47=Error Entering BitRate Value... It's Not a Number. 
set t48=BitRate Value Set to:
set t49=BitRate Value Out of Limits  100 / 50000  Re-enter^!
set t50=Select Encoding Quality:
set t51=- Worst Quality
set t52=- Best Quality
set t53=Choose (1/2/3/4/5/6/7):
set t54=Quality Set to:
set t55=Apply Convolution3D denoiser Yes/No: 
set t56=Apply PMD denoiser Yes/No: 
set t57=Apply Detail Enhancement Yes/No:  
set t58=Enhancement Detail: Yes 
set t59=Enhancement Detail: No 
set t60=Info
set t61=Videos to Encode Saved!
set t62=Do You Want to Insert Another Video to Encode (Yes/No):
set t63=The dragged file is not a video!
set t64=Choose (1/2/3/4):
set t65=Press Enter toback to Menu Inserting Encoding into the Queue and Saving to Disk:  

set t66=Video Width
set t67=Video Height
set t68=Video Codec
set t69=Details Video Codec
set t70=Video Format 
set t71=Configuration Settings to convert video from 10bit HDR to 8bit SDR
set t72=Select Encoding DownGrader:
set t73=Settings DownGrader:

goto avvio_InserimentoCodificaHardwareDowngradingPiuDownscalingda2160p10bitHDRa1080p8bitSDR




:caricalinguaitalianoInserimentoCodificaHardwareDowngradingPiuDownscalingda2160p10bitHDRa1080p8bitSDR
set t1=Inserimento Info Codifica Hardware Video DownGrading e DownScalingda 2160p 10 bit HDR a 1080p 8 bit SDR e Salvataggio su Disco.

set t2=Trascina Qui il 
set t211=File Video 2160p 10 bit HDR da Convertire in  1080p 8 bit SDR:  

set t3=File Inesistente 
set t4=Informazioni Video:  
set t5=Il Video inserito e' 2160p 10bit HDR 
set t6=Il Video inserito non e' 2160p 10bit HDR 
set t7=Durata del Video in secondi:
set t8=Durata del video in Minuti:
set t9=Intervallo tra i Fotogrammi per il Rilevamento del crop:
set t10= secondi
set t11=Rilevamento Bande Nere Iniziato....
set t12=Rilevazione crop fotogramma
set t13=a secondi
set t14=Eseguita...
set t15=Larghezza Video 2160p Originale:
set t16=Altezza Video 2160p Originale:
set t17=Larghezza Video 2160p  Senza Barre Nere:
set t18=Altezza Video 2160p  Senza Barre Nere:

set t171=Larghezza Video 1080p  Senza Barre Nere:
set t181=Altezza Video 1080p  Senza Barre Nere:

set t19=Adattamento della Risoluzione del Video al Pieno Formato 1080p..
set t20=Larghezza Finale Video 1080p:
set t21=Altezza Finale Video 1080p:
set t22=Le Impostazioni delle Bande Nere da Tagliare sono Corrette (Si/No):
set t23=Inserimento Manuale Valori Bande Nere da Tagliare.. 
set t24=Inserisci il Valore della Banda Nera Superiore: 
set t25=Errore nell'Inserimento del Valore della Banda Nera Superiore... Non e' un Numero. 
set t26=Inserisci il Valore della Banda Nera Inferiore: 
set t27=Errore nell'Inserimento del Valore della Banda Nera Inferiore... Non e' un Numero. 
set t28=Inserisci il Valore della Banda Nera Sinistra: 
set t29=Errore nell'Inserimento del Valore della Banda Nera Sinistra... Non e' un Numero. 
set t30=Inserisci il Valore della Banda Nera Destra: 
set t31=Errore nell'Inserimento del Valore della Banda Nera Destra... Non e' un Numero. 
set t32=Banda Nera Superiore:
set t33=Banda Nera Inferiore:
set t34=Banda Nera Sinistra:
set t35=Banda Nera Destra:
set t36=Larghezza Video 2160p senza Bande Nere:
set t37=Altezza Video 2160p senza Bande Nere:

set t361=Larghezza Video 1080p senza Bande Nere:
set t371=Altezza Video 1080p senza Bande Nere:

set t38=Selezionare Scheda Grafica con cui Eseguire la Codifica:
set t39=Scegli (1/2):
set t40=Selezionare tipo di Codifica:
set t41=Errore nell'Inserimento del Valore della Quantizzazione... Non e' un Numero. 
set t42=Valore Quantizzazzione Impostato a:
set t43=Parametri per codifica:

set t44=Inserire Valore Quantizzazione Minimo 10 Massimo 28:
set t45=Valore Quantizzazzione al di fuori dei  Limiti  10 / 28  Reinserire^!
set t46=Inserire Valore BitRate kbs Minimo 100 Massimo 50000:
set t47=Errore nell'Inserimento del Valore del BitRate... Non e' un Numero. 
set t48=Valore BitRate Impostato a:
set t49=Valore  BitRate al di fuori dei  Limiti  100 / 50000  Reinserire^!

set t50=Selezionare Qualita' Codifica:
set t51=- Peggiore Qualita'
set t52=- Migliore Qualita'
set t53=Scegli (1/2/3/4/5/6/7):
set t54=Qualita' Impostata su:
set t55=Applicare il denoiser Convolution3D Si/No: 
set t56=Applicare il denoiser PMD Si/No: 
set t57=Applicare il Miglioramento Dettagli Si/No:  
set t58=Miglioramento Dettagli: Si 
set t59=Miglioramento Dettagli: No 
set t60=Informazioni
set t61=Video da Codificare Salvate!
set t62=Vuoi Inserire un altro Video da Codificare (Si/No):
set t63=Il file trascinato non e' un video!
set t64=Scegli (1/2/3/4):
set t65=Premi Invio per tornare al menu' Inserimento Codifiche in Coda e Salvataggio sul Disco:  

set t66=Larghezza Video
set t67=Altezza Video
set t68=Codec Video
set t69=Codec Video Dettagli
set t70=Format Video 
set t71=Configurazione Parametri per convertire il video da 10bit HDR a 8bit SDR
set t72=Selezionare DownGrader Codifica:
set t73=DownGrader Impostato:

goto avvio_InserimentoCodificaHardwareDowngradingPiuDownscalingda2160p10bitHDRa1080p8bitSDR

:avvio_InserimentoCodificaHardwareDowngradingPiuDownscalingda2160p10bitHDRa1080p8bitSDR



set /a "numeromovie=1"


echo !t1!
echo.


:altrivideodainserireNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR


set NomeFile2160ppuliziadettaggli=
rem set MetadatiStreamHDR10=

set /P NomeFile2160ppuliziadettaggli=!t2! !numeromovie! !t211!
rem echo Hai digitato: %NomeFile%
rem pause

set "NomeFileSorgente=!NomeFile2160ppuliziadettaggli:"=!"
@REM echo NomeFileSorgente = !NomeFileSorgente!
set "NomeFile=^"!NomeFileSorgente!^""
@REM echo NomeFile = !NomeFile!
@REM pause


if exist %NomeFile% ( goto infovideo_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR ) else ( 
                                                        echo.
                                                        echo !t3!
                                                        echo.
                                                        goto fineinfovideo_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
                                                        )    



:infovideo_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
echo.
echo !t4!
echo.

.\bin\ffprobe -v error -hide_banner -select_streams v:0 -show_entries stream=width,height,codec_name,codec_long_name,pix_fmt,color_space,color_transfer,color_primaries -of default=noprint_wrappers=1 !NomeFile! > ".\temp\Temp_HDR10_Stream.txt"

set /A x1=1
set /A nohdrcs=0
set /A nohdrct=0
set /A nohdrcp=0
set /A wv=0
set /a hv=0
set /A fv=0

rem echo nohdr = %nohdr%

for /f "tokens=1,2 delims==" %%a in (.\temp\Temp_HDR10_Stream.txt) do (if !x1!==3 ( 
                                                                            echo !t66! "%%a" = %%b  
                                                                            set /A "widthvideo=%%b"
                                                                            @REM echo widthvideo = !widthvideo!
                                                                            if !widthvideo! LEQ 3840 if !widthvideo! GEQ 2000 (set /A "wv=1"
                                                                                                                                @REM echo wv = !wv!
                                                                                                                                )
                                                                            )
                                                                if !x1!==4 ( 
                                                                            echo !t67! "%%a" = %%b  
                                                                            set /A "heightvideo=%%b"
                                                                            @REM echo heightvideo = !heightvideo!
                                                                            if !heightvideo! LEQ 2160 if !heightvideo! GEQ 1400 (set /A "hv=1"
                                                                                                                                @REM echo hv = !hv!
                                                                                                                                )
                                                                            )                                                           
                                                                if !x1!==6 ( 
                                                                            echo Color Space "%%a" = %%b  
                                                                            set "colorsp=%%b"
                                                                            @REM echo colorsp = !colorsp!
                                                                            if !colorsp!==bt2020nc (set /A "nohdrcs=1"
                                                                                                    @REM echo nohdrcs = !nohdrcs!
                                                                                                    )
                                                                            if !colorsp!==unknown (set /A "nohdrcs=1"
                                                                                                    @REM echo nohdrcs = !nohdrcs!
                                                                                                    )
                                                                            if !colorsp!==reserved (set /A "nohdrcs=1"
                                                                                                    @REM echo nohdrcs = !nohdrcs!
                                                                                                    )                    
                                                                            ) 
                                                                if !x1!==7 ( 
                                                                            echo Color Transfer "%%a" = %%b  
                                                                            set "colortr=%%b"
                                                                            @REM echo colortr = !colortr!
                                                                            if !colortr!==smpte2084 (set /A "nohdrct=1"
                                                                                                    @REM echo nohdrct = !nohdrct!
                                                                                                    )
                                                                            ) 
                                                                if !x1!==8 ( 
                                                                            echo Color Primaries "%%a" = %%b  
                                                                            set "colorpr=%%b"
                                                                            @REM echo colorpr = !colorpr!
                                                                            if !colorpr!==bt2020 (set /A "nohdrcp=1"
                                                                                                    @REM echo nohdrcp = !nohdrcp!
                                                                                                    )           
                                                                            )    
                                                                if !x1!==1 ( 
                                                                            echo !t68! "%%a" = %%b  
                                                                            )       
                                                                if !x1!==2 ( 
                                                                            echo !t69! "%%a" = %%b  
                                                                            )   
                                                                if !x1!==5 ( 
                                                                            echo !t70! "%%a" = %%b  
                                                                            set "formatvideo=%%b"
                                                                            @REM echo formatvideo = !formatvideo!
                                                                            if !formatvideo!==yuv420p10le (set /A "fv=1"
                                                                                                            @REM echo fv = !fv!
                                                                                                            )
                                                                            )
                                                                set /A x1+=1                                                            
)
echo.

if !x1!==1 goto :novideofile2160p_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR


if !nohdrcs!==1 if !nohdrct!==1 if !nohdrcp!==1 if !wv!==1 if !hv!==1 if !fv!==1 ( 
                                                                                   echo !t5!
                                                                                   echo. 
                                                                                   goto RilevazioneBandeNere_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR                                                                    
                                                                                   ) 


echo !t6!
echo.
goto fineinfovideo_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

echo.

:RilevazioneBandeNere_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR  


.\bin\ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 !NomeFile!  > ".\temp\durata_film.txt"

set /a contatore=1
for /f "tokens=1 delims=." %%a in (.\temp\durata_film.txt) do  (
                                                        echo. 
                                                        echo !t7! %%a
                                                        set /a "secondi=%%a"
                                                        set /a "minuti=!secondi!/60"
                                                        echo !t8! !minuti!
                                                        set /a "intervallo_tagli=!secondi!/11"
                                                        echo !t9! !intervallo_tagli!!t10!
                                                        echo.
                                                        echo !t11!
                                                        echo.

                                                        

                                                        FOR /L %%a IN (1, 1, 10) DO (
                                                                                    rem echo %%a
                                                                                    set /a "secondi=%%a*!intervallo_tagli!"
                                                                                    rem echo !secondi!

                                                                                    
                                                                                    set /a "ca=72"
                                                                                    rem echo !ca!
                                                                                                                    
                                                                                    set /a "cb=2"
                                                                                    rem echo !cb!
                                                                                                                    
                                                                                    set /a "cc=0"
                                                                                    rem echo !cc!

                                                                                    set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                    rem echo !cr!
        
                                                                                
                                                                                    .\bin\ffmpeg -ss !secondi! -hide_banner -nostats -i %NomeFile% -vframes 10 -vf !cr! -f null - 2> ".\temp\crop.txt"
                                                                                    
                                                                                    findstr /r "Parsed_cropdetect_0" .\temp\crop.txt >> .\temp\risultato_multiplo.txt   
                                                                                    
                                                                                    echo !t12! %%a !t13! !secondi! !t14!
                                                                                    
                                                                                    )       
                                                                                       

                                                                                    for /f "tokens=1,2 delims==" %%a in (.\temp\risultato_multiplo.txt) do ( echo %%b >> .\temp\crop_multiplo.txt )
                                                                                    
                                                                                    set /a "maxfrequenza=0"

                                                                                    for /f "delims=" %%a in (.\temp\crop_multiplo.txt) do ( 
                                                                                                                                    set "cropconfront=%%a"
                                                                                                                                    rem echo "!cropconfront!"
                                                                                                                                    
                                                                                                                                    set /a "contatorfrequenza=0"
                                                                                                                                    for /f "delims=" %%b in (.\temp\crop_multiplo.txt) do (
                                                                                                                                                                                    set "dato_da_verificare=%%b"
                                                                                                                                                                                    rem echo cropconfront = "!cropconfront!"
                                                                                                                                                                                    rem echo dato_da_verificare = "!dato_da_verificare!"
                                                                                                                                                                                    if !cropconfront!==!dato_da_verificare! ( set /a "contatorfrequenza+=1")
                                                                                                                                                                                    )
                                                                                                                                    if !maxfrequenza! LSS !contatorfrequenza! ( 
                                                                                                                                                                                set /a "maxfrequenza=!contatorfrequenza!"
                                                                                                                                                                                set "cropd=!cropconfront!"
                                                                                                                                                                                )
                                                                                                                                    

                                                                                                                                    rem if !cropconfront! in (elenco_crop_frequenza.txt) ()
                                                                                                                                    rem echo !cropconfront!:!contatorfrequenza! >> elenco_crop_frequenza.txt

                                                                                                                                    )

                                                                                    rem echo crop piu' frequente = !cropd! con grequenza = !maxfrequenza!
                                                                                    echo !cropd! > .\temp\crop_finale.txt

                                                                                    for /f "tokens=1,2,3,4 delims=:" %%a in (.\temp\crop_finale.txt) do  ( 
                                                                                                                                                    rem set /a "mwidth=%%a"
                                                                                                                                                    rem echo mwidth = !mwidth!

                                                                                                                                                    rem set /a "mheight=%%b"
                                                                                                                                                    rem echo mheight = !mheight!

                                                                                                                                                    rem set /a "mx=%%c"
                                                                                                                                                    rem echo mx = !mx!

                                                                                                                                                    rem set /a "my=%%d"
                                                                                                                                                    rem echo my = !my!

                                                                                                                                                    if !contatore!==1 ( 
                                                                                                                                                                set /a "wmax=%%a" 
                                                                                                                                                                set /a "hmax=%%b"
                                                                                                                                                                set /a "xmin=%%c"
                                                                                                                                                                set /a "ymin=%%d"
                                                                                                                                                                set /a "mwidth=%%a"
                                                                                                                                                                set /a "mheight=%%b"
                                                                                                                                                                set /a "mx=%%c"
                                                                                                                                                                set /a "my=%%d"
                                                                                                                                                                set /a "contatore+=1"
                                                                                                                                                                )
                                                                                                                                                    
                                                                                                                                                    rem if %%b gtr !hmax! if %%c gtr !xmin! if %%d gtr !ymin! 

                                                                                                                                                    if %%a geq !wmax! if %%b geq !hmax! ( 
                                                                                                                                                                        set /a "wmax=%%a" 
                                                                                                                                                                        set /a "hmax=%%b"
                                                                                                                                                                        set /a "xmin=%%c"
                                                                                                                                                                        set /a "ymin=%%d"
                                                                                                                                                                        set /a "mwidth=%%a"
                                                                                                                                                                        set /a "mheight=%%b"
                                                                                                                                                                        set /a "mx=%%c"
                                                                                                                                                                        set /a "my=%%d"
                                                                                                                                                                        )
                                                                                                                                                    )
                                                                                    echo.
                                                                                    set /a "csup=!my!"
                                                                                    rem echo csup = !csup!
                                                                                                                                    
                                                                                    set /a "csin=!mx!"
                                                                                    rem echo csin = !csin!

                                                                                    set /a "cinf=!heightvideo!-!mheight!-!my!"
                                                                                    rem echo movieheightreal = !movieheightreal!
                                                                                    rem echo cinf = !cinf!
                                                                                    set /a "cdes=!widthvideo!-!mwidth!-!mx!"
                                                                                    rem echo cdes = !cdes!

                                                                                    echo !t15! !widthvideo!  
                                                                                    echo !t16! !heightvideo!  
                                                                                    echo.

                                                                                    echo Crop Settings: --crop !csin!,!csup!,!cdes!,!cinf!  
                                                                                    set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"  
                                                                                    echo.  

                                                                                    set /a "height4kcrop=(!heightvideo!-!csup!-!cinf!)/2*2"
                                                                                    set /a "width4kcrop=(!widthvideo!-!csin!-!cdes!)/2*2"

                                                                                    echo !t17! !width4kcrop!  
                                                                                    echo !t18! !height4kcrop!  
                                                                                    echo.

                                                                                    set /a "height1080p=!height4kcrop!/4*2"
                                                                                    set /a "width1080p=!width4kcrop!/4*2"
                                                                                    
                                                                                    echo !t171! !width1080p!  
                                                                                    echo !t181! !height1080p!  
                                                                                    echo.


                                                                                    set /a "larghezza1080pnvenc=1920"
                                                                                    set /a "altezza1080pnvenc=1080"
                                                                                    @REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
                                                                                    @REM echo altezza1080pnvenc = !altezza1080pnvenc!                                    

                                                                                    set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!width1080p!"
                                                                                    set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!height1080p!"
                                                                                    @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
                                                                                    @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

                                                                                    if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                                                                                                        @REM echo dentro il 1o if
                                                                                                                                                                        set /a "width2k=!width1080p!"
                                                                                                                                                                        set /a "height2k=!height1080p!"
                                                                                                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                                                                                                set /a "width2k=!width1080p!"
                                                                                                                                                                                                                                                                set /a "height2k=!height1080p!"
                                                                                                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo width1080p = !width1080p!
                                                                                                                                                                                                                                                                                                                                                        @REM echo height1080p = !height1080p!
                                                                                                                                                                                                                                                                                                                                                        set /a "width2k=!width1080p!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        set /a "height2k=!height1080p!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "width2k=!width1080p!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "height2k=!height1080p!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                                                                                                                set /a "width2k=!width1080p!"
                                                                                                                                                                                                                                                                set /a "height2k=!height1080p!"
                                                                                                                                                                                                                                                                )
                                                                                                                                                                        
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                                                                                                        set /a "width2k=!width1080p!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        set /a "height2k=!height1080p!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.                         

                                                                                        echo !t20!  !width2k! 
                                                                                        echo !t21!  !height2k!    
                                                                                        echo.

                                                                                        @REM set /a "width4k=width2k*2"
                                                                                        @REM set /a "height4k=height2k*2"

                                                                                        @REM echo Larghezza Finale Video 2160p:  !width4k! 
                                                                                        @REM echo Altezza Finale Video 2160p:  !height4k!    
                                                                                        @REM echo.
                                                                                    )

                                                                                    
                                                        )                          

:iniziocropdowngradeDownScale_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set /a "csup=0"
set /a "cinf=0"
set /a "csin=0"
set /a "cdes=0"
set /a "bandasuperiore=0"
set /a "bandainferiore=0"
set /a "bandasinistra=0"
set /a "bandadestra=0"
set /a "differenzialelarghezza1080pnvenc=0"
set /a "differenzialealtezza1080pnvenc=0"
if exist ".\temp\Temp_HDR10_Stream.txt" ( del ".\temp\Temp_HDR10_Stream.txt" ) 
if exist ".\temp\durata_film.txt" ( del ".\temp\durata_film.txt" )
if exist ".\temp\crop.txt" ( del ".\temp\crop.txt" )
if exist ".\temp\risultato_multiplo.txt" ( del ".\temp\risultato_multiplo.txt" )
if exist ".\temp\crop_multiplo.txt" ( del ".\temp\crop_multiplo.txt" )
if exist ".\temp\crop_finale.txt" ( del ".\temp\crop_finale.txt" )

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t22!"   
    if errorlevel 2 goto cropmanualeNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
    if errorlevel 1 goto finecropNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
)

CHOICE /N /C:SN /M "!t22!"   

if errorlevel 2 goto cropmanualeNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if errorlevel 1 goto finecropNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR


:cropmanualeNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
echo.
echo !t23!
echo.

:banda_superiore_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set /p "bandasuperiore=!t24!"
SET "var="&for /f "delims=0123456789" %%i in ("!bandasuperiore!") do set var=!bandasuperiore!
if defined var (
                echo.
                echo !t25!
                echo.
                goto banda_superiore_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
                ) else (
                        set /a "csup=!bandasuperiore!/2*2"
                        )

echo.
:banda_inferiore_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set /p "bandainferiore=!t26!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandainferiore!") do set var=!bandainferiore!
if defined var (
                echo.
                echo !t27!
                echo.
                goto banda_inferiore_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
                ) else (
                        set /a "cinf=!bandainferiore!/2*2"
                        )


echo.
:banda_sinistra_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set /p "bandasinistra=!t28!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandasinistra!") do set var=!bandasinistra!
if defined var (
                echo.
                echo !t29!
                echo.
                goto banda_sinistra_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
                ) else (
                        set /a "csin=!bandasinistra!/2*2"
                        )

                        
echo.
:banda_destra_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set /p "bandadestra=!t30!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandadestra!") do set var=!bandadestra!
if defined var (
                echo.
                echo !t31!
                echo.
                goto banda_destra_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
                ) else (
                        set /a "cdes=!bandadestra!/2*2"
                        )


set /a "larghezza1080pnvenc=3840"
set /a "altezza1080pnvenc=2160"
@REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
@REM echo altezza1080pnvenc = !altezza1080pnvenc!                                    

set /a "mwidth=!widthvideo!/2*2"
set /a "mheight=!heightvideo!/2*2"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "mwidthc=!mwidth!-!csin!-!cdes!"
set /a "mheightc=!mheight!-!csup!-!cinf!"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!mwidthc!"
set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!mheightc!"
@REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
@REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

echo.
echo !t32!  !csup! 
echo !t33!  !cinf! 
echo !t34!  !csin! 
echo !t35!  !cdes! 
echo.


set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
echo Crop Settings: !cropff!
echo.

echo !t36!  !mwidthc! 
echo !t37!  !mheightc! 
echo.

set /a "mwidthc1080p=!mwidthc!/2"
set /a "mheightc1080p=!mheightc!/2"

echo !t361!  !mwidthc1080p! 
echo !t371!  !mheightc1080p! 
echo.


if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                        @REM echo dentro il 1o if
                                                                                        set /a "width2k=!mwidthc!"
                                                                                        set /a "height2k=!mheightc!"
                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                set /a "width2k=!mwidthc!"
                                                                                                                                                                                set /a "height2k=!mheightc!"
                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                        set /a "width2k=!mwidthc!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                        set /a "height2k=!mheightc!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                set /a "width2k=!mwidthc!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                set /a "height2k=!mheightc!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                )
                                                                                        if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                        set /a "width2k=!mwidthc!"
                                                                                                                                                                        set /a "height2k=!mheightc!"
                                                                                                                                                                        )
                                                                                                                                                                        
                                                                                        if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                set /a "width2k=!mwidthc!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                set /a "height2k=!mheightc!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.                         

                                                                                        @REM echo Larghezza Finale Video 2160p:  !width2k! 
                                                                                        @REM echo Altezza Finale Video 2160p:  !height2k!    
                                                                                        @REM echo.

                                                                                        set /a "width2k=width2k/4*2"
                                                                                        set /a "height2k=height2k/4*2"

                                                                                        echo !t20!  !width2k! 
                                                                                        echo !t21!  !height2k!    
                                                                                        echo.

                                                                                        @REM set /a "width4k=width2k*2"
                                                                                        @REM set /a "height4k=height2k*2"

                                                                                        @REM echo Larghezza Finale Video 2160p:  !width4k! 
                                                                                        @REM echo Altezza Finale Video 2160p:  !height4k!    
                                                                                        @REM echo.
                                                                                    ) 

goto iniziocropdowngradeDownScale_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:finecropNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

rem///////////////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////////////



echo.
echo !t38!
echo.
echo 1) NVidia 
echo 2) Intel 
echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto ChoosenIntel_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if errorlevel 1 goto ChoosenNVidia_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:ChoosenIntel_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "SchedaGrafica=Intel"
@REM echo SchedaGrafica = !SchedaGrafica!
goto fineSceltaSchedaGrafica_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:ChoosenNVidia_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "SchedaGrafica=NVidia"
@REM echo SchedaGrafica = !SchedaGrafica!

:fineSceltaSchedaGrafica_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

@REM pause 

if !SchedaGrafica!==NVidia (
                                goto InserimentoImpostazioniNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
                                ) 





if !SchedaGrafica!==Intel (
                                goto InserimentoImpostazioniQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
                                 )


@REM pause 




rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


:InserimentoImpostazioniNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR


echo.
echo !t40!
echo.
echo 1) CQP 
echo 2) VBR 
echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto CodificaVBRNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if errorlevel 1 goto CodificaCQPNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:CodificaVBRNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "TipoCodificaNVEnc=--vbr "
set /a "quantizzazioneNVEnc=0"
goto inserimentoValoriCQPVBRNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:CodificaCQPNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "TipoCodificaNVEnc=--cqp "
set /a "quantizzazioneNVEnc=1"

:inserimentoValoriCQPVBRNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

if !quantizzazioneNVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneNVEnc=!t44! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneNVEnc!") do set var=!valoreQuantizzazioneNVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                echo.
                                                goto inserimentoValoriCQPVBRNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
                                                ) 

                                set /a "valoreQuantizzazioneNVEnc=!valoreQuantizzazioneNVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneNVEnc!
                                if !valoreQuantizzazioneNVEnc! GEQ 10 if !valoreQuantizzazioneNVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneNVEnc!
                                                                                                                set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreQuantizzazioneNVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                                goto fineQuantizzazioneNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
                                                                                                                        
                                )



if !quantizzazioneNVEnc!==0 (
                                echo.
                                set /p "valoreBitRateNVEnc=!t46! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateNVEnc!") do set var=!valoreBitRateNVEnc!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                echo.
                                                goto inserimentoValoriCQPVBRNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
                                                ) 
                                set /a "valoreBitRateNVEnc=!valoreBitRateNVEnc!"
                                @REM echo valoreBitRateNVEnc = !valoreBitRateNVEnc!
                                if !valoreBitRateNVEnc! GEQ 100 if !valoreBitRateNVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateNVEnc!
                                                                                                        set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreBitRateNVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                        goto fineQuantizzazioneNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
                                                                                                              
                                )


:fineQuantizzazioneNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR



echo.
echo !t50!
echo.
echo 1) P1 !t51!
echo 2) P2 
echo 3) P3 
echo 4) P4 
echo 5) P5 
echo 6) P6 
echo 7) P7 !t52!
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto P7NVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if errorlevel 6 goto P6NVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if errorlevel 5 goto P5NVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if errorlevel 4 goto P4NVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if errorlevel 3 goto P3NVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if errorlevel 2 goto P2NVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if errorlevel 1 goto P1NVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR


:P7NVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "SettaggioQualitaNVEnc=--preset P7"
set "QualitySetting=P7"
goto fineQualitCodificaNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:P6NVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "SettaggioQualitaNVEnc=--preset P6"
set "QualitySetting=P6"
goto fineQualitCodificaNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:P5NVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "SettaggioQualitaNVEnc=--preset P5"
set "QualitySetting=P5"
goto fineQualitCodificaNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:P4NVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "SettaggioQualitaNVEnc=--preset P4"
set "QualitySetting=P4"
goto fineQualitCodificaNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:P3NVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "SettaggioQualitaNVEnc=--preset P3"
set "QualitySetting=P3"
goto fineQualitCodificaNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:P2NVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "SettaggioQualitaNVEnc=--preset P2"
set "QualitySetting=P2"
goto fineQualitCodificaNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:P1NVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "SettaggioQualitaNVEnc=--preset P1"
set "QualitySetting=P1"
goto fineQualitCodificaNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR


:fineQualitCodificaNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaNVEnc!


echo.
echo !t71!
echo !t72!
echo.
echo 1) NVEnc Color Correction 
echo 2) LibPlacebo Color Correction 

echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto LibPlaceboColorNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if errorlevel 1 goto NVEncColorCorrection_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:NVEncColorCorrection_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "NVEncColorCorrectionSystem=--vpp-colorspace hdr2sdr=hable,source_peak=1000,ldr_nits=100,a=0.22,b=0.3,c=0.1,d=0.2,e=0.01,f=0.3"
set "NVEncUpgrader=NVEnc Color Correction"
goto NVEncFineSelezioneUpGrader_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:LibPlaceboColorNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "NVEncColorCorrectionSystem=--vpp-libplacebo-tonemapping src_csp=dovi,dst_csp=sdr"
set "NVEncUpgrader=LibPlacebo Color Correction"

:NVEncFineSelezioneUpGrader_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
echo.
echo !t73! !NVEncUpgrader!
echo.
echo !t43! !NVEncColorCorrectionSystem!


:sceltadenoiser
set conv3d1080p=
set pmd1080p=

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t55!"
    if errorlevel 2 goto conv3dChoosenNoNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
    if errorlevel 1 goto conv3dChoosenYesNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
)

echo.
CHOICE /N /C:SN /M "!t55!"

if errorlevel 2 goto conv3dChoosenNoNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if errorlevel 1 goto conv3dChoosenYesNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:conv3dChoosenNoNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "conv3d1080p=N"
goto sceltaDeniserPMDNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:conv3dChoosenYesNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "conv3d1080p=S"



:sceltaDeniserPMDNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t56!"
    if errorlevel 2 goto PMDChoosenNoNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
    if errorlevel 1 goto PMDChoosenYesNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
)

echo.
CHOICE /N /C:SN /M "!t56!"

if errorlevel 2 goto PMDChoosenNoNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if errorlevel 1 goto PMDChoosenYesNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:PMDChoosenNoNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "pmd1080p=N"
goto assegnazioneDenoisesNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:PMDChoosenYesNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "pmd1080p=S"


:assegnazioneDenoisesNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set /A nvdenv=0

if !conv3d1080p!==S if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00 --vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==S if !pmd1080p!==N ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==N ( 
                                        set "nvdenoiser=nessuno" 
                                        set "nvdenv=1"
                                        set "unicopassaggio=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: Nessun Denoiser 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )

@REM pause

echo.
if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t57!"
    if errorlevel 2 goto ApplicaMiglioramentoDettagliNVEncNo_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
    if errorlevel 1 goto ApplicaMiglioramentoDettagliNVEncSi_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
)
CHOICE /N /C:SN /M "!t57!"

if errorlevel 2 goto ApplicaMiglioramentoDettagliNVEncNo_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if errorlevel 1 goto ApplicaMiglioramentoDettagliNVEncSi_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:ApplicaMiglioramentoDettagliNVEncNo_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "miglioramento1080p=N"
goto fineSceltaMigliaramentiNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:ApplicaMiglioramentoDettagliNVEncSi_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "miglioramento1080p=S"

:fineSceltaMigliaramentiNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if !miglioramento1080p!==S ( 
                                set "edgeleveling=--vpp-edgelevel strength=10.0,threshold=24.0,black=6,white=0" 
                                echo.
                                echo NVEnc !t58!
                                echo.
                                )
if !miglioramento1080p!==N ( 
                                set "edgeleveling=nessuno" 
                                echo.
                                echo NVEnc !t59!
                                echo.
                                )


@REM pause


set file_senza_virgolette=!NomeFile:"=!
rem echo !file_senza_virgolette!

set file_senza_estensione=!file_senza_virgolette:.mkv=!
rem echo %file_senza_estensione%

set fileoutput2160p="!file_senza_estensione!_DownGraded_DownScaled_1080p_8bit_SDR.mkv"
rem echo fileoutput2160p = %fileoutput2160p%

echo.
set "VideoInfoCodifica=NVEnc_DownGraded_DownScaled_da_2160p_10bit_HDR_a_1080p_8bit_SDR|!NomeFile!|!fileoutput2160p!|nessuno|!cropff!|!width2k!x!height2k!|nessuna|nessuno|!colorpr!|!colortr!|!colorsp!|!tipoQuantizzazioneNVEnc!|!SettaggioQualitaNVEnc!|nessuno|nessuno|!nvdenoiser!|!formatvideo!|!edgeleveling!|!NVEncColorCorrectionSystem!|no_numero_passaggi_upscaling|no_lokahead|no_precisione_vettore_movimento"
@REM echo VideoInfoCodifica = !VideoInfoCodifica!
@REM echo.

if exist ".\saved\savedmoviesallencodings.dat" ( 
                                                echo !VideoInfoCodifica! >> .\saved\savedmoviesallencodings.dat
                                                goto finesalvataggioInserimentoNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
                                                ) 

echo !VideoInfoCodifica! > .\saved\savedmoviesallencodings.dat


:finesalvataggioInserimentoNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

echo !t60! !numeromovie! !t61!
echo.

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t62!"
    if errorlevel 2 goto finesceltanuovovideodacodificareNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
    if errorlevel 1 goto altrivideodainserireMenuNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
)

CHOICE /N /C:SN /M "!t62!"
echo.

if errorlevel 2 goto finesceltanuovovideodacodificareNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if errorlevel 1 goto altrivideodainserireMenuNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:altrivideodainserireMenuNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set /a "numeromovie+=1"
echo.
goto altrivideodainserireNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:finesceltanuovovideodacodificareNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
echo.
goto fineinfovideo_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR


rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////






rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


:InserimentoImpostazioniQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR


echo.
echo !t40!
echo.
echo 1) CQP 
echo 2) ICQ 
echo 3) LA-ICQ 
echo 4) VBR 
echo.
CHOICE /N /C:1234 /M "!t64!"

if errorlevel 4 goto CodificaVBRQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if errorlevel 3 goto CodificaLAICQQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if errorlevel 2 goto CodificaICQQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if errorlevel 1 goto CodificaCQPQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR


:CodificaCQPQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "TipoCodificaQSVEnc=--cqp "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:CodificaICQQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "TipoCodificaQSVEnc=--icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:CodificaLAICQQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "TipoCodificaQSVEnc=--la-icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:CodificaVBRQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "TipoCodificaQSVEnc=--vbr "
set /a "quantizzazioneQSVEnc=0"
goto inserimentoValoriCQPVBRQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR


:inserimentoValoriCQPVBRQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

if !quantizzazioneQSVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneQSVEnc=!t44! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneQSVEnc!") do set var=!valoreQuantizzazioneQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                echo.
                                                goto inserimentoValoriCQPVBRQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
                                                ) 

                                set /a "valoreQuantizzazioneQSVEnc=!valoreQuantizzazioneQSVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneQSVEnc!
                                if !valoreQuantizzazioneQSVEnc! GEQ 10 if !valoreQuantizzazioneQSVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneQSVEnc!
                                                                                                                set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreQuantizzazioneQSVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                                goto fineQuantizzazioneQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
                                                                                                                        
                                )



if !quantizzazioneQSVEnc!==0 (
                                echo.
                                set /p "valoreBitRateQSVEnc=!t46! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateQSVEnc!") do set var=!valoreBitRateQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t4!7!
                                                echo.
                                                goto inserimentoValoriCQPVBRQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
                                                ) 
                                set /a "valoreBitRateQSVEnc=!valoreBitRateQSVEnc!"
                                @REM echo valoreBitRateQSVEnc = !valoreBitRateQSVEnc!
                                if !valoreBitRateQSVEnc! GEQ 100 if !valoreBitRateQSVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateQSVEnc!
                                                                                                        set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreBitRateQSVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                        goto fineQuantizzazioneQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
                                                                                                              
                                )


:fineQuantizzazioneQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR



echo.
echo !t50!
echo.
echo 1) Best 
echo 2) Higher 
echo 3) High 
echo 4) Balanced 
echo 5) Fast 
echo 6) Faster 
echo 7) Fastest 
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto QualitFastestQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if errorlevel 6 goto QualitFasterQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if errorlevel 5 goto QualitFastQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if errorlevel 4 goto QualitBalancedtQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if errorlevel 3 goto QualitHighQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if errorlevel 2 goto QualitHigherQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if errorlevel 1 goto QualitBestQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR


:QualitBestQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "SettaggioQualitaQSvenc=--quality best"
set "QualitySetting=best"
goto fineQualitCodificaQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:QualitHigherQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "SettaggioQualitaQSvenc=--quality higher"
set "QualitySetting=higher"
goto fineQualitCodificaQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:QualitHighQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "SettaggioQualitaQSvenc=--quality high"
set "QualitySetting=high"
goto fineQualitCodificaQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:QualitBalancedtQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "SettaggioQualitaQSvenc=--quality balanced"
set "QualitySetting=balanced"
goto fineQualitCodificaQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:QualitFastQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "SettaggioQualitaQSvenc=--quality fast"
set "QualitySetting=fast"
goto fineQualitCodificaQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:QualitFasterQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "SettaggioQualitaQSvenc=--quality faster"
set "QualitySetting=faster"
goto fineQualitCodificaQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:QualitFastestQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "SettaggioQualitaQSvenc=--quality fastest"
set "QualitySetting=fastest"
goto fineQualitCodificaQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR


:fineQualitCodificaQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaQSvenc!


echo.
echo !t71!
echo !t72!
echo.
echo 1) QSVEnc Color Correction 
echo 2) LibPlacebo Color Correction 

echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto LibPlaceboQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if errorlevel 1 goto QSVEncColorCorrection_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:QSVEncColorCorrection_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "QSVEncColorCorrectionSystem=--vpp-colorspace hdr2sdr=hable,source_peak=1000,ldr_nits=100,a=0.22,b=0.3,c=0.1,d=0.2,e=0.01,f=0.3"
set "QSVEncUpgrader=QSVEnc Color Correction"
goto QSVEncFineSelezioneUpGrader_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:LibPlaceboQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "QSVEncColorCorrectionSystem=--vpp-libplacebo-tonemapping src_csp=dovi,dst_csp=sdr"
set "QSVEncUpgrader=LibPlacebo Color Correction"

:QSVEncFineSelezioneUpGrader_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
echo.
echo !t73! !QSVEncUpgrader!
echo.
echo !t43! !QSVEncColorCorrectionSystem!



:sceltadenoiser
set conv3d1080p=
set pmd1080p=

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t55!"
    if errorlevel 2 goto conv3dChoosenNoQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
    if errorlevel 1 goto conv3dChoosenYesQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
)
echo.
CHOICE /N /C:SN /M "!t55!"

if errorlevel 2 goto conv3dChoosenNoQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if errorlevel 1 goto conv3dChoosenYesQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:conv3dChoosenNoQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "conv3d1080p=N"
goto sceltaDeniserPMDQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:conv3dChoosenYesQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "conv3d1080p=S"



:sceltaDeniserPMDQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t56!"
    if errorlevel 2 goto PMDChoosenNoQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
    if errorlevel 1 goto PMDChoosenYesQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
)
echo.
CHOICE /N /C:SN /M "!t56!"

if errorlevel 2 goto PMDChoosenNoQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if errorlevel 1 goto PMDChoosenYesQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:PMDChoosenNoQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "pmd1080p=N"
goto assegnazioneDenoisesQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:PMDChoosenYesQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "pmd1080p=S"


:assegnazioneDenoisesQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set /A nvdenv=0

if !conv3d1080p!==S if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00 --vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==S if !pmd1080p!==N ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==N ( 
                                        set "nvdenoiser=nessuno" 
                                        set "nvdenv=1"
                                        set "unicopassaggio=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: Nessun Denoiser 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )

@REM pause


if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t57!"
    if errorlevel 2 goto ApplicaMiglioramentoDettagliQSVEncNo_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
    if errorlevel 1 goto ApplicaMiglioramentoDettagliQSVEncSi_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
)

echo.
CHOICE /N /C:SN /M "!t57!"

if errorlevel 2 goto ApplicaMiglioramentoDettagliQSVEncNo_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if errorlevel 1 goto ApplicaMiglioramentoDettagliQSVEncSi_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:ApplicaMiglioramentoDettagliQSVEncNo_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "miglioramento1080p=N"
goto fineSceltaMigliaramentiQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:ApplicaMiglioramentoDettagliQSVEncSi_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set "miglioramento1080p=S"

:fineSceltaMigliaramentiQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if !miglioramento1080p!==S ( 
                                set "edgeleveling=--vpp-edgelevel strength=10.0,threshold=24.0,black=6,white=0" 
                                echo.
                                echo QSVEnc !t58!
                                echo.
                                )
if !miglioramento1080p!==N ( 
                                set "edgeleveling=nessuno" 
                                echo.
                                echo QSVEnc !t59!
                                echo.
                                )


@REM pause


set file_senza_virgolette=!NomeFile:"=!
rem echo !file_senza_virgolette!

set file_senza_estensione=!file_senza_virgolette:.mkv=!
rem echo %file_senza_estensione%

set fileoutput2160p="!file_senza_estensione!_DownGraded_DownScaled_1080p_8bit_SDR.mkv"
rem echo fileoutput2160p = %fileoutput2160p%

echo.
set "VideoInfoCodifica=QSVEnc_DownGraded_DownScaled_da_2160p_10bit_HDR_a_1080p_8bit_SDR|!NomeFile!|!fileoutput2160p!|nessuno|!cropff!|!width2k!x!height2k!|nessuna|nessuno|!colorpr!|!colortr!|!colorsp!|!tipoQuantizzazioneQSVEnc!|!SettaggioQualitaQSVEnc!|nessuno|nessuno|!nvdenoiser!|!formatvideo!|!edgeleveling!|!QSVEncColorCorrectionSystem!|no_numero_passaggi_upscaling|no_lokahead|no_precisione_vettore_movimento"
@REM echo VideoInfoCodifica = !VideoInfoCodifica!
@REM echo.

if exist ".\saved\savedmoviesallencodings.dat" ( 
                                                echo !VideoInfoCodifica! >> .\saved\savedmoviesallencodings.dat
                                                goto finesalvataggioInserimentoQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
                                                ) 

echo !VideoInfoCodifica! > .\saved\savedmoviesallencodings.dat


:finesalvataggioInserimentoQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

echo !t60! !numeromovie! !t61!
echo.

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t62!"
    if errorlevel 2 goto finesceltanuovovideodacodificareQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
    if errorlevel 1 goto altrivideodainserireMenuQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
) 

CHOICE /N /C:SN /M "!t62!"
echo.

if errorlevel 2 goto finesceltanuovovideodacodificareQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
if errorlevel 1 goto altrivideodainserireMenuQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:altrivideodainserireMenuQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
set /a "numeromovie+=1"
echo.
goto altrivideodainserireNVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR

:finesceltanuovovideodacodificareQSVEnc_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
echo.
goto fineinfovideo_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR


rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////





goto fineinfovideo_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR




:novideofile2160p_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR
echo !t63!
echo.


:fineinfovideo_InserimentoDownGradingDownScalingda2160p10bitHDRa1080p8bitSDR


if exist ".\temp\Temp_HDR10_Stream.txt" ( del .\temp\Temp_HDR10_Stream.txt )
if exist ".\temp\durata_film.txt" ( del .\temp\durata_film.txt )
if exist ".\temp\crop.txt" ( del .\temp\crop.txt )
if exist ".\temp\risultato_multiplo.txt" ( del .\temp\risultato_multiplo.txt )
if exist ".\temp\crop_multiplo.txt" ( del .\temp\crop_multiplo.txt )
if exist ".\temp\crop_finale.txt" ( del .\temp\crop_finale.txt )
      




set waitenter=
set /P waitenter=!t65!
Endlocal
goto InserimentoCodifcaInCodaeSalvataggioSuDisco















rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:InserimentoCodificaHardwareDowngradingda2160p1080p10bitHDR10a8bitSDR

cls
setLocal EnableExtensions EnableDelayedExpansion


for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoInserimentoCodificaHardwareDowngradingda2160p1080p10bitHDR10a8bitSDR
)

if %lingua%==inglese (
    goto caricalinguaingleseInserimentoCodificaHardwareDowngradingda2160p1080p10bitHDR10a8bitSDR
)



:caricalinguaingleseInserimentoCodificaHardwareDowngradingda2160p1080p10bitHDR10a8bitSDR
set t1=Insert Hardware Video Encoding Info DownGrading from 2160p or 1080p 10 bit HDR to 8 bit SDR and Saving to Disk

set t2=Drag Here the
set t211=Video File 2160p or 1080p 10 bit HDR to Convert to 8 bit SDR:  

set t3=File does not exist 
set t4=Info Video:  
set t5=The Inserted Video is
set t6=The Inserted Video isn't
set t7=Video Duration in seconds:
set t8=Video Duration in Minutes:
set t9=Interval between Frames for Crop Detection:
set t10= seconds
set t11=Black Bands Detection Started....
set t12=Crop Detection to Frame
set t13=to seconds
set t14=Done...
set t15=Input Video Width 
set t16=Input Video Height
set t17=Output Video Width Without Black Bars
set t18=Outout Video Height Without Black Bars
set t19=Adapting Video Resolution to Full Format
set t20=Final Output Video Width
set t21=Final Output Video Height
set t22=Settings of Black Bands to Crop are Correct (Yes/No):
set t23=Manually Entering Black Band Values to Crop... 
set t24=Enter the Upper Black Band Value: 
set t25=Error Entering Upper Black Band Value... It's Not a Number. 
set t26=Enter the Lower Black Band Value: 
set t27=Error Entering Lower Black Band Value... It's Not a Number.
set t28=Enter the Left Black Band Value: 
set t29=Error Entering Left Black Band Value... It's Not a Number.
set t30=Enter the Right Black Band Value: 
set t31=Error Entering Right Black Band Value... It's Not a Number.
set t32=Upper Black Band:
set t33=Lower Black Band:
set t34=Left Black Band:
set t35=Right Black Band:
set t36=Original Video Width Without Black Bars
set t37=Original Video Height Without Black Bars
set t38=Select Graphic Card you want to Encode with:
set t39=Choose (1/2):
set t40=Select Encoding Type:
set t41=Error Entering Quantization Value... Not a Number. 
set t42=Quantization Value Set to:
set t43=Encoding Settings:
set t44=Enter Quantization value Minimum 10 Maximum 28:
set t45=Quantization Value Out of  Limits  10 / 28  Re-enter^!
set t46=Enter BitRate Value kbs Minimum 100 Maximum 50000:
set t47=Error Entering BitRate Value... It's Not a Number. 
set t48=BitRate Value Set to:
set t49=BitRate Value Out of Limits  100 / 50000  Re-enter^!
set t50=Select Encoding Quality:
set t51=- Worst Quality
set t52=- Best Quality
set t53=Choose (1/2/3/4/5/6/7):
set t54=Quality Set to:
set t55=Apply Convolution3D denoiser Yes/No: 
set t56=Apply PMD denoiser Yes/No: 
set t57=Apply Detail Enhancement Yes/No:  
set t58=Enhancement Detail: Yes 
set t59=Enhancement Detail: No 
set t60=Info
set t61=Videos to Encode Saved!
set t62=Do You Want to Insert Another Video to Encode (Yes/No):
set t63=The dragged file is not a video!
set t64=Choose (1/2/3/4):
set t65=Press Enter toback to Menu Inserting Encoding into the Queue and Saving to Disk:  

set t66=Video Width
set t67=Video Height
set t68=Video Codec
set t69=Details Video Codec
set t70=Video Format 
set t71=Configuration Settings to convert video from 10bit HDR to 8bit SDR
set t72=Select Encoding DownGrader:
set t73=Settings DownGrader:

goto avvio_InserimentoCodificaHardwareDowngradingda2160p1080p10bitHDR10a8bitSDR




:caricalinguaitalianoInserimentoCodificaHardwareDowngradingda2160p1080p10bitHDR10a8bitSDR
set t1=Inserimento Info Codifica Hardware Video DownGrading da 2160p o 1080p 10 bit HDR a 8 bit SDR e Salvataggio su Disco.

set t2=Trascina Qui il
set t211=File Video 2160p o 1080p 10 bit HDR da Convertire a 8 bit SDR:  

set t3=File Inesistente 
set t4=Informazioni Video:  
set t5=Il Video inserito e'
set t6=Il Video inserito non e'
set t7=Durata del Video in secondi:
set t8=Durata del video in Minuti:
set t9=Intervallo tra i Fotogrammi per il Rilevamento del crop:
set t10= secondi
set t11=Rilevamento Bande Nere Iniziato....
set t12=Rilevazione crop fotogramma
set t13=a secondi
set t14=Eseguita...
set t15=Larghezza Video di Input 
set t16=Altezza Video di Input
set t17=Larghezza Video di Input Senza Barre Nere
set t18=Altezza Video di Input Senza Barre Nere
set t19=Adattamento della Risoluzione del Video al Pieno Formato
set t20=Larghezza Finale Video di Output
set t21=Altezza Finale Video di Output
set t22=Le Impostazioni delle Bande Nere da Tagliare sono Corrette (Si/No):
set t23=Inserimento Manuale Valori Bande Nere da Tagliare.. 
set t24=Inserisci il Valore della Banda Nera Superiore: 
set t25=Errore nell'Inserimento del Valore della Banda Nera Superiore... Non e' un Numero. 
set t26=Inserisci il Valore della Banda Nera Inferiore: 
set t27=Errore nell'Inserimento del Valore della Banda Nera Inferiore... Non e' un Numero. 
set t28=Inserisci il Valore della Banda Nera Sinistra: 
set t29=Errore nell'Inserimento del Valore della Banda Nera Sinistra... Non e' un Numero. 
set t30=Inserisci il Valore della Banda Nera Destra: 
set t31=Errore nell'Inserimento del Valore della Banda Nera Destra... Non e' un Numero. 
set t32=Banda Nera Superiore:
set t33=Banda Nera Inferiore:
set t34=Banda Nera Sinistra:
set t35=Banda Nera Destra:
set t36=Larghezza Video Originale Senza Barre Nere
set t37=Altezza Video Originale Senza Barre Nere
set t38=Selezionare Scheda Grafica con cui Eseguire la Codifica:
set t39=Scegli (1/2):
set t40=Selezionare tipo di Codifica:
set t41=Errore nell'Inserimento del Valore della Quantizzazione... Non e' un Numero. 
set t42=Valore Quantizzazzione Impostato a:
set t43=Parametri per codifica:
set t44=Inserire Valore Quantizzazione Minimo 10 Massimo 28:
set t45=Valore Quantizzazzione al di fuori dei  Limiti  10 / 28  Reinserire^!
set t46=Inserire Valore BitRate kbs Minimo 100 Massimo 50000:
set t47=Errore nell'Inserimento del Valore del BitRate... Non e' un Numero. 
set t48=Valore BitRate Impostato a:
set t49=Valore  BitRate al di fuori dei  Limiti  100 / 50000  Reinserire^!
set t50=Selezionare Qualita' Codifica:
set t51=- Peggiore Qualita'
set t52=- Migliore Qualita'
set t53=Scegli (1/2/3/4/5/6/7):
set t54=Qualita' Impostata su:
set t55=Applicare il denoiser Convolution3D Si/No: 
set t56=Applicare il denoiser PMD Si/No: 
set t57=Applicare il Miglioramento Dettagli Si/No:  
set t58=Miglioramento Dettagli: Si 
set t59=Miglioramento Dettagli: No 
set t60=Informazioni
set t61=Video da Codificare Salvate!
set t62=Vuoi Inserire un altro Video da Codificare (Si/No):
set t63=Il file trascinato non e' un video!
set t64=Scegli (1/2/3/4):
set t65=Premi Invio per tornare al menu' Inserimento Codifiche in Coda e Salvataggio sul Disco:  

set t66=Larghezza Video
set t67=Altezza Video
set t68=Codec Video
set t69=Codec Video Dettagli
set t70=Format Video 
set t71=Configurazione Parametri per convertire il video da 10bit HDR a 8bit SDR
set t72=Selezionare DownGrader Codifica:
set t73=DownGrader Impostato:

goto avvio_InserimentoCodificaHardwareDowngradingda2160p1080p10bitHDR10a8bitSDR

:avvio_InserimentoCodificaHardwareDowngradingda2160p1080p10bitHDR10a8bitSDR

set /a "numeromovie=1"


echo !t1!
echo.


:altrivideodainserire_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR


set NomeFile2160ppuliziadettaggli=
rem set MetadatiStreamHDR10=

set /P NomeFile2160ppuliziadettaggli=!t2! !numeromovie! !t211! 
rem echo Hai digitato: %NomeFile%
rem pause

set "NomeFileSorgente=!NomeFile2160ppuliziadettaggli:"=!"
@REM echo NomeFileSorgente = !NomeFileSorgente!
set "NomeFile=^"!NomeFileSorgente!^""
@REM echo NomeFile = !NomeFile!
rem pause


if exist %NomeFile% ( goto infovideo_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR ) else ( 
                                                        echo.
                                                        echo !t3!
                                                        echo.
                                                        goto fineinfovideo_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
                                                        )    




:infovideo_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

echo.
echo !t4!
echo.

.\bin\ffprobe -v error -hide_banner -select_streams v:0 -show_entries stream=width,height,codec_name,codec_long_name,pix_fmt,color_space,color_transfer,color_primaries -of default=noprint_wrappers=1 %NomeFile% > ".\temp\Temp_HDR10_Stream.txt"

set /A x1=1
set /A nohdrcs=0
set /A nohdrct=0
set /A nohdrcp=0
set /A wv=0
set /a hv=0
set /A fv=0
set def=
rem echo nohdr = %nohdr%

for /f "tokens=1,2 delims==" %%a in (.\temp\Temp_HDR10_Stream.txt) do (if !x1!==3 ( 
                                                                            echo !t66! "%%a" = %%b  
                                                                            set /A "widthvideo=%%b"
                                                                            @REM echo widthvideo = !widthvideo!
                                                                            if !widthvideo! LEQ 3840 if !widthvideo! GEQ 2000 (set /A "wv=1"
                                                                                                                                @REM echo wv = !wv!
                                                                                                                                set "def=2160p"
                                                                                                                                )
                                                                            if !widthvideo! LEQ 1920 if !widthvideo! GEQ 1000 (set /A "wv=1"
                                                                                                                                @REM echo wv = !wv!
                                                                                                                                set "def=1080p"
                                                                                                                                )
                                                                            )
                                                                if !x1!==4 ( 
                                                                            echo !t67! "%%a" = %%b  
                                                                            set /A "heightvideo=%%b"
                                                                            @REM echo heightvideo = !heightvideo!
                                                                            if !heightvideo! LEQ 2160 if !heightvideo! GEQ 1400 (set /A "hv=1"
                                                                                                                                @REM echo hv = !hv!
                                                                                                                                )
                                                                            if !heightvideo! LEQ 1080 if !heightvideo! GEQ 700 (set /A "hv=1"
                                                                                                                                @REM echo hv = !hv!
                                                                                                                                )
                                                                            )                                                           
                                                                if !x1!==6 ( 
                                                                            echo Color Space "%%a" = %%b  
                                                                            set "colorsp=%%b"
                                                                            @REM echo colorsp = !colorsp!
                                                                            if !colorsp!==bt2020nc (set /A "nohdrcs=1"
                                                                                                    @REM echo nohdrcs = !nohdrcs!
                                                                                                    )
                                                                            if !colorsp!==unknown (set /A "nohdrcs=1"
                                                                                                    @REM echo nohdrcs = !nohdrcs!
                                                                                                    )
                                                                            if !colorsp!==reserved (set /A "nohdrcs=1"
                                                                                                    @REM echo nohdrcs = !nohdrcs!
                                                                                                    )                    
                                                                            ) 
                                                                if !x1!==7 ( 
                                                                            echo Color Transfer "%%a" = %%b  
                                                                            set "colortr=%%b"
                                                                            @REM echo colortr = !colortr!
                                                                            if !colortr!==smpte2084 (set /A "nohdrct=1"
                                                                                                    @REM echo nohdrct = !nohdrct!
                                                                                                    )
                                                                            ) 
                                                                if !x1!==8 ( 
                                                                            echo Color Primaries "%%a" = %%b  
                                                                            set "colorpr=%%b"
                                                                            @REM echo colorpr = !colorpr!
                                                                            if !colorpr!==bt2020 (set /A "nohdrcp=1"
                                                                                                    @REM echo nohdrcp = !nohdrcp!
                                                                                                    )           
                                                                            )    
                                                                if !x1!==1 ( 
                                                                            echo !t68! "%%a" = %%b  
                                                                            )       
                                                                if !x1!==2 ( 
                                                                            echo !t69! "%%a" = %%b  
                                                                            )   
                                                                if !x1!==5 ( 
                                                                            echo !t70! "%%a" = %%b  
                                                                            set "formatvideo=%%b"
                                                                            @REM echo formatvideo = !formatvideo!
                                                                            if !formatvideo!==yuv420p10le (set /A "fv=1"
                                                                                                            @REM echo fv = !fv!
                                                                                                            )
                                                                            )
                                                                set /A x1+=1                                                            
)
echo.

if !x1!==1 goto :novideofile2160p10080p_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR


if !nohdrcs!==1 if !nohdrct!==1 if !nohdrcp!==1 if !wv!==1 if !hv!==1 if !fv!==1 ( 
                                                                                   echo !t5! !def! 10bit HDR 
                                                                                   echo. 
                                                                                   goto RilevazioneBandeNere_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR                                                                     
                                                                                   ) 


echo !t6! !def! 10bit HDR 
echo.
goto fineinfovideo_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

echo


:RilevazioneBandeNere_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

.\bin\ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 %NomeFile%  > ".\temp\durata_film.txt"

set /a contatore=1
for /f "tokens=1 delims=." %%a in (.\temp\durata_film.txt) do  (
                                                        echo. 
                                                        echo !t7! %%a
                                                        set /a "secondi=%%a"
                                                        set /a "minuti=!secondi!/60"
                                                        echo !t8! !minuti!
                                                        set /a "intervallo_tagli=!secondi!/11"
                                                        echo !t9! !intervallo_tagli!!t10!
                                                        echo.
                                                        echo !t11!
                                                        echo.

                                                        

                                                        FOR /L %%a IN (1, 1, 10) DO (
                                                                                    rem echo %%a
                                                                                    set /a "secondi=%%a*!intervallo_tagli!"
                                                                                    rem echo !secondi!

                                                                                    
                                                                                    set /a "ca=72"
                                                                                    rem echo !ca!
                                                                                                                    
                                                                                    set /a "cb=2"
                                                                                    rem echo !cb!
                                                                                                                    
                                                                                    set /a "cc=0"
                                                                                    rem echo !cc!

                                                                                    set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                    rem echo !cr!
        
                                                                                
                                                                                    .\bin\ffmpeg -ss !secondi! -hide_banner -nostats -i %NomeFile% -vframes 10 -vf !cr! -f null - 2> ".\temp\crop.txt"
                                                                                    
                                                                                    findstr /r "Parsed_cropdetect_0" .\temp\crop.txt >> .\temp\risultato_multiplo.txt   
                                                                                    
                                                                                    echo !t12! %%a !t13! !secondi! !t14!
                                                                                    
                                                                                    )       
                                                                                       

                                                                                    for /f "tokens=1,2 delims==" %%a in (.\temp\risultato_multiplo.txt) do ( echo %%b >> .\temp\crop_multiplo.txt )
                                                                                    
                                                                                    set /a "maxfrequenza=0"

                                                                                    for /f "delims=" %%a in (.\temp\crop_multiplo.txt) do ( 
                                                                                                                                    set "cropconfront=%%a"
                                                                                                                                    rem echo "!cropconfront!"
                                                                                                                                    
                                                                                                                                    set /a "contatorfrequenza=0"
                                                                                                                                    for /f "delims=" %%b in (.\temp\crop_multiplo.txt) do (
                                                                                                                                                                                    set "dato_da_verificare=%%b"
                                                                                                                                                                                    rem echo cropconfront = "!cropconfront!"
                                                                                                                                                                                    rem echo dato_da_verificare = "!dato_da_verificare!"
                                                                                                                                                                                    if !cropconfront!==!dato_da_verificare! ( set /a "contatorfrequenza+=1")
                                                                                                                                                                                    )
                                                                                                                                    if !maxfrequenza! LSS !contatorfrequenza! ( 
                                                                                                                                                                                set /a "maxfrequenza=!contatorfrequenza!"
                                                                                                                                                                                set "cropd=!cropconfront!"
                                                                                                                                                                                )
                                                                                                                                    

                                                                                                                                    rem if !cropconfront! in (elenco_crop_frequenza.txt) ()
                                                                                                                                    rem echo !cropconfront!:!contatorfrequenza! >> elenco_crop_frequenza.txt

                                                                                                                                    )

                                                                                    rem echo crop piu' frequente = !cropd! con grequenza = !maxfrequenza!
                                                                                    echo !cropd! > .\temp\crop_finale.txt

                                                                                    for /f "tokens=1,2,3,4 delims=:" %%a in (.\temp\crop_finale.txt) do  ( 
                                                                                                                                                    rem set /a "mwidth=%%a"
                                                                                                                                                    rem echo mwidth = !mwidth!

                                                                                                                                                    rem set /a "mheight=%%b"
                                                                                                                                                    rem echo mheight = !mheight!

                                                                                                                                                    rem set /a "mx=%%c"
                                                                                                                                                    rem echo mx = !mx!

                                                                                                                                                    rem set /a "my=%%d"
                                                                                                                                                    rem echo my = !my!

                                                                                                                                                    if !contatore!==1 ( 
                                                                                                                                                                set /a "wmax=%%a" 
                                                                                                                                                                set /a "hmax=%%b"
                                                                                                                                                                set /a "xmin=%%c"
                                                                                                                                                                set /a "ymin=%%d"
                                                                                                                                                                set /a "mwidth=%%a"
                                                                                                                                                                set /a "mheight=%%b"
                                                                                                                                                                set /a "mx=%%c"
                                                                                                                                                                set /a "my=%%d"
                                                                                                                                                                set /a "contatore+=1"
                                                                                                                                                                )
                                                                                                                                                    
                                                                                                                                                    rem if %%b gtr !hmax! if %%c gtr !xmin! if %%d gtr !ymin! 

                                                                                                                                                    if %%a geq !wmax! if %%b geq !hmax! ( 
                                                                                                                                                                        set /a "wmax=%%a" 
                                                                                                                                                                        set /a "hmax=%%b"
                                                                                                                                                                        set /a "xmin=%%c"
                                                                                                                                                                        set /a "ymin=%%d"
                                                                                                                                                                        set /a "mwidth=%%a"
                                                                                                                                                                        set /a "mheight=%%b"
                                                                                                                                                                        set /a "mx=%%c"
                                                                                                                                                                        set /a "my=%%d"
                                                                                                                                                                        )
                                                                                                                                                    )
                                                                                    echo.
                                                                                    set /a "csup=!my!"
                                                                                    rem echo csup = !csup!
                                                                                                                                    
                                                                                    set /a "csin=!mx!"
                                                                                    rem echo csin = !csin!

                                                                                    set /a "cinf=!heightvideo!-!mheight!-!my!"
                                                                                    rem echo movieheightreal = !movieheightreal!
                                                                                    rem echo cinf = !cinf!
                                                                                    set /a "cdes=!widthvideo!-!mwidth!-!mx!"
                                                                                    rem echo cdes = !cdes!

                                                                                    echo !t15! !def!: !widthvideo!  
                                                                                    echo !t16! !def!: !heightvideo!  
                                                                                    echo.

                                                                                    echo Crop Settings: --crop !csin!,!csup!,!cdes!,!cinf!  
                                                                                    set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"  
                                                                                    echo.  

                                                                                    set /a "height4kcrop=(!heightvideo!-!csup!-!cinf!)/2*2"
                                                                                    set /a "width4kcrop=(!widthvideo!-!csin!-!cdes!)/2*2"

                                                                                    echo !t17! !def!: !width4kcrop!  
                                                                                    echo !t18! !def!: !height4kcrop!  
                                                                                    echo.

                                                                                    if !def!==1080p (
                                                                                                    set /a "larghezza1080pnvenc=1920"
                                                                                                    set /a "altezza1080pnvenc=1080"
                                                                                                    @REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
                                                                                                    @REM echo altezza1080pnvenc = !altezza1080pnvenc!       
                                                                                                    )               

                                                                                    if !def!==2160p (
                                                                                                    set /a "larghezza1080pnvenc=3840"
                                                                                                    set /a "altezza1080pnvenc=2160"
                                                                                                    @REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
                                                                                                    @REM echo altezza1080pnvenc = !altezza1080pnvenc!       
                                                                                                    )                      

                                                                                    set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!width4kcrop!"
                                                                                    set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!height4kcrop!"
                                                                                    @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
                                                                                    @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

                                                                                    if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                                                                                                        @REM echo dentro il 1o if
                                                                                                                                                                        set /a "width4k=!width4kcrop!"
                                                                                                                                                                        set /a "height4k=!height4kcrop!"
                                                                                                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                                                                                                set /a "width4k=!width4kcrop!"
                                                                                                                                                                                                                                                                set /a "height4k=!height4kcrop!"
                                                                                                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo width4kcrop = !width4kcrop!
                                                                                                                                                                                                                                                                                                                                                        @REM echo height4kcrop = !height4kcrop!
                                                                                                                                                                                                                                                                                                                                                        set /a "width4k=!width4kcrop!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        set /a "height4k=!height4kcrop!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "width4k=!width4kcrop!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "height4k=!height4kcrop!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                                                                                                                set /a "width4k=!width4kcrop!"
                                                                                                                                                                                                                                                                set /a "height4k=!height4kcrop!"
                                                                                                                                                                                                                                                                )
                                                                                                                                                                        
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                                                                                                        set /a "width4k=!width4kcrop!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        set /a "height4k=!height4kcrop!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        )                                                                                        
                                                                                   

                                                                                        echo !t19! !def!..
                                                                                        echo.                         

                                                                                        echo !t20! !def!:  !width4k! 
                                                                                        echo !t21! !def!:  !height4k!    
                                                                                        echo.

                                                                                        @REM set /a "width4k=width2k*2"
                                                                                        @REM set /a "height4k=height2k*2"

                                                                                        @REM echo Larghezza Finale Video 2160p:  !width4k! 
                                                                                        @REM echo Altezza Finale Video 2160p:  !height4k!    
                                                                                        @REM echo.
                                                                                    )  
                                                       )                          

:inizioCropManuale_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR 

set /a "csup=0"
set /a "cinf=0"
set /a "csin=0"
set /a "cdes=0"
set /a "bandasuperiore=0"
set /a "bandainferiore=0"
set /a "bandasinistra=0"
set /a "bandadestra=0"
set /a "differenzialelarghezza1080pnvenc=0"
set /a "differenzialealtezza1080pnvenc=0"
if exist ".\temp\Temp_HDR10_Stream.txt" ( del ".\temp\Temp_HDR10_Stream.txt" ) 
if exist ".\temp\durata_film.txt" ( del ".\temp\durata_film.txt" )
if exist ".\temp\crop.txt" ( del ".\temp\crop.txt" )
if exist ".\temp\risultato_multiplo.txt" ( del ".\temp\risultato_multiplo.txt" )
if exist ".\temp\crop_multiplo.txt" ( del ".\temp\crop_multiplo.txt" )
if exist ".\temp\crop_finale.txt" ( del ".\temp\crop_finale.txt" )

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t22!"   
    if errorlevel 2 goto cropmanualeNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
    if errorlevel 1 goto finecropmanualeNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
)
CHOICE /N /C:SN /M "!t22!"   

if errorlevel 2 goto cropmanualeNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
if errorlevel 1 goto finecropmanualeNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR


:cropmanualeNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
echo.
echo !t23!
echo.

:banda_superiore_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set /p "bandasuperiore=!t24!"
SET "var="&for /f "delims=0123456789" %%i in ("!bandasuperiore!") do set var=!bandasuperiore!
if defined var (
                echo.
                echo !t25!
                echo.
                goto banda_superiore_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
                ) else (
                        set /a "csup=!bandasuperiore!/2*2"
                        )

echo.
:banda_inferiore_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set /p "bandainferiore=!t26!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandainferiore!") do set var=!bandainferiore!
if defined var (
                echo.
                echo !t27!
                echo.
                goto banda_inferiore_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
                ) else (
                        set /a "cinf=!bandainferiore!/2*2"
                        )


echo.
:banda_sinistra_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set /p "bandasinistra=!t28!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandasinistra!") do set var=!bandasinistra!
if defined var (
                echo.
                echo !t29!
                echo.
                goto banda_sinistra_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
                ) else (
                        set /a "csin=!bandasinistra!/2*2"
                        )

                        
echo.
:banda_destra_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set /p "bandadestra=!t30!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandadestra!") do set var=!bandadestra!
if defined var (
                echo.
                echo !t31!
                echo.
                goto banda_destra_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
                ) else (
                        set /a "cdes=!bandadestra!/2*2"
                        )


if !def!==1080p (
                set /a "larghezza1080pnvenc=1920"
                set /a "altezza1080pnvenc=1080"
                @REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
                @REM echo altezza1080pnvenc = !altezza1080pnvenc!       
                )               

if !def!==2160p (
                set /a "larghezza1080pnvenc=3840"
                set /a "altezza1080pnvenc=2160"
                @REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
                @REM echo altezza1080pnvenc = !altezza1080pnvenc!       
                )                                                       

set /a "width4kcrop=!widthvideo!/2*2"
set /a "height4kcrop=!heightvideo!/2*2"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "mwidthc=!width4kcrop!-!csin!-!cdes!"
set /a "mheightc=!height4kcrop!-!csup!-!cinf!"
@REM echo nuovo mwidhtc = !mwidthc!
@REM echo nuovo mheightc = !mheightc!

set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!mwidthc!"
set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!mheightc!"
@REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
@REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

echo.
echo !t32!  !csup! 
echo !t33!  !cinf! 
echo !t34!  !csin! 
echo !t35!  !cdes! 
echo.


set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
echo Crop Settings: !cropff!
echo.

echo !t36! !def!:  !mwidthc! 
echo !t37! !def!:  !mheightc! 
echo.

rem pause

if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                        @REM echo dentro il 1o if
                                                                                        set /a "width4k=!mwidthc!"
                                                                                        set /a "height4k=!mheightc!"
                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                set /a "width4k=!mwidthc!"
                                                                                                                                                                                set /a "height4k=!mheightc!"
                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                        set /a "width4k=!mwidthc!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                        set /a "height4k=!mheightc!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                set /a "width4k=!mwidthc!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                set /a "height4k=!mheightc!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                )
                                                                                        if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                        set /a "width4k=!mwidthc!"
                                                                                                                                                                        set /a "height4k=!mheightc!"
                                                                                                                                                                        )
                                                                                                                                                                        
                                                                                        if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                set /a "width4k=!mwidthc!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                set /a "height4k=!mheightc!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                )                                                                                        
                                                                                   

                                                                                        echo !t19! !def!..
                                                                                        echo.                         

                                                                                        echo !t20! !def!:  !width4k! 
                                                                                        echo !t21! !def!:  !height4k!    
                                                                                        echo.

                                                                                        @REM set /a "width4k=width2k*2"
                                                                                        @REM set /a "height4k=height2k*2"

                                                                                        @REM echo Larghezza Finale Video 2160p:  !width4k! 
                                                                                        @REM echo Altezza Finale Video 2160p:  !height4k!    
                                                                                        @REM echo.
                                                                                    ) 

goto inizioCropManuale_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:finecropmanualeNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR



echo.
echo !t38!
echo.
echo 1) NVidia 
echo 2) Intel 
echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto ChoosenIntel_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
if errorlevel 1 goto ChoosenNVidia_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:ChoosenIntel_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "SchedaGrafica=Intel"
@REM echo SchedaGrafica = !SchedaGrafica!
goto fineSceltaSchedaGrafica_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:ChoosenNVidia_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "SchedaGrafica=NVidia"
@REM echo SchedaGrafica = !SchedaGrafica!

:fineSceltaSchedaGrafica_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

@REM pause 

if !SchedaGrafica!==NVidia (
                                goto InserimentoImpostazioniNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
                                ) 





if !SchedaGrafica!==Intel (
                                goto InserimentoImpostazioniQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
                                 )


@REM pause 


rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

:InserimentoImpostazioniNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

echo.
echo !t40!
echo.
echo 1) CQP 
echo 2) VBR 
echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto CodificaVBRNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
if errorlevel 1 goto CodificaCQPNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:CodificaVBRNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "TipoCodificaNVEnc=--vbr "
set /a "quantizzazioneNVEnc=0"
goto inserimentoValoriCQPVBRNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:CodificaCQPNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "TipoCodificaNVEnc=--cqp "
set /a "quantizzazioneNVEnc=1"

:inserimentoValoriCQPVBRNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

if !quantizzazioneNVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneNVEnc=!t44! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneNVEnc!") do set var=!valoreQuantizzazioneNVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                echo.
                                                goto inserimentoValoriCQPVBRNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
                                                ) 

                                set /a "valoreQuantizzazioneNVEnc=!valoreQuantizzazioneNVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneNVEnc!
                                if !valoreQuantizzazioneNVEnc! GEQ 10 if !valoreQuantizzazioneNVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneNVEnc!
                                                                                                                set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreQuantizzazioneNVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                                goto fineQuantizzazioneNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
                                                                                                                        
                                )



if !quantizzazioneNVEnc!==0 (
                                echo.
                                set /p "valoreBitRateNVEnc=!t46! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateNVEnc!") do set var=!valoreBitRateNVEnc!
                                if defined var (
                                                echo.
                                                echo !47!
                                                echo.
                                                goto inserimentoValoriCQPVBRNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
                                                ) 
                                set /a "valoreBitRateNVEnc=!valoreBitRateNVEnc!"
                                @REM echo valoreBitRateNVEnc = !valoreBitRateNVEnc!
                                if !valoreBitRateNVEnc! GEQ 100 if !valoreBitRateNVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateNVEnc!
                                                                                                        set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreBitRateNVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                        goto fineQuantizzazioneNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
                                                                                                              
                                )


:fineQuantizzazioneNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR


echo.
echo !t50!
echo.
echo 1) P1 !t51!
echo 2) P2 
echo 3) P3 
echo 4) P4 
echo 5) P5 
echo 6) P6 
echo 7) P7 !t52!
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto P7NVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
if errorlevel 6 goto P6NVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
if errorlevel 5 goto P5NVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
if errorlevel 4 goto P4NVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
if errorlevel 3 goto P3NVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
if errorlevel 2 goto P2NVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
if errorlevel 1 goto P1NVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR


:P7NVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "SettaggioQualitaNVEnc=--preset P7"
set "QualitySetting=P7"
goto fineQualitCodificaNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:P6NVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "SettaggioQualitaNVEnc=--preset P6"
set "QualitySetting=P6"
goto fineQualitCodificaNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:P5NVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "SettaggioQualitaNVEnc=--preset P5"
set "QualitySetting=P5"
goto fineQualitCodificaNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:P4NVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "SettaggioQualitaNVEnc=--preset P4"
set "QualitySetting=P4"
goto fineQualitCodificaNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:P3NVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "SettaggioQualitaNVEnc=--preset P3"
set "QualitySetting=P3"
goto fineQualitCodificaNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:P2NVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "SettaggioQualitaNVEnc=--preset P2"
set "QualitySetting=P2"
goto fineQualitCodificaNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:P1NVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "SettaggioQualitaNVEnc=--preset P1"
set "QualitySetting=P1"
goto fineQualitCodificaNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR


:fineQualitCodificaNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaNVEnc!



echo.
echo !t71!
echo !t72!
echo.
echo 1) NVEnc Color Correction 
echo 2) LibPlacebo Color Correction 

echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto LibPlaceboColorNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
if errorlevel 1 goto NVEncColorCorrection_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:NVEncColorCorrection_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "NVEncColorCorrectionSystem=--vpp-colorspace hdr2sdr=hable,source_peak=1000,ldr_nits=100,a=0.22,b=0.3,c=0.1,d=0.2,e=0.01,f=0.3"
set "NVEncUpgrader=NVEnc Color Correction"
goto NVEncFineSelezione_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:LibPlaceboColorNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "NVEncColorCorrectionSystem=--vpp-libplacebo-tonemapping src_csp=dovi,dst_csp=sdr"
set "NVEncUpgrader=LibPlacebo Color Correction"


:NVEncFineSelezione_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
echo.
echo !t73! !NVEncUpgrader!
echo.
echo !t43! !NVEncColorCorrectionSystem!



set conv3d1080p=
set pmd1080p=


if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t55!"
    if errorlevel 2 goto conv3dChoosenNoNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
    if errorlevel 1 goto conv3dChoosenYesNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
)

echo.
CHOICE /N /C:SN /M "!t55!"

if errorlevel 2 goto conv3dChoosenNoNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
if errorlevel 1 goto conv3dChoosenYesNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:conv3dChoosenNoNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "conv3d1080p=N"
goto sceltaDeniserPMDNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:conv3dChoosenYesNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "conv3d1080p=S"





:sceltaDeniserPMDNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t56!"
    if errorlevel 2 goto PMDChoosenNoNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
    if errorlevel 1 goto PMDChoosenYesNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
)

echo.
CHOICE /N /C:SN /M "!t56!"

if errorlevel 2 goto PMDChoosenNoNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
if errorlevel 1 goto PMDChoosenYesNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:PMDChoosenNoNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "pmd1080p=N"
goto assegnazioneDenoisesNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:PMDChoosenYesNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "pmd1080p=S"


:assegnazioneDenoisesNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set /A nvdenv=0

if !conv3d1080p!==S if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00 --vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==S if !pmd1080p!==N ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==N ( 
                                        set "nvdenoiser=nessuno" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: Nessun Denoiser 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )

@REM pause


echo.

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t57!"
    if errorlevel 2 goto ApplicaMiglioramentoDettagliNVEncNO_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
    if errorlevel 1 goto ApplicaMiglioramentoDettagliNVEncSi_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
)

CHOICE /N /C:SN /M "!t57!"

if errorlevel 2 goto ApplicaMiglioramentoDettagliNVEncNO_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
if errorlevel 1 goto ApplicaMiglioramentoDettagliNVEncSi_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:ApplicaMiglioramentoDettagliNVEncNO_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "miglioramento1080p=N"
goto fineSceltaMigliaramentiNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:ApplicaMiglioramentoDettagliNVEncSi_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "miglioramento1080p=S"

:fineSceltaMigliaramentiNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
if !miglioramento1080p!==S ( 
                                set "edgeleveling=--vpp-edgelevel strength=10.0,threshold=24.0,black=6,white=0" 
                                echo.
                                echo NVEnc !t58!
                                echo.
                                )
if !miglioramento1080p!==N ( 
                                set "edgeleveling=nessuno" 
                                echo.
                                echo NVEnc !t59!
                                echo.
                                )


@REM pause


set file_senza_virgolette=%NomeFile:"=%
rem echo %file_senza_virgolette%

set file_senza_estensione=%file_senza_virgolette:.mkv=%
rem echo %file_senza_estensione%

set fileoutput2160p="%file_senza_estensione%_!def!_DownGraded_8bit_SDR.mkv"
rem echo fileoutput2160p = %fileoutput2160p%

echo.
set "VideoInfoCodifica=NVEnc_downgraded_da_2160p_o_1080p_10bit_hdr_a_8_bit_sdr|!NomeFile!|!fileoutput2160p!|nessuno|!cropff!|!width4k!x!height4k!|nessuna|nessuno|!colorpr!|!colortr!|!colorsp!|!tipoQuantizzazioneNVEnc!|!SettaggioQualitaNVEnc!|nessuno|nessuno|!nvdenoiser!|!formatvideo!|!edgeleveling!|!NVEncColorCorrectionSystem!|no_numero_passaggi_upscaling|no_lokahead|no_precisione_vettore_movimento"
@REM echo VideoInfoCodifica = !VideoInfoCodifica!
@REM echo.

if exist ".\saved\savedmoviesallencodings.dat" ( 
                                                echo !VideoInfoCodifica! >> .\saved\savedmoviesallencodings.dat
                                                goto finesalvataggioInserimentoNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
                                                ) 

echo !VideoInfoCodifica! > .\saved\savedmoviesallencodings.dat


:finesalvataggioInserimentoNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

echo !t60! !numeromovie! !t61!
echo.

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t62!"
    if errorlevel 2 goto finesceltanuovovideodacodificareNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
    if errorlevel 1 goto altrivideodainserireMenuNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
)

CHOICE /N /C:SN /M "!t62!"
echo.

if errorlevel 2 goto finesceltanuovovideodacodificareNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
if errorlevel 1 goto altrivideodainserireMenuNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:altrivideodainserireMenuNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set /a "numeromovie+=1"
echo.
goto altrivideodainserire_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:finesceltanuovovideodacodificareNVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
echo.
goto fineinfovideo_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR


rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////





rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

:InserimentoImpostazioniQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR



echo.
echo t40!
echo.
echo 1) CQP 
echo 2) ICQ 
echo 3) LA-ICQ 
echo 4) VBR 
echo.
CHOICE /N /C:1234 /M "!t64!"

if errorlevel 4 goto CodificaVBRQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
if errorlevel 3 goto CodificaLAICQQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
if errorlevel 2 goto CodificaICQQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR 
if errorlevel 1 goto CodificaCQPQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR


:CodificaCQPQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "TipoCodificaQSVEnc=--cqp "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:CodificaICQQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "TipoCodificaQSVEnc=--icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:CodificaLAICQQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "TipoCodificaQSVEnc=--la-icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:CodificaVBRQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "TipoCodificaQSVEnc=--vbr "
set /a "quantizzazioneQSVEnc=0"
goto inserimentoValoriCQPVBRQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR


:inserimentoValoriCQPVBRQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

if !quantizzazioneQSVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneQSVEnc=!t44! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneQSVEnc!") do set var=!valoreQuantizzazioneQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                echo.
                                                goto inserimentoValoriCQPVBRQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
                                                ) 

                                set /a "valoreQuantizzazioneQSVEnc=!valoreQuantizzazioneQSVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneQSVEnc!
                                if !valoreQuantizzazioneQSVEnc! GEQ 10 if !valoreQuantizzazioneQSVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneQSVEnc!
                                                                                                                set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreQuantizzazioneQSVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                                goto fineQuantizzazioneQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
                                                                                                                        
                                )



if !quantizzazioneQSVEnc!==0 (
                                echo.
                                set /p "valoreBitRateQSVEnc=!t46! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateQSVEnc!") do set var=!valoreBitRateQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                echo.
                                                goto inserimentoValoriCQPVBRQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
                                                ) 
                                set /a "valoreBitRateQSVEnc=!valoreBitRateQSVEnc!"
                                @REM echo valoreBitRateQSVEnc = !valoreBitRateQSVEnc!
                                if !valoreBitRateQSVEnc! GEQ 100 if !valoreBitRateQSVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateQSVEnc!
                                                                                                        set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreBitRateQSVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                        goto fineQuantizzazioneQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
                                                                                                              
                                )


:fineQuantizzazioneQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR




echo.
echo !t50!
echo.
echo 1) Best 
echo 2) Higher 
echo 3) High 
echo 4) Balanced 
echo 5) Fast 
echo 6) Faster 
echo 7) Fastest 
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto QualitFastestQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
if errorlevel 6 goto QualitFasterQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
if errorlevel 5 goto QualitFastQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
if errorlevel 4 goto QualitBalancedtQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
if errorlevel 3 goto QualitHighQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
if errorlevel 2 goto QualitHigherQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
if errorlevel 1 goto QualitBestQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR


:QualitBestQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "SettaggioQualitaQSvenc=--quality best"
set "QualitySetting=best"
goto fineQualitCodificaQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:QualitHigherQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "SettaggioQualitaQSvenc=--quality higher"
set "QualitySetting=higher"
goto fineQualitCodificaQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:QualitHighQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "SettaggioQualitaQSvenc=--quality high"
set "QualitySetting=high"
goto fineQualitCodificaQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:QualitBalancedtQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "SettaggioQualitaQSvenc=--quality balanced"
set "QualitySetting=balanced"
goto fineQualitCodificaQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:QualitFastQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "SettaggioQualitaQSvenc=--quality fast"
set "QualitySetting=fast"
goto fineQualitCodificaQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:QualitFasterQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "SettaggioQualitaQSvenc=--quality faster"
set "QualitySetting=faster"
goto fineQualitCodificaQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:QualitFastestQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "SettaggioQualitaQSvenc=--quality fastest"
set "QualitySetting=fastest"
goto fineQualitCodificaQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR


:fineQualitCodificaQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaQSvenc!


echo.
echo !t71!
echo !t72!
echo.
echo 1) QSVEnc Color Correction 
echo 2) LibPlacebo Color Correction 

echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto LibPlaceboColorCorrectionQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
if errorlevel 1 goto QSVEncColorCorrection_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR


:QSVEncColorCorrection_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "QSVEncColorCorrectionSystem=--vpp-colorspace hdr2sdr=hable,source_peak=1000,ldr_nits=100,a=0.22,b=0.3,c=0.1,d=0.2,e=0.01,f=0.3"
set "QSVEncUpgrader=QSVEnc Color Correction"
goto QSVEncFineSelezione_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:LibPlaceboColorCorrectionQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "QSVEncColorCorrectionSystem=--vpp-libplacebo-tonemapping src_csp=dovi,dst_csp=sdr"
set "QSVEncUpgrader=LibPlacebo Color Correction"


:QSVEncFineSelezione_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
echo.
echo !t73! !QSVEncUpgrader!
echo.
echo !t43! !QSVEncColorCorrectionSystem!



:sceltadenoiserQSVEnc
set conv3d1080p=
set pmd1080p=

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t55!"
    if errorlevel 2 goto conv3dChoosenNoQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
    if errorlevel 1 goto conv3dChoosenYesQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
)
echo.
CHOICE /N /C:SN /M "!t55!"

if errorlevel 2 goto conv3dChoosenNoQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
if errorlevel 1 goto conv3dChoosenYesQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:conv3dChoosenNoQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "conv3d1080p=N"
goto sceltaDeniserPMDQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:conv3dChoosenYesQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "conv3d1080p=S"



:sceltaDeniserPMDQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t56!"
    if errorlevel 2 goto PMDChoosenNoQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
    if errorlevel 1 goto PMDChoosenYesQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
)
echo.
CHOICE /N /C:SN /M "!t56!"

if errorlevel 2 goto PMDChoosenNoQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
if errorlevel 1 goto PMDChoosenYesQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:PMDChoosenNoQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "pmd1080p=N"
goto assegnazioneDenoisesQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:PMDChoosenYesQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "pmd1080p=S"


:assegnazioneDenoisesQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set /A nvdenv=0

if !conv3d1080p!==S if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00 --vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==S if !pmd1080p!==N ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==N ( 
                                        set "nvdenoiser=nessuno" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: Nessun Denoiser 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )

@REM pause


if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t57!"
    if errorlevel 2 goto ApplicaMiglioramentoDettagliQSVEncNo_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
    if errorlevel 1 goto ApplicaMiglioramentoDettagliQSVEncSi_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
)
echo.
CHOICE /N /C:SN /M "!t57!"

if errorlevel 2 goto ApplicaMiglioramentoDettagliQSVEncNo_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
if errorlevel 1 goto ApplicaMiglioramentoDettagliQSVEncSi_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:ApplicaMiglioramentoDettagliQSVEncNo_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "miglioramento1080p=N"
goto fineSceltaMigliaramentiQSCEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:ApplicaMiglioramentoDettagliQSVEncSi_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set "miglioramento1080p=S"

:fineSceltaMigliaramentiQSCEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
if !miglioramento1080p!==S ( 
                                set "edgeleveling=--vpp-edgelevel strength=10.0,threshold=24.0,black=6,white=0" 
                                echo.
                                echo QSVEnc !t58!
                                echo.
                                )
if !miglioramento1080p!==N ( 
                                set "edgeleveling=nessuno" 
                                echo.
                                echo QSVEnc !t59!
                                echo.
                                )


@REM pause

set file_senza_virgolette=%NomeFile:"=%
rem echo %file_senza_virgolette%

set file_senza_estensione=%file_senza_virgolette:.mkv=%
rem echo %file_senza_estensione%

set fileoutput2160p="%file_senza_estensione%_!def!_DownGraded_8bit_SDR.mkv"
rem echo fileoutput2160p = %fileoutput2160p%

echo.
set "VideoInfoCodifica=QSVEnc_downgraded_da_2160p_o_1080p_10bit_hdr_a_8_bit_sdr|!NomeFile!|!fileoutput2160p!|nessuno|!cropff!|!width4k!x!height4k!|nessuna|nessuno|!colorpr!|!colortr!|!colorsp!|!tipoQuantizzazioneQSVEnc!|!SettaggioQualitaQSVEnc!|nessuno|nessuno|!nvdenoiser!|!formatvideo!|!edgeleveling!|!QSVEncColorCorrectionSystem!|no_numero_passaggi_upscaling|no_lokahead|no_precisione_vettore_movimento"
@REM echo VideoInfoCodifica = !VideoInfoCodifica!
@REM echo.

if exist ".\saved\savedmoviesallencodings.dat" ( 
                                                echo !VideoInfoCodifica! >> .\saved\savedmoviesallencodings.dat
                                                goto finesalvataggioInserimentoQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
                                                ) 

echo !VideoInfoCodifica! > .\saved\savedmoviesallencodings.dat


:finesalvataggioInserimentoQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

echo !t60! !numeromovie! !t61!
echo.

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t62!"
    if errorlevel 2 goto finesceltanuovovideodacodificareQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
    if errorlevel 1 goto altrivideodainserireMenuQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
)

CHOICE /N /C:SN /M "!t62!"
echo.

if errorlevel 2 goto finesceltanuovovideodacodificareQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
if errorlevel 1 goto altrivideodainserireMenuQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:altrivideodainserireMenuQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
set /a "numeromovie+=1"
echo.
goto altrivideodainserire_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

:finesceltanuovovideodacodificareQSVEnc_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
echo.
goto fineinfovideo_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR

rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



goto fineinfovideo_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR



:novideofile2160p10080p_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR
echo !t63!
echo.




:fineinfovideo_InserimentoDowngradingda2160p1080p10bitHDR10a8bitSDR



if exist ".\temp\Temp_HDR10_Stream.txt" ( del .\temp\Temp_HDR10_Stream.txt )
if exist ".\temp\durata_film.txt" ( del .\temp\durata_film.txt )
if exist ".\temp\crop.txt" ( del .\temp\crop.txt )
if exist ".\temp\risultato_multiplo.txt" ( del .\temp\risultato_multiplo.txt )
if exist ".\temp\crop_multiplo.txt" ( del .\temp\crop_multiplo.txt )
if exist ".\temp\crop_finale.txt" ( del .\temp\crop_finale.txt )
      




set waitenter=
set /P waitenter=!t65!
Endlocal
goto InserimentoCodifcaInCodaeSalvataggioSuDisco














rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:InserimentoCodificaHardwareUpGradingda2160p810bitSDRa2160p10bitHDR10

cls
setLocal EnableExtensions EnableDelayedExpansion





for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoInserimentoCodificaHardwareUpGradingda2160p810bitSDRa2160p10bitHDR10
)

if %lingua%==inglese (
    goto caricalinguaingleseInserimentoCodificaHardwareUpGradingda2160p810bitSDRa2160p10bitHDR10
)



:caricalinguaingleseInserimentoCodificaHardwareUpGradingda2160p810bitSDRa2160p10bitHDR10
set t1=Insert Hardware Video Encoding Info UpGrading from 2160p 10 bit or 8 bit SDR to 2160p 10 bit HDR and Saving to Disk

set t2=Drag Here the
set t211=Video File 2160p 10 bit HDR to Convert to 1080p 8 bit SDR:  

set t3=File does not exist 
set t4=Info Video:  

set t5=The Inserted Video is 2160p 8bit SDR 
set t511=The Inserted Video is 2160p 10bit SDR 

set t6=The Inserted Video isn't 2160p 8bit or 10bit SDR 
set t7=Video Duration in seconds:
set t8=Video Duration in Minutes:
set t9=Interval between Frames for Crop Detection:
set t10= seconds
set t11=Black Bands Detection Started....
set t12=Crop Detection to Frame
set t13=to seconds
set t14=Done...
set t15=Original 2160p Video Width: 
set t16=Original 2160p Video Height:
set t17=Original Video 2160p Width Without Black Bars:
set t18=Original Video 2160p Height Without Black Bars:

set t171=Output Video 1080p Width Without Black Bars:
set t181=Outout Video 1080p Height Without Black Bars:

set t19=Adapting Video Resolution to Full 2160p Format...
set t20=Final 2160p Output Video Width:
set t21=Final 2160p Output Video Height:

set t22=Settings of Black Bands to Crop are Correct (Yes/No):
set t23=Manually Entering Black Band Values to Crop... 
set t24=Enter the Upper Black Band Value: 
set t25=Error Entering Upper Black Band Value... It's Not a Number. 
set t26=Enter the Lower Black Band Value: 
set t27=Error Entering Lower Black Band Value... It's Not a Number.
set t28=Enter the Left Black Band Value: 
set t29=Error Entering Left Black Band Value... It's Not a Number.
set t30=Enter the Right Black Band Value: 
set t31=Error Entering Right Black Band Value... It's Not a Number.
set t32=Upper Black Band:
set t33=Lower Black Band:
set t34=Left Black Band:
set t35=Right Black Band:
set t36=2160p Original Video Width without Black Bars:
set t37=2160p Original Video Height without Black Bars:

@REM set t361=1080p Video Width without Black Bars:
@REM set t371=1080p Video Height without Black Bars

set t38=Select Graphic Card you want to Encode with:
set t39=Choose (1/2):
set t40=Select Encoding Type:
set t41=Error Entering Quantization Value... Not a Number. 
set t42=Quantization Value Set to:
set t43=Encoding Settings:
set t44=Enter Quantization value Minimum 10 Maximum 28:
set t45=Quantization Value Out of  Limits  10 / 28  Re-enter^!
set t46=Enter BitRate Value kbs Minimum 100 Maximum 50000:
set t47=Error Entering BitRate Value... It's Not a Number. 
set t48=BitRate Value Set to:
set t49=BitRate Value Out of Limits  100 / 50000  Re-enter^!
set t50=Select Encoding Quality:
set t51=- Worst Quality
set t52=- Best Quality
set t53=Choose (1/2/3/4/5/6/7):
set t54=Quality Set to:
set t55=Apply Convolution3D denoiser Yes/No: 
set t56=Apply PMD denoiser Yes/No: 
set t57=Apply Detail Enhancement Yes/No:  
set t58=Enhancement Detail: Yes 
set t59=Enhancement Detail: No 
set t60=Info
set t61=Videos to Encode Saved!
set t62=Do You Want to Insert Another Video to Encode (Yes/No):
set t63=The dragged file is not a video!
set t64=Choose (1/2/3/4):
set t65=Press Enter toback to Menu Inserting Encoding into the Queue and Saving to Disk:  

set t66=Video Width
set t67=Video Height
set t68=Video Codec
set t69=Details Video Codec
set t70=Video Format 
set t71=Configuration Settings to convert video from 8bit or 10bit SDR to 10bit HDR
set t72=Select Encoding UpGrader:
set t73=Settings UpGrader:
set t74=Choose (1/2/3):

goto avvio_InserimentoCodificaHardwareUpGradingda2160p810bitSDRa2160p10bitHDR10




:caricalinguaitalianoInserimentoCodificaHardwareUpGradingda2160p810bitSDRa2160p10bitHDR10
set t1=Inserimento Info Codifica Hardware Video UpGrading da 2160p 10 bit o 8 bit SDR a 10 bit HDR e Salvataggio su Disco.

set t2=Trascina Qui il 
set t211=File Video 2160p 8 bit o [923m10 bit SDR da Convertire in 10 bit HDR:  

set t3=File Inesistente 
set t4=Informazioni Video:  

set t5=Il Video inserito e' 2160p 8bit SDR 
set t511=Il Video inserito e' 2160p 10bit SDR 

set t6=Il Video inserito non e' 2160p 8bit o 10bit SDR 

set t7=Durata del Video in secondi:
set t8=Durata del video in Minuti:
set t9=Intervallo tra i Fotogrammi per il Rilevamento del crop:
set t10= secondi
set t11=Rilevamento Bande Nere Iniziato....
set t12=Rilevazione crop fotogramma
set t13=a secondi
set t14=Eseguita...
set t15=Larghezza Video 2160p Originale:
set t16=Altezza Video 2160p Originale:
set t17=Larghezza Video Originale 2160p  Senza Barre Nere:
set t18=Altezza Video Originale 2160p  Senza Barre Nere:

set t171=Larghezza Video 1080p  Senza Barre Nere:
set t181=Altezza Video 1080p  Senza Barre Nere:

set t19=Adattamento della Risoluzione del Video al Pieno Formato 2160p..
set t20=Larghezza Finale Video 2160p:
set t21=Altezza Finale Video 2160p:

set t22=Le Impostazioni delle Bande Nere da Tagliare sono Corrette (Si/No):
set t23=Inserimento Manuale Valori Bande Nere da Tagliare.. 
set t24=Inserisci il Valore della Banda Nera Superiore: 
set t25=Errore nell'Inserimento del Valore della Banda Nera Superiore... Non e' un Numero. 
set t26=Inserisci il Valore della Banda Nera Inferiore: 
set t27=Errore nell'Inserimento del Valore della Banda Nera Inferiore... Non e' un Numero. 
set t28=Inserisci il Valore della Banda Nera Sinistra: 
set t29=Errore nell'Inserimento del Valore della Banda Nera Sinistra... Non e' un Numero. 
set t30=Inserisci il Valore della Banda Nera Destra: 
set t31=Errore nell'Inserimento del Valore della Banda Nera Destra... Non e' un Numero. 
set t32=Banda Nera Superiore:
set t33=Banda Nera Inferiore:
set t34=Banda Nera Sinistra:
set t35=Banda Nera Destra:
set t36=Larghezza Video Originale 2160p senza Bande Nere:
set t37=Altezza Video Originale 2160p senza Bande Nere:

@REM set t361=Larghezza Video 1080p senza Bande Nere:
@REM set t371=Altezza Video 1080p senza Bande Nere:

set t38=Selezionare Scheda Grafica con cui Eseguire la Codifica:
set t39=Scegli (1/2):
set t40=Selezionare tipo di Codifica:
set t41=Errore nell'Inserimento del Valore della Quantizzazione... Non e' un Numero. 
set t42=Valore Quantizzazzione Impostato a:
set t43=Parametri per codifica:

set t44=Inserire Valore Quantizzazione Minimo 10 Massimo 28:
set t45=Valore Quantizzazzione al di fuori dei  Limiti  10 / 28  Reinserire^!
set t46=Inserire Valore BitRate kbs Minimo 100 Massimo 50000:
set t47=Errore nell'Inserimento del Valore del BitRate... Non e' un Numero. 
set t48=Valore BitRate Impostato a:
set t49=Valore  BitRate al di fuori dei  Limiti  100 / 50000  Reinserire^!

set t50=Selezionare Qualita' Codifica:
set t51=- Peggiore Qualita'
set t52=- Migliore Qualita'
set t53=Scegli (1/2/3/4/5/6/7):
set t54=Qualita' Impostata su:
set t55=Applicare il denoiser Convolution3D Si/No: 
set t56=Applicare il denoiser PMD Si/No: 
set t57=Applicare il Miglioramento Dettagli Si/No:  
set t58=Miglioramento Dettagli: Si 
set t59=Miglioramento Dettagli: No 
set t60=Informazioni
set t61=Video da Codificare Salvate!
set t62=Vuoi Inserire un altro Video da Codificare (Si/No):
set t63=Il file trascinato non e' un video!
set t64=Scegli (1/2/3/4):
set t65=Premi Invio per tornare al menu' Inserimento Codifiche in Coda e Salvataggio sul Disco:  

set t66=Larghezza Video
set t67=Altezza Video
set t68=Codec Video
set t69=Codec Video Dettagli
set t70=Format Video 
set t71=Configurazione Parametri per convertire il video da 8bit o 10bit SDR a 10bit HDR
set t72=Selezionare UpGrader Codifica:
set t73=UpGrader Impostato:
set t74=Scegli (1/2/3):

goto avvio_InserimentoCodificaHardwareUpGradingda2160p810bitSDRa2160p10bitHDR10

:avvio_InserimentoCodificaHardwareUpGradingda2160p810bitSDRa2160p10bitHDR10





set /a "numeromovie=1"


echo !t1!
echo.


:altrivideodainserire_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10


set NomeFile2160ppuliziadettaggli=
rem set MetadatiStreamHDR10=

set /P NomeFile2160ppuliziadettaggli=!t2! !numeromovie! !t211! 
rem echo Hai digitato: %NomeFile%
rem pause

set "NomeFileSorgente=!NomeFile2160ppuliziadettaggli:"=!"
@REM echo NomeFileSorgente = !NomeFileSorgente!
set "NomeFile=^"!NomeFileSorgente!^""
@REM echo NomeFile = !NomeFile!
rem pause


if exist %NomeFile% ( goto infovideo_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10 ) else ( 
                                                        echo.
                                                        echo !t3!
                                                        echo.
                                                        goto fineinfovideo_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
                                                        )    



:infovideo_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
echo.
echo !t4!
echo.

.\bin\ffprobe -v error -hide_banner -select_streams v:0 -show_entries stream=width,height,codec_name,codec_long_name,pix_fmt,color_space,color_transfer,color_primaries -of default=noprint_wrappers=1 !NomeFile! > ".\temp\Temp_HDR10_Stream.txt"

set /A x1=1
set /A nohdrcs=0
set /A nohdrct=0
set /A nohdrcp=0
set /A wv=0
set /a hv=0
set /A fv=0

rem echo nohdr = %nohdr%

for /f "tokens=1,2 delims==" %%a in (.\temp\Temp_HDR10_Stream.txt) do (if !x1!==3 ( 
                                                                            echo !t66! "%%a" = %%b  
                                                                            set /A "widthvideo=%%b"
                                                                            rem echo widthvideo = !widthvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !widthvideo! LEQ 3840 if !widthvideo! GEQ 2000 (set /A "wv=1"
                                                                                                                                rem echo wv = !wv!
                                                                                                                                )
                                                                            )
                                                                if !x1!==4 ( 
                                                                            echo !t67! "%%a" = %%b  
                                                                            set /A "heightvideo=%%b"
                                                                            rem echo heightvideo = !heightvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !heightvideo! LEQ 2160 if !heightvideo! GEQ 1400 (set /A "hv=1"
                                                                                                        rem echo hv = !hv!
                                                                                                        )
                                                                            )                                                           
                                                                if !x1!==6 ( 
                                                                            echo Color Space "%%a" = %%b  
                                                                            set "colorsp=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colorsp!==bt709 (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorsp!==unknown (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorsp!==reserved (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                    
                                                                            ) 
                                                                if !x1!==7 ( 
                                                                            echo Color Transfer "%%a" = %%b  
                                                                            set "colortr=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colortr!==bt709 (set /A "nohdrct=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colortr!==unknown (set /A "nohdrct=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colortr!==reserved (set /A "nohdrct=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                    
                                                                            ) 
                                                                if !x1!==8 ( 
                                                                            echo Color Primaries "%%a" = %%b  
                                                                            set "colorpr=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colorpr!==bt709 (set /A "nohdrcp=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorpr!==unknown (set /A "nohdrcp=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorpr!==reserved (set /A "nohdrcp=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                
                                                                            )    
                                                                if !x1!==1 ( 
                                                                            echo !t68! "%%a" = %%b  
                                                                            )       
                                                                if !x1!==2 ( 
                                                                            echo !t69! "%%a" = %%b  
                                                                            )   
                                                                if !x1!==5 ( 
                                                                            echo !t70! "%%a" = %%b  
                                                                            set "formatvideo=%%b"
                                                                            rem echo formatvideo = !formatvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !formatvideo!==yuv420p (set /A "fv=1"
                                                                                                        rem echo fv = !fv!
                                                                                                        )
                                                                            if !formatvideo!==yuv420p10le (set /A "fv=1"
                                                                                                        rem echo fv = !fv!
                                                                                                        )
                                                                            )
                                                                set /A x1+=1                                                            
)
echo.

if !x1!==1 goto novideofile2160p_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10


if !nohdrcs!==1 if !nohdrct!==1 if !nohdrcp!==1 if !wv!==1 if !hv!==1 if !fv!==1 ( 
                                                                                   if !formatvideo!==yuv420p10le (
                                                                                                                    echo !t511!
                                                                                                                    echo. 
                                                                                                                    goto rilevazionebandenere_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
                                                                                                                    ) 
                                                                                   if !formatvideo!==yuv420p (                                 
                                                                                                                echo !t5!
                                                                                                                echo. 
                                                                                                                goto rilevazionebandenere_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
                                                                                                                )
                                                                                   ) 
echo !t6!
echo.
goto fineinfovideo_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10


rem//////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////


:rilevazionebandenere_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
.\bin\ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 %NomeFile%  > ".\temp\durata_film.txt"

set /a contatore=1
for /f "tokens=1 delims=." %%a in (.\temp\durata_film.txt) do  (
                                                        echo. 
                                                        echo !t7! %%a
                                                        set /a "secondi=%%a"
                                                        set /a "minuti=!secondi!/60"
                                                        echo !t8! !minuti!
                                                        set /a "intervallo_tagli=!secondi!/11"
                                                        echo !t9! !intervallo_tagli!!t10!
                                                        echo.
                                                        echo !t11!
                                                        echo.

                                                        

                                                        FOR /L %%a IN (1, 1, 10) DO (
                                                                                    rem echo %%a
                                                                                    set /a "secondi=%%a*!intervallo_tagli!"
                                                                                    rem echo !secondi!

                                                                                    
                                                                                    if !formatvideo!==yuv420p (
                                                                                                                set /a "ca=16"
                                                                                                                rem echo !ca!
                                                                                                                    
                                                                                                                set /a "cb=2"
                                                                                                                rem echo !cb!
                                                                                                                    
                                                                                                                set /a "cc=0"
                                                                                                                rem echo !cc!

                                                                                                                set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                                                rem echo !cr!
                                                                                                                )

                                                                                    if !formatvideo!==yuv420p10le  ( 
                                                                                                                    set /a "ca=72"
                                                                                                                    rem echo !ca!
                                                                                                                    
                                                                                                                    set /a "cb=2"
                                                                                                                    rem echo !cb!
                                                                                                                    
                                                                                                                    set /a "cc=0"
                                                                                                                    rem echo !cc!

                                                                                                                    set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                                                    rem echo !cr!
                                                                                                                    )                  
        
                                                                                
                                                                                    .\bin\ffmpeg -ss !secondi! -hide_banner -nostats -i %NomeFile% -vframes 10 -vf !cr! -f null - 2> ".\temp\crop.txt"
                                                                                    
                                                                                    findstr /r "Parsed_cropdetect_0" .\temp\crop.txt >> .\temp\risultato_multiplo.txt   
                                                                                    
                                                                                    echo !t12! %%a !t13! !secondi! !t14!
                                                                                    
                                                                                    )       
                                                                                       

                                                                                    for /f "tokens=1,2 delims==" %%a in (.\temp\risultato_multiplo.txt) do ( echo %%b >> .\temp\crop_multiplo.txt )
                                                                                    
                                                                                    set /a "maxfrequenza=0"

                                                                                    for /f "delims=" %%a in (.\temp\crop_multiplo.txt) do ( 
                                                                                                                                    set "cropconfront=%%a"
                                                                                                                                    rem echo "!cropconfront!"
                                                                                                                                    
                                                                                                                                    set /a "contatorfrequenza=0"
                                                                                                                                    for /f "delims=" %%b in (.\temp\crop_multiplo.txt) do (
                                                                                                                                                                                    set "dato_da_verificare=%%b"
                                                                                                                                                                                    rem echo cropconfront = "!cropconfront!"
                                                                                                                                                                                    rem echo dato_da_verificare = "!dato_da_verificare!"
                                                                                                                                                                                    if !cropconfront!==!dato_da_verificare! ( set /a "contatorfrequenza+=1")
                                                                                                                                                                                    )
                                                                                                                                    if !maxfrequenza! LSS !contatorfrequenza! ( 
                                                                                                                                                                                set /a "maxfrequenza=!!contatorfrequenza!!"
                                                                                                                                                                                set "cropd=!cropconfront!"
                                                                                                                                                                                )
                                                                                                                                    

                                                                                                                                    rem if !cropconfront! in (elenco_crop_frequenza.txt) ()
                                                                                                                                    rem echo !cropconfront!:!contatorfrequenza! >> elenco_crop_frequenza.txt

                                                                                                                                    )

                                                                                    rem echo crop piu' frequente = !cropd! con grequenza = !maxfrequenza!
                                                                                    echo !cropd! > .\temp\crop_finale.txt

                                                                                    for /f "tokens=1,2,3,4 delims=:" %%a in (.\temp\crop_finale.txt) do  ( 
                                                                                                                                                    rem set /a "mwidth=%%a"
                                                                                                                                                    rem echo mwidth = !mwidth!

                                                                                                                                                    rem set /a "mheight=%%b"
                                                                                                                                                    rem echo mheight = !mheight!

                                                                                                                                                    rem set /a "mx=%%c"
                                                                                                                                                    rem echo mx = !mx!

                                                                                                                                                    rem set /a "my=%%d"
                                                                                                                                                    rem echo my = !my!

                                                                                                                                                    if !contatore!==1 ( 
                                                                                                                                                                set /a "wmax=%%a" 
                                                                                                                                                                set /a "hmax=%%b"
                                                                                                                                                                set /a "xmin=%%c"
                                                                                                                                                                set /a "ymin=%%d"
                                                                                                                                                                set /a "mwidth=%%a"
                                                                                                                                                                set /a "mheight=%%b"
                                                                                                                                                                set /a "mx=%%c"
                                                                                                                                                                set /a "my=%%d"
                                                                                                                                                                set /a "contatore+=1"
                                                                                                                                                                )
                                                                                                                                                    
                                                                                                                                                    rem if %%b gtr !hmax! if %%c gtr !xmin! if %%d gtr !ymin! 

                                                                                                                                                    if %%a geq !wmax! if %%b geq !hmax! ( 
                                                                                                                                                                        set /a "wmax=%%a" 
                                                                                                                                                                        set /a "hmax=%%b"
                                                                                                                                                                        set /a "xmin=%%c"
                                                                                                                                                                        set /a "ymin=%%d"
                                                                                                                                                                        set /a "mwidth=%%a"
                                                                                                                                                                        set /a "mheight=%%b"
                                                                                                                                                                        set /a "mx=%%c"
                                                                                                                                                                        set /a "my=%%d"
                                                                                                                                                                        )
                                                                                                                                                    )
                                                                                    echo.
                                                                                    set /a "csup=!my!"
                                                                                    rem echo csup = !csup!
                                                                                                                                    
                                                                                    set /a "csin=!mx!"
                                                                                    rem echo csin = !csin!

                                                                                    set /a "cinf=!heightvideo!-!mheight!-!my!"
                                                                                    rem echo movieheightreal = !movieheightreal!
                                                                                    rem echo cinf = !cinf!
                                                                                    set /a "cdes=!widthvideo!-!mwidth!-!mx!"
                                                                                    rem echo cdes = !cdes!

                                                                                    echo Crop Settings: --crop !csin!,!csup!,!cdes!,!cinf!  
                                                                                    set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"  
                                                                                    echo.  
                                                                                    
                                                                                    set /a "mwidthc=(!widthvideo!-!csin!-!cdes!)/2*2"
                                                                                    set /a "mheightc=(!heightvideo!-!csup!-!cinf!)/2*2"


                                                                                    echo !t17!  !mwidthc! 
                                                                                    echo !t18!  !mheightc! 
                                                                                    echo.
                                                                                    
                                                                                    set /a "larghezza2160pnvenc=3840"
                                                                                    set /a "altezza2160pnvenc=2160"
                                                                                    @REM echo larghezza2160pnvenc = !larghezza2160pnvenc!                                    
                                                                                    @REM echo altezza2160pnvenc = !altezza2160pnvenc!     

                                                                                    set /a "differenzialelarghezza2160pnvenc=!larghezza2160pnvenc!-!mwidthc!"
                                                                                    set /a "differenzialealtezza2160pnvenc=!altezza2160pnvenc!-!mheightc!"
                                                                                    @REM echo differenzialelarghezza2160pnvenc = !differenzialelarghezza2160pnvenc!                                                                
                                                                                    @REM echo differenzialealtezza2160pnvenc = !differenzialealtezza2160pnvenc!

                                                                                    if !differenzialelarghezza2160pnvenc!==0 if !differenzialealtezza2160pnvenc! GTR 0 (
                                                                                                                                                                        @REM echo dentro il 1o if
                                                                                                                                                                        set /a "width4k=!mwidthc!"
                                                                                                                                                                        set /a "height4k=!mheightc!"
                                                                                                                                                                        )                        
                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                        if !differenzialelarghezza2160pnvenc! GTR 0 if !differenzialealtezza2160pnvenc!==0 (
                                                                                                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                                                                                                set /a "width4k=!mwidthc!"
                                                                                                                                                                                                                                                                set /a "height4k=!mheightc!"
                                                                                                                                                                                                                                                                ) else if !differenzialelarghezza2160pnvenc! LSS !differenzialealtezza2160pnvenc! (
                                                                                                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza2160pnvenc = !differenzialelarghezza2160pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza2160pnvenc = !differenzialealtezza2160pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                                                                                                        set /a "width4k=!mwidthc!+!differenzialelarghezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        set /a "height4k=!mheightc!+!differenzialelarghezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        @REM echo width4k = !width4k!
                                                                                                                                                                                                                                                                                                                                                        @REM echo height4k = !height4k!
                                                                                                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza2160pnvenc! GTR !differenzialealtezza2160pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "width4k=!mwidthc!+!differenzialealtezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo width4k = !width4k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "height4k=!mheightc!+!differenzialealtezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo height4k = !height4k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                        if !differenzialelarghezza2160pnvenc!==0 if !differenzialealtezza2160pnvenc!==0 (   
                                                                                                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                                                                                                        set /a "width4k=!mwidthc!"
                                                                                                                                                                                                                                                        set /a "height4k=!mheightc!"
                                                                                                                                                                                                                                                        )
                                                                                                                                                                                                                                                        
                                                                                                                                                                        if !differenzialelarghezza2160pnvenc!==!differenzialealtezza2160pnvenc! (   
                                                                                                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                                                                                                set /a "width4k=!mwidthc!+differenzialelarghezza2160pnvenc"
                                                                                                                                                                                                                                                set /a "height4k=!mheightc!+differenzialelarghezza2160pnvenc"
                                                                                                                                                                                                                                                )                                                                                        
                                                                                                                                                                

                                                                                                                                                                        echo !t19!
                                                                                                                                                                        echo.                         

                                                                                                                                                                        echo !t20!  !width4k! 
                                                                                                                                                                        echo !t21!  !height4k!    
                                                                                                                                                                        echo.

                                                                                                                                                                    ) 

                                                                                    ) 
                                                        )                          
                                                  

:cropmanuale_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set /a "csup=0"
set /a "cinf=0"
set /a "csin=0"
set /a "cdes=0"
set /a "bandasuperiore=0"
set /a "bandainferiore=0"
set /a "bandasinistra=0"
set /a "bandadestra=0"
set /a "differenzialelarghezza2160pnvenc=0"
set /a "differenzialealtezza2160pnvenc=0"
if exist ".\temp\Temp_HDR10_Stream.txt" ( del ".\temp\Temp_HDR10_Stream.txt" ) 
if exist ".\temp\durata_film.txt" ( del ".\temp\durata_film.txt" )
if exist ".\temp\crop.txt" ( del ".\temp\crop.txt" )
if exist ".\temp\risultato_multiplo.txt" ( del ".\temp\risultato_multiplo.txt" )
if exist ".\temp\crop_multiplo.txt" ( del ".\temp\crop_multiplo.txt" )
if exist ".\temp\crop_finale.txt" ( del ".\temp\crop_finale.txt" )


if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t22!"   
    if errorlevel 2 goto cropmanualeNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
    if errorlevel 1 goto finecropNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
)

CHOICE /N /C:SN /M "!t22!"   

if errorlevel 2 goto cropmanualeNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if errorlevel 1 goto finecropNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10


:cropmanualeNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
echo.
echo !t23!
echo.

:banda_superiore_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set /p "bandasuperiore=!t24!"
SET "var="&for /f "delims=0123456789" %%i in ("!bandasuperiore!") do set var=!bandasuperiore!
if defined var (
                echo.
                echo !t25!
                echo.
                goto banda_superiore_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
                ) else (
                        set /a "csup=!bandasuperiore!/2*2"
                        )

echo.
:banda_inferiore_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set /p "bandainferiore=!t26!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandainferiore!") do set var=!bandainferiore!
if defined var (
                echo.
                echo !t27!
                echo.
                goto banda_inferiore_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
                ) else (
                        set /a "cinf=!bandainferiore!/2*2"
                        )


echo.
:banda_inferiore_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set /p "bandasinistra=!t28!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandasinistra!") do set var=!bandasinistra!
if defined var (
                echo.
                echo !t29!
                echo.
                goto banda_inferiore_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
                ) else (
                        set /a "csin=!bandasinistra!/2*2"
                        )

                        
echo.
:banda_destra_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set /p "bandadestra=!t30!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandadestra!") do set var=!bandadestra!
if defined var (
                echo.
                echo !t31!
                echo.
                goto banda_destra_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
                ) else (
                        set /a "cdes=!bandadestra!/2*2"
                        )


set /a "larghezza2160pnvenc=3840"
set /a "altezza2160pnvenc=2160"
@REM echo larghezza2160pnvenc = !larghezza2160pnvenc!                                    
@REM echo altezza2160pnvenc = !altezza2160pnvenc!                                    

set /a "mwidth=!widthvideo!/2*2"
set /a "mheight=!heightvideo!/2*2"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "mwidthc=!mwidth!-!csin!-!cdes!"
set /a "mheightc=!mheight!-!csup!-!cinf!"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "differenzialelarghezza2160pnvenc=!larghezza2160pnvenc!-!mwidthc!"
set /a "differenzialealtezza2160pnvenc=!altezza2160pnvenc!-!mheightc!"
@REM echo differenzialelarghezza2160pnvenc = !differenzialelarghezza2160pnvenc!                                                                
@REM echo differenzialealtezza2160pnvenc = !differenzialealtezza2160pnvenc!

echo.
echo !t32!  !csup! 
echo !t33!  !cinf! 
echo !t34!  !csin! 
echo !t35!  !cdes! 
echo.


set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
echo Crop Settings: !cropff!
echo.

echo !t36!  !mwidthc! 
echo !t37!  !mheightc! 
echo.



if !differenzialelarghezza2160pnvenc!==0 if !differenzialealtezza2160pnvenc! GTR 0 (
                                                                                        @REM echo dentro il 1o if
                                                                                        set /a "width4k=!mwidthc!"
                                                                                        set /a "height4k=!mheightc!"
                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                        if !differenzialelarghezza2160pnvenc! GTR 0 if !differenzialealtezza2160pnvenc!==0 (
                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                set /a "width4k=!mwidthc!"
                                                                                                                                                                                set /a "height4k=!mheightc!"
                                                                                                                                                                                ) else if !differenzialelarghezza2160pnvenc! LSS !differenzialealtezza2160pnvenc! (
                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza2160pnvenc = !differenzialelarghezza2160pnvenc!
                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza2160pnvenc = !differenzialealtezza2160pnvenc!
                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                        set /a "width4k=!mwidthc!+!differenzialelarghezza2160pnvenc!"
                                                                                                                                                                                                                                                                        set /a "height4k=!mheightc!+!differenzialelarghezza2160pnvenc!"
                                                                                                                                                                                                                                                                        @REM echo width4k = !width4k!
                                                                                                                                                                                                                                                                        @REM echo height4k = !height4k!
                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza2160pnvenc! GTR !differenzialealtezza2160pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                set /a "width4k=!mwidthc!+!differenzialealtezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo width4k = !width4k!
                                                                                                                                                                                                                                                                                                                                                                set /a "height4k=!mheightc!+!differenzialealtezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo height4k = !height4k!
                                                                                                                                                                                                                                                                                                                                                                )
                                                                                        if !differenzialelarghezza2160pnvenc!==0 if !differenzialealtezza2160pnvenc!==0 (   
                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                        set /a "width4k=!mwidthc!"
                                                                                                                                                                        set /a "height4k=!mheightc!"
                                                                                                                                                                        )
                                                                                                                                                                        
                                                                                        if !differenzialelarghezza2160pnvenc!==!differenzialealtezza2160pnvenc! (   
                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                set /a "width4k=!mwidthc!+differenzialelarghezza2160pnvenc"
                                                                                                                                                                set /a "height4k=!mheightc!+differenzialelarghezza2160pnvenc"
                                                                                                                                                                )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.                         

                                                                                        echo !t20!  !width4k! 
                                                                                        echo !t21!  !height4k!    
                                                                                        echo.

                                                                                    ) 

goto cropmanuale_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:finecropNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10


rem//////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////


echo.
echo !t38!
echo.
echo 1) NVidia 
echo 2) Intel 
echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto ChoosenIntel_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if errorlevel 1 goto ChoosenNVidia_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:ChoosenIntel_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "SchedaGrafica=Intel"
@REM echo SchedaGrafica = !SchedaGrafica!
goto fineSceltaSchedaGrafica_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:ChoosenNVidia_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "SchedaGrafica=NVidia"
@REM echo SchedaGrafica = !SchedaGrafica!

:fineSceltaSchedaGrafica_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

@REM pause 

if !SchedaGrafica!==NVidia (
                                goto InserimentoImpostazioniNVEnc_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
                                ) 





if !SchedaGrafica!==Intel (
                                goto InserimentoImpostazioniQSVEnc_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
                                 )


@REM pause 


rem//////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////


:InserimentoImpostazioniNVEnc_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

echo.
echo !t40!
echo.
echo 1) CQP 
echo 2) VBR 
echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto CodificaVBRNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if errorlevel 1 goto CodificaCQPNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:CodificaVBRNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "TipoCodificaNVEnc=--vbr "
set /a "quantizzazioneNVEnc=0"
goto inserimentoValoriCQPVBRNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:CodificaCQPNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "TipoCodificaNVEnc=--cqp "
set /a "quantizzazioneNVEnc=1"

:inserimentoValoriCQPVBRNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

if !quantizzazioneNVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneNVEnc=!t44!" 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneNVEnc!") do set var=!valoreQuantizzazioneNVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                echo.
                                                goto inserimentoValoriCQPVBRNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
                                                ) 

                                set /a "valoreQuantizzazioneNVEnc=!valoreQuantizzazioneNVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneNVEnc!
                                if !valoreQuantizzazioneNVEnc! GEQ 10 if !valoreQuantizzazioneNVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneNVEnc!
                                                                                                                set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreQuantizzazioneNVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                                goto fineQuantizzazioneNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
                                                                                                                        
                                )



if !quantizzazioneNVEnc!==0 (
                                echo.
                                set /p "valoreBitRateNVEnc=!t46!" 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateNVEnc!") do set var=!valoreBitRateNVEnc!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                echo.
                                                goto inserimentoValoriCQPVBRNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
                                                ) 
                                set /a "valoreBitRateNVEnc=!valoreBitRateNVEnc!"
                                @REM echo valoreBitRateNVEnc = !valoreBitRateNVEnc!
                                if !valoreBitRateNVEnc! GEQ 100 if !valoreBitRateNVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateNVEnc!
                                                                                                        set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreBitRateNVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                        goto fineQuantizzazioneNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
                                                                                                              
                                )


:fineQuantizzazioneNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10


echo.
echo !t50!
echo.
echo 1) P1 !t51!
echo 2) P2 
echo 3) P3 
echo 4) P4 
echo 5) P5 
echo 6) P6 
echo 7) P7 !t52!
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto P7NVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if errorlevel 6 goto P6NVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if errorlevel 5 goto P5NVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if errorlevel 4 goto P4NVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if errorlevel 3 goto P3NVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if errorlevel 2 goto P2NVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if errorlevel 1 goto P1NVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10


:P7NVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "SettaggioQualitaNVEnc=--preset P7"
set "QualitySetting=P7"
goto fineQualitCodificaNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10 

:P6NVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "SettaggioQualitaNVEnc=--preset P6"
set "QualitySetting=P6"
goto fineQualitCodificaNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10 

:P5NVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "SettaggioQualitaNVEnc=--preset P5"
set "QualitySetting=P5"
goto fineQualitCodificaNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10 

:P4NVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "SettaggioQualitaNVEnc=--preset P4"
set "QualitySetting=P4"
goto fineQualitCodificaNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10 

:P3NVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "SettaggioQualitaNVEnc=--preset P3"
set "QualitySetting=P3"
goto fineQualitCodificaNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10 

:P2NVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "SettaggioQualitaNVEnc=--preset P2"
set "QualitySetting=P2"
goto fineQualitCodificaNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10 

:P1NVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "SettaggioQualitaNVEnc=--preset P1"
set "QualitySetting=P1"
goto fineQualitCodificaNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10 


:fineQualitCodificaNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10 
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaNVEnc!


echo.
echo !t71!
echo !t72!
echo.
echo 1) NVEnc Color Correction 
echo 2) LibPlacebo Color Correction 
echo 3) NVidia Color Correction 

echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto NVidiaColorCorrectionUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if errorlevel 2 goto LibPlaceboColorCorrectionUpGradingNVEnc_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10 
if errorlevel 1 goto NVEncColorCorrectionUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10 

:NVEncColorCorrectionUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10 
set "NVEncColorCorrectionSystem=--vpp-colorspace colorprim=bt709:bt2020,transfer=bt709:smpte2084,matrix=bt709:bt2020nc --vpp-tweak brightness=0.1,contrast=1.2,saturation=1.1"
set "NVEncUpgrader=NVEnc Color Correction"
goto NVEncFineSelezioneUpGrader_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:LibPlaceboColorCorrectionUpGradingNVEnc_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10 
set "NVEncColorCorrectionSystem=--vpp-libplacebo-tonemapping src_csp=sdr,dst_csp=hdr10"
set "NVEncUpgrader=LibPlacebo Color Correction"
goto NVEncFineSelezioneUpGrader_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:NVidiaColorCorrectionUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "NVEncColorCorrectionSystem=--vpp-ngx-truehdr"
set "NVEncUpgrader=NVidia Color Correction"

:NVEncFineSelezioneUpGrader_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
echo.
echo !t73! !NVEncUpgrader!
echo.
echo !t43! !NVEncColorCorrectionSystem!
echo.


:sceltadenoiser
set conv3d1080p=
set pmd1080p=
set /a unicopassaggio=0

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t55!"
    if errorlevel 2 goto conv3dChoosenNoNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
    if errorlevel 1 goto conv3dChoosenYesNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
)

echo.
CHOICE /N /C:SN /M "!t55!"

if errorlevel 2 goto conv3dChoosenNoNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if errorlevel 1 goto conv3dChoosenYesNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:conv3dChoosenNoNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "conv3d1080p=N"
goto sceltaDeniserPMDNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:conv3dChoosenYesNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "conv3d1080p=S"



:sceltaDeniserPMDNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t56!"
    if errorlevel 2 goto PMDChoosenNoNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
    if errorlevel 1 goto PMDChoosenYesNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
)

echo.
CHOICE /N /C:SN /M "!t56!"

if errorlevel 2 goto PMDChoosenNoNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if errorlevel 1 goto PMDChoosenYesNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:PMDChoosenNoNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "pmd1080p=N"
goto assegnazioneDenoisesNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:PMDChoosenYesNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "pmd1080p=S"


:assegnazioneDenoisesNVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set /A nvdenv=0

if !conv3d1080p!==S if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00 --vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==S if !pmd1080p!==N ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==N ( 
                                        set "nvdenoiser=nessuno" 
                                        set "nvdenv=1"
                                        set "unicopassaggio=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: Nessun Denoiser 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )


echo.
if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t57!"
    if errorlevel 2 goto ApplicaMiglioramentoDettagliNVEncNo_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
    if errorlevel 1 goto ApplicaMiglioramentoDettagliNVEncSi_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
)
CHOICE /N /C:SN /M "!t57!"

if errorlevel 2 goto ApplicaMiglioramentoDettagliNVEncNo_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if errorlevel 1 goto ApplicaMiglioramentoDettagliNVEncSi_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:ApplicaMiglioramentoDettagliNVEncNo_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "miglioramento1080p=N"
goto fineSceltaMigliaramentiNVEnc_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:ApplicaMiglioramentoDettagliNVEncSi_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "miglioramento1080p=S"

:fineSceltaMigliaramentiNVEnc_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if !miglioramento1080p!==S ( 
                                set "edgeleveling=--vpp-edgelevel strength=10.0,threshold=24.0,black=6,white=0" 
                                echo.
                                echo NVEnc !t58!
                                echo.
                                )
if !miglioramento1080p!==N ( 
                                set "edgeleveling=nessuno" 
                                echo.
                                echo NVEnc !t59!
                                echo.
                                )



set file_senza_virgolette=!NomeFile:"=!
rem echo %file_senza_virgolette%

set file_senza_estensione=!file_senza_virgolette:.mkv=!
rem echo %file_senza_estensione%

set fileoutput2160p="!file_senza_estensione!_2160p_10bit_HDR.mkv"
rem echo fileoutput2160p = %fileoutput2160p%

echo.
set "VideoInfoCodifica=NVEnc_da_2160p_8bit_o_10bit_sdr_a_2160p_10bit_hdr|!NomeFile!|!fileoutput2160p!|nessuno|!cropff!|!width4k!x!height4k!|nessuna|nessuno|!colorpr!|!colortr!|!colorsp!|!tipoQuantizzazioneNVEnc!|!SettaggioQualitaNVEnc!|nessuno|nessuno|!nvdenoiser!|!formatvideo!|!edgeleveling!|!NVEncColorCorrectionSystem!|no_numero_passaggi_upscaling|no_lokahead|no_precisione_vettore_movimento"
@REM echo VideoInfoCodifica = !VideoInfoCodifica!
@REM echo.

if exist ".\saved\savedmoviesallencodings.dat" ( 
                                                echo !VideoInfoCodifica! >> .\saved\savedmoviesallencodings.dat
                                                goto LibPlaceboColorCorrectionUpGradingQSVEnc_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10 
                                                ) 

echo !VideoInfoCodifica! > .\saved\savedmoviesallencodings.dat


:LibPlaceboColorCorrectionUpGradingQSVEnc_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10 

echo !t60! !numeromovie! !t61!
echo.

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t62!"
    if errorlevel 2 goto finesceltanuovovideodacodificareNVEnc_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
    if errorlevel 1 goto altrivideodainserireMenuNVEnc_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
)

CHOICE /N /C:SN /M "!t62!"
echo.

if errorlevel 2 goto finesceltanuovovideodacodificareNVEnc_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if errorlevel 1 goto altrivideodainserireMenuNVEnc_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:altrivideodainserireMenuNVEnc_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set /a "numeromovie+=1"
echo.
goto altrivideodainserire_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:finesceltanuovovideodacodificareNVEnc_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
echo.
goto fineinfovideo_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10


rem//////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////






rem//////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////


:InserimentoImpostazioniQSVEnc_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10


echo.
echo !t40!
echo.
echo 1) CQP 
echo 2) ICQ 
echo 3) LA-ICQ 
echo 4) VBR 
echo.
CHOICE /N /C:1234 /M "!t64!"

if errorlevel 4 goto CodificaVBRQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if errorlevel 3 goto CodificaLAICQQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if errorlevel 2 goto CodificaICQQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if errorlevel 1 goto CodificaCQPQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10


:CodificaCQPQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "TipoCodificaQSVEnc=--cqp "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:CodificaICQQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "TipoCodificaQSVEnc=--icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:CodificaLAICQQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "TipoCodificaQSVEnc=--la-icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:CodificaVBRQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "TipoCodificaQSVEnc=--vbr "
set /a "quantizzazioneQSVEnc=0"
goto inserimentoValoriCQPVBRQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10


:inserimentoValoriCQPVBRQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

if !quantizzazioneQSVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneQSVEnc=!t44!" 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneQSVEnc!") do set var=!valoreQuantizzazioneQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                echo.
                                                goto inserimentoValoriCQPVBRQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
                                                ) 

                                set /a "valoreQuantizzazioneQSVEnc=!valoreQuantizzazioneQSVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneQSVEnc!
                                if !valoreQuantizzazioneQSVEnc! GEQ 10 if !valoreQuantizzazioneQSVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneQSVEnc!
                                                                                                                set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreQuantizzazioneQSVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                                goto fineQuantizzazioneQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
                                                                                                                        
                                )



if !quantizzazioneQSVEnc!==0 (
                                echo.
                                set /p "valoreBitRateQSVEnc=!t46! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateQSVEnc!") do set var=!valoreBitRateQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                echo.
                                                goto inserimentoValoriCQPVBRQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
                                                ) 
                                set /a "valoreBitRateQSVEnc=!valoreBitRateQSVEnc!"
                                @REM echo valoreBitRateQSVEnc = !valoreBitRateQSVEnc!
                                if !valoreBitRateQSVEnc! GEQ 100 if !valoreBitRateQSVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateQSVEnc!
                                                                                                        set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreBitRateQSVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                        goto fineQuantizzazioneQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
                                                                                                              
                                )


:fineQuantizzazioneQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10



echo.
echo !t50!
echo.
echo 1) Best 
echo 2) Higher 
echo 3) High 
echo 4) Balanced 
echo 5) Fast 
echo 6) Faster 
echo 7) Fastest 
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto QualitFastestQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if errorlevel 6 goto QualitFasterQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if errorlevel 5 goto QualitFastQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if errorlevel 4 goto QualitBalancedtQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if errorlevel 3 goto QualitHighQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if errorlevel 2 goto QualitHigherQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if errorlevel 1 goto QualitBestQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10


:QualitBestQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "SettaggioQualitaQSvenc=--quality best"
set "QualitySetting=best"
goto fineQualitCodificaQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:QualitHigherQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "SettaggioQualitaQSvenc=--quality higher"
set "QualitySetting=higher"
goto fineQualitCodificaQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:QualitHighQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "SettaggioQualitaQSvenc=--quality high"
set "QualitySetting=high"
goto fineQualitCodificaQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:QualitBalancedtQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "SettaggioQualitaQSvenc=--quality balanced"
set "QualitySetting=balanced"
goto fineQualitCodificaQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:QualitFastQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "SettaggioQualitaQSvenc=--quality fast"
set "QualitySetting=fast"
goto fineQualitCodificaQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:QualitFasterQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "SettaggioQualitaQSvenc=--quality faster"
set "QualitySetting=faster"
goto fineQualitCodificaQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:QualitFastestQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "SettaggioQualitaQSvenc=--quality fastest"
set "QualitySetting=fastest"
goto fineQualitCodificaQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10


:fineQualitCodificaQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaQSvenc!




echo.
echo !t71!
echo !t72!
echo.
echo 1) QSVEnc Color Correction 
echo 2) LibPlacebo Color Correction 

echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto LibPlaceboColorCorrectionUpGradingQSVEnc_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if errorlevel 1 goto QSVEncColorCorrectionUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10


:QSVEncColorCorrectionUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "QSVEncColorCorrectionSystem=--vpp-colorspace colorprim=bt709:bt2020,transfer=bt709:smpte2084,matrix=bt709:bt2020nc --vpp-tweak brightness=0.1,contrast=1.2,saturation=1.1"
set "QSVEncUpgrader=QSVEnc Color Correction"
goto QSVEncFineSelezioneUpGrader2_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:LibPlaceboColorCorrectionUpGradingQSVEnc_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "QSVEncColorCorrectionSystem=--vpp-libplacebo-tonemapping src_csp=sdr,dst_csp=hdr10"
set "QSVEncUpgrader=LibPlacebo Color Correction"


:QSVEncFineSelezioneUpGrader2_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
echo.
echo !t73! !QSVEncUpgrader!
echo.
echo !t43! !QSVEncColorCorrectionSystem!



:sceltadenoiser
set conv3d1080p=
set pmd1080p=
set /a unicopassaggio=0


if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t55!"
    if errorlevel 2 goto conv3dChoosenNoQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
    if errorlevel 1 goto conv3dChoosenYesQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
)

echo.
CHOICE /N /C:SN /M "!t55!

if errorlevel 2 goto conv3dChoosenNoQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if errorlevel 1 goto conv3dChoosenYesQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:conv3dChoosenNoQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "conv3d1080p=N"
goto sceltaDeniserPMDQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:conv3dChoosenYesQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "conv3d1080p=S"



:sceltaDeniserPMDQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t56!"
    if errorlevel 2 goto PMDChoosenNoQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
    if errorlevel 1 goto PMDChoosenYesQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
)
echo.
CHOICE /N /C:SN /M "!t56!"

if errorlevel 2 goto PMDChoosenNoQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if errorlevel 1 goto PMDChoosenYesQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:PMDChoosenNoQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "pmd1080p=N"
goto assegnazioneDenoisesQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:PMDChoosenYesQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "pmd1080p=S"


:assegnazioneDenoisesQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set /A nvdenv=0

if !conv3d1080p!==S if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00 --vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==S if !pmd1080p!==N ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==N ( 
                                        set "nvdenoiser=nessuno" 
                                        set "nvdenv=1"
                                        set "unicopassaggio=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: Nessun Denoiser 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )


if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t57!"
    if errorlevel 2 goto ApplicaMiglioramentoDettagliQSVEncNo_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
    if errorlevel 1 goto ApplicaMiglioramentoDettagliQSVEncSi_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
)

echo.
CHOICE /N /C:SN /M "!t57!"

if errorlevel 2 goto ApplicaMiglioramentoDettagliQSVEncNo_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if errorlevel 1 goto ApplicaMiglioramentoDettagliQSVEncSi_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:ApplicaMiglioramentoDettagliQSVEncNo_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "miglioramento1080p=N"
goto fineSceltaMigliaramentiQSVEnc_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:ApplicaMiglioramentoDettagliQSVEncSi_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set "miglioramento1080p=S"

:fineSceltaMigliaramentiQSVEnc_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if !miglioramento1080p!==S ( 
                                set "edgeleveling=--vpp-edgelevel strength=10.0,threshold=24.0,black=6,white=0" 
                                echo.
                                echo QSVEnc !t58!
                                echo.
                                )
if !miglioramento1080p!==N ( 
                                set "edgeleveling=nessuno" 
                                echo.
                                echo QSVEnc !t59!
                                echo.
                                )



set file_senza_virgolette=!NomeFile:"=!
rem echo %file_senza_virgolette%

set file_senza_estensione=!file_senza_virgolette:.mkv=!
rem echo %file_senza_estensione%

set fileoutput2160p="!file_senza_estensione!_2160p_10bit_HDR.mkv"
rem echo fileoutput2160p = %fileoutput2160p%

echo.
set "VideoInfoCodifica=QSVEnc_da_2160p_8bit_o_10bit_sdr_a_2160p_10bit_hdr|!NomeFile!|!fileoutput2160p!|nessuno|!cropff!|!width4k!x!height4k!|nessuna|nessuno|!colorpr!|!colortr!|!colorsp!|!tipoQuantizzazioneQSVEnc!|!SettaggioQualitaQSVEnc!|nessuno|nessuno|!nvdenoiser!|!formatvideo!|!edgeleveling!|!QSVEncColorCorrectionSystem!|no_numero_passaggi_upscaling|no_lokahead|no_precisione_vettore_movimento"
@REM echo VideoInfoCodifica = !VideoInfoCodifica!
@REM echo.

if exist ".\saved\savedmoviesallencodings.dat" ( 
                                                echo !VideoInfoCodifica! >> .\saved\savedmoviesallencodings.dat
                                                goto LibPlaceboColorCorrectionUpGradingQSVEnc_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10 
                                                ) 

echo !VideoInfoCodifica! > .\saved\savedmoviesallencodings.dat


:LibPlaceboColorCorrectionUpGradingQSVEnc_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10 

echo !t60! !numeromovie! !t61!
echo.

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t62!"
    if errorlevel 2 goto finesceltanuovovideodacodificareQSVEnc_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
    if errorlevel 1 goto altrivideodainserireMenuQSVEnc_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
)

CHOICE /N /C:SN /M "!t62!"
echo.

if errorlevel 2 goto finesceltanuovovideodacodificareQSVEnc_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if errorlevel 1 goto altrivideodainserireMenuQSVEnc_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:altrivideodainserireMenuQSVEnc_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
set /a "numeromovie+=1"
echo.
goto altrivideodainserire_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10

:finesceltanuovovideodacodificareQSVEnc_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
echo.
goto fineinfovideo_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10



goto fineinfovideo_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10




:novideofile2160p_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
echo !t63!
echo.


:fineinfovideo_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10


if exist ".\temp\Temp_HDR10_Stream.txt" ( del .\temp\Temp_HDR10_Stream.txt )
if exist ".\temp\durata_film.txt" ( del .\temp\durata_film.txt )
if exist ".\temp\crop.txt" ( del .\temp\crop.txt )
if exist ".\temp\risultato_multiplo.txt" ( del .\temp\risultato_multiplo.txt )
if exist ".\temp\crop_multiplo.txt" ( del .\temp\crop_multiplo.txt )
if exist ".\temp\crop_finale.txt" ( del .\temp\crop_finale.txt )
      




set waitenter=
set /P waitenter=!t65!
Endlocal
goto InserimentoCodifcaInCodaeSalvataggioSuDisco







rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:InserimentoCodificaHardwareUpScalingda1080p10bitHDRa2160p10bitHDR10

cls
setLocal EnableExtensions EnableDelayedExpansion



for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoInserimentoCodificaHardwareUpScalingda1080p10bitHDRa2160p10bitHDR10
)

if %lingua%==inglese (
    goto caricalinguaingleseInserimentoCodificaHardwareUpScalingda1080p10bitHDRa2160p10bitHDR10
)



:caricalinguaingleseInserimentoCodificaHardwareUpScalingda1080p10bitHDRa2160p10bitHDR10
set t1=Insert Hardware Video Encoding Info UpScaling from 1080p 10 bit HDR to 2160p 10 bit HDR and Saving to Disk

set t2=Drag Here the
set t211=Video File 1080p 10 bit HDR to Convert to 2160p 10 bit HDR:  

set t3=File does not exist 
set t4=Info Video:  

set t5=The Inserted Video is 1080p 10bit HDR 
@REM set t511=The Inserted Video is 2160p 10bit SDR 

set t6=The Inserted Video isn't 1080p 10bit HDR 
set t7=Video Duration in seconds:
set t8=Video Duration in Minutes:
set t9=Interval between Frames for Crop Detection:
set t10= seconds
set t11=Black Bands Detection Started....
set t12=Crop Detection to Frame
set t13=to seconds
set t14=Done...
set t15=Original 2160p Video Width: 
set t16=Original 2160p Video Height:
set t17=Original Video 1080p Width Without Black Bars:
set t18=Original Video 1080p Height Without Black Bars:

set t171=Output Video 1080p Width Without Black Bars:
set t181=Outout Video 1080p Height Without Black Bars:

set t19=Adapting Video Resolution to Full 1080p Format...

set t191=Final 1080p Output Video Width:
set t192=Final 1080p Output Video Height:
set t20=Final 2160p Output Video Width:
set t21=Final 2160p Output Video Height:

set t22=Settings of Black Bands to Crop are Correct (Yes/No):
set t23=Manually Entering Black Band Values to Crop... 
set t24=Enter the Upper Black Band Value: 
set t25=Error Entering Upper Black Band Value... It's Not a Number. 
set t26=Enter the Lower Black Band Value: 
set t27=Error Entering Lower Black Band Value... It's Not a Number.
set t28=Enter the Left Black Band Value: 
set t29=Error Entering Left Black Band Value... It's Not a Number.
set t30=Enter the Right Black Band Value: 
set t31=Error Entering Right Black Band Value... It's Not a Number.
set t32=Upper Black Band:
set t33=Lower Black Band:
set t34=Left Black Band:
set t35=Right Black Band:
set t36=2160p Original Video Width without Black Bars:
set t37=2160p Original Video Height without Black Bars:

@REM set t361=1080p Video Width without Black Bars:
@REM set t371=1080p Video Height without Black Bars

set t38=Select Graphic Card you want to Encode with:
set t39=Choose (1/2):
set t40=Select Encoding Type:
set t41=Error Entering Quantization Value... Not a Number. 
set t42=Quantization Value Set to:
set t43=Encoding Settings:
set t44=Enter Quantization value Minimum 10 Maximum 28:
set t45=Quantization Value Out of  Limits  10 / 28  Re-enter^!
set t46=Enter BitRate Value kbs Minimum 100 Maximum 50000:
set t47=Error Entering BitRate Value... It's Not a Number. 
set t48=BitRate Value Set to:
set t49=BitRate Value Out of Limits  100 / 50000  Re-enter^!
set t50=Select Encoding Quality:
set t51=- Worst Quality
set t52=- Best Quality
set t53=Choose (1/2/3/4/5/6/7):
set t54=Quality Set to:
set t55=Apply Convolution3D denoiser Yes/No: 
set t56=Apply PMD denoiser Yes/No: 
set t57=Apply Detail Enhancement Yes/No:  
set t58=Enhancement Detail: Yes 
set t59=Enhancement Detail: No 
set t60=Info
set t61=Videos to Encode Saved!
set t62=Do You Want to Insert Another Video to Encode (Yes/No):
set t63=The dragged file is not a video!
set t64=Choose (1/2/3/4):
set t65=Press Enter toback to Menu Inserting Encoding into the Queue and Saving to Disk:  

set t66=Video Width
set t67=Video Height
set t68=Video Codec
set t69=Details Video Codec
set t70=Video Format 
set t71=Configuration Settings to convert video from 8bit or 10bit SDR to 10bit HDR
set t72=Select Encoding UpGrader:
set t73=Settings UpGrader:
set t74=Choose (1/2/3):

set t75=Configuration UpScaling from 1080p 10 bit HDR to 2160p 10 bit HDR 
set t76=Select Operations to Perform:
set t77=1) First Pass Encode for Upscaling and a Second Pass Encode to Clean Up the Video and Enhance Details
set t78=2) Cleanup, Detail Enhancement and Upscaling in a Single Encode

goto avvio_InserimentoCodificaHardwareUpScalingda1080p10bitHDRa2160p10bitHDR10




:caricalinguaitalianoInserimentoCodificaHardwareUpScalingda1080p10bitHDRa2160p10bitHDR10
set t1=Inserimento Info Codifica Hardware Video UpScaling da 1080p 10 bit HDR a 2160p 10 bit HDR e Salvataggio su Disco.

set t2=Trascina Qui il 
set t211=File Video 1080p 10 bit HDR da Convertire in 2160p 10 bit HDR:  

set t3=File Inesistente 
set t4=Informazioni Video:  

set t5=Il Video inserito e' 1080p 10bit HDR 
@REM set t511=Il Video inserito e' 2160p 10bit SDR 

set t6=Il Video inserito non e' 1080p 10bit HDR 

set t7=Durata del Video in secondi:
set t8=Durata del video in Minuti:
set t9=Intervallo tra i Fotogrammi per il Rilevamento del crop:
set t10= secondi
set t11=Rilevamento Bande Nere Iniziato....
set t12=Rilevazione crop fotogramma
set t13=a secondi
set t14=Eseguita...
set t15=Larghezza Video 2160p Originale:
set t16=Altezza Video 2160p Originale:
set t17=Larghezza Video Originale 1080p  Senza Barre Nere:
set t18=Altezza Video Originale 1080p  Senza Barre Nere:

set t171=Larghezza Video 1080p  Senza Barre Nere:
set t181=Altezza Video 1080p  Senza Barre Nere:

set t19=Adattamento della Risoluzione del Video al Pieno Formato 1080p..

set t191=Larghezza Finale Video 1080p:
set t192=Altezza Finale Video 1080p:
set t20=Larghezza Finale Video 2160p:
set t21=Altezza Finale Video 2160p:

set t22=Le Impostazioni delle Bande Nere da Tagliare sono Corrette (Si/No):
set t23=Inserimento Manuale Valori Bande Nere da Tagliare.. 
set t24=Inserisci il Valore della Banda Nera Superiore: 
set t25=Errore nell'Inserimento del Valore della Banda Nera Superiore... Non e' un Numero. 
set t26=Inserisci il Valore della Banda Nera Inferiore: 
set t27=Errore nell'Inserimento del Valore della Banda Nera Inferiore... Non e' un Numero. 
set t28=Inserisci il Valore della Banda Nera Sinistra: 
set t29=Errore nell'Inserimento del Valore della Banda Nera Sinistra... Non e' un Numero. 
set t30=Inserisci il Valore della Banda Nera Destra: 
set t31=Errore nell'Inserimento del Valore della Banda Nera Destra... Non e' un Numero. 
set t32=Banda Nera Superiore:
set t33=Banda Nera Inferiore:
set t34=Banda Nera Sinistra:
set t35=Banda Nera Destra:
set t36=Larghezza Video Originale 2160p senza Bande Nere:
set t37=Altezza Video Originale 2160p senza Bande Nere:

@REM set t361=Larghezza Video 1080p senza Bande Nere:
@REM set t371=Altezza Video 1080p senza Bande Nere:

set t38=Selezionare Scheda Grafica con cui Eseguire la Codifica:
set t39=Scegli (1/2):
set t40=Selezionare tipo di Codifica:
set t41=Errore nell'Inserimento del Valore della Quantizzazione... Non e' un Numero. 
set t42=Valore Quantizzazzione Impostato a:
set t43=Parametri per codifica:

set t44=Inserire Valore Quantizzazione Minimo 10 Massimo 28:
set t45=Valore Quantizzazzione al di fuori dei  Limiti  10 / 28  Reinserire^!
set t46=Inserire Valore BitRate kbs Minimo 100 Massimo 50000:
set t47=Errore nell'Inserimento del Valore del BitRate... Non e' un Numero. 
set t48=Valore BitRate Impostato a:
set t49=Valore  BitRate al di fuori dei  Limiti  100 / 50000  Reinserire^!

set t50=Selezionare Qualita' Codifica:
set t51=- Peggiore Qualita'
set t52=- Migliore Qualita'
set t53=Scegli (1/2/3/4/5/6/7):
set t54=Qualita' Impostata su:
set t55=Applicare il denoiser Convolution3D Si/No: 
set t56=Applicare il denoiser PMD Si/No: 
set t57=Applicare il Miglioramento Dettagli Si/No:  
set t58=Miglioramento Dettagli: Si 
set t59=Miglioramento Dettagli: No 
set t60=Informazioni
set t61=Video da Codificare Salvate!
set t62=Vuoi Inserire un altro Video da Codificare (Si/No):
set t63=Il file trascinato non e' un video!
set t64=Scegli (1/2/3/4):
set t65=Premi Invio per tornare al menu' Inserimento Codifiche in Coda e Salvataggio sul Disco:  

set t66=Larghezza Video
set t67=Altezza Video
set t68=Codec Video
set t69=Codec Video Dettagli
set t70=Format Video 
set t71=Configurazione Parametri per convertire il video da 8bit o 10bit SDR a 10bit HDR
set t72=Selezionare UpGrader Codifica:
set t73=UpGrader Impostato:
set t74=Scegli (1/2/3):

set t75=Configurazione Operazione di UpScaling da 1080p 10 bit HDR a 2160p 10 bit HDR 
set t76=Selezionare Operazioni da Eseguire:
set t77=1) Fare Prima Codifica per UpScaling e Seconda Codifica per Ripulire il Video e Migliorare i Dettagli
set t78=2) Ripulire, Migliorare i Dettagli e Upscaling in un Unica Codifica 


goto avvio_InserimentoCodificaHardwareUpScalingda1080p10bitHDRa2160p10bitHDR10

:avvio_InserimentoCodificaHardwareUpScalingda1080p10bitHDRa2160p10bitHDR10




set /a "numeromovie=1"


echo !t1!
echo.


:altrivideodainserire_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10


set NomeFile2160ppuliziadettaggli=
rem set MetadatiStreamHDR10=

set /P NomeFile2160ppuliziadettaggli=!t2! !numeromovie! !t211! 
rem echo Hai digitato: %NomeFile%
rem pause

set "NomeFileSorgente=!NomeFile2160ppuliziadettaggli:"=!"
@REM echo NomeFileSorgente = !NomeFileSorgente!
set "NomeFile=^"!NomeFileSorgente!^""
@REM echo NomeFile = !NomeFile!
rem pause


if exist !NomeFile! ( goto infovideo_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10 ) else ( 
                                                        echo.
                                                        echo !t3!
                                                        echo.
                                                        goto fineinfovideo_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
                                                        )    

:infovideo_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
echo.
echo !t4!
echo.

.\bin\ffprobe -v error -hide_banner -select_streams v:0 -show_entries stream=width,height,codec_name,codec_long_name,pix_fmt,color_space,color_transfer,color_primaries -of default=noprint_wrappers=1 !NomeFile! > ".\temp\Temp_HDR10_Stream.txt"

set /A x1=1
set /A nohdrcs=0
set /A nohdrct=0
set /A nohdrcp=0
set /A wv=0
set /a hv=0
set /A fv=0

rem echo nohdr = %nohdr%

for /f "tokens=1,2 delims==" %%a in (.\temp\Temp_HDR10_Stream.txt) do (if !x1!==3 ( 
                                                                            echo !t66! "%%a" = %%b  
                                                                            set /A "widthvideo=%%b"
                                                                            rem echo widthvideo = !widthvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !widthvideo! LEQ 1920 if !widthvideo! GEQ 1000 (set /A "wv=1"
                                                                                                                                rem echo wv = !wv!
                                                                                                                                )
                                                                            )
                                                                if !x1!==4 ( 
                                                                            echo !t67! "%%a" = %%b  
                                                                            set /A "heightvideo=%%b"
                                                                            rem echo heightvideo = !heightvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !heightvideo! LEQ 1080 if !heightvideo! GEQ 700 (set /A "hv=1"
                                                                                                        rem echo hv = !hv!
                                                                                                        )
                                                                            )                                                           
                                                                if !x1!==6 ( 
                                                                            echo Color Space "%%a" = %%b  
                                                                            set "colorsp=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colorsp!==bt2020nc (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorsp!==unknown (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorsp!==reserved (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                    
                                                                            ) 
                                                                if !x1!==7 ( 
                                                                            echo Color Transfer "%%a" = %%b  
                                                                            set "colortr=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colortr!==smpte2084 (set /A "nohdrct=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                 
                                                                            ) 
                                                                if !x1!==8 ( 
                                                                            echo Color Primaries "%%a" = %%b  
                                                                            set "colorpr=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colorpr!==bt2020 (set /A "nohdrcp=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            )    
                                                                if !x1!==1 ( 
                                                                            echo !t68! "%%a" = %%b  
                                                                            )       
                                                                if !x1!==2 ( 
                                                                            echo !t69! "%%a" = %%b  
                                                                            )   
                                                                if !x1!==5 ( 
                                                                            echo !t70! "%%a" = %%b  
                                                                            set "formatvideo=%%b"
                                                                            rem echo formatvideo = !formatvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !formatvideo!==yuv420p10le (set /A "fv=1"
                                                                                                        rem echo fv = !fv!
                                                                                                        )
                                                                            )
                                                                set /A x1+=1                                                            
)
echo.

if !x1!==1 goto :novideofile1080p_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10


if !nohdrcs!==1 if !nohdrct!==1 if !nohdrcp!==1 if !wv!==1 if !hv!==1 if !fv!==1 ( 
                                                                                   echo !t5!
                                                                                   echo. 
                                                                                   goto rilevazionebandenere_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
                                                                                   ) 


echo !t6!
echo.
goto fineinfovideo_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10



:rilevazionebandenere_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

.\bin\ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 %NomeFile%  > ".\temp\durata_film.txt"


set /a contatore=1
for /f "tokens=1 delims=." %%a in (.\temp\durata_film.txt) do  (
                                                        echo. 
                                                        echo !t7! %%a
                                                        set /a "secondi=%%a"
                                                        set /a "minuti=!secondi!/60"
                                                        echo !t8! !minuti!
                                                        set /a "intervallo_tagli=!secondi!/11"
                                                        echo !t9! !intervallo_tagli!!t10!
                                                        echo.
                                                        echo !t11!
                                                        echo.

                                                        

                                                        FOR /L %%a IN (1, 1, 10) DO (
                                                                                    rem echo %%a
                                                                                    set /a "secondi=%%a*!intervallo_tagli!"
                                                                                    rem echo !secondi!

                                                                                    
                                                                                    set /a "ca=72"
                                                                                    rem echo !ca!
                                                                                                                    
                                                                                    set /a "cb=2"
                                                                                    rem echo !cb!
                                                                                                                    
                                                                                    set /a "cc=0"
                                                                                    rem echo !cc!

                                                                                    set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                    rem echo !cr!

                                                                                    .\bin\ffmpeg -ss !secondi! -hide_banner -nostats -i %NomeFile% -vframes 10 -vf !cr! -f null - 2> ".\temp\crop.txt"
                                                                                    
                                                                                    findstr /r "Parsed_cropdetect_0" .\temp\crop.txt >> .\temp\risultato_multiplo.txt   
                                                                                    
                                                                                    echo !t12! %%a !t13! !secondi! !t14!
                                                                                    
                                                                                    )       
                                                                                       

                                                                                    for /f "tokens=1,2 delims==" %%a in (.\temp\risultato_multiplo.txt) do ( echo %%b >> .\temp\crop_multiplo.txt )
                                                                                    
                                                                                    set /a "maxfrequenza=0"

                                                                                    for /f "delims=" %%a in (.\temp\crop_multiplo.txt) do ( 
                                                                                                                                    set "cropconfront=%%a"
                                                                                                                                    rem echo "!cropconfront!"
                                                                                                                                    
                                                                                                                                    set /a "contatorfrequenza=0"
                                                                                                                                    for /f "delims=" %%b in (.\temp\crop_multiplo.txt) do (
                                                                                                                                                                                    set "dato_da_verificare=%%b"
                                                                                                                                                                                    rem echo cropconfront = "!cropconfront!"
                                                                                                                                                                                    rem echo dato_da_verificare = "!dato_da_verificare!"
                                                                                                                                                                                    if !cropconfront!==!dato_da_verificare! ( set /a "contatorfrequenza+=1")
                                                                                                                                                                                    )
                                                                                                                                    if !maxfrequenza! LSS !contatorfrequenza! ( 
                                                                                                                                                                                set /a "maxfrequenza=!!contatorfrequenza!!"
                                                                                                                                                                                set "cropd=!cropconfront!"
                                                                                                                                                                                )
                                                                                                                                    

                                                                                                                                    rem if !cropconfront! in (elenco_crop_frequenza.txt) ()
                                                                                                                                    rem echo !cropconfront!:!contatorfrequenza! >> elenco_crop_frequenza.txt

                                                                                                                                    )

                                                                                    rem echo crop piu' frequente = !cropd! con grequenza = !maxfrequenza!
                                                                                    echo !cropd! > .\temp\crop_finale.txt

                                                                                    for /f "tokens=1,2,3,4 delims=:" %%a in (.\temp\crop_finale.txt) do  ( 
                                                                                                                                                    rem set /a "mwidth=%%a"
                                                                                                                                                    rem echo mwidth = !mwidth!

                                                                                                                                                    rem set /a "mheight=%%b"
                                                                                                                                                    rem echo mheight = !mheight!

                                                                                                                                                    rem set /a "mx=%%c"
                                                                                                                                                    rem echo mx = !mx!

                                                                                                                                                    rem set /a "my=%%d"
                                                                                                                                                    rem echo my = !my!

                                                                                                                                                    if !contatore!==1 ( 
                                                                                                                                                                set /a "wmax=%%a" 
                                                                                                                                                                set /a "hmax=%%b"
                                                                                                                                                                set /a "xmin=%%c"
                                                                                                                                                                set /a "ymin=%%d"
                                                                                                                                                                set /a "mwidth=%%a"
                                                                                                                                                                set /a "mheight=%%b"
                                                                                                                                                                set /a "mx=%%c"
                                                                                                                                                                set /a "my=%%d"
                                                                                                                                                                set /a "contatore+=1"
                                                                                                                                                                )
                                                                                                                                                    
                                                                                                                                                    rem if %%b gtr !hmax! if %%c gtr !xmin! if %%d gtr !ymin! 

                                                                                                                                                    if %%a geq !wmax! if %%b geq !hmax! ( 
                                                                                                                                                                        set /a "wmax=%%a" 
                                                                                                                                                                        set /a "hmax=%%b"
                                                                                                                                                                        set /a "xmin=%%c"
                                                                                                                                                                        set /a "ymin=%%d"
                                                                                                                                                                        set /a "mwidth=%%a"
                                                                                                                                                                        set /a "mheight=%%b"
                                                                                                                                                                        set /a "mx=%%c"
                                                                                                                                                                        set /a "my=%%d"
                                                                                                                                                                        )
                                                                                                                                                    )
                                                                                    echo.
                                                                                    
                                                                                    set /a "mwidth=!mwidth!/2*2"
                                                                                    set /a "mheight=!mheight!/2*2"

                                                                                    set /a "csup=!my!/2*2"
                                                                                    rem echo csup = !csup!
                                                                                                                                    
                                                                                    set /a "csin=!mx!/2*2"
                                                                                    rem echo csin = !csin!

                                                                                    set /a "cinf=(!heightvideo!-!mheight!-!my!)/2*2"
                                                                                    rem echo movieheightreal = !movieheightreal!
                                                                                    rem echo cinf = !cinf!
                                                                                    set /a "cdes=(!widthvideo!-!mwidth!-!mx!)/2*2"
                                                                                    rem echo cdes = !cdes!

                                                                                    echo Crop Settings: --crop !csin!,!csup!,!cdes!,!cinf!    
                                                                                    set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
                                                                                    echo.  
                                                                                    
                                                                                    echo !t17!  !mwidth! 
                                                                                    echo !t18!  !mheight! 
                                                                                    echo.

                                                                                    set /a "larghezza1080pnvenc=1920"
                                                                                    set /a "altezza1080pnvenc=1080"
                                                                                    @REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
                                                                                    @REM echo altezza1080pnvenc = !altezza1080pnvenc!                                    

                                                                                    set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!mwidth!"
                                                                                    set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!mheight!"
                                                                                    @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
                                                                                    @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

                                                                                    if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                                                                                                        @REM echo dentro il 1o if
                                                                                                                                                                        set /a "width2k=!mwidth!"
                                                                                                                                                                        set /a "height2k=!mheight!"
                                                                                                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                                                                                                set /a "width2k=!mwidth!"
                                                                                                                                                                                                                                                                set /a "height2k=!mheight!"
                                                                                                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                                                                                                        set /a "width2k=!mwidth!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        set /a "height2k=!mheight!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "width2k=!mwidth!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "height2k=!mheight!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                                                                                                                set /a "width2k=!mwidth!"
                                                                                                                                                                                                                                                                set /a "height2k=!mheight!"
                                                                                                                                                                                                                                                                )
                                                                                                                                                                        
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                                                                                                        set /a "width2k=!mwidth!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        set /a "height2k=!mheight!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.                         

                                                                                        echo !t191!  !width2k! 
                                                                                        echo !t192!  !height2k!    
                                                                                        echo.

                                                                                        set /a "width4k=width2k*2"
                                                                                        set /a "height4k=height2k*2"

                                                                                        echo !t20!  !width4k! 
                                                                                        echo !t21!  !height4k!    
                                                                                        echo.
                                                                                    )  
                                                        )                          
                                                  

:cropmanuale_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set /a "csup=0"
set /a "cinf=0"
set /a "csin=0"
set /a "cdes=0"
set /a "bandasuperiore=0"
set /a "bandainferiore=0"
set /a "bandasinistra=0"
set /a "bandadestra=0"
set /a "differenzialelarghezza1080pnvenc=0"
set /a "differenzialealtezza1080pnvenc=0"
if exist ".\temp\Temp_HDR10_Stream.txt" ( del ".\temp\Temp_HDR10_Stream.txt" ) 
if exist ".\temp\durata_film.txt" ( del ".\temp\durata_film.txt" )
if exist ".\temp\crop.txt" ( del ".\temp\crop.txt" )
if exist ".\temp\risultato_multiplo.txt" ( del ".\temp\risultato_multiplo.txt" )
if exist ".\temp\crop_multiplo.txt" ( del ".\temp\crop_multiplo.txt" )
if exist ".\temp\crop_finale.txt" ( del ".\temp\crop_finale.txt" )

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t22!"   
    if errorlevel 2 goto cropmanualeinsval_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
    if errorlevel 1 goto finecropmanuale_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
)

CHOICE /N /C:SN /M "!t22!"   

if errorlevel 2 goto cropmanualeinsval_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if errorlevel 1 goto finecropmanuale_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10


:cropmanualeinsval_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
echo.
echo !t23!
echo.

:banda_superiore_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set /p "bandasuperiore=!t24!"
SET "var="&for /f "delims=0123456789" %%i in ("!bandasuperiore!") do set var=!bandasuperiore!
if defined var (
                echo.
                echo !t25!
                echo.
                goto banda_superiore_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
                ) else (
                        set /a "csup=!bandasuperiore!/2*2"
                        )

echo.
:banda_inferiore_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set /p "bandainferiore=!t26!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandainferiore!") do set var=!bandainferiore!
if defined var (
                echo.
                echo !t27!
                echo.
                goto banda_inferiore_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
                ) else (
                        set /a "cinf=!bandainferiore!/2*2"
                        )


echo.
:banda_sinistra_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set /p "bandasinistra=!t28!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandasinistra!") do set var=!bandasinistra!
if defined var (
                echo.
                echo !t29!
                echo.
                goto banda_sinistra_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
                ) else (
                        set /a "csin=!bandasinistra!/2*2"
                        )

                        
echo.
:banda_destra__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set /p "bandadestra=!t30!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandadestra!") do set var=!bandadestra!
if defined var (
                echo.
                echo !t31!
                echo.
                goto banda_destra__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
                ) else (
                        set /a "cdes=!bandadestra!/2*2"
                        )


set /a "larghezza1080pnvenc=1920"
set /a "altezza1080pnvenc=1080"
@REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
@REM echo altezza1080pnvenc = !altezza1080pnvenc!                                    

set /a "mwidth=!mwidth!/2*2"
set /a "mheight=!mheight!/2*2"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "mwidthc=!mwidth!-!csin!-!cdes!"
set /a "mheightc=!mheight!-!csup!-!cinf!"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!mwidthc!"
set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!mheightc!"
@REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
@REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

echo.
echo !t32!  !csup! 
echo !t33!  !cinf! 
echo !t34!  !csin! 
echo !t35!  !cdes! 
echo.


set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
echo Crop Settings: !cropff!
echo.

echo !t17!  !mwidthc! 
echo !t18!  !mheightc! 
echo.



if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                        @REM echo dentro il 1o if
                                                                                        set /a "width2k=!mwidthc!"
                                                                                        set /a "height2k=!mheightc!"
                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                set /a "width2k=!mwidthc!"
                                                                                                                                                                                set /a "height2k=!mheightc!"
                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                        set /a "width2k=!mwidthc!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                        set /a "height2k=!mheightc!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                set /a "width2k=!mwidthc!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                set /a "height2k=!mheightc!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                )
                                                                                        if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                        set /a "width2k=!mwidthc!"
                                                                                                                                                                        set /a "height2k=!mheightc!"
                                                                                                                                                                        )
                                                                                                                                                                        
                                                                                        if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                set /a "width2k=!mwidthc!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                set /a "height2k=!mheightc!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.                         

                                                                                        echo !t191!  !width2k! 
                                                                                        echo !t192!  !height2k!    
                                                                                        echo.

                                                                                        set /a "width4k=width2k*2"
                                                                                        set /a "height4k=height2k*2"

                                                                                        echo !t20!  !width4k! 
                                                                                        echo !t21!  !height4k!    
                                                                                        echo.
                                                                                    ) 

goto cropmanuale_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:finecropmanuale_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10


rem//////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////


echo.
echo !t38!
echo.
echo 1) NVidia 
echo 2) Intel 
echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto ChoosenIntel__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if errorlevel 1 goto ChoosenNVidia__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:ChoosenIntel__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "SchedaGrafica=Intel"
@REM echo SchedaGrafica = !SchedaGrafica!
goto fineSceltaSchedaGrafica__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:ChoosenNVidia__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "SchedaGrafica=NVidia"
@REM echo SchedaGrafica = !SchedaGrafica!

:fineSceltaSchedaGrafica__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

@REM pause 

if !SchedaGrafica!==NVidia (
                                goto InserimentoImpostazioniNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
                                ) 





if !SchedaGrafica!==Intel (
                                goto InserimentoImpostazioniQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
                                 )


@REM pause 



rem//////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////


:InserimentoImpostazioniNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

echo.
echo !t40!
echo.
echo 1) CQP 
echo 2) VBR 
echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto CodificaVBRNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if errorlevel 1 goto CodificaCQPNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:CodificaVBRNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "TipoCodificaNVEnc=--vbr "
set /a "quantizzazioneNVEnc=0"
goto inserimentoValoriCQPVBRNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:CodificaCQPNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "TipoCodificaNVEnc=--cqp "
set /a "quantizzazioneNVEnc=1"

:inserimentoValoriCQPVBRNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

if !quantizzazioneNVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneNVEnc=!t44!" 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneNVEnc!") do set var=!valoreQuantizzazioneNVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                echo.
                                                goto inserimentoValoriCQPVBRNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
                                                ) 

                                set /a "valoreQuantizzazioneNVEnc=!valoreQuantizzazioneNVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneNVEnc!
                                if !valoreQuantizzazioneNVEnc! GEQ 10 if !valoreQuantizzazioneNVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneNVEnc!
                                                                                                                set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreQuantizzazioneNVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                                goto fineQuantizzazioneNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
                                                                                                                        
                                )



if !quantizzazioneNVEnc!==0 (
                                echo.
                                set /p "valoreBitRateNVEnc=!t46!" 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateNVEnc!") do set var=!valoreBitRateNVEnc!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                echo.
                                                goto inserimentoValoriCQPVBRNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
                                                ) 
                                set /a "valoreBitRateNVEnc=!valoreBitRateNVEnc!"
                                @REM echo valoreBitRateNVEnc = !valoreBitRateNVEnc!
                                if !valoreBitRateNVEnc! GEQ 100 if !valoreBitRateNVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateNVEnc!
                                                                                                        set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreBitRateNVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                        goto fineQuantizzazioneNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
                                                                                                              
                                )


:fineQuantizzazioneNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10



echo.
echo !t50!
echo.
echo 1) P1 !t51!
echo 2) P2 
echo 3) P3 
echo 4) P4 
echo 5) P5 
echo 6) P6 
echo 7) P7 !t52!
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto P7NVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if errorlevel 6 goto P6NVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if errorlevel 5 goto P5NVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if errorlevel 4 goto P4NVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if errorlevel 3 goto P3NVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if errorlevel 2 goto P2NVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if errorlevel 1 goto P1NVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10


:P7NVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "SettaggioQualitaNVEnc=--preset P7"
set "QualitySetting=P7"
goto fineQualitCodificaNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:P6NVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "SettaggioQualitaNVEnc=--preset P6"
set "QualitySetting=P6"
goto fineQualitCodificaNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:P5NVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "SettaggioQualitaNVEnc=--preset P5"
set "QualitySetting=P5"
goto fineQualitCodificaNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:P4NVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "SettaggioQualitaNVEnc=--preset P4"
set "QualitySetting=P4"
goto fineQualitCodificaNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:P3NVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "SettaggioQualitaNVEnc=--preset P3"
set "QualitySetting=P3"
goto fineQualitCodificaNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:P2NVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "SettaggioQualitaNVEnc=--preset P2"
set "QualitySetting=P2"
goto fineQualitCodificaNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:P1NVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "SettaggioQualitaNVEnc=--preset P1"
set "QualitySetting=P1"
goto fineQualitCodificaNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10


:fineQualitCodificaNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaNVEnc!



:sceltadenoiser
set conv3d1080p=
set pmd1080p=
set /a unicopassaggio=0

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t55!"
    if errorlevel 2 goto conv3dChoosenNoNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
    if errorlevel 1 goto conv3dChoosenYesNVEncUpScaling2__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
)

echo.
CHOICE /N /C:SN /M "!t55!"

if errorlevel 2 goto conv3dChoosenNoNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if errorlevel 1 goto conv3dChoosenYesNVEncUpScaling2__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:conv3dChoosenNoNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "conv3d1080p=N"
goto sceltaDeniserPMDNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:conv3dChoosenYesNVEncUpScaling2__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "conv3d1080p=S"



:sceltaDeniserPMDNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t56!"
    if errorlevel 2 goto PMDChoosenNoNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
    if errorlevel 1 goto PMDChoosenYesNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
)

echo.
CHOICE /N /C:SN /M "!t56!"

if errorlevel 2 goto PMDChoosenNoNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if errorlevel 1 goto PMDChoosenYesNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:PMDChoosenNoNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "pmd1080p=N"
goto assegnazioneDenoisesNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:PMDChoosenYesNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "pmd1080p=S"


:assegnazioneDenoisesNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set /A nvdenv=0

if !conv3d1080p!==S if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00 --vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==S if !pmd1080p!==N ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==N ( 
                                        set "nvdenoiser=nessuno" 
                                        set "nvdenv=1"
                                        set "unicopassaggio=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: Nessun Denoiser 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )

@REM pause


echo.

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t57!"
    if errorlevel 2 goto ApplicaMiglioramentoDettagliNVEncNo__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
    if errorlevel 1 goto ApplicaMiglioramentoDettagliNVEncSI__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
)

CHOICE /N /C:SN /M "!t57!"

if errorlevel 2 goto ApplicaMiglioramentoDettagliNVEncNo__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if errorlevel 1 goto ApplicaMiglioramentoDettagliNVEncSI__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:ApplicaMiglioramentoDettagliNVEncNo__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "miglioramento1080p=N"
goto fineSceltaMigliaramentiNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:ApplicaMiglioramentoDettagliNVEncSI__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "miglioramento1080p=S"

:fineSceltaMigliaramentiNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if !miglioramento1080p!==S ( 
                                set "edgeleveling=--vpp-edgelevel strength=10.0,threshold=24.0,black=6,white=0" 
                                echo.
                                echo NVEnc !t58!
                                echo.
                                )
if !miglioramento1080p!==N ( 
                                set "edgeleveling=nessuno" 
                                echo.
                                echo NVEnc !t59!
                                echo.
                                )


@REM pause


if !nvdenoiser!==nessuno if !edgeleveling!==nessuno (
                                                        set "unicopassaggio=1"
                                                        goto fineConfigurazioneOperazioniUpScalingNVEnc_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
                                                        )

echo.
echo !t75!
echo !t76!
echo.
echo !t77!
echo !t78!

echo.
CHOICE /N /C:123 /M "!t39!"

if errorlevel 2 goto OperazioniUpScalingSingolaCodificaNvEnc_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if errorlevel 1 goto OperazioniUpScalingDoppiaCodificaNvEnc_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:OperazioniUpScalingSingolaCodificaNvEnc_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "unicopassaggio=1"
goto fineConfigurazioneOperazioniUpScalingNVEnc_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:OperazioniUpScalingDoppiaCodificaNvEnc_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "unicopassaggio=0"

:fineConfigurazioneOperazioniUpScalingNVEnc_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10




set file_senza_virgolette=!NomeFile:"=!
rem echo %file_senza_virgolette%

set file_senza_estensione=!file_senza_virgolette:.mkv=!
rem echo %file_senza_estensione%

set fileoutput2160p="!file_senza_estensione!_UpScaled_2160p.mkv"
rem echo fileoutput2160p = %fileoutput2160p%

echo.
set "VideoInfoCodifica=NVEnc_UpScaling_da_1080p_10bit_hdr_a_2160p_10bit_hdr|!NomeFile!|!fileoutput2160p!|nessuno|!cropff!|!width4k!x!height4k!|!width2k!x!height2k!|nessuno|!colorpr!|!colortr!|!colorsp!|!tipoQuantizzazioneNVEnc!|!SettaggioQualitaNVEnc!|nessuno|nessuno|!nvdenoiser!|!formatvideo!|!edgeleveling!|no_color_correction|!unicopassaggio!|no_lokahead|no_precisione_vettore_movimento"
@REM echo VideoInfoCodifica = !VideoInfoCodifica!
@REM echo.

if exist ".\saved\savedmoviesallencodings.dat" ( 
                                                echo !VideoInfoCodifica! >> .\saved\savedmoviesallencodings.dat
                                                goto finesalvataggioInserimentoNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
                                                ) 

echo !VideoInfoCodifica! > .\saved\savedmoviesallencodings.dat


:finesalvataggioInserimentoNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

echo !t60! !numeromovie! !t61!
echo.

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t62!"
    if errorlevel 2 goto finesceltanuovovideodacodificareNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
    if errorlevel 1 goto altrivideodainserireMenuNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
)

CHOICE /N /C:SN /M "!t62!"
echo.

if errorlevel 2 goto finesceltanuovovideodacodificareNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if errorlevel 1 goto altrivideodainserireMenuNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:altrivideodainserireMenuNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set /a "numeromovie+=1"
echo.
goto altrivideodainserire_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:finesceltanuovovideodacodificareNVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
echo.
goto fineinfovideo_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10


rem//////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////




rem//////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////


:InserimentoImpostazioniQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

echo.
echo !t40!
echo.
echo 1) CQP 
echo 2) ICQ 
echo 3) LA-ICQ 
echo 4) VBR 
echo.
CHOICE /N /C:1234 /M "!t64!"

if errorlevel 4 goto CodificaVBRQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if errorlevel 3 goto CodificaLAICQQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if errorlevel 2 goto CodificaICQQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if errorlevel 1 goto CodificaCQPQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10


:CodificaCQPQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "TipoCodificaQSVEnc=--cqp "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:CodificaICQQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "TipoCodificaQSVEnc=--icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:CodificaLAICQQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "TipoCodificaQSVEnc=--la-icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:CodificaVBRQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "TipoCodificaQSVEnc=--vbr "
set /a "quantizzazioneQSVEnc=0"
goto inserimentoValoriCQPVBRQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10


:inserimentoValoriCQPVBRQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

if !quantizzazioneQSVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneQSVEnc=!t44!" 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneQSVEnc!") do set var=!valoreQuantizzazioneQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                echo.
                                                goto inserimentoValoriCQPVBRQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
                                                ) 

                                set /a "valoreQuantizzazioneQSVEnc=!valoreQuantizzazioneQSVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneQSVEnc!
                                if !valoreQuantizzazioneQSVEnc! GEQ 10 if !valoreQuantizzazioneQSVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneQSVEnc!
                                                                                                                set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreQuantizzazioneQSVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                                goto fineQuantizzazioneQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
                                                                                                                        
                                )



if !quantizzazioneQSVEnc!==0 (
                                echo.
                                set /p "valoreBitRateQSVEnc=!t46!" 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateQSVEnc!") do set var=!valoreBitRateQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                echo.
                                                goto inserimentoValoriCQPVBRQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
                                                ) 
                                set /a "valoreBitRateQSVEnc=!valoreBitRateQSVEnc!"
                                @REM echo valoreBitRateQSVEnc = !valoreBitRateQSVEnc!
                                if !valoreBitRateQSVEnc! GEQ 100 if !valoreBitRateQSVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateQSVEnc!
                                                                                                        set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreBitRateQSVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                        goto fineQuantizzazioneQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
                                                                                                              
                                )


:fineQuantizzazioneQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10



echo.
echo !t50!
echo.
echo 1) Best 
echo 2) Higher 
echo 3) High 
echo 4) Balanced 
echo 5) Fast 
echo 6) Faster 
echo 7) Fastest 
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto QualitFastestQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if errorlevel 6 goto QualitFasterQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if errorlevel 5 goto QualitFastQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if errorlevel 4 goto QualitBalancedtQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if errorlevel 3 goto QualitHighQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if errorlevel 2 goto QualitHigherQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if errorlevel 1 goto QualitBestQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10


:QualitBestQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "SettaggioQualitaQSvenc=--quality best"
set "QualitySetting=best"
goto fineQualitCodificaQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:QualitHigherQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "SettaggioQualitaQSvenc=--quality higher"
set "QualitySetting=higher"
goto fineQualitCodificaQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:QualitHighQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "SettaggioQualitaQSvenc=--quality high"
set "QualitySetting=high"
goto fineQualitCodificaQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:QualitBalancedtQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "SettaggioQualitaQSvenc=--quality balanced"
set "QualitySetting=balanced"
goto fineQualitCodificaQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:QualitFastQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "SettaggioQualitaQSvenc=--quality fast"
set "QualitySetting=fast"
goto fineQualitCodificaQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:QualitFasterQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "SettaggioQualitaQSvenc=--quality faster"
set "QualitySetting=faster"
goto fineQualitCodificaQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:QualitFastestQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "SettaggioQualitaQSvenc=--quality fastest"
set "QualitySetting=fastest"
goto fineQualitCodificaQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10


:fineQualitCodificaQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaQSvenc!



:sceltadenoiser
set conv3d1080p=
set pmd1080p=
set /a unicopassaggio=0

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t55!"
    if errorlevel 2 goto conv3dChoosenNoQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
    if errorlevel 1 goto conv3dChoosenYesQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
)

echo.
CHOICE /N /C:SN /M "!t55!"

if errorlevel 2 goto conv3dChoosenNoQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if errorlevel 1 goto conv3dChoosenYesQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:conv3dChoosenNoQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "conv3d1080p=N"
goto sceltaDeniserPMDQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:conv3dChoosenYesQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "conv3d1080p=S"



:sceltaDeniserPMDQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t56!"
    if errorlevel 2 goto PMDChoosenNoQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
    if errorlevel 1 goto PMDChoosenYesQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
)
echo.
CHOICE /N /C:SN /M "!t56!"

if errorlevel 2 goto PMDChoosenNoQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if errorlevel 1 goto PMDChoosenYesQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:PMDChoosenNoQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "pmd1080p=N"
goto assegnazioneDenoisesQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:PMDChoosenYesQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "pmd1080p=S"


:assegnazioneDenoisesQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set /A nvdenv=0

if !conv3d1080p!==S if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00 --vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==S if !pmd1080p!==N ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==N ( 
                                        set "nvdenoiser=nessuno" 
                                        set "nvdenv=1"
                                        set "unicopassaggio=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: Nessun Denoiser 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )

@REM pause

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t57!"
    if errorlevel 2 goto ApplicaMiglioramentoDettagliQSVEncNo__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
    if errorlevel 1 goto ApplicaMiglioramentoDettagliQSVEncSi__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
)

echo.
CHOICE /N /C:SN /M "!t57!"

if errorlevel 2 goto ApplicaMiglioramentoDettagliQSVEncNo__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if errorlevel 1 goto ApplicaMiglioramentoDettagliQSVEncSi__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:ApplicaMiglioramentoDettagliQSVEncNo__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "miglioramento1080p=N"
goto fineSceltaMigliaramentiQSVEnci__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:ApplicaMiglioramentoDettagliQSVEncSi__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "miglioramento1080p=S"

:fineSceltaMigliaramentiQSVEnci__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if !miglioramento1080p!==S ( 
                                set "edgeleveling=--vpp-edgelevel strength=10.0,threshold=24.0,black=6,white=0" 
                                echo.
                                echo QSVEnc !t58!
                                echo.
                                )
if !miglioramento1080p!==N ( 
                                set "edgeleveling=nessuno" 
                                echo.
                                echo QSVEnc !t59!
                                echo.
                                )


@REM pause

if !nvdenoiser!==nessuno if !edgeleveling!==nessuno (
                                                        set "unicopassaggio=1"
                                                        goto fineConfigurazioneOperazioniUpScalingQSVEnc_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
                                                        )

echo.
echo.
echo !t75!
echo !t76!
echo.
echo !t77!
echo !t78!

echo.
CHOICE /N /C:123 /M "!t39!"

if errorlevel 2 goto OperazioniUpScalingSingolaCodificaQSVEnc_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if errorlevel 1 goto OperazioniUpScalingDoppiaCodificaQSVEnc_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:OperazioniUpScalingSingolaCodificaQSVEnc_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "unicopassaggio=1"
goto fineConfigurazioneOperazioniUpScalingQSVEnc_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:OperazioniUpScalingDoppiaCodificaQSVEnc_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set "unicopassaggio=0"

:fineConfigurazioneOperazioniUpScalingQSVEnc_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10





set file_senza_virgolette=!NomeFile:"=!
rem echo %file_senza_virgolette%

set file_senza_estensione=!file_senza_virgolette:.mkv=!
rem echo %file_senza_estensione%

set fileoutput2160p="!file_senza_estensione!_UpScaled_2160p.mkv"
rem echo fileoutput2160p = %fileoutput2160p%

echo.
set "VideoInfoCodifica=QSVEnc_UpScaling_da_1080p_10bit_hdr_a_2160p_10bit_hdr|!NomeFile!|!fileoutput2160p!|nessuno|!cropff!|!width4k!x!height4k!|!width2k!x!height2k!|nessuno|!colorpr!|!colortr!|!colorsp!|!tipoQuantizzazioneQSVEnc!|!SettaggioQualitaQSVEnc!|nessuno|nessuno|!nvdenoiser!|!formatvideo!|!edgeleveling!|no_color_correction|!unicopassaggio!|no_lokahead|no_precisione_vettore_movimento"
@REM echo VideoInfoCodifica = !VideoInfoCodifica!
@REM echo.

if exist ".\saved\savedmoviesallencodings.dat" ( 
                                                echo !VideoInfoCodifica! >> .\saved\savedmoviesallencodings.dat
                                                goto finesalvataggioInserimentoQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
                                                ) 

echo !VideoInfoCodifica! > .\saved\savedmoviesallencodings.dat


:finesalvataggioInserimentoQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

echo !t60! !numeromovie! !t61!
echo.

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t62!"
    if errorlevel 2 goto finesceltanuovovideodacodificareQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
    if errorlevel 1 goto altrivideodainserireMenuQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
)

CHOICE /N /C:SN /M "!t62!"
echo.

if errorlevel 2 goto finesceltanuovovideodacodificareQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
if errorlevel 1 goto altrivideodainserireMenuQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:altrivideodainserireMenuQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
set /a "numeromovie+=1"
echo.
goto altrivideodainserire_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10

:finesceltanuovovideodacodificareQSVEnc__InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
echo.
goto fineinfovideo_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10


rem//////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////


goto fineinfovideo_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10




:novideofile1080p_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10
echo !t63!
echo.


:fineinfovideo_InserimentUpScalingda1080p10bitHDRa2160p10bitHDR10


if exist ".\temp\Temp_HDR10_Stream.txt" ( del .\temp\Temp_HDR10_Stream.txt )
if exist ".\temp\durata_film.txt" ( del .\temp\durata_film.txt )
if exist ".\temp\crop.txt" ( del .\temp\crop.txt )
if exist ".\temp\risultato_multiplo.txt" ( del .\temp\risultato_multiplo.txt )
if exist ".\temp\crop_multiplo.txt" ( del .\temp\crop_multiplo.txt )
if exist ".\temp\crop_finale.txt" ( del .\temp\crop_finale.txt )
      




set waitenter=
set /P waitenter=!t65!
Endlocal
goto InserimentoCodifcaInCodaeSalvataggioSuDisco










rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:InserimentoCodificaHardwareUpScalingPiuUpGradingda1080p810bitSDRa2160p10bitHDR10

cls
setLocal EnableExtensions EnableDelayedExpansion



for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoInserimentoCodificaHardwareUpScalingPiuUpGradingda1080p810bitSDRa2160p10bitHDR10
)

if %lingua%==inglese (
    goto caricalinguaingleseInserimentoCodificaHardwareUpScalingPiuUpGradingda1080p810bitSDRa2160p10bitHDR10
)



:caricalinguaingleseInserimentoCodificaHardwareUpScalingPiuUpGradingda1080p810bitSDRa2160p10bitHDR10
set t1=Insert Hardware Video Encoding Info UpScaling and UpGrading from 1080p 8 bit or 10 bit SDR to 2160p 10 bit HDR and Saving to Disk

set t2=Drag Here the
set t211=Video File 1080p 8 bit or 10 bit SDR to Convert to 2160p 10 bit HDR:  

set t3=File does not exist 
set t4=Info Video:  

set t5=The Inserted Video is 1080p 8bit SDR 
set t511=The Inserted Video is 1080p 10bit SDR 

set t6=The Inserted Video isn't 1080p 8bit or 10bit SDR 
set t7=Video Duration in seconds:
set t8=Video Duration in Minutes:
set t9=Interval between Frames for Crop Detection:
set t10= seconds
set t11=Black Bands Detection Started....
set t12=Crop Detection to Frame
set t13=to seconds
set t14=Done...
set t15=Original 2160p Video Width: 
set t16=Original 2160p Video Height:
set t17=Original Video 1080p Width Without Black Bars:
set t18=Original Video 1080p Height Without Black Bars:

set t171=Output Video 1080p Width Without Black Bars:
set t181=Outout Video 1080p Height Without Black Bars:

set t19=Adapting Video Resolution to Full 1080p Format...

set t191=Final 1080p Output Video Width:
set t192=Final 1080p Output Video Height:
set t20=Final 2160p Output Video Width:
set t21=Final 2160p Output Video Height:

set t22=Settings of Black Bands to Crop are Correct (Yes/No):
set t23=Manually Entering Black Band Values to Crop... 
set t24=Enter the Upper Black Band Value: 
set t25=Error Entering Upper Black Band Value... It's Not a Number. 
set t26=Enter the Lower Black Band Value: 
set t27=Error Entering Lower Black Band Value... It's Not a Number.
set t28=Enter the Left Black Band Value: 
set t29=Error Entering Left Black Band Value... It's Not a Number.
set t30=Enter the Right Black Band Value: 
set t31=Error Entering Right Black Band Value... It's Not a Number.
set t32=Upper Black Band:
set t33=Lower Black Band:
set t34=Left Black Band:
set t35=Right Black Band:
set t36=1080p Original Video Width without Black Bars:
set t37=1080p Original Video Height without Black Bars:

@REM set t361=1080p Video Width without Black Bars:
@REM set t371=1080p Video Height without Black Bars

set t38=Select Graphic Card you want to Encode with:
set t39=Choose (1/2):
set t40=Select Encoding Type:
set t41=Error Entering Quantization Value... Not a Number. 
set t42=Quantization Value Set to:
set t43=Encoding Settings:
set t44=Enter Quantization value Minimum 10 Maximum 28:
set t45=Quantization Value Out of  Limits  10 / 28  Re-enter^!
set t46=Enter BitRate Value kbs Minimum 100 Maximum 50000:
set t47=Error Entering BitRate Value... It's Not a Number. 
set t48=BitRate Value Set to:
set t49=BitRate Value Out of Limits  100 / 50000  Re-enter^!
set t50=Select Encoding Quality:
set t51=- Worst Quality
set t52=- Best Quality
set t53=Choose (1/2/3/4/5/6/7):
set t54=Quality Set to:
set t55=Apply Convolution3D denoiser Yes/No: 
set t56=Apply PMD denoiser Yes/No: 
set t57=Apply Detail Enhancement Yes/No:  
set t58=Enhancement Detail: Yes 
set t59=Enhancement Detail: No 
set t60=Info
set t61=Videos to Encode Saved!
set t62=Do You Want to Insert Another Video to Encode (Yes/No):
set t63=The dragged file is not a video!
set t64=Choose (1/2/3/4):
set t65=Press Enter toback to Menu Inserting Encoding into the Queue and Saving to Disk:  

set t66=Video Width
set t67=Video Height
set t68=Video Codec
set t69=Details Video Codec
set t70=Video Format 
set t71=Configuration Settings to convert video from 8bit or 10bit SDR to 10bit HDR
set t72=Select Encoding UpGrader:
set t73=Settings UpGrader:
set t74=Choose (1/2/3):

set t75=Configuration UpScaling and UpGrading from 1080p 8 or 10 bit SDR to 2160p 10 bit HDR 
set t76=Select Operations to Perform:
set t77=1) First Pass Encode for Upscaling and a Second Pass Encode to Clean Up the Video and Enhance Details
set t78=2) Cleanup, Detail Enhancement and Upscaling in a Single Encode

goto avvio_InserimentoCodificaHardwareUpScalingPiuUpGradingda1080p810bitSDRa2160p10bitHDR10




:caricalinguaitalianoInserimentoCodificaHardwareUpScalingPiuUpGradingda1080p810bitSDRa2160p10bitHDR10
set t1=Inserimento Info Codifica Hardware Video UpScaling e UpGrading da 1080p 8 bit o 10 bit SDR a 2160p 10 bit HDR e Salvataggio su Disco.

set t2=Trascina Qui il 
set t211=File Video 1080p 8 bit o [923m10 bit SDR da Convertire in 2160p 10 bit HDR:  

set t3=File Inesistente 
set t4=Informazioni Video:  

set t5=Il Video inserito e' 1080p 8bit SDR 
set t511=Il Video inserito e' 1080p 10bit SDR 

set t6=Il Video inserito non e' 1080p 8bit o 10bit SDR 

set t7=Durata del Video in secondi:
set t8=Durata del video in Minuti:
set t9=Intervallo tra i Fotogrammi per il Rilevamento del crop:
set t10= secondi
set t11=Rilevamento Bande Nere Iniziato....
set t12=Rilevazione crop fotogramma
set t13=a secondi
set t14=Eseguita...
set t15=Larghezza Video 2160p Originale:
set t16=Altezza Video 2160p Originale:
set t17=Larghezza Video Originale 1080p  Senza Barre Nere:
set t18=Altezza Video Originale 1080p  Senza Barre Nere:

set t171=Larghezza Video 1080p  Senza Barre Nere:
set t181=Altezza Video 1080p  Senza Barre Nere:

set t19=Adattamento della Risoluzione del Video al Pieno Formato 1080p..

set t191=Larghezza Finale Video 1080p:
set t192=Altezza Finale Video 1080p:
set t20=Larghezza Finale Video 2160p:
set t21=Altezza Finale Video 2160p:

set t22=Le Impostazioni delle Bande Nere da Tagliare sono Corrette (Si/No):
set t23=Inserimento Manuale Valori Bande Nere da Tagliare.. 
set t24=Inserisci il Valore della Banda Nera Superiore: 
set t25=Errore nell'Inserimento del Valore della Banda Nera Superiore... Non e' un Numero. 
set t26=Inserisci il Valore della Banda Nera Inferiore: 
set t27=Errore nell'Inserimento del Valore della Banda Nera Inferiore... Non e' un Numero. 
set t28=Inserisci il Valore della Banda Nera Sinistra: 
set t29=Errore nell'Inserimento del Valore della Banda Nera Sinistra... Non e' un Numero. 
set t30=Inserisci il Valore della Banda Nera Destra: 
set t31=Errore nell'Inserimento del Valore della Banda Nera Destra... Non e' un Numero. 
set t32=Banda Nera Superiore:
set t33=Banda Nera Inferiore:
set t34=Banda Nera Sinistra:
set t35=Banda Nera Destra:
set t36=Larghezza Video Originale 1080p senza Bande Nere:
set t37=Altezza Video Originale 1080p senza Bande Nere:

@REM set t361=Larghezza Video 1080p senza Bande Nere:
@REM set t371=Altezza Video 1080p senza Bande Nere:

set t38=Selezionare Scheda Grafica con cui Eseguire la Codifica:
set t39=Scegli (1/2):
set t40=Selezionare tipo di Codifica:
set t41=Errore nell'Inserimento del Valore della Quantizzazione... Non e' un Numero. 
set t42=Valore Quantizzazzione Impostato a:
set t43=Parametri per codifica:

set t44=Inserire Valore Quantizzazione Minimo 10 Massimo 28:
set t45=Valore Quantizzazzione al di fuori dei  Limiti  10 / 28  Reinserire^!
set t46=Inserire Valore BitRate kbs Minimo 100 Massimo 50000:
set t47=Errore nell'Inserimento del Valore del BitRate... Non e' un Numero. 
set t48=Valore BitRate Impostato a:
set t49=Valore  BitRate al di fuori dei  Limiti  100 / 50000  Reinserire^!

set t50=Selezionare Qualita' Codifica:
set t51=- Peggiore Qualita'
set t52=- Migliore Qualita'
set t53=Scegli (1/2/3/4/5/6/7):
set t54=Qualita' Impostata su:
set t55=Applicare il denoiser Convolution3D Si/No: 
set t56=Applicare il denoiser PMD Si/No: 
set t57=Applicare il Miglioramento Dettagli Si/No:  
set t58=Miglioramento Dettagli: Si 
set t59=Miglioramento Dettagli: No 
set t60=Informazioni
set t61=Video da Codificare Salvate!
set t62=Vuoi Inserire un altro Video da Codificare (Si/No):
set t63=Il file trascinato non e' un video!
set t64=Scegli (1/2/3/4):
set t65=Premi Invio per tornare al menu' Inserimento Codifiche in Coda e Salvataggio sul Disco:  

set t66=Larghezza Video
set t67=Altezza Video
set t68=Codec Video
set t69=Codec Video Dettagli
set t70=Format Video 
set t71=Configurazione Parametri per convertire il video da 8bit o 10bit SDR a 10bit HDR
set t72=Selezionare UpGrader Codifica:
set t73=UpGrader Impostato:
set t74=Scegli (1/2/3):


set t75=Configurazione Operazione di UpScaling e UpGrading da 1080p 8 o 10 bit SDR a 2160p 10 bit HDR 
set t76=Selezionare Operazioni da Eseguire:
set t77=1) Fare Prima Codifica per UpScaling e Seconda Codifica per Ripulire il Video e Migliorare i Dettagli
set t78=2) Ripulire, Migliorare i Dettagli e Upscaling in un Unica Codifica 

goto avvio_InserimentoCodificaHardwareUpScalingPiuUpGradingda1080p810bitSDRa2160p10bitHDR10

:avvio_InserimentoCodificaHardwareUpScalingPiuUpGradingda1080p810bitSDRa2160p10bitHDR10





set /a "numeromovie=1"


echo !t1!
echo.


:altrivideodainserireNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p


set NomeFile1080p=
rem set MetadatiStreamHDR10=

set /P NomeFile1080p=!t2! !numeromovie! !t211! 
rem echo Hai digitato: %NomeFile%
rem pause

set "NomeFileSorgente=!NomeFile1080p:"=!"
@REM echo NomeFileSorgente = !NomeFileSorgente!
set "NomeFile=^"!NomeFileSorgente!^""
@REM echo NomeFile = !NomeFile!
@REM rem pause


if exist !NomeFile! ( goto infovideo_InserimentoUpScalingUpgradingda1080p8o10bita2160p ) else ( 
                                                        echo.
                                                        echo !t3!
                                                        echo.
                                                        goto fineinfovideo_InserimentoUpScalingUpgradingda1080p8o10bita2160p
                                                        )    



:infovideo_InserimentoUpScalingUpgradingda1080p8o10bita2160p
echo.
echo !t4!
echo.

.\bin\ffprobe -v error -hide_banner -select_streams v:0 -show_entries stream=width,height,codec_name,codec_long_name,pix_fmt,color_space,color_transfer,color_primaries -of default=noprint_wrappers=1 !NomeFile! > ".\temp\Temp_HDR10_Stream.txt"

set /A x1=1
set /A nohdrcs=0
set /A nohdrct=0
set /A nohdrcp=0
set /A wv=0
set /a hv=0
set /A fv=0

rem echo nohdr = %nohdr%

for /f "tokens=1,2 delims==" %%a in (.\temp\Temp_HDR10_Stream.txt) do (if !x1!==3 ( 
                                                                            echo !t66! "%%a" = %%b  
                                                                            set /A "widthvideo=%%b"
                                                                            rem echo widthvideo = !widthvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !widthvideo! LEQ 1920 if !widthvideo! GEQ 1000 (set /A "wv=1"
                                                                                                                                rem echo wv = !wv!
                                                                                                                                )
                                                                            )
                                                                if !x1!==4 ( 
                                                                            echo !t67! "%%a" = %%b  
                                                                            set /A "heightvideo=%%b"
                                                                            rem echo heightvideo = !heightvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !heightvideo! LEQ 1080 if !heightvideo! GEQ 700 (set /A "hv=1"
                                                                                                        rem echo hv = !hv!
                                                                                                        )
                                                                            )                                                           
                                                                if !x1!==6 ( 
                                                                            echo Color Space "%%a" = %%b  
                                                                            set "colorsp=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colorsp!==bt709 (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorsp!==unknown (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorsp!==reserved (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                    
                                                                            ) 
                                                                if !x1!==7 ( 
                                                                            echo Color Transfer "%%a" = %%b  
                                                                            set "colortr=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colortr!==bt709 (set /A "nohdrct=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colortr!==unknown (set /A "nohdrct=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colortr!==reserved (set /A "nohdrct=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                    
                                                                            ) 
                                                                if !x1!==8 ( 
                                                                            echo Color Primaries "%%a" = %%b  
                                                                            set "colorpr=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colorpr!==bt709 (set /A "nohdrcp=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorpr!==unknown (set /A "nohdrcp=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorpr!==reserved (set /A "nohdrcp=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                
                                                                            )    
                                                                if !x1!==1 ( 
                                                                            echo !t68! "%%a" = %%b  
                                                                            )       
                                                                if !x1!==2 ( 
                                                                            echo !t69! "%%a" = %%b  
                                                                            )   
                                                                if !x1!==5 ( 
                                                                            echo !t70! "%%a" = %%b  
                                                                            set "formatvideo=%%b"
                                                                            rem echo formatvideo = !formatvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !formatvideo!==yuv420p (set /A "fv=1"
                                                                                                        rem echo fv = !fv!
                                                                                                        )
                                                                            if !formatvideo!==yuv420p10le (set /A "fv=1"
                                                                                                            rem echo fv = !fv!
                                                                                                            )
                                                                            )
                                                                set /A x1+=1                                                            
)
echo.

if !x1!==1 goto :novideofile1080p_InserimentoUpScalingUpgradingda1080p8o10bita2160p


if !nohdrcs!==1 if !nohdrct!==1 if !nohdrcp!==1 if !wv!==1 if !hv!==1 if !fv!==1 ( 
                                                                                   if !formatvideo!==yuv420p10le (
                                                                                                                    echo !t511!
                                                                                                                    echo. 
                                                                                                                    goto rilevazionebandenere_InserimentoUpScalingUpgradingda1080p8o10bita2160p
                                                                                                                    ) 
                                                                                   if !formatvideo!==yuv420p (                                 
                                                                                                                echo !t5!
                                                                                                                echo. 
                                                                                                                goto rilevazionebandenere_InserimentoUpScalingUpgradingda1080p8o10bita2160p
                                                                                                                )
                                                                                   ) 


echo !t6!
echo.
goto fineNVEncUpScaling


:rilevazionebandenere_InserimentoUpScalingUpgradingda1080p8o10bita2160p

.\bin\ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 !NomeFile!  > ".\temp\durata_film.txt"


set /a contatore=1
for /f "tokens=1 delims=." %%a in (.\temp\durata_film.txt) do  (
                                                        echo. 
                                                        echo !t7! %%a
                                                        set /a "secondi=%%a"
                                                        set /a "minuti=!secondi!/60"
                                                        echo !t8! !minuti!
                                                        set /a "intervallo_tagli=!secondi!/11"
                                                        echo !t9! !intervallo_tagli!!t10!
                                                        echo.
                                                        echo !t11!
                                                        echo.

                                                        

                                                        FOR /L %%a IN (1, 1, 10) DO (
                                                                                    rem echo %%a
                                                                                    set /a "secondi=%%a*!intervallo_tagli!"
                                                                                    rem echo !secondi!

                                                                                    if !formatvideo!==yuv420p (
                                                                                                                set /a "ca=16"
                                                                                                                rem echo !ca!
                                                                                                                    
                                                                                                                set /a "cb=2"
                                                                                                                rem echo !cb!
                                                                                                                    
                                                                                                                set /a "cc=0"
                                                                                                                rem echo !cc!

                                                                                                                set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                                                rem echo !cr!
                                                                                                                )

                                                                                    if !formatvideo!==yuv420p10le  ( 
                                                                                                                    set /a "ca=72"
                                                                                                                    rem echo !ca!
                                                                                                                    
                                                                                                                    set /a "cb=2"
                                                                                                                    rem echo !cb!
                                                                                                                    
                                                                                                                    set /a "cc=0"
                                                                                                                    rem echo !cc!

                                                                                                                    set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                                                    rem echo !cr!
                                                                                                                    )                                                                                                                

                                    
                                                                                
                                                                                
                                                                                    .\bin\ffmpeg -ss !secondi! -hide_banner -nostats -i !NomeFile! -vframes 10 -vf !cr! -f null - 2> ".\temp\crop.txt"
                                                                                    
                                                                                    findstr /r "Parsed_cropdetect_0" .\temp\crop.txt >> .\temp\risultato_multiplo.txt   
                                                                                    
                                                                                    echo !t12! %%a !t13! !secondi! !t14!
                                                                                    
                                                                                    )       
                                                                                       

                                                                                    for /f "tokens=1,2 delims==" %%a in (.\temp\risultato_multiplo.txt) do ( echo %%b >> .\temp\crop_multiplo.txt )
                                                                                    
                                                                                    set /a "maxfrequenza=0"

                                                                                    for /f "delims=" %%a in (.\temp\crop_multiplo.txt) do ( 
                                                                                                                                    set "cropconfront=%%a"
                                                                                                                                    rem echo "!cropconfront!"
                                                                                                                                    
                                                                                                                                    set /a "contatorfrequenza=0"
                                                                                                                                    for /f "delims=" %%b in (.\temp\crop_multiplo.txt) do (
                                                                                                                                                                                    set "dato_da_verificare=%%b"
                                                                                                                                                                                    rem echo cropconfront = "!cropconfront!"
                                                                                                                                                                                    rem echo dato_da_verificare = "!dato_da_verificare!"
                                                                                                                                                                                    if !cropconfront!==!dato_da_verificare! ( set /a "contatorfrequenza+=1")
                                                                                                                                                                                    )
                                                                                                                                    if !maxfrequenza! LSS !contatorfrequenza! ( 
                                                                                                                                                                                set /a "maxfrequenza=!!contatorfrequenza!!"
                                                                                                                                                                                set "cropd=!cropconfront!"
                                                                                                                                                                                )
                                                                                                                                    

                                                                                                                                    rem if !cropconfront! in (elenco_crop_frequenza.txt) ()
                                                                                                                                    rem echo !cropconfront!:!contatorfrequenza! >> elenco_crop_frequenza.txt

                                                                                                                                    )

                                                                                    rem echo crop piu' frequente = !cropd! con grequenza = !maxfrequenza!
                                                                                    echo !cropd! > .\temp\crop_finale.txt

                                                                                    for /f "tokens=1,2,3,4 delims=:" %%a in (.\temp\crop_finale.txt) do  ( 
                                                                                                                                                    rem set /a "mwidth=%%a"
                                                                                                                                                    rem echo mwidth = !mwidth!

                                                                                                                                                    rem set /a "mheight=%%b"
                                                                                                                                                    rem echo mheight = !mheight!

                                                                                                                                                    rem set /a "mx=%%c"
                                                                                                                                                    rem echo mx = !mx!

                                                                                                                                                    rem set /a "my=%%d"
                                                                                                                                                    rem echo my = !my!

                                                                                                                                                    if !contatore!==1 ( 
                                                                                                                                                                set /a "wmax=%%a" 
                                                                                                                                                                set /a "hmax=%%b"
                                                                                                                                                                set /a "xmin=%%c"
                                                                                                                                                                set /a "ymin=%%d"
                                                                                                                                                                set /a "mwidth=%%a"
                                                                                                                                                                set /a "mheight=%%b"
                                                                                                                                                                set /a "mx=%%c"
                                                                                                                                                                set /a "my=%%d"
                                                                                                                                                                set /a "contatore+=1"
                                                                                                                                                                )
                                                                                                                                                    
                                                                                                                                                    rem if %%b gtr !hmax! if %%c gtr !xmin! if %%d gtr !ymin! 

                                                                                                                                                    if %%a geq !wmax! if %%b geq !hmax! ( 
                                                                                                                                                                        set /a "wmax=%%a" 
                                                                                                                                                                        set /a "hmax=%%b"
                                                                                                                                                                        set /a "xmin=%%c"
                                                                                                                                                                        set /a "ymin=%%d"
                                                                                                                                                                        set /a "mwidth=%%a"
                                                                                                                                                                        set /a "mheight=%%b"
                                                                                                                                                                        set /a "mx=%%c"
                                                                                                                                                                        set /a "my=%%d"
                                                                                                                                                                        )
                                                                                                                                                    )
                                                                                    echo.
                                                                                    
                                                                                    set /a "mwidth=!mwidth!/2*2"
                                                                                    set /a "mheight=!mheight!/2*2"

                                                                                    set /a "csup=!my!/2*2"
                                                                                    rem echo csup = !csup!
                                                                                                                                    
                                                                                    set /a "csin=!mx!/2*2"
                                                                                    rem echo csin = !csin!

                                                                                    set /a "cinf=(!heightvideo!-!mheight!-!my!)/2*2"
                                                                                    rem echo movieheightreal = !movieheightreal!
                                                                                    rem echo cinf = !cinf!
                                                                                    set /a "cdes=(!widthvideo!-!mwidth!-!mx!)/2*2"
                                                                                    rem echo cdes = !cdes!

                                                                                    echo Crop Settings: --crop !csin!,!csup!,!cdes!,!cinf!    
                                                                                    set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
                                                                                    echo.  
                                                                                    
                                                                                    echo !t17!  !mwidth! 
                                                                                    echo !t18!  !mheight! 
                                                                                    echo.

                                                                                    set /a "larghezza1080pnvenc=1920"
                                                                                    set /a "altezza1080pnvenc=1080"
                                                                                    @REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
                                                                                    @REM echo altezza1080pnvenc = !altezza1080pnvenc!                                    

                                                                                    set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!mwidth!"
                                                                                    set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!mheight!"
                                                                                    @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
                                                                                    @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

                                                                                    if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                                                                                                        @REM echo dentro il 1o if
                                                                                                                                                                        set /a "width2k=!mwidth!"
                                                                                                                                                                        set /a "height2k=!mheight!"
                                                                                                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                                                                                                set /a "width2k=!mwidth!"
                                                                                                                                                                                                                                                                set /a "height2k=!mheight!"
                                                                                                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                                                                                                        set /a "width2k=!mwidth!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        set /a "height2k=!mheight!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "width2k=!mwidth!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "height2k=!mheight!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                                                                                                                set /a "width2k=!mwidth!"
                                                                                                                                                                                                                                                                set /a "height2k=!mheight!"
                                                                                                                                                                                                                                                                )
                                                                                                                                                                        
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                                                                                                        set /a "width2k=!mwidth!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        set /a "height2k=!mheight!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.                         

                                                                                        echo !t191!  !width2k! 
                                                                                        echo !t192!  !height2k!    
                                                                                        echo.

                                                                                        set /a "width4k=width2k*2"
                                                                                        set /a "height4k=height2k*2"

                                                                                        echo !t20!  !width4k! 
                                                                                        echo !t21!  !height4k!    
                                                                                        echo.
                                                                                    )  
                                                        )                          
                                                  

:cropmanuale_InserimentoUpScalingUpgradingda1080p8o10bita2160p

set /a "csup=0"
set /a "cinf=0"
set /a "csin=0"
set /a "cdes=0"
set /a "bandasuperiore=0"
set /a "bandainferiore=0"
set /a "bandasinistra=0"
set /a "bandadestra=0"
set /a "differenzialelarghezza1080pnvenc=0"
set /a "differenzialealtezza1080pnvenc=0"
if exist ".\temp\Temp_HDR10_Stream.txt" ( del ".\temp\Temp_HDR10_Stream.txt" ) 
if exist ".\temp\durata_film.txt" ( del ".\temp\durata_film.txt" )
if exist ".\temp\crop.txt" ( del ".\temp\crop.txt" )
if exist ".\temp\risultato_multiplo.txt" ( del ".\temp\risultato_multiplo.txt" )
if exist ".\temp\crop_multiplo.txt" ( del ".\temp\crop_multiplo.txt" )
if exist ".\temp\crop_finale.txt" ( del ".\temp\crop_finale.txt" )

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t22!"   
    if errorlevel 2 goto cropmanualeNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
    if errorlevel 1 goto finecropNVEncUpScaling_InserimentoUpScalingUpgradingda1080p8o10bita2160p
)

CHOICE /N /C:SN /M "!t22!"   

if errorlevel 2 goto cropmanualeNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 1 goto finecropNVEncUpScaling_InserimentoUpScalingUpgradingda1080p8o10bita2160p


:cropmanualeNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
echo.
echo !t23!
echo.

:banda_superiore_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set /p "bandasuperiore=!t24!"
SET "var="&for /f "delims=0123456789" %%i in ("!bandasuperiore!") do set var=!bandasuperiore!
if defined var (
                echo.
                echo !t25!
                echo.
                goto banda_superiore_InserimentoUpScalingUpgradingda1080p8o10bita2160p
                ) else (
                        set /a "csup=!bandasuperiore!/2*2"
                        )

echo.
:banda_inferiore_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set /p "bandainferiore=!t26!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandainferiore!") do set var=!bandainferiore!
if defined var (
                echo.
                echo !t27!
                echo.
                goto banda_inferiore_InserimentoUpScalingUpgradingda1080p8o10bita2160p
                ) else (
                        set /a "cinf=!bandainferiore!/2*2"
                        )


echo.
:banda_sinistra_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set /p "bandasinistra=!t28!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandasinistra!") do set var=!bandasinistra!
if defined var (
                echo.
                echo !t29!
                echo.
                goto banda_sinistra_InserimentoUpScalingUpgradingda1080p8o10bita2160p
                ) else (
                        set /a "csin=!bandasinistra!/2*2"
                        )

                        
echo.
:banda_destra_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set /p "bandadestra=!t30!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandadestra!") do set var=!bandadestra!
if defined var (
                echo.
                echo !t31!
                echo.
                goto banda_destra_InserimentoUpScalingUpgradingda1080p8o10bita2160p
                ) else (
                        set /a "cdes=!bandadestra!/2*2"
                        )


set /a "larghezza1080pnvenc=1920"
set /a "altezza1080pnvenc=1080"
@REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
@REM echo altezza1080pnvenc = !altezza1080pnvenc!                                    

set /a "mwidth=!widthvideo!/2*2"
set /a "mheight=!heightvideo!/2*2"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "mwidthc=!mwidth!-!csin!-!cdes!"
set /a "mheightc=!mheight!-!csup!-!cinf!"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!mwidthc!"
set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!mheightc!"
@REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
@REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

echo.
echo !t32!  !csup! 
echo !t33!  !cinf! 
echo !t34!  !csin! 
echo !t35!  !cdes! 
echo.


set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
echo Crop Settings: !cropff!
echo.

echo !t36!  !mwidthc! 
echo !t37!  !mheightc! 
echo.



if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                        @REM echo dentro il 1o if
                                                                                        set /a "width2k=!mwidthc!"
                                                                                        set /a "height2k=!mheightc!"
                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                set /a "width2k=!mwidthc!"
                                                                                                                                                                                set /a "height2k=!mheightc!"
                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                        set /a "width2k=!mwidthc!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                        set /a "height2k=!mheightc!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                set /a "width2k=!mwidthc!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                set /a "height2k=!mheightc!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                )
                                                                                        if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                        set /a "width2k=!mwidthc!"
                                                                                                                                                                        set /a "height2k=!mheightc!"
                                                                                                                                                                        )
                                                                                                                                                                        
                                                                                        if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                set /a "width2k=!mwidthc!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                set /a "height2k=!mheightc!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.                         

                                                                                        echo !t191!  !width2k! 
                                                                                        echo !t192!  !height2k!    
                                                                                        echo.

                                                                                        set /a "width4k=width2k*2"
                                                                                        set /a "height4k=height2k*2"

                                                                                        echo !t20!  !width4k! 
                                                                                        echo !t21!  !height4k!    
                                                                                        echo.
                                                                                    ) 

goto cropmanuale_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:finecropNVEncUpScaling_InserimentoUpScalingUpgradingda1080p8o10bita2160p



echo.
echo !t38!
echo.
echo 1) NVidia 
echo 2) Intel 
echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto doppiopassaggio_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 1 goto singolopassaggio_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:doppiopassaggio_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "SchedaGrafica=Intel"
@REM echo SchedaGrafica = !SchedaGrafica!
goto fineSceltaSchedaGrafica_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:singolopassaggio_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "SchedaGrafica=NVidia"
@REM echo SchedaGrafica = !SchedaGrafica!

:fineSceltaSchedaGrafica_InserimentoUpScalingUpgradingda1080p8o10bita2160p

@REM pause 

if !SchedaGrafica!==NVidia (
                                goto InserimentoImpostazioniNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
                                ) 





if !SchedaGrafica!==Intel (
                                goto InserimentoImpostazioniQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
                                 )


@REM pause 


rem//////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////


:InserimentoImpostazioniNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p


echo.
echo !t40!
echo.
echo 1) CQP 
echo 2) VBR 
echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto CodificaVBRNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 1 goto CodificaCQPNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:CodificaVBRNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "TipoCodificaNVEnc=--vbr "
set /a "quantizzazioneNVEnc=0"
goto inserimentoValoriCQPVBRNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:CodificaCQPNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "TipoCodificaNVEnc=--cqp "
set /a "quantizzazioneNVEnc=1"

:inserimentoValoriCQPVBRNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

if !quantizzazioneNVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneNVEnc=!t44!" 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneNVEnc!") do set var=!valoreQuantizzazioneNVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                echo.
                                                goto inserimentoValoriCQPVBRNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
                                                ) 

                                set /a "valoreQuantizzazioneNVEnc=!valoreQuantizzazioneNVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneNVEnc!
                                if !valoreQuantizzazioneNVEnc! GEQ 10 if !valoreQuantizzazioneNVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneNVEnc!
                                                                                                                set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreQuantizzazioneNVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                                goto fineQuantizzazioneNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
                                                                                                                        
                                )



if !quantizzazioneNVEnc!==0 (
                                echo.
                                set /p "valoreBitRateNVEnc=!t46!" 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateNVEnc!") do set var=!valoreBitRateNVEnc!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                echo.
                                                goto inserimentoValoriCQPVBRNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
                                                ) 
                                set /a "valoreBitRateNVEnc=!valoreBitRateNVEnc!"
                                @REM echo valoreBitRateNVEnc = !valoreBitRateNVEnc!
                                if !valoreBitRateNVEnc! GEQ 100 if !valoreBitRateNVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateNVEnc!
                                                                                                        set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreBitRateNVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                        goto fineQuantizzazioneNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
                                                                                                              
                                )


:fineQuantizzazioneNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p


echo.
echo !t50!
echo.
echo 1) P1 !t51!
echo 2) P2 
echo 3) P3 
echo 4) P4 
echo 5) P5 
echo 6) P6 
echo 7) P7 !t52!
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto P7NVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 6 goto P6NVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 5 goto P5NVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 4 goto P4NVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 3 goto P3NVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 2 goto P2NVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 1 goto P1NVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p


:P7NVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "SettaggioQualitaNVEnc=--preset P7"
set "QualitySetting=P7"
goto fineQualitCodificaNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:P6NVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "SettaggioQualitaNVEnc=--preset P6"
set "QualitySetting=P6"
goto fineQualitCodificaNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:P5NVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "SettaggioQualitaNVEnc=--preset P5"
set "QualitySetting=P5"
goto fineQualitCodificaNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:P4NVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "SettaggioQualitaNVEnc=--preset P4"
set "QualitySetting=P4"
goto fineQualitCodificaNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:P3NVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "SettaggioQualitaNVEnc=--preset P3"
set "QualitySetting=P3"
goto fineQualitCodificaNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:P2NVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "SettaggioQualitaNVEnc=--preset P2"
set "QualitySetting=P2"
goto fineQualitCodificaNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:P1NVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "SettaggioQualitaNVEnc=--preset P1"
set "QualitySetting=P1"
goto fineQualitCodificaNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p


:fineQualitCodificaNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaNVEnc!


echo.
echo !t71!
echo !t72!
echo.
echo 1) NVEnc Color Correction 
echo 2) LibPlacebo Color Correction 
echo 3) NVidia Color Correction 

echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto NVidiaColorCorrection_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 2 goto LibPlaceboColorCorrectionNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 1 goto NVEncColorCorrection_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:NVEncColorCorrection_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "NVEncColorCorrectionSystem=--vpp-colorspace colorprim=bt709:bt2020,transfer=bt709:smpte2084,matrix=bt709:bt2020nc --vpp-tweak brightness=0.1,contrast=1.2,saturation=1.1"
set "NVEncUpgrader=NVEnc Color Correction"
goto NVEncFineSelezioneUpGrader_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:LibPlaceboColorCorrectionNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "NVEncColorCorrectionSystem=--vpp-libplacebo-tonemapping src_csp=sdr,dst_csp=hdr10"
set "NVEncUpgrader=LibPlacebo Color Correction"
goto NVEncFineSelezioneUpGrader_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:NVidiaColorCorrection_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "NVEncColorCorrectionSystem=--vpp-ngx-truehdr"
set "NVEncUpgrader=NVidia Color Correction"

:NVEncFineSelezioneUpGrader_InserimentoUpScalingUpgradingda1080p8o10bita2160p
echo.
echo !t73! !NVEncUpgrader!
echo.
echo !t43! !NVEncColorCorrectionSystem!



:sceltadenoiser
set conv3d1080p=
set pmd1080p=
set /a unicopassaggio=0

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t55!"
    if errorlevel 2 goto conv3dChoosenNoNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
    if errorlevel 1 goto conv3dChoosenYesNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
)

echo.
CHOICE /N /C:SN /M "!t55!"

if errorlevel 2 goto conv3dChoosenNoNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 1 goto conv3dChoosenYesNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:conv3dChoosenNoNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "conv3d1080p=N"
goto sceltaDeniserPMDNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:conv3dChoosenYesNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "conv3d1080p=S"



:sceltaDeniserPMDNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t56!"
    if errorlevel 2 goto PMDChoosenNoNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
    if errorlevel 1 goto PMDChoosenYesNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
)

echo.
CHOICE /N /C:SN /M "!t56!"

if errorlevel 2 goto PMDChoosenNoNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 1 goto PMDChoosenYesNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:PMDChoosenNoNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "pmd1080p=N"
goto assegnazioneDenoisesNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:PMDChoosenYesNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "pmd1080p=S"


:assegnazioneDenoisesNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set /A nvdenv=0

if !conv3d1080p!==S if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00 --vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==S if !pmd1080p!==N ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==N ( 
                                        set "nvdenoiser=nessuno" 
                                        set "nvdenv=1"
                                        set "unicopassaggio=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: Nessun Denoiser 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )

@REM pause


echo.
if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t57!"
    if errorlevel 2 goto ApplicaMiglioramentoDettagliNVEncNo_InserimentoUpScalingUpgradingda1080p8o10bita2160p
    if errorlevel 1 goto ApplicaMiglioramentoDettagliNVEncSi_InserimentoUpScalingUpgradingda1080p8o10bita2160p
)
CHOICE /N /C:SN /M "!t57!"

if errorlevel 2 goto ApplicaMiglioramentoDettagliNVEncNo_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 1 goto ApplicaMiglioramentoDettagliNVEncSi_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:ApplicaMiglioramentoDettagliNVEncNo_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "miglioramento1080p=N"
goto fineSceltaMigliaramentiNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:ApplicaMiglioramentoDettagliNVEncSi_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "miglioramento1080p=S"

:fineSceltaMigliaramentiNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if !miglioramento1080p!==S ( 
                                set "edgeleveling=--vpp-edgelevel strength=10.0,threshold=24.0,black=6,white=0" 
                                echo.
                                echo NVEnc !t58!
                                echo.
                                )
if !miglioramento1080p!==N ( 
                                set "edgeleveling=nessuno" 
                                echo.
                                echo NVEnc !t59!
                                echo.
                                )


@REM pause


if !nvdenoiser!==nessuno if !edgeleveling!==nessuno (
                                                        set "unicopassaggio=1"
                                                        goto fineConfigurazioneOperazioniUpScalingNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
                                                        )


echo.
echo !t75!
echo !t76!
echo.
echo !t77!
echo !t78!

echo.
CHOICE /N /C:123 /M "!t39!"

if errorlevel 2 goto OperazioniUpScalingSingolaCodificaNvEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 1 goto OperazioniUpScalingDoppiaCodificaNvEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:OperazioniUpScalingSingolaCodificaNvEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "unicopassaggio=1"
goto fineConfigurazioneOperazioniUpScalingNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:OperazioniUpScalingDoppiaCodificaNvEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "unicopassaggio=0"

:fineConfigurazioneOperazioniUpScalingNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p


set file_senza_virgolette=%NomeFile:"=%
rem echo %file_senza_virgolette%

set file_senza_estensione=%file_senza_virgolette:.mkv=%
rem echo %file_senza_estensione%

set fileoutput2160p="%file_senza_estensione%_UpScaled_2160p_10_bit_HDR.mkv"
rem echo fileoutput2160p = %fileoutput2160p%

echo.
set "VideoInfoCodifica=NVEnc_UpScaling_UpGrading_da_1080p_a_2160p|!NomeFile!|!fileoutput2160p!|nessuno|!cropff!|!width4k!x!height4k!|!width2k!x!height2k!|nessuno|!colorpr!|!colortr!|!colorsp!|!tipoQuantizzazioneNVEnc!|!SettaggioQualitaNVEnc!|nessuno|nessuno|!nvdenoiser!|!formatvideo!|!edgeleveling!|!NVEncColorCorrectionSystem!|!unicopassaggio!|no_lokahead|no_precisione_vettore_movimento"
@REM echo VideoInfoCodifica = !VideoInfoCodifica!
@REM echo.

if exist ".\saved\savedmoviesallencodings.dat" ( 
                                                echo !VideoInfoCodifica! >> .\saved\savedmoviesallencodings.dat
                                                goto finesalvataggioInserimentoNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
                                                ) 

echo !VideoInfoCodifica! > .\saved\savedmoviesallencodings.dat


:finesalvataggioInserimentoNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

echo !t60! !numeromovie! !t61!
echo.

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t62!"
    if errorlevel 2 goto finesceltanuovovideodacodificareNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
    if errorlevel 1 goto sialtrivideodainserireMenuNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
)
CHOICE /N /C:SN /M "!t62!"
echo.

if errorlevel 2 goto finesceltanuovovideodacodificareNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 1 goto sialtrivideodainserireMenuNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:sialtrivideodainserireMenuNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set /a "numeromovie+=1"
echo.
goto altrivideodainserireNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:finesceltanuovovideodacodificareNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
echo.
goto fineinfovideo_InserimentoUpScalingUpgradingda1080p8o10bita2160p


rem//////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////



:InserimentoImpostazioniQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p


echo.
echo !40!
echo.
echo 1) CQP 
echo 2) ICQ 
echo 3) LA-ICQ 
echo 4) VBR 
echo.
CHOICE /N /C:1234 /M "!t64!"

if errorlevel 4 goto CodificaVBRQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 3 goto CodificaLAICQQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 2 goto CodificaICQQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 1 goto CodificaCQPQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p


:CodificaCQPQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "TipoCodificaQSVEnc=--cqp "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:CodificaICQQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "TipoCodificaQSVEnc=--icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:CodificaLAICQQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "TipoCodificaQSVEnc=--la-icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:CodificaVBRQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "TipoCodificaQSVEnc=--vbr "
set /a "quantizzazioneQSVEnc=0"
goto inserimentoValoriCQPVBRQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p


:inserimentoValoriCQPVBRQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

if !quantizzazioneQSVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneQSVEnc=!t44!" 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneQSVEnc!") do set var=!valoreQuantizzazioneQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                echo.
                                                goto inserimentoValoriCQPVBRQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
                                                ) 

                                set /a "valoreQuantizzazioneQSVEnc=!valoreQuantizzazioneQSVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneQSVEnc!
                                if !valoreQuantizzazioneQSVEnc! GEQ 10 if !valoreQuantizzazioneQSVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneQSVEnc!
                                                                                                                set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreQuantizzazioneQSVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                                goto fineQuantizzazioneQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
                                                                                                                        
                                )



if !quantizzazioneQSVEnc!==0 (
                                echo.
                                set /p "valoreBitRateQSVEnc=!t46!" 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateQSVEnc!") do set var=!valoreBitRateQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                echo.
                                                goto inserimentoValoriCQPVBRQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
                                                ) 
                                set /a "valoreBitRateQSVEnc=!valoreBitRateQSVEnc!"
                                @REM echo valoreBitRateQSVEnc = !valoreBitRateQSVEnc!
                                if !valoreBitRateQSVEnc! GEQ 100 if !valoreBitRateQSVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateQSVEnc!
                                                                                                        set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreBitRateQSVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                        goto fineQuantizzazioneQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
                                                                                                              
                                )


:fineQuantizzazioneQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p



echo.
echo !t50!
echo.
echo 1) Best 
echo 2) Higher 
echo 3) High 
echo 4) Balanced 
echo 5) Fast 
echo 6) Faster 
echo 7) Fastest 
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto QualitFastestQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 6 goto QualitFasterQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 5 goto QualitFastQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 4 goto QualitBalancedtQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 3 goto QualitHighQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 2 goto QualitHigherQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 1 goto QualitBestQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p


:QualitBestQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "SettaggioQualitaQSvenc=--quality best"
set "QualitySetting=best"
goto fineQualitCodificaQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:QualitHigherQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "SettaggioQualitaQSvenc=--quality higher"
set "QualitySetting=higher"
goto fineQualitCodificaQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:QualitHighQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "SettaggioQualitaQSvenc=--quality high"
set "QualitySetting=high"
goto fineQualitCodificaQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:QualitBalancedtQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "SettaggioQualitaQSvenc=--quality balanced"
set "QualitySetting=balanced"
goto fineQualitCodificaQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:QualitFastQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "SettaggioQualitaQSvenc=--quality fast"
set "QualitySetting=fast"
goto fineQualitCodificaQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:QualitFasterQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "SettaggioQualitaQSvenc=--quality faster"
set "QualitySetting=faster"
goto fineQualitCodificaQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:QualitFastestQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "SettaggioQualitaQSvenc=--quality fastest"
set "QualitySetting=fastest"
goto fineQualitCodificaQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p


:fineQualitCodificaQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaQSvenc!



echo.
echo !t71!
echo !t72!
echo.
echo 1) QSVEnc Color Correction 
echo 2) LibPlacebo Color Correction 

echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto LibPlaceboColorCorrectionQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 1 goto QSVEncColorCorrection_InserimentoUpScalingUpgradingda1080p8o10bita2160p


:QSVEncColorCorrection_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "QSVEncColorCorrectionSystem=--vpp-colorspace colorprim=bt709:bt2020,transfer=bt709:smpte2084,matrix=bt709:bt2020nc --vpp-tweak brightness=0.1,contrast=1.2,saturation=1.1"
set "QSVEncUpgrader=QSVEnc Color Correction"
goto QSVEncFineSelezioneUpGrader_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:LibPlaceboColorCorrectionQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "QSVEncColorCorrectionSystem=--vpp-libplacebo-tonemapping src_csp=sdr,dst_csp=hdr10"
set "QSVEncUpgrader=LibPlacebo Color Correction"


:QSVEncFineSelezioneUpGrader_InserimentoUpScalingUpgradingda1080p8o10bita2160p
echo.
echo !t73! !QSVEncUpgrader!
echo.
echo !t43! !QSVEncColorCorrectionSystem!



:sceltadenoiserQSVEnc
set conv3d1080p=
set pmd1080p=
set /a unicopassaggio=0


if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t55!"
    if errorlevel 2 goto conv3dChoosenNoQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
    if errorlevel 1 goto conv3dChoosenYesQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
)

echo.
CHOICE /N /C:SN /M "!t55!"

if errorlevel 2 goto conv3dChoosenNoQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 1 goto conv3dChoosenYesQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:conv3dChoosenNoQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "conv3d1080p=N"
goto sceltaDeniserPMDQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:conv3dChoosenYesQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "conv3d1080p=S"



:sceltaDeniserPMDQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t56!"
    if errorlevel 2 goto PMDChoosenNoQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
    if errorlevel 1 goto PMDChoosenYesQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
)
echo.
CHOICE /N /C:SN /M "!t56!"

if errorlevel 2 goto PMDChoosenNoQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 1 goto PMDChoosenYesQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:PMDChoosenNoQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "pmd1080p=N"
goto assegnazioneDenoisesQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:PMDChoosenYesQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "pmd1080p=S"


:assegnazioneDenoisesQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set /A nvdenv=0

if !conv3d1080p!==S if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00 --vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==S if !pmd1080p!==N ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==N ( 
                                        set "nvdenoiser=nessuno" 
                                        set "nvdenv=1"
                                        set "unicopassaggio=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: Nessun Denoiser 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )

@REM pause

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t57!"
    if errorlevel 2 goto ApplicaMiglioramentoDettagliQSVEncNo_InserimentoUpScalingUpgradingda1080p8o10bita2160p
    if errorlevel 1 goto ApplicaMiglioramentoDettagliQSVEncSi_InserimentoUpScalingUpgradingda1080p8o10bita2160p
)
echo.
CHOICE /N /C:SN /M "!t57!"

if errorlevel 2 goto ApplicaMiglioramentoDettagliQSVEncNo_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 1 goto ApplicaMiglioramentoDettagliQSVEncSi_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:ApplicaMiglioramentoDettagliQSVEncNo_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "miglioramento1080p=N"
goto fineSceltaMigliaramentiQSCEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:ApplicaMiglioramentoDettagliQSVEncSi_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "miglioramento1080p=S"

:fineSceltaMigliaramentiQSCEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if !miglioramento1080p!==S ( 
                                set "edgeleveling=--vpp-edgelevel strength=10.0,threshold=24.0,black=6,white=0" 
                                echo.
                                echo QSVEnc !t58!
                                echo.
                                )
if !miglioramento1080p!==N ( 
                                set "edgeleveling=nessuno" 
                                echo.
                                echo QSVEnc !t59!
                                echo.
                                )


@REM pause

if !nvdenoiser!==nessuno if !edgeleveling!==nessuno (
                                                        set "unicopassaggio=1"
                                                        goto fineConfigurazioneOperazioniUpScalingQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
                                                        )

echo.
echo !t75!
echo !t76!
echo.
echo !t77!
echo !t78!

echo.
CHOICE /N /C:123 /M "!t39!"

if errorlevel 2 goto OperazioniUpScalingSingolaCodificaQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 1 goto OperazioniUpScalingDoppiaCodificaQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:OperazioniUpScalingSingolaCodificaQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "unicopassaggio=1"
goto fineConfigurazioneOperazioniUpScalingQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:OperazioniUpScalingDoppiaCodificaQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set "unicopassaggio=0"

:fineConfigurazioneOperazioniUpScalingQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p



set file_senza_virgolette=%NomeFile:"=%
rem echo %file_senza_virgolette%

set file_senza_estensione=%file_senza_virgolette:.mkv=%
rem echo %file_senza_estensione%

set fileoutput2160p="%file_senza_estensione%_UpScaled_2160p_10_bit_HDR.mkv"
rem echo fileoutput2160p = %fileoutput2160p%

echo.
set "VideoInfoCodifica=QSVEnc_UpScaling_UpGrading_da_1080p_a_2160p|!NomeFile!|!fileoutput2160p!|nessuno|!cropff!|!width4k!x!height4k!|!width2k!x!height2k!|nessuno|!colorpr!|!colortr!|!colorsp!|!tipoQuantizzazioneQSVEnc!|!SettaggioQualitaQSVEnc!|nessuno|nessuno|!nvdenoiser!|!formatvideo!|!edgeleveling!|!QSVEncColorCorrectionSystem!|!unicopassaggio!|no_lokahead|no_precisione_vettore_movimento"
@REM echo VideoInfoCodifica = !VideoInfoCodifica!
@REM echo.

if exist ".\saved\savedmoviesallencodings.dat" ( 
                                                echo !VideoInfoCodifica! >> .\saved\savedmoviesallencodings.dat
                                                goto finesalvataggioInserimentoQSEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
                                                ) 

echo !VideoInfoCodifica! > .\saved\savedmoviesallencodings.dat


:finesalvataggioInserimentoQSEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

echo !t60! !numeromovie! !t61!
echo.

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t62!"
    if errorlevel 2 goto finesceltanuovovideodacodificareQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
    if errorlevel 1 goto sialtrivideodainserireMenuQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
)
CHOICE /N /C:SN /M "!t62!"
echo.

if errorlevel 2 goto finesceltanuovovideodacodificareQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
if errorlevel 1 goto sialtrivideodainserireMenuQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:sialtrivideodainserireMenuQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
set /a "numeromovie+=1"
echo.
goto altrivideodainserireNVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p

:finesceltanuovovideodacodificareQSVEnc_InserimentoUpScalingUpgradingda1080p8o10bita2160p
echo.
goto fineinfovideo_InserimentoUpScalingUpgradingda1080p8o10bita2160p



rem//////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////





:novideofile1080p_InserimentoUpScalingUpgradingda1080p8o10bita2160p
echo !t63!
echo.



:fineinfovideo_InserimentoUpScalingUpgradingda1080p8o10bita2160p


if exist ".\temp\Temp_HDR10_Stream.txt" ( del .\temp\Temp_HDR10_Stream.txt )
if exist ".\temp\durata_film.txt" ( del .\temp\durata_film.txt )
if exist ".\temp\crop.txt" ( del .\temp\crop.txt )
if exist ".\temp\risultato_multiplo.txt" ( del .\temp\risultato_multiplo.txt )
if exist ".\temp\crop_multiplo.txt" ( del .\temp\crop_multiplo.txt )
if exist ".\temp\crop_finale.txt" ( del .\temp\crop_finale.txt )
      




set waitenter=
set /P waitenter=!t65!
Endlocal
goto InserimentoCodifcaInCodaeSalvataggioSuDisco




rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:InserimentoCodificaHardwareH265

cls
setLocal EnableExtensions EnableDelayedExpansion





for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoInserimentoCodificaHardwareH265
)

if %lingua%==inglese (
    goto caricalinguaingleseInserimentoCodificaHardwareH265
)



:caricalinguaingleseInserimentoCodificaHardwareH265
set t1=Insert Hardware Video Encoding Info and Saving to Disk

set t2=Drag Here the
set t211=Video for Hardware Encoding with GPU:  

set t3=File does not exist 
set t4=Info Video:  

set t5=The Inserted Video is 2160p 8bit SDR 
set t511=The Inserted Video is 2160p 10bit SDR 

set t6=The Inserted Video isn't 2160p 8bit or 10bit SDR 
set t7=Video Duration in seconds:
set t8=Video Duration in Minutes:
set t9=Interval between Frames for Crop Detection:
set t10= seconds
set t11=Black Bands Detection Started....
set t12=Crop Detection to Frame
set t13=to seconds
set t14=Done...
set t15=Original 2160p Video Width: 
set t16=Original 2160p Video Height:
set t17=Original Video Width Without Black Bars:
set t18=Original Video Height Without Black Bars:

set t171=Output Video 1080p Width Without Black Bars:
set t181=Outout Video 1080p Height Without Black Bars:

set t19=Adapting Video Resolution to Full 2160p Format...
set t20=Final 2160p Output Video Width:
set t21=Final 2160p Output Video Height:

set t22=Settings of Black Bands to Crop are Correct (Yes/No):
set t23=Manually Entering Black Bands Values to Crop... 
set t24=Enter the Upper Black Band Value: 
set t25=Error Entering Upper Black Band Value... It's Not a Number. 
set t26=Enter the Lower Black Band Value: 
set t27=Error Entering Lower Black Band Value... It's Not a Number.
set t28=Enter the Left Black Band Value: 
set t29=Error Entering Left Black Band Value... It's Not a Number.
set t30=Enter the Right Black Band Value: 
set t31=Error Entering Right Black Band Value... It's Not a Number.
set t32=Upper Black Band:
set t33=Lower Black Band:
set t34=Left Black Band:
set t35=Right Black Band:
set t36=2160p Original Video Width without Black Bars:
set t37=2160p Original Video Height without Black Bars:

@REM set t361=1080p Video Width without Black Bars:
@REM set t371=1080p Video Height without Black Bars

set t38=Select Graphic Card you want to Encode with:
set t39=Choose (1/2):
set t40=Select Encoding Type:
set t41=Error Entering Quantization Value... Not a Number. 
set t42=Quantization Value Set to:
set t43=Encoding Settings:
set t44=Enter Quantization value Minimum 10 Maximum 28:
set t45=Quantization Value Out of  Limits  10 / 28  Re-enter^!
set t46=Enter BitRate Value kbs Minimum 100 Maximum 50000:
set t47=Error Entering BitRate Value... It's Not a Number. 
set t48=BitRate Value Set to:
set t49=BitRate Value Out of Limits  100 / 50000  Re-enter^!
set t50=Select Encoding Quality:
set t51=- Worst Quality
set t52=- Best Quality
set t53=Choose (1/2/3/4/5/6/7):
set t54=Quality Set to:
set t55=Apply Convolution3D denoiser Yes/No: 
set t56=Apply PMD denoiser Yes/No: 
set t57=Apply Detail Enhancement Yes/No:  
set t58=Enhancement Detail: Yes 
set t59=Enhancement Detail: No 
set t60=Info
set t61=Videos to Encode Saved!
set t62=Do You Want to Insert Another Video to Encode (Yes/No):
set t63=The dragged file is not a video!
set t64=Choose (1/2/3/4):
set t65=Press Enter toback to Menu Inserting Encoding into the Queue and Saving to Disk:  

set t66=Video Width
set t67=Video Height
set t68=Video Codec
set t69=Details Video Codec
set t70=Video Format 
set t71=Configuration Settings to convert video from 8bit or 10bit SDR to 10bit HDR
set t72=Select Encoding UpGrader:
set t73=Settings UpGrader:
set t74=Choose (1/2/3):

set t75=Configuration Encoding Lookahead:
set t76=Insert Value of Lookahead (1-32): 
set t77=Error Entering Lookahead Value... Not a Number.
set t78=Lookahead Value Entered Out of Range 1-32
set t79=Lookahead Settings:

set t80=Select type of Adaptive Quantization:
set t81=- Disabled
set t82=Adaptive Quantization Settings:

set t83=Setting Intensity of Adaptive Quantization:
set t84=Insert Value of Adaptive Quantization Intensity (0-15): 
set t85=Value Adaptive Quantization Intensity Entered Out of Range 1-15
set t86=- Automatic
set t87=Adaptive Quantization Intensity Setting:

set t88=Select Motion Vector Accuracy:
set t89=- Best
set t90=- Worst
set t91=Motion Vector Accuracy Setting:

set t92=Select Denoiser:
set t93=No Denoiser
set t94=No Denoiser Selected.

set t95=Select Strength Covolution3D Denoiser:
set t96=Weak
set t97=Moderate
set t98=Strong
set t99=Covolution3D Setting:

set t100=Select Strength PMD Denoiser:
set t101=PMD Denoiser Setting:

set t102=Select Strength FFT3D Denoiser :
set t103=FFT3D Denoiser Setting:

set t104=Select Strength KNN Denoiser:
set t105=KNN Denoiser Setting:

set t106=Select Strength NLMEANS Denoiser:
set t107=NLMEANS Denoiser Setting:

set t108=Select Strength DCT Denoiser:
set t109=DCT Denoiser Setting:

set t110=Insert Value of Lookahead (10-99): 

goto avvio_InserimentoCodificaHardwareH265




:caricalinguaitalianoInserimentoCodificaHardwareH265
set t1=Inserimento Info Codifica Hardware Video e Salvataggio su Disco.

set t2=Trascina Qui il 
set t211=File Video per la Codifica Hardware con la GPU:  

set t3=File Inesistente 
set t4=Informazioni Video:  

set t5=Il Video inserito e' 2160p 8bit SDR 
set t511=Il Video inserito e' 2160p 10bit SDR 

set t6=Il Video inserito non e' 2160p 8bit o 10bit SDR 

set t7=Durata del Video in secondi:
set t8=Durata del video in Minuti:
set t9=Intervallo tra i Fotogrammi per il Rilevamento del crop:
set t10= secondi
set t11=Rilevamento Bande Nere Iniziato....
set t12=Rilevazione crop fotogramma
set t13=a secondi
set t14=Eseguita...
set t15=Larghezza Video 2160p Originale:
set t16=Altezza Video 2160p Originale:
set t17=Larghezza Video Originale Senza Barre Nere:
set t18=Altezza Video Originale Senza Barre Nere:

set t171=Larghezza Video 1080p  Senza Barre Nere:
set t181=Altezza Video 1080p  Senza Barre Nere:

set t19=Adattamento della Risoluzione del Video al Pieno Formato 2160p..
set t20=Larghezza Finale Video 2160p:
set t21=Altezza Finale Video 2160p:

set t22=Le Impostazioni delle Bande Nere da Tagliare sono Corrette (Si/No):
set t23=Inserimento Manuale Valori Bande Nere da Tagliare.. 
set t24=Inserisci il Valore della Banda Nera Superiore: 
set t25=Errore nell'Inserimento del Valore della Banda Nera Superiore... Non e' un Numero. 
set t26=Inserisci il Valore della Banda Nera Inferiore: 
set t27=Errore nell'Inserimento del Valore della Banda Nera Inferiore... Non e' un Numero. 
set t28=Inserisci il Valore della Banda Nera Sinistra: 
set t29=Errore nell'Inserimento del Valore della Banda Nera Sinistra... Non e' un Numero. 
set t30=Inserisci il Valore della Banda Nera Destra: 
set t31=Errore nell'Inserimento del Valore della Banda Nera Destra... Non e' un Numero. 
set t32=Banda Nera Superiore:
set t33=Banda Nera Inferiore:
set t34=Banda Nera Sinistra:
set t35=Banda Nera Destra:
set t36=Larghezza Video Originale 2160p senza Bande Nere:
set t37=Altezza Video Originale 2160p senza Bande Nere:

@REM set t361=Larghezza Video 1080p senza Bande Nere:
@REM set t371=Altezza Video 1080p senza Bande Nere:

set t38=Selezionare Scheda Grafica con cui Eseguire la Codifica:
set t39=Scegli (1/2):
set t40=Selezionare tipo di Codifica:
set t41=Errore nell'Inserimento del Valore della Quantizzazione... Non e' un Numero. 
set t42=Valore Quantizzazzione Impostato a:
set t43=Parametri per codifica:

set t44=Inserire Valore Quantizzazione Minimo 10 Massimo 28:
set t45=Valore Quantizzazzione al di fuori dei  Limiti  10 / 28  Reinserire^!
set t46=Inserire Valore BitRate kbs Minimo 100 Massimo 50000:
set t47=Errore nell'Inserimento del Valore del BitRate... Non e' un Numero. 
set t48=Valore BitRate Impostato a:
set t49=Valore  BitRate al di fuori dei  Limiti  100 / 50000  Reinserire^!

set t50=Selezionare Qualita' Codifica:
set t51=- Peggiore Qualita'
set t52=- Migliore Qualita'
set t53=Scegli (1/2/3/4/5/6/7):
set t54=Qualita' Impostata su:
set t55=Applicare il denoiser Convolution3D Si/No: 
set t56=Applicare il denoiser PMD Si/No: 
set t57=Applicare il Miglioramento Dettagli Si/No:  
set t58=Miglioramento Dettagli: Si 
set t59=Miglioramento Dettagli: No 
set t60=Informazioni
set t61=Video da Codificare Salvate!
set t62=Vuoi Inserire un altro Video da Codificare (Si/No):
set t63=Il file trascinato non e' un video!
set t64=Scegli (1/2/3/4):
set t65=Premi Invio per tornare al menu' Inserimento Codifiche in Coda e Salvataggio sul Disco:  

set t66=Larghezza Video
set t67=Altezza Video
set t68=Codec Video
set t69=Codec Video Dettagli
set t70=Format Video 
set t71=Configurazione Parametri per convertire il video da 8bit o 10bit SDR a 10bit HDR
set t72=Selezionare UpGrader Codifica:
set t73=UpGrader Impostato:
set t74=Scegli (1/2/3):

set t75=Configurazione Lookahead Codifica:
set t76=Inserisci il Valore Lookahead (1-32): 
set t77=Errore nell'Inserimento del Valore Lookahead... Non e' un Numero. 
set t78=Valore Lookahead Inserito fuori dall'Intervallo 1-32
set t79=Lookahead Impostato su:

set t80=Selezionare il tipo di Quantizzazione Adattiva:
set t81=- Disabilitata
set t82=Quantizzazione Adattiva Impostata su:

set t83=Impostare Forza Quantizzazione Adattiva:
set t84=Inserisci il Valore della Forza Quantizzazione Adattativa (0-15): 
set t85=Valore Forza Quantizzazione Adattativa Inserito fuori dall'Intervallo 1-15
set t86=- Automatica
set t87=Forza Quantizzazione Adattiva Impostata su:

set t88=Selezionare la Precisione del Vettore di Movimento:
set t89=- Migliore
set t90=- Peggiore
set t91=Precisione del Vettore di Movimento Impostata su:

set t92=Selezionare il tipo di Denoiser:
set t93=Nessun Denoiser
set t94=Nessun Denoiser Selezionato.

set t95=Selezionare Forza Denoiser Covolution3D:
set t96=Leggero
set t97=Medio
set t98=Forte
set t99=Covolution3D Denoiser Impostato su:

set t100=Selezionare Forza Denoiser PMD:
set t101=PMD Denoiser Impostato su:

set t102=Selezionare Forza Denoiser FFT3D:
set t103=FFT3D Denoiser Impostato su:

set t104=Selezionare Forza Denoiser KNN:
set t105=KNN Denoiser Impostato su:

set t106=Selezionare Forza Denoiser NLMEANS:
set t107=NLMEANS Denoiser Impostato su:

set t108=Selezionare Forza Denoiser DCT:
set t109=DCT Denoiser Impostato su:

set t110=Inserisci il Valore Lookahead (10-99): 
set t111=Valore Lookahead Inserito fuori dall'Intervallo 10-99
goto avvio_InserimentoCodificaHardwareH265

:avvio_InserimentoCodificaHardwareH265




set /a "numeromovie=1"


echo !t1!
echo.


:altrivideodainserireNVEnc_InserimentoCodificaHardwareH265


set NomeFile=
rem set MetadatiStreamHDR10=

set /P NomeFile=!t2! !numeromovie! !t211! 
rem echo Hai digitato: %NomeFile%
rem pause

set "NomeFileSorgente=!NomeFile:"=!"
@REM echo NomeFileSorgente = !NomeFileSorgente!
set "NomeFile=^"!NomeFileSorgente!^""
@REM echo NomeFile = !NomeFile!
rem pause


if exist %NomeFile% ( goto infovideo_InserimentoCodificaHardwareH265 ) else ( 
                                                        echo.
                                                        echo !t3!
                                                        echo.
                                                        goto fineinfovideo_InserimentoCodificaHardwareH265
                                                        )    



:infovideo_InserimentoCodificaHardwareH265
echo.
echo !t4!
echo.

.\bin\ffprobe -v error -hide_banner -select_streams v:0 -show_entries stream=width,height,codec_name,codec_long_name,pix_fmt,color_space,color_transfer,color_primaries -of default=noprint_wrappers=1 %NomeFile% > ".\temp\Temp_HDR10_Stream.txt"

set /A x1=1

rem echo nohdr = %nohdr%

for /f "tokens=1,2 delims==" %%a in (.\temp\Temp_HDR10_Stream.txt) do (if !x1!==3 ( 
                                                                            echo !t66! "%%a" = %%b  
                                                                            set /A "widthvideo=%%b"
                                                                            )
                                                                if !x1!==4 ( 
                                                                            echo !t67! "%%a" = %%b  
                                                                            set /A "heightvideo=%%b"
                                                                            )                                                           
                                                                if !x1!==6 ( 
                                                                            echo Color Space "%%a" = %%b  
                                                                            set "colorsp=%%b"              
                                                                            ) 
                                                                if !x1!==7 ( 
                                                                            echo Color Transfer "%%a" = %%b  
                                                                            set "colortr=%%b"      
                                                                            ) 
                                                                if !x1!==8 ( 
                                                                            echo Color Primaries "%%a" = %%b  
                                                                            set "colorpr=%%b"         
                                                                            )    
                                                                if !x1!==1 ( 
                                                                            echo !t68! "%%a" = %%b  
                                                                            )       
                                                                if !x1!==2 ( 
                                                                            echo !t69! "%%a" = %%b  
                                                                            )   
                                                                if !x1!==5 ( 
                                                                            echo !t70! "%%a" = %%b  
                                                                            set "formatvideo=%%b"
                                                                            )
                                                                set /A x1+=1                                                            
)

if !x1!==1 goto novideofile_InserimentoCodificaHardwareH265



:rilevazionebandenere_InserimentoCodificaHardwareH265

.\bin\ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 %NomeFile%  > ".\temp\durata_film.txt"


set /a contatore=1
for /f "tokens=1 delims=." %%a in (.\temp\durata_film.txt) do  (
                                                        echo. 
                                                       echo !t7! %%a
                                                        set /a "secondi=%%a"
                                                        set /a "minuti=!secondi!/60"
                                                        echo !t8! !minuti!
                                                        set /a "intervallo_tagli=!secondi!/11"
                                                        echo !t9! !intervallo_tagli!!t10!
                                                        echo.
                                                        echo !t11!
                                                        echo.

                                                        

                                                        FOR /L %%a IN (1, 1, 10) DO (
                                                                                    rem echo %%a
                                                                                    set /a "secondi=%%a*!intervallo_tagli!"
                                                                                    rem echo !secondi!

                                                                                    if !formatvideo!==yuv420p (
                                                                                                                set /a "ca=16"
                                                                                                                rem echo !ca!
                                                                                                                    
                                                                                                                set /a "cb=2"
                                                                                                                rem echo !cb!
                                                                                                                    
                                                                                                                set /a "cc=0"
                                                                                                                rem echo !cc!

                                                                                                                set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                                                rem echo !cr!
                                                                                                                )

                                                                                    if !formatvideo!==yuv420p10le  ( 
                                                                                                                    set /a "ca=72"
                                                                                                                    rem echo !ca!
                                                                                                                    
                                                                                                                    set /a "cb=2"
                                                                                                                    rem echo !cb!
                                                                                                                    
                                                                                                                    set /a "cc=0"
                                                                                                                    rem echo !cc!

                                                                                                                    set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                                                    rem echo !cr!
                                                                                                                    )                                                                                                                

                                    
                                                                                
                                                                                
                                                                                    .\bin\ffmpeg -ss !secondi! -hide_banner -nostats -i %NomeFile% -vframes 10 -vf !cr! -f null - 2> ".\temp\crop.txt"
                                                                                    
                                                                                    findstr /r "Parsed_cropdetect_0" .\temp\crop.txt >> .\temp\risultato_multiplo.txt   
                                                                                    
                                                                                    echo !t12! %%a !t13! !secondi! !t14!
                                                                                    
                                                                                    )       
                                                                                       

                                                                                    for /f "tokens=1,2 delims==" %%a in (.\temp\risultato_multiplo.txt) do ( echo %%b >> .\temp\crop_multiplo.txt )
                                                                                    
                                                                                    set /a "maxfrequenza=0"

                                                                                    for /f "delims=" %%a in (.\temp\crop_multiplo.txt) do ( 
                                                                                                                                    set "cropconfront=%%a"
                                                                                                                                    rem echo "!cropconfront!"
                                                                                                                                    
                                                                                                                                    set /a "contatorfrequenza=0"
                                                                                                                                    for /f "delims=" %%b in (.\temp\crop_multiplo.txt) do (
                                                                                                                                                                                    set "dato_da_verificare=%%b"
                                                                                                                                                                                    rem echo cropconfront = "!cropconfront!"
                                                                                                                                                                                    rem echo dato_da_verificare = "!dato_da_verificare!"
                                                                                                                                                                                    if !cropconfront!==!dato_da_verificare! ( set /a "contatorfrequenza+=1")
                                                                                                                                                                                    )
                                                                                                                                    if !maxfrequenza! LSS !contatorfrequenza! ( 
                                                                                                                                                                                set /a "maxfrequenza=!!contatorfrequenza!!"
                                                                                                                                                                                set "cropd=!cropconfront!"
                                                                                                                                                                                )
                                                                                                                                    

                                                                                                                                    rem if !cropconfront! in (elenco_crop_frequenza.txt) ()
                                                                                                                                    rem echo !cropconfront!:!contatorfrequenza! >> elenco_crop_frequenza.txt

                                                                                                                                    )

                                                                                    rem echo crop piu' frequente = !cropd! con grequenza = !maxfrequenza!
                                                                                    echo !cropd! > .\temp\crop_finale.txt

                                                                                    for /f "tokens=1,2,3,4 delims=:" %%a in (.\temp\crop_finale.txt) do  ( 
                                                                                                                                                    rem set /a "mwidth=%%a"
                                                                                                                                                    rem echo mwidth = !mwidth!

                                                                                                                                                    rem set /a "mheight=%%b"
                                                                                                                                                    rem echo mheight = !mheight!

                                                                                                                                                    rem set /a "mx=%%c"
                                                                                                                                                    rem echo mx = !mx!

                                                                                                                                                    rem set /a "my=%%d"
                                                                                                                                                    rem echo my = !my!

                                                                                                                                                    if !contatore!==1 ( 
                                                                                                                                                                set /a "wmax=%%a" 
                                                                                                                                                                set /a "hmax=%%b"
                                                                                                                                                                set /a "xmin=%%c"
                                                                                                                                                                set /a "ymin=%%d"
                                                                                                                                                                set /a "mwidth=%%a"
                                                                                                                                                                set /a "mheight=%%b"
                                                                                                                                                                set /a "mx=%%c"
                                                                                                                                                                set /a "my=%%d"
                                                                                                                                                                set /a "contatore+=1"
                                                                                                                                                                )
                                                                                                                                                    
                                                                                                                                                    rem if %%b gtr !hmax! if %%c gtr !xmin! if %%d gtr !ymin! 

                                                                                                                                                    if %%a geq !wmax! if %%b geq !hmax! ( 
                                                                                                                                                                        set /a "wmax=%%a" 
                                                                                                                                                                        set /a "hmax=%%b"
                                                                                                                                                                        set /a "xmin=%%c"
                                                                                                                                                                        set /a "ymin=%%d"
                                                                                                                                                                        set /a "mwidth=%%a"
                                                                                                                                                                        set /a "mheight=%%b"
                                                                                                                                                                        set /a "mx=%%c"
                                                                                                                                                                        set /a "my=%%d"
                                                                                                                                                                        )
                                                                                                                                                    )
                                                                                    echo.
                                                                                    
                                                                                    set /a "mwidth=!mwidth!/2*2"
                                                                                    set /a "mheight=!mheight!/2*2"

                                                                                    set /a "csup=!my!/2*2"
                                                                                    rem echo csup = !csup!
                                                                                                                                    
                                                                                    set /a "csin=!mx!/2*2"
                                                                                    rem echo csin = !csin!

                                                                                    set /a "cinf=(!heightvideo!-!mheight!-!my!)/2*2"
                                                                                    rem echo movieheightreal = !movieheightreal!
                                                                                    rem echo cinf = !cinf!
                                                                                    set /a "cdes=(!widthvideo!-!mwidth!-!mx!)/2*2"
                                                                                    rem echo cdes = !cdes!

                                                                                    echo Crop Settings: --crop !csin!,!csup!,!cdes!,!cinf!    
                                                                                    set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
                                                                                    echo.  
                                                                                    
                                                                                    echo !t17!  !mwidth! 
                                                                                    echo !t18!  !mheight! 
                                                                                    echo.
                                                                                    )  
                                                        )                          

:cropmanuale_InserimentoCodificaHardwareH265
set /a "csup=0"
set /a "cinf=0"
set /a "csin=0"
set /a "cdes=0"
set /a "bandasuperiore=0"
set /a "bandainferiore=0"
set /a "bandasinistra=0"
set /a "bandadestra=0"
if exist ".\temp\Temp_HDR10_Stream.txt" ( del ".\temp\Temp_HDR10_Stream.txt" ) 
if exist ".\temp\durata_film.txt" ( del ".\temp\durata_film.txt" )
if exist ".\temp\crop.txt" ( del ".\temp\crop.txt" )
if exist ".\temp\risultato_multiplo.txt" ( del ".\temp\risultato_multiplo.txt" )
if exist ".\temp\crop_multiplo.txt" ( del ".\temp\crop_multiplo.txt" )
if exist ".\temp\crop_finale.txt" ( del ".\temp\crop_finale.txt" )

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t22!"   
    if errorlevel 2 goto cropmanuale_InserimentoCodificaHardwareH265
    if errorlevel 1 goto finecrop_InserimentoCodificaHardwareH265
)
CHOICE /N /C:SN /M "!t22!"   

if errorlevel 2 goto cropmanuale_InserimentoCodificaHardwareH265
if errorlevel 1 goto finecrop_InserimentoCodificaHardwareH265


:cropmanuale_InserimentoCodificaHardwareH265
echo.
echo !t23!
echo.

:banda_superiore_InserimentoCodificaHardwareH265
set /p "bandasuperiore=!t24!"
SET "var="&for /f "delims=0123456789" %%i in ("!bandasuperiore!") do set var=!bandasuperiore!
if defined var (
                echo.
                echo !t25!
                echo.
                goto banda_superiore_InserimentoCodificaHardwareH265
                ) else (
                        set /a "csup=!bandasuperiore!/2*2"
                        )

echo.
:banda_inferiore_InserimentoCodificaHardwareH265
set /p "bandainferiore=!t26!  
SET "var="&for /f "delims=0123456789" %%i in ("!bandainferiore!") do set var=!bandainferiore!
if defined var (
                echo.
                echo !t27!
                echo.
                goto banda_inferiore_InserimentoCodificaHardwareH265
                ) else (
                        set /a "cinf=!bandainferiore!/2*2"
                        )


echo.
:banda_sinistra_InserimentoCodificaHardwareH265
set /p "bandasinistra=!t28!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandasinistra!") do set var=!bandasinistra!
if defined var (
                echo.
                echo !t29!
                echo.
                goto banda_sinistra_InserimentoCodificaHardwareH265
                ) else (
                        set /a "csin=!bandasinistra!/2*2"
                        )

                        
echo.
:banda_destra_InserimentoCodificaHardwareH265
set /p "bandadestra=!t30!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandadestra!") do set var=!bandadestra!
if defined var (
                echo.
                echo !t31!
                echo.
                goto banda_destra_InserimentoCodificaHardwareH265
                ) else (
                        set /a "cdes=!bandadestra!/2*2"
                        )


set /a "mwidth=!widthvideo!/2*2"
set /a "mheight=!heightvideo!/2*2"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "mwidthc=!mwidth!-!csin!-!cdes!"
set /a "mheightc=!mheight!-!csup!-!cinf!"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "mwidth=!mwidthc!"
set /a "mheight=!mheightc!"

echo.
echo !t32!  !csup! 
echo !t33!  !cinf! 
echo !t34!  !csin! 
echo !t35!  !cdes! 
echo.

set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
echo Crop Settings: !cropff!
echo.

echo !t17!  !mwidth! 
echo !t18!  !mheight! 
echo.

goto cropmanuale_InserimentoCodificaHardwareH265

:finecrop_InserimentoCodificaHardwareH265



echo.
echo !t38!
echo.
echo 1) NVidia 
echo 2) Intel 
echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto ChoosenIntel_InserimentoCodificaHardwareH265
if errorlevel 1 goto ChoosenNVidia_InserimentoCodificaHardwareH265

:ChoosenIntel_InserimentoCodificaHardwareH265
set "SchedaGrafica=Intel"
@REM echo SchedaGrafica = !SchedaGrafica!
goto fineSceltaSchedaGrafica_InserimentoCodificaHardwareH265

:ChoosenNVidia_InserimentoCodificaHardwareH265
set "SchedaGrafica=NVidia"
@REM echo SchedaGrafica = !SchedaGrafica!

:fineSceltaSchedaGrafica_InserimentoCodificaHardwareH265

@REM pause 

if !SchedaGrafica!==NVidia (
                                goto InserimentoImpostazioniNVEnc_InserimentoCodificaHardwareH265
                                ) 





if !SchedaGrafica!==Intel (
                                goto InserimentoImpostazioniQSVEnc_InserimentoCodificaHardwareH265
                                 )


@REM pause 



rem//////////////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////////////


:InserimentoImpostazioniNVEnc_InserimentoCodificaHardwareH265

echo.
echo !t40!
echo.
echo 1) CQP 
echo 2) VBR 
echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto CodificaVBRNVEnc_InserimentoCodificaHardwareH265
if errorlevel 1 goto CodificaCQPNVEnc_InserimentoCodificaHardwareH265

:CodificaVBRNVEnc_InserimentoCodificaHardwareH265
set "TipoCodificaNVEnc=--vbr "
set /a "quantizzazioneNVEnc=0"
goto inserimentoValoriCQPVBRNVEnc_InserimentoCodificaHardwareH265

:CodificaCQPNVEnc_InserimentoCodificaHardwareH265
set "TipoCodificaNVEnc=--cqp "
set /a "quantizzazioneNVEnc=1"

:inserimentoValoriCQPVBRNVEnc_InserimentoCodificaHardwareH265

if !quantizzazioneNVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneNVEnc=!t44!" 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneNVEnc!") do set var=!valoreQuantizzazioneNVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                echo.
                                                goto inserimentoValoriCQPVBRNVEnc_InserimentoCodificaHardwareH265
                                                ) 

                                set /a "valoreQuantizzazioneNVEnc=!valoreQuantizzazioneNVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneNVEnc!
                                if !valoreQuantizzazioneNVEnc! GEQ 10 if !valoreQuantizzazioneNVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneNVEnc!
                                                                                                                set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreQuantizzazioneNVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                                goto fineQuantizzazioneNVEnc_InserimentoCodificaHardwareH265
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRNVEnc_InserimentoCodificaHardwareH265
                                                                                                                        
                                )



if !quantizzazioneNVEnc!==0 (
                                echo.
                                set /p "valoreBitRateNVEnc=!t46!" 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateNVEnc!") do set var=!valoreBitRateNVEnc!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                echo.
                                                goto inserimentoValoriCQPVBRNVEnc_InserimentoCodificaHardwareH265
                                                ) 
                                set /a "valoreBitRateNVEnc=!valoreBitRateNVEnc!"
                                @REM echo valoreBitRateNVEnc = !valoreBitRateNVEnc!
                                if !valoreBitRateNVEnc! GEQ 100 if !valoreBitRateNVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateNVEnc!
                                                                                                        set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreBitRateNVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                        goto fineQuantizzazioneNVEnc_InserimentoCodificaHardwareH265
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRNVEnc_InserimentoCodificaHardwareH265
                                                                                                              
                                )


:fineQuantizzazioneNVEnc_InserimentoCodificaHardwareH265


echo.
echo !t50!
echo.
echo 1) P1 !t51!
echo 2) P2 
echo 3) P3 
echo 4) P4 
echo 5) P5 
echo 6) P6 
echo 7) P7 !t52!
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto P7NVEnc_InserimentoCodificaHardwareH265
if errorlevel 6 goto P6NVEnc_InserimentoCodificaHardwareH265
if errorlevel 5 goto P5NVEnc_InserimentoCodificaHardwareH265
if errorlevel 4 goto P4NVEnc_InserimentoCodificaHardwareH265
if errorlevel 3 goto P3NVEnc_InserimentoCodificaHardwareH265
if errorlevel 2 goto P2NVEnc_InserimentoCodificaHardwareH265
if errorlevel 1 goto P1NVEnc_InserimentoCodificaHardwareH265


:P7NVEnc_InserimentoCodificaHardwareH265
set "SettaggioQualitaNVEnc=--preset P7"
set "QualitySetting=P7"
goto fineQualitCodificaNVEnc_InserimentoCodificaHardwareH265

:P6NVEnc_InserimentoCodificaHardwareH265
set "SettaggioQualitaNVEnc=--preset P6"
set "QualitySetting=P6"
goto fineQualitCodificaNVEnc_InserimentoCodificaHardwareH265

:P5NVEnc_InserimentoCodificaHardwareH265
set "SettaggioQualitaNVEnc=--preset P5"
set "QualitySetting=P5"
goto fineQualitCodificaNVEnc_InserimentoCodificaHardwareH265

:P4NVEnc_InserimentoCodificaHardwareH265
set "SettaggioQualitaNVEnc=--preset P4"
set "QualitySetting=P4"
goto fineQualitCodificaNVEnc_InserimentoCodificaHardwareH265

:P3NVEnc_InserimentoCodificaHardwareH265
set "SettaggioQualitaNVEnc=--preset P3"
set "QualitySetting=P3"
goto fineQualitCodificaNVEnc_InserimentoCodificaHardwareH265

:P2NVEnc_InserimentoCodificaHardwareH265
set "SettaggioQualitaNVEnc=--preset P2"
set "QualitySetting=P2"
goto fineQualitCodificaNVEnc_InserimentoCodificaHardwareH265

:P1NVEnc_InserimentoCodificaHardwareH265
set "SettaggioQualitaNVEnc=--preset P1"
set "QualitySetting=P1"
goto fineQualitCodificaNVEnc_InserimentoCodificaHardwareH265


:fineQualitCodificaNVEnc_InserimentoCodificaHardwareH265
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaNVEnc!




echo.
echo !t75!
echo.

:inserimentolookaheadNVEnc_InserimentoCodificaHardwareH265
set /p "valorelook=!t76!"  
SET "var="&for /f "delims=0123456789" %%i in ("!valorelook!") do set var=!valorelook!

@REM echo valorelook = !valorelook!
@REM echo var = !var!

if defined var (
                echo.
                echo !t77!
                echo.
                goto inserimentolookaheadNVEnc_InserimentoCodificaHardwareH265
                ) else (
                        set /a "lookaheadvalue=!valorelook!"
                        set "SettaggioLookahead=--lookahead !valorelook!"
                        @REM echo lookaheadvalue = !lookaheadvalue!
                        )


if !lookaheadvalue! LSS 1 (     echo.
                                echo !t78
                                echo.
                                goto inserimentolookaheadNVEnc_InserimentoCodificaHardwareH265
                                )

if !lookaheadvalue! GTR 32 (    echo.
                                echo !t78!
                                echo.
                                goto inserimentolookaheadNVEnc_InserimentoCodificaHardwareH265
                                )

echo.
echo !t79! !lookaheadvalue!
echo.
echo !t43! !SettaggioLookahead!
@REM pause



rem quantizzazione adattativa
echo.
echo !t80!
echo.
echo 1) Off !t81!
echo 2) Spatial
echo 3) Temporal
echo 4) Spatial + Temporal
echo.
CHOICE /N /C:1234 /M "!t64!"

if errorlevel 4 goto quantizzazioneAdattativaSpazialeTemporale_InserimentoCodificaHardwareH265
if errorlevel 3 goto quantizzazioneAdattativaTemporale_InserimentoCodificaHardwareH265
if errorlevel 2 goto quantizzazioneAdattativaSpaziale_InserimentoCodificaHardwareH265
if errorlevel 1 goto quantizzazioneAdattativaSpenta_InserimentoCodificaHardwareH265


:quantizzazioneAdattativaSpenta_InserimentoCodificaHardwareH265
set "SettaggioQuantizAdat=--no-aq"
set "SettingQuantAdat=Off - Disabilitata"
goto finequantizzazioneAdattativa_InserimentoCodificaHardwareH265

:quantizzazioneAdattativaSpaziale_InserimentoCodificaHardwareH265
set "SettaggioQuantizAdat=--aq"
set "SettingQuantAdat=Spatial"
goto finequantizzazioneAdattativa_InserimentoCodificaHardwareH265

:quantizzazioneAdattativaTemporale_InserimentoCodificaHardwareH265
set "SettaggioQuantizAdat=--aq-temporal"
set "SettingQuantAdat=Temporal"
goto finequantizzazioneAdattativa_InserimentoCodificaHardwareH265

:quantizzazioneAdattativaSpazialeTemporale_InserimentoCodificaHardwareH265
set "SettaggioQuantizAdat=--aq --aq-temporal"
set "SettingQuantAdat=Spatial + Temporal"
goto finequantizzazioneAdattativa_InserimentoCodificaHardwareH265


:finequantizzazioneAdattativa_InserimentoCodificaHardwareH265
echo.
echo !t82! !SettingQuantAdat!
echo.
echo !t43! !SettaggioQuantizAdat!



rem intensit quantizzazione adattativa

if !SettaggioQuantizAdat!==--no-aq ( 
                                        goto finequantizzazioneAdattativa_InserimentoCodificaHardwareH265 
                                        )

echo.
echo !t83!
echo.
:inserimentoValorequantizzazioneAdattativa_InserimentoCodificaHardwareH265
set /p "ForzaQuantizAdatValue=!t84!"  

if !ForzaQuantizAdatValue! LSS 0 (      echo.
                                        echo !t85!
                                        echo.
                                        goto inserimentoValorequantizzazioneAdattativa_InserimentoCodificaHardwareH265
                                        )

if !ForzaQuantizAdatValue! GTR 15 (     echo.
                                        echo !t85!
                                        echo.
                                        goto inserimentoValorequantizzazioneAdattativa_InserimentoCodificaHardwareH265
                                        )




:ForzaQuantizzazioneAdattativa_InserimentoCodificaHardwareH265


if !ForzaQuantizAdatValue!==0 (
        set "SettaggioForzaQuantizAdat=--aq-strength 0"
        set "SettingForzaQuantAdat=0 !t86!"
        echo.
        echo !t87! !SettingForzaQuantAdat!
        echo.
        echo !t43! !SettaggioForzaQuantizAdat!
) else (
        set "SettaggioForzaQuantizAdat=--aq-strength !ForzaQuantizAdatValue!"
        set "SettingForzaQuantAdat=!ForzaQuantizAdatValue!"
        echo.
        echo !t87! !SettingForzaQuantAdat!
        echo.
        echo !t43! !SettaggioForzaQuantizAdat!
)

:finequantizzazioneAdattativa_InserimentoCodificaHardwareH265




rem precisione vettore di movimento
echo.
echo !t88!
echo.
echo 1) Auto
echo 2) Q-pel !t89!
echo 3) half-pel
echo 4) full-pel !t90!
echo.
CHOICE /N /C:1234 /M "!t64!"

if errorlevel 4 goto precisioneVettoreMovimentoFull-pel_InserimentoCodificaHardwareH265
if errorlevel 3 goto precisioneVettoreMovimentoHalf-pel_InserimentoCodificaHardwareH265
if errorlevel 2 goto precisioneVettoreMovimentoQ-pel_InserimentoCodificaHardwareH265
if errorlevel 1 goto precisioneVettoreMovimentoAuto_InserimentoCodificaHardwareH265

:precisioneVettoreMovimentoFull-pel_InserimentoCodificaHardwareH265
set "SettaggioPrecisioneVettoreMovimento=--mv-precision full-pel"
set "SettingPrecisioneVettoreMovimento=Full-pel"
goto precisioneVettoreMovimento_InserimentoCodificaHardwareH265

:precisioneVettoreMovimentoHalf-pel_InserimentoCodificaHardwareH265
set "SettaggioPrecisioneVettoreMovimento=--mv-precision half-pel"
set "SettingPrecisioneVettoreMovimento=Half-pel"
goto precisioneVettoreMovimento_InserimentoCodificaHardwareH265

:precisioneVettoreMovimentoQ-pel_InserimentoCodificaHardwareH265
set "SettaggioPrecisioneVettoreMovimento=--mv-precision Q-pel"
set "SettingPrecisioneVettoreMovimento=Q-pel"
goto precisioneVettoreMovimento_InserimentoCodificaHardwareH265

:precisioneVettoreMovimentoAuto_InserimentoCodificaHardwareH265
set "SettaggioPrecisioneVettoreMovimento=--mv-precision Auto"
set "SettingPrecisioneVettoreMovimento=Auto"
goto precisioneVettoreMovimento_InserimentoCodificaHardwareH265

:precisioneVettoreMovimento_InserimentoCodificaHardwareH265
echo.
echo !t91 !SettingPrecisioneVettoreMovimento!
echo.
echo !t43! !SettaggioPrecisioneVettoreMovimento!



rem denoiser
echo.
echo !t92!
echo.
echo 1) Convolution3D
echo 2) PMD
echo 3) FFT3D
echo 4) KNN
echo 5) NLMEANS
echo 6) DCT
echo 7) !t93!
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto NessundenoiserNVEnc_InserimentoCodificaHardwareH265
if errorlevel 6 goto denoiserDCTNVEnc_InserimentoCodificaHardwareH265
if errorlevel 5 goto denoiserNLMEANSNVEnc_InserimentoCodificaHardwareH265
if errorlevel 4 goto denoiserKNNNVEnc_InserimentoCodificaHardwareH265
if errorlevel 3 goto denoiserFFT3DNVEnc_InserimentoCodificaHardwareH265
if errorlevel 2 goto denoiserPMDNVEnc_InserimentoCodificaHardwareH265
if errorlevel 1 goto denoiserConvolution3DNVEnc_InserimentoCodificaHardwareH265


:NessundenoiserNVEnc_InserimentoCodificaHardwareH265
echo.
set "nvdenoiser=nessuno"
echo !t94!

goto finesceltadenoiserNVEnc_InserimentoCodificaHardwareH265


:denoiserConvolution3DNVEnc_InserimentoCodificaHardwareH265
echo.
echo !t95!
echo.
echo 1) !t96!
echo 2) !t97!
echo 3) !t98!
echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto Convolution3DForteNVEnc_InserimentoCodificaHardwareH265
if errorlevel 2 goto Convolution3DMedioNVEnc_InserimentoCodificaHardwareH265
if errorlevel 1 goto Convolution3DLeggeroNVEnc_InserimentoCodificaHardwareH265


:Convolution3DForteNVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=4.50,cthresh=6.00,t_ythresh=1.50,t_cthresh=2.00" 
echo.
echo !t99! !t98!
echo.
echo !t43! !nvdenoiser! 
goto fineconvolution3dimpostazioniNVEnc_InserimentoCodificaHardwareH265

:Convolution3DMedioNVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=3.00,cthresh=4.00,t_ythresh=1.50,t_cthresh=2.00" 
echo.
echo !t99! !t97!
echo.
echo !t43! !nvdenoiser! 
goto fineconvolution3dimpostazioniNVEnc_InserimentoCodificaHardwareH265

:Convolution3DLeggeroNVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
echo.
echo !t99! !t96!
echo.
echo !t43! !nvdenoiser! 
goto fineconvolution3dimpostazioniNVEnc_InserimentoCodificaHardwareH265

:fineconvolution3dimpostazioniNVEnc_InserimentoCodificaHardwareH265

goto :finesceltadenoiserNVEnc_InserimentoCodificaHardwareH265

rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

:denoiserPMDNVEnc_InserimentoCodificaHardwareH265
echo.
echo !t100!
echo.
echo 1) !t96!
echo 2) !t97!
echo 3) !t98!
echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto PMDForteNVEnc_InserimentoCodificaHardwareH265
if errorlevel 2 goto PMDMedioNVEnc_InserimentoCodificaHardwareH265
if errorlevel 1 goto PMDLeggeroNVEnc_InserimentoCodificaHardwareH265


:PMDForteNVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-pmd apply_count=20,strength=100,threshold=100" 
echo.
echo !t101! !t98!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserPMDimpostazioniNVEnc_InserimentoCodificaHardwareH265

:PMDMedioNVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-pmd apply_count=15,strength=75,threshold=75" 
echo.
echo !t101! !t97!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserPMDimpostazioniNVEnc_InserimentoCodificaHardwareH265

:PMDLeggeroNVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
echo.
echo !t101! !t96!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserPMDimpostazioniNVEnc_InserimentoCodificaHardwareH265


:finedenoiserPMDimpostazioniNVEnc_InserimentoCodificaHardwareH265
goto :finesceltadenoiserNVEnc_InserimentoCodificaHardwareH265

rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

:denoiserFFT3DNVEnc_InserimentoCodificaHardwareH265
echo.
echo !t102!
echo.
echo 1) !t96!
echo 2) !t97!
echo 3) !t98!
echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto FFT3DForteNVEnc_InserimentoCodificaHardwareH265
if errorlevel 2 goto FFT3DMedioNVEnc_InserimentoCodificaHardwareH265
if errorlevel 1 goto FFT3DLeggeroNVEnc_InserimentoCodificaHardwareH265


:FFT3DForteNVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-fft3d sigma=100.0,amount=1.0,block_size=32,overlap=0.5,method=0,temporal=1,prec=auto" 
echo.
echo !t103! !t98!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserFFT3DimpostazioniNVEnc_InserimentoCodificaHardwareH265

:FFT3DMedioNVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-fft3d sigma=60.0,amount=0.6,block_size=32,overlap=0.5,method=0,temporal=1,prec=auto" 
echo.
echo !t103! !t97!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserFFT3DimpostazioniNVEnc_InserimentoCodificaHardwareH265

:FFT3DLeggeroNVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-fft3d sigma=30.0,amount=0.3,block_size=32,overlap=0.5,method=0,temporal=1,prec=auto" 
echo.
echo !t103! !t96!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserFFT3DimpostazioniNVEnc_InserimentoCodificaHardwareH265



:finedenoiserFFT3DimpostazioniNVEnc_InserimentoCodificaHardwareH265
goto :finesceltadenoiserNVEnc_InserimentoCodificaHardwareH265

rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


:denoiserKNNNVEnc_InserimentoCodificaHardwareH265
echo.
echo !t104!
echo.
echo 1) !t96!
echo 2) !t97!
echo 3) !t98!
echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto KNNForteNVEnc_InserimentoCodificaHardwareH265
if errorlevel 2 goto KNNMedioNVEnc_InserimentoCodificaHardwareH265
if errorlevel 1 goto KNNLeggeroNVEnc_InserimentoCodificaHardwareH265


:KNNForteNVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-knn radius=5,strength=0.15,lerp=0.1,th_lerp=0.8" 
echo.
echo !t105! !t98!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserKNNimpostazioniNVEnc_InserimentoCodificaHardwareH265

:KNNMedioNVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-knn radius=4,strength=0.10,lerp=0.1,th_lerp=0.8" NLMEANSForteNVEn
echo.
echo !t105! !t97!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserKNNimpostazioniNVEnc_InserimentoCodificaHardwareH265

:KNNLeggeroNVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-knn radius=3,strength=0.05,lerp=0.1,th_lerp=0.8" 
echo.
echo !t105! !t96!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserKNNimpostazioniNVEnc_InserimentoCodificaHardwareH265


:finedenoiserKNNimpostazioniNVEnc_InserimentoCodificaHardwareH265
goto :finesceltadenoiserNVEnc_InserimentoCodificaHardwareH265

rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


:denoiserNLMEANSNVEnc_InserimentoCodificaHardwareH265
echo.
echo !t106!
echo.
echo 1) !t96!
echo 2) !t97!
echo 3) !t98!
echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto NLMEANSForteNVEnc_InserimentoCodificaHardwareH265
if errorlevel 2 goto NLMEANSMedioNVEnc_InserimentoCodificaHardwareH265
if errorlevel 1 goto NLMEANSLeggeroNVEnc_InserimentoCodificaHardwareH265


:NLMEANSForteNVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-nlmeans sigma=0.05,h=0.005,patch=7,search=15" 
echo.
echo !t107! !t98!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserNLMEANSimpostazioniNVEnc_InserimentoCodificaHardwareH265

:NLMEANSMedioNVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-nlmeans sigma=0.03,h=0.005,patch=7,search=15" 
echo.
echo !t107! !t97!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserNLMEANSimpostazioniNVEnc_InserimentoCodificaHardwareH265

:NLMEANSLeggeroNVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-nlmeans sigma=0.01,h=0.005,patch=7,search=15" 
echo.
echo !t107! !t96!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserNLMEANSimpostazioniNVEnc_InserimentoCodificaHardwareH265


:finedenoiserNLMEANSimpostazioniNVEnc_InserimentoCodificaHardwareH265
goto :finesceltadenoiserNVEnc_InserimentoCodificaHardwareH265

rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

:denoiserDCTNVEnc_InserimentoCodificaHardwareH265
echo.
echo !t108!
echo.
echo 1) !t96!
echo 2) !t97!
echo 3) !t98!
echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto DCTForteNVEnc_InserimentoCodificaHardwareH265
if errorlevel 2 goto DCTMedioNVEnc_InserimentoCodificaHardwareH265
if errorlevel 1 goto DCTLeggeroNVEnc_InserimentoCodificaHardwareH265


:DCTForteNVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-denoise-dct step=1,sigma=10.0" 
echo.
echo !t109! !t98!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserDCTimpostazioniNVEnc_InserimentoCodificaHardwareH265

:DCTMedioNVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-denoise-dct step=1,sigma=5.0" 
echo.
echo !t109! !t97!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserDCTimpostazioniNVEnc_InserimentoCodificaHardwareH265

:DCTLeggeroNVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-denoise-dct step=1,sigma=2.0" 
echo.
echo !t109! !t96!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserDCTimpostazioniNVEnc_InserimentoCodificaHardwareH265

:finedenoiserDCTimpostazioniNVEnc_InserimentoCodificaHardwareH265
goto :finesceltadenoiserNVEnc_InserimentoCodificaHardwareH265


:finesceltadenoiserNVEnc_InserimentoCodificaHardwareH265



echo.
if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t57!"
    if errorlevel 2 goto ApplicaMiglioramentoDettagliNVEncNo_InserimentoCodificaHardwareH265
    if errorlevel 1 goto ApplicaMiglioramentoDettagliNVEncSi_InserimentoCodificaHardwareH265
)
CHOICE /N /C:SN /M "!t57!"

if errorlevel 2 goto ApplicaMiglioramentoDettagliNVEncNo_InserimentoCodificaHardwareH265
if errorlevel 1 goto ApplicaMiglioramentoDettagliNVEncSi_InserimentoCodificaHardwareH265

:ApplicaMiglioramentoDettagliNVEncNo_InserimentoCodificaHardwareH265
set "miglioramento1080p=N"
goto fineSceltaMigliaramentiNVEnc_InserimentoCodificaHardwareH265

:ApplicaMiglioramentoDettagliNVEncSi_InserimentoCodificaHardwareH265
set "miglioramento1080p=S"

:fineSceltaMigliaramentiNVEnc_InserimentoCodificaHardwareH265
if !miglioramento1080p!==S ( 
                                set "edgeleveling=--vpp-edgelevel strength=10.0,threshold=24.0,black=6,white=0" 
                                echo.
                                echo NVEnc !t58!
                                echo.
                                )
if !miglioramento1080p!==N ( 
                                set "edgeleveling=nessuno" 
                                echo.
                                echo NVEnc !t59!
                                echo.
                                )




set file_senza_virgolette=%NomeFile:"=%
rem echo %file_senza_virgolette%

set file_senza_estensione=%file_senza_virgolette:.mkv=%
rem echo %file_senza_estensione%

set fileoutput="%file_senza_estensione%_Codifica_Hardware_NVEnc.mkv"
rem echo fileoutput = %fileoutput%

echo.
set "VideoInfoCodifica=NVEnc_semplice_codifica_hardware|!NomeFile!|!fileoutput!|nessuno|!cropff!|!mwidth!x!mheight!|nessuna|nessuno|!colorpr!|!colortr!|!colorsp!|!tipoQuantizzazioneNVEnc!|!SettaggioQualitaNVEnc!|!SettaggioQuantizAdat!|!SettaggioForzaQuantizAdat!|!nvdenoiser!|!formatvideo!|!edgeleveling!|no_color_correction|no_numero_passaggi_upscaling|!SettaggioLookahead!|!SettaggioPrecisioneVettoreMovimento!"
@REM echo VideoInfoCodifica = !VideoInfoCodifica!
@REM echo.

if exist ".\saved\savedmoviesallencodings.dat" ( 
                                                echo !VideoInfoCodifica! >> .\saved\savedmoviesallencodings.dat
                                                goto fineSceltaMigliaramentiNVEnc_InserimentoCodificaHardwareH265
                                                ) 

echo !VideoInfoCodifica! > .\saved\savedmoviesallencodings.dat


:fineSceltaMigliaramentiNVEnc_InserimentoCodificaHardwareH265

echo !t60! !numeromovie! !t61!
echo.

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t62!"
    if errorlevel 2 goto finesceltanuovovideodacodificareNVEnc_InserimentoCodificaHardwareH265
    if errorlevel 1 goto altrivideodainserireMenuNVEnc_InserimentoCodificaHardwareH265
)
CHOICE /N /C:SN /M "!t62!"
echo.

if errorlevel 2 goto finesceltanuovovideodacodificareNVEnc_InserimentoCodificaHardwareH265
if errorlevel 1 goto altrivideodainserireMenuNVEnc_InserimentoCodificaHardwareH265

:altrivideodainserireMenuNVEnc_InserimentoCodificaHardwareH265
set /a "numeromovie+=1"
echo.
goto altrivideodainserireNVEnc_InserimentoCodificaHardwareH265

:finesceltanuovovideodacodificareNVEnc_InserimentoCodificaHardwareH265
echo.
goto fineinfovideo_InserimentoCodificaHardwareH265


rem////////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////////


:InserimentoImpostazioniQSVEnc_InserimentoCodificaHardwareH265

echo.
echo !t40!
echo.
echo 1) CQP 
echo 2) ICQ 
echo 3) LA-ICQ 
echo 4) VBR 
echo.
CHOICE /N /C:1234 /M "!t64!"

if errorlevel 4 goto CodificaVBRQSVEnc_InserimentoCodificaHardwareH265
if errorlevel 3 goto CodificaLAICQQSVEnc_InserimentoCodificaHardwareH265
if errorlevel 2 goto CodificaICQQSVEnc_InserimentoCodificaHardwareH265
if errorlevel 1 goto CodificaCQPQSVEnc_InserimentoCodificaHardwareH265


:CodificaCQPQSVEnc_InserimentoCodificaHardwareH265
set "TipoCodificaQSVEnc=--cqp "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc_InserimentoCodificaHardwareH265

:CodificaICQQSVEnc_InserimentoCodificaHardwareH265
set "TipoCodificaQSVEnc=--icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc_InserimentoCodificaHardwareH265

:CodificaLAICQQSVEnc_InserimentoCodificaHardwareH265
set "TipoCodificaQSVEnc=--la-icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc_InserimentoCodificaHardwareH265

:CodificaVBRQSVEnc_InserimentoCodificaHardwareH265
set "TipoCodificaQSVEnc=--vbr "
set /a "quantizzazioneQSVEnc=0"
goto inserimentoValoriCQPVBRQSVEnc_InserimentoCodificaHardwareH265


:inserimentoValoriCQPVBRQSVEnc_InserimentoCodificaHardwareH265

if !quantizzazioneQSVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneQSVEnc=!t44!" 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneQSVEnc!") do set var=!valoreQuantizzazioneQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                echo.
                                                goto inserimentoValoriCQPVBRQSVEnc_InserimentoCodificaHardwareH265
                                                ) 

                                set /a "valoreQuantizzazioneQSVEnc=!valoreQuantizzazioneQSVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneQSVEnc!
                                if !valoreQuantizzazioneQSVEnc! GEQ 10 if !valoreQuantizzazioneQSVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneQSVEnc!
                                                                                                                set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreQuantizzazioneQSVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                                goto fineQuantizzazioneQSVEnc_InserimentoCodificaHardwareH265
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRQSVEnc_InserimentoCodificaHardwareH265
                                                                                                                        
                                )



if !quantizzazioneQSVEnc!==0 (
                                echo.
                                set /p "valoreBitRateQSVEnc=!t46!" 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateQSVEnc!") do set var=!valoreBitRateQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                echo.
                                                goto inserimentoValoriCQPVBRQSVEnc_InserimentoCodificaHardwareH265
                                                ) 
                                set /a "valoreBitRateQSVEnc=!valoreBitRateQSVEnc!"
                                @REM echo valoreBitRateQSVEnc = !valoreBitRateQSVEnc!
                                if !valoreBitRateQSVEnc! GEQ 100 if !valoreBitRateQSVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateQSVEnc!
                                                                                                        set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreBitRateQSVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                        goto fineQuantizzazioneQSVEnc_InserimentoCodificaHardwareH265
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRQSVEnc_InserimentoCodificaHardwareH265
                                                                                                              
                                )


:fineQuantizzazioneQSVEnc_InserimentoCodificaHardwareH265



echo.
echo !t50!
echo.
echo 1) Best 
echo 2) Higher 
echo 3) High 
echo 4) Balanced 
echo 5) Fast 
echo 6) Faster 
echo 7) Fastest 
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto QualitFastestQSVEnc_InserimentoCodificaHardwareH265
if errorlevel 6 goto QualitFasterQSVEnc_InserimentoCodificaHardwareH265
if errorlevel 5 goto QualitFastQSVEnc_InserimentoCodificaHardwareH265
if errorlevel 4 goto QualitBalancedtQSVEnc_InserimentoCodificaHardwareH265
if errorlevel 3 goto QualitHighQSVEnc_InserimentoCodificaHardwareH265
if errorlevel 2 goto QualitHigherQSVEnc_InserimentoCodificaHardwareH265
if errorlevel 1 goto QualitBestQSVEnc_InserimentoCodificaHardwareH265


:QualitBestQSVEnc_InserimentoCodificaHardwareH265
set "SettaggioQualitaQSvenc=--quality best"
set "QualitySetting=best"
goto fineQualitCodificaQSVEnc_InserimentoCodificaHardwareH265

:QualitHigherQSVEnc_InserimentoCodificaHardwareH265
set "SettaggioQualitaQSvenc=--quality higher"
set "QualitySetting=higher"
goto fineQualitCodificaQSVEnc_InserimentoCodificaHardwareH265

:QualitHighQSVEnc_InserimentoCodificaHardwareH265
set "SettaggioQualitaQSvenc=--quality high"
set "QualitySetting=high"
goto fineQualitCodificaQSVEnc_InserimentoCodificaHardwareH265

:QualitBalancedtQSVEnc_InserimentoCodificaHardwareH265
set "SettaggioQualitaQSvenc=--quality balanced"
set "QualitySetting=balanced"
goto fineQualitCodificaQSVEnc_InserimentoCodificaHardwareH265

:QualitFastQSVEnc_InserimentoCodificaHardwareH265
set "SettaggioQualitaQSvenc=--quality fast"
set "QualitySetting=fast"
goto fineQualitCodificaQSVEnc_InserimentoCodificaHardwareH265

:QualitFasterQSVEnc_InserimentoCodificaHardwareH265
set "SettaggioQualitaQSvenc=--quality faster"
set "QualitySetting=faster"
goto fineQualitCodificaQSVEnc_InserimentoCodificaHardwareH265

:QualitFastestQSVEnc_InserimentoCodificaHardwareH265
set "SettaggioQualitaQSvenc=--quality fastest"
set "QualitySetting=fastest"
goto fineQualitCodificaQSVEnc_InserimentoCodificaHardwareH265


:fineQualitCodificaQSVEnc_InserimentoCodificaHardwareH265
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaQSvenc!



echo.
echo !t75!
echo.

:inserimentolookaheadQSVEnc_InserimentoCodificaHardwareH265
set /p "valorelook=!t110!"  
SET "var="&for /f "delims=0123456789" %%i in ("!valorelook!") do set var=!valorelook!

@REM echo valorelook = !valorelook!
@REM echo var = !var!

if defined var (
                echo.
                echo !t77!
                echo.
                goto inserimentolookaheadQSVEnc_InserimentoCodificaHardwareH265
                ) else (
                        set /a "lookaheadvalue=!valorelook!"
                        set "SettaggioLookahead=--la-depth !valorelook!"
                        @REM echo lookaheadvalue = !lookaheadvalue!
                        )


if !lookaheadvalue! LSS 10 (     echo.
                                echo !t111!
                                echo.
                                goto inserimentolookaheadQSVEnc_InserimentoCodificaHardwareH265
                                )

if !lookaheadvalue! GTR 99 (    echo.
                                echo !t111!
                                echo.
                                goto inserimentolookaheadQSVEnc_InserimentoCodificaHardwareH265
                                )

echo.
echo !t79! !lookaheadvalue!
echo.
echo !t43! !SettaggioLookahead!
@REM pause



rem denoiser
echo.
echo !t92!
echo.
echo 1) Convolution3D
echo 2) PMD
echo 3) FFT3D
echo 4) KNN
echo 5) NLMEANS
echo 6) DCT
echo 7) !t93!
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto NessundenoiserQSVEnc_InserimentoCodificaHardwareH265
if errorlevel 6 goto denoiserDCTQSVEnc_InserimentoCodificaHardwareH265
if errorlevel 5 goto denoiserNLMEANSQSVEnc_InserimentoCodificaHardwareH265
if errorlevel 4 goto denoiserKNNQSVEnc_InserimentoCodificaHardwareH265
if errorlevel 3 goto denoiserFFT3DQSVEnc_InserimentoCodificaHardwareH265
if errorlevel 2 goto denoiserPMDQSVEnc_InserimentoCodificaHardwareH265
if errorlevel 1 goto denoiserConvolution3DQSVEnc_InserimentoCodificaHardwareH265


:NessundenoiserQSVEnc_InserimentoCodificaHardwareH265
echo.
set "nvdenoiser=nessuno"
echo !t94!

goto finesceltadenoiserQSVEnc_InserimentoCodificaHardwareH265


:denoiserConvolution3DQSVEnc_InserimentoCodificaHardwareH265
echo.
echo !t95!
echo.
echo 1) !t96!
echo 2) !t97!
echo 3) !t98!
echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto Convolution3DForteQSVEnc_InserimentoCodificaHardwareH265
if errorlevel 2 goto Convolution3DMedioQSVEnc_InserimentoCodificaHardwareH265
if errorlevel 1 goto Convolution3DLeggeroQSVEnc_InserimentoCodificaHardwareH265


:Convolution3DForteQSVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=4.50,cthresh=6.00,t_ythresh=1.50,t_cthresh=2.00" 
echo.
echo !t99! !t98!
echo.
echo !t43! !nvdenoiser! 
goto fineconvolution3dimpostazioniQSVEnc_InserimentoCodificaHardwareH265

:Convolution3DMedioQSVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=3.00,cthresh=4.00,t_ythresh=1.50,t_cthresh=2.00" 
echo.
echo !t99! !t97!
echo.
echo !t43! !nvdenoiser! 
goto fineconvolution3dimpostazioniQSVEnc_InserimentoCodificaHardwareH265

:Convolution3DLeggeroQSVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
echo.
echo !t99! !t96!
echo.
echo !t43! !nvdenoiser! 
goto fineconvolution3dimpostazioniQSVEnc_InserimentoCodificaHardwareH265

:fineconvolution3dimpostazioniQSVEnc_InserimentoCodificaHardwareH265

goto :finesceltadenoiserQSVEnc_InserimentoCodificaHardwareH265

rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

:denoiserPMDQSVEnc_InserimentoCodificaHardwareH265
echo.
echo !t100!
echo.
echo 1) !t96!
echo 2) !t97!
echo 3) !t98!
echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto PMDForteQSVEnc_InserimentoCodificaHardwareH265
if errorlevel 2 goto PMDMedioQSVEnc_InserimentoCodificaHardwareH265
if errorlevel 1 goto PMDLeggeroQSVEnc_InserimentoCodificaHardwareH265


:PMDForteQSVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-pmd apply_count=20,strength=100,threshold=100" 
echo.
echo !t101! !t98!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserPMDimpostazioniQSVEnc_InserimentoCodificaHardwareH265

:PMDMedioQSVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-pmd apply_count=15,strength=75,threshold=75" 
echo.
echo !t101! !t97!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserPMDimpostazioniQSVEnc_InserimentoCodificaHardwareH265

:PMDLeggeroQSVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
echo.
echo !t101! !t96!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserPMDimpostazioniQSVEnc_InserimentoCodificaHardwareH265


:finedenoiserPMDimpostazioniQSVEnc_InserimentoCodificaHardwareH265
goto :finesceltadenoiserQSVEnc_InserimentoCodificaHardwareH265

rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

:denoiserFFT3DQSVEnc_InserimentoCodificaHardwareH265
echo.
echo !t102!
echo.
echo 1) !t96!
echo 2) !t97!
echo 3) !t98!
echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto FFT3DForteQSVEnc_InserimentoCodificaHardwareH265
if errorlevel 2 goto FFT3DMedioQSVEnc_InserimentoCodificaHardwareH265
if errorlevel 1 goto FFT3DLeggeroQSVEnc_InserimentoCodificaHardwareH265


:FFT3DForteQSVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-fft3d sigma=100.0,amount=1.0,block_size=32,overlap=0.5,method=0,temporal=1,prec=auto" 
echo.
echo !t103! !t98!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserFFT3DimpostazioniQSVEnc_InserimentoCodificaHardwareH265

:FFT3DMedioQSVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-fft3d sigma=60.0,amount=0.6,block_size=32,overlap=0.5,method=0,temporal=1,prec=auto" 
echo.
echo !t103! !t97!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserFFT3DimpostazioniQSVEnc_InserimentoCodificaHardwareH265

:FFT3DLeggeroQSVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-fft3d sigma=30.0,amount=0.3,block_size=32,overlap=0.5,method=0,temporal=1,prec=auto" 
echo.
echo !t103! !t96!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserFFT3DimpostazioniQSVEnc_InserimentoCodificaHardwareH265



:finedenoiserFFT3DimpostazioniQSVEnc_InserimentoCodificaHardwareH265
goto :finesceltadenoiserQSVEnc_InserimentoCodificaHardwareH265

rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


:denoiserKNNQSVEnc_InserimentoCodificaHardwareH265
echo.
echo !t104!
echo.
echo 1) !t96!
echo 2) !t97!
echo 3) !t98!
echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto KNNForteQSVEnc_InserimentoCodificaHardwareH265
if errorlevel 2 goto KNNMedioQSVEnc_InserimentoCodificaHardwareH265
if errorlevel 1 goto KNNLeggeroQSVEnc_InserimentoCodificaHardwareH265


:KNNForteQSVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-knn radius=5,strength=0.15,lerp=0.1,th_lerp=0.8" 
echo.
echo !t105! !t98!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserKNNimpostazioniQSVEnc_InserimentoCodificaHardwareH265

:KNNMedioQSVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-knn radius=4,strength=0.10,lerp=0.1,th_lerp=0.8" 
echo.
echo !t105! !t97!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserKNNimpostazioniQSVEnc_InserimentoCodificaHardwareH265

:KNNLeggeroQSVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-knn radius=3,strength=0.05,lerp=0.1,th_lerp=0.8" 
echo.
echo !t105! !t96!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserKNNimpostazioniQSVEnc_InserimentoCodificaHardwareH265


:finedenoiserKNNimpostazioniQSVEnc_InserimentoCodificaHardwareH265
goto :finesceltadenoiserQSVEnc_InserimentoCodificaHardwareH265

rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


:denoiserNLMEANSQSVEnc_InserimentoCodificaHardwareH265
echo.
echo !t106!
echo.
echo 1) !t96!
echo 2) !t97!
echo 3) !t98!
echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto NLMEANSForteQSVEnc_InserimentoCodificaHardwareH265
if errorlevel 2 goto NLMEANSMedioQSVEnc_InserimentoCodificaHardwareH265
if errorlevel 1 goto NLMEANSLeggeroQSVEnc_InserimentoCodificaHardwareH265


:NLMEANSForteQSVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-nlmeans sigma=0.05,h=0.005,patch=7,search=15" 
echo.
echo !t107! !t98!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserNLMEANSimpostazioniQSVEnc_InserimentoCodificaHardwareH265

:NLMEANSMedioQSVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-nlmeans sigma=0.03,h=0.005,patch=7,search=15" 
echo.
echo !t107! !t97!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserNLMEANSimpostazioniQSVEnc_InserimentoCodificaHardwareH265

:NLMEANSLeggeroQSVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-nlmeans sigma=0.01,h=0.005,patch=7,search=15" 
echo.
echo !t107! !t96!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserNLMEANSimpostazioniQSVEnc_InserimentoCodificaHardwareH265


:finedenoiserNLMEANSimpostazioniQSVEnc_InserimentoCodificaHardwareH265
goto :finesceltadenoiserQSVEnc_InserimentoCodificaHardwareH265

rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

:denoiserDCTQSVEnc_InserimentoCodificaHardwareH265
echo.
echo !t108!
echo.
echo 1) !t96!
echo 2) !t97!
echo 3) !t98!
echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto DCTForteQSVEnc_InserimentoCodificaHardwareH265
if errorlevel 2 goto DCTMedioQSVEnc_InserimentoCodificaHardwareH265
if errorlevel 1 goto DCTLeggeroQSVEnc_InserimentoCodificaHardwareH265


:DCTForteQSVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-denoise-dct step=1,sigma=10.0" 
echo.
echo !t109! !t98!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserDCTimpostazioniQSVEncCodificaHardwareIntelQSVEnc

:DCTMedioQSVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-denoise-dct step=1,sigma=5.0" 
echo.
echo !t109! !t97!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserDCTimpostazioniQSVEncCodificaHardwareIntelQSVEnc

:DCTLeggeroQSVEnc_InserimentoCodificaHardwareH265
set "nvdenoiser=--vpp-denoise-dct step=1,sigma=2.0" 
echo.
echo !t109! !t96!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserDCTimpostazioniQSVEncCodificaHardwareIntelQSVEnc

:finedenoiserDCTimpostazioniQSVEncCodificaHardwareIntelQSVEnc
goto :finesceltadenoiserQSVEnc_InserimentoCodificaHardwareH265


:finesceltadenoiserQSVEnc_InserimentoCodificaHardwareH265



echo.
if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t57!"
    if errorlevel 2 goto ApplicaMiglioramentoDettagliNoQSVEnc_InserimentoCodificaHardwareH265
    if errorlevel 1 goto ApplicaMiglioramentoDettagliSiQSVEnc_InserimentoCodificaHardwareH265
)
CHOICE /N /C:SN /M "!t57!"

if errorlevel 2 goto ApplicaMiglioramentoDettagliNoQSVEnc_InserimentoCodificaHardwareH265
if errorlevel 1 goto ApplicaMiglioramentoDettagliSiQSVEnc_InserimentoCodificaHardwareH265

:ApplicaMiglioramentoDettagliNoQSVEnc_InserimentoCodificaHardwareH265
set "miglioramento1080p=N"
goto fineSceltaMigliaramentiQSVEnc_InserimentoCodificaHardwareH265

:ApplicaMiglioramentoDettagliSiQSVEnc_InserimentoCodificaHardwareH265
set "miglioramento1080p=S"

:fineSceltaMigliaramentiQSVEnc_InserimentoCodificaHardwareH265
if !miglioramento1080p!==S ( 
                                set "edgeleveling=--vpp-edgelevel strength=10.0,threshold=24.0,black=6,white=0" 
                                echo.
                                echo QSVEnc !t58!
                                echo.
                                )
if !miglioramento1080p!==N ( 
                                set "edgeleveling=nessuno" 
                                echo.
                                echo QSVEnc !t59!
                                echo.
                                )


set file_senza_virgolette=%NomeFile:"=%
rem echo %file_senza_virgolette%

set file_senza_estensione=%file_senza_virgolette:.mkv=%
rem echo %file_senza_estensione%

set fileoutput="%file_senza_estensione%_Codifica_Hardware_QSVEnc.mkv"
rem echo fileoutput = %fileoutput%

echo.
set "VideoInfoCodifica=QSVEnc_semplice_codifica_hardware|!NomeFile!|!fileoutput!|nessuno|!cropff!|!mwidth!x!mheight!|nessuna|nessuno|!colorpr!|!colortr!|!colorsp!|!tipoQuantizzazioneQSVEnc!|!SettaggioQualitaQSVEnc!|nessuna|nessuna|!nvdenoiser!|!formatvideo!|!edgeleveling!|no_color_correction|no_numero_passaggi_upscaling|!SettaggioLookahead!|no_precisione_vettore_movimento"
@REM echo VideoInfoCodifica = !VideoInfoCodifica!
@REM echo.

if exist ".\saved\savedmoviesallencodings.dat" ( 
                                                echo !VideoInfoCodifica! >> .\saved\savedmoviesallencodings.dat
                                                goto finesalvataggioInserimentoQSVEnc_InserimentoCodificaHardwareH265
                                                ) 

echo !VideoInfoCodifica! > .\saved\savedmoviesallencodings.dat


:finesalvataggioInserimentoQSVEnc_InserimentoCodificaHardwareH265

echo !t60! !numeromovie! !t61!
echo.

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t62!"
    if errorlevel 2 goto finesceltanuovovideodacodificareQSVEnc_InserimentoCodificaHardwareH265
    if errorlevel 1 goto altrivideodainserireMenuQSVEnc_InserimentoCodificaHardwareH265
)

CHOICE /N /C:SN /M "!t62!"
echo.

if errorlevel 2 goto finesceltanuovovideodacodificareQSVEnc_InserimentoCodificaHardwareH265
if errorlevel 1 goto altrivideodainserireMenuQSVEnc_InserimentoCodificaHardwareH265

:altrivideodainserireMenuQSVEnc_InserimentoCodificaHardwareH265
set /a "numeromovie+=1"
echo.
goto altrivideodainserireNVEnc_InserimentoCodificaHardwareH265

:finesceltanuovovideodacodificareQSVEnc_InserimentoCodificaHardwareH265
echo.
goto fineinfovideo_InserimentoCodificaHardwareH265


rem////////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////////


goto fineinfovideo_InserimentoCodificaHardwareH265




:novideofile_InserimentoCodificaHardwareH265
echo !t63!
echo.


:fineinfovideo_InserimentoCodificaHardwareH265


if exist ".\temp\Temp_HDR10_Stream.txt" ( del .\temp\Temp_HDR10_Stream.txt )
if exist ".\temp\durata_film.txt" ( del .\temp\durata_film.txt )
if exist ".\temp\crop.txt" ( del .\temp\crop.txt )
if exist ".\temp\risultato_multiplo.txt" ( del .\temp\risultato_multiplo.txt )
if exist ".\temp\crop_multiplo.txt" ( del .\temp\crop_multiplo.txt )
if exist ".\temp\crop_finale.txt" ( del .\temp\crop_finale.txt )
      




set waitenter=
set /P waitenter=!t65!  
Endlocal
goto InserimentoCodifcaInCodaeSalvataggioSuDisco







rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

cls
setLocal EnableExtensions EnableDelayedExpansion



for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoInserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
)
if %lingua%==inglese (
    goto caricalinguaingleseInserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
)


:caricalinguaingleseInserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set t1=Insert Hardware Video Encoding Info 2160p Light Denoiser, Detail Enhancement and Saving to Disk. 

set t2=Drag Here the
set t211=Video File 2160p 10 bit HDR to apply the Denoiser and Enhance Details: 


set t3=File does not exist 
set t4=Info Video:  

set t5=The Inserted Video is 2160p 10 bit HDR 
@REM set t511=The Inserted Video is 2160p 10bit SDR 

set t6=The Inserted Video isn't 2160p 10 bit HDR 
set t7=Video Duration in seconds:
set t8=Video Duration in Minutes:
set t9=Interval between Frames for Crop Detection:
set t10= seconds
set t11=Black Bands Detection Started....
set t12=Crop Detection to Frame
set t13=to seconds
set t14=Done...
set t15=Original 2160p Video Width: 
set t16=Original 2160p Video Height:
set t17=Original Video 2160p Width Without Black Bars:
set t18=Original Video 2160p Height Without Black Bars:

set t171=Output Video 1080p Width Without Black Bars:
set t181=Outout Video 1080p Height Without Black Bars:

set t19=Adapting Video Resolution to Full 2160p Format...
set t20=Final 2160p Output Video Width:
set t21=Final 2160p Output Video Height:

set t22=Settings of Black Bands to Crop are Correct (Yes/No):
set t23=Manually Entering Black Bands Values to Crop... 
set t24=Enter the Upper Black Band Value: 
set t25=Error Entering Upper Black Band Value... It's Not a Number. 
set t26=Enter the Lower Black Band Value: 
set t27=Error Entering Lower Black Band Value... It's Not a Number.
set t28=Enter the Left Black Band Value: 
set t29=Error Entering Left Black Band Value... It's Not a Number.
set t30=Enter the Right Black Band Value: 
set t31=Error Entering Right Black Band Value... It's Not a Number.
set t32=Upper Black Band:
set t33=Lower Black Band:
set t34=Left Black Band:
set t35=Right Black Band:
set t36=2160p Original Video Width without Black Bars:
set t37=2160p Original Video Height without Black Bars:

@REM set t361=1080p Video Width without Black Bars:
@REM set t371=1080p Video Height without Black Bars

set t38=Select Graphic Card you want to Encode with:
set t39=Choose (1/2):
set t40=Select Encoding Type:
set t41=Error Entering Quantization Value... Not a Number. 
set t42=Quantization Value Set to:
set t43=Encoding Settings:
set t44=Enter Quantization value Minimum 10 Maximum 28:
set t45=Quantization Value Out of  Limits  10 / 28  Re-enter^!
set t46=Enter BitRate Value kbs Minimum 100 Maximum 50000:
set t47=Error Entering BitRate Value... It's Not a Number. 
set t48=BitRate Value Set to:
set t49=BitRate Value Out of Limits  100 / 50000  Re-enter^!
set t50=Select Encoding Quality:
set t51=- Worst Quality
set t52=- Best Quality
set t53=Choose (1/2/3/4/5/6/7):
set t54=Quality Set to:
set t55=Apply Convolution3D denoiser Yes/No: 
set t56=Apply PMD denoiser Yes/No: 
set t57=Apply Detail Enhancement Yes/No:  
set t58=Enhancement Detail: Yes 
set t59=Enhancement Detail: No 
set t60=Info
set t61=Videos to Encode Saved!
set t62=Do You Want to Insert Another Video to Encode (Yes/No):
set t63=The dragged file is not a video!
set t64=Choose (1/2/3/4):
set t65=Press Enter toback to Menu Inserting Encoding into the Queue and Saving to Disk:  

set t66=Video Width
set t67=Video Height
set t68=Video Codec
set t69=Details Video Codec
set t70=Video Format 
set t71=Configuration Settings to convert video from 8bit or 10bit SDR to 10bit HDR
set t72=Select Encoding UpGrader:
set t73=Settings UpGrader:
set t74=Choose (1/2/3):

goto avvio_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli



:caricalinguaitalianoInserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set t1=Inserimento Info Codifica Hardware Video 2160p Denoiser Leggero, Miglioramento Dettagli e Salvataggio su Disco.

set t2=Trascina Qui il 
set t211=File Video 2160p 10 bit HDR a cui applicare il Denoiser e il Miglioramento Dettagli:  

set t3=File Inesistente 
set t4=Informazioni Video:  

set t5=Il Video inserito e' 2160p 10 bit HDR 
@REM set t511=Il Video inserito e' 2160p 10bit SDR 

set t6=Il Video inserito non e' 2160p 10 bit HDR 

set t7=Durata del Video in secondi:
set t8=Durata del video in Minuti:
set t9=Intervallo tra i Fotogrammi per il Rilevamento del crop:
set t10= secondi
set t11=Rilevamento Bande Nere Iniziato....
set t12=Rilevazione crop fotogramma
set t13=a secondi
set t14=Eseguita...
set t15=Larghezza Video 2160p Originale:
set t16=Altezza Video 2160p Originale:
set t17=Larghezza Video Originale 2160p  Senza Barre Nere:
set t18=Altezza Video Originale 2160p  Senza Barre Nere:

set t171=Larghezza Video 1080p  Senza Barre Nere:
set t181=Altezza Video 1080p  Senza Barre Nere:

set t19=Adattamento della Risoluzione del Video al Pieno Formato 2160p..
set t20=Larghezza Finale Video 2160p:
set t21=Altezza Finale Video 2160p:

set t22=Le Impostazioni delle Bande Nere da Tagliare sono Corrette (Si/No):
set t23=Inserimento Manuale Valori Bande Nere da Tagliare.. 
set t24=Inserisci il Valore della Banda Nera Superiore: 
set t25=Errore nell'Inserimento del Valore della Banda Nera Superiore... Non e' un Numero. 
set t26=Inserisci il Valore della Banda Nera Inferiore: 
set t27=Errore nell'Inserimento del Valore della Banda Nera Inferiore... Non e' un Numero. 
set t28=Inserisci il Valore della Banda Nera Sinistra: 
set t29=Errore nell'Inserimento del Valore della Banda Nera Sinistra... Non e' un Numero. 
set t30=Inserisci il Valore della Banda Nera Sinistra: 
set t31=Errore nell'Inserimento del Valore della Banda Nera Sinistra... Non e' un Numero. 
set t32=Banda Nera Superiore:
set t33=Banda Nera Inferiore:
set t34=Banda Nera Sinistra:
set t35=Banda Nera Destra:
set t36=Larghezza Video Originale 2160p senza Bande Nere:
set t37=Altezza Video Originale 2160p senza Bande Nere:

@REM set t361=Larghezza Video 1080p senza Bande Nere:
@REM set t371=Altezza Video 1080p senza Bande Nere:

set t38=Selezionare Scheda Grafica con cui Eseguire la Codifica:
set t39=Scegli (1/2):
set t40=Selezionare tipo di Codifica:
set t41=Errore nell'Inserimento del Valore della Quantizzazione... Non e' un Numero. 
set t42=Valore Quantizzazzione Impostato a:
set t43=Parametri per codifica:

set t44=Inserire Valore Quantizzazione Minimo 10 Massimo 28:
set t45=Valore Quantizzazzione al di fuori dei  Limiti  10 / 28  Reinserire^!
set t46=Inserire Valore BitRate kbs Minimo 100 Massimo 50000:
set t47=Errore nell'Inserimento del Valore del BitRate... Non e' un Numero. 
set t48=Valore BitRate Impostato a:
set t49=Valore  BitRate al di fuori dei  Limiti  100 / 50000  Reinserire^!

set t50=Selezionare Qualita' Codifica:
set t51=- Peggiore Qualita'
set t52=- Migliore Qualita'
set t53=Scegli (1/2/3/4/5/6/7):
set t54=Qualita' Impostata su:
set t55=Applicare il denoiser Convolution3D Si/No: 
set t56=Applicare il denoiser PMD Si/No: 
set t57=Applicare il Miglioramento Dettagli Si/No:  
set t58=Miglioramento Dettagli: Si 
set t59=Miglioramento Dettagli: No 
set t60=Informazioni
set t61=Video da Codificare Salvate!
set t62=Vuoi Inserire un altro Video da Codificare (Si/No):
set t63=Il file trascinato non e' un video!
set t64=Scegli (1/2/3/4):
set t65=Premi Invio per tornare al menu' Inserimento Codifiche in Coda e Salvataggio sul Disco:  

set t66=Larghezza Video
set t67=Altezza Video
set t68=Codec Video
set t69=Codec Video Dettagli
set t70=Format Video 
set t71=Configurazione Parametri per convertire il video da 8bit o 10bit SDR a 10bit HDR
set t72=Selezionare UpGrader Codifica:
set t73=UpGrader Impostato:
set t74=Scegli (1/2/3):

goto avvio_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:avvio_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli




set /a "numeromovie=1"


echo !t1!
echo.


:altrivideodainserireNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli


set NomeFile2160ppuliziadettaggli=
rem set MetadatiStreamHDR10=

set /P NomeFile2160ppuliziadettaggli=!t2! !numeromovie! !t211! 
rem echo Hai digitato: %NomeFile%
rem pause

set "NomeFileSorgente=!NomeFile2160ppuliziadettaggli:"=!"
@REM echo NomeFileSorgente = !NomeFileSorgente!
set "NomeFile=^"!NomeFileSorgente!^""
@REM echo NomeFile = !NomeFile!
rem pause


if exist %NomeFile2160ppuliziadettaggli% ( goto infovideo_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli ) else ( 
                                                        echo.
                                                        echo !t3!
                                                        echo.
                                                        goto fineinfovideo_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
                                                        )    



:infovideo_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
echo.
echo !t4!
echo.

.\bin\ffprobe -v error -hide_banner -select_streams v:0 -show_entries stream=width,height,codec_name,codec_long_name,pix_fmt,color_space,color_transfer,color_primaries -of default=noprint_wrappers=1 %NomeFile2160ppuliziadettaggli% > "Temp_HDR10_Stream.txt"

set /A x1=1
set /A nohdrcs=0
set /A nohdrct=0
set /A nohdrcp=0
set /A wv=0
set /a hv=0
set /A fv=0

rem echo nohdr = %nohdr%

for /f "tokens=1,2 delims==" %%a in (Temp_HDR10_Stream.txt) do (if !x1!==3 ( 
                                                                            echo !t66! "%%a" = %%b  
                                                                            set /A "widthvideo=%%b"
                                                                            rem echo widthvideo = !widthvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !widthvideo! LEQ 3840 if !widthvideo! GEQ 2000 (set /A "wv=1"
                                                                                                                                rem echo wv = !wv!
                                                                                                                                )
                                                                            )
                                                                if !x1!==4 ( 
                                                                            echo !t67! "%%a" = %%b  
                                                                            set /A "heightvideo=%%b"
                                                                            rem echo heightvideo = !heightvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !heightvideo! LEQ 2160 if !heightvideo! GEQ 1400 (set /A "hv=1"
                                                                                                        rem echo hv = !hv!
                                                                                                        )
                                                                            )                                                           
                                                                if !x1!==6 ( 
                                                                            echo Color Space "%%a" = %%b  
                                                                            set "colorsp=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colorsp!==bt2020nc (set /A "nohdrcs=1"
                                                                                                    rem echo nohdr = !nohdr!
                                                                                                    )
                                                                            if !colorsp!==unknown (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorsp!==reserved (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                    
                                                                            ) 
                                                                if !x1!==7 ( 
                                                                            echo Color Transfer "%%a" = %%b  
                                                                            set "colortr=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colortr!==smpte2084 (set /A "nohdrct=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            ) 
                                                                if !x1!==8 ( 
                                                                            echo Color Primaries "%%a" = %%b  
                                                                            set "colorpr=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colorpr!==bt2020 (set /A "nohdrcp=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )           
                                                                            )    
                                                                if !x1!==1 ( 
                                                                            echo !t68! "%%a" = %%b  
                                                                            )       
                                                                if !x1!==2 ( 
                                                                            echo !t69! "%%a" = %%b  
                                                                            )   
                                                                if !x1!==5 ( 
                                                                            echo !t70! "%%a" = %%b  
                                                                            set "formatvideo=%%b"
                                                                            rem echo formatvideo = !formatvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !formatvideo!==yuv420p10le (set /A "fv=1"
                                                                                                            rem echo fv = !fv!
                                                                                                            )
                                                                            )
                                                                set /A x1+=1                                                            
)
echo.

if !x1!==1 goto novideofile2160p_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli


if !nohdrcs!==1 if !nohdrct!==1 if !nohdrcp!==1 if !wv!==1 if !hv!==1 if !fv!==1 ( 
                                                                                   echo !t5!
                                                                                   echo. 
                                                                                   goto rilevazionebandenere_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
                                                                                   ) 
echo !t6!
echo.
goto fineinfovideo_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli


rem//////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////

:rilevazionebandenere_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

.\bin\ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 %NomeFile2160ppuliziadettaggli%  > ".\temp\durata_film.txt"

set /a contatore=1
for /f "tokens=1 delims=." %%a in (.\temp\durata_film.txt) do  (
                                                        echo. 
                                                        echo !t7! %%a
                                                        set /a "secondi=%%a"
                                                        set /a "minuti=!secondi!/60"
                                                        echo !t8! !minuti!
                                                        set /a "intervallo_tagli=!secondi!/11"
                                                        echo !t9! !intervallo_tagli!!t10!
                                                        echo.
                                                        echo !t11!
                                                        echo.

                                                        

                                                        FOR /L %%a IN (1, 1, 10) DO (
                                                                                    rem echo %%a
                                                                                    set /a "secondi=%%a*!intervallo_tagli!"
                                                                                    rem echo !secondi!

                                                                                    
                                                                                    set /a "ca=72"
                                                                                    rem echo !ca!
                                                                                                                    
                                                                                    set /a "cb=2"
                                                                                    rem echo !cb!
                                                                                                                    
                                                                                    set /a "cc=0"
                                                                                    rem echo !cc!

                                                                                    set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                    rem echo !cr!
        
                                                                                
                                                                                    .\bin\ffmpeg -ss !secondi! -hide_banner -nostats -i %NomeFile2160ppuliziadettaggli% -vframes 10 -vf !cr! -f null - 2> ".\temp\crop.txt"
                                                                                    
                                                                                    findstr /r "Parsed_cropdetect_0" .\temp\crop.txt >> .\temp\risultato_multiplo.txt   
                                                                                    
                                                                                    echo !t12! %%a !t13! !secondi! !t14!
                                                                                    
                                                                                    )       
                                                                                       

                                                                                    for /f "tokens=1,2 delims==" %%a in (.\temp\risultato_multiplo.txt) do ( echo %%b >> .\temp\crop_multiplo.txt )
                                                                                    
                                                                                    set /a "maxfrequenza=0"

                                                                                    for /f "delims=" %%a in (.\temp\crop_multiplo.txt) do ( 
                                                                                                                                    set "cropconfront=%%a"
                                                                                                                                    rem echo "!cropconfront!"
                                                                                                                                    
                                                                                                                                    set /a "contatorfrequenza=0"
                                                                                                                                    for /f "delims=" %%b in (.\temp\crop_multiplo.txt) do (
                                                                                                                                                                                    set "dato_da_verificare=%%b"
                                                                                                                                                                                    rem echo cropconfront = "!cropconfront!"
                                                                                                                                                                                    rem echo dato_da_verificare = "!dato_da_verificare!"
                                                                                                                                                                                    if !cropconfront!==!dato_da_verificare! ( set /a "contatorfrequenza+=1")
                                                                                                                                                                                    )
                                                                                                                                    if !maxfrequenza! LSS !contatorfrequenza! ( 
                                                                                                                                                                                set /a "maxfrequenza=!!contatorfrequenza!!"
                                                                                                                                                                                set "cropd=!cropconfront!"
                                                                                                                                                                                )
                                                                                                                                    

                                                                                                                                    rem if !cropconfront! in (elenco_crop_frequenza.txt) ()
                                                                                                                                    rem echo !cropconfront!:!contatorfrequenza! >> elenco_crop_frequenza.txt

                                                                                                                                    )

                                                                                    rem echo crop piu' frequente = !cropd! con grequenza = !maxfrequenza!
                                                                                    echo !cropd! > .\temp\crop_finale.txt

                                                                                    for /f "tokens=1,2,3,4 delims=:" %%a in (.\temp\crop_finale.txt) do  ( 
                                                                                                                                                    rem set /a "mwidth=%%a"
                                                                                                                                                    rem echo mwidth = !mwidth!

                                                                                                                                                    rem set /a "mheight=%%b"
                                                                                                                                                    rem echo mheight = !mheight!

                                                                                                                                                    rem set /a "mx=%%c"
                                                                                                                                                    rem echo mx = !mx!

                                                                                                                                                    rem set /a "my=%%d"
                                                                                                                                                    rem echo my = !my!

                                                                                                                                                    if !contatore!==1 ( 
                                                                                                                                                                set /a "wmax=%%a" 
                                                                                                                                                                set /a "hmax=%%b"
                                                                                                                                                                set /a "xmin=%%c"
                                                                                                                                                                set /a "ymin=%%d"
                                                                                                                                                                set /a "mwidth=%%a"
                                                                                                                                                                set /a "mheight=%%b"
                                                                                                                                                                set /a "mx=%%c"
                                                                                                                                                                set /a "my=%%d"
                                                                                                                                                                set /a "contatore+=1"
                                                                                                                                                                )
                                                                                                                                                    
                                                                                                                                                    rem if %%b gtr !hmax! if %%c gtr !xmin! if %%d gtr !ymin! 

                                                                                                                                                    if %%a geq !wmax! if %%b geq !hmax! ( 
                                                                                                                                                                        set /a "wmax=%%a" 
                                                                                                                                                                        set /a "hmax=%%b"
                                                                                                                                                                        set /a "xmin=%%c"
                                                                                                                                                                        set /a "ymin=%%d"
                                                                                                                                                                        set /a "mwidth=%%a"
                                                                                                                                                                        set /a "mheight=%%b"
                                                                                                                                                                        set /a "mx=%%c"
                                                                                                                                                                        set /a "my=%%d"
                                                                                                                                                                        )
                                                                                                                                                    )
                                                                                    echo.

                                                                                    set /a "mwidth=!mwidth!/2*2"
                                                                                    set /a "mheight=!mheight!/2*2"

                                                                                    set /a "csup=!my!"
                                                                                    rem echo csup = !csup!
                                                                                                                                    
                                                                                    set /a "csin=!mx!"
                                                                                    rem echo csin = !csin!

                                                                                    set /a "cinf=!heightvideo!-!mheight!-!my!"
                                                                                    rem echo movieheightreal = !movieheightreal!
                                                                                    rem echo cinf = !cinf!
                                                                                    set /a "cdes=!widthvideo!-!mwidth!-!mx!"
                                                                                    rem echo cdes = !cdes!

                                                                                    set /a "Width4k=!mwidth!"
                                                                                    set /a "height4k=!mheight!"
                                                                                    
                                                                                    echo Crop Setting: --crop !csin!,!csup!,!cdes!,!cinf!  
                                                                                    set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"  
                                                                                    echo.  
                                                                                    
                                                                                    echo !t17!  !width4k! 
                                                                                    echo !t18!  !height4k! 
                                                                                    echo.

                                                                                    set /a "larghezza2160pnvenc=3840"
                                                                                    set /a "altezza2160pnvenc=2160"
                                                                                    @REM echo larghezza2160pnvenc = !larghezza2160pnvenc!                                    
                                                                                    @REM echo altezza2160pnvenc = !altezza2160pnvenc!                                    

                                                                                    set /a "differenzialelarghezza2160pnvenc=!larghezza2160pnvenc!-!mwidth!"
                                                                                    set /a "differenzialealtezza2160pnvenc=!altezza2160pnvenc!-!mheight!"
                                                                                    @REM echo differenzialelarghezza2160pnvenc = !differenzialelarghezza2160pnvenc!                                                                
                                                                                    @REM echo differenzialealtezza2160pnvenc = !differenzialealtezza2160pnvenc!

                                                                                    if !differenzialelarghezza2160pnvenc!==0 if !differenzialealtezza2160pnvenc! GTR 0 (
                                                                                                                                                                        @REM echo dentro il 1o if
                                                                                                                                                                        set /a "width4k=!mwidth!"
                                                                                                                                                                        set /a "height4k=!mheight!"
                                                                                                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                                                                                                        if !differenzialelarghezza2160pnvenc! GTR 0 if !differenzialealtezza2160pnvenc!==0 (
                                                                                                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                                                                                                set /a "width4k=!mwidth!"
                                                                                                                                                                                                                                                                set /a "height4k=!mheight!"
                                                                                                                                                                                                                                                                ) else if !differenzialelarghezza2160pnvenc! LSS !differenzialealtezza2160pnvenc! (
                                                                                                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza2160pnvenc = !differenzialelarghezza2160pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza2160pnvenc = !differenzialealtezza2160pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                                                                                                        set /a "width4k=!mwidth!+!differenzialelarghezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        set /a "height4k=!mheight!+!differenzialelarghezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        @REM echo width4k = !width4k!
                                                                                                                                                                                                                                                                                                                                                        @REM echo height4k = !height4k!
                                                                                                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza2160pnvenc! GTR !differenzialealtezza2160pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "width4k=!mwidth!+!differenzialealtezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo width4k = !width4k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "height4k=!mheight!+!differenzialealtezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo height4k = !height4k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                if !differenzialelarghezza2160pnvenc!==0 if !differenzialealtezza2160pnvenc!==0 (   
                                                                                                                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                                                                                                                set /a "width4k=!mwidth!"
                                                                                                                                                                                                                                                                set /a "height4k=!mheight!"
                                                                                                                                                                                                                                                                )
                                                                                                                                                                        
                                                                                                                                                                                if !differenzialelarghezza2160pnvenc!==!differenzialealtezza2160pnvenc! (   
                                                                                                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                                                                                                        set /a "width4k=!mwidth!+differenzialelarghezza2160pnvenc"
                                                                                                                                                                                                                                                        set /a "height4k=!mheight!+differenzialelarghezza2160pnvenc"
                                                                                                                                                                                                                                                        )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.                         

                                                                                        echo !t20!  !width4k! 
                                                                                        echo !t21!  !height4k!    
                                                                                        echo.

                                                                                    ) 
                                                        )                          

:inizioinserimentomanualecrop_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set /a "csup=0"
set /a "cinf=0"
set /a "csin=0"
set /a "cdes=0"
set /a "bandasuperiore=0"
set /a "bandainferiore=0"
set /a "bandasinistra=0"
set /a "bandadestra=0"
set /a "differenzialelarghezza1080pnvenc=0"
set /a "differenzialealtezza1080pnvenc=0"
if exist ".\temp\Temp_HDR10_Stream.txt" ( del .\temp\Temp_HDR10_Stream.txt )
if exist ".\temp\durata_film.txt" ( del .\temp\durata_film.txt )
if exist ".\temp\crop.txt" ( del .\temp\crop.txt )
if exist ".\temp\risultato_multiplo.txt" ( del .\temp\risultato_multiplo.txt )
if exist ".\temp\crop_multiplo.txt" ( del .\temp\crop_multiplo.txt )
if exist ".\temp\crop_finale.txt" ( del .\temp\crop_finale.txt )  

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t22!"   
    if errorlevel 2 goto inserimentomanualecrop_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
    if errorlevel 1 goto finecrop_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
)

CHOICE /N /C:SN /M "!t22!"   

if errorlevel 2 goto inserimentomanualecrop_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
if errorlevel 1 goto finecrop_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:inserimentomanualecrop_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
echo.
echo !t23!
echo.

:banda_superiore_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set /p "bandasuperiore=!t24!"
SET "var="&for /f "delims=0123456789" %%i in ("!bandasuperiore!") do set var=!bandasuperiore!
if defined var (
                echo.
                echo !t25!
                echo.
                goto banda_superiore_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
                ) else (
                        set /a "csup=!bandasuperiore!/2*2"
                        )

echo.
:banda_inferiore_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set /p "bandainferiore=!t26!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandainferiore!") do set var=!bandainferiore!
if defined var (
                echo.
                echo !t27!
                echo.
                goto banda_inferiore_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
                ) else (
                        set /a "cinf=!bandainferiore!/2*2"
                        )


echo.
:banda_sinistra_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set /p "bandasinistra=!t28!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandasinistra!") do set var=!bandasinistra!
if defined var (
                echo.
                echo !t29!
                echo.
                goto banda_sinistra_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
                ) else (
                        set /a "csin=!bandasinistra!/2*2"
                        )

                        
echo.
:banda_destra_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set /p "bandadestra=!t30!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandadestra!") do set var=!bandadestra!
if defined var (
                echo.
                echo !t31!
                echo.
                goto banda_destra_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
                ) else (
                        set /a "cdes=!bandadestra!/2*2"
                        )


set /a "larghezza2160pnvenc=3840"
set /a "altezza2160pnvenc=2160"
@REM echo larghezza2160pnvenc = !larghezza2160pnvenc!                                    
@REM echo altezza2160pnvenc = !altezza2160pnvenc!                                    

set /a "mwidth=!widthvideo!/2*2"
set /a "mheight=!heightvideo!/2*2"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "mwidthc=!mwidth!-!csin!-!cdes!"
set /a "mheightc=!mheight!-!csup!-!cinf!"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "differenzialelarghezza2160pnvenc=!larghezza2160pnvenc!-!mwidthc!"
set /a "differenzialealtezza2160pnvenc=!altezza2160pnvenc!-!mheightc!"
@REM echo differenzialelarghezza2160pnvenc = !differenzialelarghezza2160pnvenc!                                                                
@REM echo differenzialealtezza2160pnvenc = !differenzialealtezza2160pnvenc!

echo.
echo !t32!  !csup! 
echo !t33!  !cinf! 
echo !t34!  !csin! 
echo !t35!  !cdes! 
echo.


set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
echo Crop Settings: !cropff!
echo.

echo !t17!  !mwidthc! 
echo !t18!  !mheightc! 
echo.



if !differenzialelarghezza2160pnvenc!==0 if !differenzialealtezza2160pnvenc! GTR 0 (
                                                                                        @REM echo dentro il 1o if
                                                                                        set /a "width4k=!mwidthc!"
                                                                                        set /a "height4k=!mheightc!"
                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                        if !differenzialelarghezza2160pnvenc! GTR 0 if !differenzialealtezza2160pnvenc!==0 (
                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                set /a "width4k=!mwidthc!"
                                                                                                                                                                                set /a "height4k=!mheightc!"
                                                                                                                                                                                ) else if !differenzialelarghezza2160pnvenc! LSS !differenzialealtezza2160pnvenc! (
                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza2160pnvenc = !differenzialelarghezza2160pnvenc!
                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza2160pnvenc = !differenzialealtezza2160pnvenc!
                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                        set /a "width4k=!mwidthc!+!differenzialelarghezza2160pnvenc!"
                                                                                                                                                                                                                                                                        set /a "height4k=!mheightc!+!differenzialelarghezza2160pnvenc!"
                                                                                                                                                                                                                                                                        @REM echo width4k = !width4k!
                                                                                                                                                                                                                                                                        @REM echo height4k = !height4k!
                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza2160pnvenc! GTR !differenzialealtezza2160pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                set /a "width4k=!mwidthc!+!differenzialealtezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo width4k = !width4k!
                                                                                                                                                                                                                                                                                                                                                                set /a "height4k=!mheightc!+!differenzialealtezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo height4k = !height4k!
                                                                                                                                                                                                                                                                                                                                                                )
                                                                                        if !differenzialelarghezza2160pnvenc!==0 if !differenzialealtezza2160pnvenc!==0 (   
                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                        set /a "width4k=!mwidthc!"
                                                                                                                                                                        set /a "height4k=!mheightc!"
                                                                                                                                                                        )
                                                                                                                                                                        
                                                                                        if !differenzialelarghezza2160pnvenc!==!differenzialealtezza2160pnvenc! (   
                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                set /a "width4k=!mwidthc!+differenzialelarghezza2160pnvenc"
                                                                                                                                                                set /a "height4k=!mheightc!+differenzialelarghezza2160pnvenc"
                                                                                                                                                                )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.                         

                                                                                        echo !t20!  !width4k! 
                                                                                        echo !t21!  !height4k!    
                                                                                        echo.

                                                                                    ) 

goto inizioinserimentomanualecrop_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli


:finecrop_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli


rem//////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////


echo.
echo !t38!
echo.
echo 1) NVidia 
echo 2) Intel 
echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto ChoosenIntel_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
if errorlevel 1 goto ChoosenNVidia_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:ChoosenIntel_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set "SchedaGrafica=Intel"
@REM echo SchedaGrafica = !SchedaGrafica!
goto fineSceltaSchedaGrafica_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:ChoosenNVidia_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set "SchedaGrafica=NVidia"
@REM echo SchedaGrafica = !SchedaGrafica!

:fineSceltaSchedaGrafica_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

@REM pause 

if !SchedaGrafica!==NVidia (
                                goto InserimentoImpostazioniNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
                                ) 





if !SchedaGrafica!==Intel (
                                goto InserimentoImpostazioniQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
                                 )


@REM pause 




:InserimentoImpostazioniNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

echo.
echo !t40!
echo.
echo 1) CQP 
echo 2) VBR 
echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto CodificaVBRNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
if errorlevel 1 goto CodificaCQPNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:CodificaVBRNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set "TipoCodificaNVEnc=--vbr "
set /a "quantizzazioneNVEnc=0"
goto inserimentoValoriCQPVBRNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:CodificaCQPNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set "TipoCodificaNVEnc=--cqp "
set /a "quantizzazioneNVEnc=1"

:inserimentoValoriCQPVBRNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

if !quantizzazioneNVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneNVEnc=!t44! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneNVEnc!") do set var=!valoreQuantizzazioneNVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                echo.
                                                goto inserimentoValoriCQPVBRNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
                                                ) 

                                set /a "valoreQuantizzazioneNVEnc=!valoreQuantizzazioneNVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneNVEnc!
                                if !valoreQuantizzazioneNVEnc! GEQ 10 if !valoreQuantizzazioneNVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneNVEnc!
                                                                                                                set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreQuantizzazioneNVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                                goto fineQuantizzazioneNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
                                                                                                                        
                                )



if !quantizzazioneNVEnc!==0 (
                                echo.
                                set /p "valoreBitRateNVEnc=!t46! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateNVEnc!") do set var=!valoreBitRateNVEnc!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                echo.
                                                goto inserimentoValoriCQPVBRNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
                                                ) 
                                set /a "valoreBitRateNVEnc=!valoreBitRateNVEnc!"
                                @REM echo valoreBitRateNVEnc = !valoreBitRateNVEnc!
                                if !valoreBitRateNVEnc! GEQ 100 if !valoreBitRateNVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateNVEnc!
                                                                                                        set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreBitRateNVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                        goto fineQuantizzazioneNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
                                                                                                        
                                )


:fineQuantizzazioneNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

echo.
echo !t50!
echo.
echo 1) P1 !t51!
echo 2) P2 
echo 3) P3 
echo 4) P4 
echo 5) P5 
echo 6) P6 
echo 7) P7 !t52!
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto P7NVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
if errorlevel 6 goto P6NVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
if errorlevel 5 goto P5NVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
if errorlevel 4 goto P4NVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
if errorlevel 3 goto P3NVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
if errorlevel 2 goto P2NVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
if errorlevel 1 goto P1NVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli


:P7NVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set "SettaggioQualitaNVEnc=--preset P7"
set "QualitySetting=P7"
goto fineQualitCodificaNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:P6NVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set "SettaggioQualitaNVEnc=--preset P6"
set "QualitySetting=P6"
goto fineQualitCodificaNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:P5NVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set "SettaggioQualitaNVEnc=--preset P5"
set "QualitySetting=P5"
goto fineQualitCodificaNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:P4NVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set "SettaggioQualitaNVEnc=--preset P4"
set "QualitySetting=P4"
goto fineQualitCodificaNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:P3NVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set "SettaggioQualitaNVEnc=--preset P3"
set "QualitySetting=P3"
goto fineQualitCodificaNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:P2NVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set "SettaggioQualitaNVEnc=--preset P2"
set "QualitySetting=P2"
goto fineQualitCodificaNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:P1NVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set "SettaggioQualitaNVEnc=--preset P1"
set "QualitySetting=P1"
goto fineQualitCodificaNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli


:fineQualitCodificaNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaNVEnc!


rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

:sceltadenoiserNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set conv3d1080p=
set pmd1080p=

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t55!"
    if errorlevel 2 goto conv3dChoosenNoNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
    if errorlevel 1 goto conv3dChoosenYesNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
)

echo.
CHOICE /N /C:SN /M "!t55!"

if errorlevel 2 goto conv3dChoosenNoNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
if errorlevel 1 goto conv3dChoosenYesNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:conv3dChoosenNoNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set "conv3d1080p=N"
goto sceltaDeniserPMDNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:conv3dChoosenYesNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set "conv3d1080p=S"


:sceltaDeniserPMDNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t56!"
    if errorlevel 2 goto PMDChoosenNoNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
    if errorlevel 1 goto PPMDChoosenYesNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
)

echo.
CHOICE /N /C:SN /M "!t56!"

if errorlevel 2 goto PMDChoosenNoNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
if errorlevel 1 goto PPMDChoosenYesNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:PMDChoosenNoNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set "pmd1080p=N"
goto assegnazioneDenoisesNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:PPMDChoosenYesNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set "pmd1080p=S"


:assegnazioneDenoisesNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set /A nvdenv=0

if !conv3d1080p!==S if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00 --vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==S if !pmd1080p!==N ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==N ( 
                                        set "nvdenoiser=nessuno" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: Nessun Denoiser 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )

@REM pause

set file_senza_virgolette=%NomeFile:"=%
rem echo %file_senza_virgolette%

set file_senza_estensione=%file_senza_virgolette:.mkv=%
rem echo %file_senza_estensione%

set fileoutput2160p="%file_senza_estensione%_Denoiser_Leggero_Dettagli_Migliorati.mkv"
rem echo fileoutput2160p = %fileoutput2160p%

echo.
set "VideoInfoCodifica=NVEnc_2160p_denoier_pulizia|!NomeFile!|!fileoutput2160p!|nessuno|!cropff!|!width4k!x!height4k!|nessuna|nessuno|!colorpr!|!colortr!|!colorsp!|!tipoQuantizzazioneNVEnc!|!SettaggioQualitaNVEnc!|nessuno|nessuno|!nvdenoiser!|!formatvideo!|no_miglioramento_dettagli|no_color_correction|no_numero_passaggi_upscaling|no_lokahead|no_precisione_vettore_movimento"
@REM echo VideoInfoCodifica = !VideoInfoCodifica!
@REM echo.

if exist ".\saved\savedmoviesallencodings.dat" ( 
                                                echo !VideoInfoCodifica! >> .\saved\savedmoviesallencodings.dat
                                                goto finesalvataggioInserimentoNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
                                                ) 

echo !VideoInfoCodifica! > .\saved\savedmoviesallencodings.dat


:finesalvataggioInserimentoNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

echo !t60! !numeromovie! !t61!
echo.

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t62!"
    if errorlevel 2 goto finesceltanuovovideodacodificareNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
    if errorlevel 1 goto altrivideodainserireMenuNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
)

CHOICE /N /C:SN /M "!t62!"
echo.

if errorlevel 2 goto finesceltanuovovideodacodificareNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
if errorlevel 1 goto altrivideodainserireMenuNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:altrivideodainserireMenuNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set /a "numeromovie+=1"
echo.
goto altrivideodainserireNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:finesceltanuovovideodacodificareNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
echo.
goto fineinfovideo_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli


rem//////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////


:InserimentoImpostazioniQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

echo.
echo !t40!
echo.
echo 1) CQP 
echo 2) ICQ 
echo 3) LA-ICQ 
echo 4) VBR 
echo.
CHOICE /N /C:1234 /M "!t64!"

if errorlevel 4 goto CodificaVBRQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
if errorlevel 3 goto CodificaLAICQQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
if errorlevel 2 goto CodificaICQQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
if errorlevel 1 goto CodificaCQPQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli


:CodificaCQPQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set "TipoCodificaQSVEnc=--cqp "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:CodificaICQQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set "TipoCodificaQSVEnc=--icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:CodificaLAICQQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set "TipoCodificaQSVEnc=--la-icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:CodificaVBRQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set "TipoCodificaQSVEnc=--vbr "
set /a "quantizzazioneQSVEnc=0"
goto inserimentoValoriCQPVBRQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli


:inserimentoValoriCQPVBRQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

if !quantizzazioneQSVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneQSVEnc=!t44! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneQSVEnc!") do set var=!valoreQuantizzazioneQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                echo.
                                                goto inserimentoValoriCQPVBRQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
                                                ) 

                                set /a "valoreQuantizzazioneQSVEnc=!valoreQuantizzazioneQSVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneQSVEnc!
                                if !valoreQuantizzazioneQSVEnc! GEQ 10 if !valoreQuantizzazioneQSVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneQSVEnc!
                                                                                                                set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreQuantizzazioneQSVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                                goto fineQuantizzazioneQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
                                                                                                                        
                                )



if !quantizzazioneQSVEnc!==0 (
                                echo.
                                set /p "valoreBitRateQSVEnc=!t46! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateQSVEnc!") do set var=!valoreBitRateQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                echo.
                                                goto inserimentoValoriCQPVBRQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
                                                ) 
                                set /a "valoreBitRateQSVEnc=!valoreBitRateQSVEnc!"
                                @REM echo valoreBitRateQSVEnc = !valoreBitRateQSVEnc!
                                if !valoreBitRateQSVEnc! GEQ 100 if !valoreBitRateQSVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateQSVEnc!
                                                                                                        set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreBitRateQSVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                        goto fineQuantizzazioneQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
                                                                                                              
                                )

:fineQuantizzazioneQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli


echo.
echo !t50!
echo.
echo 1) Best 
echo 2) Higher 
echo 3) High 
echo 4) Balanced 
echo 5) Fast 
echo 6) Faster 
echo 7) Fastest 
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto QualitFastestQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
if errorlevel 6 goto QualitFasterQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
if errorlevel 5 goto QualitFastQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
if errorlevel 4 goto QualitBalancedtQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
if errorlevel 3 goto QualitHighQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
if errorlevel 2 goto QualitHigherQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
if errorlevel 1 goto QualitBestQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli


:QualitBestQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set "SettaggioQualitaQSvenc=--quality best"
set "QualitySetting=best"
goto fineQualitCodificaQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:QualitHigherQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set "SettaggioQualitaQSvenc=--quality higher"
set "QualitySetting=higher"
goto fineQualitCodificaQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:QualitHighQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set "SettaggioQualitaQSvenc=--quality high"
set "QualitySetting=high"
goto fineQualitCodificaQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:QualitBalancedtQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set "SettaggioQualitaQSvenc=--quality balanced"
set "QualitySetting=balanced"
goto fineQualitCodificaQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:QualitFastQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set "SettaggioQualitaQSvenc=--quality fast"
set "QualitySetting=fast"
goto fineQualitCodificaQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:QualitFasterQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set "SettaggioQualitaQSvenc=--quality faster"
set "QualitySetting=faster"
goto fineQualitCodificaQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:QualitFastestQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set "SettaggioQualitaQSvenc=--quality fastest"
set "QualitySetting=fastest"
goto fineQualitCodificaQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli


:fineQualitCodificaQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaQSvenc!

rem/////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////

:sceltadenoiserQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set conv3d1080p=
set pmd1080p=

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t55!"
    if errorlevel 2 goto conv3dChoosenNoQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
    if errorlevel 1 goto conv3dChoosenYesQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
)
echo.
CHOICE /N /C:SN /M "!t55!"

if errorlevel 2 goto conv3dChoosenNoQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
if errorlevel 1 goto conv3dChoosenYesQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:conv3dChoosenNoQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set "conv3d1080p=N"
goto sceltaDeniserPMDQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:conv3dChoosenYesQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set "conv3d1080p=S"


:sceltaDeniserPMDQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
:sceltaDeniserPMDQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t56!"
    if errorlevel 2 goto PMDChoosenNoQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
    if errorlevel 1 goto PPMDChoosenYesQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
)
echo.
CHOICE /N /C:SN /M "!t56!"

if errorlevel 2 goto PMDChoosenNoQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
if errorlevel 1 goto PPMDChoosenYesQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:PMDChoosenNoQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set "pmd1080p=N"
goto assegnazioneDenoisesQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:PPMDChoosenYesQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set "pmd1080p=S"


:assegnazioneDenoisesQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set /A nvdenv=0

if !conv3d1080p!==S if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00 --vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==S if !pmd1080p!==N ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==N ( 
                                        set "nvdenoiser=nessuno" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: Nessun Denoiser 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )


@REM pause

set file_senza_virgolette=%NomeFile:"=%
rem echo %file_senza_virgolette%

set file_senza_estensione=%file_senza_virgolette:.mkv=%
rem echo %file_senza_estensione%

set fileoutput2160p="%file_senza_estensione%_Denoiser_Leggero_Dettagli_Migliorati.mkv"
rem echo fileoutput2160p = %fileoutput2160p%

echo.
set "VideoInfoCodifica=QSVEnc_2160p_denoier_pulizia|!NomeFile!|!fileoutput2160p!|nessuno|!cropff!|!width4k!x!height4k!|nessuna|nessuno|!colorpr!|!colortr!|!colorsp!|!tipoQuantizzazioneQSVEnc!|!SettaggioQualitaQSVEnc!|nessuno|nessuno|!nvdenoiser!|!formatvideo!|no_miglioramento_dettagli|no_color_correction|no_numero_passaggi_upscaling|no_lokahead|no_precisione_vettore_movimento"
@REM echo VideoInfoCodifica = !VideoInfoCodifica!
@REM echo.

if exist ".\saved\savedmoviesallencodings.dat" ( 
                                                echo !VideoInfoCodifica! >> .\saved\savedmoviesallencodings.dat
                                                goto finesalvataggioInserimentoQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
                                                ) 

echo !VideoInfoCodifica! > .\saved\savedmoviesallencodings.dat


:finesalvataggioInserimentoQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

echo !t60! !numeromovie! !t61!
echo.

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t62!"
    if errorlevel 2 goto finesceltanuovovideodacodificareQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
    if errorlevel 1 goto altrivideodainserireMenuQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
)

CHOICE /N /C:SN /M "!t62!"
echo.

if errorlevel 2 goto finesceltanuovovideodacodificareQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
if errorlevel 1 goto altrivideodainserireMenuQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:altrivideodainserireMenuQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
set /a "numeromovie+=1"
echo.
goto altrivideodainserireNVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

:finesceltanuovovideodacodificareQSVEnc_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
echo.
goto fineinfovideo_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli

rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////




goto fineinfovideo_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli




:novideofile2160p_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
echo !t63!
echo.


:fineinfovideo_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli


if exist ".\temp\Temp_HDR10_Stream.txt" ( del .\temp\Temp_HDR10_Stream.txt )
if exist ".\temp\durata_film.txt" ( del .\temp\durata_film.txt )
if exist ".\temp\crop.txt" ( del .\temp\crop.txt )
if exist ".\temp\risultato_multiplo.txt" ( del .\temp\risultato_multiplo.txt )
if exist ".\temp\crop_multiplo.txt" ( del .\temp\crop_multiplo.txt )
if exist ".\temp\crop_finale.txt" ( del .\temp\crop_finale.txt )
      




set waitenter=
set /P waitenter=!t65!
Endlocal
goto InserimentoCodifcaInCodaeSalvataggioSuDisco







rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:InserimentoFFmpegCodificaSoftwareH265
cls
setLocal EnableExtensions EnableDelayedExpansion


for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoInserimentoFFmpegCodificaSoftwareH265
)

if %lingua%==inglese (
    goto caricalinguaingleseInserimentoFFmpegCodificaSoftwareH265
)



:caricalinguaingleseInserimentoFFmpegCodificaSoftwareH265
set t1=Insert Info FFmpeg Video Software Encoding and Saving to Disk

set t2=Drag Here the
set t211=Video File to Encode:  

set t3=File does not exist 
set t4=Info Video:  

set t5=The Inserted Video is 2160p 8bit SDR 
set t511=The Inserted Video is 2160p 10bit SDR 

set t6=The Inserted Video isn't 2160p 8bit or 10bit SDR 
set t7=Video Duration in seconds:
set t8=Video Duration in Minutes:
set t9=Interval between Frames for Crop Detection:
set t10= seconds
set t11=Black Bands Detection Started....
set t12=Crop Detection to Frame
set t13=to seconds
set t14=Done...
set t15=Original 2160p Video Width: 
set t16=Original 2160p Video Height:
set t17=Video Width Without Black Bars:
set t18=Video Height Without Black Bars:

set t171=Output Video 1080p Width Without Black Bars:
set t181=Outout Video 1080p Height Without Black Bars:

set t19=Adapting Video Resolution to Full 2160p Format...
set t20=Final 2160p Output Video Width:
set t21=Final 2160p Output Video Height:

set t22=Settings of Black Bands to Crop are Correct (Yes/No):
set t23=Manually Entering Black Bands Values to Crop... 
set t24=Enter the Upper Black Band Value: 
set t25=Error Entering Upper Black Band Value... It's Not a Number. 
set t26=Enter the Lower Black Band Value: 
set t27=Error Entering Lower Black Band Value... It's Not a Number.
set t28=Enter the Left Black Band Value: 
set t29=Error Entering Left Black Band Value... It's Not a Number.
set t30=Enter the Right Black Band Value: 
set t31=Error Entering Right Black Band Value... It's Not a Number.
set t32=Upper Black Band:
set t33=Lower Black Band:
set t34=Left Black Band:
set t35=Right Black Band:
set t36=2160p Original Video Width without Black Bars:
set t37=2160p Original Video Height without Black Bars:

@REM set t361=1080p Video Width without Black Bars:
@REM set t371=1080p Video Height without Black Bars

set t38=Select Graphic Card you want to Encode with:
set t39=Choose (1/2):
set t40=Select Encoding Type:
set t41=Error Entering Quantization Value... Not a Number. 
set t42=Quantization Value Set to:
set t43=Encoding Settings:
set t44=Enter Quantization value Minimum 10 Maximum 28:
set t45=Quantization Value Out of  Limits  10 / 28  Re-enter^!
set t46=Enter BitRate Value kbs Minimum 100 Maximum 50000:
set t47=Error Entering BitRate Value... It's Not a Number. 
set t48=BitRate Value Set to:
set t49=BitRate Value Out of Limits  100 / 50000  Re-enter^!
set t50=Select Encoding Quality:
set t51=- Worst Quality
set t52=- Best Quality
set t53=Choose (1/2/3/4/5/6/7):
set t54=Quality Set to:
set t55=Apply Convolution3D denoiser Yes/No: 
set t56=Apply PMD denoiser Yes/No: 
set t57=Apply Detail Enhancement Yes/No:  
set t58=Enhancement Detail: Yes 
set t59=Enhancement Detail: No 
set t60=Info
set t61=Videos to Encode Saved!
set t62=Do You Want to Insert Another Video to Encode (Yes/No):
set t63=The dragged file is not a video!
set t64=Choose (1/2/3/4):
set t65=Press Enter toback to Menu Inserting Encoding into the Queue and Saving to Disk:  

set t66=Video Width
set t67=Video Height
set t68=Video Codec
set t69=Details Video Codec
set t70=Video Format 
set t71=Configuration Settings to convert video from 8bit or 10bit SDR to 10bit HDR
set t72=Select Encoding UpGrader:
set t73=Settings UpGrader:
set t74=Choose (1/2/3):

set t75=Dolby Vision Metadata Present 
set t76=HDR10+ Metadata Present 
set t77=FFmpeg x265 Settings:  

set t78=Insert CRF Value Minimum 10 Maximum 28:
set t79=Error Entering CRF value... It is not a number. 
set t80=CRF Value Set to:
set t81=CRF Value Out of Limits  10 / 28  Re-enter^!

set t82=Select Encoding Speed-Quality:
set t83=- Worst Quality - The Faster Encoding
set t84=- Recommended
set t85=- Best Quality - The Slowest Encoding
set t86=Choose (1/2/3/4/5/6/7/8/9/0):
set t87=Speed-Quality Set to:

set t88=Select Type of Adptive Quantization:
set t89=1) Disabled 
set t90=2) Enabled 
set t91=3) Enabled + Auto-Variance 
set t92=4) Enabled + Auto-Variance + Dark Bias 
set t93=5) Enabled + Auto-Variance + Edge
set t94=Choose (1/2/3/4/5):
set t95=Adaptive Quantization Set to:
set t96=Select Value of Adaptive Quantization Strength:
set t97=- Worst Quality - Smaller File
set t98=- Best Quality - Bigger File
set t99=Adaptive Quantization Strength Set to:

set t100=Select Denoiser Filter:
set t101=1) No one 
set t102=Selected Denoiser:
set t103=Select Denoiser Strength:
set t104=1) Weak 
set t105=2) Moderate 
set t106=3) Strong 

set t107=The video has no Master Display Metadata.

set t108=Enabled + Auto-Variance + Edge
set t109=Enabled + Auto-Variance + Dark Bias
set t110=Enabled + Auto-Variance
set t111=Enabled 
set t112=93mDisabled

set t113=No Denoiser

goto avvio_InserimentoFFmpegCodificaSoftwareH265



:caricalinguaitalianoInserimentoFFmpegCodificaSoftwareH265
set t1=Inserimento Informazioni FFmpeg Codifica Software Video e Salvataggio su Disco.

set t2=Trascina Qui il 
set t211=File Video da Codificare:  

set t3=File Inesistente 
set t4=Informazioni Video:  

set t5=Il Video inserito e' 2160p 8bit SDR 
set t511=Il Video inserito e' 2160p 10bit SDR 

set t6=Il Video inserito non e' 2160p 8bit o 10bit SDR 

set t7=Durata del Video in secondi:
set t8=Durata del video in Minuti:
set t9=Intervallo tra i Fotogrammi per il Rilevamento del crop:
set t10= secondi
set t11=Rilevamento Bande Nere Iniziato....
set t12=Rilevazione crop fotogramma
set t13=a secondi
set t14=Eseguita...
set t15=Larghezza Video 2160p Originale:
set t16=Altezza Video 2160p Originale:
set t17=Larghezza Video Senza Barre Nere:
set t18=Altezza Video Senza Barre Nere:

set t171=Larghezza Video 1080p  Senza Barre Nere:
set t181=Altezza Video 1080p  Senza Barre Nere:

set t19=Adattamento della Risoluzione del Video al Pieno Formato 2160p..
set t20=Larghezza Finale Video 2160p:
set t21=Altezza Finale Video 2160p:

set t22=Le Impostazioni delle Bande Nere da Tagliare sono Corrette (Si/No):
set t23=Inserimento Manuale Valori Bande Nere da Tagliare.. 
set t24=Inserisci il Valore della Banda Nera Superiore: 
set t25=Errore nell'Inserimento del Valore della Banda Nera Superiore... Non e' un Numero. 
set t26=Inserisci il Valore della Banda Nera Inferiore: 
set t27=Errore nell'Inserimento del Valore della Banda Nera Inferiore... Non e' un Numero. 
set t28=Inserisci il Valore della Banda Nera Sinistra: 
set t29=Errore nell'Inserimento del Valore della Banda Nera Sinistra... Non e' un Numero. 
set t30=Inserisci il Valore della Banda Nera Destra: 
set t31=Errore nell'Inserimento del Valore della Banda Nera Destra... Non e' un Numero. 
set t32=Banda Nera Superiore:
set t33=Banda Nera Inferiore:
set t34=Banda Nera Sinistra:
set t35=Banda Nera Destra:
set t36=Larghezza Video Originale 2160p senza Bande Nere:
set t37=Altezza Video Originale 2160p senza Bande Nere:

@REM set t361=Larghezza Video 1080p senza Bande Nere:
@REM set t371=Altezza Video 1080p senza Bande Nere:

set t38=Selezionare Scheda Grafica con cui Eseguire la Codifica:
set t39=Scegli (1/2):
set t40=Selezionare tipo di Codifica:
set t41=Errore nell'Inserimento del Valore della Quantizzazione... Non e' un Numero. 
set t42=Valore Quantizzazzione Impostato a:
set t43=Parametri per codifica:

set t44=Inserire Valore Quantizzazione Minimo 10 Massimo 28:
set t45=Valore Quantizzazzione al di fuori dei  Limiti  10 / 28  Reinserire^!
set t46=Inserire Valore BitRate kbs Minimo 100 Massimo 50000:
set t47=Errore nell'Inserimento del Valore del BitRate... Non e' un Numero. 
set t48=Valore BitRate Impostato a:
set t49=Valore  BitRate al di fuori dei  Limiti  100 / 50000  Reinserire^!

set t50=Selezionare Qualita' Codifica:
set t51=- Peggiore Qualita'
set t52=- Migliore Qualita'
set t53=Scegli (1/2/3/4/5/6/7):
set t54=Qualita' Impostata su:
set t55=Applicare il denoiser Convolution3D Si/No: 
set t56=Applicare il denoiser PMD Si/No: 
set t57=Applicare il Miglioramento Dettagli Si/No:  
set t58=Miglioramento Dettagli: Si 
set t59=Miglioramento Dettagli: No 
set t60=Informazioni
set t61=Video da Codificare Salvate!
set t62=Vuoi Inserire un altro Video da Codificare (Si/No):
set t63=Il file trascinato non e' un video!
set t64=Scegli (1/2/3/4):
set t65=Premi Invio per tornare al menu' Inserimento Codifiche in Coda e Salvataggio sul Disco:  

set t66=Larghezza Video
set t67=Altezza Video
set t68=Codec Video
set t69=Codec Video Dettagli
set t70=Format Video 
set t71=Configurazione Parametri per convertire il video da 8bit o 10bit SDR a 10bit HDR
set t72=Selezionare UpGrader Codifica:
set t73=UpGrader Impostato:
set t74=Scegli (1/2/3):

set t75=Metadati Dolby Vision Presenti 
set t76=Metadati HDR10+ Presenti  
set t77=FFmpeg Parametri x265:  

set t78=Inserire Valore CRF Minimo 10 Massimo 28:
set t79=Errore nell'Inserimento del Valore del CRF... Non e' un Numero. 
set t80=Valore CRF Impostato a:
set t81=Valore CRF al di fuori dei  Limiti  10 / 28  Reinserire^!

set t82=Selezionare Velocita'-Qualita' Codifica:
set t83=- Peggiore Qualita' - Codifica Molto Veloce
set t84=- Consigliata
set t85=- Migliore Qualita' - Codifica Molto Lenta
set t86=Scegli (1/2/3/4/5/6/7/8/9/0):
set t87=Velocita'-Qualita' Impostata su:

set t88=Selezionare tipo di Quantizzazione Adattiva:
set t89=1) Disabilitata 
set t90=2) Abilitata 
set t91=3) Abilitata + Auto-Variance 
set t92=4) Abilitata + Auto-Variance + Dark Bias 
set t93=5) Abilitata + Auto-Variance + Edge
set t94=Scegli (1/2/3/4/5):
set t95=Quantizzazione Adattiva Impostata su:

set t96=Selezionare Valore Forza Quantizzazione Adattiva:
set t97=- Peggiore Qualita' - File piu' Piccolo
set t98=- Migliore Qualita' - File piu' Grande
set t99=Forza Quantizzazione Adattiva Impostata su:

set t100=Selezionare Filtro Denoiser:
set t101=1) Nessuno 
set t102=Denoiser Selezionato:
set t103=Selezionare Intensita' Denoiser:
set t104=1) Leggero 
set t105=2) Medio 
set t106=3) Forte 

set t107=Il Video non ha Metadati Master Display

set t108=Abilitata + Auto-Variance + Edge
set t109=Abilitata + Auto-Variance + Dark Bias
set t110=Abilitata + Auto-Variance
set t111=Abilitata
set t112=Disabilitata

set t113=Nessun Denoiser
goto avvio_InserimentoFFmpegCodificaSoftwareH265

:avvio_InserimentoFFmpegCodificaSoftwareH265






set /a "numeromovie=1"

echo !t1!
echo.

:altrivideodainserireInserimentoFFmpegCodificaSoftwareH265
set "NomeFile="
rem set MetadatiStreamHDR10=

set /P NomeFile=!t2! !numeromovie! !t211! 
rem echo Hai digitato: %NomeFile%
rem pause

set "NomeFileSorgente=!NomeFile:"=!"
@REM echo NomeFileSorgente = !NomeFileSorgente!
set "NomeFile=^"!NomeFileSorgente!^""
@REM echo NomeFile = !NomeFile!
rem pause

if exist !NomeFile! ( goto InfoVideoInserimentoFFmpegCodificaSoftwareH265 ) else ( 
                                                        echo.
                                                        echo !t3!
                                                        echo.
                                                        goto FineInserimentoFFmpegCodificaSoftwareH265
                                                        )    



:InfoVideoInserimentoFFmpegCodificaSoftwareH265
echo.
echo !t4!
echo.

.\bin\ffprobe -v error -hide_banner -select_streams v:0 -show_entries stream=width,height,codec_name,codec_long_name,pix_fmt,color_space,color_transfer,color_primaries -of default=noprint_wrappers=1 %NomeFile% > ".\temp\Temp_HDR10_Stream.txt"

set /A "hdrcs=0"
set /A "hdrtr=0"
set /A "hdrcp=0"
set /A "fv=0"
set /A "x1=1"

rem echo nohdr = %nohdr%

for /f "tokens=1,2 delims==" %%a in (.\temp\Temp_HDR10_Stream.txt) do (
                                                                if !x1!==1 ( 
                                                                            echo !t68! "%%a" = %%b  
                                                                            )       
                                                                if !x1!==2 ( 
                                                                            echo !t69! "%%a" = %%b  
                                                                            )   
                                                                if !x1!==3 ( 
                                                                            echo !t66! "%%a" = %%b  
                                                                            set /A "widthvideo=%%b"
                                                                            @REM echo widthvideo = !widthvideo!
                                                                            )
                                                                if !x1!==4 ( 
                                                                            echo !t67! "%%a" = %%b  
                                                                            set /A "heightvideo=%%b"
                                                                            @REM echo heightvideo = !heightvideo!
                                                                            ) 
                                                                if !x1!==5 ( 
                                                                            echo !t70! "%%a" = %%b  
                                                                            set "formatvideo=%%b"
                                                                            @REM echo formatvideo = !formatvideo!
                                                                            if !formatvideo!==yuv420p10le (
                                                                                                            set /A "fv=1"
                                                                                                            @REM echo fv = !fv!
                                                                                                        )
                                                                            )
                                                                if !x1!==6 ( 
                                                                            echo Color Space "%%a" = %%b  
                                                                            set "colorsp=%%b"
                                                                            @REM echo colorsp = !colorsp!
                                                                            if !colorsp!==bt2020nc (
                                                                                                    set /A "hdrcs=1"
                                                                                                    @REM echo hdrcs = !hdrcs!
                                                                                                    )                
                                                                            ) 
                                                                if !x1!==7 ( 
                                                                            echo Color Transfer "%%a" = %%b  
                                                                            set "colortr=%%b"
                                                                            @REM echo colortr = !colortr!
                                                                            if !colortr!==smpte2084 (
                                                                                                    set /A "hdrtr=1"
                                                                                                    @REM echo hdrtr = !hdrtr!
                                                                                                    )
                                                                            if !colortr!==unknown (
                                                                                                    set /A "hdrtr=1"
                                                                                                @REM echo hdrtr = !hdrtr!
                                                                                                )
                                                                            if !colortr!==reserved (
                                                                                                    set /A "hdrct=1"
                                                                                                @REM echo hdrtr = !hdrtr!
                                                                                                )                    
                                                                            ) 
                                                                if !x1!==8 ( 
                                                                            echo Color Primaries "%%a" = %%b  
                                                                            set "colorpr=%%b"
                                                                            @REM echo colorpr = !colorpr!
                                                                            if !colorpr!==bt2020 (
                                                                                                    set /A "hdrcp=1"
                                                                                                @REM echo hdrcp = !hdrcp!
                                                                                                )
                                                                            if !colorpr!==unknown (
                                                                                                    set /A "hdrcp=1"
                                                                                                @REM echo hdrcp = !hdrcp!
                                                                                                )
                                                                            if !colorpr!==reserved (
                                                                                                    set /A "hdrcp=1"
                                                                                                @REM echo hdrcp = !hdrcp!
                                                                                                )                
                                                                            )    

                                                                set /A x1+=1                                                            
)

rem pause

echo.

if !x1!==1 goto :novideofileInserimentoFFmpegCodificaSoftwareH265

@REM echo.
@REM echo hdrcs = !hdrcs!
@REM echo hdrtr = !hdrtr!
@REM echo hdrcp = !hdrcp!
@REM echo fv = !fv!

if !hdrcs!==1 if !hdrtr!==1 if !hdrcp!==1 if !fv!==1 ( 
    @REM echo.
    @REM echo hdrcs = !hdrcs!
    @REM echo hdrtr = !hdrtr!
    @REM echo hdrcp = !hdrcp!
    @REM echo fv = !fv!
    goto letturaMetadatiHDR10InserimentoFFmpegCodificaSoftwareH265

) 
set "masterdisplaysettings=nessuno"
goto fineletturaMetadatiHDR10InserimentoFFmpegCodificaSoftwareH265


rem/////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////

:letturaMetadatiHDR10InserimentoFFmpegCodificaSoftwareH265
.\bin\ffprobe -loglevel panic -select_streams 0 -show_frames -read_intervals %%+#1 -show_entries frame=side_data_list -of default=noprint_wrappers=1 %NomeFile% > ".\temp\Temp_HDR10.txt"


set /A x2=1
set /A dvp=0
set /A hdr10pp=0

set redx=
set redy=
set greenx=
set greeyx=
set bx=
set by=
set wpx=
set wpy=
set minl=
set maxl=
set maxc=
set maxa=
set /A maxcpresent=0
set /A maxapresent=0


findstr /c:"Mastering display metadata" .\temp\Temp_HDR10.txt > .\temp\Temp_HDR10_Finale.txt
findstr /c:"red_x" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"red_y" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"green_x" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"green_y" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"blue_x" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"blue_y" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"white_point_x" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"white_point_y" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"min_luminance" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"max_luminance" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"Content light level metadata" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"max_content" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"max_average" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt

findstr /c:"HDR Dynamic Metadata SMPTE2094-40 (HDR10+)" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"Dolby Vision Metadata" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt

rem elimina le prime righe che corrispondono alle stringhe tra le virgolette"
rem findstr /V "TAG:timecode=" .\temp\Temp_HDR10.txt > Temp_HDR10p.txt
rem findstr /V "side_data_type=H.26[45] User Data Unregistered SEI message" Temp_HDR10p.txt > Temp_HDR10f.txt

rem del ".\temp\Temp_HDR10.txt"


for /f "tokens=1,2 delims==,/" %%a in (.\temp\Temp_HDR10_Finale.txt) do ( 
                                                            if !x2!==1 (
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=Dolby Vision Metadata"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==1 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        goto solodvFFmpegSempliceCodifica
                                                                                                        )
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=HDR Dynamic Metadata SMPTE2094-40 (HDR10+)"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==1 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        goto solohdr10plusFFmpegSempliceCodifica
                                                                                                        )

                                                                        echo %%b
                                                                        echo.
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==2 ( 
                                                                        echo %%a = %%b  
                                                                        set "redx=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==3 ( 
                                                                        echo %%a = %%b  
                                                                        set "redy=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==4 ( 
                                                                        echo %%a = %%b  
                                                                        set "greenx=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==5 ( 
                                                                        echo %%a = %%b  
                                                                        set "greeny=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==6 ( 
                                                                        echo %%a = %%b  
                                                                        set "bx=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==7 ( 
                                                                        echo %%a = %%b  
                                                                        set "by=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==8 ( 
                                                                        echo %%a = %%b  
                                                                        set "wpx=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==9 ( 
                                                                        echo %%a = %%b  
                                                                        set "wpy=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==10 ( 
                                                                        echo %%a = %%b  
                                                                        set "minl=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==11 ( 
                                                                        echo %%a = %%b  
                                                                        set "maxl=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==12 (
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=Dolby Vision Metadata"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==12 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        set /a dvp=1
                                                                                                        ) 
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=HDR Dynamic Metadata SMPTE2094-40 (HDR10+)"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==12 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        set /a hdr10pp=1
                                                                                                        )
                                                                        if !dvp!==1 ( 
                                                                                    echo.
                                                                                    echo !t75!
                                                                                    )
                                                                        if !hdr10pp!==1 ( 
                                                                                        echo.
                                                                                        echo !t76!
                                                                                        )
                                                                        
                                                                        if !dvp!==0 if !hdr10pp!==0 (
                                                                                                echo.
                                                                                                echo %%b
                                                                                                echo.
                                                                                                rem echo !x2!
                                                                                                )
                                                                        
                                                                        )
                                                            if !x2!==13 (
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=Dolby Vision Metadata"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==13 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        set /a dvp=1
                                                                                                        ) 
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=HDR Dynamic Metadata SMPTE2094-40 (HDR10+)"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==13 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        set /a hdr10pp=1
                                                                                                        )
                                                                        if !dvp!==1 ( 
                                                                                    echo.
                                                                                    echo !t75!
                                                                                    )
                                                                        if !hdr10pp!==1 ( 
                                                                                        echo.
                                                                                        echo !t76!
                                                                                        )
                                                                        
                                                                        if !dvp!==0 if !hdr10pp!==0 ( 
                                                                                                echo %%a = %%b  
                                                                                                set "maxc=%%b"
                                                                                                set "maxcpresent=1"
                                                                                                rem echo !x2!
                                                                                                )
                                                                        )
                                                            if !x2!==14 ( 
                                                                        echo %%a = %%b  
                                                                        set "maxa=%%b"
                                                                        set "maxapresent=1"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==15 (
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=Dolby Vision Metadata"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==15 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        set /a dvp=1
                                                                                                        ) 
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=HDR Dynamic Metadata SMPTE2094-40 (HDR10+)"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==15 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        set /a hdr10pp=1
                                                                                                        )
                                                                        if !dvp!==1 ( 
                                                                                    echo.
                                                                                    echo !t75!
                                                                                    )
                                                                        if !hdr10pp!==1 ( 
                                                                                        echo.
                                                                                        echo !t76!
                                                                                        )
                                                                        )
                                                            if !x2!==16 (
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=Dolby Vision Metadata"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==16 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        set /a dvp=1
                                                                                                        ) 
                                                                        if !dvp!==1 ( 
                                                                                    echo.
                                                                                    echo !t75!
                                                                                    )
                                                                        )
                                                            set /A x2+=1
)

rem echo maxapresent = %maxapresent%
rem echo maxcpresent = %maxcpresent%


if %maxapresent%==1 if %maxcpresent%==1 (
                                        echo.
                                        echo !t77!
                                        echo master-display=G^(!greenx!,!greeny!^)B^(!bx!,!by!^)R^(!redx!,!redy!^)WP^(!wpx!,!wpy!^)L^(!maxl!,!minl!^):max-cll=!maxc!,!maxa!
                                        set "masterdisplaysettings=G^(!greenx!,!greeny!^)B^(!bx!,!by!^)R^(!redx!,!redy!^)WP^(!wpx!,!wpy!^)L^(!maxl!,!minl!^):max-cll=!maxc!,!maxa!"
                                        @REM echo masterdisplaysettings = !masterdisplaysettings!
                                        echo.
                                        )

if %maxapresent%==0 if %maxcpresent%==0 (
                                        echo.
                                        echo !t77!
                                        echo master-display=G^(!greenx!,!greeny!^)B^(!bx!,!by!^)R^(!redx!,!redy!^)WP^(!wpx!,!wpy!^)L^(!maxl!,!minl!^)
                                        set "masterdisplaysettings=G^(!greenx!,!greeny!^)B^(!bx!,!by!^)R^(!redx!,!redy!^)WP^(!wpx!,!wpy!^)L^(!maxl!,!minl!^)"
                                        @REM echo masterdisplaysettings = !masterdisplaysettings!
                                        echo.
                                        )                                                                       

:fineLetturaMetadatiHDR10InserimentoFFmpegCodificaSoftwareH265


rem/////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////


:rilevazionebandenereInserimentoFFmpegCodificaSoftwareH265

.\bin\ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 %NomeFile%  > ".\temp\durata_film.txt"


set /a contatore=1
for /f "tokens=1 delims=." %%a in (.\temp\durata_film.txt) do  (
                                                        echo. 
                                                        echo !t7! %%a
                                                        set /a "secondi=%%a"
                                                        set /a "minuti=!secondi!/60"
                                                        echo !t8! !minuti!
                                                        set /a "intervallo_tagli=!secondi!/11"
                                                        echo !t9! !intervallo_tagli!!t10!
                                                        echo.
                                                        echo !t11!
                                                        echo.

                                                        

                                                        FOR /L %%a IN (1, 1, 10) DO (
                                                                                    rem echo %%a
                                                                                    set /a "secondi=%%a*!intervallo_tagli!"
                                                                                    rem echo !secondi!

                                                                                    if !formatvideo!==yuv420p (
                                                                                                                set /a "ca=16"
                                                                                                                rem echo !ca!
                                                                                                                    
                                                                                                                set /a "cb=2"
                                                                                                                rem echo !cb!
                                                                                                                    
                                                                                                                set /a "cc=0"
                                                                                                                rem echo !cc!

                                                                                                                set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                                                rem echo !cr!
                                                                                                                )

                                                                                    if !formatvideo!==yuv420p10le  ( 
                                                                                                                    set /a "ca=72"
                                                                                                                    rem echo !ca!
                                                                                                                    
                                                                                                                    set /a "cb=2"
                                                                                                                    rem echo !cb!
                                                                                                                    
                                                                                                                    set /a "cc=0"
                                                                                                                    rem echo !cc!

                                                                                                                    set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                                                    rem echo !cr!
                                                                                                                    )                                                                                                                

                                    
                                                                                
                                                                                
                                                                                    .\bin\ffmpeg -ss !secondi! -hide_banner -nostats -i %NomeFile% -vframes 10 -vf !cr! -f null - 2> ".\temp\crop.txt"
                                                                                    
                                                                                    findstr /r "Parsed_cropdetect_0" .\temp\crop.txt >> .\temp\risultato_multiplo.txt   
                                                                                    
                                                                                    echo !t12! %%a !t13! !secondi! !t14!
                                                                                    
                                                                                    )       
                                                                                       

                                                                                    for /f "tokens=1,2 delims==" %%a in (.\temp\risultato_multiplo.txt) do ( echo %%b >> .\temp\crop_multiplo.txt )
                                                                                    
                                                                                    set /a "maxfrequenza=0"

                                                                                    for /f "delims=" %%a in (.\temp\crop_multiplo.txt) do ( 
                                                                                                                                    set "cropconfront=%%a"
                                                                                                                                    rem echo "!cropconfront!"
                                                                                                                                    
                                                                                                                                    set /a "contatorfrequenza=0"
                                                                                                                                    for /f "delims=" %%b in (.\temp\crop_multiplo.txt) do (
                                                                                                                                                                                    set "dato_da_verificare=%%b"
                                                                                                                                                                                    rem echo cropconfront = "!cropconfront!"
                                                                                                                                                                                    rem echo dato_da_verificare = "!dato_da_verificare!"
                                                                                                                                                                                    if !cropconfront!==!dato_da_verificare! ( set /a "contatorfrequenza+=1")
                                                                                                                                                                                    )
                                                                                                                                    if !maxfrequenza! LSS !contatorfrequenza! ( 
                                                                                                                                                                                set /a "maxfrequenza=!!contatorfrequenza!!"
                                                                                                                                                                                set "cropd=!cropconfront!"
                                                                                                                                                                                )
                                                                                                                                    

                                                                                                                                    rem if !cropconfront! in (elenco_crop_frequenza.txt) ()
                                                                                                                                    rem echo !cropconfront!:!contatorfrequenza! >> elenco_crop_frequenza.txt

                                                                                                                                    )

                                                                                    rem echo crop piu' frequente = !cropd! con grequenza = !maxfrequenza!
                                                                                    echo !cropd! > .\temp\crop_finale.txt

                                                                                    for /f "tokens=1,2,3,4 delims=:" %%a in (.\temp\crop_finale.txt) do  ( 
                                                                                                                                                    rem set /a "mwidth=%%a"
                                                                                                                                                    rem echo mwidth = !mwidth!

                                                                                                                                                    rem set /a "mheight=%%b"
                                                                                                                                                    rem echo mheight = !mheight!

                                                                                                                                                    rem set /a "mx=%%c"
                                                                                                                                                    rem echo mx = !mx!

                                                                                                                                                    rem set /a "my=%%d"
                                                                                                                                                    rem echo my = !my!

                                                                                                                                                    if !contatore!==1 ( 
                                                                                                                                                                set /a "wmax=%%a" 
                                                                                                                                                                set /a "hmax=%%b"
                                                                                                                                                                set /a "xmin=%%c"
                                                                                                                                                                set /a "ymin=%%d"
                                                                                                                                                                set /a "mwidth=%%a"
                                                                                                                                                                set /a "mheight=%%b"
                                                                                                                                                                set /a "mx=%%c"
                                                                                                                                                                set /a "my=%%d"
                                                                                                                                                                set /a "contatore+=1"
                                                                                                                                                                )
                                                                                                                                                    
                                                                                                                                                    rem if %%b gtr !hmax! if %%c gtr !xmin! if %%d gtr !ymin! 

                                                                                                                                                    if %%a geq !wmax! if %%b geq !hmax! ( 
                                                                                                                                                                        set /a "wmax=%%a" 
                                                                                                                                                                        set /a "hmax=%%b"
                                                                                                                                                                        set /a "xmin=%%c"
                                                                                                                                                                        set /a "ymin=%%d"
                                                                                                                                                                        set /a "mwidth=%%a"
                                                                                                                                                                        set /a "mheight=%%b"
                                                                                                                                                                        set /a "mx=%%c"
                                                                                                                                                                        set /a "my=%%d"
                                                                                                                                                                        )
                                                                                                                                                    )
                                                                                    echo.
                                                                                    
                                                                                    set /a "mwidth=!mwidth!/2*2"
                                                                                    set /a "mheight=!mheight!/2*2"

                                                                                    set /a "csup=!my!/2*2"
                                                                                    rem echo csup = !csup!
                                                                                                                                    
                                                                                    set /a "csin=!mx!/2*2"
                                                                                    rem echo csin = !csin!

                                                                                    set /a "cinf=(!heightvideo!-!mheight!-!my!)/2*2"
                                                                                    rem echo movieheightreal = !movieheightreal!
                                                                                    rem echo cinf = !cinf!
                                                                                    set /a "cdes=(!widthvideo!-!mwidth!-!mx!)/2*2"
                                                                                    rem echo cdes = !cdes!

                                                                                    echo FFmpeg Crop Settings: crop=!mwidth!:!mheight!:!csin!:!csup!    
                                                                                    set "cropff=crop=!mwidth!:!mheight!:!csin!:!csup!"
                                                                                    @REM echo cropff = !cropff!
                                                                                    echo.  
                                                                                    
                                                                                    echo !t17!  !mwidth! 
                                                                                    echo !t18!  !mheight! 
                                                                                    echo.
                  
                                                        )                          
                                                  

:cropmanuale1080pInserimentoFFmpegCodificaSoftwareH265
set /a "csup=0"
set /a "cinf=0"
set /a "csin=0"
set /a "cdes=0"
set /a "bandasuperiore=0"
set /a "bandainferiore=0"
set /a "bandasinistra=0"
set /a "bandadestra=0"
set /a "differenzialelarghezza1080pnvenc=0"
set /a "differenzialealtezza1080pnvenc=0"
if exist ".\temp\Temp_HDR10.txt" ( del ".\temp\Temp_HDR10.txt" )
if exist ".\temp\Temp_HDR10_Finale.txt" ( del ".\temp\Temp_HDR10_Finale.txt" )
if exist ".\temp\Temp_HDR10_Stream.txt" ( del ".\temp\Temp_HDR10_Stream.txt" ) 
if exist ".\temp\durata_film.txt" ( del ".\temp\durata_film.txt" )
if exist ".\temp\crop.txt" ( del ".\temp\crop.txt" )
if exist ".\temp\risultato_multiplo.txt" ( del ".\temp\risultato_multiplo.txt" )
if exist ".\temp\crop_multiplo.txt" ( del ".\temp\crop_multiplo.txt" )
if exist ".\temp\crop_finale.txt" ( del ".\temp\crop_finale.txt" )

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t22!"   
    if errorlevel 2 goto cropmanualeInserimentoFFmpegCodificaSoftwareH265
    if errorlevel 1 goto finecropInserimentoFFmpegCodificaSoftwareH265
)

CHOICE /N /C:SN /M "!t22!"   

if errorlevel 2 goto cropmanualeInserimentoFFmpegCodificaSoftwareH265
if errorlevel 1 goto finecropInserimentoFFmpegCodificaSoftwareH265

:cropmanualeInserimentoFFmpegCodificaSoftwareH265
echo.
echo !t23!
echo.

:banda_superiore_valoreInserimentoFFmpegCodificaSoftwareH265
set /p "bandasuperiore=!t24!"
SET "var="&for /f "delims=0123456789" %%i in ("!bandasuperiore!") do set var=!bandasuperiore!
if defined var (
                echo.
                echo !t25!
                echo.
                goto banda_superiore_valoreInserimentoFFmpegCodificaSoftwareH265
                ) else (
                        set /a "csup=!bandasuperiore!/2*2"
                        )

echo.
:banda_inferiore_valoreInserimentoFFmpegCodificaSoftwareH265
set /p "bandainferiore=!t26!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandainferiore!") do set var=!bandainferiore!
if defined var (
                echo.
                echo !t27!
                echo.
                goto banda_inferiore_valoreInserimentoFFmpegCodificaSoftwareH265
                ) else (
                        set /a "cinf=!bandainferiore!/2*2"
                        )


echo.
:banda_sinistra_valoreInserimentoFFmpegCodificaSoftwareH265
set /p "bandasinistra=!t28!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandasinistra!") do set var=!bandasinistra!
if defined var (
                echo.
                echo !t29!
                echo.
                goto banda_sinistra_valoreInserimentoFFmpegCodificaSoftwareH265
                ) else (
                        set /a "csin=!bandasinistra!/2*2"
                        )

                        
echo.
:banda_destra_valoreInserimentoFFmpegCodificaSoftwareH265
set /p "bandadestra=!t30!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandadestra!") do set var=!bandadestra!
if defined var (
                echo.
                echo !t31!
                echo.
                goto banda_destra_valoreInserimentoFFmpegCodificaSoftwareH265
                ) else (
                        set /a "cdes=!bandadestra!/2*2"
                        )
                                   

set /a "mwidths=!widthvideo!/2*2"
set /a "mheights=!heightvideo!/2*2"
@REM echo nuovo mwidhts = !mwidths!
@REM echo nuovo mheights = !mheights!

set /a "mwidth=!mwidths!-!csin!-!cdes!"
set /a "mheight=!mheights!-!csup!-!cinf!"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!


echo.
echo !t32!  !csup! 
echo !t33!  !cinf! 
echo !t34!  !csin! 
echo !t35!  !cdes! 
echo.


echo FFmpeg Crop Settings: crop=!mwidth!:!mheight!:!csin!:!csup!    
set "cropff=crop=!mwidthc!:!mheightc!:!csin!:!csup!"
@REM echo cropff = !cropff!
echo.  

echo !t17!  !mwidth! 
echo !t18!  !mheight! 
echo.



goto cropmanuale1080pInserimentoFFmpegCodificaSoftwareH265

:finecropInserimentoFFmpegCodificaSoftwareH265

echo.


rem////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////


rem tipo codifica
echo.
echo !t40!
echo.
echo 1) CRF 
echo 2) VBR 
echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto CodificaVBRInserimentoFFmpegCodificaSoftwareH265
if errorlevel 1 goto CodificaCRFInserimentoFFmpegCodificaSoftwareH265

:CodificaVBRInserimentoFFmpegCodificaSoftwareH265
set "TipoCodificaFFmpeg=-b:v "
set /a "Valorecrf_FFmpeg=0"
goto inserimentoValoriCRFInserimentoFFmpegCodificaSoftwareH265

:CodificaCRFInserimentoFFmpegCodificaSoftwareH265
set "TipoCodificaFFmpeg=-crf:v "
set /a "Valorecrf_FFmpeg=1"

:inserimentoValoriCRFInserimentoFFmpegCodificaSoftwareH265

if !Valorecrf_FFmpeg!==1 (
                                echo.
                                set /p "valoreCRFFFmpeg=!t78! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreCRFFFmpeg!") do set var=!valoreCRFFFmpeg!
                                if defined var (
                                                echo.
                                                echo !t79!
                                                echo.
                                                goto inserimentoValoriCRFInserimentoFFmpegCodificaSoftwareH265
                                                ) 

                                set /a "valoreCRFFFmpeg=!valoreCRFFFmpeg!"
                                @REM echo valoreQuantizzazione = !valoreCRFFFmpeg!
                                if !valoreCRFFFmpeg! GEQ 10 if !valoreCRFFFmpeg! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t80! !valoreCRFFFmpeg!
                                                                                                                set "tipoQuantizzazioneFFmpeg=!TipoCodificaFFmpeg!!valoreCRFFFmpeg!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneFFmpeg!
                                                                                                                goto fineQuantizzazioneInserimentoFFmpegCodificaSoftwareH265
                                                                                                                ) 
                                echo.
                                echo !t81!
                                goto inserimentoValoriCRFInserimentoFFmpegCodificaSoftwareH265
                                                                                                                        
                                )



if !Valorecrf_FFmpeg!==0 (
                                echo.
                                set /p "valoreBitRateFFmpeg=!t46! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateFFmpeg!") do set var=!valoreBitRateFFmpeg!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                echo.
                                                goto inserimentoValoriCRFInserimentoFFmpegCodificaSoftwareH265
                                                ) 
                                set /a "valoreBitRateFFmpeg=!valoreBitRateFFmpeg!"
                                @REM echo valoreBitRateFFmpeg = !valoreBitRateFFmpeg!
                                if !valoreBitRateFFmpeg! GEQ 100 if !valoreBitRateFFmpeg! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateFFmpeg!
                                                                                                        set "tipoQuantizzazioneFFmpeg=!TipoCodificaFFmpeg!!valoreBitRateFFmpeg!k"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneFFmpeg!
                                                                                                        goto fineQuantizzazioneInserimentoFFmpegCodificaSoftwareH265
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCRFInserimentoFFmpegCodificaSoftwareH265
                                                                                                              
                                )


:fineQuantizzazioneInserimentoFFmpegCodificaSoftwareH265


rem////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////



rem velocit codifica
echo.
echo !t82!
echo.
echo 1) Ultrafast !t83!
echo 2) Superfast 
echo 3) Veryfast 
echo 4) Faster 
echo 5) Fast 
echo 6) Medium !t84!
echo 7) Slow 
echo 8) Slower 
echo 9) Veryslow 
echo 0) Placebo !t85!
echo.
CHOICE /N /C:1234567890 /M "!t86!"

if errorlevel 10 goto PlaceboInserimentoFFmpegCodificaSoftwareH265
if errorlevel 9 goto VeryslowInserimentoFFmpegCodificaSoftwareH265
if errorlevel 8 goto SlowerInserimentoFFmpegCodificaSoftwareH265
if errorlevel 7 goto SlowInserimentoFFmpegCodificaSoftwareH265
if errorlevel 6 goto MediumInserimentoFFmpegCodificaSoftwareH265
if errorlevel 5 goto FastInserimentoFFmpegCodificaSoftwareH265
if errorlevel 4 goto FasterFFmpegSempliceCodifica
if errorlevel 3 goto VeryfastInserimentoFFmpegCodificaSoftwareH265
if errorlevel 2 goto SuperfastInserimentoFFmpegCodificaSoftwareH265
if errorlevel 1 goto UltrafastInserimentoFFmpegCodificaSoftwareH265


:PlaceboInserimentoFFmpegCodificaSoftwareH265
set "SettaggioQualitaFFmpeg=-preset:v placebo"
set "QualitySetting=Placebo"
goto fineQualitCodificaInserimentoFFmpegCodificaSoftwareH265

:VeryslowInserimentoFFmpegCodificaSoftwareH265
set "SettaggioQualitaFFmpeg=-preset:v veryslow"
set "QualitySetting=Veryslow"
goto fineQualitCodificaInserimentoFFmpegCodificaSoftwareH265

:SlowerInserimentoFFmpegCodificaSoftwareH265
set "SettaggioQualitaFFmpeg=-preset:v slower"
set "QualitySetting=Slower"
goto fineQualitCodificaInserimentoFFmpegCodificaSoftwareH265

:SlowInserimentoFFmpegCodificaSoftwareH265
set "SettaggioQualitaFFmpeg=-preset:v slow"
set "QualitySetting=Slow"
goto fineQualitCodificaInserimentoFFmpegCodificaSoftwareH265

:MediumInserimentoFFmpegCodificaSoftwareH265
set "SettaggioQualitaFFmpeg=-preset:v medium"
set "QualitySetting=Medium"
goto fineQualitCodificaInserimentoFFmpegCodificaSoftwareH265

:FastInserimentoFFmpegCodificaSoftwareH265
set "SettaggioQualitaFFmpeg=-preset:v fast"
set "QualitySetting=Fast"
goto fineQualitCodificaInserimentoFFmpegCodificaSoftwareH265

:FasterFFmpegSempliceCodifica
set "SettaggioQualitaFFmpeg=-preset:v faster"
set "QualitySetting=Faster"
goto fineQualitCodificaInserimentoFFmpegCodificaSoftwareH265

:VeryfastInserimentoFFmpegCodificaSoftwareH265
set "SettaggioQualitaFFmpeg=-preset:v veryfast"
set "QualitySetting=Veryfast"
goto fineQualitCodificaInserimentoFFmpegCodificaSoftwareH265

:SuperfastInserimentoFFmpegCodificaSoftwareH265
set "SettaggioQualitaFFmpeg=-preset:v superfast"
set "QualitySetting=Superfast"
goto fineQualitCodificaInserimentoFFmpegCodificaSoftwareH265

:UltrafastInserimentoFFmpegCodificaSoftwareH265
set "SettaggioQualitaFFmpeg=-preset:v ultrafast"
set "QualitySetting=Ultrafast"
goto fineQualitCodificaInserimentoFFmpegCodificaSoftwareH265


:fineQualitCodificaInserimentoFFmpegCodificaSoftwareH265
echo.
echo !t87! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaFFmpeg!


rem////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////


rem quantizzazione adattiva
echo.
echo !t88!
echo.
echo !t89!
echo !t90!
echo !t91!
echo !t92!
echo !t93!
echo.
CHOICE /N /C:12345 /M "!t94!"

if errorlevel 5 goto EdgeInserimentoFFmpegCodificaSoftwareH265
if errorlevel 4 goto DarkBiasInserimentoFFmpegCodificaSoftwareH265
if errorlevel 3 goto AutoVarianceInserimentoFFmpegCodificaSoftwareH265
if errorlevel 2 goto AbilitataInserimentoFFmpegCodificaSoftwareH265
if errorlevel 1 goto DisabilitatInserimentoFFmpegCodificaSoftwareH265

:EdgeInserimentoFFmpegCodificaSoftwareH265
set "ValoreQuantizzazioneAdattiva=aq-mode=4"
set "TipoQuantizzazioneAdattiva_FFmpeg=!t108!"
goto QuantizzazioneSelezionataInserimentoFFmpegCodificaSoftwareH265

:DarkBiasInserimentoFFmpegCodificaSoftwareH265
set "ValoreQuantizzazioneAdattiva=aq-mode=3"
set "TipoQuantizzazioneAdattiva_FFmpeg=!t109!"
goto QuantizzazioneSelezionataInserimentoFFmpegCodificaSoftwareH265

:AutoVarianceInserimentoFFmpegCodificaSoftwareH265
set "ValoreQuantizzazioneAdattiva=aq-mode=2"
set "TipoQuantizzazioneAdattiva_FFmpeg=!t110!"
goto QuantizzazioneSelezionataInserimentoFFmpegCodificaSoftwareH265

:AbilitataInserimentoFFmpegCodificaSoftwareH265
set "ValoreQuantizzazioneAdattiva=aq-mode=1"
set "TipoQuantizzazioneAdattiva_FFmpeg=!t111!"
goto QuantizzazioneSelezionataInserimentoFFmpegCodificaSoftwareH265

:DisabilitatInserimentoFFmpegCodificaSoftwareH265
set "ValoreQuantizzazioneAdattiva=aq-mode=0"
set "TipoQuantizzazioneAdattiva_FFmpeg=!t112!"
goto QuantizzazioneSelezionataInserimentoFFmpegCodificaSoftwareH265

:QuantizzazioneSelezionataInserimentoFFmpegCodificaSoftwareH265

echo.
echo !t95! !TipoQuantizzazioneAdattiva_FFmpeg!
echo.
echo !t43! !ValoreQuantizzazioneAdattiva!




rem////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////

if !TipoQuantizzazioneAdattiva_FFmpeg!==Disabilitata (
    set "SettaggioFozaQAFFmpeg=aq-strength=1.0"
    goto fineForzaQuantizzazioneAdattivaInserimentoFFmpegCodificaSoftwareH265Disabilitata
)



rem forza quantizzazione
echo.
echo !t96!
echo.
echo 1) 0.1 !t97!
echo 2) 0.2 
echo 3) 0.3 
echo 4) 0.4 
echo 5) 0.5 
echo 6) 0.6 
echo 7) 0.7 
echo 8) 0.8 
echo 9) 0.9 
echo 0) 1.0 !t98!
echo.
CHOICE /N /C:1234567890 /M "!t86!"

if errorlevel 10 goto Forza10InserimentoFFmpegCodificaSoftwareH265
if errorlevel 9 goto Forza9InserimentoFFmpegCodificaSoftwareH265
if errorlevel 8 goto Forza8InserimentoFFmpegCodificaSoftwareH265
if errorlevel 7 goto Forza7InserimentoFFmpegCodificaSoftwareH265
if errorlevel 6 goto Forza6InserimentoFFmpegCodificaSoftwareH265
if errorlevel 5 goto Forza5InserimentoFFmpegCodificaSoftwareH265
if errorlevel 4 goto Forza4InserimentoFFmpegCodificaSoftwareH265
if errorlevel 3 goto Forza3InserimentoFFmpegCodificaSoftwareH265
if errorlevel 2 goto Forza2InserimentoFFmpegCodificaSoftwareH265
if errorlevel 1 goto Forza1InserimentoFFmpegCodificaSoftwareH265


:Forza10InserimentoFFmpegCodificaSoftwareH265
set "SettaggioFozaQAFFmpeg=aq-strength=1.0"
set "SettingoFozaQAFFmpeg=1.0"
goto fineForzaQuantizzazioneAdattivaInserimentoFFmpegCodificaSoftwareH265

:Forza9InserimentoFFmpegCodificaSoftwareH265
set "SettaggioFozaQAFFmpeg=aq-strength=0.9"
set "SettingoFozaQAFFmpeg=0.9"
goto fineForzaQuantizzazioneAdattivaInserimentoFFmpegCodificaSoftwareH265

:Forza8InserimentoFFmpegCodificaSoftwareH265
set "SettaggioFozaQAFFmpeg=aq-strength=0.8"
set "SettingoFozaQAFFmpeg=0.7"
goto fineForzaQuantizzazioneAdattivaInserimentoFFmpegCodificaSoftwareH265

:Forza7InserimentoFFmpegCodificaSoftwareH265
set "SettaggioFozaQAFFmpeg=aq-strength=0.7"
set "SettingoFozaQAFFmpeg=0.7"
goto fineForzaQuantizzazioneAdattivaInserimentoFFmpegCodificaSoftwareH265

:Forza6InserimentoFFmpegCodificaSoftwareH265
set "SettaggioFozaQAFFmpeg=aq-strength=0.6"
set "SettingoFozaQAFFmpeg=0.6"
goto fineForzaQuantizzazioneAdattivaInserimentoFFmpegCodificaSoftwareH265

:Forza5InserimentoFFmpegCodificaSoftwareH265
set "SettaggioFozaQAFFmpeg=aq-strength=0.5"
set "SettingoFozaQAFFmpeg=0.5"
goto fineForzaQuantizzazioneAdattivaInserimentoFFmpegCodificaSoftwareH265

:Forza4InserimentoFFmpegCodificaSoftwareH265
set "SettaggioFozaQAFFmpeg=aq-strength=0.4"
set "SettingoFozaQAFFmpeg=0.4"
goto fineForzaQuantizzazioneAdattivaInserimentoFFmpegCodificaSoftwareH265

:Forza3InserimentoFFmpegCodificaSoftwareH265
set "SettaggioFozaQAFFmpeg=aq-strength=0.3"
set "SettingoFozaQAFFmpeg=0.3"
goto fineForzaQuantizzazioneAdattivaInserimentoFFmpegCodificaSoftwareH265

:Forza2InserimentoFFmpegCodificaSoftwareH265
set "SettaggioFozaQAFFmpeg=aq-strength=0.2"
set "SettingoFozaQAFFmpeg=0.2"
goto fineForzaQuantizzazioneAdattivaInserimentoFFmpegCodificaSoftwareH265

:Forza1InserimentoFFmpegCodificaSoftwareH265
set "SettaggioFozaQAFFmpeg=aq-strength=0.1"
set "SettingoFozaQAFFmpeg=0.1"
goto fineForzaQuantizzazioneAdattivaInserimentoFFmpegCodificaSoftwareH265


:fineForzaQuantizzazioneAdattivaInserimentoFFmpegCodificaSoftwareH265
echo.
echo !t99! !SettingoFozaQAFFmpeg!
echo.
echo !t43! !SettaggioFozaQAFFmpeg!

:fineForzaQuantizzazioneAdattivaInserimentoFFmpegCodificaSoftwareH265Disabilitata



rem////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////

rem denoiser
set "DenoiserFinalSettings="
echo.
echo !t100!
echo.
echo !t101!
echo 2) Atadenoise 
echo 3) Nlmeans 
echo 4) Vaguedenoiser 
echo 5) Hqdn3d 
echo.
CHOICE /N /C:12345 /M "!t94!"

if errorlevel 5 goto Hqdn3dInserimentoFFmpegCodificaSoftwareH265
if errorlevel 4 goto VagueDenoiserInserimentoFFmpegCodificaSoftwareH265
if errorlevel 3 goto NlmeansDenoiserInserimentoFFmpegCodificaSoftwareH265
if errorlevel 2 goto AtaDenoiserInserimentoFFmpegCodificaSoftwareH265
if errorlevel 1 goto NessunDenoiserInserimentoFFmpegCodificaSoftwareH265

:Hqdn3dInserimentoFFmpegCodificaSoftwareH265
set "DenoiserSelezionato=Hqdn3d"
set "NumeroTipoDenoiser=5"
goto FineSceltaDenoiserInserimentoFFmpegCodificaSoftwareH265

:VagueDenoiserInserimentoFFmpegCodificaSoftwareH265
set "DenoiserSelezionato=VagueDenoiser"
set "NumeroTipoDenoiser=4"
goto FineSceltaDenoiserInserimentoFFmpegCodificaSoftwareH265

:NlmeansDenoiserInserimentoFFmpegCodificaSoftwareH265
set "DenoiserSelezionato=Nlmeans"
set "NumeroTipoDenoiser=3"
goto FineSceltaDenoiserInserimentoFFmpegCodificaSoftwareH265

:AtaDenoiserInserimentoFFmpegCodificaSoftwareH265
set "DenoiserSelezionato=AtaDenoiser"
set "NumeroTipoDenoiser=2"
goto FineSceltaDenoiserInserimentoFFmpegCodificaSoftwareH265

:NessunDenoiserInserimentoFFmpegCodificaSoftwareH265
set "DenoiserSelezionato=!t113!"
set "NumeroTipoDenoiser=1"
goto FineSceltaDenoiserInserimentoFFmpegCodificaSoftwareH265

:FineSceltaDenoiserInserimentoFFmpegCodificaSoftwareH265
echo.
echo !t102! !DenoiserSelezionato!


if !NumeroTipoDenoiser!==1 (
   set "DenoiserFinalSettings=nessuno" 
   goto SalvataggioInfoFilmInserimentoFFmpegCodificaSoftwareH265
)

echo.
echo !t103!
echo.
echo !t104!
echo !t105!
echo !t106!
echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto IntensitaForteDenoiserInserimentoFFmpegCodificaSoftwareH265
if errorlevel 2 goto IntensitaMediaDenoiserInserimentoFFmpegCodificaSoftwareH265
if errorlevel 1 goto IntensitaLeggeraDenoiserInserimentoFFmpegCodificaSoftwareH265

:IntensitaForteDenoiserInserimentoFFmpegCodificaSoftwareH265
if !NumeroTipoDenoiser!==5 (
    set "denoiserSettings=hqdn3d=luma_spatial=12:chroma_spatial=6:luma_tmp=6:chroma_tmp=4"
)
if !NumeroTipoDenoiser!==4 (
    set "denoiserSettings=vaguedenoiser=threshold=6:percent=100:nsteps=12"
)
if !NumeroTipoDenoiser!==3 (
    set "denoiserSettings=nlmeans=s=20:p=33:r=15"
)
if !NumeroTipoDenoiser!==2 (
    set "denoiserSettings=atadenoise=0a=0.04:0b=0.12:1a=0.04:1b=0.12:2a=0.04:2b=0.12:s=9"
)
goto FineIntensitaDenoiseraInserimentoFFmpegCodificaSoftwareH265


:IntensitaMediaDenoiserInserimentoFFmpegCodificaSoftwareH265
if !NumeroTipoDenoiser!==5 (
    set "denoiserSettings=hqdn3d=luma_spatial=8:chroma_spatial=4:luma_tmp=6:chroma_tmp=4"
)
if !NumeroTipoDenoiser!==4 (
    set "denoiserSettings=vaguedenoiser=threshold=4:percent=100:nsteps=8"
)
if !NumeroTipoDenoiser!==3 (
    set "denoiserSettings=nlmeans=s=15:p=33:r=15"
)
if !NumeroTipoDenoiser!==2 (
    set "denoiserSettings=atadenoise=0a=0.03:0b=0.08:1a=0.03:1b=0.08:2a=0.03:2b=0.08:s=9"
)
goto FineIntensitaDenoiseraInserimentoFFmpegCodificaSoftwareH265


:IntensitaLeggeraDenoiserInserimentoFFmpegCodificaSoftwareH265
if !NumeroTipoDenoiser!==5 (
    set "denoiserSettings=hqdn3d=luma_spatial=4:chroma_spatial=2:luma_tmp=6:chroma_tmp=4"
)
if !NumeroTipoDenoiser!==4 (
    set "denoiserSettings=vaguedenoiser=threshold=2:percent=100:nsteps=4"
)
if !NumeroTipoDenoiser!==3 (
    set "denoiserSettings=nlmeans=s=10:p=33:r=15"
)
if !NumeroTipoDenoiser!==2 (
    set "denoiserSettings=atadenoise=0a=0.01:0b=0.02:1a=0.01:1b=0.02:2a=0.01:2b=0.02:s=9"
)
goto FineIntensitaDenoiseraInserimentoFFmpegCodificaSoftwareH265


:FineIntensitaDenoiseraInserimentoFFmpegCodificaSoftwareH265
echo.
set "DenoiserFinalSettings=-filter_complex ^"[0:0]!denoiserSettings![v]^" -map ^"[v]^""

:StampaParametriCodificaFFmpegSempliceCodifica
echo !t43! !DenoiserFinalSettings!


rem////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////


:SalvataggioInfoFilmInserimentoFFmpegCodificaSoftwareH265

set file_senza_virgolette=!NomeFile:"=!
@REM echo %file_senza_virgolette%
@REM echo.

set file_senza_estensione=!file_senza_virgolette:.mkv=!
@REM echo %file_senza_estensione%
@REM echo.

set fileoutput="!file_senza_estensione!_Codificato.mkv"
@REM echo fileoutput = !fileoutput!
@REM echo.


echo.
set "VideoInfoCodifica=semplice_codifica_ffmpeg|!NomeFile!|!fileoutput!|nessuno|!cropff!|!mwidth!x!mheight!|nessuna|!masterdisplaysettings!|!colorpr!|!colortr!|!colorsp!|!tipoQuantizzazioneFFmpeg!|!SettaggioQualitaFFmpeg!|!ValoreQuantizzazioneAdattiva!|!SettaggioFozaQAFFmpeg!|!DenoiserFinalSettings!|!formatvideo!|no_miglioramento_dettagli|no_color_correction|no_numero_passaggi_upscaling|no_lokahead|no_precisione_vettore_movimento"
@REM echo VideoInfoCodifica = !VideoInfoCodifica!
@REM echo.

if exist ".\saved\savedmoviesallencodings.dat" ( 
                                                echo !VideoInfoCodifica! >> .\saved\savedmoviesallencodings.dat
                                                goto finesalvataggioInserimentoFFmpegCodificaSoftwareH265
                                                ) 

echo !VideoInfoCodifica! > .\saved\savedmoviesallencodings.dat


:finesalvataggioInserimentoFFmpegCodificaSoftwareH265

echo !t60! !numeromovie! !t61!
echo.

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t62!"
    echo.
    if errorlevel 2 goto finesceltanuovovideodacodificareInserimentoFFmpegCodificaSoftwareH265
    if errorlevel 1 goto altrivideodainserireInserimentoFFmpegCodificaSoftwareH265
)

CHOICE /N /C:SN /M "!t62!"
echo.

if errorlevel 2 goto finesceltanuovovideodacodificareInserimentoFFmpegCodificaSoftwareH265
if errorlevel 1 goto altrivideodainserireInserimentoFFmpegCodificaSoftwareH265

:finesceltanuovovideodacodificareInserimentoFFmpegCodificaSoftwareH265



rem////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////



goto FineRealeInserimentoFFmpegCodificaSoftwareH265


:solohdr10plusFFmpegSempliceCodifica
echo !t107!
echo.
goto FineRealeInserimentoFFmpegCodificaSoftwareH265

:solodvFFmpegSempliceCodifica
echo !t107!
echo.
goto FineRealeInserimentoFFmpegCodificaSoftwareH265

:novideofileInserimentoFFmpegCodificaSoftwareH265
echo !t63!
echo.
goto FineRealeInserimentoFFmpegCodificaSoftwareH265



:FineRealeInserimentoFFmpegCodificaSoftwareH265



:FineInserimentoFFmpegCodificaSoftwareH265

if exist ".\temp\Temp_HDR10.txt" ( del ".\temp\Temp_HDR10.txt" )
if exist ".\temp\Temp_HDR10_Finale.txt" ( del ".\temp\Temp_HDR10_Finale.txt" )
if exist ".\temp\Temp_HDR10_Stream.txt" ( del ".\temp\Temp_HDR10_Stream.txt" ) 
if exist ".\temp\durata_film.txt" ( del ".\temp\durata_film.txt" )
if exist ".\temp\crop.txt" ( del ".\temp\crop.txt" )
if exist ".\temp\risultato_multiplo.txt" ( del ".\temp\risultato_multiplo.txt" )
if exist ".\temp\crop_multiplo.txt" ( del ".\temp\crop_multiplo.txt" )
if exist ".\temp\crop_finale.txt" ( del ".\temp\crop_finale.txt" )



set waitenter=
set /P waitenter=!t65!
Endlocal
goto InserimentoCodifcaInCodaeSalvataggioSuDisco





rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p
cls
setLocal EnableExtensions EnableDelayedExpansion



for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoInserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p
)

if %lingua%==inglese (
    goto caricalinguaingleseInserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p
)



:caricalinguaingleseInserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p
set t1=Insert Info FFmpeg Video Software Encoding 2160p and 1080p from 2160p and Saving to Disk
set t2=Drag Here the
set t2111=Video File 2160p 10 bit HDR to Encode:  

set t3=File does not exist 
set t4=Info Video:  

set t5=The Inserted Video is 2160p 8bit SDR 
set t511=The Inserted Video is 2160p 10bit SDR 

set t6=The Inserted Video isn't 2160p 8bit or 10bit SDR 
set t7=Video Duration in seconds:
set t8=Video Duration in Minutes:
set t9=Interval between Frames for Crop Detection:
set t10= seconds
set t11=Black Bands Detection Started....
set t12=Crop Detection to Frame
set t13=to seconds
set t14=Done...
set t15=Original 2160p Video Width: 
set t16=Original 2160p Video Height:

set t17=Output Video 2160p Width Without Black Bars:
set t18=Outout Video 2160p Height Without Black Bars:

set t171=Output Video 1080p Width Without Black Bars:
set t181=Outout Video 1080p Height Without Black Bars:

set t19=Adapting Video Resolution to Full 2160p Format...

set t20=Final 2160p Output Video Width:
set t21=Final 2160p Output Video Height:
set t201=Final 1080p Output Video Width:
set t211=Final 1080p Output Video Height:

set t22=Settings of Black Bands to Crop are Correct (Yes/No):
set t23=Manually Entering Black Bands Values to Crop... 
set t24=Enter the Upper Black Band Value: 
set t25=Error Entering Upper Black Band Value... It's Not a Number. 
set t26=Enter the Lower Black Band Value: 
set t27=Error Entering Lower Black Band Value... It's Not a Number.
set t28=Enter the Left Black Band Value: 
set t29=Error Entering Left Black Band Value... It's Not a Number.
set t30=Enter the Right Black Band Value: 
set t31=Error Entering Right Black Band Value... It's Not a Number.
set t32=Upper Black Band:
set t33=Lower Black Band:
set t34=Left Black Band:
set t35=Right Black Band:
set t36=2160p Original Video Width without Black Bars:
set t37=2160p Original Video Height without Black Bars:

@REM set t361=1080p Video Width without Black Bars:
@REM set t371=1080p Video Height without Black Bars

set t38=Select Graphic Card you want to Encode with:
set t39=Choose (1/2):
set t40=Select Encoding Type:
set t41=Error Entering Quantization Value... Not a Number. 
set t42=Quantization Value Set to:

set t43=Encoding Settings:
set t431=Encoding Settings

set t44=Enter Quantization value Minimum 10 Maximum 28:
set t45=Quantization Value Out of  Limits  10 / 28  Re-enter^!
set t46=Enter BitRate Value kbs Minimum 100 Maximum 50000:
set t47=Error Entering BitRate Value... It's Not a Number. 
set t48=BitRate Value Set to:
set t49=BitRate Value Out of Limits  100 / 50000  Re-enter^!
set t50=Select Encoding Quality:
set t51=- Worst Quality
set t52=- Best Quality
set t53=Choose (1/2/3/4/5/6/7):
set t54=Quality Set to:
set t55=Apply Convolution3D denoiser Yes/No: 
set t56=Apply PMD denoiser Yes/No: 
set t57=Apply Detail Enhancement Yes/No:  
set t58=Enhancement Detail: Yes 
set t59=Enhancement Detail: No 
set t60=Info
set t61=Videos to Encode Saved!
set t62=Do You Want to Insert Another Video to Encode (Yes/No):
set t63=The dragged file is not a video!
set t64=Choose (1/2/3/4):
set t65=Press Enter toback to Menu Inserting Encoding into the Queue and Saving to Disk:  

set t66=Video Width
set t67=Video Height
set t68=Video Codec
set t69=Details Video Codec
set t70=Video Format 
set t71=Configuration Settings to convert video from 8bit or 10bit SDR to 10bit HDR
set t72=Select Encoding UpGrader:
set t73=Settings UpGrader:
set t74=Choose (1/2/3):

set t75=Dolby Vision Metadata Present 
set t76=HDR10+ Metadata Present 
set t77=FFmpeg x265 Settings:  

set t78=Insert CRF Value for Video 2160p Minimum 10 Maximum 28:
set t79=Error Entering CRF value... It is not a number. 
set t80=CRF Value Set to:
set t81=CRF Value Out of Limits  10 / 28  Re-enter^!

set t82=Select Encoding Speed-Quality:
set t83=- Worst Quality - The Faster Encoding
set t84=- Recommended
set t85=- Best Quality - The Slowest Encoding
set t86=Choose (1/2/3/4/5/6/7/8/9/0):
set t87=Speed-Quality Set to:

set t88=Select Type of Adptive Quantization:
set t89=1) Disabled 
set t90=2) Enabled 
set t91=3) Enabled + Auto-Variance 
set t92=4) Enabled + Auto-Variance + Dark Bias 
set t93=5) Enabled + Auto-Variance + Edge
set t94=Choose (1/2/3/4/5):
set t95=Adaptive Quantization Set to:
set t96=Select Value of Adaptive Quantization Strength:
set t97=- Worst Quality - Smaller File
set t98=- Best Quality - Bigger File
set t99=Adaptive Quantization Strength Set to:

set t100=Select Denoiser Filter:
set t101=1) No one 
set t102=Selected Denoiser:
set t103=Select Denoiser Strength:
set t104=1) Weak 
set t105=2) Moderate 
set t106=3) Strong 

set t107=The video has no Master Display Metadata.

set t108=Enabled + Auto-Variance + Edge
set t109=Enabled + Auto-Variance + Dark Bias
set t110=Enabled + Auto-Variance
set t111=Enabled 
set t112=93mDisabled

set t113=No Denoiser

set t114=Do you want Encode Video 2160p (Yes/No):
set t115=Do you want Encode Video 1080p  (Yes/No):
set t116=Drag Here Output Empty Filer of Video 2160p:
set t117=Drag Here Output Empty Filer of Video 1080p:
set t118=Output Empty File of Video 2160p Non-existent 
set t119=Output Empty File of Video 1080p Non-existent 
set t120=You don't want any Encoding, nothing has been saved...
set t121=The source file name is the same as the empty 2160p output file.
set t122=Re-enter Empty Output File Name.
set t123=The source file name is the same as the empty 1080p output file.
set t124=The Name of Empty 2160p Video File is the same as 1080p
set t125=The Source Video is 2160p 10 bit HDR.
set t126=CRF Value for Video 2160p Set to:
set t127=CRF Value for Video 1080p Set to:
set t128=Enter BitRate Value kbs kbs for Video 2160p Minimum 100 Maximum 50000:
set t129=BitRate Value for Video 2160p Set to:
set t130=BitRate Value for Video 1080p Set to:
set t131=The Source Video is not 2160p 10 bit HDR.

goto avvio_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p



:caricalinguaitalianoInserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p
set t1=Inserimento Informazioni FFmpeg Codifica Software Video 2160p e 1080p da 2160p e Salvataggio su Disco.

set t2=Trascina Qui il 
set t2111=File Video 2160p 10 bit HDR da Codificare:  

set t3=File Inesistente 
set t4=Informazioni Video:  

set t5=Il Video inserito e' 2160p 8bit SDR 
set t511=Il Video inserito e' 2160p 10bit SDR 

set t6=Il Video inserito non e' 2160p 8bit o 10bit SDR 

set t7=Durata del Video in secondi:
set t8=Durata del video in Minuti:
set t9=Intervallo tra i Fotogrammi per il Rilevamento del crop:
set t10= secondi
set t11=Rilevamento Bande Nere Iniziato....
set t12=Rilevazione crop fotogramma
set t13=a secondi
set t14=Eseguita...
set t15=Larghezza Video 2160p Originale:
set t16=Altezza Video 2160p Originale:

set t17=Larghezza Video 2160p  Senza Barre Nere:
set t18=Altezza Video 2160p  Senza Barre Nere:

set t171=Larghezza Video 1080p  Senza Barre Nere:
set t181=Altezza Video 1080p  Senza Barre Nere:

set t19=Adattamento della Risoluzione del Video al Pieno Formato 2160p..

set t20=Larghezza Finale Video 2160p:
set t21=Altezza Finale Video 2160p:
set t201=Larghezza Finale Video 1080p:
set t211=Altezza Finale Video 1080p:

set t22=Le Impostazioni delle Bande Nere da Tagliare sono Corrette (Si/No):
set t23=Inserimento Manuale Valori Bande Nere da Tagliare.. 
set t24=Inserisci il Valore della Banda Nera Superiore: 
set t25=Errore nell'Inserimento del Valore della Banda Nera Superiore... Non e' un Numero. 
set t26=Inserisci il Valore della Banda Nera Inferiore: 
set t27=Errore nell'Inserimento del Valore della Banda Nera Inferiore... Non e' un Numero. 
set t28=Inserisci il Valore della Banda Nera Sinistra: 
set t29=Errore nell'Inserimento del Valore della Banda Nera Sinistra... Non e' un Numero. 
set t30=Inserisci il Valore della Banda Nera Destra: 
set t31=Errore nell'Inserimento del Valore della Banda Nera Destra... Non e' un Numero. 
set t32=Banda Nera Superiore:
set t33=Banda Nera Inferiore:
set t34=Banda Nera Sinistra:
set t35=Banda Nera Destra:
set t36=Larghezza Video Originale 2160p senza Bande Nere:
set t37=Altezza Video Originale 2160p senza Bande Nere:

@REM set t361=Larghezza Video 1080p senza Bande Nere:
@REM set t371=Altezza Video 1080p senza Bande Nere:

set t38=Selezionare Scheda Grafica con cui Eseguire la Codifica:
set t39=Scegli (1/2):
set t40=Selezionare tipo di Codifica:
set t41=Errore nell'Inserimento del Valore della Quantizzazione... Non e' un Numero. 
set t42=Valore Quantizzazzione Impostato a:

set t43=Parametri per codifica:
set t431=Parametri per codifica

set t44=Inserire Valore Quantizzazione Minimo 10 Massimo 28:
set t45=Valore Quantizzazzione al di fuori dei  Limiti  10 / 28  Reinserire^!
set t46=Inserire Valore BitRate kbs Minimo 100 Massimo 50000:
set t47=Errore nell'Inserimento del Valore del BitRate... Non e' un Numero. 
set t48=Valore BitRate Impostato a:
set t49=Valore  BitRate al di fuori dei  Limiti  100 / 50000  Reinserire^!

set t50=Selezionare Qualita' Codifica:
set t51=- Peggiore Qualita'
set t52=- Migliore Qualita'
set t53=Scegli (1/2/3/4/5/6/7):
set t54=Qualita' Impostata su:
set t55=Applicare il denoiser Convolution3D Si/No: 
set t56=Applicare il denoiser PMD Si/No: 
set t57=Applicare il Miglioramento Dettagli Si/No:  
set t58=Miglioramento Dettagli: Si 
set t59=Miglioramento Dettagli: No 
set t60=Informazioni
set t61=Video da Codificare Salvate!
set t62=Vuoi Inserire un altro Video da Codificare (Si/No):
set t63=Il file trascinato non e' un video!
set t64=Scegli (1/2/3/4):
set t65=Premi Invio per tornare al menu' Inserimento Codifiche in Coda e Salvataggio sul Disco:  

set t66=Larghezza Video
set t67=Altezza Video
set t68=Codec Video
set t69=Codec Video Dettagli
set t70=Format Video 
set t71=Configurazione Parametri per convertire il video da 8bit o 10bit SDR a 10bit HDR
set t72=Selezionare UpGrader Codifica:
set t73=UpGrader Impostato:
set t74=Scegli (1/2/3):

set t75=Metadati Dolby Vision Presenti 
set t76=Metadati HDR10+ Presenti  
set t77=FFmpeg Parametri x265:  

set t78=Inserire Valore CRF per Video 2160p Minimo 10 Massimo 28:
set t79=Errore nell'Inserimento del Valore del CRF... Non e' un Numero. 
set t80=Valore CRF Impostato a:
set t81=Valore CRF al di fuori dei  Limiti  10 / 28  Reinserire^!

set t82=Selezionare Velocita'-Qualita' Codifica:
set t83=- Peggiore Qualita' - Codifica Molto Veloce
set t84=- Consigliata
set t85=- Migliore Qualita' - Codifica Molto Lenta
set t86=Scegli (1/2/3/4/5/6/7/8/9/0):
set t87=Velocita'-Qualita' Impostata su:

set t88=Selezionare tipo di Quantizzazione Adattiva:
set t89=1) Disabilitata 
set t90=2) Abilitata 
set t91=3) Abilitata + Auto-Variance 
set t92=4) Abilitata + Auto-Variance + Dark Bias 
set t93=5) Abilitata + Auto-Variance + Edge
set t94=Scegli (1/2/3/4/5):
set t95=Quantizzazione Adattiva Impostata su:

set t96=Selezionare Valore Forza Quantizzazione Adattiva:
set t97=- Peggiore Qualita' - File piu' Piccolo
set t98=- Migliore Qualita' - File piu' Grande
set t99=Forza Quantizzazione Adattiva Impostata su:

set t100=Selezionare Filtro Denoiser:
set t101=1) Nessuno 
set t102=Denoiser Selezionato:
set t103=Selezionare Intensita' Denoiser:
set t104=1) Leggero 
set t105=2) Medio 
set t106=3) Forte 

set t107=Il Video non ha Metadati Master Display

set t108=Abilitata + Auto-Variance + Edge
set t109=Abilitata + Auto-Variance + Dark Bias
set t110=Abilitata + Auto-Variance
set t111=Abilitata
set t112=Disabilitata

set t113=Nessun Denoiser
set t114=Vuoi Fare la Codifica 2160p (Si/No):
set t115=Vuoi Fare la Codifica 1080p (Si/No):
set t116=Trascina Qui il File Vuoto di Output del Video 2160p:  
set t117=Trascina Qui il File Vuoto di Output del Video 1080p:  
set t118=File Vuoto di Output del Video 2160p Inesistente 
set t119=File Vuoto di Output del Video 1080p Inesistente 
set t120=Non vuoi nessuna codifica non e' stato salvato niente...
set t121=Il Nome del File Sorgente e' Uguale a quello del File Vuoto di Output 2160p
set t122=Reinserire Nome File di Output 
set t123=Il Nome del File Sorgente e' Uguale a quello del File Vuoto di Output 1080p
set t124=Il Nome del File Vuoto di Output 2160p e' Uguale a quello del 1080p
set t125=Il Video Sorgente e' 2160p 10 bit HDR
set t126=Valore CRF per Video 2160p Impostato a:
set t127=Valore CRF per Video 1080p Impostato a:
set t128=Inserire Valore BitRate kbs per Video 2160p Minimo 100 Massimo 50000:
set t129=Valore BitRate per Video 2160p Impostato a:
set t130=Valore BitRate per Video 1080p Impostato a:
set t131=Il Video Sorgente non e' 2160p 10 bit HDR

goto avvio_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p

:avvio_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p




set /a "numeromovie=0"

echo !t1!
echo.

:altrivideodainserire_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set /a "numeromovie+=1"
set "NomeFile="
rem set MetadatiStreamHDR10=

set /P NomeFile=!t2! !numeromovie! !t2111! 
echo.
rem echo Hai digitato: %NomeFile%
rem pause

set "NomeFileSorgente=!NomeFile:"=!"
@REM echo NomeFileSorgente = !NomeFileSorgente!
set "NomeFile=^"!NomeFileSorgente!^""
@REM echo NomeFile = !NomeFile!
rem pause

if exist !NomeFile! ( goto InserimentoVideoOutput2160p_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p ) else ( 
                                                        echo.
                                                        echo !t3!
                                                        echo.
                                                        goto fineRealeInserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p
                                                        )    


:InserimentoVideoOutput2160p_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p  

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t114! "   
    echo.
    if errorlevel 2 goto SceltaNoCodifica2160pInserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p
    if errorlevel 1 goto SceltaSiCodifica2160pInserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p
)

CHOICE /N /C:SN /M "!t114!"
echo.

if errorlevel 2 goto SceltaNoCodifica2160pInserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p
if errorlevel 1 goto SceltaSiCodifica2160pInserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p

:SceltaNoCodifica2160pInserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p
set /a "mr2160p=0"
set "NomeFileOutputFFmpeg=nessuno"
goto InserimentoVideoOutput1080p_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p     

:SceltaSiCodifica2160pInserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p
set /a "mr2160p=1"
set /P NomeFileOutputFFmpeg=!t116!
echo.

set "NomeFileOutputFFmpeg1=!NomeFileOutputFFmpeg:"=!"
@REM echo NomeFileOutputFFmpeg1 = !NomeFileOutputFFmpeg1!
set "NomeFileOutputFFmpeg=^"!NomeFileOutputFFmpeg1!^""
@REM echo NomeFile = !NomeFile!


if exist !NomeFileOutputFFmpeg! ( goto InserimentoVideoOutput1080p_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p ) else ( 
                                                                            echo.
                                                                            echo !t118!
                                                                            echo.
                                                                            goto fineRealeInserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p
                                                                            )    


:InserimentoVideoOutput1080p_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p   
if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t115! "   
    echo.
    if errorlevel 2 goto SceltaNoCodifica1080pInserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p
    if errorlevel 1 goto SceltaSiCodifica1080pInserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p

)            
CHOICE /N /C:SN /M "!t115!"
echo.

if errorlevel 2 goto SceltaNoCodifica1080pInserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p
if errorlevel 1 goto SceltaSiCodifica1080pInserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p

:SceltaNoCodifica1080pInserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p
set /a "mr1080p=0"
set "NomeFileOutputFFmpeg2=nessuno"
goto controlloFileInseriti_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p   

:SceltaSiCodifica1080pInserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p
set /a "mr2160p=1"
set /P NomeFileOutputFFmpeg2=!t117!
echo.

set "NomeFileOutputFFmpeg1=!NomeFileOutputFFmpeg2:"=!"
@REM echo NomeFileOutputFFmpeg1 = !NomeFileOutputFFmpeg1!
set "NomeFileOutputFFmpeg2=^"!NomeFileOutputFFmpeg1!^""
@REM echo NomeFile = !NomeFile!


if exist !NomeFileOutputFFmpeg2! ( goto controlloFileInseriti_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p ) else ( 
                                                                            echo.
                                                                            echo !t119!
                                                                            echo.
                                                                            goto fineRealeInserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p
                                                                            )    



:controlloFileInseriti_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p     


if !NomeFileOutputFFmpeg!==nessuno if !NomeFileOutputFFmpeg2!==nessuno (
                                                                        echo !t120!
                                                                        echo.
                                                                        goto fineRealeInserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p
)


if !NomeFile!==!NomeFileOutputFFmpeg! (
                                                        echo !t121!
                                                        echo !t122!
                                                        echo.
                                                        goto InserimentoVideoOutput2160p_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p  
                                                    )

if !NomeFile!==!NomeFileOutputFFmpeg2! (
                                                        echo !t123!
                                                        echo !t122!
                                                        echo.
                                                        goto InserimentoVideoOutput1080p_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p                                                       
                                                    )


if !NomeFileOutputFFmpeg!==!NomeFileOutputFFmpeg2! (
                                                        echo !t124!
                                                        echo !t122!
                                                        echo.
                                                        goto InserimentoVideoOutput2160p_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
                   
                                                    )                               



:InizioEstrazioneInfoVideo_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p

echo !t4!
echo.

.\bin\ffprobe -v error -hide_banner -select_streams v:0 -show_entries stream=width,height,codec_name,codec_long_name,pix_fmt,color_space,color_transfer,color_primaries -of default=noprint_wrappers=1 !NomeFile! > ".\temp\Temp_HDR10_Stream.txt"

set /A x1=1
set /A nohdrcs=0
set /A nohdrct=0
set /A nohdrcp=0
set /A nohdrfv=0
set /A wv=0
set /A hv=0
set /A nohdrfv=0

rem echo nohdr = %nohdr%

for /f "tokens=1,2 delims==" %%a in (.\temp\Temp_HDR10_Stream.txt) do (if !x1!==3 ( 
                                                                            echo !t66! "%%a" = %%b  
                                                                            set /A "widthvideo=%%b"
                                                                            rem echo widthvideo = !widthvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !widthvideo! LEQ 1920 if !widthvideo! GEQ 1000 (set /A "wv=1"
                                                                                                                                rem echo wv = !wv!
                                                                                                                                )
                                                                            )
                                                                if !x1!==4 ( 
                                                                            echo !t67! "%%a" = %%b  
                                                                            set /A "heightvideo=%%b"
                                                                            rem echo heightvideo = !heightvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !heightvideo! LEQ 1080 if !heightvideo! GEQ 700 (set /A "hv=1"
                                                                                                        rem echo hv = !hv!
                                                                                                        )
                                                                            )                                                           
                                                                if !x1!==6 ( 
                                                                            echo Color Space "%%a" = %%b  
                                                                            set "colorsp=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colorsp!==bt709 (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorsp!==unknown (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorsp!==reserved (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                    
                                                                            ) 
                                                                if !x1!==7 ( 
                                                                            echo Color Transfer "%%a" = %%b  
                                                                            set "colortr=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colortr!==bt709 (set /A "nohdrct=1"
                                                                                                rem echo nohdrct = !nohdrct!
                                                                                                )
                                                                            if !colortr!==unknown (set /A "nohdrct=1"
                                                                                                rem echo nohdrct = !nohdrct!
                                                                                                )
                                                                            if !colortr!==reserved (set /A "nohdrct=1"
                                                                                                rem echo nohdrct = !nohdrct!
                                                                                                )                    
                                                                            ) 
                                                                if !x1!==8 ( 
                                                                            echo Color Primaries "%%a" = %%b  
                                                                            set "colorpr=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colorpr!==bt709 (set /A "nohdrcp=1"
                                                                                                rem echo nohdrcp = !nohdrcp!
                                                                                                )
                                                                            if !colorpr!==unknown (set /A "nohdrcp=1"
                                                                                                rem echo nohdrcp = !nohdrcp!
                                                                                                )
                                                                            if !colorpr!==reserved (set /A "nohdrcp=1"
                                                                                                rem echo nohdrcp = !nohdrcp!
                                                                                                )                
                                                                            )    
                                                                if !x1!==1 ( 
                                                                            echo !t68! "%%a" = %%b  
                                                                            )       
                                                                if !x1!==2 ( 
                                                                            echo !t69! "%%a" = %%b  
                                                                            )   
                                                                if !x1!==5 ( 
                                                                            echo !t70! "%%a" = %%b  
                                                                            set "formatvideo=%%b"
                                                                            rem echo !formatvideo!
                                                                            if !formatvideo!==yuv420p (set /A "nohdrfv=1"
                                                                                                    rem echo nohdrfv = !nohdrfv!
                                                                                                    )
                                                                            )
                                                                set /A x1+=1                                                         
)
echo.

if !x1!==1 goto novideofileffmpeg_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p


@REM echo x1 = !x1!
@REM echo nohdrcs = !nohdrcs!
@REM echo nohdrct = !nohdrct!
@REM echo nohdrcp = !nohdrcp!
@REM echo wv = !wv!
@REM echo hv = !hv!
@REM echo nohdrfv = !nohdrfv!

@REM pause

if !nohdrcs!==1 if !nohdrct!==1 if !nohdrcp!==1 if !nohdrfv!==1 if !wv!==1 if !hv!==1 goto finehdrffmpeg_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p rem elimina 1080p 8bit SDR

if !nohdrcs!==1 if !nohdrct!==1 if !nohdrcp!==1 if !nohdrfv!==0 if !wv!==1 if !hv!==1 goto finehdrffmpeg_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p rem elimina 1080p 10bit SDR

if !nohdrcs!==0 if !nohdrct!==0 if !nohdrcp!==0 if !nohdrfv!==0 if !wv!==1 if !hv!==1 goto finehdrffmpeg_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p rem elimina 1080p 10bit HDR

if !nohdrcs!==1 if !nohdrct!==1 if !nohdrcp!==1 if !nohdrfv!==0 if !wv!==0 if !hv!==0 goto finehdrffmpeg_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p rem elimina 2160p 10bit SDR



echo !t125!
echo.

@REM pause

.\bin\ffprobe -loglevel panic -select_streams 0 -show_frames -read_intervals %%+#1 -show_entries frame=side_data_list -of default=noprint_wrappers=1 !NomeFile! > ".\temp\Temp_HDR10.txt"


set /A x2=1
set /A dvp=0
set /A hdr10pp=0

set redx=
set redy=
set greenx=
set greeyx=
set bx=
set by=
set wpx=
set wpy=
set minl=
set maxl=
set maxc=
set maxa=
set /A maxcpresent=0
set /A maxapresent=0


findstr /c:"Mastering display metadata" .\temp\Temp_HDR10.txt > .\temp\Temp_HDR10_Finale.txt
findstr /c:"red_x" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"red_y" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"green_x" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"green_y" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"blue_x" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"blue_y" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"white_point_x" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"white_point_y" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"min_luminance" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"max_luminance" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"Content light level metadata" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"max_content" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"max_average" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt

findstr /c:"HDR Dynamic Metadata SMPTE2094-40 (HDR10+)" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"Dolby Vision Metadata" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt

rem elimina le prime righe che corrispondono alle stringhe tra le virgolette"
rem findstr /V "TAG:timecode=" .\temp\Temp_HDR10.txt > .\temp\Temp_HDR10p.txt
rem findstr /V "side_data_type=H.26[45] User Data Unregistered SEI message" .\temp\Temp_HDR10p.txt > .\temp\Temp_HDR10f.txt

rem del "Temp_HDR10.txt"


for /f "tokens=1,2 delims==,/" %%a in (.\temp\Temp_HDR10_Finale.txt) do ( 
                                                            if !x2!==1 (
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=Dolby Vision Metadata"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==1 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        goto solodvffpmeg_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p
                                                                                                        )
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=HDR Dynamic Metadata SMPTE2094-40 (HDR10+)"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==1 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        goto solohdr10plusffpmeg_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p
                                                                                                        )

                                                                        echo %%b
                                                                        echo.
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==2 ( 
                                                                        echo %%a = %%b  
                                                                        set "redx=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==3 ( 
                                                                        echo %%a = %%b  
                                                                        set "redy=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==4 ( 
                                                                        echo %%a = %%b  
                                                                        set "greenx=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==5 ( 
                                                                        echo %%a = %%b  
                                                                        set "greeny=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==6 ( 
                                                                        echo %%a = %%b  
                                                                        set "bx=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==7 ( 
                                                                        echo %%a = %%b  
                                                                        set "by=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==8 ( 
                                                                        echo %%a = %%b  
                                                                        set "wpx=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==9 ( 
                                                                        echo %%a = %%b  
                                                                        set "wpy=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==10 ( 
                                                                        echo %%a = %%b  
                                                                        set "minl=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==11 ( 
                                                                        echo %%a = %%b  
                                                                        set "maxl=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==12 (
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=Dolby Vision Metadata"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==12 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        set /a dvp=1
                                                                                                        ) 
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=HDR Dynamic Metadata SMPTE2094-40 (HDR10+)"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==12 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        set /a hdr10pp=1
                                                                                                        )
                                                                        if !dvp!==1 ( 
                                                                                    echo.
                                                                                    echo !t75!
                                                                                    )
                                                                        if !hdr10pp!==1 ( 
                                                                                        echo.
                                                                                        echo !t76!
                                                                                        )
                                                                        
                                                                        if !dvp!==0 if !hdr10pp!==0 (
                                                                                                echo.
                                                                                                echo %%b
                                                                                                echo.
                                                                                                rem echo !x2!
                                                                                                )
                                                                        
                                                                        )
                                                            if !x2!==13 (
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=Dolby Vision Metadata"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==13 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        set /a dvp=1
                                                                                                        ) 
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=HDR Dynamic Metadata SMPTE2094-40 (HDR10+)"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==13 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        set /a hdr10pp=1
                                                                                                        )
                                                                        if !dvp!==1 ( 
                                                                                    echo.
                                                                                    echo !t75!
                                                                                    )
                                                                        if !hdr10pp!==1 ( 
                                                                                        echo.
                                                                                        echo !t76!
                                                                                        )
                                                                        
                                                                        if !dvp!==0 if !hdr10pp!==0 ( 
                                                                                                echo %%a = %%b  
                                                                                                set "maxc=%%b"
                                                                                                set "maxcpresent=1"
                                                                                                rem echo !x2!
                                                                                                )
                                                                        )
                                                            if !x2!==14 ( 
                                                                        echo %%a = %%b  
                                                                        set "maxa=%%b"
                                                                        set "maxapresent=1"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==15 (
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=Dolby Vision Metadata"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==15 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        set /a dvp=1
                                                                                                        ) 
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=HDR Dynamic Metadata SMPTE2094-40 (HDR10+)"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==15 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        set /a hdr10pp=1
                                                                                                        )
                                                                        if !dvp!==1 ( 
                                                                                    echo.
                                                                                    echo !t75!
                                                                                    )
                                                                        if !hdr10pp!==1 ( 
                                                                                        echo.
                                                                                        echo !t76!
                                                                                        )
                                                                        )
                                                            if !x2!==16 (
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=Dolby Vision Metadata"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==16 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        set /a dvp=1
                                                                                                        ) 
                                                                        if !dvp!==1 ( 
                                                                                    echo.
                                                                                    echo !t75!
                                                                                    )
                                                                        )
                                                            set /A x2+=1
)

rem echo maxapresent = %maxapresent%
rem echo maxcpresent = %maxcpresent%


if %maxapresent%==1 if %maxcpresent%==1 (
                                        echo.
                                        echo !t77!
                                        echo master-display=G^(!greenx!,!greeny!^)B^(!bx!,!by!^)R^(!redx!,!redy!^)WP^(!wpx!,!wpy!^)L^(!maxl!,!minl!^):max-cll=!maxc!,!maxa!
                                        set "masterdisplaysettings=G^(!greenx!,!greeny!^)B^(!bx!,!by!^)R^(!redx!,!redy!^)WP^(!wpx!,!wpy!^)L^(!maxl!,!minl!^):max-cll=!maxc!,!maxa!"
                                        rem set masterdisplaysettings=master-display^=G^(!greenx!,!greeny!^)B^(!bx!,!by!^)R^(!redx!,!redy!^)WP^(!wpx!,!wpy!^)L^(!maxl!,!minl!^):max-cll=!maxc!,!maxa!"
                                        rem echo !masterdisplaysettings!
                                        echo.
                                        )

if %maxapresent%==0 if %maxcpresent%==0 (
                                        echo.
                                        echo !t77!
                                        echo master-display=G^(!greenx!,!greeny!^)B^(!bx!,!by!^)R^(!redx!,!redy!^)WP^(!wpx!,!wpy!^)L^(!maxl!,!minl!^)
                                        set "masterdisplaysettings=G^(!greenx!,!greeny!^)B^(!bx!,!by!^)R^(!redx!,!redy!^)WP^(!wpx!,!wpy!^)L^(!maxl!,!minl!^)"
                                        rem set "masterdisplaysettings=master-display^=G^(!greenx!,!greeny!^)B^(!bx!,!by!^)R^(!redx!,!redy!^)WP^(!wpx!,!wpy!^)L^(!maxl!,!minl!^)"
                                        rem echo !masterdisplaysettings!
                                        echo.
                                        )


rem//////////////////////////////////////////////////////////////////////////////////////////////////
rem//////////////////////////////////////////////////////////////////////////////////////////////////

:rilevazionebandenere_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

.\bin\ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 %NomeFile%  > ".\temp\durata_film.txt"


set /a contatore=1
for /f "tokens=1 delims=." %%a in (.\temp\durata_film.txt) do  (
                                                        echo. 
                                                        echo !t7! %%a
                                                        set /a "secondi=%%a"
                                                        set /a "minuti=!secondi!/60"
                                                        echo !t8! !minuti!
                                                        set /a "intervallo_tagli=!secondi!/11"
                                                        echo !t9! !intervallo_tagli!!t10!
                                                        echo.
                                                        echo !t11!
                                                        echo.

                                                        

                                                        FOR /L %%a IN (1, 1, 10) DO (
                                                                                    rem echo %%a
                                                                                    set /a "secondi=%%a*!intervallo_tagli!"
                                                                                    rem echo !secondi!

                                                                                    if !formatvideo!==yuv420p (
                                                                                                                set /a "ca=16"
                                                                                                                rem echo !ca!
                                                                                                                    
                                                                                                                set /a "cb=2"
                                                                                                                rem echo !cb!
                                                                                                                    
                                                                                                                set /a "cc=0"
                                                                                                                rem echo !cc!

                                                                                                                set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                                                rem echo !cr!
                                                                                                                )

                                                                                    if !formatvideo!==yuv420p10le  ( 
                                                                                                                    set /a "ca=72"
                                                                                                                    rem echo !ca!
                                                                                                                    
                                                                                                                    set /a "cb=2"
                                                                                                                    rem echo !cb!
                                                                                                                    
                                                                                                                    set /a "cc=0"
                                                                                                                    rem echo !cc!

                                                                                                                    set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                                                    rem echo !cr!
                                                                                                                    )                                                                                                                

                                    
                                                                                
                                                                                
                                                                                    .\bin\ffmpeg -ss !secondi! -hide_banner -nostats -i %NomeFile% -vframes 10 -vf !cr! -f null - 2> ".\temp\crop.txt"
                                                                                    
                                                                                    findstr /r "Parsed_cropdetect_0" .\temp\crop.txt >> .\temp\risultato_multiplo.txt   
                                                                                    
                                                                                    echo !t12! %%a !t13! !secondi! !t14!
                                                                                    
                                                                                    )       
                                                                                       

                                                                                    for /f "tokens=1,2 delims==" %%a in (.\temp\risultato_multiplo.txt) do ( echo %%b >> .\temp\crop_multiplo.txt )
                                                                                    
                                                                                    set /a "maxfrequenza=0"

                                                                                    for /f "delims=" %%a in (.\temp\crop_multiplo.txt) do ( 
                                                                                                                                    set "cropconfront=%%a"
                                                                                                                                    rem echo "!cropconfront!"
                                                                                                                                    
                                                                                                                                    set /a "contatorfrequenza=0"
                                                                                                                                    for /f "delims=" %%b in (.\temp\crop_multiplo.txt) do (
                                                                                                                                                                                    set "dato_da_verificare=%%b"
                                                                                                                                                                                    rem echo cropconfront = "!cropconfront!"
                                                                                                                                                                                    rem echo dato_da_verificare = "!dato_da_verificare!"
                                                                                                                                                                                    if !cropconfront!==!dato_da_verificare! ( set /a "contatorfrequenza+=1")
                                                                                                                                                                                    )
                                                                                                                                    if !maxfrequenza! LSS !contatorfrequenza! ( 
                                                                                                                                                                                set /a "maxfrequenza=!contatorfrequenza!"
                                                                                                                                                                                set "cropd=!cropconfront!"
                                                                                                                                                                                )
                                                                                                                                    

                                                                                                                                    rem if !cropconfront! in (elenco_crop_frequenza.txt) ()
                                                                                                                                    rem echo !cropconfront!:!contatorfrequenza! >> elenco_crop_frequenza.txt

                                                                                                                                    )

                                                                                    rem echo crop piu' frequente = !cropd! con grequenza = !maxfrequenza!
                                                                                    echo !cropd! > .\temp\crop_finale.txt

                                                                                    for /f "tokens=1,2,3,4 delims=:" %%a in (.\temp\crop_finale.txt) do  ( 
                                                                                                                                                    rem set /a "mwidth=%%a"
                                                                                                                                                    rem echo mwidth = !mwidth!

                                                                                                                                                    rem set /a "mheight=%%b"
                                                                                                                                                    rem echo mheight = !mheight!

                                                                                                                                                    rem set /a "mx=%%c"
                                                                                                                                                    rem echo mx = !mx!

                                                                                                                                                    rem set /a "my=%%d"
                                                                                                                                                    rem echo my = !my!

                                                                                                                                                    if !contatore!==1 ( 
                                                                                                                                                                set /a "wmax=%%a" 
                                                                                                                                                                set /a "hmax=%%b"
                                                                                                                                                                set /a "xmin=%%c"
                                                                                                                                                                set /a "ymin=%%d"
                                                                                                                                                                set /a "mwidth=%%a"
                                                                                                                                                                set /a "mheight=%%b"
                                                                                                                                                                set /a "mx=%%c"
                                                                                                                                                                set /a "my=%%d"
                                                                                                                                                                set /a "contatore+=1"
                                                                                                                                                                )
                                                                                                                                                    
                                                                                                                                                    rem if %%b gtr !hmax! if %%c gtr !xmin! if %%d gtr !ymin! 

                                                                                                                                                    if %%a geq !wmax! if %%b geq !hmax! ( 
                                                                                                                                                                        set /a "wmax=%%a" 
                                                                                                                                                                        set /a "hmax=%%b"
                                                                                                                                                                        set /a "xmin=%%c"
                                                                                                                                                                        set /a "ymin=%%d"
                                                                                                                                                                        set /a "mwidth=%%a"
                                                                                                                                                                        set /a "mheight=%%b"
                                                                                                                                                                        set /a "mx=%%c"
                                                                                                                                                                        set /a "my=%%d"
                                                                                                                                                                        )
                                                                                                                                                    )
                                                                                    echo.
                                                                                    
                                                                                    set /a "mwidth4k=!mwidth!/2*2"
                                                                                    set /a "mheight4k=!mheight!/2*2"

                                                                                    set /a "csup=!my!/2*2"
                                                                                    rem echo csup = !csup!
                                                                                                                                    
                                                                                    set /a "csin=!mx!/2*2"
                                                                                    rem echo csin = !csin!

                                                                                    set /a "cinf=(!heightvideo!-!mheight!-!my!)/2*2"
                                                                                    rem echo movieheightreal = !movieheightreal!
                                                                                    rem echo cinf = !cinf!
                                                                                    set /a "cdes=(!widthvideo!-!mwidth!-!mx!)/2*2"
                                                                                    rem echo cdes = !cdes!
                                                                                    echo.

                                                                                    echo FFmpeg Crop Settings: crop=!mwidth4k!:!mheight4k!:!csin!:!csup!    
                                                                                    set "cropff=crop=!mwidth4k!:!mheight4k!:!csin!:!csup!"
                                                                                    @REM echo cropff = !cropff!
                                                                                    echo.  
                                                                                    
                                                                                    echo !t17!  !mwidth4k! 
                                                                                    echo !t18!  !mheight4k! 
                                                                                    echo.

                                                                                    set /a "mwidth2k=!mwidth4k!/2"
                                                                                    set /a "mheight2k=!mheight4k!/2"

                                                                                    echo !t171!  !mwidth2k! 
                                                                                    echo !t181!  !mheight2k! 
                                                                                    echo.

                                                                                    set /a "larghezza1080pnvenc=3840"
                                                                                    set /a "altezza1080pnvenc=2160"
                                                                                    @REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
                                                                                    @REM echo altezza1080pnvenc = !altezza1080pnvenc!                                    

                                                                                    set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!mwidth4k!"
                                                                                    set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!mheight4k!"
                                                                                    @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
                                                                                    @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

                                                                                    if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                                                                                                        @REM echo dentro il 1o if
                                                                                                                                                                        set /a "width2k=!mwidth4k!"
                                                                                                                                                                        set /a "height2k=!mheight4k!"
                                                                                                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                                                                                                set /a "width2k=!mwidth4k!"
                                                                                                                                                                                                                                                                set /a "height2k=!mheight4k!"
                                                                                                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo width1080p = !width1080p!
                                                                                                                                                                                                                                                                                                                                                        @REM echo height1080p = !height1080p!
                                                                                                                                                                                                                                                                                                                                                        set /a "width2k=!mwidth4k!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        set /a "height2k=!mheight4k!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "width2k=!mwidth4k!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "height2k=!mheight4k!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                                                                                                                set /a "width2k=!mwidth4k!"
                                                                                                                                                                                                                                                                set /a "height2k=!mheight4k!"
                                                                                                                                                                                                                                                                )
                                                                                                                                                                        
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                                                                                                        set /a "width2k=!mwidth4k!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        set /a "height2k=!mheight4k!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.   

                                                                                        set /a "width4k=!width2k!/2*2"
                                                                                        set /a "height4k=!height2k!/2*2"                      

                                                                                        echo !t20!  !width4k! 
                                                                                        echo !t21!  !height4k!    
                                                                                        echo.

                                                                                        set /a "width2k=!width4k!/4*2"
                                                                                        set /a "height2k=!height4k!/4*2"

                                                                                        echo !t201!  !width2k! 
                                                                                        echo !t211!  !height2k!    
                                                                                        echo.
                  
                                                        )                          

:cropmanuale_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set /a "csup=0"
set /a "cinf=0"
set /a "csin=0"
set /a "cdes=0"
set /a "bandasuperiore=0"
set /a "bandainferiore=0"
set /a "bandasinistra=0"
set /a "bandadestra=0"
set /a "differenzialelarghezza1080pnvenc=0"
set /a "differenzialealtezza1080pnvenc=0"
if exist ".\temp\Temp_HDR10.txt" ( del ".\temp\Temp_HDR10.txt" )
if exist ".\temp\Temp_HDR10_Finale.txt" ( del ".\temp\Temp_HDR10_Finale.txt" )
if exist ".\temp\Temp_HDR10_Stream.txt" ( del ".\temp\Temp_HDR10_Stream.txt" ) 
if exist ".\temp\durata_film.txt" ( del ".\temp\durata_film.txt" )
if exist ".\temp\crop.txt" ( del ".\temp\crop.txt" )
if exist ".\temp\risultato_multiplo.txt" ( del ".\temp\risultato_multiplo.txt" )
if exist ".\temp\crop_multiplo.txt" ( del ".\temp\crop_multiplo.txt" )
if exist ".\temp\crop_finale.txt" ( del ".\temp\crop_finale.txt" )

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t22!"   
    if errorlevel 2 goto cropmanualeFFmpeg_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
    if errorlevel 1 goto finecropmanualeFFmpeg_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
)

CHOICE /N /C:SN /M "!t22!"   

if errorlevel 2 goto cropmanualeFFmpeg_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 1 goto finecropmanualeFFmpeg_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:cropmanualeFFmpeg_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
echo.
echo !t23!
echo.

:banda_superiore_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set /p "bandasuperiore=!t24!"
SET "var="&for /f "delims=0123456789" %%i in ("!bandasuperiore!") do set var=!bandasuperiore!
if defined var (
                echo.
                echo !t25!
                echo.
                goto banda_superiore_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
                ) else (
                        set /a "csup=!bandasuperiore!/2*2"
                        )

echo.
:banda_inferiore_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set /p "bandainferiore=!t26!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandainferiore!") do set var=!bandainferiore!
if defined var (
                echo.
                echo !t27!
                echo.
                goto banda_inferiore_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
                ) else (
                        set /a "cinf=!bandainferiore!/2*2"
                        )


echo.
:banda_sinistra_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set /p "bandasinistra=!t28!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandasinistra!") do set var=!bandasinistra!
if defined var (
                echo.
                echo !t29!
                echo.
                goto banda_sinistra_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
                ) else (
                        set /a "csin=!bandasinistra!/2*2"
                        )

                        
echo.
:banda_destra_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set /p "bandadestra=!t30!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandadestra!") do set var=!bandadestra!
if defined var (
                echo.
                echo !t31!
                echo.
                goto banda_destra_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
                ) else (
                        set /a "cdes=!bandadestra!/2*2"
                        )
                                   

set /a "mwidth=!widthvideo!/2*2"
set /a "mheight=!heightvideo!/2*2"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "mwidth4k=!mwidth!-!csin!-!cdes!"
set /a "mheight4k=!mheight!-!csup!-!cinf!"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!


echo.
echo !t32!  !csup! 
echo !t33!  !cinf! 
echo !t34!  !csin! 
echo !t35!  !cdes!  
echo.


echo FFmpeg Crop Settings: crop=!mwidth4k!:!mheight4k!:!csin!:!csup!    
set "cropff=crop=!mwidth4k!:!mheight4k!:!csin!:!csup!"
@REM echo cropff = !cropff!
echo.  

echo !t17!  !mwidth4k! 
echo !t18! senza Barre Nere:  !mheight4k! 
echo.

set /a "mwidth2k=!mwidth4k!/2"
set /a "mheight2k=!mheight4k!/2"

echo !t171!  !mwidth2k! 
echo !t181!  !mheight2k! 
echo.


set /a "larghezza1080pnvenc=3840"
set /a "altezza1080pnvenc=2160"
@REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
@REM echo altezza1080pnvenc = !altezza1080pnvenc!                                    

set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!mwidth4k!"
set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!mheight4k!"
@REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
@REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                    @REM echo dentro il 1o if
                                                                                    set /a "width2k=!mwidth4k!"
                                                                                    set /a "height2k=!mheight4k!"
                                                                                    )                        
                                                                                                                                                                                            
if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                        @REM echo dentro il 2o if
                                                                                        set /a "width2k=!mwidth4k!"
                                                                                        set /a "height2k=!mheight4k!"
                                                                                        ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                @REM echo dentro il 2o if 2o else
                                                                                                                                                                                @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                @REM echo width1080p = !width1080p!
                                                                                                                                                                                @REM echo height1080p = !height1080p!
                                                                                                                                                                                set /a "width2k=!mwidth4k!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                set /a "height2k=!mheight4k!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                        set /a "width2k=!mwidth4k!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                        set /a "height2k=!mheight4k!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                        )
if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                @REM echo dentro 0 0
                                                                                set /a "width2k=!mwidth4k!"
                                                                                set /a "height2k=!mheight4k!"
                                                                                )

if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                        @REM echo dentro 0 0
                                                                        set /a "width2k=!mwidth4k!+differenzialelarghezza1080pnvenc"
                                                                        set /a "height2k=!mheight4k!+differenzialelarghezza1080pnvenc"
                                                                        )                                                                                        


echo !t19!
echo.   

set /a "width4k=!width2k!/2*2"
set /a "height4k=!height2k!/2*2"                      

echo !t20!  !width4k! 
echo !t21!  !height4k!    
echo.

set /a "width2k=!width4k!/4*2"
set /a "height2k=!height4k!/4*2"

echo !t201!  !width2k! 
echo !t211!  !height2k!    
echo.

goto cropmanuale_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:finecropmanualeFFmpeg_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 


rem////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////


rem tipo codifica
echo.
echo !t40!
echo.
echo 1) CRF 
echo 2) VBR 
echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto CodificaVBR_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 1 goto CodificaCRF_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:CodificaVBR_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "TipoCodificaFFmpeg=-b:v "
set /a "Valorecrf_FFmpeg=0"
goto inserimentoValoriCRF_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:CodificaCRF_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "TipoCodificaFFmpeg=-crf:v "
set /a "Valorecrf_FFmpeg=1"

:inserimentoValoriCRF_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

if !Valorecrf_FFmpeg!==1 (
                                echo.
                                set /p "valoreCRFFFmpeg=!t78! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreCRFFFmpeg!") do set var=!valoreCRFFFmpeg!
                                if defined var (
                                                echo.
                                                echo !t79!
                                                echo.
                                                goto inserimentoValoriCRF_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
                                                ) 

                                set /a "valoreCRFFFmpeg=!valoreCRFFFmpeg!"
                                @REM echo valoreQuantizzazione = !valoreCRFFFmpeg!
                                if !valoreCRFFFmpeg! GEQ 10 if !valoreCRFFFmpeg! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t126! !valoreCRFFFmpeg!
                                                                                                                set "tipoQuantizzazioneFFmpeg=!TipoCodificaFFmpeg!!valoreCRFFFmpeg!"
                                                                                                                set /a "valoreCRFFFmpeg1080p=!valoreCRFFFmpeg!+2"
                                                                                                                echo !t127! !valoreCRFFFmpeg1080p!
                                                                                                                set "tipoQuantizzazioneFFmpeg1080p=!TipoCodificaFFmpeg!!valoreCRFFFmpeg1080p!"
                                                                                                                echo.
                                                                                                                echo !t431! Video 2160p: !tipoQuantizzazioneFFmpeg!
                                                                                                                echo !t431! Video 1080p: !tipoQuantizzazioneFFmpeg1080p!
                                                                                                                goto fineQuantizzazione_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
                                                                                                                ) 
                                echo.
                                echo !t81!
                                goto inserimentoValoriCRF_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
                                                                                                                        
                                )



if !Valorecrf_FFmpeg!==0 (
                                echo.
                                set /p "valoreBitRateFFmpeg=!t128! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateFFmpeg!") do set var=!valoreBitRateFFmpeg!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                echo.
                                                goto inserimentoValoriCRF_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
                                                ) 
                                set /a "valoreBitRateFFmpeg=!valoreBitRateFFmpeg!"
                                @REM echo valoreBitRateFFmpeg = !valoreBitRateFFmpeg!
                                if !valoreBitRateFFmpeg! GEQ 100 if !valoreBitRateFFmpeg! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t129! !valoreBitRateFFmpeg!
                                                                                                        set "tipoQuantizzazioneFFmpeg=!TipoCodificaFFmpeg!!valoreBitRateFFmpeg!k"
                                                                                                        set /a "valoreBitRateFFmpeg1080p=!valoreBitRateFFmpeg!/2"
                                                                                                        echo !t130! !valoreBitRateFFmpeg1080p!
                                                                                                        set "tipoQuantizzazioneFFmpeg1080p=!TipoCodificaFFmpeg!!valoreBitRateFFmpeg1080p!k"
                                                                                                        echo.
                                                                                                        echo !t431! Video 2160p: !tipoQuantizzazioneFFmpeg!
                                                                                                        echo !t431! Video 1080p: !tipoQuantizzazioneFFmpeg1080p!
                                                                                                        goto fineQuantizzazione_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCRF_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
                                                                                                              
                                )


:fineQuantizzazione_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

rem////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////

rem velocit codifica
echo.
echo !t82!
echo.
echo 1) Ultrafast !t83!
echo 2) Superfast 
echo 3) Veryfast 
echo 4) Faster 
echo 5) Fast 
echo 6) Medium !t84!
echo 7) Slow 
echo 8) Slower 
echo 9) Veryslow 
echo 0) Placebo !t85!
echo.
CHOICE /N /C:1234567890 /M "!t86!"

if errorlevel 10 goto Placebo_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 9 goto Veryslow_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 8 goto Slower_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 7 goto Slow_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 6 goto Medium_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 5 goto Fast_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 4 goto Faster_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 3 goto Veryfast_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 2 goto Superfast_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 1 goto Ultrafast_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 


:Placebo_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "SettaggioQualitaFFmpeg=-preset:v placebo"
set "QualitySetting=Placebo"
goto fineQualitCodifica_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:Veryslow_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "SettaggioQualitaFFmpeg=-preset:v veryslow"
set "QualitySetting=Veryslow"
goto fineQualitCodifica_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:Slower_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "SettaggioQualitaFFmpeg=-preset:v slower"
set "QualitySetting=Slower"
goto fineQualitCodifica_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:Slow_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "SettaggioQualitaFFmpeg=-preset:v slow"
set "QualitySetting=Slow"
goto fineQualitCodifica_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:Medium_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "SettaggioQualitaFFmpeg=-preset:v medium"
set "QualitySetting=Medium"
goto fineQualitCodifica_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:Fast_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "SettaggioQualitaFFmpeg=-preset:v fast"
set "QualitySetting=Fast"
goto fineQualitCodifica_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:Faster_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "SettaggioQualitaFFmpeg=-preset:v faster"
set "QualitySetting=Faster"
goto fineQualitCodifica_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:Veryfast_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "SettaggioQualitaFFmpeg=-preset:v veryfast"
set "QualitySetting=Veryfast"
goto fineQualitCodifica_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:Superfast_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "SettaggioQualitaFFmpeg=-preset:v superfast"
set "QualitySetting=Superfast"
goto fineQualitCodifica_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:Ultrafast_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "SettaggioQualitaFFmpeg=-preset:v ultrafast"
set "QualitySetting=Ultrafast"
goto fineQualitCodifica_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 


:fineQualitCodifica_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
echo.
echo !t87! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaFFmpeg!



rem////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////


rem quantizzazione adattiva
echo.
echo !t88!
echo.
echo !t89!
echo !t90!
echo !t91!
echo !t92!
echo !t93!
echo.
CHOICE /N /C:12345 /M "!t94!"

if errorlevel 5 goto Edge_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 4 goto DarkBias_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 3 goto AutoVariance_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 2 goto Abilitata_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 1 goto Disabilitata_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:Edge_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "ValoreQuantizzazioneAdattiva=aq-mode=4"
set "TipoQuantizzazioneAdattiva_FFmpeg=!t108!"
goto QuantizzazioneSelezionata_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:DarkBias_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "ValoreQuantizzazioneAdattiva=aq-mode=3"
set "TipoQuantizzazioneAdattiva_FFmpeg=!t109!"
goto QuantizzazioneSelezionata_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:AutoVariance_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "ValoreQuantizzazioneAdattiva=aq-mode=2"
set "TipoQuantizzazioneAdattiva_FFmpeg=!t110!"
goto QuantizzazioneSelezionata_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:Abilitata_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "ValoreQuantizzazioneAdattiva=aq-mode=1"
set "TipoQuantizzazioneAdattiva_FFmpeg=!t111!"
goto QuantizzazioneSelezionata_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:Disabilitata_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "ValoreQuantizzazioneAdattiva=aq-mode=0"
set "TipoQuantizzazioneAdattiva_FFmpeg=!t112!"
goto QuantizzazioneSelezionata_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:QuantizzazioneSelezionata_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

echo.
echo !t95! !TipoQuantizzazioneAdattiva_FFmpeg!
echo.
echo !t43! !ValoreQuantizzazioneAdattiva!


rem////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////


if !TipoQuantizzazioneAdattiva_FFmpeg!==Disabilitata (
    set "SettaggioFozaQAFFmpeg=aq-strength=1.0"
    goto fineForzaQuantizzazioneAdattiva_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
)



rem forza quantizzazione
echo.
echo !t96!
echo.
echo 1) 0.1 !t97!
echo 2) 0.2 
echo 3) 0.3 
echo 4) 0.4 
echo 5) 0.5 
echo 6) 0.6 
echo 7) 0.7 
echo 8) 0.8 
echo 9) 0.9 
echo 0) 1.0 !t98!
echo.
CHOICE /N /C:1234567890 /M "!t86!"

if errorlevel 10 goto Forza10_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 9 goto Forza9_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 8 goto Forza8_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 7 goto Forza7_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 6 goto Forza6_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 5 goto Forza5_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 4 goto Forza4_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 3 goto Forza3_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 2 goto Forza2_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 1 goto Forza1_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 


:Forza10_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "SettaggioFozaQAFFmpeg=aq-strength=1.0"
set "SettingoFozaQAFFmpeg=1.0"
goto fineForzaQuantizzazioneAdattiva_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:Forza9_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "SettaggioFozaQAFFmpeg=aq-strength=0.9"
set "SettingoFozaQAFFmpeg=0.9"
goto fineForzaQuantizzazioneAdattiva_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:Forza8_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "SettaggioFozaQAFFmpeg=aq-strength=0.8"
set "SettingoFozaQAFFmpeg=0.7"
goto fineForzaQuantizzazioneAdattiva_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:Forza7_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "SettaggioFozaQAFFmpeg=aq-strength=0.7"
set "SettingoFozaQAFFmpeg=0.7"
goto fineForzaQuantizzazioneAdattiva_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:Forza6_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "SettaggioFozaQAFFmpeg=aq-strength=0.6"
set "SettingoFozaQAFFmpeg=0.6"
goto fineForzaQuantizzazioneAdattiva_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:Forza5_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "SettaggioFozaQAFFmpeg=aq-strength=0.5"
set "SettingoFozaQAFFmpeg=0.5"
goto fineForzaQuantizzazioneAdattiva_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:Forza4_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "SettaggioFozaQAFFmpeg=aq-strength=0.4"
set "SettingoFozaQAFFmpeg=0.4"
goto fineForzaQuantizzazioneAdattiva_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:Forza3_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "SettaggioFozaQAFFmpeg=aq-strength=0.3"
set "SettingoFozaQAFFmpeg=0.3"
goto fineForzaQuantizzazioneAdattiva_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:Forza2_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "SettaggioFozaQAFFmpeg=aq-strength=0.2"
set "SettingoFozaQAFFmpeg=0.2"
goto fineForzaQuantizzazioneAdattiva_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:Forza1_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "SettaggioFozaQAFFmpeg=aq-strength=0.1"
set "SettingoFozaQAFFmpeg=0.1"
goto fineForzaQuantizzazioneAdattiva_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 


:fineForzaQuantizzazioneAdattiva_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
echo.
echo !t99! !SettingoFozaQAFFmpeg!
echo.
echo !t43! !SettaggioFozaQAFFmpeg!

:fineForzaQuantizzazioneAdattiva_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 


rem////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////

rem denoiser
rem quantizzazione adattiva
set "DenoiserFinalSettings="
echo.
echo !t100!
echo.
echo !t101!
echo 2) Atadenoise 
echo 3) Nlmeans 
echo 4) Vaguedenoiser 
echo 5) Hqdn3d 
echo.
CHOICE /N /C:12345 /M "!t94!"

if errorlevel 5 goto Hqdn3dDenoiser_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 4 goto VagueDenoiser_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 3 goto NlmeansDenoiser_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 2 goto AtaDenoiser_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 1 goto NessunDenoiser_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:Hqdn3dDenoiser_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "DenoiserSelezionato=Hqdn3d"
set "NumeroTipoDenoiser=5"
goto FineSceltaDenoiser_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:VagueDenoiser_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "DenoiserSelezionato=VagueDenoiser"
set "NumeroTipoDenoiser=4"
goto FineSceltaDenoiser_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:NlmeansDenoiser_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "DenoiserSelezionato=Nlmeans"
set "NumeroTipoDenoiser=3"
goto FineSceltaDenoiser_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:AtaDenoiser_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "DenoiserSelezionato=AtaDenoiser"
set "NumeroTipoDenoiser=2"
goto FineSceltaDenoiser_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:NessunDenoiser_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
set "DenoiserSelezionato=Nessun Denoiser"
set "NumeroTipoDenoiser=1"
goto FineSceltaDenoiser_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:FineSceltaDenoiser_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
echo.
echo !t102! !DenoiserSelezionato!


if !NumeroTipoDenoiser!==1 (
   set "DenoiserFinalSettings=nessuno" 
   goto SalvataggioInfoCodifica_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
)

echo.
echo !t103!
echo.
echo !t104!
echo !t105!
echo !t106!
echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto IntensitaForteDenoiser_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 2 goto IntensitaMediaDenoiser_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 1 goto IntensitaLeggera_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:IntensitaForteDenoiser_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if !NumeroTipoDenoiser!==5 (
    set "denoiserSettings=hqdn3d=luma_spatial=12:chroma_spatial=6:luma_tmp=6:chroma_tmp=4"
)
if !NumeroTipoDenoiser!==4 (
    set "denoiserSettings=vaguedenoiser=threshold=6:percent=100:nsteps=12"
)
if !NumeroTipoDenoiser!==3 (
    set "denoiserSettings=nlmeans=s=20:p=33:r=15"
)
if !NumeroTipoDenoiser!==2 (
    set "denoiserSettings=atadenoise=0a=0.04:0b=0.12:1a=0.04:1b=0.12:2a=0.04:2b=0.12:s=9"
)
goto FineIntensitaDenoiser_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 


:IntensitaMediaDenoiser_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if !NumeroTipoDenoiser!==5 (
    set "denoiserSettings=hqdn3d=luma_spatial=8:chroma_spatial=4:luma_tmp=6:chroma_tmp=4"
)
if !NumeroTipoDenoiser!==4 (
    set "denoiserSettings=vaguedenoiser=threshold=4:percent=100:nsteps=8"
)
if !NumeroTipoDenoiser!==3 (
    set "denoiserSettings=nlmeans=s=15:p=33:r=15"
)
if !NumeroTipoDenoiser!==2 (
    set "denoiserSettings=atadenoise=0a=0.03:0b=0.08:1a=0.03:1b=0.08:2a=0.03:2b=0.08:s=9"
)
goto FineIntensitaDenoiser_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 


:IntensitaLeggera_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if !NumeroTipoDenoiser!==5 (
    set "denoiserSettings=hqdn3d=luma_spatial=4:chroma_spatial=2:luma_tmp=6:chroma_tmp=4"
)
if !NumeroTipoDenoiser!==4 (
    set "denoiserSettings=vaguedenoiser=threshold=2:percent=100:nsteps=4"
)
if !NumeroTipoDenoiser!==3 (
    set "denoiserSettings=nlmeans=s=10:p=33:r=15"
)
if !NumeroTipoDenoiser!==2 (
    set "denoiserSettings=atadenoise=0a=0.01:0b=0.02:1a=0.01:1b=0.02:2a=0.01:2b=0.02:s=9"
)
goto FineIntensitaDenoiser_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 


:FineIntensitaDenoiser_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
echo.
set "DenoiserFinalSettings=!denoiserSettings!"

:StampaParametriCodifica_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
echo !t43! !DenoiserFinalSettings!


rem////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////


:SalvataggioInfoCodifica_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

echo.
set "VideoInfoCodifica=codifica_ffmpeg_2160p_piu_1080p_da_2160p|!NomeFile!|!NomeFileOutputFFmpeg!|!NomeFileOutputFFmpeg2!|!cropff!|!mwidth4k!x!mheight4k!|!mwidth2k!x!mheight2k!|!masterdisplaysettings!|!colorpr!|!colortr!|!colorsp!|!tipoQuantizzazioneFFmpeg!x!tipoQuantizzazioneFFmpeg1080p!|!SettaggioQualitaFFmpeg!|!ValoreQuantizzazioneAdattiva!|!SettaggioFozaQAFFmpeg!|!DenoiserFinalSettings!|!formatvideo!|no_miglioramento_dettagli|no_color_correction|no_numero_passaggi_upscaling|no_lokahead|no_precisione_vettore_movimento"
@REM echo VideoInfoCodifica = !VideoInfoCodifica!
@REM echo.

if exist ".\saved\savedmoviesallencodings.dat" ( 
                                                echo !VideoInfoCodifica! >> .\saved\savedmoviesallencodings.dat
                                                goto finesalvataggioInserimentoFFmpegCodificaSoftwareH265
                                                ) 

echo !VideoInfoCodifica! > .\saved\savedmoviesallencodings.dat


:finesalvataggioInserimentoFFmpegCodificaSoftwareH265

echo !t60! !numeromovie! !t61!
echo.

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t62!"
    echo.
    if errorlevel 2 goto finesceltanuovovideodacodificare_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
    if errorlevel 1 goto altrivideodainserire_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
)

CHOICE /N /C:SN /M "!t62!"
echo.

if errorlevel 2 goto finesceltanuovovideodacodificare_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 
if errorlevel 1 goto altrivideodainserire_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 

:finesceltanuovovideodacodificare_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p 






goto fineRealeInserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p


:solohdr10plus_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p
echo !t107!
echo.
goto fineRealeInserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p

:solodv_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p
echo !t107!
echo.
goto fineRealeInserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p


:novideofileffmpeg_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p
echo !t63!
echo.
goto fineRealeInserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p


:finehdrffmpeg_InserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p
echo !t131!
echo.




:fineRealeInserimentoFFmpegCodifica2160pPiu1080pdaVideo2160p

if exist ".\temp\Temp_HDR10.txt" ( del ".\temp\Temp_HDR10.txt" )
if exist ".\temp\Temp_HDR10_Finale.txt" ( del ".\temp\Temp_HDR10_Finale.txt" )
if exist ".\temp\Temp_HDR10_Stream.txt" ( del ".\temp\Temp_HDR10_Stream.txt" ) 
if exist ".\temp\durata_film.txt" ( del ".\temp\durata_film.txt" )
if exist ".\temp\crop.txt" ( del ".\temp\crop.txt" )
if exist ".\temp\risultato_multiplo.txt" ( del ".\temp\risultato_multiplo.txt" )
if exist ".\temp\crop_multiplo.txt" ( del ".\temp\crop_multiplo.txt" )
if exist ".\temp\crop_finale.txt" ( del ".\temp\crop_finale.txt" )




set waitenter=
set /P waitenter=!t65!
Endlocal
goto InserimentoCodifcaInCodaeSalvataggioSuDisco









rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:QSVEncPuliziaLeggeraDettagliMigliorati

cls
setLocal EnableExtensions EnableDelayedExpansion



for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoQSVEncPuliziaLeggeraDettagliMigliorati
)
if %lingua%==inglese (
    goto caricalinguaingleseQSVEncPuliziaLeggeraDettagliMigliorati
)


:caricalinguaingleseQSVEncPuliziaLeggeraDettagliMigliorati
@REM set t1=Insert Hardware Video Encoding Info 2160p Light Denoiser, Detail Enhancement and Saving to Disk. 

set t2=Drag Here the Video File 2160p 10 bit HDR to apply the Denoiser and Enhance Details: 
@REM set t211=Video File 2160p 10 bit HDR to apply the Denoiser and Enhance Details: 


set t3=File does not exist 
set t4=Info Video:  

set t5=The Inserted Video is 2160p 10bit HDR 
@REM set t511=The Inserted Video is 2160p 10bit SDR 

set t6=The Inserted Video isn't 2160p 10bit HDR 
set t7=Video Duration in seconds:
set t8=Video Duration in Minutes:
set t9=Interval between Frames for Crop Detection:
set t10= seconds
set t11=Black Bands Detection Started....
set t12=Crop Detection to Frame
set t13=to seconds
set t14=Done...
set t15=Original 2160p Video Width: 
set t16=Original 2160p Video Height:
set t17=Original Video 2160p Width Without Black Bars:
set t18=Original Video 2160p Height Without Black Bars:

set t171=Output Video 1080p Width Without Black Bars:
set t181=Outout Video 1080p Height Without Black Bars:

set t19=Adapting Video Resolution to Full 2160p Format...
set t20=Final 2160p Output Video Width:
set t21=Final 2160p Output Video Height:

set t22=Settings of Black Bands to Crop are Correct (Yes/No):
set t23=Manually Entering Black Bands Values to Crop... 
set t24=Enter the Upper Black Band Value: 
set t25=Error Entering Upper Black Band Value... It's Not a Number. 
set t26=Enter the Lower Black Band Value: 
set t27=Error Entering Lower Black Band Value... It's Not a Number.
set t28=Enter the Left Black Band Value: 
set t29=Error Entering Left Black Band Value... It's Not a Number.
set t30=Enter the Right Black Band Value: 
set t31=Error Entering Right Black Band Value... It's Not a Number.
set t32=Upper Black Band:
set t33=Lower Black Band:
set t34=Left Black Band:
set t35=Right Black Band:
set t36=2160p Original Video Width without Black Bars:
set t37=2160p Original Video Height without Black Bars:

@REM set t361=1080p Video Width without Black Bars:
@REM set t371=1080p Video Height without Black Bars

set t38=Select Graphic Card you want to Encode with:
set t39=Choose (1/2):
set t40=Select Encoding Type:
set t41=Error Entering Quantization Value... Not a Number. 
set t42=Quantization Value Set to:
set t43=Encoding Settings:
set t44=Enter Quantization value Minimum 10 Maximum 28:
set t45=Quantization Value Out of  Limits  10 / 28  Re-enter^!
set t46=Enter BitRate Value kbs Minimum 100 Maximum 50000:
set t47=Error Entering BitRate Value... It's Not a Number. 
set t48=BitRate Value Set to:
set t49=BitRate Value Out of Limits  100 / 50000  Re-enter^!
set t50=Select Encoding Quality:
set t51=- Worst Quality
set t52=- Best Quality
set t53=Choose (1/2/3/4/5/6/7):
set t54=Quality Set to:
set t55=Apply Convolution3D denoiser Yes/No: 
set t56=Apply PMD denoiser Yes/No: 
set t57=Apply Detail Enhancement Yes/No:  
set t58=Enhancement Detail: Yes 
set t59=Enhancement Detail: No 
set t60=Info
set t61=Videos to Encode Saved!
set t62=Do You Want to Insert Another Video to Encode (Yes/No):
set t63=The dragged file is not a video!
set t64=Choose (1/2/3/4):
set t65=Press Enter to Back to Main Menu.  

set t66=Video Width
set t67=Video Height
set t68=Video Codec
set t69=Details Video Codec
set t70=Video Format 
set t71=Configuration Settings to convert video from 8bit or 10bit SDR to 10bit HDR
set t72=Select Encoding UpGrader:
set t73=Settings UpGrader:
set t74=Choose (1/2/3):

set t75=Encoding Finished...
set t76=Cleaning and Enhancement Details Started.... 
set t1000=Now the PC will be turned off... 

goto avvio_QSVEncPuliziaLeggeraDettagliMigliorati



:caricalinguaitalianoQSVEncPuliziaLeggeraDettagliMigliorati
@REM set t1=Inserimento Info Codifica Hardware Video 2160p Denoiser Leggero, Miglioramento Dettagli e Salvataggio su Disco.

set t2=Trascina Qui il File Video 2160p 10 bit HDR a cui applicare un Leggero Denoiser e il Miglioramento Dettagli:  
@REM set t211=File Video 2160p 10 bit HDR a cui applicare il Denoiser e il Miglioramento Dettagli:  

set t3=File Inesistente 
set t4=Informazioni Video:  

set t5=Il Video inserito e' 2160p 10 bit HDR 
@REM set t511=Il Video inserito e' 2160p 10bit SDR 

set t6=Il Video inserito non e' 2160p 10bit HDR 

set t7=Durata del Video in secondi:
set t8=Durata del video in Minuti:
set t9=Intervallo tra i Fotogrammi per il Rilevamento del crop:
set t10= secondi
set t11=Rilevamento Bande Nere Iniziato....
set t12=Rilevazione crop fotogramma
set t13=a secondi
set t14=Eseguita...
set t15=Larghezza Video 2160p Originale:
set t16=Altezza Video 2160p Originale:
set t17=Larghezza Video Originale 2160p  Senza Barre Nere:
set t18=Altezza Video Originale 2160p  Senza Barre Nere:

set t171=Larghezza Video 1080p  Senza Barre Nere:
set t181=Altezza Video 1080p  Senza Barre Nere:

set t19=Adattamento della Risoluzione del Video al Pieno Formato 2160p..
set t20=Larghezza Finale Video 2160p:
set t21=Altezza Finale Video 2160p:

set t22=Le Impostazioni delle Bande Nere da Tagliare sono Corrette (Si/No):
set t23=Inserimento Manuale Valori Bande Nere da Tagliare.. 
set t24=Inserisci il Valore della Banda Nera Superiore: 
set t25=Errore nell'Inserimento del Valore della Banda Nera Superiore... Non e' un Numero. 
set t26=Inserisci il Valore della Banda Nera Inferiore: 
set t27=Errore nell'Inserimento del Valore della Banda Nera Inferiore... Non e' un Numero. 
set t28=Inserisci il Valore della Banda Nera Sinistra: 
set t29=Errore nell'Inserimento del Valore della Banda Nera Sinistra... Non e' un Numero. 
set t30=Inserisci il Valore della Banda Nera Destra: 
set t31=Errore nell'Inserimento del Valore della Banda Nera Destra... Non e' un Numero. 
set t32=Banda Nera Superiore:
set t33=Banda Nera Inferiore:
set t34=Banda Nera Sinistra:
set t35=Banda Nera Destra:
set t36=Larghezza Video Originale 2160p senza Bande Nere:
set t37=Altezza Video Originale 2160p senza Bande Nere:

@REM set t361=Larghezza Video 1080p senza Bande Nere:
@REM set t371=Altezza Video 1080p senza Bande Nere:

set t38=Selezionare Scheda Grafica con cui Eseguire la Codifica:
set t39=Scegli (1/2):
set t40=Selezionare tipo di Codifica:
set t41=Errore nell'Inserimento del Valore della Quantizzazione... Non e' un Numero. 
set t42=Valore Quantizzazzione Impostato a:
set t43=Parametri per codifica:

set t44=Inserire Valore Quantizzazione Minimo 10 Massimo 28:
set t45=Valore Quantizzazzione al di fuori dei  Limiti  10 / 28  Reinserire^!
set t46=Inserire Valore BitRate kbs Minimo 100 Massimo 50000:
set t47=Errore nell'Inserimento del Valore del BitRate... Non e' un Numero. 
set t48=Valore BitRate Impostato a:
set t49=Valore  BitRate al di fuori dei  Limiti  100 / 50000  Reinserire^!

set t50=Selezionare Qualita' Codifica:
set t51=- Peggiore Qualita'
set t52=- Migliore Qualita'
set t53=Scegli (1/2/3/4/5/6/7):
set t54=Qualita' Impostata su:
set t55=Applicare il denoiser Convolution3D Si/No: 
set t56=Applicare il denoiser PMD Si/No: 
set t57=Applicare il Miglioramento Dettagli Si/No:  
set t58=Miglioramento Dettagli: Si 
set t59=Miglioramento Dettagli: No 
set t60=Informazioni
set t61=Video da Codificare Salvate!
set t62=Vuoi Inserire un altro Video da Codificare (Si/No):
set t63=Il file trascinato non e' un video!
set t64=Scegli (1/2/3/4):
set t65=Premi Invio per tornare al Menu' Principale. 

set t66=Larghezza Video
set t67=Altezza Video
set t68=Codec Video
set t69=Codec Video Dettagli
set t70=Format Video 
set t71=Configurazione Parametri per convertire il video da 8bit o 10bit SDR a 10bit HDR
set t72=Selezionare UpGrader Codifica:
set t73=UpGrader Impostato:
set t74=Scegli (1/2/3):

set t75=Codifica Terminata...
set t76=Pulizia e Miglioramento Dettagli Iniziati.... 
set t1000=Il PC ora verra' Spento... 

goto avvio_QSVEncPuliziaLeggeraDettagliMigliorati

:avvio_QSVEncPuliziaLeggeraDettagliMigliorati




set /a "numeromovie=1"



:altrivideodainserireNVEnc_QSVEncPuliziaLeggeraDettagliMigliorati


set NomeFile2160ppuliziadettaggli=
rem set MetadatiStreamHDR10=

set /P NomeFile2160ppuliziadettaggli=!t2!
rem echo Hai digitato: %NomeFile%
rem pause

set "NomeFileSorgente=!NomeFile2160ppuliziadettaggli:"=!"
@REM echo NomeFileSorgente = !NomeFileSorgente!
set "NomeFile=^"!NomeFileSorgente!^""
@REM echo NomeFile = !NomeFile!
rem pause


if exist !NomeFile! ( goto infovideo_QSVEncPuliziaLeggeraDettagliMigliorati ) else ( 
                                                        echo.
                                                        echo !t3!
                                                        echo.
                                                        goto fineinfovideo_QSVEncPuliziaLeggeraDettagliMigliorati
                                                        )    



:infovideo_QSVEncPuliziaLeggeraDettagliMigliorati
echo.
echo !t4!
echo.

.\bin\ffprobe -v error -hide_banner -select_streams v:0 -show_entries stream=width,height,codec_name,codec_long_name,pix_fmt,color_space,color_transfer,color_primaries -of default=noprint_wrappers=1 !NomeFile! > "Temp_HDR10_Stream.txt"

set /A x1=1
set /A nohdrcs=0
set /A nohdrct=0
set /A nohdrcp=0
set /A wv=0
set /a hv=0
set /A fv=0

rem echo nohdr = %nohdr%

for /f "tokens=1,2 delims==" %%a in (Temp_HDR10_Stream.txt) do (if !x1!==3 ( 
                                                                            echo !t66! "%%a" = %%b  
                                                                            set /A "widthvideo=%%b"
                                                                            rem echo widthvideo = !widthvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !widthvideo! LEQ 3840 if !widthvideo! GEQ 2000 (set /A "wv=1"
                                                                                                                                rem echo wv = !wv!
                                                                                                                                )
                                                                            )
                                                                if !x1!==4 ( 
                                                                            echo !t67! "%%a" = %%b  
                                                                            set /A "heightvideo=%%b"
                                                                            rem echo heightvideo = !heightvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !heightvideo! LEQ 2160 if !heightvideo! GEQ 1400 (set /A "hv=1"
                                                                                                        rem echo hv = !hv!
                                                                                                        )
                                                                            )                                                           
                                                                if !x1!==6 ( 
                                                                            echo Color Space "%%a" = %%b  
                                                                            set "colorsp=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colorsp!==bt2020nc (set /A "nohdrcs=1"
                                                                                                    rem echo nohdr = !nohdr!
                                                                                                    )
                                                                            if !colorsp!==unknown (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorsp!==reserved (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                    
                                                                            ) 
                                                                if !x1!==7 ( 
                                                                            echo Color Transfer "%%a" = %%b  
                                                                            set "colortr=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colortr!==smpte2084 (set /A "nohdrct=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            ) 
                                                                if !x1!==8 ( 
                                                                            echo Color Primaries "%%a" = %%b  
                                                                            set "colorpr=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colorpr!==bt2020 (set /A "nohdrcp=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )           
                                                                            )    
                                                                if !x1!==1 ( 
                                                                            echo !t68! "%%a" = %%b  
                                                                            )       
                                                                if !x1!==2 ( 
                                                                            echo !t69! "%%a" = %%b  
                                                                            )   
                                                                if !x1!==5 ( 
                                                                            echo !t70! "%%a" = %%b  
                                                                            set "formatvideo=%%b"
                                                                            rem echo formatvideo = !formatvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !formatvideo!==yuv420p10le (set /A "fv=1"
                                                                                                            rem echo fv = !fv!
                                                                                                            )
                                                                            )
                                                                set /A x1+=1                                                            
)
echo.

if !x1!==1 goto novideofile2160p_QSVEncPuliziaLeggeraDettagliMigliorati


if !nohdrcs!==1 if !nohdrct!==1 if !nohdrcp!==1 if !wv!==1 if !hv!==1 if !fv!==1 ( 
                                                                                   echo !t5!
                                                                                   goto rilevazionebandenere_QSVEncPuliziaLeggeraDettagliMigliorati
                                                                                   ) 
echo !t6!
echo.
goto fineinfovideo_QSVEncPuliziaLeggeraDettagliMigliorati


rem//////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////

:rilevazionebandenere_QSVEncPuliziaLeggeraDettagliMigliorati

.\bin\ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 !NomeFile!  > ".\temp\durata_film.txt"

set /a contatore=1
for /f "tokens=1 delims=." %%a in (.\temp\durata_film.txt) do  (
                                                        echo. 
                                                        echo !t7! %%a
                                                        set /a "secondi=%%a"
                                                        set /a "minuti=!secondi!/60"
                                                        echo !t8! !minuti!
                                                        set /a "intervallo_tagli=!secondi!/11"
                                                        echo !t9! !intervallo_tagli!!t10!
                                                        echo.
                                                        echo !t11!
                                                        echo.

                                                        

                                                        FOR /L %%a IN (1, 1, 10) DO (
                                                                                    rem echo %%a
                                                                                    set /a "secondi=%%a*!intervallo_tagli!"
                                                                                    rem echo !secondi!

                                                                                    
                                                                                    set /a "ca=72"
                                                                                    rem echo !ca!
                                                                                                                    
                                                                                    set /a "cb=2"
                                                                                    rem echo !cb!
                                                                                                                    
                                                                                    set /a "cc=0"
                                                                                    rem echo !cc!

                                                                                    set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                    rem echo !cr!
        
                                                                                
                                                                                    .\bin\ffmpeg -ss !secondi! -hide_banner -nostats -i !NomeFile! -vframes 10 -vf !cr! -f null - 2> ".\temp\crop.txt"
                                                                                    
                                                                                    findstr /r "Parsed_cropdetect_0" .\temp\crop.txt >> .\temp\risultato_multiplo.txt   
                                                                                    
                                                                                    echo !t12! %%a !t13! !secondi! !t14!
                                                                                    
                                                                                    )       
                                                                                       

                                                                                    for /f "tokens=1,2 delims==" %%a in (.\temp\risultato_multiplo.txt) do ( echo %%b >> .\temp\crop_multiplo.txt )
                                                                                    
                                                                                    set /a "maxfrequenza=0"

                                                                                    for /f "delims=" %%a in (.\temp\crop_multiplo.txt) do ( 
                                                                                                                                    set "cropconfront=%%a"
                                                                                                                                    rem echo "!cropconfront!"
                                                                                                                                    
                                                                                                                                    set /a "contatorfrequenza=0"
                                                                                                                                    for /f "delims=" %%b in (.\temp\crop_multiplo.txt) do (
                                                                                                                                                                                    set "dato_da_verificare=%%b"
                                                                                                                                                                                    rem echo cropconfront = "!cropconfront!"
                                                                                                                                                                                    rem echo dato_da_verificare = "!dato_da_verificare!"
                                                                                                                                                                                    if !cropconfront!==!dato_da_verificare! ( set /a "contatorfrequenza+=1")
                                                                                                                                                                                    )
                                                                                                                                    if !maxfrequenza! LSS !contatorfrequenza! ( 
                                                                                                                                                                                set /a "maxfrequenza=!!contatorfrequenza!!"
                                                                                                                                                                                set "cropd=!cropconfront!"
                                                                                                                                                                                )
                                                                                                                                    

                                                                                                                                    rem if !cropconfront! in (elenco_crop_frequenza.txt) ()
                                                                                                                                    rem echo !cropconfront!:!contatorfrequenza! >> elenco_crop_frequenza.txt

                                                                                                                                    )

                                                                                    rem echo crop piu' frequente = !cropd! con grequenza = !maxfrequenza!
                                                                                    echo !cropd! > .\temp\crop_finale.txt

                                                                                    for /f "tokens=1,2,3,4 delims=:" %%a in (.\temp\crop_finale.txt) do  ( 
                                                                                                                                                    rem set /a "mwidth=%%a"
                                                                                                                                                    rem echo mwidth = !mwidth!

                                                                                                                                                    rem set /a "mheight=%%b"
                                                                                                                                                    rem echo mheight = !mheight!

                                                                                                                                                    rem set /a "mx=%%c"
                                                                                                                                                    rem echo mx = !mx!

                                                                                                                                                    rem set /a "my=%%d"
                                                                                                                                                    rem echo my = !my!

                                                                                                                                                    if !contatore!==1 ( 
                                                                                                                                                                set /a "wmax=%%a" 
                                                                                                                                                                set /a "hmax=%%b"
                                                                                                                                                                set /a "xmin=%%c"
                                                                                                                                                                set /a "ymin=%%d"
                                                                                                                                                                set /a "mwidth=%%a"
                                                                                                                                                                set /a "mheight=%%b"
                                                                                                                                                                set /a "mx=%%c"
                                                                                                                                                                set /a "my=%%d"
                                                                                                                                                                set /a "contatore+=1"
                                                                                                                                                                )
                                                                                                                                                    
                                                                                                                                                    rem if %%b gtr !hmax! if %%c gtr !xmin! if %%d gtr !ymin! 

                                                                                                                                                    if %%a geq !wmax! if %%b geq !hmax! ( 
                                                                                                                                                                        set /a "wmax=%%a" 
                                                                                                                                                                        set /a "hmax=%%b"
                                                                                                                                                                        set /a "xmin=%%c"
                                                                                                                                                                        set /a "ymin=%%d"
                                                                                                                                                                        set /a "mwidth=%%a"
                                                                                                                                                                        set /a "mheight=%%b"
                                                                                                                                                                        set /a "mx=%%c"
                                                                                                                                                                        set /a "my=%%d"
                                                                                                                                                                        )
                                                                                                                                                    )
                                                                                    echo.

                                                                                    set /a "mwidth=!mwidth!/2*2"
                                                                                    set /a "mheight=!mheight!/2*2"

                                                                                    set /a "csup=!my!"
                                                                                    rem echo csup = !csup!
                                                                                                                                    
                                                                                    set /a "csin=!mx!"
                                                                                    rem echo csin = !csin!

                                                                                    set /a "cinf=!heightvideo!-!mheight!-!my!"
                                                                                    rem echo movieheightreal = !movieheightreal!
                                                                                    rem echo cinf = !cinf!
                                                                                    set /a "cdes=!widthvideo!-!mwidth!-!mx!"
                                                                                    rem echo cdes = !cdes!

                                                                                    set /a "Width4k=!mwidth!"
                                                                                    set /a "height4k=!mheight!"
                                                                                    
                                                                                    echo Crop Setting: --crop !csin!,!csup!,!cdes!,!cinf!  
                                                                                    set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"  
                                                                                    echo.  
                                                                                    
                                                                                    echo !t17!  !width4k! 
                                                                                    echo !t18!  !height4k! 
                                                                                    echo.

                                                                                    set /a "larghezza2160pnvenc=3840"
                                                                                    set /a "altezza2160pnvenc=2160"
                                                                                    @REM echo larghezza2160pnvenc = !larghezza2160pnvenc!                                    
                                                                                    @REM echo altezza2160pnvenc = !altezza2160pnvenc!                                    

                                                                                    set /a "differenzialelarghezza2160pnvenc=!larghezza2160pnvenc!-!mwidth!"
                                                                                    set /a "differenzialealtezza2160pnvenc=!altezza2160pnvenc!-!mheight!"
                                                                                    @REM echo differenzialelarghezza2160pnvenc = !differenzialelarghezza2160pnvenc!                                                                
                                                                                    @REM echo differenzialealtezza2160pnvenc = !differenzialealtezza2160pnvenc!

                                                                                    if !differenzialelarghezza2160pnvenc!==0 if !differenzialealtezza2160pnvenc! GTR 0 (
                                                                                                                                                                        @REM echo dentro il 1o if
                                                                                                                                                                        set /a "width4k=!mwidth!"
                                                                                                                                                                        set /a "height4k=!mheight!"
                                                                                                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                                                                                                        if !differenzialelarghezza2160pnvenc! GTR 0 if !differenzialealtezza2160pnvenc!==0 (
                                                                                                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                                                                                                set /a "width4k=!mwidth!"
                                                                                                                                                                                                                                                                set /a "height4k=!mheight!"
                                                                                                                                                                                                                                                                ) else if !differenzialelarghezza2160pnvenc! LSS !differenzialealtezza2160pnvenc! (
                                                                                                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza2160pnvenc = !differenzialelarghezza2160pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza2160pnvenc = !differenzialealtezza2160pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                                                                                                        set /a "width4k=!mwidth!+!differenzialelarghezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        set /a "height4k=!mheight!+!differenzialelarghezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        @REM echo width4k = !width4k!
                                                                                                                                                                                                                                                                                                                                                        @REM echo height4k = !height4k!
                                                                                                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza2160pnvenc! GTR !differenzialealtezza2160pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "width4k=!mwidth!+!differenzialealtezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo width4k = !width4k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "height4k=!mheight!+!differenzialealtezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo height4k = !height4k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                if !differenzialelarghezza2160pnvenc!==0 if !differenzialealtezza2160pnvenc!==0 (   
                                                                                                                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                                                                                                                set /a "width4k=!mwidth!"
                                                                                                                                                                                                                                                                set /a "height4k=!mheight!"
                                                                                                                                                                                                                                                                )
                                                                                                                                                                        
                                                                                                                                                                                if !differenzialelarghezza2160pnvenc!==!differenzialealtezza2160pnvenc! (   
                                                                                                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                                                                                                        set /a "width4k=!mwidth!+differenzialelarghezza2160pnvenc"
                                                                                                                                                                                                                                                        set /a "height4k=!mheight!+differenzialelarghezza2160pnvenc"
                                                                                                                                                                                                                                                        )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.                         

                                                                                        echo !t20!  !width4k! 
                                                                                        echo !t21!  !height4k!    
                                                                                        echo.

                                                                                    ) 
                                                        )                          

:inizioinserimentomanualecrop_QSVEncPuliziaLeggeraDettagliMigliorati
set /a "csup=0"
set /a "cinf=0"
set /a "csin=0"
set /a "cdes=0"
set /a "bandasuperiore=0"
set /a "bandainferiore=0"
set /a "bandasinistra=0"
set /a "bandadestra=0"
set /a "differenzialelarghezza1080pnvenc=0"
set /a "differenzialealtezza1080pnvenc=0"
if exist ".\temp\Temp_HDR10_Stream.txt" ( del .\temp\Temp_HDR10_Stream.txt )
if exist ".\temp\durata_film.txt" ( del .\temp\durata_film.txt )
if exist ".\temp\crop.txt" ( del .\temp\crop.txt )
if exist ".\temp\risultato_multiplo.txt" ( del .\temp\risultato_multiplo.txt )
if exist ".\temp\crop_multiplo.txt" ( del .\temp\crop_multiplo.txt )
if exist ".\temp\crop_finale.txt" ( del .\temp\crop_finale.txt )  

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t22!"   
    if errorlevel 2 goto inserimentomanualecrop_QSVEncPuliziaLeggeraDettagliMigliorati
    if errorlevel 1 goto finecrop_QSVEncPuliziaLeggeraDettagliMigliorati
)

CHOICE /N /C:SN /M "!t22!"   

if errorlevel 2 goto inserimentomanualecrop_QSVEncPuliziaLeggeraDettagliMigliorati
if errorlevel 1 goto finecrop_QSVEncPuliziaLeggeraDettagliMigliorati

:inserimentomanualecrop_QSVEncPuliziaLeggeraDettagliMigliorati
echo.
echo !t23!
echo.

:banda_superiore_QSVEncPuliziaLeggeraDettagliMigliorati
set /p "bandasuperiore=!t24!"
SET "var="&for /f "delims=0123456789" %%i in ("!bandasuperiore!") do set var=!bandasuperiore!
if defined var (
                echo.
                echo !t25!
                echo.
                goto banda_superiore_QSVEncPuliziaLeggeraDettagliMigliorati
                ) else (
                        set /a "csup=!bandasuperiore!/2*2"
                        )

echo.
:banda_inferiore_QSVEncPuliziaLeggeraDettagliMigliorati
set /p "bandainferiore=!t26!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandainferiore!") do set var=!bandainferiore!
if defined var (
                echo.
                echo !t27!
                echo.
                goto banda_inferiore_QSVEncPuliziaLeggeraDettagliMigliorati
                ) else (
                        set /a "cinf=!bandainferiore!/2*2"
                        )


echo.
:banda_sinistra_QSVEncPuliziaLeggeraDettagliMigliorati
set /p "bandasinistra=!t28!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandasinistra!") do set var=!bandasinistra!
if defined var (
                echo.
                echo !t29!
                echo.
                goto banda_sinistra_QSVEncPuliziaLeggeraDettagliMigliorati
                ) else (
                        set /a "csin=!bandasinistra!/2*2"
                        )

                        
echo.
:banda_destra_QSVEncPuliziaLeggeraDettagliMigliorati
set /p "bandadestra=!t30!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandadestra!") do set var=!bandadestra!
if defined var (
                echo.
                echo !t31!
                echo.
                goto banda_destra_QSVEncPuliziaLeggeraDettagliMigliorati
                ) else (
                        set /a "cdes=!bandadestra!/2*2"
                        )


set /a "larghezza2160pnvenc=3840"
set /a "altezza2160pnvenc=2160"
@REM echo larghezza2160pnvenc = !larghezza2160pnvenc!                                    
@REM echo altezza2160pnvenc = !altezza2160pnvenc!                                    

set /a "mwidth=!widthvideo!/2*2"
set /a "mheight=!heightvideo!/2*2"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "mwidthc=!mwidth!-!csin!-!cdes!"
set /a "mheightc=!mheight!-!csup!-!cinf!"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "differenzialelarghezza2160pnvenc=!larghezza2160pnvenc!-!mwidthc!"
set /a "differenzialealtezza2160pnvenc=!altezza2160pnvenc!-!mheightc!"
@REM echo differenzialelarghezza2160pnvenc = !differenzialelarghezza2160pnvenc!                                                                
@REM echo differenzialealtezza2160pnvenc = !differenzialealtezza2160pnvenc!

echo.
echo !t32!  !csup! 
echo !t33!  !cinf! 
echo !t34!  !csin! 
echo !t35!  !cdes! 
echo.


set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
echo Crop Settings: !cropff!
echo.

echo !t17!  !mwidthc! 
echo !t18!  !mheightc! 
echo.



if !differenzialelarghezza2160pnvenc!==0 if !differenzialealtezza2160pnvenc! GTR 0 (
                                                                                        @REM echo dentro il 1o if
                                                                                        set /a "width4k=!mwidthc!"
                                                                                        set /a "height4k=!mheightc!"
                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                        if !differenzialelarghezza2160pnvenc! GTR 0 if !differenzialealtezza2160pnvenc!==0 (
                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                set /a "width4k=!mwidthc!"
                                                                                                                                                                                set /a "height4k=!mheightc!"
                                                                                                                                                                                ) else if !differenzialelarghezza2160pnvenc! LSS !differenzialealtezza2160pnvenc! (
                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza2160pnvenc = !differenzialelarghezza2160pnvenc!
                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza2160pnvenc = !differenzialealtezza2160pnvenc!
                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                        set /a "width4k=!mwidthc!+!differenzialelarghezza2160pnvenc!"
                                                                                                                                                                                                                                                                        set /a "height4k=!mheightc!+!differenzialelarghezza2160pnvenc!"
                                                                                                                                                                                                                                                                        @REM echo width4k = !width4k!
                                                                                                                                                                                                                                                                        @REM echo height4k = !height4k!
                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza2160pnvenc! GTR !differenzialealtezza2160pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                set /a "width4k=!mwidthc!+!differenzialealtezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo width4k = !width4k!
                                                                                                                                                                                                                                                                                                                                                                set /a "height4k=!mheightc!+!differenzialealtezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo height4k = !height4k!
                                                                                                                                                                                                                                                                                                                                                                )
                                                                                        if !differenzialelarghezza2160pnvenc!==0 if !differenzialealtezza2160pnvenc!==0 (   
                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                        set /a "width4k=!mwidthc!"
                                                                                                                                                                        set /a "height4k=!mheightc!"
                                                                                                                                                                        )
                                                                                                                                                                        
                                                                                        if !differenzialelarghezza2160pnvenc!==!differenzialealtezza2160pnvenc! (   
                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                set /a "width4k=!mwidthc!+differenzialelarghezza2160pnvenc"
                                                                                                                                                                set /a "height4k=!mheightc!+differenzialelarghezza2160pnvenc"
                                                                                                                                                                )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.                         

                                                                                        echo !t20!  !width4k! 
                                                                                        echo !t21!  !height4k!    
                                                                                        echo.

                                                                                    ) 

goto inizioinserimentomanualecrop_QSVEncPuliziaLeggeraDettagliMigliorati

:finecrop_QSVEncPuliziaLeggeraDettagliMigliorati


:InserimentoImpostazioniQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati

echo.
echo !t40!
echo.
echo 1) CQP 
echo 2) ICQ 
echo 3) LA-ICQ 
echo 4) VBR 
echo.
CHOICE /N /C:1234 /M "!t64!"

if errorlevel 4 goto CodificaVBRQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
if errorlevel 3 goto CodificaLAICQQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
if errorlevel 2 goto CodificaICQQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
if errorlevel 1 goto CodificaCQPQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati


:CodificaCQPQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
set "TipoCodificaQSVEnc=--cqp "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati

:CodificaICQQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
set "TipoCodificaQSVEnc=--icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati

:CodificaLAICQQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
set "TipoCodificaQSVEnc=--la-icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati

:CodificaVBRQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
set "TipoCodificaQSVEnc=--vbr "
set /a "quantizzazioneQSVEnc=0"
goto inserimentoValoriCQPVBRQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati


:inserimentoValoriCQPVBRQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati

if !quantizzazioneQSVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneQSVEnc=!t44! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneQSVEnc!") do set var=!valoreQuantizzazioneQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                goto inserimentoValoriCQPVBRQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
                                                ) 

                                set /a "valoreQuantizzazioneQSVEnc=!valoreQuantizzazioneQSVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneQSVEnc!
                                if !valoreQuantizzazioneQSVEnc! GEQ 10 if !valoreQuantizzazioneQSVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneQSVEnc!
                                                                                                                set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreQuantizzazioneQSVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                                goto fineQuantizzazioneQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
                                                                                                                        
                                )



if !quantizzazioneQSVEnc!==0 (
                                echo.
                                set /p "valoreBitRateQSVEnc=!t46! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateQSVEnc!") do set var=!valoreBitRateQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                goto inserimentoValoriCQPVBRQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
                                                ) 
                                set /a "valoreBitRateQSVEnc=!valoreBitRateQSVEnc!"
                                @REM echo valoreBitRateQSVEnc = !valoreBitRateQSVEnc!
                                if !valoreBitRateQSVEnc! GEQ 100 if !valoreBitRateQSVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateQSVEnc!
                                                                                                        set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreBitRateQSVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                        goto fineQuantizzazioneQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
                                                                                                              
                                )

:fineQuantizzazioneQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati


echo.
echo !t50!
echo.
echo 1) Best 
echo 2) Higher 
echo 3) High 
echo 4) Balanced 
echo 5) Fast 
echo 6) Faster 
echo 7) Fastest 
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto QualitFastestQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
if errorlevel 6 goto QualitFasterQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
if errorlevel 5 goto QualitFastQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
if errorlevel 4 goto QualitBalancedtQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
if errorlevel 3 goto QualitHighQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
if errorlevel 2 goto QualitHigherQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
if errorlevel 1 goto QualitBestQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati


:QualitBestQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
set "SettaggioQualitaQSvenc=--quality best"
set "QualitySetting=best"
goto fineQualitCodificaQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati

:QualitHigherQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
set "SettaggioQualitaQSvenc=--quality higher"
set "QualitySetting=higher"
goto fineQualitCodificaQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati

:QualitHighQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
set "SettaggioQualitaQSvenc=--quality high"
set "QualitySetting=high"
goto fineQualitCodificaQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati

:QualitBalancedtQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
set "SettaggioQualitaQSvenc=--quality balanced"
set "QualitySetting=balanced"
goto fineQualitCodificaQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati

:QualitFastQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
set "SettaggioQualitaQSvenc=--quality fast"
set "QualitySetting=fast"
goto fineQualitCodificaQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati

:QualitFasterQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
set "SettaggioQualitaQSvenc=--quality faster"
set "QualitySetting=faster"
goto fineQualitCodificaQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati

:QualitFastestQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
set "SettaggioQualitaQSvenc=--quality fastest"
set "QualitySetting=fastest"
goto fineQualitCodificaQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati


:fineQualitCodificaQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaQSvenc!

rem/////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////

:sceltadenoiserQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
set conv3d1080p=
set pmd1080p=

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t55!"
    if errorlevel 2 goto conv3dChoosenNoQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
    if errorlevel 1 goto conv3dChoosenYesQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
)
echo.
CHOICE /N /C:SN /M "!t55!"

if errorlevel 2 goto conv3dChoosenNoQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
if errorlevel 1 goto conv3dChoosenYesQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati

:conv3dChoosenNoQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
set "conv3d1080p=N"
goto sceltaDeniserPMDQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati

:conv3dChoosenYesQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
set "conv3d1080p=S"


:sceltaDeniserPMDQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
:sceltaDeniserPMDQSVEncUpGrading_InserimentoUpGradingda2160p810bitSDRa2160p10bitHDR10
if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t56!"
    if errorlevel 2 goto PMDChoosenNoQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
    if errorlevel 1 goto PPMDChoosenYesQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
)
echo.
CHOICE /N /C:SN /M "!t56!"

if errorlevel 2 goto PMDChoosenNoQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
if errorlevel 1 goto PPMDChoosenYesQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati

:PMDChoosenNoQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
set "pmd1080p=N"
goto assegnazioneDenoisesQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati

:PPMDChoosenYesQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
set "pmd1080p=S"


:assegnazioneDenoisesQSVEnc_QSVEncPuliziaLeggeraDettagliMigliorati
set /A nvdenv=0

if !conv3d1080p!==S if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00 --vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==S if !pmd1080p!==N ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==N ( 
                                        set "nvdenoiser=" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: Nessun Denoiser 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )


@REM pause




echo.
echo !t76!
echo.


set file_senza_virgolette=!NomeFile:"=!
rem echo %file_senza_virgolette%

set file_senza_estensione=!file_senza_virgolette:.mkv=!
rem echo %file_senza_estensione%

set fileoutput2160p="!file_senza_estensione!_Denoiser_Leggero_Dettagli_Migliorati.mkv"
rem echo fileoutput2160p = %fileoutput2160p%



set fileoutput2160p_senza_virgolette=%fileoutput2160p:"=% 
rem echo %fileoutput2160p_senza_virgolette%

for %%i in ("%fileoutput2160p_senza_virgolette%") do (  
                                                        set "solo_nome_file=%%~ni"
                                                        rem echo Nome file: !solo_nome_file!

                                                        set "solo_estensione_file=%%~xi"
                                                        rem echo Estensione: !solo_estensione_file!
                                                    )

set fileoutput2160p_rinominato=!solo_nome_file!_rinominato!solo_estensione_file!

if exist "Temp_HDR10_Stream.txt" ( del Temp_HDR10_Stream.txt )
if exist "durata_film.txt" ( del durata_film.txt )
if exist "crop.txt" ( del crop.txt )
if exist "risultato_multiplo.txt" ( del risultato_multiplo.txt )
if exist "crop_multiplo.txt" ( del crop_multiplo.txt )
if exist "crop_finale.txt" ( del crop_finale.txt )

rem echo %fileoutput2160p_rinominato%


".\bin\qsvencc\QSVEncC64.exe" --avsw --device auto -i !NomeFile!  !cropff!  --output-res !width4k!x!height4k! --video-metadata clear --metadata clear --chapter-copy -c hevc !tipoQuantizzazioneQSVEnc! !SettaggioQualitaQSVEnc! --la-depth 32  --level auto  --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display copy --max-cll copy --output-depth 10  --avsync cfr --psnr --ssim     -m default_mode:infer_no_subs    !nvdenoiser!  --vpp-resize algo=lanczos4  --vpp-edgelevel strength=10.0,threshold=24.0,black=6.0  --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o %fileoutput2160p%


ren %fileoutput2160p% "%fileoutput2160p_rinominato%"



echo.
echo !t75!
echo.


rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////




goto fineinfovideo_QSVEncPuliziaLeggeraDettagliMigliorati




:novideofile2160p_QSVEncPuliziaLeggeraDettagliMigliorati
echo !t63!
echo.


:fineinfovideo_QSVEncPuliziaLeggeraDettagliMigliorati

if exist ".\saved\settings.dat" (
                                for /f "tokens=1,2 delims=|" %%a in (.\saved\settings.dat) do (
                                                                                                    rem echo %%a
                                                                                                    rem echo %%b
                                                                                                    set /a "shst=%%b"
                                                                                                    rem echo !shst!
                                                                                                    rem pause
                                                                                                    if !shst!==1 (
                                                                                                                echo !t1000!
                                                                                                                echo.
                                                                                                                shutdown /s
                                                                                                                set /a "delay=10"
                                                                                                                timeout /t !delay!
                                                                                                                exit
                                                                                                                )
                                                                                                                            
                                                                                                    )                                                                                                  
                                                                                                )

if exist ".\temp\Temp_HDR10_Stream.txt" ( del .\temp\Temp_HDR10_Stream.txt )
if exist ".\temp\durata_film.txt" ( del .\temp\durata_film.txt )
if exist ".\temp\crop.txt" ( del .\temp\crop.txt )
if exist ".\temp\risultato_multiplo.txt" ( del .\temp\risultato_multiplo.txt )
if exist ".\temp\crop_multiplo.txt" ( del .\temp\crop_multiplo.txt )
if exist ".\temp\crop_finale.txt" ( del .\temp\crop_finale.txt )
      




set waitenter=
set /P waitenter=!t65!
Endlocal
goto menuiniziale



rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:FFmpegSempliceCodifica
cls
setLocal EnableExtensions EnableDelayedExpansion


for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoFFmpegSempliceCodifica
)

if %lingua%==inglese (
    goto caricalinguaingleseFFmpegSempliceCodifica
)



:caricalinguaingleseFFmpegSempliceCodifica
@REM set t1=Insert Info FFmpeg Video Software Encoding and Saving to Disk

set t2=Drag Here the Video File to Encode: 
@REM set t211=Video File to Encode:  

set t3=File does not exist 
set t4=Info Video:  

set t5=The Inserted Video is 2160p 8bit SDR 
set t511=The Inserted Video is 2160p 10bit SDR 

set t6=The Inserted Video isn't 2160p 8bit or 10bit SDR 
set t7=Video Duration in seconds:
set t8=Video Duration in Minutes:
set t9=Interval between Frames for Crop Detection:
set t10= seconds
set t11=Black Bands Detection Started....
set t12=Crop Detection to Frame
set t13=to seconds
set t14=Done...
set t15=Original 2160p Video Width: 
set t16=Original 2160p Video Height:
set t17=Video Width Without Black Bars:
set t18=Video Height Without Black Bars:

set t171=Output Video 1080p Width Without Black Bars:
set t181=Outout Video 1080p Height Without Black Bars:

set t19=Adapting Video Resolution to Full 2160p Format...
set t20=Final 2160p Output Video Width:
set t21=Final 2160p Output Video Height:

set t22=Settings of Black Bands to Crop are Correct (Yes/No):
set t23=Manually Entering Black Bands Values to Crop... 
set t24=Enter the Upper Black Band Value: 
set t25=Error Entering Upper Black Band Value... It's Not a Number. 
set t26=Enter the Lower Black Band Value: 
set t27=Error Entering Lower Black Band Value... It's Not a Number.
set t28=Enter the Left Black Band Value: 
set t29=Error Entering Left Black Band Value... It's Not a Number.
set t30=Enter the Right Black Band Value: 
set t31=Error Entering Right Black Band Value... It's Not a Number.
set t32=Upper Black Band:
set t33=Lower Black Band:
set t34=Left Black Band:
set t35=Right Black Band:
set t36=2160p Original Video Width without Black Bars:
set t37=2160p Original Video Height without Black Bars:

@REM set t361=1080p Video Width without Black Bars:
@REM set t371=1080p Video Height without Black Bars

set t38=Select Graphic Card you want to Encode with:
set t39=Choose (1/2):
set t40=Select Encoding Type:
set t41=Error Entering Quantization Value... Not a Number. 
set t42=Quantization Value Set to:
set t43=Encoding Settings:
set t44=Enter Quantization value Minimum 10 Maximum 28:
set t45=Quantization Value Out of  Limits  10 / 28  Re-enter^!
set t46=Enter BitRate Value kbs Minimum 100 Maximum 50000:
set t47=Error Entering BitRate Value... It's Not a Number. 
set t48=BitRate Value Set to:
set t49=BitRate Value Out of Limits  100 / 50000  Re-enter^!
set t50=Select Encoding Quality:
set t51=- Worst Quality
set t52=- Best Quality
set t53=Choose (1/2/3/4/5/6/7):
set t54=Quality Set to:
set t55=Apply Convolution3D denoiser Yes/No: 
set t56=Apply PMD denoiser Yes/No: 
set t57=Apply Detail Enhancement Yes/No:  
set t58=Enhancement Detail: Yes 
set t59=Enhancement Detail: No 
set t60=Info
set t61=Videos to Encode Saved!
set t62=Do You Want to Insert Another Video to Encode (Yes/No):
set t63=The dragged file is not a video!
set t64=Choose (1/2/3/4):
set t65=Press Enter toback to Menu Inserting Encoding into the Queue and Saving to Disk:  

set t66=Video Width
set t67=Video Height
set t68=Video Codec
set t69=Details Video Codec
set t70=Video Format 
set t71=Configuration Settings to convert video from 8bit or 10bit SDR to 10bit HDR
set t72=Select Encoding UpGrader:
set t73=Settings UpGrader:
set t74=Choose (1/2/3):

set t75=Dolby Vision Metadata Present 
set t76=HDR10+ Metadata Present 
set t77=FFmpeg x265 Settings:  

set t78=Insert CRF Value Minimum 10 Maximum 28:
set t79=Error Entering CRF value... It is not a number. 
set t80=CRF Value Set to:
set t81=CRF Value Out of Limits  10 / 28  Re-enter^!

set t82=Select Encoding Speed-Quality:
set t83=- Worst Quality - The Faster Encoding
set t84=- Recommended
set t85=- Best Quality - The Slowest Encoding
set t86=Choose (1/2/3/4/5/6/7/8/9/0):
set t87=Speed-Quality Set to:

set t88=Select Type of Adptive Quantization:
set t89=1) Disabled 
set t90=2) Enabled 
set t91=3) Enabled + Auto-Variance 
set t92=4) Enabled + Auto-Variance + Dark Bias 
set t93=5) Enabled + Auto-Variance + Edge
set t94=Choose (1/2/3/4/5):
set t95=Adaptive Quantization Set to:
set t96=Select Value of Adaptive Quantization Strength:
set t97=- Worst Quality - Smaller File
set t98=- Best Quality - Bigger File
set t99=Adaptive Quantization Strength Set to:

set t100=Select Denoiser Filter:
set t101=1) No one 
set t102=Selected Denoiser:
set t103=Select Denoiser Strength:
set t104=1) Weak 
set t105=2) Moderate 
set t106=3) Strong 

set t107=The video has no Master Display Metadata.

set t108=Enabled + Auto-Variance + Edge
set t109=Enabled + Auto-Variance + Dark Bias
set t110=Enabled + Auto-Variance
set t111=Enabled 
set t112=93mDisabled

set t113=No Denoiser
set t114=FFmpeg Encoding Finished.... 
set t115=Press Enter to Back to Main Menu.  
set t1000=Now the PC will be turned off... 


goto avvio_FFmpegSempliceCodifica



:caricalinguaitalianoFFmpegSempliceCodifica
@REM set t1=Inserimento Informazioni FFmpeg Codifica Software Video e Salvataggio su Disco.

set t2=Trascina Qui il File Video da Codificare:  
@REM set t211=File Video da Codificare:  

set t3=File Inesistente 
set t4=Informazioni Video:  

set t5=Il Video inserito e' 2160p 8bit SDR 
set t511=Il Video inserito e' 2160p 10bit SDR 

set t6=Il Video inserito non e' 2160p 8bit o 10bit SDR 

set t7=Durata del Video in secondi:
set t8=Durata del video in Minuti:
set t9=Intervallo tra i Fotogrammi per il Rilevamento del crop:
set t10= secondi
set t11=Rilevamento Bande Nere Iniziato....
set t12=Rilevazione crop fotogramma
set t13=a secondi
set t14=Eseguita...
set t15=Larghezza Video 2160p Originale:
set t16=Altezza Video 2160p Originale:
set t17=Larghezza Video Senza Barre Nere:
set t18=Altezza Video Senza Barre Nere:

set t171=Larghezza Video 1080p  Senza Barre Nere:
set t181=Altezza Video 1080p  Senza Barre Nere:

set t19=Adattamento della Risoluzione del Video al Pieno Formato 2160p..
set t20=Larghezza Finale Video 2160p:
set t21=Altezza Finale Video 2160p:

set t22=Le Impostazioni delle Bande Nere da Tagliare sono Corrette (Si/No):
set t23=Inserimento Manuale Valori Bande Nere da Tagliare.. 
set t24=Inserisci il Valore della Banda Nera Superiore: 
set t25=Errore nell'Inserimento del Valore della Banda Nera Superiore... Non e' un Numero. 
set t26=Inserisci il Valore della Banda Nera Inferiore: 
set t27=Errore nell'Inserimento del Valore della Banda Nera Inferiore... Non e' un Numero. 
set t28=Inserisci il Valore della Banda Nera Sinistra: 
set t29=Errore nell'Inserimento del Valore della Banda Nera Sinistra... Non e' un Numero. 
set t30=Inserisci il Valore della Banda Nera Destra: 
set t31=Errore nell'Inserimento del Valore della Banda Nera Destra... Non e' un Numero. 
set t32=Banda Nera Superiore:
set t33=Banda Nera Inferiore:
set t34=Banda Nera Sinistra:
set t35=Banda Nera Destra:
set t36=Larghezza Video Originale 2160p senza Bande Nere:
set t37=Altezza Video Originale 2160p senza Bande Nere:

@REM set t361=Larghezza Video 1080p senza Bande Nere:
@REM set t371=Altezza Video 1080p senza Bande Nere:

set t38=Selezionare Scheda Grafica con cui Eseguire la Codifica:
set t39=Scegli (1/2):
set t40=Selezionare tipo di Codifica:
set t41=Errore nell'Inserimento del Valore della Quantizzazione... Non e' un Numero. 
set t42=Valore Quantizzazzione Impostato a:
set t43=Parametri per codifica:

set t44=Inserire Valore Quantizzazione Minimo 10 Massimo 28:
set t45=Valore Quantizzazzione al di fuori dei  Limiti  10 / 28  Reinserire^!
set t46=Inserire Valore BitRate kbs Minimo 100 Massimo 50000:
set t47=Errore nell'Inserimento del Valore del BitRate... Non e' un Numero. 
set t48=Valore BitRate Impostato a:
set t49=Valore  BitRate al di fuori dei  Limiti  100 / 50000  Reinserire^!

set t50=Selezionare Qualita' Codifica:
set t51=- Peggiore Qualita'
set t52=- Migliore Qualita'
set t53=Scegli (1/2/3/4/5/6/7):
set t54=Qualita' Impostata su:
set t55=Applicare il denoiser Convolution3D Si/No: 
set t56=Applicare il denoiser PMD Si/No: 
set t57=Applicare il Miglioramento Dettagli Si/No:  
set t58=Miglioramento Dettagli: Si 
set t59=Miglioramento Dettagli: No 
set t60=Informazioni
set t61=Video da Codificare Salvate!
set t62=Vuoi Inserire un altro Video da Codificare (Si/No):
set t63=Il file trascinato non e' un video!
set t64=Scegli (1/2/3/4):
set t65=Premi Invio per tornare al menu' Inserimento Codifiche in Coda e Salvataggio sul Disco:  

set t66=Larghezza Video
set t67=Altezza Video
set t68=Codec Video
set t69=Codec Video Dettagli
set t70=Format Video 
set t71=Configurazione Parametri per convertire il video da 8bit o 10bit SDR a 10bit HDR
set t72=Selezionare UpGrader Codifica:
set t73=UpGrader Impostato:
set t74=Scegli (1/2/3):

set t75=Metadati Dolby Vision Presenti 
set t76=Metadati HDR10+ Presenti  
set t77=FFmpeg Parametri x265:  

set t78=Inserire Valore CRF Minimo 10 Massimo 28:
set t79=Errore nell'Inserimento del Valore del CRF... Non e' un Numero. 
set t80=Valore CRF Impostato a:
set t81=Valore CRF al di fuori dei  Limiti  10 / 28  Reinserire^!

set t82=Selezionare Velocita'-Qualita' Codifica:
set t83=- Peggiore Qualita' - Codifica Molto Veloce
set t84=- Consigliata
set t85=- Migliore Qualita' - Codifica Molto Lenta
set t86=Scegli (1/2/3/4/5/6/7/8/9/0):
set t87=Velocita'-Qualita' Impostata su:

set t88=Selezionare tipo di Quantizzazione Adattiva:
set t89=1) Disabilitata 
set t90=2) Abilitata 
set t91=3) Abilitata + Auto-Variance 
set t92=4) Abilitata + Auto-Variance + Dark Bias 
set t93=5) Abilitata + Auto-Variance + Edge
set t94=Scegli (1/2/3/4/5):
set t95=Quantizzazione Adattiva Impostata su:

set t96=Selezionare Valore Forza Quantizzazione Adattiva:
set t97=- Peggiore Qualita' - File piu' Piccolo
set t98=- Migliore Qualita' - File piu' Grande
set t99=Forza Quantizzazione Adattiva Impostata su:

set t100=Selezionare Filtro Denoiser:
set t101=1) Nessuno 
set t102=Denoiser Selezionato:
set t103=Selezionare Intensita' Denoiser:
set t104=1) Leggero 
set t105=2) Medio 
set t106=3) Forte 

set t107=Il Video non ha Metadati Master Display

set t108=Abilitata + Auto-Variance + Edge
set t109=Abilitata + Auto-Variance + Dark Bias
set t110=Abilitata + Auto-Variance
set t111=Abilitata
set t112=Disabilitata

set t113=Nessun Denoiser
set t114=Codifica FFmpeg Terminata.... 
set t115=Premi Invio per tornare al Menu' Principale:  
set t1000=Il PC ora verra' Spento... 

goto avvio_FFmpegSempliceCodifica

:avvio_FFmpegSempliceCodifica




set "NomeFile="
rem set MetadatiStreamHDR10=

set /P NomeFile=!t2!
rem echo Hai digitato: %NomeFile%
rem pause

set "NomeFileSorgente=!NomeFile:"=!"
@REM echo NomeFileSorgente = !NomeFileSorgente!
set "NomeFile=^"!NomeFileSorgente!^""
@REM echo NomeFile = !NomeFile!
rem pause

if exist !NomeFile! ( goto InfoVideoFmpegSempliceCodifica ) else ( 
                                                        echo.
                                                        echo !t3!
                                                        echo.
                                                        goto FineRealeFmpegSempliceCodifica
                                                        )    



:InfoVideoFmpegSempliceCodifica
echo.
echo !t4!
echo.

.\bin\ffprobe -v error -hide_banner -select_streams v:0 -show_entries stream=width,height,codec_name,codec_long_name,pix_fmt,color_space,color_transfer,color_primaries -of default=noprint_wrappers=1 %NomeFile% > ".\temp\Temp_HDR10_Stream.txt"

set /A "hdrcs=0"
set /A "hdrtr=0"
set /A "hdrcp=0"
set /A "fv=0"
set /A "x1=1"

rem echo nohdr = %nohdr%

for /f "tokens=1,2 delims==" %%a in (.\temp\Temp_HDR10_Stream.txt) do (
                                                                if !x1!==1 ( 
                                                                            echo !t68! "%%a" = %%b  
                                                                            )       
                                                                if !x1!==2 ( 
                                                                            echo !t69! "%%a" = %%b  
                                                                            )   
                                                                if !x1!==3 ( 
                                                                            echo !t66! "%%a" = %%b  
                                                                            set /A "widthvideo=%%b"
                                                                            @REM echo widthvideo = !widthvideo!
                                                                            )
                                                                if !x1!==4 ( 
                                                                            echo !t67! "%%a" = %%b  
                                                                            set /A "heightvideo=%%b"
                                                                            @REM echo heightvideo = !heightvideo!
                                                                            ) 
                                                                if !x1!==5 ( 
                                                                            echo !t70! "%%a" = %%b  
                                                                            set "formatvideo=%%b"
                                                                            @REM echo formatvideo = !formatvideo!
                                                                            if !formatvideo!==yuv420p10le (
                                                                                                            set /A "fv=1"
                                                                                                            @REM echo fv = !fv!
                                                                                                        )
                                                                            )
                                                                if !x1!==6 ( 
                                                                            echo Color Space "%%a" = %%b  
                                                                            set "colorsp=%%b"
                                                                            @REM echo colorsp = !colorsp!
                                                                            if !colorsp!==bt2020nc (
                                                                                                    set /A "hdrcs=1"
                                                                                                    @REM echo hdrcs = !hdrcs!
                                                                                                    )                
                                                                            ) 
                                                                if !x1!==7 ( 
                                                                            echo Color Transfer "%%a" = %%b  
                                                                            set "colortr=%%b"
                                                                            @REM echo colortr = !colortr!
                                                                            if !colortr!==smpte2084 (
                                                                                                    set /A "hdrtr=1"
                                                                                                    @REM echo hdrtr = !hdrtr!
                                                                                                    )
                                                                            if !colortr!==unknown (
                                                                                                    set /A "hdrtr=1"
                                                                                                @REM echo hdrtr = !hdrtr!
                                                                                                )
                                                                            if !colortr!==reserved (
                                                                                                    set /A "hdrct=1"
                                                                                                @REM echo hdrtr = !hdrtr!
                                                                                                )                    
                                                                            ) 
                                                                if !x1!==8 ( 
                                                                            echo Color Primaries "%%a" = %%b  
                                                                            set "colorpr=%%b"
                                                                            @REM echo colorpr = !colorpr!
                                                                            if !colorpr!==bt2020 (
                                                                                                    set /A "hdrcp=1"
                                                                                                @REM echo hdrcp = !hdrcp!
                                                                                                )
                                                                            if !colorpr!==unknown (
                                                                                                    set /A "hdrcp=1"
                                                                                                @REM echo hdrcp = !hdrcp!
                                                                                                )
                                                                            if !colorpr!==reserved (
                                                                                                    set /A "hdrcp=1"
                                                                                                @REM echo hdrcp = !hdrcp!
                                                                                                )                
                                                                            )    

                                                                set /A x1+=1                                                            
)

rem pause

echo.

if fv==1 if hdrcs==0 if hdrtr==0 if hdrcp==0 (
    set "ProfileValue=-profile:v main10"
) else (
    set "ProfileValue=-profile:v main"
)

if !x1!==1 goto :novideofileFmpegSempliceCodifica

@REM echo.
@REM echo hdrcs = !hdrcs!
@REM echo hdrtr = !hdrtr!
@REM echo hdrcp = !hdrcp!
@REM echo fv = !fv!

if !hdrcs!==1 if !hdrtr!==1 if !hdrcp!==1 if !fv!==1 ( 
    @REM echo.
    @REM echo hdrcs = !hdrcs!
    @REM echo hdrtr = !hdrtr!
    @REM echo hdrcp = !hdrcp!
    @REM echo fv = !fv!
    goto letturaMetadatiHDR10FmpegSempliceCodifica

) 
set "masterdisplaysettings=nessuno"
goto fineletturaMetadatiHDR10FmpegSempliceCodifica


rem/////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////


:letturaMetadatiHDR10FmpegSempliceCodifica
.\bin\ffprobe -loglevel panic -select_streams 0 -show_frames -read_intervals %%+#1 -show_entries frame=side_data_list -of default=noprint_wrappers=1 %NomeFile% > ".\temp\Temp_HDR10.txt"


set /A x2=1
set /A dvp=0
set /A hdr10pp=0

set redx=
set redy=
set greenx=
set greeyx=
set bx=
set by=
set wpx=
set wpy=
set minl=
set maxl=
set maxc=
set maxa=
set /A maxcpresent=0
set /A maxapresent=0


findstr /c:"Mastering display metadata" .\temp\Temp_HDR10.txt > .\temp\Temp_HDR10_Finale.txt
findstr /c:"red_x" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"red_y" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"green_x" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"green_y" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"blue_x" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"blue_y" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"white_point_x" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"white_point_y" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"min_luminance" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"max_luminance" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"Content light level metadata" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"max_content" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"max_average" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt

findstr /c:"HDR Dynamic Metadata SMPTE2094-40 (HDR10+)" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt
findstr /c:"Dolby Vision Metadata" .\temp\Temp_HDR10.txt >> .\temp\Temp_HDR10_Finale.txt

rem elimina le prime righe che corrispondono alle stringhe tra le virgolette"
rem findstr /V "TAG:timecode=" .\temp\Temp_HDR10.txt > Temp_HDR10p.txt
rem findstr /V "side_data_type=H.26[45] User Data Unregistered SEI message" Temp_HDR10p.txt > Temp_HDR10f.txt

rem del ".\temp\Temp_HDR10.txt"


for /f "tokens=1,2 delims==,/" %%a in (.\temp\Temp_HDR10_Finale.txt) do ( 
                                                            if !x2!==1 (
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=Dolby Vision Metadata"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==1 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        goto solodvFFmpegSempliceCodifica
                                                                                                        )
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=HDR Dynamic Metadata SMPTE2094-40 (HDR10+)"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==1 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        goto solohdr10plusFFmpegSempliceCodifica
                                                                                                        )

                                                                        echo %%b
                                                                        echo.
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==2 ( 
                                                                        echo %%a = %%b  
                                                                        set "redx=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==3 ( 
                                                                        echo %%a = %%b  
                                                                        set "redy=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==4 ( 
                                                                        echo %%a = %%b  
                                                                        set "greenx=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==5 ( 
                                                                        echo %%a = %%b  
                                                                        set "greeny=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==6 ( 
                                                                        echo %%a = %%b  
                                                                        set "bx=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==7 ( 
                                                                        echo %%a = %%b  
                                                                        set "by=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==8 ( 
                                                                        echo %%a = %%b  
                                                                        set "wpx=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==9 ( 
                                                                        echo %%a = %%b  
                                                                        set "wpy=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==10 ( 
                                                                        echo %%a = %%b  
                                                                        set "minl=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==11 ( 
                                                                        echo %%a = %%b  
                                                                        set "maxl=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==12 (
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=Dolby Vision Metadata"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==12 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        set /a dvp=1
                                                                                                        ) 
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=HDR Dynamic Metadata SMPTE2094-40 (HDR10+)"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==12 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        set /a hdr10pp=1
                                                                                                        )
                                                                        if !dvp!==1 ( 
                                                                                    echo.
                                                                                    echo !t75!
                                                                                    )
                                                                        if !hdr10pp!==1 ( 
                                                                                        echo.
                                                                                        echo !t76!
                                                                                        )
                                                                        
                                                                        if !dvp!==0 if !hdr10pp!==0 (
                                                                                                echo.
                                                                                                echo %%b
                                                                                                echo.
                                                                                                rem echo !x2!
                                                                                                )
                                                                        
                                                                        )
                                                            if !x2!==13 (
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=Dolby Vision Metadata"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==13 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        set /a dvp=1
                                                                                                        ) 
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=HDR Dynamic Metadata SMPTE2094-40 (HDR10+)"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==13 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        set /a hdr10pp=1
                                                                                                        )
                                                                        if !dvp!==1 ( 
                                                                                    echo.
                                                                                    echo !t75!
                                                                                    )
                                                                        if !hdr10pp!==1 ( 
                                                                                        echo.
                                                                                        echo !t76!
                                                                                        )
                                                                        
                                                                        if !dvp!==0 if !hdr10pp!==0 ( 
                                                                                                echo %%a = %%b  
                                                                                                set "maxc=%%b"
                                                                                                set "maxcpresent=1"
                                                                                                rem echo !x2!
                                                                                                )
                                                                        )
                                                            if !x2!==14 ( 
                                                                        echo %%a = %%b  
                                                                        set "maxa=%%b"
                                                                        set "maxapresent=1"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==15 (
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=Dolby Vision Metadata"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==15 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        set /a dvp=1
                                                                                                        ) 
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=HDR Dynamic Metadata SMPTE2094-40 (HDR10+)"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==15 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        set /a hdr10pp=1
                                                                                                        )
                                                                        if !dvp!==1 ( 
                                                                                    echo.
                                                                                    echo !t75!
                                                                                    )
                                                                        if !hdr10pp!==1 ( 
                                                                                        echo.
                                                                                        echo !t76!
                                                                                        )
                                                                        )
                                                            if !x2!==16 (
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=Dolby Vision Metadata"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==16 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        set /a dvp=1
                                                                                                        ) 
                                                                        if !dvp!==1 ( 
                                                                                    echo.
                                                                                    echo !t75!
                                                                                    )
                                                                        )
                                                            set /A x2+=1
)

rem echo maxapresent = %maxapresent%
rem echo maxcpresent = %maxcpresent%


if %maxapresent%==1 if %maxcpresent%==1 (
                                        echo.
                                        echo !t77!
                                        echo master-display=G^(!greenx!,!greeny!^)B^(!bx!,!by!^)R^(!redx!,!redy!^)WP^(!wpx!,!wpy!^)L^(!maxl!,!minl!^):max-cll=!maxc!,!maxa!
                                        set "masterdisplaysettings=G^(!greenx!,!greeny!^)B^(!bx!,!by!^)R^(!redx!,!redy!^)WP^(!wpx!,!wpy!^)L^(!maxl!,!minl!^):max-cll=!maxc!,!maxa!"
                                        @REM echo masterdisplaysettings = !masterdisplaysettings!
                                        echo.
                                        )

if %maxapresent%==0 if %maxcpresent%==0 (
                                        echo.
                                        echo !t77!
                                        echo master-display=G^(!greenx!,!greeny!^)B^(!bx!,!by!^)R^(!redx!,!redy!^)WP^(!wpx!,!wpy!^)L^(!maxl!,!minl!^)
                                        set "masterdisplaysettings=G^(!greenx!,!greeny!^)B^(!bx!,!by!^)R^(!redx!,!redy!^)WP^(!wpx!,!wpy!^)L^(!maxl!,!minl!^)"
                                        @REM echo masterdisplaysettings = !masterdisplaysettings!
                                        echo.
                                        )                                                                       

:fineLetturaMetadatiHDR10FmpegSempliceCodifica




:rilevazionebandenereFmpegSempliceCodifica

.\bin\ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 %NomeFile%  > ".\temp\durata_film.txt"


set /a contatore=1
for /f "tokens=1 delims=." %%a in (.\temp\durata_film.txt) do  (
                                                        echo. 
                                                        echo !t7! %%a
                                                        set /a "secondi=%%a"
                                                        set /a "minuti=!secondi!/60"
                                                        echo !t8! !minuti!
                                                        set /a "intervallo_tagli=!secondi!/11"
                                                        echo !t9! !intervallo_tagli!!t10!
                                                        echo.
                                                        echo !t11!
                                                        echo.

                                                        

                                                        FOR /L %%a IN (1, 1, 10) DO (
                                                                                    rem echo %%a
                                                                                    set /a "secondi=%%a*!intervallo_tagli!"
                                                                                    rem echo !secondi!

                                                                                    if !formatvideo!==yuv420p (
                                                                                                                set /a "ca=16"
                                                                                                                rem echo !ca!
                                                                                                                    
                                                                                                                set /a "cb=2"
                                                                                                                rem echo !cb!
                                                                                                                    
                                                                                                                set /a "cc=0"
                                                                                                                rem echo !cc!

                                                                                                                set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                                                rem echo !cr!
                                                                                                                )

                                                                                    if !formatvideo!==yuv420p10le  ( 
                                                                                                                    set /a "ca=72"
                                                                                                                    rem echo !ca!
                                                                                                                    
                                                                                                                    set /a "cb=2"
                                                                                                                    rem echo !cb!
                                                                                                                    
                                                                                                                    set /a "cc=0"
                                                                                                                    rem echo !cc!

                                                                                                                    set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                                                    rem echo !cr!
                                                                                                                    )                                                                                                                

                                    
                                                                                
                                                                                
                                                                                    .\bin\ffmpeg -ss !secondi! -hide_banner -nostats -i %NomeFile% -vframes 10 -vf !cr! -f null - 2> ".\temp\crop.txt"
                                                                                    
                                                                                    findstr /r "Parsed_cropdetect_0" .\temp\crop.txt >> .\temp\risultato_multiplo.txt   
                                                                                    
                                                                                    echo !t12! %%a !t13! !secondi! !t14!
                                                                                    
                                                                                    )       
                                                                                       

                                                                                    for /f "tokens=1,2 delims==" %%a in (.\temp\risultato_multiplo.txt) do ( echo %%b >> .\temp\crop_multiplo.txt )
                                                                                    
                                                                                    set /a "maxfrequenza=0"

                                                                                    for /f "delims=" %%a in (.\temp\crop_multiplo.txt) do ( 
                                                                                                                                    set "cropconfront=%%a"
                                                                                                                                    rem echo "!cropconfront!"
                                                                                                                                    
                                                                                                                                    set /a "contatorfrequenza=0"
                                                                                                                                    for /f "delims=" %%b in (.\temp\crop_multiplo.txt) do (
                                                                                                                                                                                    set "dato_da_verificare=%%b"
                                                                                                                                                                                    rem echo cropconfront = "!cropconfront!"
                                                                                                                                                                                    rem echo dato_da_verificare = "!dato_da_verificare!"
                                                                                                                                                                                    if !cropconfront!==!dato_da_verificare! ( set /a "contatorfrequenza+=1")
                                                                                                                                                                                    )
                                                                                                                                    if !maxfrequenza! LSS !contatorfrequenza! ( 
                                                                                                                                                                                set /a "maxfrequenza=!!contatorfrequenza!!"
                                                                                                                                                                                set "cropd=!cropconfront!"
                                                                                                                                                                                )
                                                                                                                                    

                                                                                                                                    rem if !cropconfront! in (elenco_crop_frequenza.txt) ()
                                                                                                                                    rem echo !cropconfront!:!contatorfrequenza! >> elenco_crop_frequenza.txt

                                                                                                                                    )

                                                                                    rem echo crop piu' frequente = !cropd! con grequenza = !maxfrequenza!
                                                                                    echo !cropd! > .\temp\crop_finale.txt

                                                                                    for /f "tokens=1,2,3,4 delims=:" %%a in (.\temp\crop_finale.txt) do  ( 
                                                                                                                                                    rem set /a "mwidth=%%a"
                                                                                                                                                    rem echo mwidth = !mwidth!

                                                                                                                                                    rem set /a "mheight=%%b"
                                                                                                                                                    rem echo mheight = !mheight!

                                                                                                                                                    rem set /a "mx=%%c"
                                                                                                                                                    rem echo mx = !mx!

                                                                                                                                                    rem set /a "my=%%d"
                                                                                                                                                    rem echo my = !my!

                                                                                                                                                    if !contatore!==1 ( 
                                                                                                                                                                set /a "wmax=%%a" 
                                                                                                                                                                set /a "hmax=%%b"
                                                                                                                                                                set /a "xmin=%%c"
                                                                                                                                                                set /a "ymin=%%d"
                                                                                                                                                                set /a "mwidth=%%a"
                                                                                                                                                                set /a "mheight=%%b"
                                                                                                                                                                set /a "mx=%%c"
                                                                                                                                                                set /a "my=%%d"
                                                                                                                                                                set /a "contatore+=1"
                                                                                                                                                                )
                                                                                                                                                    
                                                                                                                                                    rem if %%b gtr !hmax! if %%c gtr !xmin! if %%d gtr !ymin! 

                                                                                                                                                    if %%a geq !wmax! if %%b geq !hmax! ( 
                                                                                                                                                                        set /a "wmax=%%a" 
                                                                                                                                                                        set /a "hmax=%%b"
                                                                                                                                                                        set /a "xmin=%%c"
                                                                                                                                                                        set /a "ymin=%%d"
                                                                                                                                                                        set /a "mwidth=%%a"
                                                                                                                                                                        set /a "mheight=%%b"
                                                                                                                                                                        set /a "mx=%%c"
                                                                                                                                                                        set /a "my=%%d"
                                                                                                                                                                        )
                                                                                                                                                    )
                                                                                    echo.
                                                                                    
                                                                                    set /a "mwidth=!mwidth!/2*2"
                                                                                    set /a "mheight=!mheight!/2*2"

                                                                                    set /a "csup=!my!/2*2"
                                                                                    rem echo csup = !csup!
                                                                                                                                    
                                                                                    set /a "csin=!mx!/2*2"
                                                                                    rem echo csin = !csin!

                                                                                    set /a "cinf=(!heightvideo!-!mheight!-!my!)/2*2"
                                                                                    rem echo movieheightreal = !movieheightreal!
                                                                                    rem echo cinf = !cinf!
                                                                                    set /a "cdes=(!widthvideo!-!mwidth!-!mx!)/2*2"
                                                                                    rem echo cdes = !cdes!

                                                                                    echo FFmpeg Crop Settings: crop=!mwidth!:!mheight!:!csin!:!csup!    
                                                                                    set "cropff=crop=!mwidth!:!mheight!:!csin!:!csup!"
                                                                                    @REM echo cropff = !cropff!
                                                                                    echo.  
                                                                                    
                                                                                    echo !t17!  !mwidth! 
                                                                                    echo !t18!  !mheight! 
                                                                                    echo.
                  
                                                        )                          
                                                  

:cropmanuale1080pFmpegSempliceCodifica
set /a "csup=0"
set /a "cinf=0"
set /a "csin=0"
set /a "cdes=0"
set /a "bandasuperiore=0"
set /a "bandainferiore=0"
set /a "bandasinistra=0"
set /a "bandadestra=0"
set /a "differenzialelarghezza1080pnvenc=0"
set /a "differenzialealtezza1080pnvenc=0"
if exist ".\temp\Temp_HDR10.txt" ( del ".\temp\Temp_HDR10.txt" )
if exist ".\temp\Temp_HDR10_Finale.txt" ( del ".\temp\Temp_HDR10_Finale.txt" )
if exist ".\temp\Temp_HDR10_Stream.txt" ( del ".\temp\Temp_HDR10_Stream.txt" ) 
if exist ".\temp\durata_film.txt" ( del ".\temp\durata_film.txt" )
if exist ".\temp\crop.txt" ( del ".\temp\crop.txt" )
if exist ".\temp\risultato_multiplo.txt" ( del ".\temp\risultato_multiplo.txt" )
if exist ".\temp\crop_multiplo.txt" ( del ".\temp\crop_multiplo.txt" )
if exist ".\temp\crop_finale.txt" ( del ".\temp\crop_finale.txt" )

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t22!"   
    if errorlevel 2 goto cropmanualeFmpegSempliceCodifica
    if errorlevel 1 goto finecropFmpegSempliceCodifica
)

CHOICE /N /C:SN /M "!t22!"   

if errorlevel 2 goto cropmanualeFmpegSempliceCodifica
if errorlevel 1 goto finecropFmpegSempliceCodifica

:cropmanualeFmpegSempliceCodifica
echo.
echo !t23!
echo.

:banda_superiore_valoreFmpegSempliceCodifica
set /p "bandasuperiore=!t24!"
SET "var="&for /f "delims=0123456789" %%i in ("!bandasuperiore!") do set var=!bandasuperiore!
if defined var (
                echo.
                echo !t25!
                echo.
                goto banda_superiore_valoreFmpegSempliceCodifica
                ) else (
                        set /a "csup=!bandasuperiore!/2*2"
                        )

echo.
:banda_inferiore_valoreFmpegSempliceCodifica
set /p "bandainferiore=!t26!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandainferiore!") do set var=!bandainferiore!
if defined var (
                echo.
                echo !t27!
                echo.
                goto banda_inferiore_valoreFmpegSempliceCodifica
                ) else (
                        set /a "cinf=!bandainferiore!/2*2"
                        )


echo.
:banda_sinistra_valoreFmpegSempliceCodifica
set /p "bandasinistra=!t28!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandasinistra!") do set var=!bandasinistra!
if defined var (
                echo.
                echo !t29!
                echo.
                goto banda_sinistra_valoreFmpegSempliceCodifica
                ) else (
                        set /a "csin=!bandasinistra!/2*2"
                        )

                        
echo.
:banda_destra_valoreFmpegSempliceCodifica
set /p "bandadestra=!t30!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandadestra!") do set var=!bandadestra!
if defined var (
                echo.
                echo !t31!
                echo.
                goto banda_destra_valoreFmpegSempliceCodifica
                ) else (
                        set /a "cdes=!bandadestra!/2*2"
                        )
                                   

set /a "mwidths=!widthvideo!/2*2"
set /a "mheights=!heightvideo!/2*2"
@REM echo nuovo mwidhts = !mwidths!
@REM echo nuovo mheights = !mheights!

set /a "mwidth=!mwidths!-!csin!-!cdes!"
set /a "mheight=!mheights!-!csup!-!cinf!"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!


echo.
echo !t32!  !csup! 
echo !t33!  !cinf! 
echo !t34!  !csin! 
echo !t35!  !cdes! 
echo.


echo FFmpeg Crop Settings: crop=!mwidth!:!mheight!:!csin!:!csup!    
set "cropff=crop=!mwidthc!:!mheightc!:!csin!:!csup!"
@REM echo cropff = !cropff!
echo.  

echo !t17!  !mwidth! 
echo !t18!  !mheight! 
echo.



goto cropmanuale1080pFmpegSempliceCodifica

:finecropFmpegSempliceCodifica

echo.


rem////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////




rem tipo codifica
echo.
echo !t40!
echo.
echo 1) CRF 
echo 2) VBR 
echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto CodificaVBRFmpegSempliceCodifica
if errorlevel 1 goto CodificaCRFFmpegSempliceCodifica

:CodificaVBRFmpegSempliceCodifica
set "TipoCodificaFFmpeg=-b:v "
set /a "Valorecrf_FFmpeg=0"
goto inserimentoValoriCRFFmpegSempliceCodifica

:CodificaCRFFmpegSempliceCodifica
set "TipoCodificaFFmpeg=-crf:v "
set /a "Valorecrf_FFmpeg=1"

:inserimentoValoriCRFFmpegSempliceCodifica

if !Valorecrf_FFmpeg!==1 (
                                echo.
                                set /p "valoreCRFFFmpeg=!t78! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreCRFFFmpeg!") do set var=!valoreCRFFFmpeg!
                                if defined var (
                                                echo.
                                                echo !t79!
                                                echo.
                                                goto inserimentoValoriCRFFmpegSempliceCodifica
                                                ) 

                                set /a "valoreCRFFFmpeg=!valoreCRFFFmpeg!"
                                @REM echo valoreQuantizzazione = !valoreCRFFFmpeg!
                                if !valoreCRFFFmpeg! GEQ 10 if !valoreCRFFFmpeg! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t80! !valoreCRFFFmpeg!
                                                                                                                set "tipoQuantizzazioneFFmpeg=!TipoCodificaFFmpeg!!valoreCRFFFmpeg!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneFFmpeg!
                                                                                                                goto fineQuantizzazioneFmpegSempliceCodifica
                                                                                                                ) 
                                echo.
                                echo !t81!
                                goto inserimentoValoriCRFFmpegSempliceCodifica
                                                                                                                        
                                )



if !Valorecrf_FFmpeg!==0 (
                                echo.
                                set /p "valoreBitRateFFmpeg=!t46! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateFFmpeg!") do set var=!valoreBitRateFFmpeg!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                echo.
                                                goto inserimentoValoriCRFFmpegSempliceCodifica
                                                ) 
                                set /a "valoreBitRateFFmpeg=!valoreBitRateFFmpeg!"
                                @REM echo valoreBitRateFFmpeg = !valoreBitRateFFmpeg!
                                if !valoreBitRateFFmpeg! GEQ 100 if !valoreBitRateFFmpeg! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateFFmpeg!
                                                                                                        set "tipoQuantizzazioneFFmpeg=!TipoCodificaFFmpeg!!valoreBitRateFFmpeg!k"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneFFmpeg!
                                                                                                        goto fineQuantizzazioneFmpegSempliceCodifica
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCRFFmpegSempliceCodifica
                                                                                                              
                                )


:fineQuantizzazioneFmpegSempliceCodifica


rem////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////



rem velocit codifica
echo.
echo !t82!
echo.
echo 1) Ultrafast !t83!
echo 2) Superfast 
echo 3) Veryfast 
echo 4) Faster 
echo 5) Fast 
echo 6) Medium !t84!
echo 7) Slow 
echo 8) Slower 
echo 9) Veryslow 
echo 0) Placebo !t85!
echo.
CHOICE /N /C:1234567890 /M "!t86!"

if errorlevel 10 goto PlaceboFmpegSempliceCodifica
if errorlevel 9 goto VeryslowFmpegSempliceCodifica
if errorlevel 8 goto SlowerFmpegSempliceCodifica
if errorlevel 7 goto SlowFmpegSempliceCodifica
if errorlevel 6 goto MediumFmpegSempliceCodifica
if errorlevel 5 goto FastFmpegSempliceCodifica
if errorlevel 4 goto FasterFFmpegSempliceCodifica
if errorlevel 3 goto VeryfastFmpegSempliceCodifica
if errorlevel 2 goto SuperfastFmpegSempliceCodifica
if errorlevel 1 goto UltrafastFmpegSempliceCodifica


:PlaceboFmpegSempliceCodifica
set "SettaggioQualitaFFmpeg=-preset:v placebo"
set "QualitySetting=Placebo"
goto fineQualitCodificaFmpegSempliceCodifica

:VeryslowFmpegSempliceCodifica
set "SettaggioQualitaFFmpeg=-preset:v veryslow"
set "QualitySetting=Veryslow"
goto fineQualitCodificaFmpegSempliceCodifica

:SlowerFmpegSempliceCodifica
set "SettaggioQualitaFFmpeg=-preset:v slower"
set "QualitySetting=Slower"
goto fineQualitCodificaFmpegSempliceCodifica

:SlowFmpegSempliceCodifica
set "SettaggioQualitaFFmpeg=-preset:v slow"
set "QualitySetting=Slow"
goto fineQualitCodificaFmpegSempliceCodifica

:MediumFmpegSempliceCodifica
set "SettaggioQualitaFFmpeg=-preset:v medium"
set "QualitySetting=Medium"
goto fineQualitCodificaFmpegSempliceCodifica

:FastFmpegSempliceCodifica
set "SettaggioQualitaFFmpeg=-preset:v fast"
set "QualitySetting=Fast"
goto fineQualitCodificaFmpegSempliceCodifica

:FasterFFmpegSempliceCodifica
set "SettaggioQualitaFFmpeg=-preset:v faster"
set "QualitySetting=Faster"
goto fineQualitCodificaFmpegSempliceCodifica

:VeryfastFmpegSempliceCodifica
set "SettaggioQualitaFFmpeg=-preset:v veryfast"
set "QualitySetting=Veryfast"
goto fineQualitCodificaFmpegSempliceCodifica

:SuperfastFmpegSempliceCodifica
set "SettaggioQualitaFFmpeg=-preset:v superfast"
set "QualitySetting=Superfast"
goto fineQualitCodificaFmpegSempliceCodifica

:UltrafastFmpegSempliceCodifica
set "SettaggioQualitaFFmpeg=-preset:v ultrafast"
set "QualitySetting=Ultrafast"
goto fineQualitCodificaFmpegSempliceCodifica


:fineQualitCodificaFmpegSempliceCodifica
echo.
echo !t87! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaFFmpeg!


rem////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////


rem quantizzazione adattiva
echo.
echo !t88!
echo.
echo !t89!
echo !t90!
echo !t91!
echo !t92!
echo !t93!
echo.
CHOICE /N /C:12345 /M "!t94!"

if errorlevel 5 goto EdgeFmpegSempliceCodifica
if errorlevel 4 goto DarkBiasFmpegSempliceCodifica
if errorlevel 3 goto AutoVarianceFmpegSempliceCodifica
if errorlevel 2 goto AbilitataFmpegSempliceCodifica
if errorlevel 1 goto DisabilitatFmpegSempliceCodifica

:EdgeFmpegSempliceCodifica
set "ValoreQuantizzazioneAdattiva=aq-mode=4"
set "TipoQuantizzazioneAdattiva_FFmpeg=!t108!"
goto QuantizzazioneSelezionataFmpegSempliceCodifica

:DarkBiasFmpegSempliceCodifica
set "ValoreQuantizzazioneAdattiva=aq-mode=3"
set "TipoQuantizzazioneAdattiva_FFmpeg=!t109!"
goto QuantizzazioneSelezionataFmpegSempliceCodifica

:AutoVarianceFmpegSempliceCodifica
set "ValoreQuantizzazioneAdattiva=aq-mode=2"
set "TipoQuantizzazioneAdattiva_FFmpeg=!t110!"
goto QuantizzazioneSelezionataFmpegSempliceCodifica

:AbilitataFmpegSempliceCodifica
set "ValoreQuantizzazioneAdattiva=aq-mode=1"
set "TipoQuantizzazioneAdattiva_FFmpeg=!t111!"
goto QuantizzazioneSelezionataFmpegSempliceCodifica

:DisabilitatFmpegSempliceCodifica
set "ValoreQuantizzazioneAdattiva=aq-mode=0"
set "TipoQuantizzazioneAdattiva_FFmpeg=!t112!"
goto QuantizzazioneSelezionataFmpegSempliceCodifica

:QuantizzazioneSelezionataFmpegSempliceCodifica

echo.
echo !t95! !TipoQuantizzazioneAdattiva_FFmpeg!
echo.
echo !t43! !ValoreQuantizzazioneAdattiva!




rem////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////

if !TipoQuantizzazioneAdattiva_FFmpeg!==Disabilitata (
    set "SettaggioFozaQAFFmpeg=aq-strength=1.0"
    goto fineForzaQuantizzazioneAdattivaFmpegSempliceCodificaDisabilitata
)



rem forza quantizzazione
echo.
echo !t96!
echo.
echo 1) 0.1 !t97!
echo 2) 0.2 
echo 3) 0.3 
echo 4) 0.4 
echo 5) 0.5 
echo 6) 0.6 
echo 7) 0.7 
echo 8) 0.8 
echo 9) 0.9 
echo 0) 1.0 !t98!
echo.
CHOICE /N /C:1234567890 /M "!t86!"

if errorlevel 10 goto Forza10FmpegSempliceCodifica
if errorlevel 9 goto Forza9FmpegSempliceCodifica
if errorlevel 8 goto Forza8FmpegSempliceCodifica
if errorlevel 7 goto Forza7FmpegSempliceCodifica
if errorlevel 6 goto Forza6FmpegSempliceCodifica
if errorlevel 5 goto Forza5FmpegSempliceCodifica
if errorlevel 4 goto Forza4FmpegSempliceCodifica
if errorlevel 3 goto Forza3FmpegSempliceCodifica
if errorlevel 2 goto Forza2FmpegSempliceCodifica
if errorlevel 1 goto Forza1FmpegSempliceCodifica


:Forza10FmpegSempliceCodifica
set "SettaggioFozaQAFFmpeg=aq-strength=1.0"
set "SettingoFozaQAFFmpeg=1.0"
goto fineForzaQuantizzazioneAdattivaFmpegSempliceCodifica

:Forza9FmpegSempliceCodifica
set "SettaggioFozaQAFFmpeg=aq-strength=0.9"
set "SettingoFozaQAFFmpeg=0.9"
goto fineForzaQuantizzazioneAdattivaFmpegSempliceCodifica

:Forza8FmpegSempliceCodifica
set "SettaggioFozaQAFFmpeg=aq-strength=0.8"
set "SettingoFozaQAFFmpeg=0.7"
goto fineForzaQuantizzazioneAdattivaFmpegSempliceCodifica

:Forza7FmpegSempliceCodifica
set "SettaggioFozaQAFFmpeg=aq-strength=0.7"
set "SettingoFozaQAFFmpeg=0.7"
goto fineForzaQuantizzazioneAdattivaFmpegSempliceCodifica

:Forza6FmpegSempliceCodifica
set "SettaggioFozaQAFFmpeg=aq-strength=0.6"
set "SettingoFozaQAFFmpeg=0.6"
goto fineForzaQuantizzazioneAdattivaFmpegSempliceCodifica

:Forza5FmpegSempliceCodifica
set "SettaggioFozaQAFFmpeg=aq-strength=0.5"
set "SettingoFozaQAFFmpeg=0.5"
goto fineForzaQuantizzazioneAdattivaFmpegSempliceCodifica

:Forza4FmpegSempliceCodifica
set "SettaggioFozaQAFFmpeg=aq-strength=0.4"
set "SettingoFozaQAFFmpeg=0.4"
goto fineForzaQuantizzazioneAdattivaFmpegSempliceCodifica

:Forza3FmpegSempliceCodifica
set "SettaggioFozaQAFFmpeg=aq-strength=0.3"
set "SettingoFozaQAFFmpeg=0.3"
goto fineForzaQuantizzazioneAdattivaFmpegSempliceCodifica

:Forza2FmpegSempliceCodifica
set "SettaggioFozaQAFFmpeg=aq-strength=0.2"
set "SettingoFozaQAFFmpeg=0.2"
goto fineForzaQuantizzazioneAdattivaFmpegSempliceCodifica

:Forza1FmpegSempliceCodifica
set "SettaggioFozaQAFFmpeg=aq-strength=0.1"
set "SettingoFozaQAFFmpeg=0.1"
goto fineForzaQuantizzazioneAdattivaFmpegSempliceCodifica


:fineForzaQuantizzazioneAdattivaFmpegSempliceCodifica
echo.
echo !t99! !SettingoFozaQAFFmpeg!
echo.
echo !t43! !SettaggioFozaQAFFmpeg!

:fineForzaQuantizzazioneAdattivaFmpegSempliceCodificaDisabilitata



rem////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////

rem denoiser
set "DenoiserFinalSettings="
echo.
echo !t100!
echo.
echo !t101!
echo 2) Atadenoise 
echo 3) Nlmeans 
echo 4) Vaguedenoiser 
echo 5) Hqdn3d 
echo.
CHOICE /N /C:12345 /M "!t94!"

if errorlevel 5 goto Hqdn3dFmpegSempliceCodifica
if errorlevel 4 goto VagueDenoiserFmpegSempliceCodifica
if errorlevel 3 goto NlmeansDenoiserFmpegSempliceCodifica
if errorlevel 2 goto AtaDenoiserFmpegSempliceCodifica
if errorlevel 1 goto NessunDenoiserFmpegSempliceCodifica

:Hqdn3dFmpegSempliceCodifica
set "DenoiserSelezionato=Hqdn3d"
set "NumeroTipoDenoiser=5"
goto FineSceltaDenoiserFmpegSempliceCodifica

:VagueDenoiserFmpegSempliceCodifica
set "DenoiserSelezionato=VagueDenoiser"
set "NumeroTipoDenoiser=4"
goto FineSceltaDenoiserFmpegSempliceCodifica

:NlmeansDenoiserFmpegSempliceCodifica
set "DenoiserSelezionato=Nlmeans"
set "NumeroTipoDenoiser=3"
goto FineSceltaDenoiserFmpegSempliceCodifica

:AtaDenoiserFmpegSempliceCodifica
set "DenoiserSelezionato=AtaDenoiser"
set "NumeroTipoDenoiser=2"
goto FineSceltaDenoiserFmpegSempliceCodifica

:NessunDenoiserFmpegSempliceCodifica
set "DenoiserSelezionato=!t113!"
set "NumeroTipoDenoiser=1"
goto FineSceltaDenoiserFmpegSempliceCodifica

:FineSceltaDenoiserFmpegSempliceCodifica
echo.
echo !t102! !DenoiserSelezionato!


if !NumeroTipoDenoiser!==1 (
   set "DenoiserFinalSettings=" 
   goto IniziaCodificaFFmpegSempliceCodifica
)

echo.
echo !t103!
echo.
echo !t104!
echo !t105!
echo !t106!
echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto IntensitaForteDenoiserFmpegSempliceCodifica
if errorlevel 2 goto IntensitaMediaDenoiserFmpegSempliceCodifica
if errorlevel 1 goto IntensitaLeggeraDenoiserFmpegSempliceCodifica

:IntensitaForteDenoiserFmpegSempliceCodifica
if !NumeroTipoDenoiser!==5 (
    set "denoiserSettings=hqdn3d=luma_spatial=12:chroma_spatial=6:luma_tmp=6:chroma_tmp=4"
)
if !NumeroTipoDenoiser!==4 (
    set "denoiserSettings=vaguedenoiser=threshold=6:percent=100:nsteps=12"
)
if !NumeroTipoDenoiser!==3 (
    set "denoiserSettings=nlmeans=s=20:p=33:r=15"
)
if !NumeroTipoDenoiser!==2 (
    set "denoiserSettings=atadenoise=0a=0.04:0b=0.12:1a=0.04:1b=0.12:2a=0.04:2b=0.12:s=9"
)
goto FineIntensitaDenoiseraFmpegSempliceCodifica


:IntensitaMediaDenoiserFmpegSempliceCodifica
if !NumeroTipoDenoiser!==5 (
    set "denoiserSettings=hqdn3d=luma_spatial=8:chroma_spatial=4:luma_tmp=6:chroma_tmp=4"
)
if !NumeroTipoDenoiser!==4 (
    set "denoiserSettings=vaguedenoiser=threshold=4:percent=100:nsteps=8"
)
if !NumeroTipoDenoiser!==3 (
    set "denoiserSettings=nlmeans=s=15:p=33:r=15"
)
if !NumeroTipoDenoiser!==2 (
    set "denoiserSettings=atadenoise=0a=0.03:0b=0.08:1a=0.03:1b=0.08:2a=0.03:2b=0.08:s=9"
)
goto FineIntensitaDenoiseraFmpegSempliceCodifica


:IntensitaLeggeraDenoiserFmpegSempliceCodifica
if !NumeroTipoDenoiser!==5 (
    set "denoiserSettings=hqdn3d=luma_spatial=4:chroma_spatial=2:luma_tmp=6:chroma_tmp=4"
)
if !NumeroTipoDenoiser!==4 (
    set "denoiserSettings=vaguedenoiser=threshold=2:percent=100:nsteps=4"
)
if !NumeroTipoDenoiser!==3 (
    set "denoiserSettings=nlmeans=s=10:p=33:r=15"
)
if !NumeroTipoDenoiser!==2 (
    set "denoiserSettings=atadenoise=0a=0.01:0b=0.02:1a=0.01:1b=0.02:2a=0.01:2b=0.02:s=9"
)
goto FineIntensitaDenoiseraFmpegSempliceCodifica


:FineIntensitaDenoiseraFmpegSempliceCodifica
echo.
set "DenoiserFinalSettings=-filter_complex ^"[0:0]!denoiserSettings![v]^" -map ^"[v]^""

:StampaParametriCodificaFFmpegSempliceCodifica
echo !t43! !DenoiserFinalSettings!


rem////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////


:IniziaCodificaFFmpegSempliceCodifica
echo.
echo Codifica FFmpeg Iniziata.... 
echo.

set file_senza_virgolette=%NomeFile:"=%
@REM echo %file_senza_virgolette%
@REM echo.

set file_senza_estensione=%file_senza_virgolette:.mkv=%
@REM echo %file_senza_estensione%
@REM echo.

set fileoutput="%file_senza_estensione%_Codificato.mkv"
@REM echo fileoutput = !fileoutput!
@REM echo.

set fileoutput_senza_virgolette=%file_senza_estensione%_Codificato.mkv
@REM echo fileoutput_senza_virgolette = !fileoutput_senza_virgolette!
@REM echo.

for %%i in ("!fileoutput_senza_virgolette!") do (  
                                                                set "solo_nome_file=%%~ni"
                                                                @REM echo Nome file: !solo_nome_file!
                                                                @REM echo.

                                                                set "solo_estensione_file=%%~xi"
                                                                @REM echo Estensione: !solo_estensione_file!
                                                                @REM echo.
                                                                )

set solo_nome_fileoutput_rinominato="!solo_nome_file!_Rinominato.mkv"       
@REM echo solo_nome_fileoutput_rinominato = !solo_nome_fileoutput_rinominato!     
@REM echo.

@REM pause


rem codifica ffmpeg
if !hdrcs!==1 if !hdrtr!==1 if !hdrcp!==1 if !fv!==1 ( 
    @REM echo.
    @REM echo hdrcs = !hdrcs!
    @REM echo hdrtr = !hdrtr!
    @REM echo hdrcp = !hdrcp!
    @REM echo fv = !fv!
    goto InizioCodifica10bitHDRFFmpegSempliceCodifica

) 

goto InizioCodifica8bitSDRFFmpegSempliceCodifica



:InizioCodifica10bitHDRFFmpegSempliceCodifica

rem start "Codifica Priorita' Alta" /d ".\bin" /high /affinity 0x00000000FFFFFFFF /Wait /b "ffmpeg.exe" -y -i "E:\sorgente.mkv"  -max_muxing_queue_size 1024  -filter_complex "[0:0]atadenoise=0a=0.01:0b=0.02:1a=0.01:1b=0.02:2a=0.01:2b=0.02:s=9,ass=logo_3840x2160.ass[v]" -map "[v]"  -c:v libx265 -pix_fmt yuv420p10le -profile:v main  -x265-params "aq-mode=3:aq-strength=0.5:repeat-headers=1:strong-intra-smoothing=1:bframes=4:b-adapt=2:frame-threads=0:colorprim=bt2020:transfer=smpte2084:colormatrix=bt2020nc:hdr10_opt=1:master-display=G(8500,39850)B(6550,2300)R(35400,14600)WP(15635,16450)L(10000000,50):max-cll=197,910:hdr10=1:chromaloc=2"  -crf:v 18  -preset:v medium  -hide_banner -stats -loglevel panic  -map_metadata -1 -map_chapters 0   -default_mode infer_no_subs   -threads 2  "E:\JDownLoader\38 Release del 12.09.2025\Le.Iene.Cani.da.Rapina(1992) VU 2160p\Le.Iene.Cani.da.rapina.1992.UHD.VU.2160p.DV.Hevc.HDR.DTS-HD.MA+AC3.ITA.ENG.SUB.LFi_Denoiser_Leggero_Dettagli_Migliorati_rinominato_Spezzone_Video_da_3840_secondi_a_3900_secondi_2160p solo video crf 18.mkv"

start "Codifica Priorita' Alta" /d ".\bin" /high /affinity 0x00000000FFFFFFFF /Wait /b "ffmpeg.exe" -y -i !NomeFile!  -max_muxing_queue_size 1024  !DenoiserFinalSettings!  -c:v libx265 -pix_fmt !formatvideo! -profile:v main10  -x265-params "!ValoreQuantizzazioneAdattiva!:!SettaggioFozaQAFFmpeg!:repeat-headers=1:strong-intra-smoothing=1:bframes=4:b-adapt=2:frame-threads=0:colorprim=!colorpr!:transfer=!colortr!:colormatrix=!colorsp!:hdr10_opt=1:!master-display!"  !tipoQuantizzazioneFFmpeg!  !SettaggioQualitaFFmpeg!  -hide_banner -stats -loglevel panic  -map_metadata -1 -map_chapters 0   -default_mode infer_no_subs   -threads 2  !fileoutput!

ren !fileoutput! !solo_nome_fileoutput_rinominato! 

echo.
echo !t114!
echo.

goto finerealehdrFmpegSempliceCodifica




:InizioCodifica8bitSDRFFmpegSempliceCodifica

rem start "Codifica Priorita' Alta" /d "C:\Users\licdo\Videos\Bluray_Rip\ffmpeg_latest" /high /affinity 0x00000000FFFFFFFF /Wait /b "ffmpeg.exe" -y -i "D:\sorgente.mkv"  -max_muxing_queue_size 1024  -filter_complex "[0:0]atadenoise=0a=0.01:0b=0.02:1a=0.01:1b=0.02:2a=0.01:2b=0.02:s=9,ass=logo_3840x2160.ass[v]" -map "[v]"  -c:v libx265 -pix_fmt yuv420p     -profile:v main  -x265-params "aq-mode=3:aq-strength=0.5:repeat-headers=0:strong-intra-smoothing=1:bframes=4:b-adapt=2:frame-threads=0:colorprim=bt709:transfer=bt709:colormatrix=bt709:chromaloc=0"   -crf:v 20 -preset:v medium   -map_metadata -1 -map_chapters 0   -default_mode infer_no_subs   -threads 2    "F:\BluRay_Rip\19 Release del 19.04.2024\La Battaglia di Lon Tan (2019) UpScaled 2160p + 1080p\La Battaglia di Long Tan - Danger Close - The Battle of Long Tan (2019) 1080p solo video crf 20.mkv"

start "Codifica Priorita' Alta" /d ".\bin" /high /affinity 0x00000000FFFFFFFF /Wait /b "ffmpeg.exe" -y -i !NomeFile!  -max_muxing_queue_size 1024  !DenoiserFinalSettings!  -c:v libx265 -pix_fmt !formatvideo! !ProfileValue!  -x265-params "!ValoreQuantizzazioneAdattiva!:!SettaggioFozaQAFFmpeg!:repeat-headers=1:strong-intra-smoothing=1:bframes=4:b-adapt=2:frame-threads=0:colorprim=!colorpr!:transfer=!colortr!:colormatrix=!colorsp!:chromaloc=0"  !tipoQuantizzazioneFFmpeg!  !SettaggioQualitaFFmpeg!  -hide_banner -stats -loglevel panic -map_metadata -1 -map_chapters 0   -default_mode infer_no_subs   -threads 2  !fileoutput!

ren !fileoutput! !solo_nome_fileoutput_rinominato! 

echo.
echo !t114!
echo.

goto finerealehdrFmpegSempliceCodifica


rem////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////


:finerealehdrFmpegSempliceCodifica

goto FineRealeFmpegSempliceCodifica


:solohdr10plusFFmpegSempliceCodifica
echo !t107!
echo.
goto FineRealeFmpegSempliceCodifica

:solodvFFmpegSempliceCodifica
echo !t107!
echo.
goto FineRealeFmpegSempliceCodifica

:novideofileFmpegSempliceCodifica
echo !t63!
echo.
goto FineRealeFmpegSempliceCodifica



:FineRealeFmpegSempliceCodifica


if exist ".\temp\Temp_HDR10.txt" ( del ".\temp\Temp_HDR10.txt" )
if exist ".\temp\Temp_HDR10_Finale.txt" ( del ".\temp\Temp_HDR10_Finale.txt" )
if exist ".\temp\Temp_HDR10_Stream.txt" ( del ".\temp\Temp_HDR10_Stream.txt" ) 
if exist ".\temp\durata_film.txt" ( del ".\temp\durata_film.txt" )
if exist ".\temp\crop.txt" ( del ".\temp\crop.txt" )
if exist ".\temp\risultato_multiplo.txt" ( del ".\temp\risultato_multiplo.txt" )
if exist ".\temp\crop_multiplo.txt" ( del ".\temp\crop_multiplo.txt" )
if exist ".\temp\crop_finale.txt" ( del ".\temp\crop_finale.txt" )


if exist ".\saved\settings.dat" (
                                for /f "tokens=1,2 delims=|" %%a in (.\saved\settings.dat) do (
                                                                                                    rem echo %%a
                                                                                                    rem echo %%b
                                                                                                    set /a "shst=%%b"
                                                                                                    rem echo !shst!
                                                                                                    rem pause
                                                                                                    if !shst!==1 (
                                                                                                                echo !t1000!
                                                                                                                echo.
                                                                                                                shutdown /s
                                                                                                                set /a "delay=10"
                                                                                                                timeout /t !delay!
                                                                                                                exit
                                                                                                                )
                                                                                                                            
                                                                                                    )                                                                                                  
                                                                                                )




set waitenter=
set /P waitenter=!t115!
Endlocal
goto puliziainiziale







rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:SempliceCodificaHardwareIntel

cls
setLocal EnableExtensions EnableDelayedExpansion





for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoSempliceCodificaHardwareIntel
)

if %lingua%==inglese (
    goto caricalinguaingleseSempliceCodificaHardwareIntel
)



:caricalinguaingleseSempliceCodificaHardwareIntel
@REM set t1=Insert Hardware Video Encoding Info and Saving to Disk

set t2=Drag Here the Video File for Hardware Encoding with GPU Intel:  
@REM set t211=Video for Hardware Encoding with GPU:  

set t3=File does not exist 
set t4=Info Video:  

set t5=The Inserted Video is 2160p 8bit SDR 
set t511=The Inserted Video is 2160p 10bit SDR 

set t6=The Inserted Video isn't 2160p 8bit or 10bit SDR 
set t7=Video Duration in seconds:
set t8=Video Duration in Minutes:
set t9=Interval between Frames for Crop Detection:
set t10= seconds
set t11=Black Bands Detection Started....
set t12=Crop Detection to Frame
set t13=to seconds
set t14=Done...
set t15=Original 2160p Video Width: 
set t16=Original 2160p Video Height:
set t17=Original Video Width Without Black Bars:
set t18=Original Video Height Without Black Bars:

set t171=Output Video 1080p Width Without Black Bars:
set t181=Outout Video 1080p Height Without Black Bars:

set t19=Adapting Video Resolution to Full 2160p Format...
set t20=Final 2160p Output Video Width:
set t21=Final 2160p Output Video Height:

set t22=Settings of Black Bands to Crop are Correct (Yes/No):
set t23=Manually Entering Black Bands Values to Crop... 
set t24=Enter the Upper Black Band Value: 
set t25=Error Entering Upper Black Band Value... It's Not a Number. 
set t26=Enter the Lower Black Band Value: 
set t27=Error Entering Lower Black Band Value... It's Not a Number.
set t28=Enter the Left Black Band Value: 
set t29=Error Entering Left Black Band Value... It's Not a Number.
set t30=Enter the Right Black Band Value: 
set t31=Error Entering Right Black Band Value... It's Not a Number.
set t32=Upper Black Band:
set t33=Lower Black Band:
set t34=Left Black Band:
set t35=Right Black Band:
set t36=2160p Original Video Width without Black Bars:
set t37=2160p Original Video Height without Black Bars:

@REM set t361=1080p Video Width without Black Bars:
@REM set t371=1080p Video Height without Black Bars

set t38=Select Graphic Card you want to Encode with:
set t39=Choose (1/2):
set t40=Select Encoding Type:
set t41=Error Entering Quantization Value... Not a Number. 
set t42=Quantization Value Set to:
set t43=Encoding Settings:
set t44=Enter Quantization value Minimum 10 Maximum 28:
set t45=Quantization Value Out of  Limits  10 / 28  Re-enter^!
set t46=Enter BitRate Value kbs Minimum 100 Maximum 50000:
set t47=Error Entering BitRate Value... It's Not a Number. 
set t48=BitRate Value Set to:
set t49=BitRate Value Out of Limits  100 / 50000  Re-enter^!
set t50=Select Encoding Quality:
set t51=- Worst Quality
set t52=- Best Quality
set t53=Choose (1/2/3/4/5/6/7):
set t54=Quality Set to:
set t55=Apply Convolution3D denoiser Yes/No: 
set t56=Apply PMD denoiser Yes/No: 
set t57=Apply Detail Enhancement Yes/No:  
set t58=Enhancement Detail: Yes 
set t59=Enhancement Detail: No 
set t60=Info
set t61=Videos to Encode Saved!
set t62=Do You Want to Insert Another Video to Encode (Yes/No):
set t63=The dragged file is not a video!
set t64=Choose (1/2/3/4):
set t65=Press Enter toback to Menu Inserting Encoding into the Queue and Saving to Disk:  

set t66=Video Width
set t67=Video Height
set t68=Video Codec
set t69=Details Video Codec
set t70=Video Format 
set t71=Configuration Settings to convert video from 8bit or 10bit SDR to 10bit HDR
set t72=Select Encoding UpGrader:
set t73=Settings UpGrader:
set t74=Choose (1/2/3):

set t75=Configuration Encoding Lookahead:
set t76=Insert Value of Lookahead (1-32): 
set t77=Error Entering Lookahead Value... Not a Number.
set t78=Lookahead Value Entered Out of Range 1-32
set t79=Lookahead Settings:

set t80=Select type of Adaptive Quantization:
set t81=- Disabled
set t82=Adaptive Quantization Settings:

set t83=Setting Intensity of Adaptive Quantization:
set t84=Insert Value of Adaptive Quantization Intensity (0-15): 
set t841=Error Entering Quantization Strength Value... It's Not a Number. 
set t85=Value Adaptive Quantization Intensity Entered Out of Range 1-15
set t86=- Automatic
set t87=Adaptive Quantization Intensity Setting:

set t88=Select Motion Vector Accuracy:
set t89=- Best
set t90=- Worst
set t91=Motion Vector Accuracy Setting:

set t92=Select Denoiser:
set t93=No Denoiser
set t94=No Denoiser Selected.

set t95=Select Strength Covolution3D Denoiser:
set t96=Weak
set t97=Moderate
set t98=Strong
set t99=Covolution3D Setting:

set t100=Select Strength PMD Denoiser:
set t101=PMD Denoiser Setting:

set t102=Select Strength FFT3D Denoiser :
set t103=FFT3D Denoiser Setting:

set t104=Select Strength KNN Denoiser:
set t105=KNN Denoiser Setting:

set t106=Select Strength NLMEANS Denoiser:
set t107=NLMEANS Denoiser Setting:

set t108=Select Strength DCT Denoiser:
set t109=DCT Denoiser Setting:

set t110=Insert Value of Lookahead (10-99): 
set t111=Value of Lookahead Entered Out of Range 10-99

set t112=Encoding Finished...
set t113=Press Enter to Back to Main Menu:  
set t114=Encoding Started.... 
set t1000=Now the PC will be turned off... 

goto avvio_SempliceCodificaHardwareIntel




:caricalinguaitalianoSempliceCodificaHardwareIntel
@REM set t1=Inserimento Info Codifica Hardware Video e Salvataggio su Disco.

set t2=Trascina Qui il File Video per Codifica Hardware con GPU Intel:  
@REM set t211=File Video per la Codifica Hardware con la GPU:  

set t3=File Inesistente 
set t4=Informazioni Video:  

set t5=Il Video inserito e' 2160p 8bit SDR 
set t511=Il Video inserito e' 2160p 10bit SDR 

set t6=Il Video inserito non e' 2160p 8bit o 10bit SDR 

set t7=Durata del Video in secondi:
set t8=Durata del video in Minuti:
set t9=Intervallo tra i Fotogrammi per il Rilevamento del crop:
set t10= secondi
set t11=Rilevamento Bande Nere Iniziato....
set t12=Rilevazione crop fotogramma
set t13=a secondi
set t14=Eseguita...
set t15=Larghezza Video 2160p Originale:
set t16=Altezza Video 2160p Originale:
set t17=Larghezza Video Originale Senza Barre Nere:
set t18=Altezza Video Originale Senza Barre Nere:

set t171=Larghezza Video 1080p  Senza Barre Nere:
set t181=Altezza Video 1080p  Senza Barre Nere:

set t19=Adattamento della Risoluzione del Video al Pieno Formato 2160p..
set t20=Larghezza Finale Video 2160p:
set t21=Altezza Finale Video 2160p:

set t22=Le Impostazioni delle Bande Nere da Tagliare sono Corrette (Si/No):
set t23=Inserimento Manuale Valori Bande Nere da Tagliare.. 
set t24=Inserisci il Valore della Banda Nera Superiore: 
set t25=Errore nell'Inserimento del Valore della Banda Nera Superiore... Non e' un Numero. 
set t26=Inserisci il Valore della Banda Nera Inferiore: 
set t27=Errore nell'Inserimento del Valore della Banda Nera Inferiore... Non e' un Numero. 
set t28=Inserisci il Valore della Banda Nera Sinistra: 
set t29=Errore nell'Inserimento del Valore della Banda Nera Sinistra... Non e' un Numero. 
set t30=Inserisci il Valore della Banda Nera Destra: 
set t31=Errore nell'Inserimento del Valore della Banda Nera Destra... Non e' un Numero. 
set t32=Banda Nera Superiore:
set t33=Banda Nera Inferiore:
set t34=Banda Nera Sinistra:
set t35=Banda Nera Destra:
set t36=Larghezza Video Originale 2160p senza Bande Nere:
set t37=Altezza Video Originale 2160p senza Bande Nere:

@REM set t361=Larghezza Video 1080p senza Bande Nere:
@REM set t371=Altezza Video 1080p senza Bande Nere:

set t38=Selezionare Scheda Grafica con cui Eseguire la Codifica:
set t39=Scegli (1/2):
set t40=Selezionare tipo di Codifica:
set t41=Errore nell'Inserimento del Valore della Quantizzazione... Non e' un Numero. 
set t42=Valore Quantizzazzione Impostato a:
set t43=Parametri per codifica:

set t44=Inserire Valore Quantizzazione Minimo 10 Massimo 28:
set t45=Valore Quantizzazzione al di fuori dei  Limiti  10 / 28  Reinserire^!
set t46=Inserire Valore BitRate kbs Minimo 100 Massimo 50000:
set t47=Errore nell'Inserimento del Valore del BitRate... Non e' un Numero. 
set t48=Valore BitRate Impostato a:
set t49=Valore  BitRate al di fuori dei  Limiti  100 / 50000  Reinserire^!

set t50=Selezionare Qualita' Codifica:
set t51=- Peggiore Qualita'
set t52=- Migliore Qualita'
set t53=Scegli (1/2/3/4/5/6/7):
set t54=Qualita' Impostata su:
set t55=Applicare il denoiser Convolution3D Si/No: 
set t56=Applicare il denoiser PMD Si/No: 
set t57=Applicare il Miglioramento Dettagli Si/No:  
set t58=Miglioramento Dettagli: Si 
set t59=Miglioramento Dettagli: No 
set t60=Informazioni
set t61=Video da Codificare Salvate!
set t62=Vuoi Inserire un altro Video da Codificare (Si/No):
set t63=Il file trascinato non e' un video!
set t64=Scegli (1/2/3/4):
set t65=Premi Invio per tornare al menu' Inserimento Codifiche in Coda e Salvataggio sul Disco:  

set t66=Larghezza Video
set t67=Altezza Video
set t68=Codec Video
set t69=Codec Video Dettagli
set t70=Format Video 
set t71=Configurazione Parametri per convertire il video da 8bit o 10bit SDR a 10bit HDR
set t72=Selezionare UpGrader Codifica:
set t73=UpGrader Impostato:
set t74=Scegli (1/2/3):

set t75=Configurazione Lookahead Codifica:
set t76=Inserisci il Valore Lookahead (1-32): 
set t77=Errore nell'Inserimento del Valore Lookahead... Non e' un Numero. 
set t78=Valore Lookahead Inserito fuori dall'Intervallo 1-32
set t79=Lookahead Impostato su:

set t80=Selezionare il tipo di Quantizzazione Adattiva:
set t81=- Disabilitata
set t82=Quantizzazione Adattiva Impostata su:

set t83=Impostare Forza Quantizzazione Adattiva:
set t84=Inserisci il Valore della Forza Quantizzazione Adattativa (0-15): 
set t841=Errore nell'Inserimento del Valore Forza Quantizzazione... Non e' un Numero. 
set t85=Valore Forza Quantizzazione Adattativa Inserito fuori dall'Intervallo 1-15
set t86=- Automatica
set t87=Forza Quantizzazione Adattiva Impostata su:

set t88=Selezionare la Precisione del Vettore di Movimento:
set t89=- Migliore
set t90=- Peggiore
set t91=Precisione del Vettore di Movimento Impostata su:

set t92=Selezionare il tipo di Denoiser:
set t93=Nessun Denoiser
set t94=Nessun Denoiser Selezionato.

set t95=Selezionare Forza Denoiser Covolution3D:
set t96=Leggero
set t97=Medio
set t98=Forte
set t99=Covolution3D Denoiser Impostato su:

set t100=Selezionare Forza Denoiser PMD:
set t101=PMD Denoiser Impostato su:

set t102=Selezionare Forza Denoiser FFT3D:
set t103=FFT3D Denoiser Impostato su:

set t104=Selezionare Forza Denoiser KNN:
set t105=KNN Denoiser Impostato su:

set t106=Selezionare Forza Denoiser NLMEANS:
set t107=NLMEANS Denoiser Impostato su:

set t108=Selezionare Forza Denoiser DCT:
set t109=DCT Denoiser Impostato su:

set t110=Inserisci il Valore Lookahead (10-99): 
set t111=Valore Lookahead Inserito fuori dall'Intervallo 10-99

set t112=Codifica Terminata...
set t113=Premi Invio per tornare al menu' principale:  
set t114=Codifica Iniziata.... 
set t1000=Il PC ora verra' Spento... 


goto avvio_SempliceCodificaHardwareIntel

:avvio_SempliceCodificaHardwareIntel




set /a "numeromovie=1"


:altrivideodainserireNVEnc_SempliceCodificaHardwareIntel


set NomeFile=
rem set MetadatiStreamHDR10=

set /P NomeFile=!t2!
rem echo Hai digitato: %NomeFile%
rem pause

set "NomeFileSorgente=!NomeFile:"=!"
@REM echo NomeFileSorgente = !NomeFileSorgente!
set "NomeFile=^"!NomeFileSorgente!^""
@REM echo NomeFile = !NomeFile!
rem pause


if exist %NomeFile% ( goto infovideo_SempliceCodificaHardwareIntel ) else ( 
                                                        echo.
                                                        echo !t3!
                                                        echo.
                                                        goto fineinfovideo_SempliceCodificaHardwareIntel
                                                        )    



:infovideo_SempliceCodificaHardwareIntel
echo.
echo !t4!
echo.

.\bin\ffprobe -v error -hide_banner -select_streams v:0 -show_entries stream=width,height,codec_name,codec_long_name,pix_fmt,color_space,color_transfer,color_primaries -of default=noprint_wrappers=1 %NomeFile% > ".\temp\Temp_HDR10_Stream.txt"

set /A x1=1

rem echo nohdr = %nohdr%

for /f "tokens=1,2 delims==" %%a in (.\temp\Temp_HDR10_Stream.txt) do (if !x1!==3 ( 
                                                                            echo !t66! "%%a" = %%b  
                                                                            set /A "widthvideo=%%b"
                                                                            )
                                                                if !x1!==4 ( 
                                                                            echo !t67! "%%a" = %%b  
                                                                            set /A "heightvideo=%%b"
                                                                            )                                                           
                                                                if !x1!==6 ( 
                                                                            echo Color Space "%%a" = %%b  
                                                                            set "colorsp=%%b"              
                                                                            ) 
                                                                if !x1!==7 ( 
                                                                            echo Color Transfer "%%a" = %%b  
                                                                            set "colortr=%%b"      
                                                                            ) 
                                                                if !x1!==8 ( 
                                                                            echo Color Primaries "%%a" = %%b  
                                                                            set "colorpr=%%b"         
                                                                            )    
                                                                if !x1!==1 ( 
                                                                            echo !t68! "%%a" = %%b  
                                                                            )       
                                                                if !x1!==2 ( 
                                                                            echo !t69! "%%a" = %%b  
                                                                            )   
                                                                if !x1!==5 ( 
                                                                            echo !t70! "%%a" = %%b  
                                                                            set "formatvideo=%%b"
                                                                            )
                                                                set /A x1+=1                                                            
)

if !x1!==1 goto novideofile_SempliceCodificaHardwareIntel

if !formatvideo!==yuv420p (
        set "tiervalue=--tier main"
        set "outputdepthvalue=--output-depth 8"
)

if !formatvideo!==yuv420p10le (
        set "tiervalue=--tier high"
        set "outputdepthvalue=--output-depth 10"
)

:rilevazionebandenere_SempliceCodificaHardwareIntel

.\bin\ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 %NomeFile%  > ".\temp\durata_film.txt"


set /a contatore=1
for /f "tokens=1 delims=." %%a in (.\temp\durata_film.txt) do  (
                                                        echo. 
                                                       echo !t7! %%a
                                                        set /a "secondi=%%a"
                                                        set /a "minuti=!secondi!/60"
                                                        echo !t8! !minuti!
                                                        set /a "intervallo_tagli=!secondi!/11"
                                                        echo !t9! !intervallo_tagli!!t10!
                                                        echo.
                                                        echo !t11!
                                                        echo.

                                                        

                                                        FOR /L %%a IN (1, 1, 10) DO (
                                                                                    rem echo %%a
                                                                                    set /a "secondi=%%a*!intervallo_tagli!"
                                                                                    rem echo !secondi!

                                                                                    if !formatvideo!==yuv420p (
                                                                                                                set /a "ca=16"
                                                                                                                rem echo !ca!
                                                                                                                    
                                                                                                                set /a "cb=2"
                                                                                                                rem echo !cb!
                                                                                                                    
                                                                                                                set /a "cc=0"
                                                                                                                rem echo !cc!

                                                                                                                set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                                                rem echo !cr!
                                                                                                                )

                                                                                    if !formatvideo!==yuv420p10le  ( 
                                                                                                                    set /a "ca=72"
                                                                                                                    rem echo !ca!
                                                                                                                    
                                                                                                                    set /a "cb=2"
                                                                                                                    rem echo !cb!
                                                                                                                    
                                                                                                                    set /a "cc=0"
                                                                                                                    rem echo !cc!

                                                                                                                    set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                                                    rem echo !cr!
                                                                                                                    )                                                                                                                

                                    
                                                                                
                                                                                
                                                                                    .\bin\ffmpeg -ss !secondi! -hide_banner -nostats -i %NomeFile% -vframes 10 -vf !cr! -f null - 2> ".\temp\crop.txt"
                                                                                    
                                                                                    findstr /r "Parsed_cropdetect_0" .\temp\crop.txt >> .\temp\risultato_multiplo.txt   
                                                                                    
                                                                                    echo !t12! %%a !t13! !secondi! !t14!
                                                                                    
                                                                                    )       
                                                                                       

                                                                                    for /f "tokens=1,2 delims==" %%a in (.\temp\risultato_multiplo.txt) do ( echo %%b >> .\temp\crop_multiplo.txt )
                                                                                    
                                                                                    set /a "maxfrequenza=0"

                                                                                    for /f "delims=" %%a in (.\temp\crop_multiplo.txt) do ( 
                                                                                                                                    set "cropconfront=%%a"
                                                                                                                                    rem echo "!cropconfront!"
                                                                                                                                    
                                                                                                                                    set /a "contatorfrequenza=0"
                                                                                                                                    for /f "delims=" %%b in (.\temp\crop_multiplo.txt) do (
                                                                                                                                                                                    set "dato_da_verificare=%%b"
                                                                                                                                                                                    rem echo cropconfront = "!cropconfront!"
                                                                                                                                                                                    rem echo dato_da_verificare = "!dato_da_verificare!"
                                                                                                                                                                                    if !cropconfront!==!dato_da_verificare! ( set /a "contatorfrequenza+=1")
                                                                                                                                                                                    )
                                                                                                                                    if !maxfrequenza! LSS !contatorfrequenza! ( 
                                                                                                                                                                                set /a "maxfrequenza=!!contatorfrequenza!!"
                                                                                                                                                                                set "cropd=!cropconfront!"
                                                                                                                                                                                )
                                                                                                                                    

                                                                                                                                    rem if !cropconfront! in (elenco_crop_frequenza.txt) ()
                                                                                                                                    rem echo !cropconfront!:!contatorfrequenza! >> elenco_crop_frequenza.txt

                                                                                                                                    )

                                                                                    rem echo crop piu' frequente = !cropd! con grequenza = !maxfrequenza!
                                                                                    echo !cropd! > .\temp\crop_finale.txt

                                                                                    for /f "tokens=1,2,3,4 delims=:" %%a in (.\temp\crop_finale.txt) do  ( 
                                                                                                                                                    rem set /a "mwidth=%%a"
                                                                                                                                                    rem echo mwidth = !mwidth!

                                                                                                                                                    rem set /a "mheight=%%b"
                                                                                                                                                    rem echo mheight = !mheight!

                                                                                                                                                    rem set /a "mx=%%c"
                                                                                                                                                    rem echo mx = !mx!

                                                                                                                                                    rem set /a "my=%%d"
                                                                                                                                                    rem echo my = !my!

                                                                                                                                                    if !contatore!==1 ( 
                                                                                                                                                                set /a "wmax=%%a" 
                                                                                                                                                                set /a "hmax=%%b"
                                                                                                                                                                set /a "xmin=%%c"
                                                                                                                                                                set /a "ymin=%%d"
                                                                                                                                                                set /a "mwidth=%%a"
                                                                                                                                                                set /a "mheight=%%b"
                                                                                                                                                                set /a "mx=%%c"
                                                                                                                                                                set /a "my=%%d"
                                                                                                                                                                set /a "contatore+=1"
                                                                                                                                                                )
                                                                                                                                                    
                                                                                                                                                    rem if %%b gtr !hmax! if %%c gtr !xmin! if %%d gtr !ymin! 

                                                                                                                                                    if %%a geq !wmax! if %%b geq !hmax! ( 
                                                                                                                                                                        set /a "wmax=%%a" 
                                                                                                                                                                        set /a "hmax=%%b"
                                                                                                                                                                        set /a "xmin=%%c"
                                                                                                                                                                        set /a "ymin=%%d"
                                                                                                                                                                        set /a "mwidth=%%a"
                                                                                                                                                                        set /a "mheight=%%b"
                                                                                                                                                                        set /a "mx=%%c"
                                                                                                                                                                        set /a "my=%%d"
                                                                                                                                                                        )
                                                                                                                                                    )
                                                                                    echo.
                                                                                    
                                                                                    set /a "mwidth=!mwidth!/2*2"
                                                                                    set /a "mheight=!mheight!/2*2"

                                                                                    set /a "csup=!my!/2*2"
                                                                                    rem echo csup = !csup!
                                                                                                                                    
                                                                                    set /a "csin=!mx!/2*2"
                                                                                    rem echo csin = !csin!

                                                                                    set /a "cinf=(!heightvideo!-!mheight!-!my!)/2*2"
                                                                                    rem echo movieheightreal = !movieheightreal!
                                                                                    rem echo cinf = !cinf!
                                                                                    set /a "cdes=(!widthvideo!-!mwidth!-!mx!)/2*2"
                                                                                    rem echo cdes = !cdes!

                                                                                    echo Crop Settings: --crop !csin!,!csup!,!cdes!,!cinf!    
                                                                                    set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
                                                                                    echo.  
                                                                                    
                                                                                    echo !t17!  !mwidth! 
                                                                                    echo !t18!  !mheight! 
                                                                                    echo.
                                                                                    )  
                                                        )                          

:cropmanuale_SempliceCodificaHardwareIntel
set /a "csup=0"
set /a "cinf=0"
set /a "csin=0"
set /a "cdes=0"
set /a "bandasuperiore=0"
set /a "bandainferiore=0"
set /a "bandasinistra=0"
set /a "bandadestra=0"
if exist ".\temp\Temp_HDR10_Stream.txt" ( del ".\temp\Temp_HDR10_Stream.txt" ) 
if exist ".\temp\durata_film.txt" ( del ".\temp\durata_film.txt" )
if exist ".\temp\crop.txt" ( del ".\temp\crop.txt" )
if exist ".\temp\risultato_multiplo.txt" ( del ".\temp\risultato_multiplo.txt" )
if exist ".\temp\crop_multiplo.txt" ( del ".\temp\crop_multiplo.txt" )
if exist ".\temp\crop_finale.txt" ( del ".\temp\crop_finale.txt" )

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t22!"   
    if errorlevel 2 goto cropmanuale_SempliceCodificaHardwareIntel
    if errorlevel 1 goto finecrop_SempliceCodificaHardwareIntel
)
CHOICE /N /C:SN /M "!t22!"   

if errorlevel 2 goto cropmanuale_SempliceCodificaHardwareIntel
if errorlevel 1 goto finecrop_SempliceCodificaHardwareIntel


:cropmanuale_SempliceCodificaHardwareIntel
echo.
echo !t23!
echo.

:banda_superiore_SempliceCodificaHardwareIntel
set /p "bandasuperiore=!t24! "
SET "var="&for /f "delims=0123456789" %%i in ("!bandasuperiore!") do set var=!bandasuperiore!
if defined var (
                echo.
                echo !t25!
                echo.
                goto banda_superiore_SempliceCodificaHardwareIntel
                ) else (
                        set /a "csup=!bandasuperiore!/2*2"
                        )

echo.
:banda_inferiore_SempliceCodificaHardwareIntel
set /p "bandainferiore=!t26! "  
SET "var="&for /f "delims=0123456789" %%i in ("!bandainferiore!") do set var=!bandainferiore!
if defined var (
                echo.
                echo !t27!
                echo.
                goto banda_inferiore_SempliceCodificaHardwareIntel
                ) else (
                        set /a "cinf=!bandainferiore!/2*2"
                        )


echo.
:banda_sinistra_SempliceCodificaHardwareIntel
set /p "bandasinistra=!t28! "  
SET "var="&for /f "delims=0123456789" %%i in ("!bandasinistra!") do set var=!bandasinistra!
if defined var (
                echo.
                echo !t29!
                echo.
                goto banda_sinistra_SempliceCodificaHardwareIntel
                ) else (
                        set /a "csin=!bandasinistra!/2*2"
                        )

                        
echo.
:banda_destra_SempliceCodificaHardwareIntel
set /p "bandadestra=!t30! "  
SET "var="&for /f "delims=0123456789" %%i in ("!bandadestra!") do set var=!bandadestra!
if defined var (
                echo.
                echo !t31!
                echo.
                goto banda_destra_SempliceCodificaHardwareIntel
                ) else (
                        set /a "cdes=!bandadestra!/2*2"
                        )


set /a "mwidth=!widthvideo!/2*2"
set /a "mheight=!heightvideo!/2*2"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "mwidthc=!mwidth!-!csin!-!cdes!"
set /a "mheightc=!mheight!-!csup!-!cinf!"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "mwidth=!mwidthc!"
set /a "mheight=!mheightc!"

echo.
echo !t32!  !csup! 
echo !t33!  !cinf! 
echo !t34!  !csin! 
echo !t35!  !cdes! 
echo.

set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
echo Crop Settings: !cropff!
echo.

echo !t17!  !mwidth! 
echo !t18!  !mheight! 
echo.

goto cropmanuale_SempliceCodificaHardwareIntel

:finecrop_SempliceCodificaHardwareIntel




:InserimentoImpostazioniQSVEnc_SempliceCodificaHardwareIntel

echo.
echo !t40!
echo.
echo 1) CQP 
echo 2) ICQ 
echo 3) LA-ICQ 
echo 4) VBR 
echo.
CHOICE /N /C:1234 /M "!t64!"

if errorlevel 4 goto CodificaVBRQSVEnc_SempliceCodificaHardwareIntel
if errorlevel 3 goto CodificaLAICQQSVEnc_SempliceCodificaHardwareIntel
if errorlevel 2 goto CodificaICQQSVEnc_SempliceCodificaHardwareIntel
if errorlevel 1 goto CodificaCQPQSVEnc_SempliceCodificaHardwareIntel


:CodificaCQPQSVEnc_SempliceCodificaHardwareIntel
set "TipoCodificaQSVEnc=--cqp "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc_SempliceCodificaHardwareIntel

:CodificaICQQSVEnc_SempliceCodificaHardwareIntel
set "TipoCodificaQSVEnc=--icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc_SempliceCodificaHardwareIntel

:CodificaLAICQQSVEnc_SempliceCodificaHardwareIntel
set "TipoCodificaQSVEnc=--la-icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc_SempliceCodificaHardwareIntel

:CodificaVBRQSVEnc_SempliceCodificaHardwareIntel
set "TipoCodificaQSVEnc=--vbr "
set /a "quantizzazioneQSVEnc=0"
goto inserimentoValoriCQPVBRQSVEnc_SempliceCodificaHardwareIntel


:inserimentoValoriCQPVBRQSVEnc_SempliceCodificaHardwareIntel

if !quantizzazioneQSVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneQSVEnc=!t44! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneQSVEnc!") do set var=!valoreQuantizzazioneQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                goto inserimentoValoriCQPVBRQSVEnc_SempliceCodificaHardwareIntel
                                                ) 

                                set /a "valoreQuantizzazioneQSVEnc=!valoreQuantizzazioneQSVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneQSVEnc!
                                if !valoreQuantizzazioneQSVEnc! GEQ 10 if !valoreQuantizzazioneQSVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneQSVEnc!
                                                                                                                set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreQuantizzazioneQSVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                                goto fineQuantizzazioneQSVEnc_SempliceCodificaHardwareIntel
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRQSVEnc_SempliceCodificaHardwareIntel
                                                                                                                        
                                )



if !quantizzazioneQSVEnc!==0 (
                                echo.
                                set /p "valoreBitRateQSVEnc=!t46! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateQSVEnc!") do set var=!valoreBitRateQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                goto inserimentoValoriCQPVBRQSVEnc_SempliceCodificaHardwareIntel
                                                ) 
                                set /a "valoreBitRateQSVEnc=!valoreBitRateQSVEnc!"
                                @REM echo valoreBitRateQSVEnc = !valoreBitRateQSVEnc!
                                if !valoreBitRateQSVEnc! GEQ 100 if !valoreBitRateQSVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateQSVEnc!
                                                                                                        set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreBitRateQSVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                        goto fineQuantizzazioneQSVEnc_SempliceCodificaHardwareIntel
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRQSVEnc_SempliceCodificaHardwareIntel
                                                                                                              
                                )


:fineQuantizzazioneQSVEnc_SempliceCodificaHardwareIntel



echo.
echo !t50!
echo.
echo 1) Best 
echo 2) Higher 
echo 3) High 
echo 4) Balanced 
echo 5) Fast 
echo 6) Faster 
echo 7) Fastest 
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto QualitFastestQSVEnc_SempliceCodificaHardwareIntel
if errorlevel 6 goto QualitFasterQSVEnc_SempliceCodificaHardwareIntel
if errorlevel 5 goto QualitFastQSVEnc_SempliceCodificaHardwareIntel
if errorlevel 4 goto QualitBalancedtQSVEnc_SempliceCodificaHardwareIntel
if errorlevel 3 goto QualitHighQSVEnc_SempliceCodificaHardwareIntel
if errorlevel 2 goto QualitHigherQSVEnc_SempliceCodificaHardwareIntel
if errorlevel 1 goto QualitBestQSVEnc_SempliceCodificaHardwareIntel


:QualitBestQSVEnc_SempliceCodificaHardwareIntel
set "SettaggioQualitaQSvenc=--quality best"
set "QualitySetting=best"
goto fineQualitCodificaQSVEnc_SempliceCodificaHardwareIntel

:QualitHigherQSVEnc_SempliceCodificaHardwareIntel
set "SettaggioQualitaQSvenc=--quality higher"
set "QualitySetting=higher"
goto fineQualitCodificaQSVEnc_SempliceCodificaHardwareIntel

:QualitHighQSVEnc_SempliceCodificaHardwareIntel
set "SettaggioQualitaQSvenc=--quality high"
set "QualitySetting=high"
goto fineQualitCodificaQSVEnc_SempliceCodificaHardwareIntel

:QualitBalancedtQSVEnc_SempliceCodificaHardwareIntel
set "SettaggioQualitaQSvenc=--quality balanced"
set "QualitySetting=balanced"
goto fineQualitCodificaQSVEnc_SempliceCodificaHardwareIntel

:QualitFastQSVEnc_SempliceCodificaHardwareIntel
set "SettaggioQualitaQSvenc=--quality fast"
set "QualitySetting=fast"
goto fineQualitCodificaQSVEnc_SempliceCodificaHardwareIntel

:QualitFasterQSVEnc_SempliceCodificaHardwareIntel
set "SettaggioQualitaQSvenc=--quality faster"
set "QualitySetting=faster"
goto fineQualitCodificaQSVEnc_SempliceCodificaHardwareIntel

:QualitFastestQSVEnc_SempliceCodificaHardwareIntel
set "SettaggioQualitaQSvenc=--quality fastest"
set "QualitySetting=fastest"
goto fineQualitCodificaQSVEnc_SempliceCodificaHardwareIntel


:fineQualitCodificaQSVEnc_SempliceCodificaHardwareIntel
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaQSvenc!



echo.
echo !t75!
echo.

:inserimentolookaheadQSVEnc_SempliceCodificaHardwareIntel
set /p "valorelook=!t110! "  
SET "var="&for /f "delims=0123456789" %%i in ("!valorelook!") do set var=!valorelook!

@REM echo valorelook = !valorelook!
@REM echo var = !var!

if defined var (
                echo.
                echo !t77!
                echo.
                goto inserimentolookaheadQSVEnc_SempliceCodificaHardwareIntel
                ) else (
                        set /a "lookaheadvalue=!valorelook!"
                        set "SettaggioLookahead=--la-depth !valorelook!"
                        @REM echo lookaheadvalue = !lookaheadvalue!
                        )


if !lookaheadvalue! LSS 10 (     echo.
                                echo !t111!
                                echo.
                                goto inserimentolookaheadQSVEnc_SempliceCodificaHardwareIntel
                                )

if !lookaheadvalue! GTR 99 (    echo.
                                echo !t111!
                                echo.
                                goto inserimentolookaheadQSVEnc_SempliceCodificaHardwareIntel
                                )

echo.
echo !t79! !lookaheadvalue!
echo.
echo !t43! !SettaggioLookahead!
@REM pause



rem denoiser
echo.
echo !t92!
echo.
echo 1) Convolution3D
echo 2) PMD
echo 3) FFT3D
echo 4) KNN
echo 5) NLMEANS
echo 6) DCT
echo 7) !t93!
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto NessundenoiserQSVEnc_SempliceCodificaHardwareIntel
if errorlevel 6 goto denoiserDCTQSVEnc_SempliceCodificaHardwareIntel
if errorlevel 5 goto denoiserNLMEANSQSVEnc_SempliceCodificaHardwareIntel
if errorlevel 4 goto denoiserKNNQSVEnc_SempliceCodificaHardwareIntel
if errorlevel 3 goto denoiserFFT3DQSVEnc_SempliceCodificaHardwareIntel
if errorlevel 2 goto denoiserPMDQSVEnc_SempliceCodificaHardwareIntel
if errorlevel 1 goto denoiserConvolution3DQSVEnc_SempliceCodificaHardwareIntel


:NessundenoiserQSVEnc_SempliceCodificaHardwareIntel
echo.
set "nvdenoiser="
echo !t94!

goto finesceltadenoiserQSVEnc_SempliceCodificaHardwareIntel


:denoiserConvolution3DQSVEnc_SempliceCodificaHardwareIntel
echo.
echo !t95!
echo.
echo 1) !t96!
echo 2) !t97!
echo 3) !t98!
echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto Convolution3DForteQSVEnc_SempliceCodificaHardwareIntel
if errorlevel 2 goto Convolution3DMedioQSVEnc_SempliceCodificaHardwareIntel
if errorlevel 1 goto Convolution3DLeggeroQSVEnc_SempliceCodificaHardwareIntel


:Convolution3DForteQSVEnc_SempliceCodificaHardwareIntel
set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=4.50,cthresh=6.00,t_ythresh=1.50,t_cthresh=2.00" 
echo.
echo !t99! !t98!
echo.
echo !t43! !nvdenoiser! 
goto fineconvolution3dimpostazioniQSVEnc_SempliceCodificaHardwareIntel

:Convolution3DMedioQSVEnc_SempliceCodificaHardwareIntel
set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=3.00,cthresh=4.00,t_ythresh=1.50,t_cthresh=2.00" 
echo.
echo !t99! !t97!
echo.
echo !t43! !nvdenoiser! 
goto fineconvolution3dimpostazioniQSVEnc_SempliceCodificaHardwareIntel

:Convolution3DLeggeroQSVEnc_SempliceCodificaHardwareIntel
set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
echo.
echo !t99! !t96!
echo.
echo !t43! !nvdenoiser! 
goto fineconvolution3dimpostazioniQSVEnc_SempliceCodificaHardwareIntel

:fineconvolution3dimpostazioniQSVEnc_SempliceCodificaHardwareIntel

goto :finesceltadenoiserQSVEnc_SempliceCodificaHardwareIntel

rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

:denoiserPMDQSVEnc_SempliceCodificaHardwareIntel
echo.
echo !t100!
echo.
echo 1) !t96!
echo 2) !t97!
echo 3) !t98!
echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto PMDForteQSVEnc_SempliceCodificaHardwareIntel
if errorlevel 2 goto PMDMedioQSVEnc_SempliceCodificaHardwareIntel
if errorlevel 1 goto PMDLeggeroQSVEnc_SempliceCodificaHardwareIntel


:PMDForteQSVEnc_SempliceCodificaHardwareIntel
set "nvdenoiser=--vpp-pmd apply_count=20,strength=100,threshold=100" 
echo.
echo !t101! !t98!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserPMDimpostazioniQSVEnc_SempliceCodificaHardwareIntel

:PMDMedioQSVEnc_SempliceCodificaHardwareIntel
set "nvdenoiser=--vpp-pmd apply_count=15,strength=75,threshold=75" 
echo.
echo !t101! !t97!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserPMDimpostazioniQSVEnc_SempliceCodificaHardwareIntel

:PMDLeggeroQSVEnc_SempliceCodificaHardwareIntel
set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
echo.
echo !t101! !t96!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserPMDimpostazioniQSVEnc_SempliceCodificaHardwareIntel


:finedenoiserPMDimpostazioniQSVEnc_SempliceCodificaHardwareIntel
goto :finesceltadenoiserQSVEnc_SempliceCodificaHardwareIntel

rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

:denoiserFFT3DQSVEnc_SempliceCodificaHardwareIntel
echo.
echo !t102!
echo.
echo 1) !t96!
echo 2) !t97!
echo 3) !t98!
echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto FFT3DForteQSVEnc_SempliceCodificaHardwareIntel
if errorlevel 2 goto FFT3DMedioQSVEnc_SempliceCodificaHardwareIntel
if errorlevel 1 goto FFT3DLeggeroQSVEnc_SempliceCodificaHardwareIntel


:FFT3DForteQSVEnc_SempliceCodificaHardwareIntel
set "nvdenoiser=--vpp-fft3d sigma=100.0,amount=1.0,block_size=32,overlap=0.5,method=0,temporal=1,prec=auto" 
echo.
echo !t103! !t98!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserFFT3DimpostazioniQSVEnc_SempliceCodificaHardwareIntel

:FFT3DMedioQSVEnc_SempliceCodificaHardwareIntel
set "nvdenoiser=--vpp-fft3d sigma=60.0,amount=0.6,block_size=32,overlap=0.5,method=0,temporal=1,prec=auto" 
echo.
echo !t103! !t97!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserFFT3DimpostazioniQSVEnc_SempliceCodificaHardwareIntel

:FFT3DLeggeroQSVEnc_SempliceCodificaHardwareIntel
set "nvdenoiser=--vpp-fft3d sigma=30.0,amount=0.3,block_size=32,overlap=0.5,method=0,temporal=1,prec=auto" 
echo.
echo !t103! !t96!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserFFT3DimpostazioniQSVEnc_SempliceCodificaHardwareIntel



:finedenoiserFFT3DimpostazioniQSVEnc_SempliceCodificaHardwareIntel
goto :finesceltadenoiserQSVEnc_SempliceCodificaHardwareIntel

rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


:denoiserKNNQSVEnc_SempliceCodificaHardwareIntel
echo.
echo !t104!
echo.
echo 1) !t96!
echo 2) !t97!
echo 3) !t98!
echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto KNNForteQSVEnc_SempliceCodificaHardwareIntel
if errorlevel 2 goto KNNMedioQSVEnc_SempliceCodificaHardwareIntel
if errorlevel 1 goto KNNLeggeroQSVEnc_SempliceCodificaHardwareIntel


:KNNForteQSVEnc_SempliceCodificaHardwareIntel
set "nvdenoiser=--vpp-knn radius=5,strength=0.15,lerp=0.1,th_lerp=0.8" 
echo.
echo !t105! !t98!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserKNNimpostazioniQSVEnc_SempliceCodificaHardwareIntel

:KNNMedioQSVEnc_SempliceCodificaHardwareIntel
set "nvdenoiser=--vpp-knn radius=4,strength=0.10,lerp=0.1,th_lerp=0.8" 
echo.
echo !t105! !t97!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserKNNimpostazioniQSVEnc_SempliceCodificaHardwareIntel

:KNNLeggeroQSVEnc_SempliceCodificaHardwareIntel
set "nvdenoiser=--vpp-knn radius=3,strength=0.05,lerp=0.1,th_lerp=0.8" 
echo.
echo !t105! !t96!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserKNNimpostazioniQSVEnc_SempliceCodificaHardwareIntel


:finedenoiserKNNimpostazioniQSVEnc_SempliceCodificaHardwareIntel
goto :finesceltadenoiserQSVEnc_SempliceCodificaHardwareIntel

rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


:denoiserNLMEANSQSVEnc_SempliceCodificaHardwareIntel
echo.
echo !t106!
echo.
echo 1) !t96!
echo 2) !t97!
echo 3) !t98!
echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto NLMEANSForteQSVEnc_SempliceCodificaHardwareIntel
if errorlevel 2 goto NLMEANSMedioQSVEnc_SempliceCodificaHardwareIntel
if errorlevel 1 goto NLMEANSLeggeroQSVEnc_SempliceCodificaHardwareIntel


:NLMEANSForteQSVEnc_SempliceCodificaHardwareIntel
set "nvdenoiser=--vpp-nlmeans sigma=0.05,h=0.005,patch=7,search=15" 
echo.
echo !t107! !t98!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserNLMEANSimpostazioniQSVEnc_SempliceCodificaHardwareIntel

:NLMEANSMedioQSVEnc_SempliceCodificaHardwareIntel
set "nvdenoiser=--vpp-nlmeans sigma=0.03,h=0.005,patch=7,search=15" 
echo.
echo !t107! !t97!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserNLMEANSimpostazioniQSVEnc_SempliceCodificaHardwareIntel

:NLMEANSLeggeroQSVEnc_SempliceCodificaHardwareIntel
set "nvdenoiser=--vpp-nlmeans sigma=0.01,h=0.005,patch=7,search=15" 
echo.
echo !t107! !t96!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserNLMEANSimpostazioniQSVEnc_SempliceCodificaHardwareIntel


:finedenoiserNLMEANSimpostazioniQSVEnc_SempliceCodificaHardwareIntel
goto :finesceltadenoiserQSVEnc_SempliceCodificaHardwareIntel

rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

:denoiserDCTQSVEnc_SempliceCodificaHardwareIntel
echo.
echo !t108!
echo.
echo 1) !t96!
echo 2) !t97!
echo 3) !t98!
echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto DCTForteQSVEnc_SempliceCodificaHardwareIntel
if errorlevel 2 goto DCTMedioQSVEnc_SempliceCodificaHardwareIntel
if errorlevel 1 goto DCTLeggeroQSVEnc_SempliceCodificaHardwareIntel


:DCTForteQSVEnc_SempliceCodificaHardwareIntel
set "nvdenoiser=--vpp-denoise-dct step=1,sigma=10.0" 
echo.
echo !t109! !t98!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserDCTimpostazioniQSVEncCodificaHardwareIntelQSVEnc

:DCTMedioQSVEnc_SempliceCodificaHardwareIntel
set "nvdenoiser=--vpp-denoise-dct step=1,sigma=5.0" 
echo.
echo !t109! !t97!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserDCTimpostazioniQSVEncCodificaHardwareIntelQSVEnc

:DCTLeggeroQSVEnc_SempliceCodificaHardwareIntel
set "nvdenoiser=--vpp-denoise-dct step=1,sigma=2.0" 
echo.
echo !t109! !t96!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserDCTimpostazioniQSVEncCodificaHardwareIntelQSVEnc

:finedenoiserDCTimpostazioniQSVEncCodificaHardwareIntelQSVEnc
goto :finesceltadenoiserQSVEnc_SempliceCodificaHardwareIntel


:finesceltadenoiserQSVEnc_SempliceCodificaHardwareIntel



echo.
if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t57!"
    if errorlevel 2 goto ApplicaMiglioramentoDettagliNoQSVEnc_SempliceCodificaHardwareIntel
    if errorlevel 1 goto ApplicaMiglioramentoDettagliSiQSVEnc_SempliceCodificaHardwareIntel
)
CHOICE /N /C:SN /M "!t57!"

if errorlevel 2 goto ApplicaMiglioramentoDettagliNoQSVEnc_SempliceCodificaHardwareIntel
if errorlevel 1 goto ApplicaMiglioramentoDettagliSiQSVEnc_SempliceCodificaHardwareIntel

:ApplicaMiglioramentoDettagliNoQSVEnc_SempliceCodificaHardwareIntel
set "miglioramento1080p=N"
goto fineSceltaMigliaramentiQSVEnc_SempliceCodificaHardwareIntel

:ApplicaMiglioramentoDettagliSiQSVEnc_SempliceCodificaHardwareIntel
set "miglioramento1080p=S"

:fineSceltaMigliaramentiQSVEnc_SempliceCodificaHardwareIntel
if !miglioramento1080p!==S ( 
                                set "edgeleveling=--vpp-edgelevel strength=10.0,threshold=24.0,black=6,white=0" 
                                echo.
                                echo QSVEnc !t58!
                                echo.
                                )
if !miglioramento1080p!==N ( 
                                set "edgeleveling=" 
                                echo.
                                echo QSVEnc !t59!
                                echo.
                                )








echo.
echo !t114!
echo.

rem pause
rem echo nomefile1080p = %NomeFile1080p%
rem pause 

rem for %%a in (!NomeFile1080p!) do (
rem                                   set "filenamese=%%~na" 
                                      rem echo Nome senza estensione: !filenamese!  
rem )




set file_senza_virgolette=%NomeFile:"=%
rem echo %file_senza_virgolette%

set file_senza_estensione=%file_senza_virgolette:.mkv=%
rem echo %file_senza_estensione%

set fileoutput2160p="%file_senza_estensione%_Encoded.mkv"

@REM echo miglioramento1080p = !miglioramento1080p!
@REM echo.
@REM pause 


if !miglioramento1080p!==S (
                                @REM echo dento if S
                                set fileoutput2160pdetailed2="!file_senza_estensione!_Encoded.mkv"
                                @REM echo fileoutput2160pdetailed2 = !fileoutput2160pdetailed2!
                                set fileoutput2160pdetailed="!file_senza_estensione!_Encoded_pul_leggera.mkv"
                                @REM echo fileoutput2160pdetailed = !fileoutput2160pdetailed!
                                )

if !miglioramento1080p!==N  (
                                @REM echo dento if N
                                set fileoutput2160pdetailed2="!file_senza_estensione!_Encoded.mkv"
                                @REM echo fileoutput2160pdetailed2 = !fileoutput2160pdetailed2!
                                set fileoutput2160pdetailed="!file_senza_estensione!_Encoded_pul_leggera.mkv"
                                @REM echo fileoutput2160pdetailed = !fileoutput2160pdetailed!
                                )


set fileoutput2160pdetailed_senza_virgolette=!fileoutput2160pdetailed:"=! 
rem echo !fileoutput2160pdetailed_senza_virgolette!


for %%i in ("!fileoutput2160pdetailed_senza_virgolette!") do (  
                                                                set "solo_nome_file=%%~ni"
                                                                rem echo Nome file: !solo_nome_file!

                                                                set "solo_estensione_file=%%~xi"
                                                                rem echo Estensione: !solo_estensione_file!
                                                                )

set fileoutput2160pdetailed_rinominato=!solo_nome_file!_rinominato!solo_estensione_file!

rem echo %fileoutput2160pdetailed_rinominato%



set fileoutput2160pdetailed2_senza_virgolette=!fileoutput2160pdetailed2:"=! 
rem echo %fileoutput2160pdetailed2_senza_virgolette%

for %%i in ("!fileoutput2160pdetailed2_senza_virgolette!") do (  
                                                                set "solo_nome_file=%%~ni"
                                                                rem echo Nome file: !solo_nome_file!

                                                                set "solo_estensione_file=%%~xi"
                                                                rem echo Estensione: !solo_estensione_file!
                                                                )

set fileoutput2160pdetailed2_rinominato=!solo_nome_file!_rinominato!solo_estensione_file!

rem echo %fileoutput2160pdetailed2_rinominato%

if exist "Temp_HDR10_Stream.txt" ( del Temp_HDR10_Stream.txt )
if exist "durata_film.txt" ( del durata_film.txt )
if exist "crop.txt" ( del crop.txt )
if exist "risultato_multiplo.txt" ( del risultato_multiplo.txt )
if exist "crop_multiplo.txt" ( del crop_multiplo.txt )
if exist "crop_finale.txt" ( del crop_finale.txt )



".\bin\qsvencc\QSVEncC64.exe" --avsw --device auto -i !NomeFile!  --output-res !mwidth!x!mheight!  !cropff! --video-metadata clear --metadata clear --chapter-copy -c hevc !tipoQuantizzazioneQSVEnc!  !SettaggioQualitaQSVEnc! !SettaggioLookahead! --profile auto --level auto --chromaloc auto --colorrange auto --colormatrix auto --transfer auto --colorprim auto --master-display copy --max-cll copy  !outputdepthvalue!  --avsync cfr --psnr --ssim     -m default_mode:infer_no_subs    --vpp-resize algo=lanczos4  !edgeleveling! !nvdenoiser! --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o !fileoutput2160pdetailed2!



rem ".\bin\qsvencc\QSVEncC64.exe" --avsw --device auto -i !NomeFiletocrop!  --output-res !width4k!x!height4k!  !nvcrop! --video-metadata clear --metadata clear --chapter-copy -c hevc !tipoQuantizzazioneQSVEnc! !SettaggioQualitaQSvenc! --la-depth 32 --level auto --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display "G(13250,34500)B(7500,3000)R(34000,16000)WP(15635,16450)L(10000000,1)" --max-cll "1000,400"  --output-depth 10   --avsync cfr  --psnr --ssim     -m default_mode:infer_no_subs    !QSVEncColorCorrectionSystem!   --vpp-resize algo=lanczos4  !edgeleveling!  --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o !fileoutput2160pdetailed2!



ren !fileoutput2160pdetailed2! "!fileoutput2160pdetailed2_rinominato!"


echo.
echo !t112!
echo.



rem////////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////////


goto fineinfovideo_SempliceCodificaHardwareIntel




:novideofile_SempliceCodificaHardwareIntel
echo !t63!
echo.


:fineinfovideo_SempliceCodificaHardwareIntel


if exist ".\saved\settings.dat" (
                                for /f "tokens=1,2 delims=|" %%a in (.\saved\settings.dat) do (
                                                                                                    rem echo %%a
                                                                                                    rem echo %%b
                                                                                                    set /a "shst=%%b"
                                                                                                    rem echo !shst!
                                                                                                    rem pause
                                                                                                    if !shst!==1 (
                                                                                                                echo !t1000!
                                                                                                                echo.
                                                                                                                shutdown /s
                                                                                                                set /a "delay=10"
                                                                                                                timeout /t !delay!
                                                                                                                exit
                                                                                                                )
                                                                                                                            
                                                                                                    )                                                                                                  
                                                                                                )


if exist "Temp_HDR10_Stream.txt" ( del Temp_HDR10_Stream.txt )
if exist "durata_film.txt" ( del durata_film.txt )
if exist "crop.txt" ( del crop.txt )
if exist "risultato_multiplo.txt" ( del risultato_multiplo.txt )
if exist "crop_multiplo.txt" ( del crop_multiplo.txt )
if exist "crop_finale.txt" ( del crop_finale.txt )

      



set waitenter=
set /P waitenter=!t113!
Endlocal
goto puliziainiziale









rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:SempliceCodificaHardwareNVidia

cls
setLocal EnableExtensions EnableDelayedExpansion





for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoSempliceCodificaHardwareNVidia
)

if %lingua%==inglese (
    goto caricalinguaingleseSempliceCodificaHardwareNVidia
)



:caricalinguaingleseSempliceCodificaHardwareNVidia
@REM set t1=Insert Hardware Video Encoding Info and Saving to Disk

set t2=Drag Here the Video File for Hardware Encoding with GPU NVidia:  
@REM set t211=Video for Hardware Encoding with GPU:  

set t3=File does not exist 
set t4=Info Video:  

set t5=The Inserted Video is 2160p 8bit SDR 
set t511=The Inserted Video is 2160p 10bit SDR 

set t6=The Inserted Video isn't 2160p 8bit or 10bit SDR 
set t7=Video Duration in seconds:
set t8=Video Duration in Minutes:
set t9=Interval between Frames for Crop Detection:
set t10= seconds
set t11=Black Bands Detection Started....
set t12=Crop Detection to Frame
set t13=to seconds
set t14=Done...
set t15=Original 2160p Video Width: 
set t16=Original 2160p Video Height:
set t17=Original Video Width Without Black Bars:
set t18=Original Video Height Without Black Bars:

set t171=Output Video 1080p Width Without Black Bars:
set t181=Outout Video 1080p Height Without Black Bars:

set t19=Adapting Video Resolution to Full 2160p Format...
set t20=Final 2160p Output Video Width:
set t21=Final 2160p Output Video Height:

set t22=Settings of Black Bands to Crop are Correct (Yes/No):
set t23=Manually Entering Black Bands Values to Crop... 
set t24=Enter the Upper Black Band Value: 
set t25=Error Entering Upper Black Band Value... It's Not a Number. 
set t26=Enter the Lower Black Band Value: 
set t27=Error Entering Lower Black Band Value... It's Not a Number.
set t28=Enter the Left Black Band Value: 
set t29=Error Entering Left Black Band Value... It's Not a Number.
set t30=Enter the Right Black Band Value: 
set t31=Error Entering Right Black Band Value... It's Not a Number.
set t32=Upper Black Band:
set t33=Lower Black Band:
set t34=Left Black Band:
set t35=Right Black Band:
set t36=2160p Original Video Width without Black Bars:
set t37=2160p Original Video Height without Black Bars:

@REM set t361=1080p Video Width without Black Bars:
@REM set t371=1080p Video Height without Black Bars

set t38=Select Graphic Card you want to Encode with:
set t39=Choose (1/2):
set t40=Select Encoding Type:
set t41=Error Entering Quantization Value... It's Not a Number. 
set t42=Quantization Value Set to:
set t43=Encoding Settings:
set t44=Enter Quantization value Minimum 10 Maximum 28:
set t45=Quantization Value Out of  Limits  10 / 28  Re-enter^!
set t46=Enter BitRate Value kbs Minimum 100 Maximum 50000:
set t47=Error Entering BitRate Value... It's Not a Number. 
set t48=BitRate Value Set to:
set t49=BitRate Value Out of Limits  100 / 50000  Re-enter^!
set t50=Select Encoding Quality:
set t51=- Worst Quality
set t52=- Best Quality
set t53=Choose (1/2/3/4/5/6/7):
set t54=Quality Set to:
set t55=Apply Convolution3D denoiser Yes/No: 
set t56=Apply PMD denoiser Yes/No: 
set t57=Apply Detail Enhancement Yes/No:  
set t58=Enhancement Detail: Yes 
set t59=Enhancement Detail: No 
set t60=Info
set t61=Videos to Encode Saved!
set t62=Do You Want to Insert Another Video to Encode (Yes/No):
set t63=The dragged file is not a video!
set t64=Choose (1/2/3/4):
set t65=Press Enter toback to Menu Inserting Encoding into the Queue and Saving to Disk:  

set t66=Video Width
set t67=Video Height
set t68=Video Codec
set t69=Details Video Codec
set t70=Video Format 
set t71=Configuration Settings to convert video from 8bit or 10bit SDR to 10bit HDR
set t72=Select Encoding UpGrader:
set t73=Settings UpGrader:
set t74=Choose (1/2/3):

set t75=Configuration Encoding Lookahead:
set t76=Insert Value of Lookahead (1-32): 
set t77=Error Entering Lookahead Value... It's Not a Number.
set t78=Lookahead Value Entered Out of Range 1-32
set t79=Lookahead Settings:

set t80=Select type of Adaptive Quantization:
set t81=- Disabled
set t82=Adaptive Quantization Settings:

set t83=Setting Intensity of Adaptive Quantization:
set t84=Insert Value of Adaptive Quantization Intensity (0-15): 
set t841=Error Entering Quantization Strength Value... It's Not a Number. 
set t85=Value Adaptive Quantization Intensity Entered Out of Range 1-15
set t86=- Automatic
set t87=Adaptive Quantization Intensity Setting:

set t88=Select Motion Vector Accuracy:
set t89=- Best
set t90=- Worst
set t91=Motion Vector Accuracy Setting:

set t92=Select Denoiser:
set t93=No Denoiser
set t94=No Denoiser Selected.

set t95=Select Strength Covolution3D Denoiser:
set t96=Weak
set t97=Moderate
set t98=Strong
set t99=Covolution3D Setting:

set t100=Select Strength PMD Denoiser:
set t101=PMD Denoiser Setting:

set t102=Select Strength FFT3D Denoiser :
set t103=FFT3D Denoiser Setting:

set t104=Select Strength KNN Denoiser:
set t105=KNN Denoiser Setting:

set t106=Select Strength NLMEANS Denoiser:
set t107=NLMEANS Denoiser Setting:

set t108=Select Strength DCT Denoiser:
set t109=DCT Denoiser Setting:

set t110=Insert Value of Lookahead (10-99): 
set t111=Value of Lookahead Entered Out of Range 10-99

set t112=Encoding Finished...
set t113=Press Enter to Back to Main Menu:  
set t114=Encoding Started.... 
set t1000=Now the PC will be turned off... 


goto avvio_SempliceCodificaHardwareNVidia




:caricalinguaitalianoSempliceCodificaHardwareNVidia
@REM set t1=Inserimento Info Codifica Hardware Video e Salvataggio su Disco.

set t2=Trascina Qui il File Video per Codifica Hardware con GPU NVidia:  
@REM set t211=File Video per la Codifica Hardware con la GPU:  

set t3=File Inesistente 
set t4=Informazioni Video:  

set t5=Il Video inserito e' 2160p 8bit SDR 
set t511=Il Video inserito e' 2160p 10bit SDR 

set t6=Il Video inserito non e' 2160p 8bit o 10bit SDR 

set t7=Durata del Video in secondi:
set t8=Durata del video in Minuti:
set t9=Intervallo tra i Fotogrammi per il Rilevamento del crop:
set t10= secondi
set t11=Rilevamento Bande Nere Iniziato....
set t12=Rilevazione crop fotogramma
set t13=a secondi
set t14=Eseguita...
set t15=Larghezza Video 2160p Originale:
set t16=Altezza Video 2160p Originale:
set t17=Larghezza Video Originale Senza Barre Nere:
set t18=Altezza Video Originale Senza Barre Nere:

set t171=Larghezza Video 1080p  Senza Barre Nere:
set t181=Altezza Video 1080p  Senza Barre Nere:

set t19=Adattamento della Risoluzione del Video al Pieno Formato 2160p..
set t20=Larghezza Finale Video 2160p:
set t21=Altezza Finale Video 2160p:

set t22=Le Impostazioni delle Bande Nere da Tagliare sono Corrette (Si/No):
set t23=Inserimento Manuale Valori Bande Nere da Tagliare.. 
set t24=Inserisci il Valore della Banda Nera Superiore: 
set t25=Errore nell'Inserimento del Valore della Banda Nera Superiore... Non e' un Numero. 
set t26=Inserisci il Valore della Banda Nera Inferiore: 
set t27=Errore nell'Inserimento del Valore della Banda Nera Inferiore... Non e' un Numero. 
set t28=Inserisci il Valore della Banda Nera Sinistra: 
set t29=Errore nell'Inserimento del Valore della Banda Nera Sinistra... Non e' un Numero. 
set t30=Inserisci il Valore della Banda Nera Destra: 
set t31=Errore nell'Inserimento del Valore della Banda Nera Destra.. Non e' un Numero. 
set t32=Banda Nera Superiore:
set t33=Banda Nera Inferiore:
set t34=Banda Nera Sinistra:
set t35=Banda Nera Destra:
set t36=Larghezza Video Originale 2160p senza Bande Nere:
set t37=Altezza Video Originale 2160p senza Bande Nere:

@REM set t361=Larghezza Video 1080p senza Bande Nere:
@REM set t371=Altezza Video 1080p senza Bande Nere:

set t38=Selezionare Scheda Grafica con cui Eseguire la Codifica:
set t39=Scegli (1/2):
set t40=Selezionare tipo di Codifica:
set t41=Errore nell'Inserimento del Valore della Quantizzazione... Non e' un Numero. 
set t42=Valore Quantizzazzione Impostato a:
set t43=Parametri per codifica:

set t44=Inserire Valore Quantizzazione Minimo 10 Massimo 28:
set t45=Valore Quantizzazzione al di fuori dei  Limiti  10 / 28  Reinserire^!
set t46=Inserire Valore BitRate kbs Minimo 100 Massimo 50000:
set t47=Errore nell'Inserimento del Valore del BitRate... Non e' un Numero. 
set t48=Valore BitRate Impostato a:
set t49=Valore  BitRate al di fuori dei  Limiti  100 / 50000  Reinserire^!

set t50=Selezionare Qualita' Codifica:
set t51=- Peggiore Qualita'
set t52=- Migliore Qualita'
set t53=Scegli (1/2/3/4/5/6/7):
set t54=Qualita' Impostata su:
set t55=Applicare il denoiser Convolution3D Si/No: 
set t56=Applicare il denoiser PMD Si/No: 
set t57=Applicare il Miglioramento Dettagli Si/No:  
set t58=Miglioramento Dettagli: Si 
set t59=Miglioramento Dettagli: No 
set t60=Informazioni
set t61=Video da Codificare Salvate!
set t62=Vuoi Inserire un altro Video da Codificare (Si/No):
set t63=Il file trascinato non e' un video!
set t64=Scegli (1/2/3/4):
set t65=Premi Invio per tornare al menu' Inserimento Codifiche in Coda e Salvataggio sul Disco:  

set t66=Larghezza Video
set t67=Altezza Video
set t68=Codec Video
set t69=Codec Video Dettagli
set t70=Format Video 
set t71=Configurazione Parametri per convertire il video da 8bit o 10bit SDR a 10bit HDR
set t72=Selezionare UpGrader Codifica:
set t73=UpGrader Impostato:
set t74=Scegli (1/2/3):

set t75=Configurazione Lookahead Codifica:
set t76=Inserisci il Valore Lookahead (1-32): 
set t77=Errore nell'Inserimento del Valore Lookahead... Non e' un Numero. 
set t78=Valore Lookahead Inserito fuori dall'Intervallo 1-32
set t79=Lookahead Impostato su:

set t80=Selezionare il tipo di Quantizzazione Adattiva:
set t81=- Disabilitata
set t82=Quantizzazione Adattiva Impostata su:

set t83=Impostare Forza Quantizzazione Adattiva:
set t84=Inserisci il Valore della Forza Quantizzazione Adattativa (0-15): 
set t841=Errore nell'Inserimento del Valore Forza Quantizzazione... Non e' un Numero. 
set t85=Valore Forza Quantizzazione Adattativa Inserito fuori dall'Intervallo 1-15
set t86=- Automatica
set t87=Forza Quantizzazione Adattiva Impostata su:

set t88=Selezionare la Precisione del Vettore di Movimento:
set t89=- Migliore
set t90=- Peggiore
set t91=Precisione del Vettore di Movimento Impostata su:

set t92=Selezionare il tipo di Denoiser:
set t93=Nessun Denoiser
set t94=Nessun Denoiser Selezionato.

set t95=Selezionare Forza Denoiser Covolution3D:
set t96=Leggero
set t97=Medio
set t98=Forte
set t99=Covolution3D Denoiser Impostato su:

set t100=Selezionare Forza Denoiser PMD:
set t101=PMD Denoiser Impostato su:

set t102=Selezionare Forza Denoiser FFT3D:
set t103=FFT3D Denoiser Impostato su:

set t104=Selezionare Forza Denoiser KNN:
set t105=KNN Denoiser Impostato su:

set t106=Selezionare Forza Denoiser NLMEANS:
set t107=NLMEANS Denoiser Impostato su:

set t108=Selezionare Forza Denoiser DCT:
set t109=DCT Denoiser Impostato su:

set t110=Inserisci il Valore Lookahead (10-99): 
set t111=Valore Lookahead Inserito fuori dall'Intervallo 10-99

set t112=Codifica Terminata...
set t113=Premi Invio per tornare al menu' principale:  
set t114=Codifica Iniziata.... 
set t1000=Il PC ora verra' Spento... 

goto avvio_SempliceCodificaHardwareNVidia



:avvio_SempliceCodificaHardwareNVidia




set /a "numeromovie=1"


:altrivideodainserireNVEnc_SempliceCodificaHardwareNVidia


set NomeFile=
rem set MetadatiStreamHDR10=

set /P NomeFile=!t2!
rem echo Hai digitato: %NomeFile%
rem pause

set "NomeFileSorgente=!NomeFile:"=!"
@REM echo NomeFileSorgente = !NomeFileSorgente!
set "NomeFile=^"!NomeFileSorgente!^""
@REM echo NomeFile = !NomeFile!
rem pause


if exist %NomeFile% ( goto infovideo_SempliceCodificaHardwareNVidia ) else ( 
                                                        echo.
                                                        echo !t3!
                                                        echo.
                                                        goto fineinfovideo_SempliceCodificaHardwareNVidia
                                                        )    



:infovideo_SempliceCodificaHardwareNVidia
echo.
echo !t4!
echo.

.\bin\ffprobe -v error -hide_banner -select_streams v:0 -show_entries stream=width,height,codec_name,codec_long_name,pix_fmt,color_space,color_transfer,color_primaries -of default=noprint_wrappers=1 %NomeFile% > ".\temp\Temp_HDR10_Stream.txt"

set /A x1=1

rem echo nohdr = %nohdr%

for /f "tokens=1,2 delims==" %%a in (.\temp\Temp_HDR10_Stream.txt) do (if !x1!==3 ( 
                                                                            echo !t66! "%%a" = %%b  
                                                                            set /A "widthvideo=%%b"
                                                                            )
                                                                if !x1!==4 ( 
                                                                            echo !t67! "%%a" = %%b  
                                                                            set /A "heightvideo=%%b"
                                                                            )                                                           
                                                                if !x1!==6 ( 
                                                                            echo Color Space "%%a" = %%b  
                                                                            set "colorsp=%%b"              
                                                                            ) 
                                                                if !x1!==7 ( 
                                                                            echo Color Transfer "%%a" = %%b  
                                                                            set "colortr=%%b"      
                                                                            ) 
                                                                if !x1!==8 ( 
                                                                            echo Color Primaries "%%a" = %%b  
                                                                            set "colorpr=%%b"         
                                                                            )    
                                                                if !x1!==1 ( 
                                                                            echo !t68! "%%a" = %%b  
                                                                            )       
                                                                if !x1!==2 ( 
                                                                            echo !t69! "%%a" = %%b  
                                                                            )   
                                                                if !x1!==5 ( 
                                                                            echo !t70! "%%a" = %%b  
                                                                            set "formatvideo=%%b"
                                                                            )
                                                                set /A x1+=1                                                            
)

if !x1!==1 goto novideofile_SempliceCodificaHardwareNVidia

if !formatvideo!==yuv420p (
        set "tiervalue=--tier main"
        set "outputdepthvalue=--output-depth 8"
)

if !formatvideo!==yuv420p10le (
        set "tiervalue=--tier high"
        set "outputdepthvalue=--output-depth 10"
)


:rilevazionebandenere_SempliceCodificaHardwareNVidia

.\bin\ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 %NomeFile%  > ".\temp\durata_film.txt"


set /a contatore=1
for /f "tokens=1 delims=." %%a in (.\temp\durata_film.txt) do  (
                                                        echo. 
                                                       echo !t7! %%a
                                                        set /a "secondi=%%a"
                                                        set /a "minuti=!secondi!/60"
                                                        echo !t8! !minuti!
                                                        set /a "intervallo_tagli=!secondi!/11"
                                                        echo !t9! !intervallo_tagli!!t10!
                                                        echo.
                                                        echo !t11!
                                                        echo.

                                                        

                                                        FOR /L %%a IN (1, 1, 10) DO (
                                                                                    rem echo %%a
                                                                                    set /a "secondi=%%a*!intervallo_tagli!"
                                                                                    rem echo !secondi!

                                                                                    if !formatvideo!==yuv420p (
                                                                                                                set /a "ca=16"
                                                                                                                rem echo !ca!
                                                                                                                    
                                                                                                                set /a "cb=2"
                                                                                                                rem echo !cb!
                                                                                                                    
                                                                                                                set /a "cc=0"
                                                                                                                rem echo !cc!

                                                                                                                set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                                                rem echo !cr!
                                                                                                                )

                                                                                    if !formatvideo!==yuv420p10le  ( 
                                                                                                                    set /a "ca=72"
                                                                                                                    rem echo !ca!
                                                                                                                    
                                                                                                                    set /a "cb=2"
                                                                                                                    rem echo !cb!
                                                                                                                    
                                                                                                                    set /a "cc=0"
                                                                                                                    rem echo !cc!

                                                                                                                    set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                                                    rem echo !cr!
                                                                                                                    )                                                                                                                

                                    
                                                                                
                                                                                
                                                                                    .\bin\ffmpeg -ss !secondi! -hide_banner -nostats -i %NomeFile% -vframes 10 -vf !cr! -f null - 2> ".\temp\crop.txt"
                                                                                    
                                                                                    findstr /r "Parsed_cropdetect_0" .\temp\crop.txt >> .\temp\risultato_multiplo.txt   
                                                                                    
                                                                                    echo !t12! %%a !t13! !secondi! !t14!
                                                                                    
                                                                                    )       
                                                                                       

                                                                                    for /f "tokens=1,2 delims==" %%a in (.\temp\risultato_multiplo.txt) do ( echo %%b >> .\temp\crop_multiplo.txt )
                                                                                    
                                                                                    set /a "maxfrequenza=0"

                                                                                    for /f "delims=" %%a in (.\temp\crop_multiplo.txt) do ( 
                                                                                                                                    set "cropconfront=%%a"
                                                                                                                                    rem echo "!cropconfront!"
                                                                                                                                    
                                                                                                                                    set /a "contatorfrequenza=0"
                                                                                                                                    for /f "delims=" %%b in (.\temp\crop_multiplo.txt) do (
                                                                                                                                                                                    set "dato_da_verificare=%%b"
                                                                                                                                                                                    rem echo cropconfront = "!cropconfront!"
                                                                                                                                                                                    rem echo dato_da_verificare = "!dato_da_verificare!"
                                                                                                                                                                                    if !cropconfront!==!dato_da_verificare! ( set /a "contatorfrequenza+=1")
                                                                                                                                                                                    )
                                                                                                                                    if !maxfrequenza! LSS !contatorfrequenza! ( 
                                                                                                                                                                                set /a "maxfrequenza=!!contatorfrequenza!!"
                                                                                                                                                                                set "cropd=!cropconfront!"
                                                                                                                                                                                )
                                                                                                                                    

                                                                                                                                    rem if !cropconfront! in (elenco_crop_frequenza.txt) ()
                                                                                                                                    rem echo !cropconfront!:!contatorfrequenza! >> elenco_crop_frequenza.txt

                                                                                                                                    )

                                                                                    rem echo crop piu' frequente = !cropd! con grequenza = !maxfrequenza!
                                                                                    echo !cropd! > .\temp\crop_finale.txt

                                                                                    for /f "tokens=1,2,3,4 delims=:" %%a in (.\temp\crop_finale.txt) do  ( 
                                                                                                                                                    rem set /a "mwidth=%%a"
                                                                                                                                                    rem echo mwidth = !mwidth!

                                                                                                                                                    rem set /a "mheight=%%b"
                                                                                                                                                    rem echo mheight = !mheight!

                                                                                                                                                    rem set /a "mx=%%c"
                                                                                                                                                    rem echo mx = !mx!

                                                                                                                                                    rem set /a "my=%%d"
                                                                                                                                                    rem echo my = !my!

                                                                                                                                                    if !contatore!==1 ( 
                                                                                                                                                                set /a "wmax=%%a" 
                                                                                                                                                                set /a "hmax=%%b"
                                                                                                                                                                set /a "xmin=%%c"
                                                                                                                                                                set /a "ymin=%%d"
                                                                                                                                                                set /a "mwidth=%%a"
                                                                                                                                                                set /a "mheight=%%b"
                                                                                                                                                                set /a "mx=%%c"
                                                                                                                                                                set /a "my=%%d"
                                                                                                                                                                set /a "contatore+=1"
                                                                                                                                                                )
                                                                                                                                                    
                                                                                                                                                    rem if %%b gtr !hmax! if %%c gtr !xmin! if %%d gtr !ymin! 

                                                                                                                                                    if %%a geq !wmax! if %%b geq !hmax! ( 
                                                                                                                                                                        set /a "wmax=%%a" 
                                                                                                                                                                        set /a "hmax=%%b"
                                                                                                                                                                        set /a "xmin=%%c"
                                                                                                                                                                        set /a "ymin=%%d"
                                                                                                                                                                        set /a "mwidth=%%a"
                                                                                                                                                                        set /a "mheight=%%b"
                                                                                                                                                                        set /a "mx=%%c"
                                                                                                                                                                        set /a "my=%%d"
                                                                                                                                                                        )
                                                                                                                                                    )
                                                                                    echo.
                                                                                    
                                                                                    set /a "mwidth=!mwidth!/2*2"
                                                                                    set /a "mheight=!mheight!/2*2"

                                                                                    set /a "csup=!my!/2*2"
                                                                                    rem echo csup = !csup!
                                                                                                                                    
                                                                                    set /a "csin=!mx!/2*2"
                                                                                    rem echo csin = !csin!

                                                                                    set /a "cinf=(!heightvideo!-!mheight!-!my!)/2*2"
                                                                                    rem echo movieheightreal = !movieheightreal!
                                                                                    rem echo cinf = !cinf!
                                                                                    set /a "cdes=(!widthvideo!-!mwidth!-!mx!)/2*2"
                                                                                    rem echo cdes = !cdes!

                                                                                    echo Crop Settings: --crop !csin!,!csup!,!cdes!,!cinf!    
                                                                                    set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
                                                                                    echo.  
                                                                                    
                                                                                    echo !t17!  !mwidth! 
                                                                                    echo !t18!  !mheight! 
                                                                                    echo.
                                                                                    )  
                                                        )                          

:cropmanuale_SempliceCodificaHardwareNVidia
set /a "csup=0"
set /a "cinf=0"
set /a "csin=0"
set /a "cdes=0"
set /a "bandasuperiore=0"
set /a "bandainferiore=0"
set /a "bandasinistra=0"
set /a "bandadestra=0"
if exist ".\temp\Temp_HDR10_Stream.txt" ( del ".\temp\Temp_HDR10_Stream.txt" ) 
if exist ".\temp\durata_film.txt" ( del ".\temp\durata_film.txt" )
if exist ".\temp\crop.txt" ( del ".\temp\crop.txt" )
if exist ".\temp\risultato_multiplo.txt" ( del ".\temp\risultato_multiplo.txt" )
if exist ".\temp\crop_multiplo.txt" ( del ".\temp\crop_multiplo.txt" )
if exist ".\temp\crop_finale.txt" ( del ".\temp\crop_finale.txt" )

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t22!"   
    if errorlevel 2 goto cropmanuale_SempliceCodificaHardwareNVidia
    if errorlevel 1 goto finecrop_SempliceCodificaHardwareNVidia
)
CHOICE /N /C:SN /M "!t22!"   

if errorlevel 2 goto cropmanuale_SempliceCodificaHardwareNVidia
if errorlevel 1 goto finecrop_SempliceCodificaHardwareNVidia


:cropmanuale_SempliceCodificaHardwareNVidia
echo.
echo !t23!
echo.

:banda_superiore_SempliceCodificaHardwareNVidia
set /p "bandasuperiore=!t24!"
SET "var="&for /f "delims=0123456789" %%i in ("!bandasuperiore!") do set var=!bandasuperiore!
if defined var (
                echo.
                echo !t25!
                echo.
                goto banda_superiore_SempliceCodificaHardwareNVidia
                ) else (
                        set /a "csup=!bandasuperiore!/2*2"
                        )

echo.
:banda_inferiore_SempliceCodificaHardwareNVidia
set /p "bandainferiore=!t26!  
SET "var="&for /f "delims=0123456789" %%i in ("!bandainferiore!") do set var=!bandainferiore!
if defined var (
                echo.
                echo !t27!
                echo.
                goto banda_inferiore_SempliceCodificaHardwareNVidia
                ) else (
                        set /a "cinf=!bandainferiore!/2*2"
                        )


echo.
:banda_sinistra_SempliceCodificaHardwareNVidia
set /p "bandasinistra=!t28!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandasinistra!") do set var=!bandasinistra!
if defined var (
                echo.
                echo !t29!
                echo.
                goto banda_sinistra_SempliceCodificaHardwareNVidia
                ) else (
                        set /a "csin=!bandasinistra!/2*2"
                        )

                        
echo.
:banda_destra_SempliceCodificaHardwareNVidia
set /p "bandadestra=!t30!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandadestra!") do set var=!bandadestra!
if defined var (
                echo.
                echo !t31!
                echo.
                goto banda_destra_SempliceCodificaHardwareNVidia
                ) else (
                        set /a "cdes=!bandadestra!/2*2"
                        )


set /a "mwidth=!widthvideo!/2*2"
set /a "mheight=!heightvideo!/2*2"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "mwidthc=!mwidth!-!csin!-!cdes!"
set /a "mheightc=!mheight!-!csup!-!cinf!"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "mwidth=!mwidthc!"
set /a "mheight=!mheightc!"

echo.
echo !t32!  !csup! 
echo !t33!  !cinf! 
echo !t34!  !csin! 
echo !t35!  !cdes! 
echo.

set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
echo Crop Settings: !cropff!
echo.

echo !t17!  !mwidth! 
echo !t18!  !mheight! 
echo.

goto cropmanuale_SempliceCodificaHardwareNVidia

:finecrop_SempliceCodificaHardwareNVidia


:InserimentoImpostazioniNVEnc_SempliceCodificaHardwareNVidia

echo.
echo !t40!
echo.
echo 1) CQP 
echo 2) VBR 
echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto CodificaVBRNVEnc_SempliceCodificaHardwareNVidia
if errorlevel 1 goto CodificaCQPNVEnc_SempliceCodificaHardwareNVidia

:CodificaVBRNVEnc_SempliceCodificaHardwareNVidia
set "TipoCodificaNVEnc=--vbr "
set /a "quantizzazioneNVEnc=0"
goto inserimentoValoriCQPVBRNVEnc_SempliceCodificaHardwareNVidia

:CodificaCQPNVEnc_SempliceCodificaHardwareNVidia
set "TipoCodificaNVEnc=--cqp "
set /a "quantizzazioneNVEnc=1"

:inserimentoValoriCQPVBRNVEnc_SempliceCodificaHardwareNVidia

if !quantizzazioneNVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneNVEnc=!t44! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneNVEnc!") do set var=!valoreQuantizzazioneNVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                goto inserimentoValoriCQPVBRNVEnc_SempliceCodificaHardwareNVidia
                                                ) 

                                set /a "valoreQuantizzazioneNVEnc=!valoreQuantizzazioneNVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneNVEnc!
                                if !valoreQuantizzazioneNVEnc! GEQ 10 if !valoreQuantizzazioneNVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneNVEnc!
                                                                                                                set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreQuantizzazioneNVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                                goto fineQuantizzazioneNVEnc_SempliceCodificaHardwareNVidia
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRNVEnc_SempliceCodificaHardwareNVidia
                                                                                                                        
                                )



if !quantizzazioneNVEnc!==0 (
                                echo.
                                set /p "valoreBitRateNVEnc=!t46! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateNVEnc!") do set var=!valoreBitRateNVEnc!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                goto inserimentoValoriCQPVBRNVEnc_SempliceCodificaHardwareNVidia
                                                ) 
                                set /a "valoreBitRateNVEnc=!valoreBitRateNVEnc!"
                                @REM echo valoreBitRateNVEnc = !valoreBitRateNVEnc!
                                if !valoreBitRateNVEnc! GEQ 100 if !valoreBitRateNVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateNVEnc!
                                                                                                        set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreBitRateNVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                        goto fineQuantizzazioneNVEnc_SempliceCodificaHardwareNVidia
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRNVEnc_SempliceCodificaHardwareNVidia
                                                                                                              
                                )


:fineQuantizzazioneNVEnc_SempliceCodificaHardwareNVidia


echo.
echo !t50!
echo.
echo 1) P1 !t51!
echo 2) P2 
echo 3) P3 
echo 4) P4 
echo 5) P5 
echo 6) P6 
echo 7) P7 !t52!
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto P7NVEnc_SempliceCodificaHardwareNVidia
if errorlevel 6 goto P6NVEnc_SempliceCodificaHardwareNVidia
if errorlevel 5 goto P5NVEnc_SempliceCodificaHardwareNVidia
if errorlevel 4 goto P4NVEnc_SempliceCodificaHardwareNVidia
if errorlevel 3 goto P3NVEnc_SempliceCodificaHardwareNVidia
if errorlevel 2 goto P2NVEnc_SempliceCodificaHardwareNVidia
if errorlevel 1 goto P1NVEnc_SempliceCodificaHardwareNVidia


:P7NVEnc_SempliceCodificaHardwareNVidia
set "SettaggioQualitaNVEnc=--preset P7"
set "QualitySetting=P7"
goto fineQualitCodificaNVEnc_SempliceCodificaHardwareNVidia

:P6NVEnc_SempliceCodificaHardwareNVidia
set "SettaggioQualitaNVEnc=--preset P6"
set "QualitySetting=P6"
goto fineQualitCodificaNVEnc_SempliceCodificaHardwareNVidia

:P5NVEnc_SempliceCodificaHardwareNVidia
set "SettaggioQualitaNVEnc=--preset P5"
set "QualitySetting=P5"
goto fineQualitCodificaNVEnc_SempliceCodificaHardwareNVidia

:P4NVEnc_SempliceCodificaHardwareNVidia
set "SettaggioQualitaNVEnc=--preset P4"
set "QualitySetting=P4"
goto fineQualitCodificaNVEnc_SempliceCodificaHardwareNVidia

:P3NVEnc_SempliceCodificaHardwareNVidia
set "SettaggioQualitaNVEnc=--preset P3"
set "QualitySetting=P3"
goto fineQualitCodificaNVEnc_SempliceCodificaHardwareNVidia

:P2NVEnc_SempliceCodificaHardwareNVidia
set "SettaggioQualitaNVEnc=--preset P2"
set "QualitySetting=P2"
goto fineQualitCodificaNVEnc_SempliceCodificaHardwareNVidia

:P1NVEnc_SempliceCodificaHardwareNVidia
set "SettaggioQualitaNVEnc=--preset P1"
set "QualitySetting=P1"
goto fineQualitCodificaNVEnc_SempliceCodificaHardwareNVidia


:fineQualitCodificaNVEnc_SempliceCodificaHardwareNVidia
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaNVEnc!




echo.
echo !t75!
echo.

:inserimentolookaheadNVEnc_SempliceCodificaHardwareNVidia
set /p "valorelook=!t76!"  
SET "var="&for /f "delims=0123456789" %%i in ("!valorelook!") do set var=!valorelook!

@REM echo valorelook = !valorelook!
@REM echo var = !var!

if defined var (
                echo.
                echo !t77!
                echo.
                goto inserimentolookaheadNVEnc_SempliceCodificaHardwareNVidia
                ) else (
                        set /a "lookaheadvalue=!valorelook!"
                        set "SettaggioLookahead=--lookahead !valorelook!"
                        @REM echo lookaheadvalue = !lookaheadvalue!
                        )


if !lookaheadvalue! LSS 1 (     echo.
                                echo !t78
                                echo.
                                goto inserimentolookaheadNVEnc_SempliceCodificaHardwareNVidia
                                )

if !lookaheadvalue! GTR 32 (    echo.
                                echo !t78!
                                echo.
                                goto inserimentolookaheadNVEnc_SempliceCodificaHardwareNVidia
                                )

echo.
echo !t79! !lookaheadvalue!
echo.
echo !t43! !SettaggioLookahead!
@REM pause



rem quantizzazione adattativa
echo.
echo !t80!
echo.
echo 1) Off !t81!
echo 2) Spatial
echo 3) Temporal
echo 4) Spatial + Temporal
echo.
CHOICE /N /C:1234 /M "!t64!"

if errorlevel 4 goto quantizzazioneAdattativaSpazialeTemporale_SempliceCodificaHardwareNVidia
if errorlevel 3 goto quantizzazioneAdattativaTemporale_SempliceCodificaHardwareNVidia
if errorlevel 2 goto quantizzazioneAdattativaSpaziale_SempliceCodificaHardwareNVidia
if errorlevel 1 goto quantizzazioneAdattativaSpenta_SempliceCodificaHardwareNVidia


:quantizzazioneAdattativaSpenta_SempliceCodificaHardwareNVidia
set "SettaggioQuantizAdat=--no-aq"
set "SettingQuantAdat=Off - Disabilitata"
goto finequantizzazioneAdattativa_SempliceCodificaHardwareNVidia

:quantizzazioneAdattativaSpaziale_SempliceCodificaHardwareNVidia
set "SettaggioQuantizAdat=--aq"
set "SettingQuantAdat=Spatial"
goto finequantizzazioneAdattativa_SempliceCodificaHardwareNVidia

:quantizzazioneAdattativaTemporale_SempliceCodificaHardwareNVidia
set "SettaggioQuantizAdat=--aq-temporal"
set "SettingQuantAdat=Temporal"
goto finequantizzazioneAdattativa_SempliceCodificaHardwareNVidia

:quantizzazioneAdattativaSpazialeTemporale_SempliceCodificaHardwareNVidia
set "SettaggioQuantizAdat=--aq --aq-temporal"
set "SettingQuantAdat=Spatial + Temporal"
goto finequantizzazioneAdattativa_SempliceCodificaHardwareNVidia


:finequantizzazioneAdattativa_SempliceCodificaHardwareNVidia
echo.
echo !t82! !SettingQuantAdat!
echo.
echo !t43! !SettaggioQuantizAdat!



rem intensit quantizzazione adattativa

if !SettaggioQuantizAdat!==--no-aq ( 
                                        goto finequantizzazioneAdattativa_SempliceCodificaHardwareNVidia 
                                        )

echo.
echo !t83!
echo.
:inserimentoValorequantizzazioneAdattativa_SempliceCodificaHardwareNVidia
set /p "ForzaQuantizAdatValue=!t84!"  

SET "var="&for /f "delims=0123456789" %%i in ("!ForzaQuantizAdatValue!") do set var=!ForzaQuantizAdatValue!
if defined var (
                echo.
                echo !t841!
                echo.
                goto inserimentoValorequantizzazioneAdattativa_SempliceCodificaHardwareNVidia
                ) 


if !ForzaQuantizAdatValue! LSS 0 (      echo.
                                        echo !t85!
                                        echo.
                                        goto inserimentoValorequantizzazioneAdattativa_SempliceCodificaHardwareNVidia
                                        )

if !ForzaQuantizAdatValue! GTR 15 (     echo.
                                        echo !t85!
                                        echo.
                                        goto inserimentoValorequantizzazioneAdattativa_SempliceCodificaHardwareNVidia
                                        )




:ForzaQuantizzazioneAdattativa_SempliceCodificaHardwareNVidia


if !ForzaQuantizAdatValue!==0 (
        set "SettaggioForzaQuantizAdat=--aq-strength 0"
        set "SettingForzaQuantAdat=0 !t86!"
        echo.
        echo !t87! !SettingForzaQuantAdat!
        echo.
        echo !t43! !SettaggioForzaQuantizAdat!
) else (
        set "SettaggioForzaQuantizAdat=--aq-strength !ForzaQuantizAdatValue!"
        set "SettingForzaQuantAdat=!ForzaQuantizAdatValue!"
        echo.
        echo !t87! !SettingForzaQuantAdat!
        echo.
        echo !t43! !SettaggioForzaQuantizAdat!
)

:finequantizzazioneAdattativa_SempliceCodificaHardwareNVidia




rem precisione vettore di movimento
echo.
echo !t88!
echo.
echo 1) Auto
echo 2) Q-pel !t89!
echo 3) half-pel
echo 4) full-pel !t90!
echo.
CHOICE /N /C:1234 /M "!t64!"

if errorlevel 4 goto precisioneVettoreMovimentoFull-pel_SempliceCodificaHardwareNVidia
if errorlevel 3 goto precisioneVettoreMovimentoHalf-pel_SempliceCodificaHardwareNVidia
if errorlevel 2 goto precisioneVettoreMovimentoQ-pel_SempliceCodificaHardwareNVidia
if errorlevel 1 goto precisioneVettoreMovimentoAuto_SempliceCodificaHardwareNVidia

:precisioneVettoreMovimentoFull-pel_SempliceCodificaHardwareNVidia
set "SettaggioPrecisioneVettoreMovimento=--mv-precision full-pel"
set "SettingPrecisioneVettoreMovimento=Full-pel"
goto precisioneVettoreMovimento_SempliceCodificaHardwareNVidia

:precisioneVettoreMovimentoHalf-pel_SempliceCodificaHardwareNVidia
set "SettaggioPrecisioneVettoreMovimento=--mv-precision half-pel"
set "SettingPrecisioneVettoreMovimento=Half-pel"
goto precisioneVettoreMovimento_SempliceCodificaHardwareNVidia

:precisioneVettoreMovimentoQ-pel_SempliceCodificaHardwareNVidia
set "SettaggioPrecisioneVettoreMovimento=--mv-precision Q-pel"
set "SettingPrecisioneVettoreMovimento=Q-pel"
goto precisioneVettoreMovimento_SempliceCodificaHardwareNVidia

:precisioneVettoreMovimentoAuto_SempliceCodificaHardwareNVidia
set "SettaggioPrecisioneVettoreMovimento=--mv-precision Auto"
set "SettingPrecisioneVettoreMovimento=Auto"
goto precisioneVettoreMovimento_SempliceCodificaHardwareNVidia

:precisioneVettoreMovimento_SempliceCodificaHardwareNVidia
echo.
echo !t91 !SettingPrecisioneVettoreMovimento!
echo.
echo !t43! !SettaggioPrecisioneVettoreMovimento!



rem denoiser
echo.
echo !t92!
echo.
echo 1) Convolution3D
echo 2) PMD
echo 3) FFT3D
echo 4) KNN
echo 5) NLMEANS
echo 6) DCT
echo 7) !t93!
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto NessundenoiserNVEnc_SempliceCodificaHardwareNVidia
if errorlevel 6 goto denoiserDCTNVEnc_SempliceCodificaHardwareNVidia
if errorlevel 5 goto denoiserNLMEANSNVEnc_SempliceCodificaHardwareNVidia
if errorlevel 4 goto denoiserKNNNVEnc_SempliceCodificaHardwareNVidia
if errorlevel 3 goto denoiserFFT3DNVEnc_SempliceCodificaHardwareNVidia
if errorlevel 2 goto denoiserPMDNVEnc_SempliceCodificaHardwareNVidia
if errorlevel 1 goto denoiserConvolution3DNVEnc_SempliceCodificaHardwareNVidia


:NessundenoiserNVEnc_SempliceCodificaHardwareNVidia
echo.
set "nvdenoiser="
echo !t94!

goto finesceltadenoiserNVEnc_SempliceCodificaHardwareNVidia


:denoiserConvolution3DNVEnc_SempliceCodificaHardwareNVidia
echo.
echo !t95!
echo.
echo 1) !t96!
echo 2) !t97!
echo 3) !t98!
echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto Convolution3DForteNVEnc_SempliceCodificaHardwareNVidia
if errorlevel 2 goto Convolution3DMedioNVEnc_SempliceCodificaHardwareNVidia
if errorlevel 1 goto Convolution3DLeggeroNVEnc_SempliceCodificaHardwareNVidia


:Convolution3DForteNVEnc_SempliceCodificaHardwareNVidia
set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=4.50,cthresh=6.00,t_ythresh=1.50,t_cthresh=2.00" 
echo.
echo !t99! !t98!
echo.
echo !t43! !nvdenoiser! 
goto fineconvolution3dimpostazioniNVEnc_SempliceCodificaHardwareNVidia

:Convolution3DMedioNVEnc_SempliceCodificaHardwareNVidia
set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=3.00,cthresh=4.00,t_ythresh=1.50,t_cthresh=2.00" 
echo.
echo !t99! !t97!
echo.
echo !t43! !nvdenoiser! 
goto fineconvolution3dimpostazioniNVEnc_SempliceCodificaHardwareNVidia

:Convolution3DLeggeroNVEnc_SempliceCodificaHardwareNVidia
set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
echo.
echo !t99! !t96!
echo.
echo !t43! !nvdenoiser! 
goto fineconvolution3dimpostazioniNVEnc_SempliceCodificaHardwareNVidia

:fineconvolution3dimpostazioniNVEnc_SempliceCodificaHardwareNVidia

goto :finesceltadenoiserNVEnc_SempliceCodificaHardwareNVidia

rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

:denoiserPMDNVEnc_SempliceCodificaHardwareNVidia
echo.
echo !t100!
echo.
echo 1) !t96!
echo 2) !t97!
echo 3) !t98!
echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto PMDForteNVEnc_SempliceCodificaHardwareNVidia
if errorlevel 2 goto PMDMedioNVEnc_SempliceCodificaHardwareNVidia
if errorlevel 1 goto PMDLeggeroNVEnc_SempliceCodificaHardwareNVidia


:PMDForteNVEnc_SempliceCodificaHardwareNVidia
set "nvdenoiser=--vpp-pmd apply_count=20,strength=100,threshold=100" 
echo.
echo !t101! !t98!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserPMDimpostazioniNVEnc_SempliceCodificaHardwareNVidia

:PMDMedioNVEnc_SempliceCodificaHardwareNVidia
set "nvdenoiser=--vpp-pmd apply_count=15,strength=75,threshold=75" 
echo.
echo !t101! !t97!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserPMDimpostazioniNVEnc_SempliceCodificaHardwareNVidia

:PMDLeggeroNVEnc_SempliceCodificaHardwareNVidia
set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
echo.
echo !t101! !t96!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserPMDimpostazioniNVEnc_SempliceCodificaHardwareNVidia


:finedenoiserPMDimpostazioniNVEnc_SempliceCodificaHardwareNVidia
goto :finesceltadenoiserNVEnc_SempliceCodificaHardwareNVidia

rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

:denoiserFFT3DNVEnc_SempliceCodificaHardwareNVidia
echo.
echo !t102!
echo.
echo 1) !t96!
echo 2) !t97!
echo 3) !t98!
echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto FFT3DForteNVEnc_SempliceCodificaHardwareNVidia
if errorlevel 2 goto FFT3DMedioNVEnc_SempliceCodificaHardwareNVidia
if errorlevel 1 goto FFT3DLeggeroNVEnc_SempliceCodificaHardwareNVidia


:FFT3DForteNVEnc_SempliceCodificaHardwareNVidia
set "nvdenoiser=--vpp-fft3d sigma=100.0,amount=1.0,block_size=32,overlap=0.5,method=0,temporal=1,prec=auto" 
echo.
echo !t103! !t98!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserFFT3DimpostazioniNVEnc_SempliceCodificaHardwareNVidia

:FFT3DMedioNVEnc_SempliceCodificaHardwareNVidia
set "nvdenoiser=--vpp-fft3d sigma=60.0,amount=0.6,block_size=32,overlap=0.5,method=0,temporal=1,prec=auto" 
echo.
echo !t103! !t97!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserFFT3DimpostazioniNVEnc_SempliceCodificaHardwareNVidia

:FFT3DLeggeroNVEnc_SempliceCodificaHardwareNVidia
set "nvdenoiser=--vpp-fft3d sigma=30.0,amount=0.3,block_size=32,overlap=0.5,method=0,temporal=1,prec=auto" 
echo.
echo !t103! !t96!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserFFT3DimpostazioniNVEnc_SempliceCodificaHardwareNVidia



:finedenoiserFFT3DimpostazioniNVEnc_SempliceCodificaHardwareNVidia
goto :finesceltadenoiserNVEnc_SempliceCodificaHardwareNVidia

rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


:denoiserKNNNVEnc_SempliceCodificaHardwareNVidia
echo.
echo !t104!
echo.
echo 1) !t96!
echo 2) !t97!
echo 3) !t98!
echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto KNNForteNVEnc_SempliceCodificaHardwareNVidia
if errorlevel 2 goto KNNMedioNVEnc_SempliceCodificaHardwareNVidia
if errorlevel 1 goto KNNLeggeroNVEnc_SempliceCodificaHardwareNVidia


:KNNForteNVEnc_SempliceCodificaHardwareNVidia
set "nvdenoiser=--vpp-knn radius=5,strength=0.15,lerp=0.1,th_lerp=0.8" 
echo.
echo !t105! !t98!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserKNNimpostazioniNVEnc_SempliceCodificaHardwareNVidia

:KNNMedioNVEnc_SempliceCodificaHardwareNVidia
set "nvdenoiser=--vpp-knn radius=4,strength=0.10,lerp=0.1,th_lerp=0.8" NLMEANSForteNVEn
echo.
echo !t105! !t97!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserKNNimpostazioniNVEnc_SempliceCodificaHardwareNVidia

:KNNLeggeroNVEnc_SempliceCodificaHardwareNVidia
set "nvdenoiser=--vpp-knn radius=3,strength=0.05,lerp=0.1,th_lerp=0.8" 
echo.
echo !t105! !t96!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserKNNimpostazioniNVEnc_SempliceCodificaHardwareNVidia


:finedenoiserKNNimpostazioniNVEnc_SempliceCodificaHardwareNVidia
goto :finesceltadenoiserNVEnc_SempliceCodificaHardwareNVidia

rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


:denoiserNLMEANSNVEnc_SempliceCodificaHardwareNVidia
echo.
echo !t106!
echo.
echo 1) !t96!
echo 2) !t97!
echo 3) !t98!
echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto NLMEANSForteNVEnc_SempliceCodificaHardwareNVidia
if errorlevel 2 goto NLMEANSMedioNVEnc_SempliceCodificaHardwareNVidia
if errorlevel 1 goto NLMEANSLeggeroNVEnc_SempliceCodificaHardwareNVidia


:NLMEANSForteNVEnc_SempliceCodificaHardwareNVidia
set "nvdenoiser=--vpp-nlmeans sigma=0.05,h=0.005,patch=7,search=15" 
echo.
echo !t107! !t98!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserNLMEANSimpostazioniNVEnc_SempliceCodificaHardwareNVidia

:NLMEANSMedioNVEnc_SempliceCodificaHardwareNVidia
set "nvdenoiser=--vpp-nlmeans sigma=0.03,h=0.005,patch=7,search=15" 
echo.
echo !t107! !t97!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserNLMEANSimpostazioniNVEnc_SempliceCodificaHardwareNVidia

:NLMEANSLeggeroNVEnc_SempliceCodificaHardwareNVidia
set "nvdenoiser=--vpp-nlmeans sigma=0.01,h=0.005,patch=7,search=15" 
echo.
echo !t107! !t96!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserNLMEANSimpostazioniNVEnc_SempliceCodificaHardwareNVidia


:finedenoiserNLMEANSimpostazioniNVEnc_SempliceCodificaHardwareNVidia
goto :finesceltadenoiserNVEnc_SempliceCodificaHardwareNVidia

rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

:denoiserDCTNVEnc_SempliceCodificaHardwareNVidia
echo.
echo !t108!
echo.
echo 1) !t96!
echo 2) !t97!
echo 3) !t98!
echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto DCTForteNVEnc_SempliceCodificaHardwareNVidia
if errorlevel 2 goto DCTMedioNVEnc_SempliceCodificaHardwareNVidia
if errorlevel 1 goto DCTLeggeroNVEnc_SempliceCodificaHardwareNVidia


:DCTForteNVEnc_SempliceCodificaHardwareNVidia
set "nvdenoiser=--vpp-denoise-dct step=1,sigma=10.0" 
echo.
echo !t109! !t98!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserDCTimpostazioniNVEnc_SempliceCodificaHardwareNVidia

:DCTMedioNVEnc_SempliceCodificaHardwareNVidia
set "nvdenoiser=--vpp-denoise-dct step=1,sigma=5.0" 
echo.
echo !t109! !t97!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserDCTimpostazioniNVEnc_SempliceCodificaHardwareNVidia

:DCTLeggeroNVEnc_SempliceCodificaHardwareNVidia
set "nvdenoiser=--vpp-denoise-dct step=1,sigma=2.0" 
echo.
echo !t109! !t96!
echo.
echo !t43! !nvdenoiser! 
goto finedenoiserDCTimpostazioniNVEnc_SempliceCodificaHardwareNVidia

:finedenoiserDCTimpostazioniNVEnc_SempliceCodificaHardwareNVidia

goto :finesceltadenoiserNVEnc_SempliceCodificaHardwareNVidia


:finesceltadenoiserNVEnc_SempliceCodificaHardwareNVidia



echo.
if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t57!"
    if errorlevel 2 goto ApplicaMiglioramentoDettagliNVEncNo_SempliceCodificaHardwareNVidia
    if errorlevel 1 goto ApplicaMiglioramentoDettagliNVEncSi_SempliceCodificaHardwareNVidia
)
CHOICE /N /C:SN /M "!t57!"

if errorlevel 2 goto ApplicaMiglioramentoDettagliNVEncNo_SempliceCodificaHardwareNVidia
if errorlevel 1 goto ApplicaMiglioramentoDettagliNVEncSi_SempliceCodificaHardwareNVidia

:ApplicaMiglioramentoDettagliNVEncNo_SempliceCodificaHardwareNVidia
set "miglioramento1080p=N"
goto fineSceltaMigliaramentiNVEnc_SempliceCodificaHardwareNVidia

:ApplicaMiglioramentoDettagliNVEncSi_SempliceCodificaHardwareNVidia
set "miglioramento1080p=S"

:fineSceltaMigliaramentiNVEnc_SempliceCodificaHardwareNVidia
if !miglioramento1080p!==S ( 
                                set "edgeleveling=--vpp-edgelevel strength=10.0,threshold=24.0,black=6,white=0" 
                                echo.
                                echo NVEnc !t58!
                                echo.
                                )
if !miglioramento1080p!==N ( 
                                set "edgeleveling=" 
                                echo.
                                echo NVEnc !t59!
                                echo.
                                )



echo.
echo !t114!
echo.



set file_senza_virgolette=%NomeFile:"=%
rem echo %file_senza_virgolette%

set file_senza_estensione=%file_senza_virgolette:.mkv=%
rem echo %file_senza_estensione%

set fileoutput2160p="%file_senza_estensione%_Encoded.mkv"

@REM echo miglioramento1080p = !miglioramento1080p!
@REM echo.
@REM pause 


if !miglioramento1080p!==S (
                                @REM echo dento if S
                                set fileoutput2160pdetailed2="!file_senza_estensione!_Encoded.mkv"
                                @REM echo fileoutput2160pdetailed2 = !fileoutput2160pdetailed2!
                                set fileoutput2160pdetailed="!file_senza_estensione!_Encoded_pul_leggera.mkv"
                                @REM echo fileoutput2160pdetailed = !fileoutput2160pdetailed!
                                )

if !miglioramento1080p!==N  (
                                @REM echo dento if N
                                set fileoutput2160pdetailed2="!file_senza_estensione!_Encoded.mkv"
                                @REM echo fileoutput2160pdetailed2 = !fileoutput2160pdetailed2!
                                set fileoutput2160pdetailed="!file_senza_estensione!_Encoded_pul_leggera.mkv"
                                @REM echo fileoutput2160pdetailed = !fileoutput2160pdetailed!
                                )


set fileoutput2160pdetailed_senza_virgolette=!fileoutput2160pdetailed:"=! 
rem echo !fileoutput2160pdetailed_senza_virgolette!


for %%i in ("!fileoutput2160pdetailed_senza_virgolette!") do (  
                                                                set "solo_nome_file=%%~ni"
                                                                rem echo Nome file: !solo_nome_file!

                                                                set "solo_estensione_file=%%~xi"
                                                                rem echo Estensione: !solo_estensione_file!
                                                                )

set fileoutput2160pdetailed_rinominato=!solo_nome_file!_rinominato!solo_estensione_file!

rem echo %fileoutput2160pdetailed_rinominato%



set fileoutput2160pdetailed2_senza_virgolette=!fileoutput2160pdetailed2:"=! 
rem echo %fileoutput2160pdetailed2_senza_virgolette%

for %%i in ("!fileoutput2160pdetailed2_senza_virgolette!") do (  
                                                                set "solo_nome_file=%%~ni"
                                                                rem echo Nome file: !solo_nome_file!

                                                                set "solo_estensione_file=%%~xi"
                                                                rem echo Estensione: !solo_estensione_file!
                                                                )

set fileoutput2160pdetailed2_rinominato=!solo_nome_file!_rinominato!solo_estensione_file!

rem echo %fileoutput2160pdetailed2_rinominato%

if exist "Temp_HDR10_Stream.txt" ( del Temp_HDR10_Stream.txt )
if exist "durata_film.txt" ( del durata_film.txt )
if exist "crop.txt" ( del crop.txt )
if exist "risultato_multiplo.txt" ( del risultato_multiplo.txt )
if exist "crop_multiplo.txt" ( del crop_multiplo.txt )
if exist "crop_finale.txt" ( del crop_finale.txt )


".\bin\nvenc\NVEncC64.exe" --avsw --device 0 -i !NomeFile!  --output-res !mwidth!x!mheight!  !cropff! --video-metadata clear --metadata clear --chapter-copy -c hevc !tipoQuantizzazioneNVEnc! --bref-mode disabled !SettaggioQualitaNVEnc! !SettaggioLookahead! !SettaggioQuantizAdat! !SettaggioForzaQuantizAdat! --profile auto --level auto !tiervalue! --chromaloc auto --colorrange auto --colormatrix auto --transfer auto --colorprim auto --master-display copy --max-cll copy  !outputdepthvalue! --multipass None !SettaggioPrecisioneVettoreMovimento! --avsync cfr --psnr --ssim     -m default_mode:infer_no_subs    --vpp-resize algo=lanczos4  !edgeleveling! !nvdenoiser! --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o !fileoutput2160pdetailed2!

ren !fileoutput2160pdetailed2! "!fileoutput2160pdetailed2_rinominato!"


echo.
echo !t112!
echo.


rem////////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////////


goto fineinfovideo_SempliceCodificaHardwareNVidia




:novideofile_SempliceCodificaHardwareNVidia
echo !t63!
echo.


:fineinfovideo_SempliceCodificaHardwareNVidia


if exist ".\saved\settings.dat" (
                                for /f "tokens=1,2 delims=|" %%a in (.\saved\settings.dat) do (
                                                                                                    rem echo %%a
                                                                                                    rem echo %%b
                                                                                                    set /a "shst=%%b"
                                                                                                    rem echo !shst!
                                                                                                    rem pause
                                                                                                    if !shst!==1 (
                                                                                                                echo !t1000!
                                                                                                                echo.
                                                                                                                shutdown /s
                                                                                                                set /a "delay=10"
                                                                                                                timeout /t !delay!
                                                                                                                exit
                                                                                                                )
                                                                                                                            
                                                                                                    )                                                                                                  
                                                                                                )


if exist "Temp_HDR10_Stream.txt" ( del Temp_HDR10_Stream.txt )
if exist "durata_film.txt" ( del durata_film.txt )
if exist "crop.txt" ( del crop.txt )
if exist "risultato_multiplo.txt" ( del risultato_multiplo.txt )
if exist "crop_multiplo.txt" ( del crop_multiplo.txt )
if exist "crop_finale.txt" ( del crop_finale.txt )



set waitenter=
set /P waitenter=!t113!
Endlocal
goto puliziainiziale







rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:QSVEncDownGrade1080p10bitSDRto1080p8bitSDR

cls
setLocal EnableExtensions EnableDelayedExpansion


for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoQSVEncDownGrade1080p10bitSDRto1080p8bitSDR
)

if %lingua%==inglese (
    goto caricalinguaingleseQSVEncDownGrade1080p10bitSDRto1080p8bitSDR
)



:caricalinguaingleseQSVEncDownGrade1080p10bitSDRto1080p8bitSDR
@REM set t1=Insert Hardware Video Encoding Info DownGrading from 1080p 10 bit SDR to 1080p 8 bit SDR and Saving to Disk

set t2=Drag Here the Video File 1080p 10 bit SDR to Convert to 8 bit:  
@REM set t211=File 1080p 10 bit SDR to Convert to 8 bit:  

set t3=File does not exist 
set t4=Info Video:  
set t5=The Inserted Video is 1080p 10bit SDR 
set t6=The Inserted Video isn't 1080p 10bit SDR 
set t7=Video Duration in seconds:
set t8=Video Duration in Minutes:
set t9=Interval between Frames for Crop Detection:
set t10= seconds
set t11=Black Bands Detection Started....
set t12=Crop Detection to Frame
set t13=to seconds
set t14=Done...
set t15=Input Video 1080p Width: 
set t16=Input Video 1080p Height:
set t17=Output Video 1080p Width Without Black Bars:
set t18=Outout Video 1080p Height Without Black Bars:
set t19=Adapting Video Resolution to Full 1080p Format...
set t20=Final Output Video Width 1080p:
set t21=Final Output Video Height 1080p:
set t22=Settings of Black Bands to Crop are Correct (Yes/No):
set t23=Manually Entering Black Band Values to Crop... 
set t24=Enter the Upper Black Band Value: 
set t25=Error Entering Upper Black Band Value... It's Not a Number. 
set t26=Enter the Lower Black Band Value: 
set t27=Error Entering Lower Black Band Value... It's Not a Number.
set t28=Enter the Left Black Band Value: 
set t29=Error Entering Left Black Band Value... It's Not a Number.
set t30=Enter the Right Black Band Value: 
set t31=Error Entering Right Black Band Value... It's Not a Number.
set t32=Upper Black Band:
set t33=Lower Black Band:
set t34=Left Black Band:
set t35=Right Black Band:
set t36=Original Video Width 1080p Without Black Bars:
set t37=Original Video Height 1080p Without Black Bars:
set t38=Select Graphic Card you want to Encode with:
set t39=Choose (1/2):
set t40=Select Encoding Type:
set t41=Error Entering Quantization Value... Not a Number. 
set t42=Quantization Value Set to:
set t43=Encoding Settings:
set t44=Enter Quantization value Minimum 10 Maximum 28:
set t45=Quantization Value Out of  Limits  10 / 28  Re-enter^!
set t46=Enter BitRate Value kbs Minimum 100 Maximum 50000:
set t47=Error Entering BitRate Value... It's Not a Number. 
set t48=BitRate Value Set to:
set t49=BitRate Value Out of Limits  100 / 50000  Re-enter^!
set t50=Select Encoding Quality:
set t51=- Worst Quality
set t52=- Best Quality
set t53=Choose (1/2/3/4/5/6/7):
set t54=Quality Set to:
set t55=Apply Convolution3D denoiser Yes/No: 
set t56=Apply PMD denoiser Yes/No: 
set t57=Apply Detail Enhancement Yes/No:  
set t58=Enhancement Detail: Yes 
set t59=Enhancement Detail: No 
set t60=Info
set t61=Videos to Encode Saved!
set t62=Do You Want to Insert Another Video to Encode (Yes/No):
set t63=The dragged file is not a video!
set t64=Choose (1/2/3/4):
set t65=Press Enter to Back to Main Menu.  

set t66=Video Width
set t67=Video Height
set t68=Video Codec
set t69=Details Video Codec
set t70=Video Format 

set t71=DownGrading Started.... 
set t72=Encoding Finished...
set t1000=Now the PC will be turned off... 

goto avvio_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR




:caricalinguaitalianoQSVEncDownGrade1080p10bitSDRto1080p8bitSDR
@REM set t1=Inserimento Info Codifica Hardware Video DownGrading da 1080p 10 bit SDR a 1080p 8 bit SDR e Salvataggio su Disco.

set t2=Trascina Qui il File Video  1080p 10 bit SDR da Convertire a 8 bit:  
@REM set t211=File Video 1080p 10 bit SDR da Convertire a 8 bit:  

set t3=File Inesistente 
set t4=Informazioni Video:  
set t5=Il Video inserito e' 1080p 10bit SDR 
set t6=Il Video inserito non e' 1080p 10bit SDR 
set t7=Durata del Video in secondi:
set t8=Durata del video in Minuti:
set t9=Intervallo tra i Fotogrammi per il Rilevamento del crop:
set t10= secondi
set t11=Rilevamento Bande Nere Iniziato....
set t12=Rilevazione crop fotogramma
set t13=a secondi
set t14=Eseguita...
set t15=Larghezza Video 1080p Originale: 
set t16=Altezza Video 1080p Originale:
set t17=Larghezza Video 1080p Senza Barre Nere:
set t18=Altezza Video 1080p Senza Barre Nere:
set t19=Adattamento della Risoluzione del Video al Pieno Formato 1080p..
set t20=Larghezza Finale Video di Output 1080p:
set t21=Altezza Finale Video di Output 1080p:
set t22=Le Impostazioni delle Bande Nere da Tagliare sono Corrette (Si/No):
set t23=Inserimento Manuale Valori Bande Nere da Tagliare.. 
set t24=Inserisci il Valore della Banda Nera Superiore: 
set t25=Errore nell'Inserimento del Valore della Banda Nera Superiore... Non e' un Numero. 
set t26=Inserisci il Valore della Banda Nera Inferiore: 
set t27=Errore nell'Inserimento del Valore della Banda Nera Inferiore... Non e' un Numero. 
set t28=Inserisci il Valore della Banda Nera Sinistra: 
set t29=Errore nell'Inserimento del Valore della Banda Nera Sinistra... Non e' un Numero. 
set t30=Inserisci il Valore della Banda Nera Destra: 
set t31=Errore nell'Inserimento del Valore della Banda Nera Destra... Non e' un Numero. 
set t32=Banda Nera Superiore:
set t33=Banda Nera Inferiore:
set t34=Banda Nera Sinistra:
set t35=Banda Nera Destra:
set t36=Larghezza Video Originale 1080p Senza Barre Nere:
set t37=Altezza Video Originale 1080p Senza Barre Nere:
set t38=Selezionare Scheda Grafica con cui Eseguire la Codifica:
set t39=Scegli (1/2):
set t40=Selezionare tipo di Codifica:
set t41=Errore nell'Inserimento del Valore della Quantizzazione... Non e' un Numero. 
set t42=Valore Quantizzazzione Impostato a:
set t43=Parametri per codifica:
set t44=Inserire Valore Quantizzazione Minimo 10 Massimo 28:
set t45=Valore Quantizzazzione al di fuori dei  Limiti  10 / 28  Reinserire^!
set t46=Inserire Valore BitRate kbs Minimo 100 Massimo 50000:
set t47=Errore nell'Inserimento del Valore del BitRate... Non e' un Numero. 
set t48=Valore BitRate Impostato a:
set t49=Valore  BitRate al di fuori dei  Limiti  100 / 50000  Reinserire^!
set t50=Selezionare Qualita' Codifica:
set t51=- Peggiore Qualita'
set t52=- Migliore Qualita'
set t53=Scegli (1/2/3/4/5/6/7):
set t54=Qualita' Impostata su:
set t55=Applicare il denoiser Convolution3D Si/No: 
set t56=Applicare il denoiser PMD Si/No: 
set t57=Applicare il Miglioramento Dettagli Si/No:  
set t58=Miglioramento Dettagli: Si 
set t59=Miglioramento Dettagli: No 
set t60=Informazioni
set t61=Video da Codificare Salvate!
set t62=Vuoi Inserire un altro Video da Codificare (Si/No):
set t63=Il file trascinato non e' un video!
set t64=Scegli (1/2/3/4):
set t65=Premi Invio per tornare al Menu' Principale.  

set t66=Larghezza Video
set t67=Altezza Video
set t68=Codec Video
set t69=Codec Video Dettagli
set t70=Format Video 

set t71=DownGrading Iniziato.... 
set t72=Codifica Terminata...
set t1000=Il PC ora verra' Spento... 

goto avvio_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR


:avvio_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR


set /a "numeromovie=1"



:altrivideodainserireNVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR


set NomeFile2160ppuliziadettaggli=
rem set MetadatiStreamHDR10=

set /P NomeFile2160ppuliziadettaggli=!t2! 
rem echo Hai digitato: %NomeFile%
rem pause

set "NomeFileSorgente=!NomeFile2160ppuliziadettaggli:"=!"
@REM echo NomeFileSorgente = !NomeFileSorgente!
set "NomeFile=^"!NomeFileSorgente!^""
@REM echo NomeFile = !NomeFile!
rem pause


if exist !NomeFile! ( goto infovideo_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR ) else ( 
                                                        echo.
                                                        echo !t3!
                                                        echo.
                                                        goto fineinfovideo_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
                                                        )    



:infovideo_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR

echo.
echo !t4!
echo.

.\bin\ffprobe -v error -hide_banner -select_streams v:0 -show_entries stream=width,height,codec_name,codec_long_name,pix_fmt,color_space,color_transfer,color_primaries -of default=noprint_wrappers=1 !NomeFile! > ".\temp\Temp_HDR10_Stream.txt"

set /A x1=1
set /A nohdrcs=0
set /A nohdrct=0
set /A nohdrcp=0
set /A wv=0
set /a hv=0
set /A fv=0
set def=
rem echo nohdr = %nohdr%

for /f "tokens=1,2 delims==" %%a in (.\temp\Temp_HDR10_Stream.txt) do (if !x1!==3 ( 
                                                                            echo !t66! "%%a" = %%b  
                                                                            set /A "widthvideo=%%b"
                                                                            @REM echo widthvideo = !widthvideo!

                                                                            if !widthvideo! LEQ 1920 if !widthvideo! GEQ 1000 (set /A "wv=1"
                                                                                                                                @REM echo wv = !wv!
                                                                                                                                set "def=1080p"
                                                                                                                                )
                                                                            )
                                                                if !x1!==4 ( 
                                                                            echo !t67! "%%a" = %%b  
                                                                            set /A "heightvideo=%%b"
                                                                            @REM echo heightvideo = !heightvideo!
          
                                                                            if !heightvideo! LEQ 1080 if !heightvideo! GEQ 700 (set /A "hv=1"
                                                                                                                                @REM echo hv = !hv!
                                                                                                                                )
                                                                            )                                                           
                                                                if !x1!==6 ( 
                                                                            echo Color Space "%%a" = %%b  
                                                                            set "colorsp=%%b"
                                                                            @REM echo colorsp = !colorsp!
                                                                            if !colorsp!==bt709 (set /A "nohdrcs=1"
                                                                                                    @REM echo nohdrcs = !nohdrcs!
                                                                                                    )
                                                                            if !colorsp!==unknown (set /A "nohdrcs=1"
                                                                                                    @REM echo nohdrcs = !nohdrcs!
                                                                                                    )
                                                                            if !colorsp!==reserved (set /A "nohdrcs=1"
                                                                                                    @REM echo nohdrcs = !nohdrcs!
                                                                                                    )                    
                                                                            ) 
                                                                if !x1!==7 ( 
                                                                            echo Color Transfer "%%a" = %%b  
                                                                            set "colortr=%%b"
                                                                            @REM echo colortr = !colortr!
                                                                            if !colortr!==bt709 (set /A "nohdrct=1"
                                                                                                    @REM echo nohdrct = !nohdrct!
                                                                                                    )
                                                                            if !colortr!==unknown (set /A "nohdrct=1"
                                                                                                    @REM echo nohdrct = !nohdrct!
                                                                                                    )
                                                                            if !colortr!==reserved (set /A "nohdrct=1"
                                                                                                    @REM echo nohdrct = !nohdrct!
                                                                                                    )
                                                                            ) 
                                                                if !x1!==8 ( 
                                                                            echo Color Primaries "%%a" = %%b  
                                                                            set "colorpr=%%b"
                                                                            @REM echo colorpr = !colorpr!
                                                                            if !colorpr!==bt709 (set /A "nohdrcp=1"
                                                                                                    @REM echo nohdrcp = !nohdrcp!
                                                                                                    )      
                                                                            if !colorpr!==unknown (set /A "nohdrcp=1"
                                                                                                    @REM echo nohdrcp = !nohdrcp!
                                                                                                    )
                                                                            if !colorpr!==reserved (set /A "nohdrcp=1"
                                                                                                    @REM echo nohdrcp = !nohdrcp!
                                                                                                    )     
                                                                            )    
                                                                if !x1!==1 ( 
                                                                            echo !t68! "%%a" = %%b  
                                                                            )       
                                                                if !x1!==2 ( 
                                                                            echo !t69! "%%a" = %%b  
                                                                            )   
                                                                if !x1!==5 ( 
                                                                            echo !t70! "%%a" = %%b  
                                                                            set "formatvideo=%%b"
                                                                            @REM echo formatvideo = !formatvideo!
                                                                            if !formatvideo!==yuv420p10le (set /A "fv=1"
                                                                                                            @REM echo fv = !fv!
                                                                                                            )
                                                                            )
                                                                set /A x1+=1                                                            
)
echo.

if !x1!==1 goto :novideofile1080p10bitSDR


if !nohdrcs!==1 if !nohdrct!==1 if !nohdrcp!==1 if !wv!==1 if !hv!==1 if !fv!==1 ( 
                                                                                   echo !t5!
                                                                                   goto RilevazioneBandeNere_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR                                                                   
                                                                                   ) 


echo !t6!
echo.
goto fineinfovideo_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR

echo.


:RilevazioneBandeNere_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR

.\bin\ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 !NomeFile!  > ".\temp\durata_film.txt"

set /a contatore=1
for /f "tokens=1 delims=." %%a in (.\temp\durata_film.txt) do  (
                                                        echo. 
                                                        echo !t7! %%a
                                                        set /a "secondi=%%a"
                                                        set /a "minuti=!secondi!/60"
                                                        echo !t8! !minuti!
                                                        set /a "intervallo_tagli=!secondi!/11"
                                                        echo !t9! !intervallo_tagli!!t10!
                                                        echo.
                                                        echo !t11!
                                                        echo.

                                                        

                                                        FOR /L %%a IN (1, 1, 10) DO (
                                                                                    rem echo %%a
                                                                                    set /a "secondi=%%a*!intervallo_tagli!"
                                                                                    rem echo !secondi!

                                                                                    
                                                                                    set /a "ca=16"
                                                                                    rem echo !ca!
                                                                                                                    
                                                                                    set /a "cb=2"
                                                                                    rem echo !cb!
                                                                                                                    
                                                                                    set /a "cc=0"
                                                                                    rem echo !cc!

                                                                                    set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                    rem echo !cr!
        
                                                                                
                                                                                    .\bin\ffmpeg -ss !secondi! -hide_banner -nostats -i !NomeFile! -vframes 10 -vf !cr! -f null - 2> ".\temp\crop.txt"
                                                                                    
                                                                                    findstr /r "Parsed_cropdetect_0" .\temp\crop.txt >> .\temp\risultato_multiplo.txt   
                                                                                    
                                                                                    echo !t12! %%a !t13! !secondi! !t14!
                                                                                    
                                                                                    )       
                                                                                       

                                                                                    for /f "tokens=1,2 delims==" %%a in (.\temp\risultato_multiplo.txt) do ( echo %%b >> .\temp\crop_multiplo.txt )
                                                                                    
                                                                                    set /a "maxfrequenza=0"

                                                                                    for /f "delims=" %%a in (.\temp\crop_multiplo.txt) do ( 
                                                                                                                                    set "cropconfront=%%a"
                                                                                                                                    rem echo "!cropconfront!"
                                                                                                                                    
                                                                                                                                    set /a "contatorfrequenza=0"
                                                                                                                                    for /f "delims=" %%b in (.\temp\crop_multiplo.txt) do (
                                                                                                                                                                                    set "dato_da_verificare=%%b"
                                                                                                                                                                                    rem echo cropconfront = "!cropconfront!"
                                                                                                                                                                                    rem echo dato_da_verificare = "!dato_da_verificare!"
                                                                                                                                                                                    if !cropconfront!==!dato_da_verificare! ( set /a "contatorfrequenza+=1")
                                                                                                                                                                                    )
                                                                                                                                    if !maxfrequenza! LSS !contatorfrequenza! ( 
                                                                                                                                                                                set /a "maxfrequenza=!contatorfrequenza!"
                                                                                                                                                                                set "cropd=!cropconfront!"
                                                                                                                                                                                )
                                                                                                                                    

                                                                                                                                    rem if !cropconfront! in (elenco_crop_frequenza.txt) ()
                                                                                                                                    rem echo !cropconfront!:!contatorfrequenza! >> elenco_crop_frequenza.txt

                                                                                                                                    )

                                                                                    rem echo crop piu' frequente = !cropd! con grequenza = !maxfrequenza!
                                                                                    echo !cropd! > .\temp\crop_finale.txt

                                                                                    for /f "tokens=1,2,3,4 delims=:" %%a in (.\temp\crop_finale.txt) do  ( 
                                                                                                                                                    rem set /a "mwidth=%%a"
                                                                                                                                                    rem echo mwidth = !mwidth!

                                                                                                                                                    rem set /a "mheight=%%b"
                                                                                                                                                    rem echo mheight = !mheight!

                                                                                                                                                    rem set /a "mx=%%c"
                                                                                                                                                    rem echo mx = !mx!

                                                                                                                                                    rem set /a "my=%%d"
                                                                                                                                                    rem echo my = !my!

                                                                                                                                                    if !contatore!==1 ( 
                                                                                                                                                                set /a "wmax=%%a" 
                                                                                                                                                                set /a "hmax=%%b"
                                                                                                                                                                set /a "xmin=%%c"
                                                                                                                                                                set /a "ymin=%%d"
                                                                                                                                                                set /a "mwidth=%%a"
                                                                                                                                                                set /a "mheight=%%b"
                                                                                                                                                                set /a "mx=%%c"
                                                                                                                                                                set /a "my=%%d"
                                                                                                                                                                set /a "contatore+=1"
                                                                                                                                                                )
                                                                                                                                                    
                                                                                                                                                    rem if %%b gtr !hmax! if %%c gtr !xmin! if %%d gtr !ymin! 

                                                                                                                                                    if %%a geq !wmax! if %%b geq !hmax! ( 
                                                                                                                                                                        set /a "wmax=%%a" 
                                                                                                                                                                        set /a "hmax=%%b"
                                                                                                                                                                        set /a "xmin=%%c"
                                                                                                                                                                        set /a "ymin=%%d"
                                                                                                                                                                        set /a "mwidth=%%a"
                                                                                                                                                                        set /a "mheight=%%b"
                                                                                                                                                                        set /a "mx=%%c"
                                                                                                                                                                        set /a "my=%%d"
                                                                                                                                                                        )
                                                                                                                                                    )
                                                                                    echo.
                                                                                    set /a "csup=!my!"
                                                                                    rem echo csup = !csup!
                                                                                                                                    
                                                                                    set /a "csin=!mx!"
                                                                                    rem echo csin = !csin!

                                                                                    set /a "cinf=!heightvideo!-!mheight!-!my!"
                                                                                    rem echo movieheightreal = !movieheightreal!
                                                                                    rem echo cinf = !cinf!
                                                                                    set /a "cdes=!widthvideo!-!mwidth!-!mx!"
                                                                                    rem echo cdes = !cdes!

                                                                                    echo !t15! !widthvideo!  
                                                                                    echo !t16! !heightvideo!  
                                                                                    echo.

                                                                                    echo Crop Settings: --crop !csin!,!csup!,!cdes!,!cinf!  
                                                                                    set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"  
                                                                                    echo.  

                                                                                    set /a "height2k=(!heightvideo!-!csup!-!cinf!)/2*2"
                                                                                    set /a "width2k=(!widthvideo!-!csin!-!cdes!)/2*2"

                                                                                    echo !t17! !width2k!  
                                                                                    echo !t18! !height2k!  
                                                                                    echo.

                                                                                    @REM echo Larghezza Video Originale 1080p Senza Barre Nere:  !mwidth! 
                                                                                    @REM echo Altezza Video Originale 1080p Senza Barre Nere:  !mheight! 
                                                                                    @REM echo.

                                                                                    set /a "larghezza1080pnvenc=1920"
                                                                                    set /a "altezza1080pnvenc=1080"
                                                                                    @REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
                                                                                    @REM echo altezza1080pnvenc = !altezza1080pnvenc!                                    

                                                                                    set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!mwidth!"
                                                                                    set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!mheight!"
                                                                                    @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
                                                                                    @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

                                                                                    if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                                                                                                        @REM echo dentro il 1o if
                                                                                                                                                                        set /a "width2k=!mwidth!"
                                                                                                                                                                        set /a "height2k=!mheight!"
                                                                                                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                                                                                                set /a "width2k=!mwidth!"
                                                                                                                                                                                                                                                                set /a "height2k=!mheight!"
                                                                                                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                                                                                                        set /a "width2k=!mwidth!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        set /a "height2k=!mheight!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "width2k=!mwidth!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "height2k=!mheight!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                                                                                                                set /a "width2k=!mwidth!"
                                                                                                                                                                                                                                                                set /a "height2k=!mheight!"
                                                                                                                                                                                                                                                                )
                                                                                                                                                                        
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                                                                                                        set /a "width2k=!mwidth!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        set /a "height2k=!mheight!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.                         

                                                                                        echo !t20!  !width2k! 
                                                                                        echo !t21!  !height2k!    
                                                                                        echo.

                                                                                        @REM set /a "width4k=width2k*2"
                                                                                        @REM set /a "height4k=height2k*2"

                                                                                        @REM echo Larghezza Finale Video 2160p =  !width4k! 
                                                                                        @REM echo Altezza Finale Video 2160p =  !height4k!    
                                                                                        echo.

                                                                                    ) 
                                                        )                          

:cropmanuale_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
set /a "csup=0"
set /a "cinf=0"
set /a "csin=0"
set /a "cdes=0"
set /a "bandasuperiore=0"
set /a "bandainferiore=0"
set /a "bandasinistra=0"
set /a "bandadestra=0"
set /a "differenzialelarghezza1080pnvenc=0"
set /a "differenzialealtezza1080pnvenc=0"
if exist ".\temp\Temp_HDR10_Stream.txt" ( del ".\temp\Temp_HDR10_Stream.txt" ) 
if exist ".\temp\durata_film.txt" ( del ".\temp\durata_film.txt" )
if exist ".\temp\crop.txt" ( del ".\temp\crop.txt" )
if exist ".\temp\risultato_multiplo.txt" ( del ".\temp\risultato_multiplo.txt" )
if exist ".\temp\crop_multiplo.txt" ( del ".\temp\crop_multiplo.txt" )
if exist ".\temp\crop_finale.txt" ( del ".\temp\crop_finale.txt" )


if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t22!"   
    if errorlevel 2 goto cropmanualeNVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
    if errorlevel 1 goto finecropNVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
)

CHOICE /N /C:SN /M "!t22!"   

if errorlevel 2 goto cropmanualeNVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
if errorlevel 1 goto finecropNVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR


:cropmanualeNVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
echo.
echo !t23!
echo.

:banda_superiore_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
set /p "bandasuperiore=!t24!"
SET "var="&for /f "delims=0123456789" %%i in ("!bandasuperiore!") do set var=!bandasuperiore!
if defined var (
                echo.
                echo !t25!
                echo.
                goto banda_superiore_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
                ) else (
                        set /a "csup=!bandasuperiore!/2*2"
                        )

echo.


:banda_inferiore_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
set /p "bandainferiore=!t26!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandainferiore!") do set var=!bandainferiore!
if defined var (
                echo.
                echo !t27!
                echo.
                goto banda_inferiore_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
                ) else (
                        set /a "cinf=!bandainferiore!/2*2"
                        )


echo.
:banda_sinistra_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
set /p "bandasinistra=!t28!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandasinistra!") do set var=!bandasinistra!
if defined var (
                echo.
                echo !t29!
                echo.
                goto banda_sinistra_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
                ) else (
                        set /a "csin=!bandasinistra!/2*2"
                        )

                        
echo.
:banda_destra_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
set /p "bandadestra=!t30!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandadestra!") do set var=!bandadestra!
if defined var (
                echo.
                echo !t31!
                echo.
                goto banda_destra_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
                ) else (
                        set /a "cdes=!bandadestra!/2*2"
                        )


set /a "larghezza1080pnvenc=1920"
set /a "altezza1080pnvenc=1080"
@REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
@REM echo altezza1080pnvenc = !altezza1080pnvenc!                                    

set /a "mwidth=!widthvideo!/2*2"
set /a "mheight=!heightvideo!/2*2"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "mwidthc=!mwidth!-!csin!-!cdes!"
set /a "mheightc=!mheight!-!csup!-!cinf!"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "width2k=!mwidthc!"
set /a "height2k=!mheightc!"

set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!mwidthc!"
set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!mheightc!"
@REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
@REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

echo.
echo !t32!  !csup! 
echo !t33!  !cinf! 
echo !t34!  !csin! 
echo !t35!  !cdes! 
echo.


set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
echo Crop Settings: !cropff!
echo.

echo !t36!  !width2k! 
echo !t37!  !height2k! 
echo.



if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                        @REM echo dentro il 1o if
                                                                                        set /a "width2k=!mwidthc!"
                                                                                        set /a "height2k=!mheightc!"
                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                set /a "width2k=!mwidthc!"
                                                                                                                                                                                set /a "height2k=!mheightc!"
                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                        set /a "width2k=!mwidthc!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                        set /a "height2k=!mheightc!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                set /a "width2k=!mwidthc!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                set /a "height2k=!mheightc!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                )
                                                                                        if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                        set /a "width2k=!mwidthc!"
                                                                                                                                                                        set /a "height2k=!mheightc!"
                                                                                                                                                                        )
                                                                                                                                                                        
                                                                                        if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                set /a "width2k=!mwidthc!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                set /a "height2k=!mheightc!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.

                                                                                        echo !t20!  !width2k! 
                                                                                        echo !t21!  !height2k!    
                                                                                        echo.

                                                                                        @REM set /a "width4k=width2k*2"
                                                                                        @REM set /a "height4k=height2k*2"

                                                                                        @REM echo Larghezza Finale Video 2160p =  !width4k! 
                                                                                        @REM echo Altezza Finale Video 2160p =  !height4k!    
                                                                                        @REM echo.
                                                                                    ) 

goto cropmanuale_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR

:finecropNVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR



rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


:InserimentoImpostazioniQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR


echo.
echo !t40!
echo.
echo 1) CQP 
echo 2) ICQ 
echo 3) LA-ICQ 
echo 4) VBR 
echo.
CHOICE /N /C:1234 /M "!t64!"

if errorlevel 4 goto CodificaVBRQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
if errorlevel 3 goto CodificaLAICQQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
if errorlevel 2 goto CodificaICQQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR 
if errorlevel 1 goto CodificaCQPQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR


:CodificaCQPQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "TipoCodificaQSVEnc=--cqp "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVCEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR

:CodificaICQQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "TipoCodificaQSVEnc=--icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVCEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR

:CodificaLAICQQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "TipoCodificaQSVEnc=--la-icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVCEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR

:CodificaVBRQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "TipoCodificaQSVEnc=--vbr "
set /a "quantizzazioneQSVEnc=0"
goto inserimentoValoriCQPVBRQSVCEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR


:inserimentoValoriCQPVBRQSVCEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR

if !quantizzazioneQSVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneQSVEnc=!t44! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneQSVEnc!") do set var=!valoreQuantizzazioneQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                goto inserimentoValoriCQPVBRQSVCEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
                                                ) 

                                set /a "valoreQuantizzazioneQSVEnc=!valoreQuantizzazioneQSVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneQSVEnc!
                                if !valoreQuantizzazioneQSVEnc! GEQ 10 if !valoreQuantizzazioneQSVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneQSVEnc!
                                                                                                                set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreQuantizzazioneQSVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                                goto fineQuantizzazioneQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRQSVCEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
                                                                                                                        
                                )



if !quantizzazioneQSVEnc!==0 (
                                echo.
                                set /p "valoreBitRateQSVEnc=!t46! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateQSVEnc!") do set var=!valoreBitRateQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                goto inserimentoValoriCQPVBRQSVCEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
                                                ) 
                                set /a "valoreBitRateQSVEnc=!valoreBitRateQSVEnc!"
                                @REM echo valoreBitRateQSVEnc = !valoreBitRateQSVEnc!
                                if !valoreBitRateQSVEnc! GEQ 100 if !valoreBitRateQSVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateQSVEnc!
                                                                                                        set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreBitRateQSVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                        goto fineQuantizzazioneQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRQSVCEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
                                                                                                              
                                )


:fineQuantizzazioneQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR


echo.
echo !t50!
echo.
echo 1) Best 
echo 2) Higher 
echo 3) High 
echo 4) Balanced 
echo 5) Fast 
echo 6) Faster 
echo 7) Fastest 
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto QualitFastestQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
if errorlevel 6 goto QualitFasterQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
if errorlevel 5 goto QualitFastQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
if errorlevel 4 goto QualitBalancedtQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
if errorlevel 3 goto QualitHighQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
if errorlevel 2 goto QualitHigherQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
if errorlevel 1 goto QualitBestQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR


:QualitBestQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "SettaggioQualitaQSvenc=--quality best"
set "QualitySetting=best"
goto fineQualitCodificaQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR

:QualitHigherQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "SettaggioQualitaQSvenc=--quality higher"
set "QualitySetting=higher"
goto fineQualitCodificaQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR

:QualitHighQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "SettaggioQualitaQSvenc=--quality high"
set "QualitySetting=high"
goto fineQualitCodificaQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR

:QualitBalancedtQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "SettaggioQualitaQSvenc=--quality balanced"
set "QualitySetting=balanced"
goto fineQualitCodificaQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR

:QualitFastQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "SettaggioQualitaQSvenc=--quality fast"
set "QualitySetting=fast"
goto fineQualitCodificaQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR

:QualitFasterQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "SettaggioQualitaQSvenc=--quality faster"
set "QualitySetting=faster"
goto fineQualitCodificaQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR

:QualitFastestQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "SettaggioQualitaQSvenc=--quality fastest"
set "QualitySetting=fastest"
goto fineQualitCodificaQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR


:fineQualitCodificaQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaQSvenc!



set conv3d1080p=
set pmd1080p=

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t55!"
    if errorlevel 2 goto conv3dChoosenNoQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
    if errorlevel 1 goto conv3dChoosenYesQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
)
echo.
CHOICE /N /C:SN /M "!t55!"

if errorlevel 2 goto conv3dChoosenNoQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
if errorlevel 1 goto conv3dChoosenYesQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR

:conv3dChoosenNoQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "conv3d1080p=N"
goto sceltaDeniserPMDQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR

:conv3dChoosenYesQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "conv3d1080p=S"



:sceltaDeniserPMDQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t56!"
    if errorlevel 2 goto PMDChoosenNoQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
    if errorlevel 1 goto PMDChoosenYesQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
)
echo.
CHOICE /N /C:SN /M "!t56!"

if errorlevel 2 goto PMDChoosenNoQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
if errorlevel 1 goto PMDChoosenYesQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR

:PMDChoosenNoQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "pmd1080p=N"
goto assegnazioneDenoisesQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR

:PMDChoosenYesQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "pmd1080p=S"


:assegnazioneDenoisesQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
set /A nvdenv=0

if !conv3d1080p!==S if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00 --vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )
if !conv3d1080p!==S if !pmd1080p!==N ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )
if !conv3d1080p!==N if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )
if !conv3d1080p!==N if !pmd1080p!==N ( 
                                        set "nvdenoiser=" 
                                        set "nvdenv=1"
                                        set "unicopassaggio=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: Nessun Denoiser 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )

@REM pause

echo.

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t57!"
    if errorlevel 2 goto ApplicaMiglioramentoDettagliQSVEncNo_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
    if errorlevel 1 goto ApplicaMiglioramentoDettagliQSVEncSi_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
)
CHOICE /N /C:SN /M "!t57!"

if errorlevel 2 goto ApplicaMiglioramentoDettagliQSVEncNo_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
if errorlevel 1 goto ApplicaMiglioramentoDettagliQSVEncSi_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR

:ApplicaMiglioramentoDettagliQSVEncNo_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "miglioramento1080p=N"
goto fineSceltaMigliaramentiQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR

:ApplicaMiglioramentoDettagliQSVEncSi_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "miglioramento1080p=S"

:fineSceltaMigliaramentiQSVEnc_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR
if !miglioramento1080p!==S ( 
                                set "edgeleveling=--vpp-edgelevel strength=10.0,threshold=24.0,black=6,white=0" 
                                echo.
                                echo QSVEnc !t58!
                                echo.
                                )
if !miglioramento1080p!==N ( 
                                set "edgeleveling=" 
                                echo.
                                echo QSVEnc !t59!
                                echo.
                                )


@REM pause



echo.
echo !t71!
echo.


set file_senza_virgolette=%NomeFile:"=%
rem echo %file_senza_virgolette%

set file_senza_estensione=%file_senza_virgolette:.mkv=%
rem echo %file_senza_estensione%

set fileoutput2160p="%file_senza_estensione%_DownGraded_!def!_8_bit_SDR.mkv"
rem echo fileoutput2160p = %fileoutput2160p%



set fileoutput2160p_senza_virgolette=%fileoutput2160p:"=% 
rem echo %fileoutput2160p_senza_virgolette%

for %%i in ("%fileoutput2160p_senza_virgolette%") do (  
                                                        set "solo_nome_file=%%~ni"
                                                        rem echo Nome file: !solo_nome_file!

                                                        set "solo_estensione_file=%%~xi"
                                                        rem echo Estensione: !solo_estensione_file!
                                                    )

set fileoutput2160p_rinominato=!solo_nome_file!_rinominato!solo_estensione_file!
rem echo %fileoutput2160p_rinominato%

if exist "Temp_HDR10_Stream.txt" ( del Temp_HDR10_Stream.txt )
if exist "durata_film.txt" ( del durata_film.txt )
if exist "crop.txt" ( del crop.txt )
if exist "risultato_multiplo.txt" ( del risultato_multiplo.txt )
if exist "crop_multiplo.txt" ( del crop_multiplo.txt )
if exist "crop_finale.txt" ( del crop_finale.txt )


".\bin\qsvencc\QSVEncC64.exe" --avhw --device auto -i %NomeFile%  --output-res !width2k!x!height2k! !cropff! --output-depth 8 --video-metadata clear --metadata clear --chapter-copy -c hevc !tipoQuantizzazioneQSVEnc!  !SettaggioQualitaQSVEnc! --la-depth 32  --level auto --chromaloc auto --colorrange auto --colormatrix  bt709 --transfer bt709 --colorprim bt709   --avsync cfr   --vpp-resize algo=lanczos4  !nvdenoiser!  !edgeleveling!  --log-level info --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off  --log ".\codifica_hardware_out_log.txt" -o %fileoutput2160p%


rem ".\bin\qsvencc\QSVEncC64.exe" --avsw --device auto -i !NomeFiletocrop!  --output-res !width4k!x!height4k!  !nvcrop! --video-metadata clear --metadata clear --chapter-copy -c hevc !tipoQuantizzazioneQSVEnc! !SettaggioQualitaQSvenc! --la-depth 32 --level auto --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display "G(13250,34500)B(7500,3000)R(34000,16000)WP(15635,16450)L(10000000,1)" --max-cll "1000,400"  --output-depth 10   --avsync cfr  --psnr --ssim     -m default_mode:infer_no_subs    !QSVEncColorCorrectionSystem!   --vpp-resize algo=lanczos4  !edgeleveling!  --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o !fileoutput2160pdetailed2!

ren %fileoutput2160p% "%fileoutput2160p_rinominato%"

echo.
echo !t72!
echo.

goto fineinfovideo_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR


rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



:novideofile2160p_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
echo !t63!
echo.


:fineinfovideo_QSVEncDownGrade1080p10bitSDRto1080p8bitSDR

if exist ".\saved\settings.dat" (
                                for /f "tokens=1,2 delims=|" %%a in (.\saved\settings.dat) do (
                                                                                                    rem echo %%a
                                                                                                    rem echo %%b
                                                                                                    set /a "shst=%%b"
                                                                                                    rem echo !shst!
                                                                                                    rem pause
                                                                                                    if !shst!==1 (
                                                                                                                echo !t1000!
                                                                                                                echo.
                                                                                                                shutdown /s
                                                                                                                set /a "delay=10"
                                                                                                                timeout /t !delay!
                                                                                                                exit
                                                                                                                )
                                                                                                                            
                                                                                                    )                                                                                                  
                                                                                                )

if exist ".\temp\Temp_HDR10_Stream.txt" ( del .\temp\Temp_HDR10_Stream.txt )
if exist ".\temp\durata_film.txt" ( del .\temp\durata_film.txt )
if exist ".\temp\crop.txt" ( del .\temp\crop.txt )
if exist ".\temp\risultato_multiplo.txt" ( del .\temp\risultato_multiplo.txt )
if exist ".\temp\crop_multiplo.txt" ( del .\temp\crop_multiplo.txt )
if exist ".\temp\crop_finale.txt" ( del .\temp\crop_finale.txt )
      




set waitenter=
set /P waitenter=!t65!
Endlocal
goto menuiniziale











rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

cls
setLocal EnableExtensions EnableDelayedExpansion


for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoQSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
)

if %lingua%==inglese (
    goto caricalinguaingleseQSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
)



:caricalinguaingleseQSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
@REM set t1=Insert Hardware Video Encoding Info DownGrading and DownScaling from 2160p 10 bit HDR to  1080p 8 bit SDR and Saving to Disk

set t2=Drag Here the Video File 2160p 10 bit HDR to Convert to  1080p 8 bit SDR:  
@REM set t211=Video File 2160p 10 bit HDR to Convert to  1080p 8 bit SDR:  

set t3=File does not exist 
set t4=Info Video:  
set t5=The Inserted Video is 2160p 10bit HDR 
set t6=The Inserted Video isn't 2160p 10bit HDR 
set t7=Video Duration in seconds:
set t8=Video Duration in Minutes:
set t9=Interval between Frames for Crop Detection:
set t10= seconds
set t11=Black Bands Detection Started....
set t12=Crop Detection to Frame
set t13=to seconds
set t14=Done...
set t15=Original 2160p Video Width: 
set t16=Original 2160p Video Height:
set t17=Output Video 2160p Width Without Black Bars:
set t18=Outout Video 2160p Height Without Black Bars:

set t171=Output Video 1080p Width Without Black Bars:
set t181=Outout Video 1080p Height Without Black Bars:

set t19=Adapting Video Resolution to Full 1080p Format...
set t20=Final 1080p Output Video Width:
set t21=Final 1080p Output Video Height:
set t22=Settings of Black Bands to Crop are Correct (Yes/No):
set t23=Manually Entering Black Band Values to Crop... 
set t24=Enter the Upper Black Band Value: 
set t25=Error Entering Upper Black Band Value... It's Not a Number. 
set t26=Enter the Lower Black Band Value: 
set t27=Error Entering Lower Black Band Value... It's Not a Number.
set t28=Enter the Left Black Band Value: 
set t29=Error Entering Left Black Band Value... It's Not a Number.
set t30=Enter the Right Black Band Value: 
set t31=Error Entering Right Black Band Value... It's Not a Number.
set t32=Upper Black Band:
set t33=Lower Black Band:
set t34=Left Black Band:
set t35=Right Black Band:
set t36=2160p Video Width without Black Bars:
set t37=2160p Video Height without Black Bars

set t361=1080p Video Width without Black Bars:
set t371=1080p Video Height without Black Bars

set t38=Select Graphic Card you want to Encode with:
set t39=Choose (1/2):
set t40=Select Encoding Type:
set t41=Error Entering Quantization Value... Not a Number. 
set t42=Quantization Value Set to:
set t43=Encoding Settings:
set t44=Enter Quantization value Minimum 10 Maximum 28:
set t45=Quantization Value Out of  Limits  10 / 28  Re-enter^!
set t46=Enter BitRate Value kbs Minimum 100 Maximum 50000:
set t47=Error Entering BitRate Value... It's Not a Number. 
set t48=BitRate Value Set to:
set t49=BitRate Value Out of Limits  100 / 50000  Re-enter^!
set t50=Select Encoding Quality:
set t51=- Worst Quality
set t52=- Best Quality
set t53=Choose (1/2/3/4/5/6/7):
set t54=Quality Set to:
set t55=Apply Convolution3D denoiser Yes/No: 
set t56=Apply PMD denoiser Yes/No: 
set t57=Apply Detail Enhancement Yes/No:  
set t58=Enhancement Detail: Yes 
set t59=Enhancement Detail: No 
set t60=Info
set t61=Videos to Encode Saved!
set t62=Do You Want to Insert Another Video to Encode (Yes/No):
set t63=The dragged file is not a video!
set t64=Choose (1/2/3/4):
set t65=Press Enter to back to Main Menu.  

set t66=Video Width
set t67=Video Height
set t68=Video Codec
set t69=Details Video Codec
set t70=Video Format 
set t71=Configuration Settings to convert video from 10bit HDR to 8bit SDR
set t72=Select Encoding DownGrader:
set t73=Settings DownGrader:

set t74=DownScaling and DownGrading Started.... 
set t75=Encoding Finished...
set t1000=Now the PC will be turned off... 

goto avvio_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR




:caricalinguaitalianoQSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
@REM set t1=Inserimento Info Codifica Hardware Video DownGrading e DownScalingda 2160p 10 bit HDR a 1080p 8 bit SDR e Salvataggio su Disco.

set t2=Trascina Qui il File Video 2160p 10 bit HDR da Convertire in  1080p 8 bit SDR:  
@REM set t211=File Video 2160p 10 bit HDR da Convertire in  1080p 8 bit SDR:  

set t3=File Inesistente 
set t4=Informazioni Video:  
set t5=Il Video inserito e' 2160p 10bit HDR 
set t6=Il Video inserito non e' 2160p 10bit HDR 
set t7=Durata del Video in secondi:
set t8=Durata del video in Minuti:
set t9=Intervallo tra i Fotogrammi per il Rilevamento del crop:
set t10= secondi
set t11=Rilevamento Bande Nere Iniziato....
set t12=Rilevazione crop fotogramma
set t13=a secondi
set t14=Eseguita...
set t15=Larghezza Video 2160p Originale:
set t16=Altezza Video 2160p Originale:
set t17=Larghezza Video 2160p  Senza Barre Nere:
set t18=Altezza Video 2160p  Senza Barre Nere:

set t171=Larghezza Video 1080p  Senza Barre Nere:
set t181=Altezza Video 1080p  Senza Barre Nere:

set t19=Adattamento della Risoluzione del Video al Pieno Formato 1080p..
set t20=Larghezza Finale Video 1080p:
set t21=Altezza Finale Video 1080p:
set t22=Le Impostazioni delle Bande Nere da Tagliare sono Corrette (Si/No):
set t23=Inserimento Manuale Valori Bande Nere da Tagliare.. 
set t24=Inserisci il Valore della Banda Nera Superiore: 
set t25=Errore nell'Inserimento del Valore della Banda Nera Superiore... Non e' un Numero. 
set t26=Inserisci il Valore della Banda Nera Inferiore: 
set t27=Errore nell'Inserimento del Valore della Banda Nera Inferiore... Non e' un Numero. 
set t28=Inserisci il Valore della Banda Nera Sinistra: 
set t29=Errore nell'Inserimento del Valore della Banda Nera Sinistra... Non e' un Numero. 
set t30=Inserisci il Valore della Banda Nera Destra: 
set t31=Errore nell'Inserimento del Valore della Banda Nera Destra... Non e' un Numero. 
set t32=Banda Nera Superiore:
set t33=Banda Nera Inferiore:
set t34=Banda Nera Sinistra:
set t35=Banda Nera Destra:
set t36=Larghezza Video 2160p senza Bande Nere:
set t37=Altezza Video 2160p senza Bande Nere:

set t361=Larghezza Video 1080p senza Bande Nere:
set t371=Altezza Video 1080p senza Bande Nere:

set t38=Selezionare Scheda Grafica con cui Eseguire la Codifica:
set t39=Scegli (1/2):
set t40=Selezionare tipo di Codifica:
set t41=Errore nell'Inserimento del Valore della Quantizzazione... Non e' un Numero. 
set t42=Valore Quantizzazzione Impostato a:
set t43=Parametri per codifica:

set t44=Inserire Valore Quantizzazione Minimo 10 Massimo 28:
set t45=Valore Quantizzazzione al di fuori dei  Limiti  10 / 28  Reinserire^!
set t46=Inserire Valore BitRate kbs Minimo 100 Massimo 50000:
set t47=Errore nell'Inserimento del Valore del BitRate... Non e' un Numero. 
set t48=Valore BitRate Impostato a:
set t49=Valore  BitRate al di fuori dei  Limiti  100 / 50000  Reinserire^!

set t50=Selezionare Qualita' Codifica:
set t51=- Peggiore Qualita'
set t52=- Migliore Qualita'
set t53=Scegli (1/2/3/4/5/6/7):
set t54=Qualita' Impostata su:
set t55=Applicare il denoiser Convolution3D Si/No: 
set t56=Applicare il denoiser PMD Si/No: 
set t57=Applicare il Miglioramento Dettagli Si/No:  
set t58=Miglioramento Dettagli: Si 
set t59=Miglioramento Dettagli: No 
set t60=Informazioni
set t61=Video da Codificare Salvate!
set t62=Vuoi Inserire un altro Video da Codificare (Si/No):
set t63=Il file trascinato non e' un video!
set t64=Scegli (1/2/3/4):
set t65=Premi Invio per tornare al Menu Principale. 

set t66=Larghezza Video
set t67=Altezza Video
set t68=Codec Video
set t69=Codec Video Dettagli
set t70=Format Video 
set t71=Configurazione Parametri per convertire il video da 10bit HDR a 8bit SDR
set t72=Selezionare DownGrader Codifica:
set t73=DownGrader Impostato:

set t74=DownScaling e DownGrading Iniziato.... 
set t75=Codifica Terminata...
set t1000=Il PC ora verra' Spento... 

goto avvio_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:avvio_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR



set /a "numeromovie=1"


:altrivideodainserireNVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR


set NomeFile2160ppuliziadettaggli=
rem set MetadatiStreamHDR10=

set /P NomeFile2160ppuliziadettaggli=!t2!
rem echo Hai digitato: %NomeFile%
rem pause

set "NomeFileSorgente=!NomeFile2160ppuliziadettaggli:"=!"
@REM echo NomeFileSorgente = !NomeFileSorgente!
set "NomeFile=^"!NomeFileSorgente!^""
@REM echo NomeFile = !NomeFile!
@REM pause


if exist %NomeFile% ( goto infovideo_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR ) else ( 
                                                        echo.
                                                        echo !t3!
                                                        echo.
                                                        goto fineinfovideo_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
                                                        )    



:infovideo_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
echo.
echo !t4!
echo.

.\bin\ffprobe -v error -hide_banner -select_streams v:0 -show_entries stream=width,height,codec_name,codec_long_name,pix_fmt,color_space,color_transfer,color_primaries -of default=noprint_wrappers=1 !NomeFile! > ".\temp\Temp_HDR10_Stream.txt"

set /A x1=1
set /A nohdrcs=0
set /A nohdrct=0
set /A nohdrcp=0
set /A wv=0
set /a hv=0
set /A fv=0

rem echo nohdr = %nohdr%

for /f "tokens=1,2 delims==" %%a in (.\temp\Temp_HDR10_Stream.txt) do (if !x1!==3 ( 
                                                                            echo !t66! "%%a" = %%b  
                                                                            set /A "widthvideo=%%b"
                                                                            @REM echo widthvideo = !widthvideo!
                                                                            if !widthvideo! LEQ 3840 if !widthvideo! GEQ 2000 (set /A "wv=1"
                                                                                                                                @REM echo wv = !wv!
                                                                                                                                )
                                                                            )
                                                                if !x1!==4 ( 
                                                                            echo !t67! "%%a" = %%b  
                                                                            set /A "heightvideo=%%b"
                                                                            @REM echo heightvideo = !heightvideo!
                                                                            if !heightvideo! LEQ 2160 if !heightvideo! GEQ 1400 (set /A "hv=1"
                                                                                                                                @REM echo hv = !hv!
                                                                                                                                )
                                                                            )                                                           
                                                                if !x1!==6 ( 
                                                                            echo Color Space "%%a" = %%b  
                                                                            set "colorsp=%%b"
                                                                            @REM echo colorsp = !colorsp!
                                                                            if !colorsp!==bt2020nc (set /A "nohdrcs=1"
                                                                                                    @REM echo nohdrcs = !nohdrcs!
                                                                                                    )
                                                                            if !colorsp!==unknown (set /A "nohdrcs=1"
                                                                                                    @REM echo nohdrcs = !nohdrcs!
                                                                                                    )
                                                                            if !colorsp!==reserved (set /A "nohdrcs=1"
                                                                                                    @REM echo nohdrcs = !nohdrcs!
                                                                                                    )                    
                                                                            ) 
                                                                if !x1!==7 ( 
                                                                            echo Color Transfer "%%a" = %%b  
                                                                            set "colortr=%%b"
                                                                            @REM echo colortr = !colortr!
                                                                            if !colortr!==smpte2084 (set /A "nohdrct=1"
                                                                                                    @REM echo nohdrct = !nohdrct!
                                                                                                    )
                                                                            ) 
                                                                if !x1!==8 ( 
                                                                            echo Color Primaries "%%a" = %%b  
                                                                            set "colorpr=%%b"
                                                                            @REM echo colorpr = !colorpr!
                                                                            if !colorpr!==bt2020 (set /A "nohdrcp=1"
                                                                                                    @REM echo nohdrcp = !nohdrcp!
                                                                                                    )           
                                                                            )    
                                                                if !x1!==1 ( 
                                                                            echo !t68! "%%a" = %%b  
                                                                            )       
                                                                if !x1!==2 ( 
                                                                            echo !t69! "%%a" = %%b  
                                                                            )   
                                                                if !x1!==5 ( 
                                                                            echo !t70! "%%a" = %%b  
                                                                            set "formatvideo=%%b"
                                                                            @REM echo formatvideo = !formatvideo!
                                                                            if !formatvideo!==yuv420p10le (set /A "fv=1"
                                                                                                            @REM echo fv = !fv!
                                                                                                            )
                                                                            )
                                                                set /A x1+=1                                                            
)
echo.

if !x1!==1 goto :novideofile2160p_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR


if !nohdrcs!==1 if !nohdrct!==1 if !nohdrcp!==1 if !wv!==1 if !hv!==1 if !fv!==1 ( 
                                                                                   echo !t5!
                                                                                   goto RilevazioneBandeNere_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR                                                                    
                                                                                   ) 


echo !t6!
echo.
goto fineinfovideo_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

echo.

:RilevazioneBandeNere_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR  


.\bin\ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 !NomeFile!  > ".\temp\durata_film.txt"

set /a contatore=1
for /f "tokens=1 delims=." %%a in (.\temp\durata_film.txt) do  (
                                                        echo. 
                                                        echo !t7! %%a
                                                        set /a "secondi=%%a"
                                                        set /a "minuti=!secondi!/60"
                                                        echo !t8! !minuti!
                                                        set /a "intervallo_tagli=!secondi!/11"
                                                        echo !t9! !intervallo_tagli!!t10!
                                                        echo.
                                                        echo !t11!
                                                        echo.

                                                        

                                                        FOR /L %%a IN (1, 1, 10) DO (
                                                                                    rem echo %%a
                                                                                    set /a "secondi=%%a*!intervallo_tagli!"
                                                                                    rem echo !secondi!

                                                                                    
                                                                                    set /a "ca=72"
                                                                                    rem echo !ca!
                                                                                                                    
                                                                                    set /a "cb=2"
                                                                                    rem echo !cb!
                                                                                                                    
                                                                                    set /a "cc=0"
                                                                                    rem echo !cc!

                                                                                    set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                    rem echo !cr!
        
                                                                                
                                                                                    .\bin\ffmpeg -ss !secondi! -hide_banner -nostats -i %NomeFile% -vframes 10 -vf !cr! -f null - 2> ".\temp\crop.txt"
                                                                                    
                                                                                    findstr /r "Parsed_cropdetect_0" .\temp\crop.txt >> .\temp\risultato_multiplo.txt   
                                                                                    
                                                                                    echo !t12! %%a !t13! !secondi! !t14!
                                                                                    
                                                                                    )       
                                                                                       

                                                                                    for /f "tokens=1,2 delims==" %%a in (.\temp\risultato_multiplo.txt) do ( echo %%b >> .\temp\crop_multiplo.txt )
                                                                                    
                                                                                    set /a "maxfrequenza=0"

                                                                                    for /f "delims=" %%a in (.\temp\crop_multiplo.txt) do ( 
                                                                                                                                    set "cropconfront=%%a"
                                                                                                                                    rem echo "!cropconfront!"
                                                                                                                                    
                                                                                                                                    set /a "contatorfrequenza=0"
                                                                                                                                    for /f "delims=" %%b in (.\temp\crop_multiplo.txt) do (
                                                                                                                                                                                    set "dato_da_verificare=%%b"
                                                                                                                                                                                    rem echo cropconfront = "!cropconfront!"
                                                                                                                                                                                    rem echo dato_da_verificare = "!dato_da_verificare!"
                                                                                                                                                                                    if !cropconfront!==!dato_da_verificare! ( set /a "contatorfrequenza+=1")
                                                                                                                                                                                    )
                                                                                                                                    if !maxfrequenza! LSS !contatorfrequenza! ( 
                                                                                                                                                                                set /a "maxfrequenza=!contatorfrequenza!"
                                                                                                                                                                                set "cropd=!cropconfront!"
                                                                                                                                                                                )
                                                                                                                                    

                                                                                                                                    rem if !cropconfront! in (elenco_crop_frequenza.txt) ()
                                                                                                                                    rem echo !cropconfront!:!contatorfrequenza! >> elenco_crop_frequenza.txt

                                                                                                                                    )

                                                                                    rem echo crop piu' frequente = !cropd! con grequenza = !maxfrequenza!
                                                                                    echo !cropd! > .\temp\crop_finale.txt

                                                                                    for /f "tokens=1,2,3,4 delims=:" %%a in (.\temp\crop_finale.txt) do  ( 
                                                                                                                                                    rem set /a "mwidth=%%a"
                                                                                                                                                    rem echo mwidth = !mwidth!

                                                                                                                                                    rem set /a "mheight=%%b"
                                                                                                                                                    rem echo mheight = !mheight!

                                                                                                                                                    rem set /a "mx=%%c"
                                                                                                                                                    rem echo mx = !mx!

                                                                                                                                                    rem set /a "my=%%d"
                                                                                                                                                    rem echo my = !my!

                                                                                                                                                    if !contatore!==1 ( 
                                                                                                                                                                set /a "wmax=%%a" 
                                                                                                                                                                set /a "hmax=%%b"
                                                                                                                                                                set /a "xmin=%%c"
                                                                                                                                                                set /a "ymin=%%d"
                                                                                                                                                                set /a "mwidth=%%a"
                                                                                                                                                                set /a "mheight=%%b"
                                                                                                                                                                set /a "mx=%%c"
                                                                                                                                                                set /a "my=%%d"
                                                                                                                                                                set /a "contatore+=1"
                                                                                                                                                                )
                                                                                                                                                    
                                                                                                                                                    rem if %%b gtr !hmax! if %%c gtr !xmin! if %%d gtr !ymin! 

                                                                                                                                                    if %%a geq !wmax! if %%b geq !hmax! ( 
                                                                                                                                                                        set /a "wmax=%%a" 
                                                                                                                                                                        set /a "hmax=%%b"
                                                                                                                                                                        set /a "xmin=%%c"
                                                                                                                                                                        set /a "ymin=%%d"
                                                                                                                                                                        set /a "mwidth=%%a"
                                                                                                                                                                        set /a "mheight=%%b"
                                                                                                                                                                        set /a "mx=%%c"
                                                                                                                                                                        set /a "my=%%d"
                                                                                                                                                                        )
                                                                                                                                                    )
                                                                                    echo.
                                                                                    set /a "csup=!my!"
                                                                                    rem echo csup = !csup!
                                                                                                                                    
                                                                                    set /a "csin=!mx!"
                                                                                    rem echo csin = !csin!

                                                                                    set /a "cinf=!heightvideo!-!mheight!-!my!"
                                                                                    rem echo movieheightreal = !movieheightreal!
                                                                                    rem echo cinf = !cinf!
                                                                                    set /a "cdes=!widthvideo!-!mwidth!-!mx!"
                                                                                    rem echo cdes = !cdes!

                                                                                    echo !t15! !widthvideo!  
                                                                                    echo !t16! !heightvideo!  
                                                                                    echo.

                                                                                    echo Crop Settings: --crop !csin!,!csup!,!cdes!,!cinf!  
                                                                                    set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"  
                                                                                    echo.  

                                                                                    set /a "height4kcrop=(!heightvideo!-!csup!-!cinf!)/2*2"
                                                                                    set /a "width4kcrop=(!widthvideo!-!csin!-!cdes!)/2*2"

                                                                                    echo !t17! !width4kcrop!  
                                                                                    echo !t18! !height4kcrop!  
                                                                                    echo.

                                                                                    set /a "height1080p=!height4kcrop!/4*2"
                                                                                    set /a "width1080p=!width4kcrop!/4*2"
                                                                                    
                                                                                    echo !t171! !width1080p!  
                                                                                    echo !t181! !height1080p!  
                                                                                    echo.


                                                                                    set /a "larghezza1080pnvenc=1920"
                                                                                    set /a "altezza1080pnvenc=1080"
                                                                                    @REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
                                                                                    @REM echo altezza1080pnvenc = !altezza1080pnvenc!                                    

                                                                                    set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!width1080p!"
                                                                                    set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!height1080p!"
                                                                                    @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
                                                                                    @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

                                                                                    if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                                                                                                        @REM echo dentro il 1o if
                                                                                                                                                                        set /a "width2k=!width1080p!"
                                                                                                                                                                        set /a "height2k=!height1080p!"
                                                                                                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                                                                                                set /a "width2k=!width1080p!"
                                                                                                                                                                                                                                                                set /a "height2k=!height1080p!"
                                                                                                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo width1080p = !width1080p!
                                                                                                                                                                                                                                                                                                                                                        @REM echo height1080p = !height1080p!
                                                                                                                                                                                                                                                                                                                                                        set /a "width2k=!width1080p!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        set /a "height2k=!height1080p!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "width2k=!width1080p!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "height2k=!height1080p!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                                                                                                                set /a "width2k=!width1080p!"
                                                                                                                                                                                                                                                                set /a "height2k=!height1080p!"
                                                                                                                                                                                                                                                                )
                                                                                                                                                                        
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                                                                                                        set /a "width2k=!width1080p!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        set /a "height2k=!height1080p!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.                         

                                                                                        echo !t20!  !width2k! 
                                                                                        echo !t21!  !height2k!    
                                                                                        echo.

                                                                                        @REM set /a "width4k=width2k*2"
                                                                                        @REM set /a "height4k=height2k*2"

                                                                                        @REM echo Larghezza Finale Video 2160p:  !width4k! 
                                                                                        @REM echo Altezza Finale Video 2160p:  !height4k!    
                                                                                        @REM echo.
                                                                                    )

                                                                                    
                                                        )                          

:iniziocropdowngradeDownScale_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set /a "csup=0"
set /a "cinf=0"
set /a "csin=0"
set /a "cdes=0"
set /a "bandasuperiore=0"
set /a "bandainferiore=0"
set /a "bandasinistra=0"
set /a "bandadestra=0"
set /a "differenzialelarghezza1080pnvenc=0"
set /a "differenzialealtezza1080pnvenc=0"
if exist ".\temp\Temp_HDR10_Stream.txt" ( del ".\temp\Temp_HDR10_Stream.txt" ) 
if exist ".\temp\durata_film.txt" ( del ".\temp\durata_film.txt" )
if exist ".\temp\crop.txt" ( del ".\temp\crop.txt" )
if exist ".\temp\risultato_multiplo.txt" ( del ".\temp\risultato_multiplo.txt" )
if exist ".\temp\crop_multiplo.txt" ( del ".\temp\crop_multiplo.txt" )
if exist ".\temp\crop_finale.txt" ( del ".\temp\crop_finale.txt" )

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t22!"   
    if errorlevel 2 goto cropmanualeNVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
    if errorlevel 1 goto finecropNVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
)

CHOICE /N /C:SN /M "!t22!"   

if errorlevel 2 goto cropmanualeNVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if errorlevel 1 goto finecropNVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR


:cropmanualeNVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
echo.
echo !t23!
echo.

:banda_superiore_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set /p "bandasuperiore=!t24!"
SET "var="&for /f "delims=0123456789" %%i in ("!bandasuperiore!") do set var=!bandasuperiore!
if defined var (
                echo.
                echo !t25!
                echo.
                goto banda_superiore_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
                ) else (
                        set /a "csup=!bandasuperiore!/2*2"
                        )

echo.
:banda_inferiore_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set /p "bandainferiore=!t26!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandainferiore!") do set var=!bandainferiore!
if defined var (
                echo.
                echo !t27!
                echo.
                goto banda_inferiore_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
                ) else (
                        set /a "cinf=!bandainferiore!/2*2"
                        )


echo.
:banda_sinistra_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set /p "bandasinistra=!t28!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandasinistra!") do set var=!bandasinistra!
if defined var (
                echo.
                echo !t29!
                echo.
                goto banda_sinistra_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
                ) else (
                        set /a "csin=!bandasinistra!/2*2"
                        )

                        
echo.
:banda_destra_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set /p "bandadestra=!t30!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandadestra!") do set var=!bandadestra!
if defined var (
                echo.
                echo !t31!
                echo.
                goto banda_destra_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
                ) else (
                        set /a "cdes=!bandadestra!/2*2"
                        )


set /a "larghezza1080pnvenc=3840"
set /a "altezza1080pnvenc=2160"
@REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
@REM echo altezza1080pnvenc = !altezza1080pnvenc!                                    

set /a "mwidth=!widthvideo!/2*2"
set /a "mheight=!heightvideo!/2*2"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "mwidthc=!mwidth!-!csin!-!cdes!"
set /a "mheightc=!mheight!-!csup!-!cinf!"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!mwidthc!"
set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!mheightc!"
@REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
@REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

echo.
echo !t32!  !csup! 
echo !t33!  !cinf! 
echo !t34!  !csin! 
echo !t35!  !cdes! 
echo.


set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
echo Crop Settings: !cropff!
echo.

echo !t36!  !mwidthc! 
echo !t37!  !mheightc! 
echo.

set /a "mwidthc1080p=!mwidthc!/2"
set /a "mheightc1080p=!mheightc!/2"

echo !t361!  !mwidthc1080p! 
echo !t371!  !mheightc1080p! 
echo.


if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                        @REM echo dentro il 1o if
                                                                                        set /a "width2k=!mwidthc!"
                                                                                        set /a "height2k=!mheightc!"
                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                set /a "width2k=!mwidthc!"
                                                                                                                                                                                set /a "height2k=!mheightc!"
                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                        set /a "width2k=!mwidthc!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                        set /a "height2k=!mheightc!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                set /a "width2k=!mwidthc!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                set /a "height2k=!mheightc!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                )
                                                                                        if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                        set /a "width2k=!mwidthc!"
                                                                                                                                                                        set /a "height2k=!mheightc!"
                                                                                                                                                                        )
                                                                                                                                                                        
                                                                                        if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                set /a "width2k=!mwidthc!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                set /a "height2k=!mheightc!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.                         

                                                                                        @REM echo Larghezza Finale Video 2160p:  !width2k! 
                                                                                        @REM echo Altezza Finale Video 2160p:  !height2k!    
                                                                                        @REM echo.

                                                                                        set /a "width2k=width2k/4*2"
                                                                                        set /a "height2k=height2k/4*2"

                                                                                        echo !t20!  !width2k! 
                                                                                        echo !t21!  !height2k!    
                                                                                        echo.

                                                                                        @REM set /a "width4k=width2k*2"
                                                                                        @REM set /a "height4k=height2k*2"

                                                                                        @REM echo Larghezza Finale Video 2160p:  !width4k! 
                                                                                        @REM echo Altezza Finale Video 2160p:  !height4k!    
                                                                                        @REM echo.
                                                                                    ) 

goto iniziocropdowngradeDownScale_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:finecropNVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR





rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


:InserimentoImpostazioniQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR


echo.
echo !t40!
echo.
echo 1) CQP 
echo 2) ICQ 
echo 3) LA-ICQ 
echo 4) VBR 
echo.
CHOICE /N /C:1234 /M "!t64!"

if errorlevel 4 goto CodificaVBRQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if errorlevel 3 goto CodificaLAICQQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if errorlevel 2 goto CodificaICQQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if errorlevel 1 goto CodificaCQPQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR


:CodificaCQPQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "TipoCodificaQSVEnc=--cqp "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:CodificaICQQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "TipoCodificaQSVEnc=--icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:CodificaLAICQQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "TipoCodificaQSVEnc=--la-icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:CodificaVBRQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "TipoCodificaQSVEnc=--vbr "
set /a "quantizzazioneQSVEnc=0"
goto inserimentoValoriCQPVBRQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR


:inserimentoValoriCQPVBRQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

if !quantizzazioneQSVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneQSVEnc=!t44! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneQSVEnc!") do set var=!valoreQuantizzazioneQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                goto inserimentoValoriCQPVBRQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
                                                ) 

                                set /a "valoreQuantizzazioneQSVEnc=!valoreQuantizzazioneQSVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneQSVEnc!
                                if !valoreQuantizzazioneQSVEnc! GEQ 10 if !valoreQuantizzazioneQSVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneQSVEnc!
                                                                                                                set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreQuantizzazioneQSVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                                goto fineQuantizzazioneQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
                                                                                                                        
                                )



if !quantizzazioneQSVEnc!==0 (
                                echo.
                                set /p "valoreBitRateQSVEnc=!t46! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateQSVEnc!") do set var=!valoreBitRateQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                goto inserimentoValoriCQPVBRQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
                                                ) 
                                set /a "valoreBitRateQSVEnc=!valoreBitRateQSVEnc!"
                                @REM echo valoreBitRateQSVEnc = !valoreBitRateQSVEnc!
                                if !valoreBitRateQSVEnc! GEQ 100 if !valoreBitRateQSVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateQSVEnc!
                                                                                                        set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreBitRateQSVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                        goto fineQuantizzazioneQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
                                                                                                              
                                )


:fineQuantizzazioneQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR



echo.
echo !t50!
echo.
echo 1) Best 
echo 2) Higher 
echo 3) High 
echo 4) Balanced 
echo 5) Fast 
echo 6) Faster 
echo 7) Fastest 
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto QualitFastestQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if errorlevel 6 goto QualitFasterQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if errorlevel 5 goto QualitFastQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if errorlevel 4 goto QualitBalancedtQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if errorlevel 3 goto QualitHighQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if errorlevel 2 goto QualitHigherQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if errorlevel 1 goto QualitBestQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR


:QualitBestQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "SettaggioQualitaQSvenc=--quality best"
set "QualitySetting=best"
goto fineQualitCodificaQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:QualitHigherQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "SettaggioQualitaQSvenc=--quality higher"
set "QualitySetting=higher"
goto fineQualitCodificaQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:QualitHighQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "SettaggioQualitaQSvenc=--quality high"
set "QualitySetting=high"
goto fineQualitCodificaQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:QualitBalancedtQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "SettaggioQualitaQSvenc=--quality balanced"
set "QualitySetting=balanced"
goto fineQualitCodificaQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:QualitFastQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "SettaggioQualitaQSvenc=--quality fast"
set "QualitySetting=fast"
goto fineQualitCodificaQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:QualitFasterQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "SettaggioQualitaQSvenc=--quality faster"
set "QualitySetting=faster"
goto fineQualitCodificaQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:QualitFastestQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "SettaggioQualitaQSvenc=--quality fastest"
set "QualitySetting=fastest"
goto fineQualitCodificaQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR


:fineQualitCodificaQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaQSvenc!


echo.
echo !t71!
echo !t72!
echo.
echo 1) QSVEnc Color Correction 
echo 2) LibPlacebo Color Correction 

echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto LibPlaceboQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if errorlevel 1 goto QSVEncColorCorrection_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:QSVEncColorCorrection_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "QSVEncColorCorrectionSystem=--vpp-colorspace hdr2sdr=hable,source_peak=1000,ldr_nits=100,a=0.22,b=0.3,c=0.1,d=0.2,e=0.01,f=0.3"
set "QSVEncUpgrader=QSVEnc Color Correction"
goto QSVEncFineSelezioneUpGrader_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:LibPlaceboQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "QSVEncColorCorrectionSystem=--vpp-libplacebo-tonemapping src_csp=dovi,dst_csp=sdr"
set "QSVEncUpgrader=LibPlacebo Color Correction"

:QSVEncFineSelezioneUpGrader_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
echo.
echo !t73! !QSVEncUpgrader!
echo.
echo !t43! !QSVEncColorCorrectionSystem!



:sceltadenoiser
set conv3d1080p=
set pmd1080p=

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t55!"
    if errorlevel 2 goto conv3dChoosenNoQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
    if errorlevel 1 goto conv3dChoosenYesQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
)
echo.
CHOICE /N /C:SN /M "!t55!"

if errorlevel 2 goto conv3dChoosenNoQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if errorlevel 1 goto conv3dChoosenYesQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:conv3dChoosenNoQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "conv3d1080p=N"
goto sceltaDeniserPMDQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:conv3dChoosenYesQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "conv3d1080p=S"



:sceltaDeniserPMDQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t56!"
    if errorlevel 2 goto PMDChoosenNoQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
    if errorlevel 1 goto PMDChoosenYesQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
)
echo.
CHOICE /N /C:SN /M "!t56!"

if errorlevel 2 goto PMDChoosenNoQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if errorlevel 1 goto PMDChoosenYesQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:PMDChoosenNoQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "pmd1080p=N"
goto assegnazioneDenoisesQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:PMDChoosenYesQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "pmd1080p=S"


:assegnazioneDenoisesQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set /A nvdenv=0

if !conv3d1080p!==S if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00 --vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )
if !conv3d1080p!==S if !pmd1080p!==N ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )
if !conv3d1080p!==N if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )
if !conv3d1080p!==N if !pmd1080p!==N ( 
                                        set "nvdenoiser=" 
                                        set "nvdenv=1"
                                        set "unicopassaggio=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: Nessun Denoiser 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )

@REM pause


if %lingua%==inglese (
    echo.
    CHOICE /N /C:YN /M "!t57!"
    if errorlevel 2 goto ApplicaMiglioramentoDettagliQSVEncNo_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
    if errorlevel 1 goto ApplicaMiglioramentoDettagliQSVEncSi_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
)

echo.
CHOICE /N /C:SN /M "!t57!"

if errorlevel 2 goto ApplicaMiglioramentoDettagliQSVEncNo_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if errorlevel 1 goto ApplicaMiglioramentoDettagliQSVEncSi_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:ApplicaMiglioramentoDettagliQSVEncNo_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "miglioramento1080p=N"
goto fineSceltaMigliaramentiQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:ApplicaMiglioramentoDettagliQSVEncSi_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "miglioramento1080p=S"

:fineSceltaMigliaramentiQSVEnc_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if !miglioramento1080p!==S ( 
                                set "edgeleveling=--vpp-edgelevel strength=10.0,threshold=24.0,black=6,white=0" 
                                echo.
                                echo QSVEnc !t58!
                                echo.
                                )
if !miglioramento1080p!==N ( 
                                set "edgeleveling=" 
                                echo.
                                echo QSVEnc !t59!
                                echo.
                                )


@REM pause


echo.
echo !t74!
echo.


set file_senza_virgolette=%NomeFile:"=%
rem echo %file_senza_virgolette%

set file_senza_estensione=%file_senza_virgolette:.mkv=%
rem echo %file_senza_estensione%

set fileoutput2160p="%file_senza_estensione%_DownGraded_DownScaled_1080p_8_bit_SDR.mkv"
rem echo fileoutput2160p = %fileoutput2160p%



set fileoutput2160p_senza_virgolette=%fileoutput2160p:"=% 
rem echo %fileoutput2160p_senza_virgolette%

for %%i in ("%fileoutput2160p_senza_virgolette%") do (  
                                                        set "solo_nome_file=%%~ni"
                                                        rem echo Nome file: !solo_nome_file!

                                                        set "solo_estensione_file=%%~xi"
                                                        rem echo Estensione: !solo_estensione_file!
                                                    )

set fileoutput2160p_rinominato=!solo_nome_file!_rinominato!solo_estensione_file!
rem echo %fileoutput2160p_rinominato%

if exist "Temp_HDR10_Stream.txt" ( del Temp_HDR10_Stream.txt )
if exist "durata_film.txt" ( del durata_film.txt )
if exist "crop.txt" ( del crop.txt )
if exist "risultato_multiplo.txt" ( del risultato_multiplo.txt )
if exist "crop_multiplo.txt" ( del crop_multiplo.txt )
if exist "crop_finale.txt" ( del crop_finale.txt )


".\bin\qsvencc\QSVEncC64.exe" --avhw --device auto -i %NomeFile%  --output-res !width2k!x!height2k! !cropff! --output-depth 8 --video-metadata clear --metadata clear --chapter-copy -c hevc !tipoQuantizzazioneQSVEnc! !SettaggioQualitaQSVEnc! --la-depth 32  --level auto --chromaloc auto --colorrange auto --colormatrix  bt709 --transfer bt709 --colorprim bt709   --avsync cfr !QSVEncColorCorrectionSystem! --vpp-resize algo=lanczos4 !nvdenoiser! !edgeleveling! --log-level info --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off  --log ".\codifica_hardware_out_log.txt" -o %fileoutput2160p%

rem ".\bin\qsvencc\QSVEncC64.exe" --avsw --device auto -i !NomeFiletocrop!  --output-res !width4k!x!height4k!  !nvcrop! --video-metadata clear --metadata clear --chapter-copy -c hevc !tipoQuantizzazioneQSVEnc! !SettaggioQualitaQSvenc! --la-depth 32 --level auto --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display "G(13250,34500)B(7500,3000)R(34000,16000)WP(15635,16450)L(10000000,1)" --max-cll "1000,400"  --output-depth 10   --avsync cfr  --psnr --ssim     -m default_mode:infer_no_subs    !QSVEncColorCorrectionSystem!   --vpp-resize algo=lanczos4  !edgeleveling!  --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o !fileoutput2160pdetailed2!


ren %fileoutput2160p% "%fileoutput2160p_rinominato%"



echo.
echo !t75!
echo.






goto fineinfovideo_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR




:novideofile2160p_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
echo !t63!
echo.


:fineinfovideo_QSVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

if exist ".\saved\settings.dat" (
                                for /f "tokens=1,2 delims=|" %%a in (.\saved\settings.dat) do (
                                                                                                    rem echo %%a
                                                                                                    rem echo %%b
                                                                                                    set /a "shst=%%b"
                                                                                                    rem echo !shst!
                                                                                                    rem pause
                                                                                                    if !shst!==1 (
                                                                                                                echo !t1000!
                                                                                                                echo.
                                                                                                                shutdown /s
                                                                                                                set /a "delay=10"
                                                                                                                timeout /t !delay!
                                                                                                                exit
                                                                                                                )
                                                                                                                            
                                                                                                    )                                                                                                  
                                                                                                )

if exist ".\temp\Temp_HDR10_Stream.txt" ( del .\temp\Temp_HDR10_Stream.txt )
if exist ".\temp\durata_film.txt" ( del .\temp\durata_film.txt )
if exist ".\temp\crop.txt" ( del .\temp\crop.txt )
if exist ".\temp\risultato_multiplo.txt" ( del .\temp\risultato_multiplo.txt )
if exist ".\temp\crop_multiplo.txt" ( del .\temp\crop_multiplo.txt )
if exist ".\temp\crop_finale.txt" ( del .\temp\crop_finale.txt )
      




set waitenter=
set /P waitenter=!t65!
Endlocal
goto menuiniziale











rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:QSVEncDownGrade2160p10bitHDRto2160p8bitSDR

cls
setLocal EnableExtensions EnableDelayedExpansion


for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoQSVEncDownGrade2160p10bitHDRto2160p8bitSDR
)

if %lingua%==inglese (
    goto caricalinguaingleseQSVEncDownGrade2160p10bitHDRto2160p8bitSDR
)



:caricalinguaingleseQSVEncDownGrade2160p10bitHDRto2160p8bitSDR
@REM set t1=Insert Hardware Video Encoding Info DownGrading from 2160p or 1080p 10 bit HDR to 8 bit SDR and Saving to Disk

set t2=Drag Here the Video File 2160p or 1080p 10 bit HDR to Convert to 8 bit SDR:  
@REM set t211=Video File 2160p or 1080p 10 bit HDR to Convert to 8 bit SDR:  

set t3=File does not exist 
set t4=Info Video:  
set t5=The Inserted Video is
set t6=The Inserted Video isn't
set t7=Video Duration in seconds:
set t8=Video Duration in Minutes:
set t9=Interval between Frames for Crop Detection:
set t10= seconds
set t11=Black Bands Detection Started....
set t12=Crop Detection to Frame
set t13=to seconds
set t14=Done...
set t15=Input Video Width 
set t16=Input Video Height
set t17=Output Video Width Without Black Bars
set t18=Outout Video Height Without Black Bars
set t19=Adapting Video Resolution to Full Format
set t20=Final Output Video Width
set t21=Final Output Video Height
set t22=Settings of Black Bands to Crop are Correct (Yes/No):
set t23=Manually Entering Black Band Values to Crop... 
set t24=Enter the Upper Black Band Value: 
set t25=Error Entering Upper Black Band Value... It's Not a Number. 
set t26=Enter the Lower Black Band Value: 
set t27=Error Entering Lower Black Band Value... It's Not a Number.
set t28=Enter the Left Black Band Value: 
set t29=Error Entering Left Black Band Value... It's Not a Number.
set t30=Enter the Right Black Band Value: 
set t31=Error Entering Right Black Band Value... It's Not a Number.
set t32=Upper Black Band:
set t33=Lower Black Band:
set t34=Left Black Band:
set t35=Right Black Band:
set t36=Original Video Width Without Black Bars
set t37=Original Video Height Without Black Bars
set t38=Select Graphic Card you want to Encode with:
set t39=Choose (1/2):
set t40=Select Encoding Type:
set t41=Error Entering Quantization Value... Not a Number. 
set t42=Quantization Value Set to:
set t43=Encoding Settings:
set t44=Enter Quantization value Minimum 10 Maximum 28:
set t45=Quantization Value Out of  Limits  10 / 28  Re-enter^!
set t46=Enter BitRate Value kbs Minimum 100 Maximum 50000:
set t47=Error Entering BitRate Value... It's Not a Number. 
set t48=BitRate Value Set to:
set t49=BitRate Value Out of Limits  100 / 50000  Re-enter^!
set t50=Select Encoding Quality:
set t51=- Worst Quality
set t52=- Best Quality
set t53=Choose (1/2/3/4/5/6/7):
set t54=Quality Set to:
set t55=Apply Convolution3D denoiser Yes/No: 
set t56=Apply PMD denoiser Yes/No: 
set t57=Apply Detail Enhancement Yes/No:  
set t58=Enhancement Detail: Yes 
set t59=Enhancement Detail: No 
set t60=Info
set t61=Videos to Encode Saved!
set t62=Do You Want to Insert Another Video to Encode (Yes/No):
set t63=The dragged file is not a video!
set t64=Choose (1/2/3/4):
set t65=Press Enter to Back to Main Menu.  

set t66=Video Width
set t67=Video Height
set t68=Video Codec
set t69=Details Video Codec
set t70=Video Format 
set t71=Configuration Settings to convert video from 10bit HDR to 8bit SDR
set t72=Select Encoding DownGrader:
set t73=Settings DownGrader:

set t74=DownGrading Started.... 
set t75=Encoding Finished...
set t76=Now the PC will be turned off... 

goto avvio_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR




:caricalinguaitalianoQSVEncDownGrade2160p10bitHDRto2160p8bitSDR
@REM set t1=Inserimento Info Codifica Hardware Video DownGrading da 2160p o 1080p 10 bit HDR a 8 bit SDR e Salvataggio su Disco.

set t2=Trascina Qui il File Video 2160p o 1080p 10 bit HDR da Convertire a 8 bit SDR:  
@REM set t211=File Video 2160p o 1080p 10 bit HDR da Convertire a 8 bit SDR:  

set t3=File Inesistente 
set t4=Informazioni Video:  
set t5=Il Video inserito e'
set t6=Il Video inserito non e'
set t7=Durata del Video in secondi:
set t8=Durata del video in Minuti:
set t9=Intervallo tra i Fotogrammi per il Rilevamento del crop:
set t10= secondi
set t11=Rilevamento Bande Nere Iniziato....
set t12=Rilevazione crop fotogramma
set t13=a secondi
set t14=Eseguita...
set t15=Larghezza Video di Input 
set t16=Altezza Video di Input
set t17=Larghezza Video di Input Senza Barre Nere
set t18=Altezza Video di Input Senza Barre Nere
set t19=Adattamento della Risoluzione del Video al Pieno Formato
set t20=Larghezza Finale Video di Output
set t21=Altezza Finale Video di Output
set t22=Le Impostazioni delle Bande Nere da Tagliare sono Corrette (Si/No):
set t23=Inserimento Manuale Valori Bande Nere da Tagliare.. 
set t24=Inserisci il Valore della Banda Nera Superiore: 
set t25=Errore nell'Inserimento del Valore della Banda Nera Superiore... Non e' un Numero. 
set t26=Inserisci il Valore della Banda Nera Inferiore: 
set t27=Errore nell'Inserimento del Valore della Banda Nera Inferiore... Non e' un Numero. 
set t28=Inserisci il Valore della Banda Nera Sinistra: 
set t29=Errore nell'Inserimento del Valore della Banda Nera Sinistra... Non e' un Numero. 
set t30=Inserisci il Valore della Banda Nera Destra: 
set t31=Errore nell'Inserimento del Valore della Banda Nera Destra... Non e' un Numero. 
set t32=Banda Nera Superiore:
set t33=Banda Nera Inferiore:
set t34=Banda Nera Sinistra:
set t35=Banda Nera Destra:
set t36=Larghezza Video Originale Senza Barre Nere
set t37=Altezza Video Originale Senza Barre Nere
set t38=Selezionare Scheda Grafica con cui Eseguire la Codifica:
set t39=Scegli (1/2):
set t40=Selezionare tipo di Codifica:
set t41=Errore nell'Inserimento del Valore della Quantizzazione... Non e' un Numero. 
set t42=Valore Quantizzazzione Impostato a:
set t43=Parametri per codifica:
set t44=Inserire Valore Quantizzazione Minimo 10 Massimo 28:
set t45=Valore Quantizzazzione al di fuori dei  Limiti  10 / 28  Reinserire^!
set t46=Inserire Valore BitRate kbs Minimo 100 Massimo 50000:
set t47=Errore nell'Inserimento del Valore del BitRate... Non e' un Numero. 
set t48=Valore BitRate Impostato a:
set t49=Valore  BitRate al di fuori dei  Limiti  100 / 50000  Reinserire^!
set t50=Selezionare Qualita' Codifica:
set t51=- Peggiore Qualita'
set t52=- Migliore Qualita'
set t53=Scegli (1/2/3/4/5/6/7):
set t54=Qualita' Impostata su:
set t55=Applicare il denoiser Convolution3D Si/No: 
set t56=Applicare il denoiser PMD Si/No: 
set t57=Applicare il Miglioramento Dettagli Si/No:  
set t58=Miglioramento Dettagli: Si 
set t59=Miglioramento Dettagli: No 
set t60=Informazioni
set t61=Video da Codificare Salvate!
set t62=Vuoi Inserire un altro Video da Codificare (Si/No):
set t63=Il file trascinato non e' un video!
set t64=Scegli (1/2/3/4):
set t65=Premi Invio per tornare al Menu' Principale.  

set t66=Larghezza Video
set t67=Altezza Video
set t68=Codec Video
set t69=Codec Video Dettagli
set t70=Format Video 
set t71=Configurazione Parametri per convertire il video da 10bit HDR a 8bit SDR
set t72=Selezionare DownGrader Codifica:
set t73=DownGrader Impostato:

set t74=DownGrading Iniziato.... 
set t75=Codifica Terminata...
set t76=Il PC ora verra' Spento... 

goto avvio_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR

:avvio_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR

set /a "numeromovie=1"


:altrivideodainserire_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR


set NomeFile2160ppuliziadettaggli=
rem set MetadatiStreamHDR10=

set /P NomeFile2160ppuliziadettaggli=!t2!
rem echo Hai digitato: %NomeFile%
rem pause

set "NomeFileSorgente=!NomeFile2160ppuliziadettaggli:"=!"
@REM echo NomeFileSorgente = !NomeFileSorgente!
set "NomeFile=^"!NomeFileSorgente!^""
@REM echo NomeFile = !NomeFile!
rem pause


if exist %NomeFile% ( goto infovideo_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR ) else ( 
                                                        echo.
                                                        echo !t3!
                                                        echo.
                                                        goto fineinfovideo_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
                                                        )    




:infovideo_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR

echo.
echo !t4!
echo.

.\bin\ffprobe -v error -hide_banner -select_streams v:0 -show_entries stream=width,height,codec_name,codec_long_name,pix_fmt,color_space,color_transfer,color_primaries -of default=noprint_wrappers=1 %NomeFile% > ".\temp\Temp_HDR10_Stream.txt"

set /A x1=1
set /A nohdrcs=0
set /A nohdrct=0
set /A nohdrcp=0
set /A wv=0
set /a hv=0
set /A fv=0
set def=
rem echo nohdr = %nohdr%

for /f "tokens=1,2 delims==" %%a in (.\temp\Temp_HDR10_Stream.txt) do (if !x1!==3 ( 
                                                                            echo !t66! "%%a" = %%b  
                                                                            set /A "widthvideo=%%b"
                                                                            @REM echo widthvideo = !widthvideo!
                                                                            if !widthvideo! LEQ 3840 if !widthvideo! GEQ 2000 (set /A "wv=1"
                                                                                                                                @REM echo wv = !wv!
                                                                                                                                set "def=2160p"
                                                                                                                                )
                                                                            if !widthvideo! LEQ 1920 if !widthvideo! GEQ 1000 (set /A "wv=1"
                                                                                                                                @REM echo wv = !wv!
                                                                                                                                set "def=1080p"
                                                                                                                                )
                                                                            )
                                                                if !x1!==4 ( 
                                                                            echo !t67! "%%a" = %%b  
                                                                            set /A "heightvideo=%%b"
                                                                            @REM echo heightvideo = !heightvideo!
                                                                            if !heightvideo! LEQ 2160 if !heightvideo! GEQ 1400 (set /A "hv=1"
                                                                                                                                @REM echo hv = !hv!
                                                                                                                                )
                                                                            if !heightvideo! LEQ 1080 if !heightvideo! GEQ 700 (set /A "hv=1"
                                                                                                                                @REM echo hv = !hv!
                                                                                                                                )
                                                                            )                                                           
                                                                if !x1!==6 ( 
                                                                            echo Color Space "%%a" = %%b  
                                                                            set "colorsp=%%b"
                                                                            @REM echo colorsp = !colorsp!
                                                                            if !colorsp!==bt2020nc (set /A "nohdrcs=1"
                                                                                                    @REM echo nohdrcs = !nohdrcs!
                                                                                                    )
                                                                            if !colorsp!==unknown (set /A "nohdrcs=1"
                                                                                                    @REM echo nohdrcs = !nohdrcs!
                                                                                                    )
                                                                            if !colorsp!==reserved (set /A "nohdrcs=1"
                                                                                                    @REM echo nohdrcs = !nohdrcs!
                                                                                                    )                    
                                                                            ) 
                                                                if !x1!==7 ( 
                                                                            echo Color Transfer "%%a" = %%b  
                                                                            set "colortr=%%b"
                                                                            @REM echo colortr = !colortr!
                                                                            if !colortr!==smpte2084 (set /A "nohdrct=1"
                                                                                                    @REM echo nohdrct = !nohdrct!
                                                                                                    )
                                                                            ) 
                                                                if !x1!==8 ( 
                                                                            echo Color Primaries "%%a" = %%b  
                                                                            set "colorpr=%%b"
                                                                            @REM echo colorpr = !colorpr!
                                                                            if !colorpr!==bt2020 (set /A "nohdrcp=1"
                                                                                                    @REM echo nohdrcp = !nohdrcp!
                                                                                                    )           
                                                                            )    
                                                                if !x1!==1 ( 
                                                                            echo !t68! "%%a" = %%b  
                                                                            )       
                                                                if !x1!==2 ( 
                                                                            echo !t69! "%%a" = %%b  
                                                                            )   
                                                                if !x1!==5 ( 
                                                                            echo !t70! "%%a" = %%b  
                                                                            set "formatvideo=%%b"
                                                                            @REM echo formatvideo = !formatvideo!
                                                                            if !formatvideo!==yuv420p10le (set /A "fv=1"
                                                                                                            @REM echo fv = !fv!
                                                                                                            )
                                                                            )
                                                                set /A x1+=1                                                            
)
echo.

if !x1!==1 goto :novideofile2160p10080p_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR


if !nohdrcs!==1 if !nohdrct!==1 if !nohdrcp!==1 if !wv!==1 if !hv!==1 if !fv!==1 ( 
                                                                                   echo !t5! !def! 10bit HDR 
                                                                                   goto RilevazioneBandeNere_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR                                                                     
                                                                                   ) 


echo !t6! !def! 10bit HDR 
echo.
goto fineinfovideo_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR

echo


:RilevazioneBandeNere_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR

.\bin\ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 %NomeFile%  > ".\temp\durata_film.txt"

set /a contatore=1
for /f "tokens=1 delims=." %%a in (.\temp\durata_film.txt) do  (
                                                        echo. 
                                                        echo !t7! %%a
                                                        set /a "secondi=%%a"
                                                        set /a "minuti=!secondi!/60"
                                                        echo !t8! !minuti!
                                                        set /a "intervallo_tagli=!secondi!/11"
                                                        echo !t9! !intervallo_tagli!!t10!
                                                        echo.
                                                        echo !t11!
                                                        echo.

                                                        

                                                        FOR /L %%a IN (1, 1, 10) DO (
                                                                                    rem echo %%a
                                                                                    set /a "secondi=%%a*!intervallo_tagli!"
                                                                                    rem echo !secondi!

                                                                                    
                                                                                    set /a "ca=72"
                                                                                    rem echo !ca!
                                                                                                                    
                                                                                    set /a "cb=2"
                                                                                    rem echo !cb!
                                                                                                                    
                                                                                    set /a "cc=0"
                                                                                    rem echo !cc!

                                                                                    set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                    rem echo !cr!
        
                                                                                
                                                                                    .\bin\ffmpeg -ss !secondi! -hide_banner -nostats -i %NomeFile% -vframes 10 -vf !cr! -f null - 2> ".\temp\crop.txt"
                                                                                    
                                                                                    findstr /r "Parsed_cropdetect_0" .\temp\crop.txt >> .\temp\risultato_multiplo.txt   
                                                                                    
                                                                                    echo !t12! %%a !t13! !secondi! !t14!
                                                                                    
                                                                                    )       
                                                                                       

                                                                                    for /f "tokens=1,2 delims==" %%a in (.\temp\risultato_multiplo.txt) do ( echo %%b >> .\temp\crop_multiplo.txt )
                                                                                    
                                                                                    set /a "maxfrequenza=0"

                                                                                    for /f "delims=" %%a in (.\temp\crop_multiplo.txt) do ( 
                                                                                                                                    set "cropconfront=%%a"
                                                                                                                                    rem echo "!cropconfront!"
                                                                                                                                    
                                                                                                                                    set /a "contatorfrequenza=0"
                                                                                                                                    for /f "delims=" %%b in (.\temp\crop_multiplo.txt) do (
                                                                                                                                                                                    set "dato_da_verificare=%%b"
                                                                                                                                                                                    rem echo cropconfront = "!cropconfront!"
                                                                                                                                                                                    rem echo dato_da_verificare = "!dato_da_verificare!"
                                                                                                                                                                                    if !cropconfront!==!dato_da_verificare! ( set /a "contatorfrequenza+=1")
                                                                                                                                                                                    )
                                                                                                                                    if !maxfrequenza! LSS !contatorfrequenza! ( 
                                                                                                                                                                                set /a "maxfrequenza=!contatorfrequenza!"
                                                                                                                                                                                set "cropd=!cropconfront!"
                                                                                                                                                                                )
                                                                                                                                    

                                                                                                                                    rem if !cropconfront! in (elenco_crop_frequenza.txt) ()
                                                                                                                                    rem echo !cropconfront!:!contatorfrequenza! >> elenco_crop_frequenza.txt

                                                                                                                                    )

                                                                                    rem echo crop piu' frequente = !cropd! con grequenza = !maxfrequenza!
                                                                                    echo !cropd! > .\temp\crop_finale.txt

                                                                                    for /f "tokens=1,2,3,4 delims=:" %%a in (.\temp\crop_finale.txt) do  ( 
                                                                                                                                                    rem set /a "mwidth=%%a"
                                                                                                                                                    rem echo mwidth = !mwidth!

                                                                                                                                                    rem set /a "mheight=%%b"
                                                                                                                                                    rem echo mheight = !mheight!

                                                                                                                                                    rem set /a "mx=%%c"
                                                                                                                                                    rem echo mx = !mx!

                                                                                                                                                    rem set /a "my=%%d"
                                                                                                                                                    rem echo my = !my!

                                                                                                                                                    if !contatore!==1 ( 
                                                                                                                                                                set /a "wmax=%%a" 
                                                                                                                                                                set /a "hmax=%%b"
                                                                                                                                                                set /a "xmin=%%c"
                                                                                                                                                                set /a "ymin=%%d"
                                                                                                                                                                set /a "mwidth=%%a"
                                                                                                                                                                set /a "mheight=%%b"
                                                                                                                                                                set /a "mx=%%c"
                                                                                                                                                                set /a "my=%%d"
                                                                                                                                                                set /a "contatore+=1"
                                                                                                                                                                )
                                                                                                                                                    
                                                                                                                                                    rem if %%b gtr !hmax! if %%c gtr !xmin! if %%d gtr !ymin! 

                                                                                                                                                    if %%a geq !wmax! if %%b geq !hmax! ( 
                                                                                                                                                                        set /a "wmax=%%a" 
                                                                                                                                                                        set /a "hmax=%%b"
                                                                                                                                                                        set /a "xmin=%%c"
                                                                                                                                                                        set /a "ymin=%%d"
                                                                                                                                                                        set /a "mwidth=%%a"
                                                                                                                                                                        set /a "mheight=%%b"
                                                                                                                                                                        set /a "mx=%%c"
                                                                                                                                                                        set /a "my=%%d"
                                                                                                                                                                        )
                                                                                                                                                    )
                                                                                    echo.
                                                                                    set /a "csup=!my!"
                                                                                    rem echo csup = !csup!
                                                                                                                                    
                                                                                    set /a "csin=!mx!"
                                                                                    rem echo csin = !csin!

                                                                                    set /a "cinf=!heightvideo!-!mheight!-!my!"
                                                                                    rem echo movieheightreal = !movieheightreal!
                                                                                    rem echo cinf = !cinf!
                                                                                    set /a "cdes=!widthvideo!-!mwidth!-!mx!"
                                                                                    rem echo cdes = !cdes!

                                                                                    echo !t15! !def!: !widthvideo!  
                                                                                    echo !t16! !def!: !heightvideo!  
                                                                                    echo.

                                                                                    echo Crop Settings: --crop !csin!,!csup!,!cdes!,!cinf!  
                                                                                    set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"  
                                                                                    echo.  

                                                                                    set /a "height4kcrop=(!heightvideo!-!csup!-!cinf!)/2*2"
                                                                                    set /a "width4kcrop=(!widthvideo!-!csin!-!cdes!)/2*2"

                                                                                    echo !t17! !def!: !width4kcrop!  
                                                                                    echo !t18! !def!: !height4kcrop!  
                                                                                    echo.

                                                                                    if !def!==1080p (
                                                                                                    set /a "larghezza1080pnvenc=1920"
                                                                                                    set /a "altezza1080pnvenc=1080"
                                                                                                    @REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
                                                                                                    @REM echo altezza1080pnvenc = !altezza1080pnvenc!       
                                                                                                    )               

                                                                                    if !def!==2160p (
                                                                                                    set /a "larghezza1080pnvenc=3840"
                                                                                                    set /a "altezza1080pnvenc=2160"
                                                                                                    @REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
                                                                                                    @REM echo altezza1080pnvenc = !altezza1080pnvenc!       
                                                                                                    )                      

                                                                                    set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!width4kcrop!"
                                                                                    set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!height4kcrop!"
                                                                                    @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
                                                                                    @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

                                                                                    if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                                                                                                        @REM echo dentro il 1o if
                                                                                                                                                                        set /a "width4k=!width4kcrop!"
                                                                                                                                                                        set /a "height4k=!height4kcrop!"
                                                                                                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                                                                                                set /a "width4k=!width4kcrop!"
                                                                                                                                                                                                                                                                set /a "height4k=!height4kcrop!"
                                                                                                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo width4kcrop = !width4kcrop!
                                                                                                                                                                                                                                                                                                                                                        @REM echo height4kcrop = !height4kcrop!
                                                                                                                                                                                                                                                                                                                                                        set /a "width4k=!width4kcrop!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        set /a "height4k=!height4kcrop!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "width4k=!width4kcrop!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "height4k=!height4kcrop!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                                                                                                                set /a "width4k=!width4kcrop!"
                                                                                                                                                                                                                                                                set /a "height4k=!height4kcrop!"
                                                                                                                                                                                                                                                                )
                                                                                                                                                                        
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                                                                                                        set /a "width4k=!width4kcrop!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        set /a "height4k=!height4kcrop!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        )                                                                                        
                                                                                   

                                                                                        echo !t19! !def!..
                                                                                        echo.                         

                                                                                        echo !t20! !def!:  !width4k! 
                                                                                        echo !t21! !def!:  !height4k!    
                                                                                        echo.

                                                                                        @REM set /a "width4k=width2k*2"
                                                                                        @REM set /a "height4k=height2k*2"

                                                                                        @REM echo Larghezza Finale Video 2160p:  !width4k! 
                                                                                        @REM echo Altezza Finale Video 2160p:  !height4k!    
                                                                                        @REM echo.
                                                                                    )  
                                                       )                          

:inizioCropManuale_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR 

set /a "csup=0"
set /a "cinf=0"
set /a "csin=0"
set /a "cdes=0"
set /a "bandasuperiore=0"
set /a "bandainferiore=0"
set /a "bandasinistra=0"
set /a "bandadestra=0"
set /a "differenzialelarghezza1080pnvenc=0"
set /a "differenzialealtezza1080pnvenc=0"
if exist ".\temp\Temp_HDR10_Stream.txt" ( del ".\temp\Temp_HDR10_Stream.txt" ) 
if exist ".\temp\durata_film.txt" ( del ".\temp\durata_film.txt" )
if exist ".\temp\crop.txt" ( del ".\temp\crop.txt" )
if exist ".\temp\risultato_multiplo.txt" ( del ".\temp\risultato_multiplo.txt" )
if exist ".\temp\crop_multiplo.txt" ( del ".\temp\crop_multiplo.txt" )
if exist ".\temp\crop_finale.txt" ( del ".\temp\crop_finale.txt" )

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t22!"   
    if errorlevel 2 goto cropmanualeNVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
    if errorlevel 1 goto finecropmanualeNVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
)
CHOICE /N /C:SN /M "!t22!"   

if errorlevel 2 goto cropmanualeNVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
if errorlevel 1 goto finecropmanualeNVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR


:cropmanualeNVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
echo.
echo !t23!
echo.

:banda_superiore_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
set /p "bandasuperiore=!t24!"
SET "var="&for /f "delims=0123456789" %%i in ("!bandasuperiore!") do set var=!bandasuperiore!
if defined var (
                echo.
                echo !t25!
                echo.
                goto banda_superiore_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
                ) else (
                        set /a "csup=!bandasuperiore!/2*2"
                        )

echo.
:banda_inferiore_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
set /p "bandainferiore=!t26!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandainferiore!") do set var=!bandainferiore!
if defined var (
                echo.
                echo !t27!
                echo.
                goto banda_inferiore_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
                ) else (
                        set /a "cinf=!bandainferiore!/2*2"
                        )


echo.
:banda_sinistra_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
set /p "bandasinistra=!t28!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandasinistra!") do set var=!bandasinistra!
if defined var (
                echo.
                echo !t29!
                echo.
                goto banda_sinistra_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
                ) else (
                        set /a "csin=!bandasinistra!/2*2"
                        )

                        
echo.
:banda_destra_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
set /p "bandadestra=!t30!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandadestra!") do set var=!bandadestra!
if defined var (
                echo.
                echo !t31!
                echo.
                goto banda_destra_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
                ) else (
                        set /a "cdes=!bandadestra!/2*2"
                        )


if !def!==1080p (
                set /a "larghezza1080pnvenc=1920"
                set /a "altezza1080pnvenc=1080"
                @REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
                @REM echo altezza1080pnvenc = !altezza1080pnvenc!       
                )               

if !def!==2160p (
                set /a "larghezza1080pnvenc=3840"
                set /a "altezza1080pnvenc=2160"
                @REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
                @REM echo altezza1080pnvenc = !altezza1080pnvenc!       
                )                                                       

set /a "width4kcrop=!widthvideo!/2*2"
set /a "height4kcrop=!heightvideo!/2*2"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "mwidthc=!width4kcrop!-!csin!-!cdes!"
set /a "mheightc=!height4kcrop!-!csup!-!cinf!"
@REM echo nuovo mwidhtc = !mwidthc!
@REM echo nuovo mheightc = !mheightc!

set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!mwidthc!"
set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!mheightc!"
@REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
@REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

echo.
echo !t32!  !csup! 
echo !t33!  !cinf! 
echo !t34!  !csin! 
echo !t35!  !cdes! 
echo.


set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
echo Crop Settings: !cropff!
echo.

echo !t36! !def!:  !mwidthc! 
echo !t37! !def!:  !mheightc! 
echo.

rem pause

if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                        @REM echo dentro il 1o if
                                                                                        set /a "width4k=!mwidthc!"
                                                                                        set /a "height4k=!mheightc!"
                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                set /a "width4k=!mwidthc!"
                                                                                                                                                                                set /a "height4k=!mheightc!"
                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                        set /a "width4k=!mwidthc!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                        set /a "height4k=!mheightc!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                set /a "width4k=!mwidthc!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                set /a "height4k=!mheightc!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                )
                                                                                        if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                        set /a "width4k=!mwidthc!"
                                                                                                                                                                        set /a "height4k=!mheightc!"
                                                                                                                                                                        )
                                                                                                                                                                        
                                                                                        if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                set /a "width4k=!mwidthc!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                set /a "height4k=!mheightc!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                )                                                                                        
                                                                                   

                                                                                        echo !t19! !def!..
                                                                                        echo.                         

                                                                                        echo !t20! !def!:  !width4k! 
                                                                                        echo !t21! !def!:  !height4k!    
                                                                                        echo.

                                                                                        @REM set /a "width4k=width2k*2"
                                                                                        @REM set /a "height4k=height2k*2"

                                                                                        @REM echo Larghezza Finale Video 2160p:  !width4k! 
                                                                                        @REM echo Altezza Finale Video 2160p:  !height4k!    
                                                                                        @REM echo.
                                                                                    ) 

goto inizioCropManuale_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR

:finecropmanualeNVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR




rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

:InserimentoImpostazioniQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR



echo.
echo !t40!
echo.
echo 1) CQP 
echo 2) ICQ 
echo 3) LA-ICQ 
echo 4) VBR 
echo.
CHOICE /N /C:1234 /M "!t64!"

if errorlevel 4 goto CodificaVBRQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
if errorlevel 3 goto CodificaLAICQQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
if errorlevel 2 goto CodificaICQQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR 
if errorlevel 1 goto CodificaCQPQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR


:CodificaCQPQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "TipoCodificaQSVEnc=--cqp "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR

:CodificaICQQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "TipoCodificaQSVEnc=--icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR

:CodificaLAICQQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "TipoCodificaQSVEnc=--la-icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR

:CodificaVBRQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "TipoCodificaQSVEnc=--vbr "
set /a "quantizzazioneQSVEnc=0"
goto inserimentoValoriCQPVBRQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR


:inserimentoValoriCQPVBRQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR

if !quantizzazioneQSVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneQSVEnc=!t44! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneQSVEnc!") do set var=!valoreQuantizzazioneQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                goto inserimentoValoriCQPVBRQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
                                                ) 

                                set /a "valoreQuantizzazioneQSVEnc=!valoreQuantizzazioneQSVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneQSVEnc!
                                if !valoreQuantizzazioneQSVEnc! GEQ 10 if !valoreQuantizzazioneQSVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneQSVEnc!
                                                                                                                set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreQuantizzazioneQSVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                                goto fineQuantizzazioneQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
                                                                                                                        
                                )



if !quantizzazioneQSVEnc!==0 (
                                echo.
                                set /p "valoreBitRateQSVEnc=!t46! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateQSVEnc!") do set var=!valoreBitRateQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                goto inserimentoValoriCQPVBRQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
                                                ) 
                                set /a "valoreBitRateQSVEnc=!valoreBitRateQSVEnc!"
                                @REM echo valoreBitRateQSVEnc = !valoreBitRateQSVEnc!
                                if !valoreBitRateQSVEnc! GEQ 100 if !valoreBitRateQSVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateQSVEnc!
                                                                                                        set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreBitRateQSVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                        goto fineQuantizzazioneQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
                                                                                                              
                                )


:fineQuantizzazioneQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR




echo.
echo !t50!
echo.
echo 1) Best 
echo 2) Higher 
echo 3) High 
echo 4) Balanced 
echo 5) Fast 
echo 6) Faster 
echo 7) Fastest 
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto QualitFastestQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
if errorlevel 6 goto QualitFasterQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
if errorlevel 5 goto QualitFastQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
if errorlevel 4 goto QualitBalancedtQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
if errorlevel 3 goto QualitHighQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
if errorlevel 2 goto QualitHigherQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
if errorlevel 1 goto QualitBestQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR


:QualitBestQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "SettaggioQualitaQSvenc=--quality best"
set "QualitySetting=best"
goto fineQualitCodificaQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR

:QualitHigherQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "SettaggioQualitaQSvenc=--quality higher"
set "QualitySetting=higher"
goto fineQualitCodificaQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR

:QualitHighQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "SettaggioQualitaQSvenc=--quality high"
set "QualitySetting=high"
goto fineQualitCodificaQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR

:QualitBalancedtQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "SettaggioQualitaQSvenc=--quality balanced"
set "QualitySetting=balanced"
goto fineQualitCodificaQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR

:QualitFastQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "SettaggioQualitaQSvenc=--quality fast"
set "QualitySetting=fast"
goto fineQualitCodificaQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR

:QualitFasterQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "SettaggioQualitaQSvenc=--quality faster"
set "QualitySetting=faster"
goto fineQualitCodificaQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR

:QualitFastestQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "SettaggioQualitaQSvenc=--quality fastest"
set "QualitySetting=fastest"
goto fineQualitCodificaQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR


:fineQualitCodificaQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaQSvenc!


echo.
echo !t71!
echo !t72!
echo.
echo 1) QSVEnc Color Correction 
echo 2) LibPlacebo Color Correction 

echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto LibPlaceboColorCorrectionQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
if errorlevel 1 goto QSVEncColorCorrection_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR


:QSVEncColorCorrection_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "QSVEncColorCorrectionSystem=--vpp-colorspace hdr2sdr=hable,source_peak=1000,ldr_nits=100,a=0.22,b=0.3,c=0.1,d=0.2,e=0.01,f=0.3"
set "QSVEncUpgrader=QSVEnc Color Correction"
goto QSVEncFineSelezione_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR

:LibPlaceboColorCorrectionQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "QSVEncColorCorrectionSystem=--vpp-libplacebo-tonemapping src_csp=dovi,dst_csp=sdr"
set "QSVEncUpgrader=LibPlacebo Color Correction"


:QSVEncFineSelezione_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
echo.
echo !t73! !QSVEncUpgrader!
echo.
echo !t43! !QSVEncColorCorrectionSystem!



:sceltadenoiserQSVEnc
set conv3d1080p=
set pmd1080p=

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t55!"
    if errorlevel 2 goto conv3dChoosenNoQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
    if errorlevel 1 goto conv3dChoosenYesQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
)
echo.
CHOICE /N /C:SN /M "!t55!"

if errorlevel 2 goto conv3dChoosenNoQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
if errorlevel 1 goto conv3dChoosenYesQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR

:conv3dChoosenNoQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "conv3d1080p=N"
goto sceltaDeniserPMDQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR

:conv3dChoosenYesQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "conv3d1080p=S"



:sceltaDeniserPMDQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t56!"
    if errorlevel 2 goto PMDChoosenNoQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
    if errorlevel 1 goto PMDChoosenYesQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
)
echo.
CHOICE /N /C:SN /M "!t56!"

if errorlevel 2 goto PMDChoosenNoQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
if errorlevel 1 goto PMDChoosenYesQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR

:PMDChoosenNoQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "pmd1080p=N"
goto assegnazioneDenoisesQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR

:PMDChoosenYesQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "pmd1080p=S"


:assegnazioneDenoisesQSVEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
set /A nvdenv=0

if !conv3d1080p!==S if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00 --vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )
if !conv3d1080p!==S if !pmd1080p!==N ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )
if !conv3d1080p!==N if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )
if !conv3d1080p!==N if !pmd1080p!==N ( 
                                        set "nvdenoiser=" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: Nessun Denoiser 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )

@REM pause


if %lingua%==inglese (
    echo.
    CHOICE /N /C:YN /M "!t57!"
    if errorlevel 2 goto ApplicaMiglioramentoDettagliQSVEncNo_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
    if errorlevel 1 goto ApplicaMiglioramentoDettagliQSVEncSi_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
)
echo.
CHOICE /N /C:SN /M "!t57!"

if errorlevel 2 goto ApplicaMiglioramentoDettagliQSVEncNo_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
if errorlevel 1 goto ApplicaMiglioramentoDettagliQSVEncSi_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR

:ApplicaMiglioramentoDettagliQSVEncNo_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "miglioramento1080p=N"
goto fineSceltaMigliaramentiQSCEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR

:ApplicaMiglioramentoDettagliQSVEncSi_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "miglioramento1080p=S"

:fineSceltaMigliaramentiQSCEnc_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
if !miglioramento1080p!==S ( 
                                set "edgeleveling=--vpp-edgelevel strength=10.0,threshold=24.0,black=6,white=0" 
                                echo.
                                echo QSVEnc !t58!
                                echo.
                                )
if !miglioramento1080p!==N ( 
                                set "edgeleveling=" 
                                echo.
                                echo QSVEnc !t59!
                                echo.
                                )


@REM pause




echo.
echo !t74!
echo.


set file_senza_virgolette=%NomeFile:"=%
rem echo %file_senza_virgolette%

set file_senza_estensione=%file_senza_virgolette:.mkv=%
rem echo %file_senza_estensione%

set fileoutput2160p="%file_senza_estensione%_DownGraded_!def!_8_bit_SDR.mkv"
rem echo fileoutput2160p = %fileoutput2160p%



set fileoutput2160p_senza_virgolette=%fileoutput2160p:"=% 
rem echo %fileoutput2160p_senza_virgolette%

for %%i in ("%fileoutput2160p_senza_virgolette%") do (  
                                                        set "solo_nome_file=%%~ni"
                                                        rem echo Nome file: !solo_nome_file!

                                                        set "solo_estensione_file=%%~xi"
                                                        rem echo Estensione: !solo_estensione_file!
                                                    )

set fileoutput2160p_rinominato=!solo_nome_file!_rinominato!solo_estensione_file!
rem echo %fileoutput2160p_rinominato%

if exist "Temp_HDR10_Stream.txt" ( del Temp_HDR10_Stream.txt )
if exist "durata_film.txt" ( del durata_film.txt )
if exist "crop.txt" ( del crop.txt )
if exist "risultato_multiplo.txt" ( del risultato_multiplo.txt )
if exist "crop_multiplo.txt" ( del crop_multiplo.txt )
if exist "crop_finale.txt" ( del crop_finale.txt )

".\bin\qsvencc\QSVEncC64.exe" --avhw --device auto -i %NomeFile%  --output-res !width4k!x!height4k! !cropff! --output-depth 8 --video-metadata clear --metadata clear --chapter-copy -c hevc !tipoQuantizzazioneQSVEnc! !SettaggioQualitaQSVEnc! --la-depth 32 --level auto --chromaloc auto --colorrange auto --colormatrix  bt709 --transfer bt709 --colorprim bt709   --avsync cfr  !QSVEncColorCorrectionSystem!  !nvdenoiser! --vpp-resize algo=lanczos4  !edgeleveling! --psnr --ssim  -m default_mode:infer_no_subs  --log-level info --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off  --log ".\codifica_hardware_out_log.txt" -o %fileoutput2160p%


ren %fileoutput2160p% "%fileoutput2160p_rinominato%"



echo.
echo !t75!
echo.



goto fineinfovideo_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR



:novideofile2160p10080p_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR
echo !t63!
echo.




:fineinfovideo_QSVEncDownGrade2160p10bitHDRto2160p8bitSDR


if exist ".\saved\settings.dat" (
                                for /f "tokens=1,2 delims=|" %%a in (.\saved\settings.dat) do (
                                                                                                    rem echo %%a
                                                                                                    rem echo %%b
                                                                                                    set /a "shst=%%b"
                                                                                                    rem echo !shst!
                                                                                                    rem pause
                                                                                                    if !shst!==1 (
                                                                                                                echo !t76!
                                                                                                                echo.
                                                                                                                shutdown /s
                                                                                                                set /a "delay=10"
                                                                                                                timeout /t !delay!
                                                                                                                exit
                                                                                                                )
                                                                                                                            
                                                                                                    )                                                                                                  
                                                                                                )


if exist ".\temp\Temp_HDR10_Stream.txt" ( del .\temp\Temp_HDR10_Stream.txt )
if exist ".\temp\durata_film.txt" ( del .\temp\durata_film.txt )
if exist ".\temp\crop.txt" ( del .\temp\crop.txt )
if exist ".\temp\risultato_multiplo.txt" ( del .\temp\risultato_multiplo.txt )
if exist ".\temp\crop_multiplo.txt" ( del .\temp\crop_multiplo.txt )
if exist ".\temp\crop_finale.txt" ( del .\temp\crop_finale.txt )
      




set waitenter=
set /P waitenter=!t65!
Endlocal
goto menuiniziale











rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:QSVEncUpScaling1080p10bitHDR

cls
setLocal EnableExtensions EnableDelayedExpansion



for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoQSVEncUpScaling1080p10bitHDR
)

if %lingua%==inglese (
    goto caricalinguaingleseQSVEncUpScaling1080p10bitHDR
)



:caricalinguaingleseQSVEncUpScaling1080p10bitHDR
@REM set t1=Insert Hardware Video Encoding Info UpScaling from 1080p 10 bit HDR to 2160p 10 bit HDR and Saving to Disk

set t2=Drag Here the Video File 1080p 10 bit HDR to Convert to 2160p 10 bit HDR:  
@REM set t211=Video File 1080p 10 bit HDR to Convert to 2160p 10 bit HDR:  

set t3=File does not exist 
set t4=Info Video:  

set t5=The Inserted Video is 1080p 10bit HDR 
@REM set t511=The Inserted Video is 2160p 10bit SDR 

set t6=The Inserted Video isn't 1080p 10bit HDR 
set t7=Video Duration in seconds:
set t8=Video Duration in Minutes:
set t9=Interval between Frames for Crop Detection:
set t10= seconds
set t11=Black Bands Detection Started....
set t12=Crop Detection to Frame
set t13=to seconds
set t14=Done...
set t15=Original 2160p Video Width: 
set t16=Original 2160p Video Height:
set t17=Original Video 1080p Width Without Black Bars:
set t18=Original Video 1080p Height Without Black Bars:

set t171=Output Video 1080p Width Without Black Bars:
set t181=Outout Video 1080p Height Without Black Bars:

set t19=Adapting Video Resolution to Full 1080p Format...

set t191=Final 1080p Output Video Width:
set t192=Final 1080p Output Video Height:
set t20=Final 2160p Output Video Width:
set t21=Final 2160p Output Video Height:

set t22=Settings of Black Bands to Crop are Correct (Yes/No):
set t23=Manually Entering Black Band Values to Crop... 
set t24=Enter the Upper Black Band Value: 
set t25=Error Entering Upper Black Band Value... It's Not a Number. 
set t26=Enter the Lower Black Band Value: 
set t27=Error Entering Lower Black Band Value... It's Not a Number.
set t28=Enter the Left Black Band Value: 
set t29=Error Entering Left Black Band Value... It's Not a Number.
set t30=Enter the Right Black Band Value: 
set t31=Error Entering Right Black Band Value... It's Not a Number.
set t32=Upper Black Band:
set t33=Lower Black Band:
set t34=Left Black Band:
set t35=Right Black Band:
set t36=2160p Original Video Width without Black Bars:
set t37=2160p Original Video Height without Black Bars:

@REM set t361=1080p Video Width without Black Bars:
@REM set t371=1080p Video Height without Black Bars

set t38=Select Graphic Card you want to Encode with:
set t39=Choose (1/2):
set t40=Select Encoding Type:
set t41=Error Entering Quantization Value... Not a Number. 
set t42=Quantization Value Set to:
set t43=Encoding Settings:
set t44=Enter Quantization value Minimum 10 Maximum 28:
set t45=Quantization Value Out of  Limits  10 / 28  Re-enter^!
set t46=Enter BitRate Value kbs Minimum 100 Maximum 50000:
set t47=Error Entering BitRate Value... It's Not a Number. 
set t48=BitRate Value Set to:
set t49=BitRate Value Out of Limits  100 / 50000  Re-enter^!
set t50=Select Encoding Quality:
set t51=- Worst Quality
set t52=- Best Quality
set t53=Choose (1/2/3/4/5/6/7):
set t54=Quality Set to:
set t55=Apply Convolution3D denoiser Yes/No: 
set t56=Apply PMD denoiser Yes/No: 
set t57=Apply Detail Enhancement Yes/No:  
set t58=Enhancement Detail: Yes 
set t59=Enhancement Detail: No 
set t60=Info
set t61=Videos to Encode Saved!
set t62=Do You Want to Insert Another Video to Encode (Yes/No):
set t63=The dragged file is not a video!
set t64=Choose (1/2/3/4):
set t65=Press Enter to Back to Main Menu.  

set t66=Video Width
set t67=Video Height
set t68=Video Codec
set t69=Details Video Codec
set t70=Video Format 
set t71=Configuration Settings to convert video from 8bit or 10bit SDR to 10bit HDR
set t72=Select Encoding UpGrader:
set t73=Settings UpGrader:
set t74=Choose (1/2/3):

set t75=Configuration UpScaling from 1080p 10 bit HDR to 2160p 10 bit HDR 
set t76=Select Operations to Perform:
set t77=1) First Pass Encode for Upscaling and a Second Pass Encode to Clean Up the Video and Enhance Details
set t78=2) Cleanup, Detail Enhancement and Upscaling in a Single Encode

set t79=UpScaling Started.... 
set t80=Denoiser and Detail Enhancement Application Started.... 
set t81=Encoding Finished...
set t82=Now the PC will be turned off... 


goto avvio_QSVEncUpScaling1080p10bitHDR




:caricalinguaitalianoQSVEncUpScaling1080p10bitHDR
@REM set t1=Inserimento Info Codifica Hardware Video UpScaling da 1080p 10 bit HDR a 2160p 10 bit HDR e Salvataggio su Disco.

set t2=Trascina Qui il File Video 1080p 10 bit HDR da Convertire in 2160p 10 bit HDR:  
@REM set t211=File Video 1080p 10 bit HDR da Convertire in 2160p 10 bit HDR:  

set t3=File Inesistente 
set t4=Informazioni Video:  

set t5=Il Video inserito e' 1080p 10bit HDR 
@REM set t511=Il Video inserito e' 2160p 10bit SDR 

set t6=Il Video inserito non e' 1080p 10bit HDR 

set t7=Durata del Video in secondi:
set t8=Durata del video in Minuti:
set t9=Intervallo tra i Fotogrammi per il Rilevamento del crop:
set t10= secondi
set t11=Rilevamento Bande Nere Iniziato....
set t12=Rilevazione crop fotogramma
set t13=a secondi
set t14=Eseguita...
set t15=Larghezza Video 2160p Originale:
set t16=Altezza Video 2160p Originale:
set t17=Larghezza Video Originale 1080p  Senza Barre Nere:
set t18=Altezza Video Originale 1080p  Senza Barre Nere:

set t171=Larghezza Video 1080p  Senza Barre Nere:
set t181=Altezza Video 1080p  Senza Barre Nere:

set t19=Adattamento della Risoluzione del Video al Pieno Formato 1080p..

set t191=Larghezza Finale Video 1080p:
set t192=Altezza Finale Video 1080p:
set t20=Larghezza Finale Video 2160p:
set t21=Altezza Finale Video 2160p:

set t22=Le Impostazioni delle Bande Nere da Tagliare sono Corrette (Si/No):
set t23=Inserimento Manuale Valori Bande Nere da Tagliare.. 
set t24=Inserisci il Valore della Banda Nera Superiore: 
set t25=Errore nell'Inserimento del Valore della Banda Nera Superiore... Non e' un Numero. 
set t26=Inserisci il Valore della Banda Nera Inferiore: 
set t27=Errore nell'Inserimento del Valore della Banda Nera Inferiore... Non e' un Numero. 
set t28=Inserisci il Valore della Banda Nera Sinistra: 
set t29=Errore nell'Inserimento del Valore della Banda Nera Sinistra... Non e' un Numero. 
set t30=Inserisci il Valore della Banda Nera Destra: 
set t31=Errore nell'Inserimento del Valore della Banda Nera Destra... Non e' un Numero. 
set t32=Banda Nera Superiore:
set t33=Banda Nera Inferiore:
set t34=Banda Nera Sinistra:
set t35=Banda Nera Destra:
set t36=Larghezza Video Originale 2160p senza Bande Nere:
set t37=Altezza Video Originale 2160p senza Bande Nere:

@REM set t361=Larghezza Video 1080p senza Bande Nere:
@REM set t371=Altezza Video 1080p senza Bande Nere:

set t38=Selezionare Scheda Grafica con cui Eseguire la Codifica:
set t39=Scegli (1/2):
set t40=Selezionare tipo di Codifica:
set t41=Errore nell'Inserimento del Valore della Quantizzazione... Non e' un Numero. 
set t42=Valore Quantizzazzione Impostato a:
set t43=Parametri per codifica:

set t44=Inserire Valore Quantizzazione Minimo 10 Massimo 28:
set t45=Valore Quantizzazzione al di fuori dei  Limiti  10 / 28  Reinserire^!
set t46=Inserire Valore BitRate kbs Minimo 100 Massimo 50000:
set t47=Errore nell'Inserimento del Valore del BitRate... Non e' un Numero. 
set t48=Valore BitRate Impostato a:
set t49=Valore  BitRate al di fuori dei  Limiti  100 / 50000  Reinserire^!

set t50=Selezionare Qualita' Codifica:
set t51=- Peggiore Qualita'
set t52=- Migliore Qualita'
set t53=Scegli (1/2/3/4/5/6/7):
set t54=Qualita' Impostata su:
set t55=Applicare il denoiser Convolution3D Si/No: 
set t56=Applicare il denoiser PMD Si/No: 
set t57=Applicare il Miglioramento Dettagli Si/No:  
set t58=Miglioramento Dettagli: Si 
set t59=Miglioramento Dettagli: No 
set t60=Informazioni
set t61=Video da Codificare Salvate!
set t62=Vuoi Inserire un altro Video da Codificare (Si/No):
set t63=Il file trascinato non e' un video!
set t64=Scegli (1/2/3/4):
set t65=Premi Invio per tornare al Menu' Principale.  

set t66=Larghezza Video
set t67=Altezza Video
set t68=Codec Video
set t69=Codec Video Dettagli
set t70=Format Video 
set t71=Configurazione Parametri per convertire il video da 8bit o 10bit SDR a 10bit HDR
set t72=Selezionare UpGrader Codifica:
set t73=UpGrader Impostato:
set t74=Scegli (1/2/3):

set t75=Configurazione Operazione di UpScaling da 1080p 10 bit HDR a 2160p 10 bit HDR 
set t76=Selezionare Operazioni da Eseguire:
set t77=1) Fare Prima Codifica per UpScaling e Seconda Codifica per Ripulire il Video e Migliorare i Dettagli
set t78=2) Ripulire, Migliorare i Dettagli e Upscaling in un Unica Codifica 

set t79=UpScaling Iniziato.... 
set t80=Applicazione Denoiser e Miglioramento Dettagli Iniziato.... 
set t81=Codifica Terminata...
set t82=Il PC ora verra' Spento... 

goto avvio_QSVEncUpScaling1080p10bitHDR

:avvio_QSVEncUpScaling1080p10bitHDR




set /a "numeromovie=1"


:altrivideodainserire_QSVEncUpScaling1080p10bitHDR


set NomeFile2160ppuliziadettaggli=
rem set MetadatiStreamHDR10=

set /P NomeFile2160ppuliziadettaggli=!t2! 
rem echo Hai digitato: %NomeFile%
rem pause

set "NomeFileSorgente=!NomeFile2160ppuliziadettaggli:"=!"
@REM echo NomeFileSorgente = !NomeFileSorgente!
set "NomeFile=^"!NomeFileSorgente!^""
@REM echo NomeFile = !NomeFile!
rem pause


if exist !NomeFile! ( goto infovideo_QSVEncUpScaling1080p10bitHDR ) else ( 
                                                        echo.
                                                        echo !t3!
                                                        echo.
                                                        goto fineinfovideo_QSVEncUpScaling1080p10bitHDR
                                                        )    

:infovideo_QSVEncUpScaling1080p10bitHDR
echo.
echo !t4!
echo.

.\bin\ffprobe -v error -hide_banner -select_streams v:0 -show_entries stream=width,height,codec_name,codec_long_name,pix_fmt,color_space,color_transfer,color_primaries -of default=noprint_wrappers=1 !NomeFile! > ".\temp\Temp_HDR10_Stream.txt"

set /A x1=1
set /A nohdrcs=0
set /A nohdrct=0
set /A nohdrcp=0
set /A wv=0
set /a hv=0
set /A fv=0

rem echo nohdr = %nohdr%

for /f "tokens=1,2 delims==" %%a in (.\temp\Temp_HDR10_Stream.txt) do (if !x1!==3 ( 
                                                                            echo !t66! "%%a" = %%b  
                                                                            set /A "widthvideo=%%b"
                                                                            rem echo widthvideo = !widthvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !widthvideo! LEQ 1920 if !widthvideo! GEQ 1000 (set /A "wv=1"
                                                                                                                                rem echo wv = !wv!
                                                                                                                                )
                                                                            )
                                                                if !x1!==4 ( 
                                                                            echo !t67! "%%a" = %%b  
                                                                            set /A "heightvideo=%%b"
                                                                            rem echo heightvideo = !heightvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !heightvideo! LEQ 1080 if !heightvideo! GEQ 700 (set /A "hv=1"
                                                                                                        rem echo hv = !hv!
                                                                                                        )
                                                                            )                                                           
                                                                if !x1!==6 ( 
                                                                            echo Color Space "%%a" = %%b  
                                                                            set "colorsp=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colorsp!==bt2020nc (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorsp!==unknown (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorsp!==reserved (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                    
                                                                            ) 
                                                                if !x1!==7 ( 
                                                                            echo Color Transfer "%%a" = %%b  
                                                                            set "colortr=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colortr!==smpte2084 (set /A "nohdrct=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                 
                                                                            ) 
                                                                if !x1!==8 ( 
                                                                            echo Color Primaries "%%a" = %%b  
                                                                            set "colorpr=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colorpr!==bt2020 (set /A "nohdrcp=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            )    
                                                                if !x1!==1 ( 
                                                                            echo !t68! "%%a" = %%b  
                                                                            )       
                                                                if !x1!==2 ( 
                                                                            echo !t69! "%%a" = %%b  
                                                                            )   
                                                                if !x1!==5 ( 
                                                                            echo !t70! "%%a" = %%b  
                                                                            set "formatvideo=%%b"
                                                                            rem echo formatvideo = !formatvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !formatvideo!==yuv420p10le (set /A "fv=1"
                                                                                                        rem echo fv = !fv!
                                                                                                        )
                                                                            )
                                                                set /A x1+=1                                                            
)
echo.

if !x1!==1 goto :novideofile1080p_QSVEncUpScaling1080p10bitHDR


if !nohdrcs!==1 if !nohdrct!==1 if !nohdrcp!==1 if !wv!==1 if !hv!==1 if !fv!==1 ( 
                                                                                   echo !t5!
                                                                                   goto rilevazionebandenere_QSVEncUpScaling1080p10bitHDR
                                                                                   ) 


echo !t6!
echo.
goto fineinfovideo_QSVEncUpScaling1080p10bitHDR



:rilevazionebandenere_QSVEncUpScaling1080p10bitHDR

.\bin\ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 %NomeFile%  > ".\temp\durata_film.txt"


set /a contatore=1
for /f "tokens=1 delims=." %%a in (.\temp\durata_film.txt) do  (
                                                        echo. 
                                                        echo !t7! %%a
                                                        set /a "secondi=%%a"
                                                        set /a "minuti=!secondi!/60"
                                                        echo !t8! !minuti!
                                                        set /a "intervallo_tagli=!secondi!/11"
                                                        echo !t9! !intervallo_tagli!!t10!
                                                        echo.
                                                        echo !t11!
                                                        echo.

                                                        

                                                        FOR /L %%a IN (1, 1, 10) DO (
                                                                                    rem echo %%a
                                                                                    set /a "secondi=%%a*!intervallo_tagli!"
                                                                                    rem echo !secondi!

                                                                                    
                                                                                    set /a "ca=72"
                                                                                    rem echo !ca!
                                                                                                                    
                                                                                    set /a "cb=2"
                                                                                    rem echo !cb!
                                                                                                                    
                                                                                    set /a "cc=0"
                                                                                    rem echo !cc!

                                                                                    set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                    rem echo !cr!

                                                                                    .\bin\ffmpeg -ss !secondi! -hide_banner -nostats -i %NomeFile% -vframes 10 -vf !cr! -f null - 2> ".\temp\crop.txt"
                                                                                    
                                                                                    findstr /r "Parsed_cropdetect_0" .\temp\crop.txt >> .\temp\risultato_multiplo.txt   
                                                                                    
                                                                                    echo !t12! %%a !t13! !secondi! !t14!
                                                                                    
                                                                                    )       
                                                                                       

                                                                                    for /f "tokens=1,2 delims==" %%a in (.\temp\risultato_multiplo.txt) do ( echo %%b >> .\temp\crop_multiplo.txt )
                                                                                    
                                                                                    set /a "maxfrequenza=0"

                                                                                    for /f "delims=" %%a in (.\temp\crop_multiplo.txt) do ( 
                                                                                                                                    set "cropconfront=%%a"
                                                                                                                                    rem echo "!cropconfront!"
                                                                                                                                    
                                                                                                                                    set /a "contatorfrequenza=0"
                                                                                                                                    for /f "delims=" %%b in (.\temp\crop_multiplo.txt) do (
                                                                                                                                                                                    set "dato_da_verificare=%%b"
                                                                                                                                                                                    rem echo cropconfront = "!cropconfront!"
                                                                                                                                                                                    rem echo dato_da_verificare = "!dato_da_verificare!"
                                                                                                                                                                                    if !cropconfront!==!dato_da_verificare! ( set /a "contatorfrequenza+=1")
                                                                                                                                                                                    )
                                                                                                                                    if !maxfrequenza! LSS !contatorfrequenza! ( 
                                                                                                                                                                                set /a "maxfrequenza=!!contatorfrequenza!!"
                                                                                                                                                                                set "cropd=!cropconfront!"
                                                                                                                                                                                )
                                                                                                                                    

                                                                                                                                    rem if !cropconfront! in (elenco_crop_frequenza.txt) ()
                                                                                                                                    rem echo !cropconfront!:!contatorfrequenza! >> elenco_crop_frequenza.txt

                                                                                                                                    )

                                                                                    rem echo crop piu' frequente = !cropd! con grequenza = !maxfrequenza!
                                                                                    echo !cropd! > .\temp\crop_finale.txt

                                                                                    for /f "tokens=1,2,3,4 delims=:" %%a in (.\temp\crop_finale.txt) do  ( 
                                                                                                                                                    rem set /a "mwidth=%%a"
                                                                                                                                                    rem echo mwidth = !mwidth!

                                                                                                                                                    rem set /a "mheight=%%b"
                                                                                                                                                    rem echo mheight = !mheight!

                                                                                                                                                    rem set /a "mx=%%c"
                                                                                                                                                    rem echo mx = !mx!

                                                                                                                                                    rem set /a "my=%%d"
                                                                                                                                                    rem echo my = !my!

                                                                                                                                                    if !contatore!==1 ( 
                                                                                                                                                                set /a "wmax=%%a" 
                                                                                                                                                                set /a "hmax=%%b"
                                                                                                                                                                set /a "xmin=%%c"
                                                                                                                                                                set /a "ymin=%%d"
                                                                                                                                                                set /a "mwidth=%%a"
                                                                                                                                                                set /a "mheight=%%b"
                                                                                                                                                                set /a "mx=%%c"
                                                                                                                                                                set /a "my=%%d"
                                                                                                                                                                set /a "contatore+=1"
                                                                                                                                                                )
                                                                                                                                                    
                                                                                                                                                    rem if %%b gtr !hmax! if %%c gtr !xmin! if %%d gtr !ymin! 

                                                                                                                                                    if %%a geq !wmax! if %%b geq !hmax! ( 
                                                                                                                                                                        set /a "wmax=%%a" 
                                                                                                                                                                        set /a "hmax=%%b"
                                                                                                                                                                        set /a "xmin=%%c"
                                                                                                                                                                        set /a "ymin=%%d"
                                                                                                                                                                        set /a "mwidth=%%a"
                                                                                                                                                                        set /a "mheight=%%b"
                                                                                                                                                                        set /a "mx=%%c"
                                                                                                                                                                        set /a "my=%%d"
                                                                                                                                                                        )
                                                                                                                                                    )
                                                                                    echo.
                                                                                    
                                                                                    set /a "mwidth=!mwidth!/2*2"
                                                                                    set /a "mheight=!mheight!/2*2"

                                                                                    set /a "csup=!my!/2*2"
                                                                                    rem echo csup = !csup!
                                                                                                                                    
                                                                                    set /a "csin=!mx!/2*2"
                                                                                    rem echo csin = !csin!

                                                                                    set /a "cinf=(!heightvideo!-!mheight!-!my!)/2*2"
                                                                                    rem echo movieheightreal = !movieheightreal!
                                                                                    rem echo cinf = !cinf!
                                                                                    set /a "cdes=(!widthvideo!-!mwidth!-!mx!)/2*2"
                                                                                    rem echo cdes = !cdes!

                                                                                    echo Crop Settings: --crop !csin!,!csup!,!cdes!,!cinf!    
                                                                                    set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
                                                                                    echo.  
                                                                                    
                                                                                    echo !t17!  !mwidth! 
                                                                                    echo !t18!  !mheight! 
                                                                                    echo.

                                                                                    set /a "larghezza1080pnvenc=1920"
                                                                                    set /a "altezza1080pnvenc=1080"
                                                                                    @REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
                                                                                    @REM echo altezza1080pnvenc = !altezza1080pnvenc!                                    

                                                                                    set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!mwidth!"
                                                                                    set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!mheight!"
                                                                                    @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
                                                                                    @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

                                                                                    if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                                                                                                        @REM echo dentro il 1o if
                                                                                                                                                                        set /a "width2k=!mwidth!"
                                                                                                                                                                        set /a "height2k=!mheight!"
                                                                                                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                                                                                                set /a "width2k=!mwidth!"
                                                                                                                                                                                                                                                                set /a "height2k=!mheight!"
                                                                                                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                                                                                                        set /a "width2k=!mwidth!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        set /a "height2k=!mheight!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "width2k=!mwidth!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "height2k=!mheight!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                                                                                                                set /a "width2k=!mwidth!"
                                                                                                                                                                                                                                                                set /a "height2k=!mheight!"
                                                                                                                                                                                                                                                                )
                                                                                                                                                                        
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                                                                                                        set /a "width2k=!mwidth!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        set /a "height2k=!mheight!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.                         

                                                                                        echo !t191!  !width2k! 
                                                                                        echo !t192!  !height2k!    
                                                                                        echo.

                                                                                        set /a "width4k=width2k*2"
                                                                                        set /a "height4k=height2k*2"

                                                                                        echo !t20!  !width4k! 
                                                                                        echo !t21!  !height4k!    
                                                                                        echo.
                                                                                    )  
                                                        )                          
                                                  

:cropmanuale_QSVEncUpScaling1080p10bitHDR
set /a "csup=0"
set /a "cinf=0"
set /a "csin=0"
set /a "cdes=0"
set /a "bandasuperiore=0"
set /a "bandainferiore=0"
set /a "bandasinistra=0"
set /a "bandadestra=0"
set /a "differenzialelarghezza1080pnvenc=0"
set /a "differenzialealtezza1080pnvenc=0"
if exist ".\temp\Temp_HDR10_Stream.txt" ( del ".\temp\Temp_HDR10_Stream.txt" ) 
if exist ".\temp\durata_film.txt" ( del ".\temp\durata_film.txt" )
if exist ".\temp\crop.txt" ( del ".\temp\crop.txt" )
if exist ".\temp\risultato_multiplo.txt" ( del ".\temp\risultato_multiplo.txt" )
if exist ".\temp\crop_multiplo.txt" ( del ".\temp\crop_multiplo.txt" )
if exist ".\temp\crop_finale.txt" ( del ".\temp\crop_finale.txt" )

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t22!"   
    if errorlevel 2 goto cropmanualeinsval_QSVEncUpScaling1080p10bitHDR
    if errorlevel 1 goto finecropmanuale_QSVEncUpScaling1080p10bitHDR
)

CHOICE /N /C:SN /M "!t22!"   

if errorlevel 2 goto cropmanualeinsval_QSVEncUpScaling1080p10bitHDR
if errorlevel 1 goto finecropmanuale_QSVEncUpScaling1080p10bitHDR


:cropmanualeinsval_QSVEncUpScaling1080p10bitHDR
echo.
echo !t23!
echo.

:banda_superiore_QSVEncUpScaling1080p10bitHDR
set /p "bandasuperiore=!t24!"
SET "var="&for /f "delims=0123456789" %%i in ("!bandasuperiore!") do set var=!bandasuperiore!
if defined var (
                echo.
                echo !t25!
                echo.
                goto banda_superiore_QSVEncUpScaling1080p10bitHDR
                ) else (
                        set /a "csup=!bandasuperiore!/2*2"
                        )

echo.
:banda_inferiore_QSVEncUpScaling1080p10bitHDR
set /p "bandainferiore=!t26!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandainferiore!") do set var=!bandainferiore!
if defined var (
                echo.
                echo !t27!
                echo.
                goto banda_inferiore_QSVEncUpScaling1080p10bitHDR
                ) else (
                        set /a "cinf=!bandainferiore!/2*2"
                        )


echo.
:banda_sinistra_QSVEncUpScaling1080p10bitHDR
set /p "bandasinistra=!t28!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandasinistra!") do set var=!bandasinistra!
if defined var (
                echo.
                echo !t29!
                echo.
                goto banda_sinistra_QSVEncUpScaling1080p10bitHDR
                ) else (
                        set /a "csin=!bandasinistra!/2*2"
                        )

                        
echo.
:banda_destra__QSVEncUpScaling1080p10bitHDR
set /p "bandadestra=!t30!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandadestra!") do set var=!bandadestra!
if defined var (
                echo.
                echo !t31!
                echo.
                goto banda_destra__QSVEncUpScaling1080p10bitHDR
                ) else (
                        set /a "cdes=!bandadestra!/2*2"
                        )


set /a "larghezza1080pnvenc=1920"
set /a "altezza1080pnvenc=1080"
@REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
@REM echo altezza1080pnvenc = !altezza1080pnvenc!                                    

set /a "mwidth=!mwidth!/2*2"
set /a "mheight=!mheight!/2*2"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "mwidthc=!mwidth!-!csin!-!cdes!"
set /a "mheightc=!mheight!-!csup!-!cinf!"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!mwidthc!"
set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!mheightc!"
@REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
@REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

echo.
echo !t32!  !csup! 
echo !t33!  !cinf! 
echo !t34!  !csin! 
echo !t35!  !cdes! 
echo.


set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
echo Crop Settings: !cropff!
echo.

echo !t17!  !mwidthc! 
echo !t18!  !mheightc! 
echo.



if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                        @REM echo dentro il 1o if
                                                                                        set /a "width2k=!mwidthc!"
                                                                                        set /a "height2k=!mheightc!"
                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                set /a "width2k=!mwidthc!"
                                                                                                                                                                                set /a "height2k=!mheightc!"
                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                        set /a "width2k=!mwidthc!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                        set /a "height2k=!mheightc!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                set /a "width2k=!mwidthc!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                set /a "height2k=!mheightc!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                )
                                                                                        if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                        set /a "width2k=!mwidthc!"
                                                                                                                                                                        set /a "height2k=!mheightc!"
                                                                                                                                                                        )
                                                                                                                                                                        
                                                                                        if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                set /a "width2k=!mwidthc!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                set /a "height2k=!mheightc!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.                         

                                                                                        echo !t191!  !width2k! 
                                                                                        echo !t192!  !height2k!    
                                                                                        echo.

                                                                                        set /a "width4k=width2k*2"
                                                                                        set /a "height4k=height2k*2"

                                                                                        echo !t20!  !width4k! 
                                                                                        echo !t21!  !height4k!    
                                                                                        echo.
                                                                                    ) 

goto cropmanuale_QSVEncUpScaling1080p10bitHDR

:finecropmanuale_QSVEncUpScaling1080p10bitHDR





rem//////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////


:InserimentoImpostazioniQSVEnc__QSVEncUpScaling1080p10bitHDR

echo.
echo !t40!
echo.
echo 1) CQP 
echo 2) ICQ 
echo 3) LA-ICQ 
echo 4) VBR 
echo.
CHOICE /N /C:1234 /M "!t64!"

if errorlevel 4 goto CodificaVBRQSVEnc__QSVEncUpScaling1080p10bitHDR
if errorlevel 3 goto CodificaLAICQQSVEnc__QSVEncUpScaling1080p10bitHDR
if errorlevel 2 goto CodificaICQQSVEnc__QSVEncUpScaling1080p10bitHDR
if errorlevel 1 goto CodificaCQPQSVEnc__QSVEncUpScaling1080p10bitHDR


:CodificaCQPQSVEnc__QSVEncUpScaling1080p10bitHDR
set "TipoCodificaQSVEnc=--cqp "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc__QSVEncUpScaling1080p10bitHDR

:CodificaICQQSVEnc__QSVEncUpScaling1080p10bitHDR
set "TipoCodificaQSVEnc=--icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc__QSVEncUpScaling1080p10bitHDR

:CodificaLAICQQSVEnc__QSVEncUpScaling1080p10bitHDR
set "TipoCodificaQSVEnc=--la-icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc__QSVEncUpScaling1080p10bitHDR

:CodificaVBRQSVEnc__QSVEncUpScaling1080p10bitHDR
set "TipoCodificaQSVEnc=--vbr "
set /a "quantizzazioneQSVEnc=0"
goto inserimentoValoriCQPVBRQSVEnc__QSVEncUpScaling1080p10bitHDR


:inserimentoValoriCQPVBRQSVEnc__QSVEncUpScaling1080p10bitHDR

if !quantizzazioneQSVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneQSVEnc=!t44! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneQSVEnc!") do set var=!valoreQuantizzazioneQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                goto inserimentoValoriCQPVBRQSVEnc__QSVEncUpScaling1080p10bitHDR
                                                ) 

                                set /a "valoreQuantizzazioneQSVEnc=!valoreQuantizzazioneQSVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneQSVEnc!
                                if !valoreQuantizzazioneQSVEnc! GEQ 10 if !valoreQuantizzazioneQSVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneQSVEnc!
                                                                                                                set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreQuantizzazioneQSVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                                goto fineQuantizzazioneQSVEnc__QSVEncUpScaling1080p10bitHDR
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRQSVEnc__QSVEncUpScaling1080p10bitHDR
                                                                                                                        
                                )



if !quantizzazioneQSVEnc!==0 (
                                echo.
                                set /p "valoreBitRateQSVEnc=!t46! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateQSVEnc!") do set var=!valoreBitRateQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                goto inserimentoValoriCQPVBRQSVEnc__QSVEncUpScaling1080p10bitHDR
                                                ) 
                                set /a "valoreBitRateQSVEnc=!valoreBitRateQSVEnc!"
                                @REM echo valoreBitRateQSVEnc = !valoreBitRateQSVEnc!
                                if !valoreBitRateQSVEnc! GEQ 100 if !valoreBitRateQSVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateQSVEnc!
                                                                                                        set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreBitRateQSVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                        goto fineQuantizzazioneQSVEnc__QSVEncUpScaling1080p10bitHDR
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRQSVEnc__QSVEncUpScaling1080p10bitHDR
                                                                                                              
                                )


:fineQuantizzazioneQSVEnc__QSVEncUpScaling1080p10bitHDR



echo.
echo !t50!
echo.
echo 1) Best 
echo 2) Higher 
echo 3) High 
echo 4) Balanced 
echo 5) Fast 
echo 6) Faster 
echo 7) Fastest 
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto QualitFastestQSVEnc__QSVEncUpScaling1080p10bitHDR
if errorlevel 6 goto QualitFasterQSVEnc__QSVEncUpScaling1080p10bitHDR
if errorlevel 5 goto QualitFastQSVEnc__QSVEncUpScaling1080p10bitHDR
if errorlevel 4 goto QualitBalancedtQSVEnc__QSVEncUpScaling1080p10bitHDR
if errorlevel 3 goto QualitHighQSVEnc__QSVEncUpScaling1080p10bitHDR
if errorlevel 2 goto QualitHigherQSVEnc__QSVEncUpScaling1080p10bitHDR
if errorlevel 1 goto QualitBestQSVEnc__QSVEncUpScaling1080p10bitHDR


:QualitBestQSVEnc__QSVEncUpScaling1080p10bitHDR
set "SettaggioQualitaQSvenc=--quality best"
set "QualitySetting=best"
goto fineQualitCodificaQSVEnc__QSVEncUpScaling1080p10bitHDR

:QualitHigherQSVEnc__QSVEncUpScaling1080p10bitHDR
set "SettaggioQualitaQSvenc=--quality higher"
set "QualitySetting=higher"
goto fineQualitCodificaQSVEnc__QSVEncUpScaling1080p10bitHDR

:QualitHighQSVEnc__QSVEncUpScaling1080p10bitHDR
set "SettaggioQualitaQSvenc=--quality high"
set "QualitySetting=high"
goto fineQualitCodificaQSVEnc__QSVEncUpScaling1080p10bitHDR

:QualitBalancedtQSVEnc__QSVEncUpScaling1080p10bitHDR
set "SettaggioQualitaQSvenc=--quality balanced"
set "QualitySetting=balanced"
goto fineQualitCodificaQSVEnc__QSVEncUpScaling1080p10bitHDR

:QualitFastQSVEnc__QSVEncUpScaling1080p10bitHDR
set "SettaggioQualitaQSvenc=--quality fast"
set "QualitySetting=fast"
goto fineQualitCodificaQSVEnc__QSVEncUpScaling1080p10bitHDR

:QualitFasterQSVEnc__QSVEncUpScaling1080p10bitHDR
set "SettaggioQualitaQSvenc=--quality faster"
set "QualitySetting=faster"
goto fineQualitCodificaQSVEnc__QSVEncUpScaling1080p10bitHDR

:QualitFastestQSVEnc__QSVEncUpScaling1080p10bitHDR
set "SettaggioQualitaQSvenc=--quality fastest"
set "QualitySetting=fastest"
goto fineQualitCodificaQSVEnc__QSVEncUpScaling1080p10bitHDR


:fineQualitCodificaQSVEnc__QSVEncUpScaling1080p10bitHDR
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaQSvenc!



:sceltadenoiser
set conv3d1080p=
set pmd1080p=
set /a unicopassaggio=0

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t55!"
    if errorlevel 2 goto conv3dChoosenNoQSVEnc__QSVEncUpScaling1080p10bitHDR
    if errorlevel 1 goto conv3dChoosenYesQSVEnc__QSVEncUpScaling1080p10bitHDR
)

echo.
CHOICE /N /C:SN /M "!t55!"

if errorlevel 2 goto conv3dChoosenNoQSVEnc__QSVEncUpScaling1080p10bitHDR
if errorlevel 1 goto conv3dChoosenYesQSVEnc__QSVEncUpScaling1080p10bitHDR

:conv3dChoosenNoQSVEnc__QSVEncUpScaling1080p10bitHDR
set "conv3d1080p=N"
goto sceltaDeniserPMDQSVEnc__QSVEncUpScaling1080p10bitHDR

:conv3dChoosenYesQSVEnc__QSVEncUpScaling1080p10bitHDR
set "conv3d1080p=S"



:sceltaDeniserPMDQSVEnc__QSVEncUpScaling1080p10bitHDR
if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t56!"
    if errorlevel 2 goto PMDChoosenNoQSVEnc__QSVEncUpScaling1080p10bitHDR
    if errorlevel 1 goto PMDChoosenYesQSVEnc__QSVEncUpScaling1080p10bitHDR
)
echo.
CHOICE /N /C:SN /M "!t56!"

if errorlevel 2 goto PMDChoosenNoQSVEnc__QSVEncUpScaling1080p10bitHDR
if errorlevel 1 goto PMDChoosenYesQSVEnc__QSVEncUpScaling1080p10bitHDR

:PMDChoosenNoQSVEnc__QSVEncUpScaling1080p10bitHDR
set "pmd1080p=N"
goto assegnazioneDenoisesQSVEnc__QSVEncUpScaling1080p10bitHDR

:PMDChoosenYesQSVEnc__QSVEncUpScaling1080p10bitHDR
set "pmd1080p=S"


:assegnazioneDenoisesQSVEnc__QSVEncUpScaling1080p10bitHDR
set /A nvdenv=0

if !conv3d1080p!==S if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00 --vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==S if !pmd1080p!==N ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==N ( 
                                        set "nvdenoiser=" 
                                        set "nvdenv=1"
                                        set "unicopassaggio=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: Nessun Denoiser 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )

@REM pause

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t57!"
    if errorlevel 2 goto ApplicaMiglioramentoDettagliQSVEncNo__QSVEncUpScaling1080p10bitHDR
    if errorlevel 1 goto ApplicaMiglioramentoDettagliQSVEncSi__QSVEncUpScaling1080p10bitHDR
)

echo.
CHOICE /N /C:SN /M "!t57!"

if errorlevel 2 goto ApplicaMiglioramentoDettagliQSVEncNo__QSVEncUpScaling1080p10bitHDR
if errorlevel 1 goto ApplicaMiglioramentoDettagliQSVEncSi__QSVEncUpScaling1080p10bitHDR

:ApplicaMiglioramentoDettagliQSVEncNo__QSVEncUpScaling1080p10bitHDR
set "miglioramento1080p=N"
goto fineSceltaMigliaramentiQSVEnci__QSVEncUpScaling1080p10bitHDR

:ApplicaMiglioramentoDettagliQSVEncSi__QSVEncUpScaling1080p10bitHDR
set "miglioramento1080p=S"

:fineSceltaMigliaramentiQSVEnci__QSVEncUpScaling1080p10bitHDR
if !miglioramento1080p!==S ( 
                                set "edgeleveling=--vpp-edgelevel strength=10.0,threshold=24.0,black=6,white=0" 
                                echo.
                                echo QSVEnc !t58!
                                echo.
                                )
if !miglioramento1080p!==N ( 
                                set "edgeleveling=" 
                                echo.
                                echo QSVEnc !t59!
                                echo.
                                )


@REM pause

if NOT DEFINED nvdenoiser if NOT DEFINED edgeleveling (
                                                        set "unicopassaggio=1"
                                                        goto fineConfigurazioneOperazioniUpScalingQSVEnc_QSVEncUpScaling1080p10bitHDR
                                                        )

echo.
echo.
echo !t75!
echo !t76!
echo.
echo !t77!
echo !t78!

echo.
CHOICE /N /C:123 /M "!t39!"

if errorlevel 2 goto OperazioniUpScalingSingolaCodificaQSVEnc_QSVEncUpScaling1080p10bitHDR
if errorlevel 1 goto OperazioniUpScalingDoppiaCodificaQSVEnc_QSVEncUpScaling1080p10bitHDR

:OperazioniUpScalingSingolaCodificaQSVEnc_QSVEncUpScaling1080p10bitHDR
set "unicopassaggio=1"
goto fineConfigurazioneOperazioniUpScalingQSVEnc_QSVEncUpScaling1080p10bitHDR

:OperazioniUpScalingDoppiaCodificaQSVEnc_QSVEncUpScaling1080p10bitHDR
set "unicopassaggio=0"

:fineConfigurazioneOperazioniUpScalingQSVEnc_QSVEncUpScaling1080p10bitHDR





echo.
echo UpScaling Iniziato.... 
echo.



set file_senza_virgolette=%NomeFile:"=%
rem echo %file_senza_virgolette%

set file_senza_estensione=%file_senza_virgolette:.mkv=%
rem echo %file_senza_estensione%

set fileoutput2160p="%file_senza_estensione%_UpScaled.mkv"

@REM echo miglioramento1080p = !miglioramento1080p!
@REM echo.
@REM pause 


if !miglioramento1080p!==S (
                                @REM echo dento if S
                                set fileoutput2160pdetailed2="!file_senza_estensione!_UpScaled 2160p.mkv"
                                @REM echo fileoutput2160pdetailed2 = !fileoutput2160pdetailed2!
                                set fileoutput2160pdetailed="!file_senza_estensione!_UpScaled 2160p_pul_leggera.mkv"
                                @REM echo fileoutput2160pdetailed = !fileoutput2160pdetailed!
                                )

if !miglioramento1080p!==N  (
                                @REM echo dento if N
                                set fileoutput2160pdetailed2="!file_senza_estensione!_UpScaled 2160p.mkv"
                                @REM echo fileoutput2160pdetailed2 = !fileoutput2160pdetailed2!
                                set fileoutput2160pdetailed="!file_senza_estensione!_UpScaled 2160p_pul_leggera.mkv"
                                @REM echo fileoutput2160pdetailed = !fileoutput2160pdetailed!
                                )


set fileoutput2160pdetailed_senza_virgolette=!fileoutput2160pdetailed:"=! 
rem echo !fileoutput2160pdetailed_senza_virgolette!


for %%i in ("!fileoutput2160pdetailed_senza_virgolette!") do (  
                                                                set "solo_nome_file=%%~ni"
                                                                rem echo Nome file: !solo_nome_file!

                                                                set "solo_estensione_file=%%~xi"
                                                                rem echo Estensione: !solo_estensione_file!
                                                                )

set fileoutput2160pdetailed_rinominato=!solo_nome_file!_rinominato!solo_estensione_file!

rem echo %fileoutput2160pdetailed_rinominato%



set fileoutput2160pdetailed2_senza_virgolette=!fileoutput2160pdetailed2:"=! 
rem echo %fileoutput2160pdetailed2_senza_virgolette%

for %%i in ("!fileoutput2160pdetailed2_senza_virgolette!") do (  
                                                                set "solo_nome_file=%%~ni"
                                                                rem echo Nome file: !solo_nome_file!

                                                                set "solo_estensione_file=%%~xi"
                                                                rem echo Estensione: !solo_estensione_file!
                                                                )

set fileoutput2160pdetailed2_rinominato=!solo_nome_file!_rinominato!solo_estensione_file!

rem echo %fileoutput2160pdetailed2_rinominato%

if exist "Temp_HDR10_Stream.txt" ( del Temp_HDR10_Stream.txt )
if exist "durata_film.txt" ( del durata_film.txt )
if exist "crop.txt" ( del crop.txt )
if exist "risultato_multiplo.txt" ( del risultato_multiplo.txt )
if exist "crop_multiplo.txt" ( del crop_multiplo.txt )
if exist "crop_finale.txt" ( del crop_finale.txt )

if !unicopassaggio!==1 ( goto codificaunicopassaggio1080p10bitHDR )

rem echo fileoutput2160p = %fileoutput2160p%
rem echo fileoutput2160pdetailed = %fileoutput2160pdetailed%

".\bin\qsvencc\QSVEncC64.exe" --avsw --device auto -i !NomeFile!  --output-res !width4k!x!height4k!  !cropff! --video-metadata clear --metadata clear --chapter-copy -c hevc !tipoQuantizzazioneQSVEnc!  !SettaggioQualitaQSVEnc! --la-depth 32   --level auto --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display copy --max-cll copy  --output-depth 10  --avsync cfr --psnr --ssim     -m default_mode:infer_no_subs      --vpp-resize algo=lanczos4  --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o !fileoutput2160p!

echo.
echo !t80!
echo.

".\bin\qsvencc\QSVEncC64.exe" --avhw --device auto -i !fileoutput2160p!  --crop 0,0,0,0  --video-metadata clear --metadata clear --chapter-copy -c hevc !tipoQuantizzazioneQSVEnc!  !SettaggioQualitaQSVEnc!  --la-depth 32  --level auto --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display copy --max-cll copy --output-depth 10   --avsync cfr     -m default_mode:infer_no_subs  !nvdenoiser! !edgeleveling!  --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off  --log-level info --log ".\codifica_hardware_out_log.txt" -o !fileoutput2160pdetailed!

ren !fileoutput2160pdetailed! "!fileoutput2160pdetailed_rinominato!"

if !unicopassaggio!==0 ( goto fineupscalingdoppiopassaggio1080p10bitHDR )

:codificaunicopassaggio1080p10bitHDR

".\bin\qsvencc\QSVEncC64.exe" --avsw --device auto -i !NomeFile!  --output-res !width4k!x!height4k!  !cropff! --video-metadata clear --metadata clear --chapter-copy -c hevc !tipoQuantizzazioneQSVEnc!  !SettaggioQualitaQSVEnc! --la-depth 32  --level auto --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display copy --max-cll copy  --output-depth 10   --avsync cfr --psnr --ssim     -m default_mode:infer_no_subs      --vpp-resize algo=lanczos4  !nvdenoiser! !edgeleveling!  --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o !fileoutput2160pdetailed2!

ren !fileoutput2160pdetailed2! "!fileoutput2160pdetailed2_rinominato!"

:fineupscalingdoppiopassaggio1080p10bitHDR

echo.
echo !t81!
echo.

goto fineinfovideo_QSVEncUpScaling1080p10bitHDR




:novideofile1080p_QSVEncUpScaling1080p10bitHDR
echo !t63!
echo.


:fineinfovideo_QSVEncUpScaling1080p10bitHDR

if exist ".\saved\settings.dat" (
                                for /f "tokens=1,2 delims=|" %%a in (.\saved\settings.dat) do (
                                                                                                    rem echo %%a
                                                                                                    rem echo %%b
                                                                                                    set /a "shst=%%b"
                                                                                                    rem echo !shst!
                                                                                                    rem pause
                                                                                                    if !shst!==1 (
                                                                                                                echo !t82!
                                                                                                                echo.
                                                                                                                shutdown /s
                                                                                                                set /a "delay=10"
                                                                                                                timeout /t !delay!
                                                                                                                exit
                                                                                                                )
                                                                                                                            
                                                                                                    )                                                                                                  
                                                                                                )


if exist ".\temp\Temp_HDR10_Stream.txt" ( del .\temp\Temp_HDR10_Stream.txt )
if exist ".\temp\durata_film.txt" ( del .\temp\durata_film.txt )
if exist ".\temp\crop.txt" ( del .\temp\crop.txt )
if exist ".\temp\risultato_multiplo.txt" ( del .\temp\risultato_multiplo.txt )
if exist ".\temp\crop_multiplo.txt" ( del .\temp\crop_multiplo.txt )
if exist ".\temp\crop_finale.txt" ( del .\temp\crop_finale.txt )
      




set waitenter=
set /P waitenter=!t65!
Endlocal
goto menuiniziale







rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:NVEncUpGrading

cls
setLocal EnableExtensions EnableDelayedExpansion





for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoNVEncUpGrading
)

if %lingua%==inglese (
    goto caricalinguaingleseNVEncUpGrading
)



:caricalinguaingleseNVEncUpGrading
@REM set t1=Insert Hardware Video Encoding Info UpGrading from 2160p 10 bit or 8 bit SDR to 2160p 10 bit HDR and Saving to Disk

set t2=Drag Here the Video File 2160p 8 bit SDR or 10 bit SDR to Convert to 10 bit HDR:  
@REM set t211=Video File 2160p 10 bit HDR to Convert to 1080p 8 bit SDR:  

set t3=File does not exist 
set t4=Info Video:  

set t5=The Inserted Video is 2160p 8bit SDR 
set t511=The Inserted Video is 2160p 10bit SDR 

set t6=The Inserted Video isn't 2160p 8bit or 10bit SDR 
set t7=Video Duration in seconds:
set t8=Video Duration in Minutes:
set t9=Interval between Frames for Crop Detection:
set t10= seconds
set t11=Black Bands Detection Started....
set t12=Crop Detection to Frame
set t13=to seconds
set t14=Done...
set t15=Original 2160p Video Width: 
set t16=Original 2160p Video Height:
set t17=Original Video 2160p Width Without Black Bars:
set t18=Original Video 2160p Height Without Black Bars:

set t171=Output Video 1080p Width Without Black Bars:
set t181=Outout Video 1080p Height Without Black Bars:

set t19=Adapting Video Resolution to Full 2160p Format...
set t20=Final 2160p Output Video Width:
set t21=Final 2160p Output Video Height:

set t22=Settings of Black Bands to Crop are Correct (Yes/No):
set t23=Manually Entering Black Band Values to Crop... 
set t24=Enter the Upper Black Band Value: 
set t25=Error Entering Upper Black Band Value... It's Not a Number. 
set t26=Enter the Lower Black Band Value: 
set t27=Error Entering Lower Black Band Value... It's Not a Number.
set t28=Enter the Left Black Band Value: 
set t29=Error Entering Left Black Band Value... It's Not a Number.
set t30=Enter the Right Black Band Value: 
set t31=Error Entering Right Black Band Value... It's Not a Number.
set t32=Upper Black Band:
set t33=Lower Black Band:
set t34=Left Black Band:
set t35=Right Black Band:
set t36=2160p Original Video Width without Black Bars:
set t37=2160p Original Video Height without Black Bars:

@REM set t361=1080p Video Width without Black Bars:
@REM set t371=1080p Video Height without Black Bars

set t38=Select Graphic Card you want to Encode with:
set t39=Choose (1/2):
set t40=Select Encoding Type:
set t41=Error Entering Quantization Value... Not a Number. 
set t42=Quantization Value Set to:
set t43=Encoding Settings:
set t44=Enter Quantization value Minimum 10 Maximum 28:
set t45=Quantization Value Out of  Limits  10 / 28  Re-enter^!
set t46=Enter BitRate Value kbs Minimum 100 Maximum 50000:
set t47=Error Entering BitRate Value... It's Not a Number. 
set t48=BitRate Value Set to:
set t49=BitRate Value Out of Limits  100 / 50000  Re-enter^!
set t50=Select Encoding Quality:
set t51=- Worst Quality
set t52=- Best Quality
set t53=Choose (1/2/3/4/5/6/7):
set t54=Quality Set to:
set t55=Apply Convolution3D denoiser Yes/No: 
set t56=Apply PMD denoiser Yes/No: 
set t57=Apply Detail Enhancement Yes/No:  
set t58=Enhancement Detail: Yes 
set t59=Enhancement Detail: No 
set t60=Info
set t61=Videos to Encode Saved!
set t62=Do You Want to Insert Another Video to Encode (Yes/No):
set t63=The dragged file is not a video!
set t64=Choose (1/2/3/4):
set t65=Press Enter to Back to Main Menu.  

set t66=Video Width
set t67=Video Height
set t68=Video Codec
set t69=Details Video Codec
set t70=Video Format 
set t71=Configuration Settings to convert video from 8bit or 10bit SDR to 10bit HDR
set t72=Select Encoding UpGrader:
set t73=Settings UpGrader:
set t74=Choose (1/2/3):

set t75=UpGrading Started.... 
set t76=Encoding Finished... 
set t1000=Now the PC will be turned off... 


goto avvio_NVEncUpGrading




:caricalinguaitalianoNVEncUpGrading
@REM set t1=Inserimento Info Codifica Hardware Video UpGrading da 2160p 10 bit o 8 bit SDR a 10 bit HDR e Salvataggio su Disco.

set t2=Trascina Qui il File Video 2160p 8 bit o [923m10 bit SDR da Convertire in 10 bit HDR:  
@REM set t211=File Video 2160p 8 bit o [923m10 bit SDR da Convertire in 10 bit HDR:  

set t3=File Inesistente 
set t4=Informazioni Video:  

set t5=Il Video inserito e' 2160p 8bit SDR 
set t511=Il Video inserito e' 2160p 10bit SDR 

set t6=Il Video inserito non e' 2160p 8bit o 10bit SDR 

set t7=Durata del Video in secondi:
set t8=Durata del video in Minuti:
set t9=Intervallo tra i Fotogrammi per il Rilevamento del crop:
set t10= secondi
set t11=Rilevamento Bande Nere Iniziato....
set t12=Rilevazione crop fotogramma
set t13=a secondi
set t14=Eseguita...
set t15=Larghezza Video 2160p Originale:
set t16=Altezza Video 2160p Originale:
set t17=Larghezza Video Originale 2160p  Senza Barre Nere:
set t18=Altezza Video Originale 2160p  Senza Barre Nere:

set t171=Larghezza Video 1080p  Senza Barre Nere:
set t181=Altezza Video 1080p  Senza Barre Nere:

set t19=Adattamento della Risoluzione del Video al Pieno Formato 2160p..
set t20=Larghezza Finale Video 2160p:
set t21=Altezza Finale Video 2160p:

set t22=Le Impostazioni delle Bande Nere da Tagliare sono Corrette (Si/No):
set t23=Inserimento Manuale Valori Bande Nere da Tagliare.. 
set t24=Inserisci il Valore della Banda Nera Superiore: 
set t25=Errore nell'Inserimento del Valore della Banda Nera Superiore... Non e' un Numero. 
set t26=Inserisci il Valore della Banda Nera Inferiore: 
set t27=Errore nell'Inserimento del Valore della Banda Nera Inferiore... Non e' un Numero. 
set t28=Inserisci il Valore della Banda Nera Sinistra: 
set t29=Errore nell'Inserimento del Valore della Banda Nera Sinistra... Non e' un Numero. 
set t30=Inserisci il Valore della Banda Nera Destra: 
set t31=Errore nell'Inserimento del Valore della Banda Nera Destra... Non e' un Numero. 
set t32=Banda Nera Superiore:
set t33=Banda Nera Inferiore:
set t34=Banda Nera Sinistra:
set t35=Banda Nera Destra:
set t36=Larghezza Video Originale 2160p senza Bande Nere:
set t37=Altezza Video Originale 2160p senza Bande Nere:

@REM set t361=Larghezza Video 1080p senza Bande Nere:
@REM set t371=Altezza Video 1080p senza Bande Nere:

set t38=Selezionare Scheda Grafica con cui Eseguire la Codifica:
set t39=Scegli (1/2):
set t40=Selezionare tipo di Codifica:
set t41=Errore nell'Inserimento del Valore della Quantizzazione... Non e' un Numero. 
set t42=Valore Quantizzazzione Impostato a:
set t43=Parametri per codifica:

set t44=Inserire Valore Quantizzazione Minimo 10 Massimo 28:
set t45=Valore Quantizzazzione al di fuori dei  Limiti  10 / 28  Reinserire^!
set t46=Inserire Valore BitRate kbs Minimo 100 Massimo 50000:
set t47=Errore nell'Inserimento del Valore del BitRate... Non e' un Numero. 
set t48=Valore BitRate Impostato a:
set t49=Valore  BitRate al di fuori dei  Limiti  100 / 50000  Reinserire^!

set t50=Selezionare Qualita' Codifica:
set t51=- Peggiore Qualita'
set t52=- Migliore Qualita'
set t53=Scegli (1/2/3/4/5/6/7):
set t54=Qualita' Impostata su:
set t55=Applicare il denoiser Convolution3D Si/No: 
set t56=Applicare il denoiser PMD Si/No: 
set t57=Applicare il Miglioramento Dettagli Si/No:  
set t58=Miglioramento Dettagli: Si 
set t59=Miglioramento Dettagli: No 
set t60=Informazioni
set t61=Video da Codificare Salvate!
set t62=Vuoi Inserire un altro Video da Codificare (Si/No):
set t63=Il file trascinato non e' un video!
set t64=Scegli (1/2/3/4):
set t65=Premi Invio per tornare al Menu' Principale.  

set t66=Larghezza Video
set t67=Altezza Video
set t68=Codec Video
set t69=Codec Video Dettagli
set t70=Format Video 
set t71=Configurazione Parametri per convertire il video da 8bit o 10bit SDR a 10bit HDR
set t72=Selezionare UpGrader Codifica:
set t73=UpGrader Impostato:
set t74=Scegli (1/2/3):

set t75=UpGrading Iniziato.... 
set t76=Codifica Terminata...
set t1000=Il PC ora verra' Spento... 


goto avvio_NVEncUpGrading

:avvio_NVEncUpGrading





set /a "numeromovie=1"


:altrivideodainserire_NVEncUpGrading


set NomeFile2160ppuliziadettaggli=
rem set MetadatiStreamHDR10=

set /P NomeFile2160ppuliziadettaggli=!t2! 
rem echo Hai digitato: %NomeFile%
rem pause

set "NomeFileSorgente=!NomeFile2160ppuliziadettaggli:"=!"
@REM echo NomeFileSorgente = !NomeFileSorgente!
set "NomeFile=^"!NomeFileSorgente!^""
@REM echo NomeFile = !NomeFile!
rem pause


if exist %NomeFile% ( goto infovideo_NVEncUpGrading ) else ( 
                                                        echo.
                                                        echo !t3!
                                                        echo.
                                                        goto fineinfovideo_NVEncUpGrading
                                                        )    



:infovideo_NVEncUpGrading
echo.
echo !t4!
echo.

.\bin\ffprobe -v error -hide_banner -select_streams v:0 -show_entries stream=width,height,codec_name,codec_long_name,pix_fmt,color_space,color_transfer,color_primaries -of default=noprint_wrappers=1 !NomeFile! > ".\temp\Temp_HDR10_Stream.txt"

set /A x1=1
set /A nohdrcs=0
set /A nohdrct=0
set /A nohdrcp=0
set /A wv=0
set /a hv=0
set /A fv=0

rem echo nohdr = %nohdr%

for /f "tokens=1,2 delims==" %%a in (.\temp\Temp_HDR10_Stream.txt) do (if !x1!==3 ( 
                                                                            echo !t66! "%%a" = %%b  
                                                                            set /A "widthvideo=%%b"
                                                                            rem echo widthvideo = !widthvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !widthvideo! LEQ 3840 if !widthvideo! GEQ 2000 (set /A "wv=1"
                                                                                                                                rem echo wv = !wv!
                                                                                                                                )
                                                                            )
                                                                if !x1!==4 ( 
                                                                            echo !t67! "%%a" = %%b  
                                                                            set /A "heightvideo=%%b"
                                                                            rem echo heightvideo = !heightvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !heightvideo! LEQ 2160 if !heightvideo! GEQ 1400 (set /A "hv=1"
                                                                                                        rem echo hv = !hv!
                                                                                                        )
                                                                            )                                                           
                                                                if !x1!==6 ( 
                                                                            echo Color Space "%%a" = %%b  
                                                                            set "colorsp=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colorsp!==bt709 (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorsp!==unknown (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorsp!==reserved (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                    
                                                                            ) 
                                                                if !x1!==7 ( 
                                                                            echo Color Transfer "%%a" = %%b  
                                                                            set "colortr=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colortr!==bt709 (set /A "nohdrct=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colortr!==unknown (set /A "nohdrct=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colortr!==reserved (set /A "nohdrct=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                    
                                                                            ) 
                                                                if !x1!==8 ( 
                                                                            echo Color Primaries "%%a" = %%b  
                                                                            set "colorpr=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colorpr!==bt709 (set /A "nohdrcp=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorpr!==unknown (set /A "nohdrcp=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorpr!==reserved (set /A "nohdrcp=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                
                                                                            )    
                                                                if !x1!==1 ( 
                                                                            echo !t68! "%%a" = %%b  
                                                                            )       
                                                                if !x1!==2 ( 
                                                                            echo !t69! "%%a" = %%b  
                                                                            )   
                                                                if !x1!==5 ( 
                                                                            echo !t70! "%%a" = %%b  
                                                                            set "formatvideo=%%b"
                                                                            rem echo formatvideo = !formatvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !formatvideo!==yuv420p (set /A "fv=1"
                                                                                                        rem echo fv = !fv!
                                                                                                        )
                                                                            if !formatvideo!==yuv420p10le (set /A "fv=1"
                                                                                                        rem echo fv = !fv!
                                                                                                        )
                                                                            )
                                                                set /A x1+=1                                                            
)
echo.

if !x1!==1 goto novideofile2160p_NVEncUpGrading


if !nohdrcs!==1 if !nohdrct!==1 if !nohdrcp!==1 if !wv!==1 if !hv!==1 if !fv!==1 ( 
                                                                                   if !formatvideo!==yuv420p10le (
                                                                                                                    echo !t511!
                                                                                                                    goto rilevazionebandenere_NVEncUpGrading
                                                                                                                    ) 
                                                                                   if !formatvideo!==yuv420p (                                 
                                                                                                                echo !t5!
                                                                                                                goto rilevazionebandenere_NVEncUpGrading
                                                                                                                )
                                                                                   ) 
echo !t6!
echo.
goto fineinfovideo_NVEncUpGrading


rem//////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////


:rilevazionebandenere_NVEncUpGrading
.\bin\ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 %NomeFile%  > ".\temp\durata_film.txt"

set /a contatore=1
for /f "tokens=1 delims=." %%a in (.\temp\durata_film.txt) do  (
                                                        echo. 
                                                        echo !t7! %%a
                                                        set /a "secondi=%%a"
                                                        set /a "minuti=!secondi!/60"
                                                        echo !t8! !minuti!
                                                        set /a "intervallo_tagli=!secondi!/11"
                                                        echo !t9! !intervallo_tagli!!t10!
                                                        echo.
                                                        echo !t11!
                                                        echo.

                                                        

                                                        FOR /L %%a IN (1, 1, 10) DO (
                                                                                    rem echo %%a
                                                                                    set /a "secondi=%%a*!intervallo_tagli!"
                                                                                    rem echo !secondi!

                                                                                    
                                                                                    if !formatvideo!==yuv420p (
                                                                                                                set /a "ca=16"
                                                                                                                rem echo !ca!
                                                                                                                    
                                                                                                                set /a "cb=2"
                                                                                                                rem echo !cb!
                                                                                                                    
                                                                                                                set /a "cc=0"
                                                                                                                rem echo !cc!

                                                                                                                set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                                                rem echo !cr!
                                                                                                                )

                                                                                    if !formatvideo!==yuv420p10le  ( 
                                                                                                                    set /a "ca=72"
                                                                                                                    rem echo !ca!
                                                                                                                    
                                                                                                                    set /a "cb=2"
                                                                                                                    rem echo !cb!
                                                                                                                    
                                                                                                                    set /a "cc=0"
                                                                                                                    rem echo !cc!

                                                                                                                    set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                                                    rem echo !cr!
                                                                                                                    )                  
        
                                                                                
                                                                                    .\bin\ffmpeg -ss !secondi! -hide_banner -nostats -i %NomeFile% -vframes 10 -vf !cr! -f null - 2> ".\temp\crop.txt"
                                                                                    
                                                                                    findstr /r "Parsed_cropdetect_0" .\temp\crop.txt >> .\temp\risultato_multiplo.txt   
                                                                                    
                                                                                    echo !t12! %%a !t13! !secondi! !t14!
                                                                                    
                                                                                    )       
                                                                                       

                                                                                    for /f "tokens=1,2 delims==" %%a in (.\temp\risultato_multiplo.txt) do ( echo %%b >> .\temp\crop_multiplo.txt )
                                                                                    
                                                                                    set /a "maxfrequenza=0"

                                                                                    for /f "delims=" %%a in (.\temp\crop_multiplo.txt) do ( 
                                                                                                                                    set "cropconfront=%%a"
                                                                                                                                    rem echo "!cropconfront!"
                                                                                                                                    
                                                                                                                                    set /a "contatorfrequenza=0"
                                                                                                                                    for /f "delims=" %%b in (.\temp\crop_multiplo.txt) do (
                                                                                                                                                                                    set "dato_da_verificare=%%b"
                                                                                                                                                                                    rem echo cropconfront = "!cropconfront!"
                                                                                                                                                                                    rem echo dato_da_verificare = "!dato_da_verificare!"
                                                                                                                                                                                    if !cropconfront!==!dato_da_verificare! ( set /a "contatorfrequenza+=1")
                                                                                                                                                                                    )
                                                                                                                                    if !maxfrequenza! LSS !contatorfrequenza! ( 
                                                                                                                                                                                set /a "maxfrequenza=!!contatorfrequenza!!"
                                                                                                                                                                                set "cropd=!cropconfront!"
                                                                                                                                                                                )
                                                                                                                                    

                                                                                                                                    rem if !cropconfront! in (elenco_crop_frequenza.txt) ()
                                                                                                                                    rem echo !cropconfront!:!contatorfrequenza! >> elenco_crop_frequenza.txt

                                                                                                                                    )

                                                                                    rem echo crop piu' frequente = !cropd! con grequenza = !maxfrequenza!
                                                                                    echo !cropd! > .\temp\crop_finale.txt

                                                                                    for /f "tokens=1,2,3,4 delims=:" %%a in (.\temp\crop_finale.txt) do  ( 
                                                                                                                                                    rem set /a "mwidth=%%a"
                                                                                                                                                    rem echo mwidth = !mwidth!

                                                                                                                                                    rem set /a "mheight=%%b"
                                                                                                                                                    rem echo mheight = !mheight!

                                                                                                                                                    rem set /a "mx=%%c"
                                                                                                                                                    rem echo mx = !mx!

                                                                                                                                                    rem set /a "my=%%d"
                                                                                                                                                    rem echo my = !my!

                                                                                                                                                    if !contatore!==1 ( 
                                                                                                                                                                set /a "wmax=%%a" 
                                                                                                                                                                set /a "hmax=%%b"
                                                                                                                                                                set /a "xmin=%%c"
                                                                                                                                                                set /a "ymin=%%d"
                                                                                                                                                                set /a "mwidth=%%a"
                                                                                                                                                                set /a "mheight=%%b"
                                                                                                                                                                set /a "mx=%%c"
                                                                                                                                                                set /a "my=%%d"
                                                                                                                                                                set /a "contatore+=1"
                                                                                                                                                                )
                                                                                                                                                    
                                                                                                                                                    rem if %%b gtr !hmax! if %%c gtr !xmin! if %%d gtr !ymin! 

                                                                                                                                                    if %%a geq !wmax! if %%b geq !hmax! ( 
                                                                                                                                                                        set /a "wmax=%%a" 
                                                                                                                                                                        set /a "hmax=%%b"
                                                                                                                                                                        set /a "xmin=%%c"
                                                                                                                                                                        set /a "ymin=%%d"
                                                                                                                                                                        set /a "mwidth=%%a"
                                                                                                                                                                        set /a "mheight=%%b"
                                                                                                                                                                        set /a "mx=%%c"
                                                                                                                                                                        set /a "my=%%d"
                                                                                                                                                                        )
                                                                                                                                                    )
                                                                                    echo.
                                                                                    set /a "csup=!my!"
                                                                                    rem echo csup = !csup!
                                                                                                                                    
                                                                                    set /a "csin=!mx!"
                                                                                    rem echo csin = !csin!

                                                                                    set /a "cinf=!heightvideo!-!mheight!-!my!"
                                                                                    rem echo movieheightreal = !movieheightreal!
                                                                                    rem echo cinf = !cinf!
                                                                                    set /a "cdes=!widthvideo!-!mwidth!-!mx!"
                                                                                    rem echo cdes = !cdes!

                                                                                    echo Crop Settings: --crop !csin!,!csup!,!cdes!,!cinf!  
                                                                                    set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"  
                                                                                    echo.  
                                                                                    
                                                                                    set /a "mwidthc=(!widthvideo!-!csin!-!cdes!)/2*2"
                                                                                    set /a "mheightc=(!heightvideo!-!csup!-!cinf!)/2*2"


                                                                                    echo !t17!  !mwidthc! 
                                                                                    echo !t18!  !mheightc! 
                                                                                    echo.
                                                                                    
                                                                                    set /a "larghezza2160pnvenc=3840"
                                                                                    set /a "altezza2160pnvenc=2160"
                                                                                    @REM echo larghezza2160pnvenc = !larghezza2160pnvenc!                                    
                                                                                    @REM echo altezza2160pnvenc = !altezza2160pnvenc!     

                                                                                    set /a "differenzialelarghezza2160pnvenc=!larghezza2160pnvenc!-!mwidthc!"
                                                                                    set /a "differenzialealtezza2160pnvenc=!altezza2160pnvenc!-!mheightc!"
                                                                                    @REM echo differenzialelarghezza2160pnvenc = !differenzialelarghezza2160pnvenc!                                                                
                                                                                    @REM echo differenzialealtezza2160pnvenc = !differenzialealtezza2160pnvenc!

                                                                                    if !differenzialelarghezza2160pnvenc!==0 if !differenzialealtezza2160pnvenc! GTR 0 (
                                                                                                                                                                        @REM echo dentro il 1o if
                                                                                                                                                                        set /a "width4k=!mwidthc!"
                                                                                                                                                                        set /a "height4k=!mheightc!"
                                                                                                                                                                        )                        
                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                        if !differenzialelarghezza2160pnvenc! GTR 0 if !differenzialealtezza2160pnvenc!==0 (
                                                                                                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                                                                                                set /a "width4k=!mwidthc!"
                                                                                                                                                                                                                                                                set /a "height4k=!mheightc!"
                                                                                                                                                                                                                                                                ) else if !differenzialelarghezza2160pnvenc! LSS !differenzialealtezza2160pnvenc! (
                                                                                                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza2160pnvenc = !differenzialelarghezza2160pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza2160pnvenc = !differenzialealtezza2160pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                                                                                                        set /a "width4k=!mwidthc!+!differenzialelarghezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        set /a "height4k=!mheightc!+!differenzialelarghezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        @REM echo width4k = !width4k!
                                                                                                                                                                                                                                                                                                                                                        @REM echo height4k = !height4k!
                                                                                                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza2160pnvenc! GTR !differenzialealtezza2160pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "width4k=!mwidthc!+!differenzialealtezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo width4k = !width4k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "height4k=!mheightc!+!differenzialealtezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo height4k = !height4k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                        if !differenzialelarghezza2160pnvenc!==0 if !differenzialealtezza2160pnvenc!==0 (   
                                                                                                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                                                                                                        set /a "width4k=!mwidthc!"
                                                                                                                                                                                                                                                        set /a "height4k=!mheightc!"
                                                                                                                                                                                                                                                        )
                                                                                                                                                                                                                                                        
                                                                                                                                                                        if !differenzialelarghezza2160pnvenc!==!differenzialealtezza2160pnvenc! (   
                                                                                                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                                                                                                set /a "width4k=!mwidthc!+differenzialelarghezza2160pnvenc"
                                                                                                                                                                                                                                                set /a "height4k=!mheightc!+differenzialelarghezza2160pnvenc"
                                                                                                                                                                                                                                                )                                                                                        
                                                                                                                                                                

                                                                                                                                                                        echo !t19!
                                                                                                                                                                        echo.                         

                                                                                                                                                                        echo !t20!  !width4k! 
                                                                                                                                                                        echo !t21!  !height4k!    
                                                                                                                                                                        echo.

                                                                                                                                                                    ) 

                                                                                    ) 
                                                        )                          
                                                  

:cropmanuale_NVEncUpGrading
set /a "csup=0"
set /a "cinf=0"
set /a "csin=0"
set /a "cdes=0"
set /a "bandasuperiore=0"
set /a "bandainferiore=0"
set /a "bandasinistra=0"
set /a "bandadestra=0"
set /a "differenzialelarghezza2160pnvenc=0"
set /a "differenzialealtezza2160pnvenc=0"
if exist ".\temp\Temp_HDR10_Stream.txt" ( del ".\temp\Temp_HDR10_Stream.txt" ) 
if exist ".\temp\durata_film.txt" ( del ".\temp\durata_film.txt" )
if exist ".\temp\crop.txt" ( del ".\temp\crop.txt" )
if exist ".\temp\risultato_multiplo.txt" ( del ".\temp\risultato_multiplo.txt" )
if exist ".\temp\crop_multiplo.txt" ( del ".\temp\crop_multiplo.txt" )
if exist ".\temp\crop_finale.txt" ( del ".\temp\crop_finale.txt" )


if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t22!"   
    if errorlevel 2 goto cropmanualeNVEncUpGrading_NVEncUpGrading
    if errorlevel 1 goto finecropNVEncUpGrading_NVEncUpGrading
)

CHOICE /N /C:SN /M "!t22!"   

if errorlevel 2 goto cropmanualeNVEncUpGrading_NVEncUpGrading
if errorlevel 1 goto finecropNVEncUpGrading_NVEncUpGrading


:cropmanualeNVEncUpGrading_NVEncUpGrading
echo.
echo !t23!
echo.

:banda_superiore_NVEncUpGrading
set /p "bandasuperiore=!t24! "
SET "var="&for /f "delims=0123456789" %%i in ("!bandasuperiore!") do set var=!bandasuperiore!
if defined var (
                echo.
                echo !t25!
                echo.
                goto banda_superiore_NVEncUpGrading
                ) else (
                        set /a "csup=!bandasuperiore!/2*2"
                        )

echo.
:banda_inferiore_NVEncUpGrading
set /p "bandainferiore=!t26! "  
SET "var="&for /f "delims=0123456789" %%i in ("!bandainferiore!") do set var=!bandainferiore!
if defined var (
                echo.
                echo !t27!
                echo.
                goto banda_inferiore_NVEncUpGrading
                ) else (
                        set /a "cinf=!bandainferiore!/2*2"
                        )


echo.
:banda_sinistra_NVEncUpGrading
set /p "bandasinistra=!t28! "  
SET "var="&for /f "delims=0123456789" %%i in ("!bandasinistra!") do set var=!bandasinistra!
if defined var (
                echo.
                echo !t29!
                echo.
                goto banda_sinistra_NVEncUpGrading
                ) else (
                        set /a "csin=!bandasinistra!/2*2"
                        )

                        
echo.
:banda_destra_NVEncUpGrading
set /p "bandadestra=!t30! "  
SET "var="&for /f "delims=0123456789" %%i in ("!bandadestra!") do set var=!bandadestra!
if defined var (
                echo.
                echo !t31!
                echo.
                goto banda_destra_NVEncUpGrading
                ) else (
                        set /a "cdes=!bandadestra!/2*2"
                        )


set /a "larghezza2160pnvenc=3840"
set /a "altezza2160pnvenc=2160"
@REM echo larghezza2160pnvenc = !larghezza2160pnvenc!                                    
@REM echo altezza2160pnvenc = !altezza2160pnvenc!                                    

set /a "mwidth=!widthvideo!/2*2"
set /a "mheight=!heightvideo!/2*2"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "mwidthc=!mwidth!-!csin!-!cdes!"
set /a "mheightc=!mheight!-!csup!-!cinf!"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "differenzialelarghezza2160pnvenc=!larghezza2160pnvenc!-!mwidthc!"
set /a "differenzialealtezza2160pnvenc=!altezza2160pnvenc!-!mheightc!"
@REM echo differenzialelarghezza2160pnvenc = !differenzialelarghezza2160pnvenc!                                                                
@REM echo differenzialealtezza2160pnvenc = !differenzialealtezza2160pnvenc!

echo.
echo !t32!  !csup! 
echo !t33!  !cinf! 
echo !t34!  !csin! 
echo !t35!  !cdes! 
echo.


set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
echo Crop Settings: !cropff!
echo.

echo !t36!  !mwidthc! 
echo !t37!  !mheightc! 
echo.



if !differenzialelarghezza2160pnvenc!==0 if !differenzialealtezza2160pnvenc! GTR 0 (
                                                                                        @REM echo dentro il 1o if
                                                                                        set /a "width4k=!mwidthc!"
                                                                                        set /a "height4k=!mheightc!"
                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                        if !differenzialelarghezza2160pnvenc! GTR 0 if !differenzialealtezza2160pnvenc!==0 (
                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                set /a "width4k=!mwidthc!"
                                                                                                                                                                                set /a "height4k=!mheightc!"
                                                                                                                                                                                ) else if !differenzialelarghezza2160pnvenc! LSS !differenzialealtezza2160pnvenc! (
                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza2160pnvenc = !differenzialelarghezza2160pnvenc!
                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza2160pnvenc = !differenzialealtezza2160pnvenc!
                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                        set /a "width4k=!mwidthc!+!differenzialelarghezza2160pnvenc!"
                                                                                                                                                                                                                                                                        set /a "height4k=!mheightc!+!differenzialelarghezza2160pnvenc!"
                                                                                                                                                                                                                                                                        @REM echo width4k = !width4k!
                                                                                                                                                                                                                                                                        @REM echo height4k = !height4k!
                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza2160pnvenc! GTR !differenzialealtezza2160pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                set /a "width4k=!mwidthc!+!differenzialealtezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo width4k = !width4k!
                                                                                                                                                                                                                                                                                                                                                                set /a "height4k=!mheightc!+!differenzialealtezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo height4k = !height4k!
                                                                                                                                                                                                                                                                                                                                                                )
                                                                                        if !differenzialelarghezza2160pnvenc!==0 if !differenzialealtezza2160pnvenc!==0 (   
                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                        set /a "width4k=!mwidthc!"
                                                                                                                                                                        set /a "height4k=!mheightc!"
                                                                                                                                                                        )
                                                                                                                                                                        
                                                                                        if !differenzialelarghezza2160pnvenc!==!differenzialealtezza2160pnvenc! (   
                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                set /a "width4k=!mwidthc!+differenzialelarghezza2160pnvenc"
                                                                                                                                                                set /a "height4k=!mheightc!+differenzialelarghezza2160pnvenc"
                                                                                                                                                                )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.                         

                                                                                        echo !t20!  !width4k! 
                                                                                        echo !t21!  !height4k!    
                                                                                        echo.

                                                                                    ) 

goto cropmanuale_NVEncUpGrading

:finecropNVEncUpGrading_NVEncUpGrading


rem//////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////



:InserimentoImpostazioniNVEnc_NVEncUpGrading

echo.
echo !t40!
echo.
echo 1) CQP 
echo 2) VBR 
echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto CodificaVBRNVEncUpGrading_NVEncUpGrading
if errorlevel 1 goto CodificaCQPNVEncUpGrading_NVEncUpGrading

:CodificaVBRNVEncUpGrading_NVEncUpGrading
set "TipoCodificaNVEnc=--vbr "
set /a "quantizzazioneNVEnc=0"
goto inserimentoValoriCQPVBRNVEncUpGrading_NVEncUpGrading

:CodificaCQPNVEncUpGrading_NVEncUpGrading
set "TipoCodificaNVEnc=--cqp "
set /a "quantizzazioneNVEnc=1"

:inserimentoValoriCQPVBRNVEncUpGrading_NVEncUpGrading

if !quantizzazioneNVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneNVEnc=!t44! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneNVEnc!") do set var=!valoreQuantizzazioneNVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                goto inserimentoValoriCQPVBRNVEncUpGrading_NVEncUpGrading
                                                ) 

                                set /a "valoreQuantizzazioneNVEnc=!valoreQuantizzazioneNVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneNVEnc!
                                if !valoreQuantizzazioneNVEnc! GEQ 10 if !valoreQuantizzazioneNVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneNVEnc!
                                                                                                                set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreQuantizzazioneNVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                                goto fineQuantizzazioneNVEncUpGrading_NVEncUpGrading
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRNVEncUpGrading_NVEncUpGrading
                                                                                                                        
                                )



if !quantizzazioneNVEnc!==0 (
                                echo.
                                set /p "valoreBitRateNVEnc=!t46! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateNVEnc!") do set var=!valoreBitRateNVEnc!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                goto inserimentoValoriCQPVBRNVEncUpGrading_NVEncUpGrading
                                                ) 
                                set /a "valoreBitRateNVEnc=!valoreBitRateNVEnc!"
                                @REM echo valoreBitRateNVEnc = !valoreBitRateNVEnc!
                                if !valoreBitRateNVEnc! GEQ 100 if !valoreBitRateNVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateNVEnc!
                                                                                                        set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreBitRateNVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                        goto fineQuantizzazioneNVEncUpGrading_NVEncUpGrading
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRNVEncUpGrading_NVEncUpGrading
                                                                                                              
                                )


:fineQuantizzazioneNVEncUpGrading_NVEncUpGrading


echo.
echo !t50!
echo.
echo 1) P1 !t51!
echo 2) P2 
echo 3) P3 
echo 4) P4 
echo 5) P5 
echo 6) P6 
echo 7) P7 !t52!
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto P7NVEncUpGrading_NVEncUpGrading
if errorlevel 6 goto P6NVEncUpGrading_NVEncUpGrading
if errorlevel 5 goto P5NVEncUpGrading_NVEncUpGrading
if errorlevel 4 goto P4NVEncUpGrading_NVEncUpGrading
if errorlevel 3 goto P3NVEncUpGrading_NVEncUpGrading
if errorlevel 2 goto P2NVEncUpGrading_NVEncUpGrading
if errorlevel 1 goto P1NVEncUpGrading_NVEncUpGrading


:P7NVEncUpGrading_NVEncUpGrading
set "SettaggioQualitaNVEnc=--preset P7"
set "QualitySetting=P7"
goto fineQualitCodificaNVEncUpGrading_NVEncUpGrading 

:P6NVEncUpGrading_NVEncUpGrading
set "SettaggioQualitaNVEnc=--preset P6"
set "QualitySetting=P6"
goto fineQualitCodificaNVEncUpGrading_NVEncUpGrading 

:P5NVEncUpGrading_NVEncUpGrading
set "SettaggioQualitaNVEnc=--preset P5"
set "QualitySetting=P5"
goto fineQualitCodificaNVEncUpGrading_NVEncUpGrading 

:P4NVEncUpGrading_NVEncUpGrading
set "SettaggioQualitaNVEnc=--preset P4"
set "QualitySetting=P4"
goto fineQualitCodificaNVEncUpGrading_NVEncUpGrading 

:P3NVEncUpGrading_NVEncUpGrading
set "SettaggioQualitaNVEnc=--preset P3"
set "QualitySetting=P3"
goto fineQualitCodificaNVEncUpGrading_NVEncUpGrading 

:P2NVEncUpGrading_NVEncUpGrading
set "SettaggioQualitaNVEnc=--preset P2"
set "QualitySetting=P2"
goto fineQualitCodificaNVEncUpGrading_NVEncUpGrading 

:P1NVEncUpGrading_NVEncUpGrading
set "SettaggioQualitaNVEnc=--preset P1"
set "QualitySetting=P1"
goto fineQualitCodificaNVEncUpGrading_NVEncUpGrading 


:fineQualitCodificaNVEncUpGrading_NVEncUpGrading 
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaNVEnc!


echo.
echo !t71!
echo !t72!
echo.
echo 1) NVEnc Color Correction 
echo 2) LibPlacebo Color Correction 
echo 3) NVidia Color Correction 

echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto NVidiaColorCorrectionUpGrading_NVEncUpGrading
if errorlevel 2 goto LibPlaceboColorCorrectionUpGradingNVEnc_NVEncUpGrading 
if errorlevel 1 goto NVEncColorCorrectionUpGrading_NVEncUpGrading 

:NVEncColorCorrectionUpGrading_NVEncUpGrading 
set "NVEncColorCorrectionSystem=--vpp-colorspace colorprim=bt709:bt2020,transfer=bt709:smpte2084,matrix=bt709:bt2020nc --vpp-tweak brightness=0.1,contrast=1.2,saturation=1.1"
set "NVEncUpgrader=NVEnc Color Correction"
goto NVEncFineSelezioneUpGrader_NVEncUpGrading

:LibPlaceboColorCorrectionUpGradingNVEnc_NVEncUpGrading 
set "NVEncColorCorrectionSystem=--vpp-libplacebo-tonemapping src_csp=sdr,dst_csp=hdr10"
set "NVEncUpgrader=LibPlacebo Color Correction"
goto NVEncFineSelezioneUpGrader_NVEncUpGrading

:NVidiaColorCorrectionUpGrading_NVEncUpGrading
set "NVEncColorCorrectionSystem=--vpp-ngx-truehdr"
set "NVEncUpgrader=NVidia Color Correction"

:NVEncFineSelezioneUpGrader_NVEncUpGrading
echo.
echo !t73! !NVEncUpgrader!
echo.
echo !t43! !NVEncColorCorrectionSystem!



:sceltadenoiser
set conv3d1080p=
set pmd1080p=
set /a unicopassaggio=0

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t55!"
    if errorlevel 2 goto conv3dChoosenNoNVEncUpGrading_NVEncUpGrading
    if errorlevel 1 goto conv3dChoosenYesNVEncUpGrading_NVEncUpGrading
)

echo.
CHOICE /N /C:SN /M "!t55!"

if errorlevel 2 goto conv3dChoosenNoNVEncUpGrading_NVEncUpGrading
if errorlevel 1 goto conv3dChoosenYesNVEncUpGrading_NVEncUpGrading

:conv3dChoosenNoNVEncUpGrading_NVEncUpGrading
set "conv3d1080p=N"
goto sceltaDeniserPMDNVEncUpGrading_NVEncUpGrading

:conv3dChoosenYesNVEncUpGrading_NVEncUpGrading
set "conv3d1080p=S"



:sceltaDeniserPMDNVEncUpGrading_NVEncUpGrading

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t56!"
    if errorlevel 2 goto PMDChoosenNoNVEncUpGrading_NVEncUpGrading
    if errorlevel 1 goto PMDChoosenYesNVEncUpGrading_NVEncUpGrading
)

echo.
CHOICE /N /C:SN /M "!t56!"

if errorlevel 2 goto PMDChoosenNoNVEncUpGrading_NVEncUpGrading
if errorlevel 1 goto PMDChoosenYesNVEncUpGrading_NVEncUpGrading

:PMDChoosenNoNVEncUpGrading_NVEncUpGrading
set "pmd1080p=N"
goto assegnazioneDenoisesNVEncUpGrading_NVEncUpGrading

:PMDChoosenYesNVEncUpGrading_NVEncUpGrading
set "pmd1080p=S"


:assegnazioneDenoisesNVEncUpGrading_NVEncUpGrading
set /A nvdenv=0

if !conv3d1080p!==S if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00 --vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )
if !conv3d1080p!==S if !pmd1080p!==N ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )
if !conv3d1080p!==N if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )
if !conv3d1080p!==N if !pmd1080p!==N ( 
                                        set "nvdenoiser=" 
                                        set "nvdenv=1"
                                        set "unicopassaggio=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: Nessun Denoiser 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )


echo.
if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t57!"
    if errorlevel 2 goto ApplicaMiglioramentoDettagliNVEncNo_NVEncUpGrading
    if errorlevel 1 goto ApplicaMiglioramentoDettagliNVEncSi_NVEncUpGrading
)
CHOICE /N /C:SN /M "!t57!"

if errorlevel 2 goto ApplicaMiglioramentoDettagliNVEncNo_NVEncUpGrading
if errorlevel 1 goto ApplicaMiglioramentoDettagliNVEncSi_NVEncUpGrading

:ApplicaMiglioramentoDettagliNVEncNo_NVEncUpGrading
set "miglioramento1080p=N"
goto fineSceltaMigliaramentiNVEnc_NVEncUpGrading

:ApplicaMiglioramentoDettagliNVEncSi_NVEncUpGrading
set "miglioramento1080p=S"

:fineSceltaMigliaramentiNVEnc_NVEncUpGrading
if !miglioramento1080p!==S ( 
                                set "edgeleveling=--vpp-edgelevel strength=10.0,threshold=24.0,black=6,white=0" 
                                echo.
                                echo NVEnc !t58!
                                echo.
                                )
if !miglioramento1080p!==N ( 
                                set "edgeleveling=" 
                                echo.
                                echo NVEnc !t59!
                                echo.
                                )





rem//////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////


echo.
echo !t75!
echo.


set file_senza_virgolette=%NomeFile:"=%
rem echo %file_senza_virgolette%

set file_senza_estensione=%file_senza_virgolette:.mkv=%
rem echo %file_senza_estensione%

set fileoutput2160p="%file_senza_estensione%_UpGraded_10bit_hdr10.mkv"

rem echo fileoutput2160p = %fileoutput2160p%


set fileoutput2160p_senza_virgolette=%fileoutput2160p:"=% 
rem echo %fileoutput2160p_senza_virgolette%

for %%i in ("%fileoutput2160p_senza_virgolette%") do (  
                                                        set "solo_nome_file=%%~ni"
                                                        rem echo Nome file: !solo_nome_file!

                                                        set "solo_estensione_file=%%~xi"
                                                        rem echo Estensione: !solo_estensione_file!
                                                    )

set fileoutput2160p_rinominato=!solo_nome_file!_rinominato!solo_estensione_file!

rem echo fileoutput2160p_rinominato = %fileoutput2160p_rinominato%

if exist ".\temp\Temp_HDR10_Stream.txt" ( del .\temp\Temp_HDR10_Stream.txt )
if exist ".\temp\durata_film.txt" ( del .\temp\durata_film.txt )
if exist ".\temp\crop.txt" ( del .\temp\crop.txt )
if exist ".\temp\risultato_multiplo.txt" ( del .\temp\risultato_multiplo.txt )
if exist ".\temp\crop_multiplo.txt" ( del .\temp\crop_multiplo.txt )
if exist ".\temp\crop_finale.txt" ( del .\temp\crop_finale.txt )

rem pause 

".\bin\nvenc\NVEncC64.exe" --avsw --device 0 -i %NomeFile%  !cropff!  --output-res !width4k!x!height4k! --video-metadata clear --metadata clear --chapter-copy -c hevc !tipoQuantizzazioneNVEnc! --bref-mode disabled !SettaggioQualitaNVEnc! --lookahead 32 --aq --aq-temporal --aq-strength 15 --profile main10 --level auto --tier high --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display "G(13250,34500)B(7500,3000)R(34000,16000)WP(15635,16450)L(10000000,1)" --max-cll "1000,400" --output-depth 10 --multipass None --mv-precision Q-pel --avsync cfr --psnr --ssim     -m default_mode:infer_no_subs    !nvdenoiser!  !NVEncColorCorrectionSystem!  --vpp-resize algo=lanczos4  !edgeleveling!   --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o %fileoutput2160p%

ren %fileoutput2160p% "%fileoutput2160p_rinominato%"


echo.
echo !t76!
echo.




goto fineinfovideo_NVEncUpGrading




:novideofile2160p_NVEncUpGrading
echo !t63!
echo.


:fineinfovideo_NVEncUpGrading

if exist ".\saved\settings.dat" (
                                for /f "tokens=1,2 delims=|" %%a in (.\saved\settings.dat) do (
                                                                                                    rem echo %%a
                                                                                                    rem echo %%b
                                                                                                    set /a "shst=%%b"
                                                                                                    rem echo !shst!
                                                                                                    rem pause
                                                                                                    if !shst!==1 (
                                                                                                                echo !t1000!
                                                                                                                echo.
                                                                                                                shutdown /s
                                                                                                                set /a "delay=10"
                                                                                                                timeout /t !delay!
                                                                                                                exit
                                                                                                                )
                                                                                                                            
                                                                                                    )                                                                                                  
                                                                                                )


if exist ".\temp\Temp_HDR10_Stream.txt" ( del .\temp\Temp_HDR10_Stream.txt )
if exist ".\temp\durata_film.txt" ( del .\temp\durata_film.txt )
if exist ".\temp\crop.txt" ( del .\temp\crop.txt )
if exist ".\temp\risultato_multiplo.txt" ( del .\temp\risultato_multiplo.txt )
if exist ".\temp\crop_multiplo.txt" ( del .\temp\crop_multiplo.txt )
if exist ".\temp\crop_finale.txt" ( del .\temp\crop_finale.txt )
      




set waitenter=
set /P waitenter=!t65!
Endlocal
goto menuiniziale










rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:QSVEncUpGrading

cls
setLocal EnableExtensions EnableDelayedExpansion





for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoQSVEncUpGrading
)

if %lingua%==inglese (
    goto caricalinguaingleseQSVEncUpGrading
)



:caricalinguaingleseQSVEncUpGrading
@REM set t1=Insert Hardware Video Encoding Info UpGrading from 2160p 10 bit or 8 bit SDR to 2160p 10 bit HDR and Saving to Disk

set t2=Drag Here the Video File 2160p 8 bit SDR or 10 bit SDR to Convert to 10 bit HDR:  
@REM set t211=Video File 2160p 10 bit HDR to Convert to 1080p 8 bit SDR:  

set t3=File does not exist 
set t4=Info Video:  

set t5=The Inserted Video is 2160p 8bit SDR 
set t511=The Inserted Video is 2160p 10bit SDR 

set t6=The Inserted Video isn't 2160p 8bit or 10bit SDR 
set t7=Video Duration in seconds:
set t8=Video Duration in Minutes:
set t9=Interval between Frames for Crop Detection:
set t10= seconds
set t11=Black Bands Detection Started....
set t12=Crop Detection to Frame
set t13=to seconds
set t14=Done...
set t15=Original 2160p Video Width: 
set t16=Original 2160p Video Height:
set t17=Original Video 2160p Width Without Black Bars:
set t18=Original Video 2160p Height Without Black Bars:

set t171=Output Video 1080p Width Without Black Bars:
set t181=Outout Video 1080p Height Without Black Bars:

set t19=Adapting Video Resolution to Full 2160p Format...
set t20=Final 2160p Output Video Width:
set t21=Final 2160p Output Video Height:

set t22=Settings of Black Bands to Crop are Correct (Yes/No):
set t23=Manually Entering Black Band Values to Crop... 
set t24=Enter the Upper Black Band Value: 
set t25=Error Entering Upper Black Band Value... It's Not a Number. 
set t26=Enter the Lower Black Band Value: 
set t27=Error Entering Lower Black Band Value... It's Not a Number.
set t28=Enter the Left Black Band Value: 
set t29=Error Entering Left Black Band Value... It's Not a Number.
set t30=Enter the Right Black Band Value: 
set t31=Error Entering Right Black Band Value... It's Not a Number.
set t32=Upper Black Band:
set t33=Lower Black Band:
set t34=Left Black Band:
set t35=Right Black Band:
set t36=2160p Original Video Width without Black Bars:
set t37=2160p Original Video Height without Black Bars:

@REM set t361=1080p Video Width without Black Bars:
@REM set t371=1080p Video Height without Black Bars

set t38=Select Graphic Card you want to Encode with:
set t39=Choose (1/2):
set t40=Select Encoding Type:
set t41=Error Entering Quantization Value... Not a Number. 
set t42=Quantization Value Set to:
set t43=Encoding Settings:
set t44=Enter Quantization value Minimum 10 Maximum 28:
set t45=Quantization Value Out of  Limits  10 / 28  Re-enter^!
set t46=Enter BitRate Value kbs Minimum 100 Maximum 50000:
set t47=Error Entering BitRate Value... It's Not a Number. 
set t48=BitRate Value Set to:
set t49=BitRate Value Out of Limits  100 / 50000  Re-enter^!
set t50=Select Encoding Quality:
set t51=- Worst Quality
set t52=- Best Quality
set t53=Choose (1/2/3/4/5/6/7):
set t54=Quality Set to:
set t55=Apply Convolution3D denoiser Yes/No: 
set t56=Apply PMD denoiser Yes/No: 
set t57=Apply Detail Enhancement Yes/No:  
set t58=Enhancement Detail: Yes 
set t59=Enhancement Detail: No 
set t60=Info
set t61=Videos to Encode Saved!
set t62=Do You Want to Insert Another Video to Encode (Yes/No):
set t63=The dragged file is not a video!
set t64=Choose (1/2/3/4):
set t65=Press Enter to back to Main Menu.  

set t66=Video Width
set t67=Video Height
set t68=Video Codec
set t69=Details Video Codec
set t70=Video Format 
set t71=Configuration Settings to convert video from 8bit or 10bit SDR to 10bit HDR
set t72=Select Encoding UpGrader:
set t73=Settings UpGrader:
set t74=Choose (1/2/3):

set t75=UpGrading Started.... 
set t76=Encoding Finished...
set t77=Now the PC will be turned off... 

goto avvio_QSVEncUpGrading




:caricalinguaitalianoQSVEncUpGrading
@REM set t1=Inserimento Info Codifica Hardware Video UpGrading da 2160p 10 bit o 8 bit SDR a 10 bit HDR e Salvataggio su Disco.

set t2=Trascina Qui il File Video 2160p 8 bit o 10 bit SDR da Convertire in 10 bit HDR:  
@REM set t211=File Video 2160p 8 bit o [923m10 bit SDR da Convertire in 10 bit HDR:  

set t3=File Inesistente 
set t4=Informazioni Video:  

set t5=Il Video inserito e' 2160p 8bit SDR 
set t511=Il Video inserito e' 2160p 10bit SDR 

set t6=Il Video inserito non e' 2160p 8bit o 10bit SDR 

set t7=Durata del Video in secondi:
set t8=Durata del video in Minuti:
set t9=Intervallo tra i Fotogrammi per il Rilevamento del crop:
set t10= secondi
set t11=Rilevamento Bande Nere Iniziato....
set t12=Rilevazione crop fotogramma
set t13=a secondi
set t14=Eseguita...
set t15=Larghezza Video 2160p Originale:
set t16=Altezza Video 2160p Originale:
set t17=Larghezza Video Originale 2160p  Senza Barre Nere:
set t18=Altezza Video Originale 2160p  Senza Barre Nere:

set t171=Larghezza Video 1080p  Senza Barre Nere:
set t181=Altezza Video 1080p  Senza Barre Nere:

set t19=Adattamento della Risoluzione del Video al Pieno Formato 2160p..
set t20=Larghezza Finale Video 2160p:
set t21=Altezza Finale Video 2160p:

set t22=Le Impostazioni delle Bande Nere da Tagliare sono Corrette (Si/No):
set t23=Inserimento Manuale Valori Bande Nere da Tagliare.. 
set t24=Inserisci il Valore della Banda Nera Superiore: 
set t25=Errore nell'Inserimento del Valore della Banda Nera Superiore... Non e' un Numero. 
set t26=Inserisci il Valore della Banda Nera Inferiore: 
set t27=Errore nell'Inserimento del Valore della Banda Nera Inferiore... Non e' un Numero. 
set t28=Inserisci il Valore della Banda Nera Sinistra: 
set t29=Errore nell'Inserimento del Valore della Banda Nera Sinistra... Non e' un Numero. 
set t30=Inserisci il Valore della Banda Nera Destra: 
set t31=Errore nell'Inserimento del Valore della Banda Nera Destra... Non e' un Numero. 
set t32=Banda Nera Superiore:
set t33=Banda Nera Inferiore:
set t34=Banda Nera Sinistra:
set t35=Banda Nera Destra:
set t36=Larghezza Video Originale 2160p senza Bande Nere:
set t37=Altezza Video Originale 2160p senza Bande Nere:

@REM set t361=Larghezza Video 1080p senza Bande Nere:
@REM set t371=Altezza Video 1080p senza Bande Nere:

set t38=Selezionare Scheda Grafica con cui Eseguire la Codifica:
set t39=Scegli (1/2):
set t40=Selezionare tipo di Codifica:
set t41=Errore nell'Inserimento del Valore della Quantizzazione... Non e' un Numero. 
set t42=Valore Quantizzazzione Impostato a:
set t43=Parametri per codifica:

set t44=Inserire Valore Quantizzazione Minimo 10 Massimo 28:
set t45=Valore Quantizzazzione al di fuori dei  Limiti  10 / 28  Reinserire^!
set t46=Inserire Valore BitRate kbs Minimo 100 Massimo 50000:
set t47=Errore nell'Inserimento del Valore del BitRate... Non e' un Numero. 
set t48=Valore BitRate Impostato a:
set t49=Valore  BitRate al di fuori dei  Limiti  100 / 50000  Reinserire^!

set t50=Selezionare Qualita' Codifica:
set t51=- Peggiore Qualita'
set t52=- Migliore Qualita'
set t53=Scegli (1/2/3/4/5/6/7):
set t54=Qualita' Impostata su:
set t55=Applicare il denoiser Convolution3D Si/No: 
set t56=Applicare il denoiser PMD Si/No: 
set t57=Applicare il Miglioramento Dettagli Si/No:  
set t58=Miglioramento Dettagli: Si 
set t59=Miglioramento Dettagli: No 
set t60=Informazioni
set t61=Video da Codificare Salvate!
set t62=Vuoi Inserire un altro Video da Codificare (Si/No):
set t63=Il file trascinato non e' un video!
set t64=Scegli (1/2/3/4):
set t65=Premi Invio per tornare al Menu' Principale.  

set t66=Larghezza Video
set t67=Altezza Video
set t68=Codec Video
set t69=Codec Video Dettagli
set t70=Format Video 
set t71=Configurazione Parametri per convertire il video da 8bit o 10bit SDR a 10bit HDR
set t72=Selezionare UpGrader Codifica:
set t73=UpGrader Impostato:
set t74=Scegli (1/2/3):

set t75=UpGrading Iniziato.... 
set t76=Codifica Terminata...
set t77=Il PC ora verra' Spento... 

goto avvio_QSVEncUpGrading

:avvio_QSVEncUpGrading





set /a "numeromovie=1"


:altrivideodainserire_QSVEncUpGrading


set NomeFile2160ppuliziadettaggli=
rem set MetadatiStreamHDR10=

set /P NomeFile2160ppuliziadettaggli=!t2! 
rem echo Hai digitato: %NomeFile%
rem pause

set "NomeFileSorgente=!NomeFile2160ppuliziadettaggli:"=!"
@REM echo NomeFileSorgente = !NomeFileSorgente!
set "NomeFile=^"!NomeFileSorgente!^""
@REM echo NomeFile = !NomeFile!
rem pause


if exist %NomeFile% ( goto infovideo_QSVEncUpGrading ) else ( 
                                                        echo.
                                                        echo !t3!
                                                        echo.
                                                        goto fineinfovideo_QSVEncUpGrading
                                                        )    



:infovideo_QSVEncUpGrading
echo.
echo !t4!
echo.

.\bin\ffprobe -v error -hide_banner -select_streams v:0 -show_entries stream=width,height,codec_name,codec_long_name,pix_fmt,color_space,color_transfer,color_primaries -of default=noprint_wrappers=1 !NomeFile! > ".\temp\Temp_HDR10_Stream.txt"

set /A x1=1
set /A nohdrcs=0
set /A nohdrct=0
set /A nohdrcp=0
set /A wv=0
set /a hv=0
set /A fv=0

rem echo nohdr = %nohdr%

for /f "tokens=1,2 delims==" %%a in (.\temp\Temp_HDR10_Stream.txt) do (if !x1!==3 ( 
                                                                            echo !t66! "%%a" = %%b  
                                                                            set /A "widthvideo=%%b"
                                                                            rem echo widthvideo = !widthvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !widthvideo! LEQ 3840 if !widthvideo! GEQ 2000 (set /A "wv=1"
                                                                                                                                rem echo wv = !wv!
                                                                                                                                )
                                                                            )
                                                                if !x1!==4 ( 
                                                                            echo !t67! "%%a" = %%b  
                                                                            set /A "heightvideo=%%b"
                                                                            rem echo heightvideo = !heightvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !heightvideo! LEQ 2160 if !heightvideo! GEQ 1400 (set /A "hv=1"
                                                                                                        rem echo hv = !hv!
                                                                                                        )
                                                                            )                                                           
                                                                if !x1!==6 ( 
                                                                            echo Color Space "%%a" = %%b  
                                                                            set "colorsp=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colorsp!==bt709 (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorsp!==unknown (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorsp!==reserved (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                    
                                                                            ) 
                                                                if !x1!==7 ( 
                                                                            echo Color Transfer "%%a" = %%b  
                                                                            set "colortr=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colortr!==bt709 (set /A "nohdrct=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colortr!==unknown (set /A "nohdrct=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colortr!==reserved (set /A "nohdrct=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                    
                                                                            ) 
                                                                if !x1!==8 ( 
                                                                            echo Color Primaries "%%a" = %%b  
                                                                            set "colorpr=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colorpr!==bt709 (set /A "nohdrcp=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorpr!==unknown (set /A "nohdrcp=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorpr!==reserved (set /A "nohdrcp=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                
                                                                            )    
                                                                if !x1!==1 ( 
                                                                            echo !t68! "%%a" = %%b  
                                                                            )       
                                                                if !x1!==2 ( 
                                                                            echo !t69! "%%a" = %%b  
                                                                            )   
                                                                if !x1!==5 ( 
                                                                            echo !t70! "%%a" = %%b  
                                                                            set "formatvideo=%%b"
                                                                            rem echo formatvideo = !formatvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !formatvideo!==yuv420p (set /A "fv=1"
                                                                                                        rem echo fv = !fv!
                                                                                                        )
                                                                            if !formatvideo!==yuv420p10le (set /A "fv=1"
                                                                                                        rem echo fv = !fv!
                                                                                                        )
                                                                            )
                                                                set /A x1+=1                                                            
)
echo.

if !x1!==1 goto novideofile2160p_QSVEncUpGrading


if !nohdrcs!==1 if !nohdrct!==1 if !nohdrcp!==1 if !wv!==1 if !hv!==1 if !fv!==1 ( 
                                                                                   if !formatvideo!==yuv420p10le (
                                                                                                                    echo !t511!
                                                                                                                    goto rilevazionebandenere_QSVEncUpGrading
                                                                                                                    ) 
                                                                                   if !formatvideo!==yuv420p (                                 
                                                                                                                echo !t5!
                                                                                                                goto rilevazionebandenere_QSVEncUpGrading
                                                                                                                )
                                                                                   ) 
echo !t6!
echo.
goto fineinfovideo_QSVEncUpGrading


rem//////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////


:rilevazionebandenere_QSVEncUpGrading
.\bin\ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 %NomeFile%  > ".\temp\durata_film.txt"

set /a contatore=1
for /f "tokens=1 delims=." %%a in (.\temp\durata_film.txt) do  (
                                                        echo. 
                                                        echo !t7! %%a
                                                        set /a "secondi=%%a"
                                                        set /a "minuti=!secondi!/60"
                                                        echo !t8! !minuti!
                                                        set /a "intervallo_tagli=!secondi!/11"
                                                        echo !t9! !intervallo_tagli!!t10!
                                                        echo.
                                                        echo !t11!
                                                        echo.

                                                        

                                                        FOR /L %%a IN (1, 1, 10) DO (
                                                                                    rem echo %%a
                                                                                    set /a "secondi=%%a*!intervallo_tagli!"
                                                                                    rem echo !secondi!

                                                                                    
                                                                                    if !formatvideo!==yuv420p (
                                                                                                                set /a "ca=16"
                                                                                                                rem echo !ca!
                                                                                                                    
                                                                                                                set /a "cb=2"
                                                                                                                rem echo !cb!
                                                                                                                    
                                                                                                                set /a "cc=0"
                                                                                                                rem echo !cc!

                                                                                                                set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                                                rem echo !cr!
                                                                                                                )

                                                                                    if !formatvideo!==yuv420p10le  ( 
                                                                                                                    set /a "ca=72"
                                                                                                                    rem echo !ca!
                                                                                                                    
                                                                                                                    set /a "cb=2"
                                                                                                                    rem echo !cb!
                                                                                                                    
                                                                                                                    set /a "cc=0"
                                                                                                                    rem echo !cc!

                                                                                                                    set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                                                    rem echo !cr!
                                                                                                                    )                  
        
                                                                                
                                                                                    .\bin\ffmpeg -ss !secondi! -hide_banner -nostats -i %NomeFile% -vframes 10 -vf !cr! -f null - 2> ".\temp\crop.txt"
                                                                                    
                                                                                    findstr /r "Parsed_cropdetect_0" .\temp\crop.txt >> .\temp\risultato_multiplo.txt   
                                                                                    
                                                                                    echo !t12! %%a !t13! !secondi! !t14!
                                                                                    
                                                                                    )       
                                                                                       

                                                                                    for /f "tokens=1,2 delims==" %%a in (.\temp\risultato_multiplo.txt) do ( echo %%b >> .\temp\crop_multiplo.txt )
                                                                                    
                                                                                    set /a "maxfrequenza=0"

                                                                                    for /f "delims=" %%a in (.\temp\crop_multiplo.txt) do ( 
                                                                                                                                    set "cropconfront=%%a"
                                                                                                                                    rem echo "!cropconfront!"
                                                                                                                                    
                                                                                                                                    set /a "contatorfrequenza=0"
                                                                                                                                    for /f "delims=" %%b in (.\temp\crop_multiplo.txt) do (
                                                                                                                                                                                    set "dato_da_verificare=%%b"
                                                                                                                                                                                    rem echo cropconfront = "!cropconfront!"
                                                                                                                                                                                    rem echo dato_da_verificare = "!dato_da_verificare!"
                                                                                                                                                                                    if !cropconfront!==!dato_da_verificare! ( set /a "contatorfrequenza+=1")
                                                                                                                                                                                    )
                                                                                                                                    if !maxfrequenza! LSS !contatorfrequenza! ( 
                                                                                                                                                                                set /a "maxfrequenza=!!contatorfrequenza!!"
                                                                                                                                                                                set "cropd=!cropconfront!"
                                                                                                                                                                                )
                                                                                                                                    

                                                                                                                                    rem if !cropconfront! in (elenco_crop_frequenza.txt) ()
                                                                                                                                    rem echo !cropconfront!:!contatorfrequenza! >> elenco_crop_frequenza.txt

                                                                                                                                    )

                                                                                    rem echo crop piu' frequente = !cropd! con grequenza = !maxfrequenza!
                                                                                    echo !cropd! > .\temp\crop_finale.txt

                                                                                    for /f "tokens=1,2,3,4 delims=:" %%a in (.\temp\crop_finale.txt) do  ( 
                                                                                                                                                    rem set /a "mwidth=%%a"
                                                                                                                                                    rem echo mwidth = !mwidth!

                                                                                                                                                    rem set /a "mheight=%%b"
                                                                                                                                                    rem echo mheight = !mheight!

                                                                                                                                                    rem set /a "mx=%%c"
                                                                                                                                                    rem echo mx = !mx!

                                                                                                                                                    rem set /a "my=%%d"
                                                                                                                                                    rem echo my = !my!

                                                                                                                                                    if !contatore!==1 ( 
                                                                                                                                                                set /a "wmax=%%a" 
                                                                                                                                                                set /a "hmax=%%b"
                                                                                                                                                                set /a "xmin=%%c"
                                                                                                                                                                set /a "ymin=%%d"
                                                                                                                                                                set /a "mwidth=%%a"
                                                                                                                                                                set /a "mheight=%%b"
                                                                                                                                                                set /a "mx=%%c"
                                                                                                                                                                set /a "my=%%d"
                                                                                                                                                                set /a "contatore+=1"
                                                                                                                                                                )
                                                                                                                                                    
                                                                                                                                                    rem if %%b gtr !hmax! if %%c gtr !xmin! if %%d gtr !ymin! 

                                                                                                                                                    if %%a geq !wmax! if %%b geq !hmax! ( 
                                                                                                                                                                        set /a "wmax=%%a" 
                                                                                                                                                                        set /a "hmax=%%b"
                                                                                                                                                                        set /a "xmin=%%c"
                                                                                                                                                                        set /a "ymin=%%d"
                                                                                                                                                                        set /a "mwidth=%%a"
                                                                                                                                                                        set /a "mheight=%%b"
                                                                                                                                                                        set /a "mx=%%c"
                                                                                                                                                                        set /a "my=%%d"
                                                                                                                                                                        )
                                                                                                                                                    )
                                                                                    echo.
                                                                                    set /a "csup=!my!"
                                                                                    rem echo csup = !csup!
                                                                                                                                    
                                                                                    set /a "csin=!mx!"
                                                                                    rem echo csin = !csin!

                                                                                    set /a "cinf=!heightvideo!-!mheight!-!my!"
                                                                                    rem echo movieheightreal = !movieheightreal!
                                                                                    rem echo cinf = !cinf!
                                                                                    set /a "cdes=!widthvideo!-!mwidth!-!mx!"
                                                                                    rem echo cdes = !cdes!

                                                                                    echo Crop Settings: --crop !csin!,!csup!,!cdes!,!cinf!  
                                                                                    set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"  
                                                                                    echo.  
                                                                                    
                                                                                    set /a "mwidthc=(!widthvideo!-!csin!-!cdes!)/2*2"
                                                                                    set /a "mheightc=(!heightvideo!-!csup!-!cinf!)/2*2"


                                                                                    echo !t17!  !mwidthc! 
                                                                                    echo !t18!  !mheightc! 
                                                                                    echo.
                                                                                    
                                                                                    set /a "larghezza2160pnvenc=3840"
                                                                                    set /a "altezza2160pnvenc=2160"
                                                                                    @REM echo larghezza2160pnvenc = !larghezza2160pnvenc!                                    
                                                                                    @REM echo altezza2160pnvenc = !altezza2160pnvenc!     

                                                                                    set /a "differenzialelarghezza2160pnvenc=!larghezza2160pnvenc!-!mwidthc!"
                                                                                    set /a "differenzialealtezza2160pnvenc=!altezza2160pnvenc!-!mheightc!"
                                                                                    @REM echo differenzialelarghezza2160pnvenc = !differenzialelarghezza2160pnvenc!                                                                
                                                                                    @REM echo differenzialealtezza2160pnvenc = !differenzialealtezza2160pnvenc!

                                                                                    if !differenzialelarghezza2160pnvenc!==0 if !differenzialealtezza2160pnvenc! GTR 0 (
                                                                                                                                                                        @REM echo dentro il 1o if
                                                                                                                                                                        set /a "width4k=!mwidthc!"
                                                                                                                                                                        set /a "height4k=!mheightc!"
                                                                                                                                                                        )                        
                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                        if !differenzialelarghezza2160pnvenc! GTR 0 if !differenzialealtezza2160pnvenc!==0 (
                                                                                                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                                                                                                set /a "width4k=!mwidthc!"
                                                                                                                                                                                                                                                                set /a "height4k=!mheightc!"
                                                                                                                                                                                                                                                                ) else if !differenzialelarghezza2160pnvenc! LSS !differenzialealtezza2160pnvenc! (
                                                                                                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza2160pnvenc = !differenzialelarghezza2160pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza2160pnvenc = !differenzialealtezza2160pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                                                                                                        set /a "width4k=!mwidthc!+!differenzialelarghezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        set /a "height4k=!mheightc!+!differenzialelarghezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        @REM echo width4k = !width4k!
                                                                                                                                                                                                                                                                                                                                                        @REM echo height4k = !height4k!
                                                                                                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza2160pnvenc! GTR !differenzialealtezza2160pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "width4k=!mwidthc!+!differenzialealtezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo width4k = !width4k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "height4k=!mheightc!+!differenzialealtezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo height4k = !height4k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                        if !differenzialelarghezza2160pnvenc!==0 if !differenzialealtezza2160pnvenc!==0 (   
                                                                                                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                                                                                                        set /a "width4k=!mwidthc!"
                                                                                                                                                                                                                                                        set /a "height4k=!mheightc!"
                                                                                                                                                                                                                                                        )
                                                                                                                                                                                                                                                        
                                                                                                                                                                        if !differenzialelarghezza2160pnvenc!==!differenzialealtezza2160pnvenc! (   
                                                                                                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                                                                                                set /a "width4k=!mwidthc!+differenzialelarghezza2160pnvenc"
                                                                                                                                                                                                                                                set /a "height4k=!mheightc!+differenzialelarghezza2160pnvenc"
                                                                                                                                                                                                                                                )                                                                                        
                                                                                                                                                                

                                                                                                                                                                        echo !t19!
                                                                                                                                                                        echo.                         

                                                                                                                                                                        echo !t20!  !width4k! 
                                                                                                                                                                        echo !t21!  !height4k!    
                                                                                                                                                                        echo.

                                                                                                                                                                    ) 

                                                                                    ) 
                                                        )                          
                                                  

:cropmanuale_QSVEncUpGrading
set /a "csup=0"
set /a "cinf=0"
set /a "csin=0"
set /a "cdes=0"
set /a "bandasuperiore=0"
set /a "bandainferiore=0"
set /a "bandasinistra=0"
set /a "bandadestra=0"
set /a "differenzialelarghezza2160pnvenc=0"
set /a "differenzialealtezza2160pnvenc=0"
if exist ".\temp\Temp_HDR10_Stream.txt" ( del ".\temp\Temp_HDR10_Stream.txt" ) 
if exist ".\temp\durata_film.txt" ( del ".\temp\durata_film.txt" )
if exist ".\temp\crop.txt" ( del ".\temp\crop.txt" )
if exist ".\temp\risultato_multiplo.txt" ( del ".\temp\risultato_multiplo.txt" )
if exist ".\temp\crop_multiplo.txt" ( del ".\temp\crop_multiplo.txt" )
if exist ".\temp\crop_finale.txt" ( del ".\temp\crop_finale.txt" )


if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t22!"   
    if errorlevel 2 goto cropmanualeNVEncUpGrading_QSVEncUpGrading
    if errorlevel 1 goto finecropNVEncUpGrading_QSVEncUpGrading
)

CHOICE /N /C:SN /M "!t22!"   

if errorlevel 2 goto cropmanualeNVEncUpGrading_QSVEncUpGrading
if errorlevel 1 goto finecropNVEncUpGrading_QSVEncUpGrading


:cropmanualeNVEncUpGrading_QSVEncUpGrading
echo.
echo !t23!
echo.

:banda_superiore_QSVEncUpGrading
set /p "bandasuperiore=!t24!"
SET "var="&for /f "delims=0123456789" %%i in ("!bandasuperiore!") do set var=!bandasuperiore!
if defined var (
                echo.
                echo !t25!
                echo.
                goto banda_superiore_QSVEncUpGrading
                ) else (
                        set /a "csup=!bandasuperiore!/2*2"
                        )

echo.
:banda_inferiore_QSVEncUpGrading
set /p "bandainferiore=!t26!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandainferiore!") do set var=!bandainferiore!
if defined var (
                echo.
                echo !t27!
                echo.
                goto banda_inferiore_QSVEncUpGrading
                ) else (
                        set /a "cinf=!bandainferiore!/2*2"
                        )


echo.
:banda_sinistra_QSVEncUpGrading
set /p "bandasinistra=!t28!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandasinistra!") do set var=!bandasinistra!
if defined var (
                echo.
                echo !t29!
                echo.
                goto banda_sinistra_QSVEncUpGrading
                ) else (
                        set /a "csin=!bandasinistra!/2*2"
                        )

                        
echo.
:banda_destra_QSVEncUpGrading
set /p "bandadestra=!t30!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandadestra!") do set var=!bandadestra!
if defined var (
                echo.
                echo !t31!
                echo.
                goto banda_destra_QSVEncUpGrading
                ) else (
                        set /a "cdes=!bandadestra!/2*2"
                        )


set /a "larghezza2160pnvenc=3840"
set /a "altezza2160pnvenc=2160"
@REM echo larghezza2160pnvenc = !larghezza2160pnvenc!                                    
@REM echo altezza2160pnvenc = !altezza2160pnvenc!                                    

set /a "mwidth=!widthvideo!/2*2"
set /a "mheight=!heightvideo!/2*2"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "mwidthc=!mwidth!-!csin!-!cdes!"
set /a "mheightc=!mheight!-!csup!-!cinf!"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "differenzialelarghezza2160pnvenc=!larghezza2160pnvenc!-!mwidthc!"
set /a "differenzialealtezza2160pnvenc=!altezza2160pnvenc!-!mheightc!"
@REM echo differenzialelarghezza2160pnvenc = !differenzialelarghezza2160pnvenc!                                                                
@REM echo differenzialealtezza2160pnvenc = !differenzialealtezza2160pnvenc!

echo.
echo !t32!  !csup! 
echo !t33!  !cinf! 
echo !t34!  !csin! 
echo !t35!  !cdes! 
echo.


set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
echo Crop Settings: !cropff!
echo.

echo !t36!  !mwidthc! 
echo !t37!  !mheightc! 
echo.



if !differenzialelarghezza2160pnvenc!==0 if !differenzialealtezza2160pnvenc! GTR 0 (
                                                                                        @REM echo dentro il 1o if
                                                                                        set /a "width4k=!mwidthc!"
                                                                                        set /a "height4k=!mheightc!"
                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                        if !differenzialelarghezza2160pnvenc! GTR 0 if !differenzialealtezza2160pnvenc!==0 (
                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                set /a "width4k=!mwidthc!"
                                                                                                                                                                                set /a "height4k=!mheightc!"
                                                                                                                                                                                ) else if !differenzialelarghezza2160pnvenc! LSS !differenzialealtezza2160pnvenc! (
                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza2160pnvenc = !differenzialelarghezza2160pnvenc!
                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza2160pnvenc = !differenzialealtezza2160pnvenc!
                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                        set /a "width4k=!mwidthc!+!differenzialelarghezza2160pnvenc!"
                                                                                                                                                                                                                                                                        set /a "height4k=!mheightc!+!differenzialelarghezza2160pnvenc!"
                                                                                                                                                                                                                                                                        @REM echo width4k = !width4k!
                                                                                                                                                                                                                                                                        @REM echo height4k = !height4k!
                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza2160pnvenc! GTR !differenzialealtezza2160pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                set /a "width4k=!mwidthc!+!differenzialealtezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo width4k = !width4k!
                                                                                                                                                                                                                                                                                                                                                                set /a "height4k=!mheightc!+!differenzialealtezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo height4k = !height4k!
                                                                                                                                                                                                                                                                                                                                                                )
                                                                                        if !differenzialelarghezza2160pnvenc!==0 if !differenzialealtezza2160pnvenc!==0 (   
                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                        set /a "width4k=!mwidthc!"
                                                                                                                                                                        set /a "height4k=!mheightc!"
                                                                                                                                                                        )
                                                                                                                                                                        
                                                                                        if !differenzialelarghezza2160pnvenc!==!differenzialealtezza2160pnvenc! (   
                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                set /a "width4k=!mwidthc!+differenzialelarghezza2160pnvenc"
                                                                                                                                                                set /a "height4k=!mheightc!+differenzialelarghezza2160pnvenc"
                                                                                                                                                                )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.                         

                                                                                        echo !t20!  !width4k! 
                                                                                        echo !t21!  !height4k!    
                                                                                        echo.

                                                                                    ) 

goto cropmanuale_QSVEncUpGrading

:finecropNVEncUpGrading_QSVEncUpGrading


rem//////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////


:InserimentoImpostazioniQSVEnc_QSVEncUpGrading


echo.
echo !t40!
echo.
echo 1) CQP 
echo 2) ICQ 
echo 3) LA-ICQ 
echo 4) VBR 
echo.
CHOICE /N /C:1234 /M "!t64!"

if errorlevel 4 goto CodificaVBRQSVEncUpGrading_QSVEncUpGrading
if errorlevel 3 goto CodificaLAICQQSVEncUpGrading_QSVEncUpGrading
if errorlevel 2 goto CodificaICQQSVEncUpGrading_QSVEncUpGrading
if errorlevel 1 goto CodificaCQPQSVEncUpGrading_QSVEncUpGrading


:CodificaCQPQSVEncUpGrading_QSVEncUpGrading
set "TipoCodificaQSVEnc=--cqp "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEncUpGrading_QSVEncUpGrading

:CodificaICQQSVEncUpGrading_QSVEncUpGrading
set "TipoCodificaQSVEnc=--icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEncUpGrading_QSVEncUpGrading

:CodificaLAICQQSVEncUpGrading_QSVEncUpGrading
set "TipoCodificaQSVEnc=--la-icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEncUpGrading_QSVEncUpGrading

:CodificaVBRQSVEncUpGrading_QSVEncUpGrading
set "TipoCodificaQSVEnc=--vbr "
set /a "quantizzazioneQSVEnc=0"
goto inserimentoValoriCQPVBRQSVEncUpGrading_QSVEncUpGrading


:inserimentoValoriCQPVBRQSVEncUpGrading_QSVEncUpGrading

if !quantizzazioneQSVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneQSVEnc=!t44! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneQSVEnc!") do set var=!valoreQuantizzazioneQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                goto inserimentoValoriCQPVBRQSVEncUpGrading_QSVEncUpGrading
                                                ) 

                                set /a "valoreQuantizzazioneQSVEnc=!valoreQuantizzazioneQSVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneQSVEnc!
                                if !valoreQuantizzazioneQSVEnc! GEQ 10 if !valoreQuantizzazioneQSVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneQSVEnc!
                                                                                                                set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreQuantizzazioneQSVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                                goto fineQuantizzazioneQSVEncUpGrading_QSVEncUpGrading
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRQSVEncUpGrading_QSVEncUpGrading
                                                                                                                        
                                )



if !quantizzazioneQSVEnc!==0 (
                                echo.
                                set /p "valoreBitRateQSVEnc=!t46! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateQSVEnc!") do set var=!valoreBitRateQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                goto inserimentoValoriCQPVBRQSVEncUpGrading_QSVEncUpGrading
                                                ) 
                                set /a "valoreBitRateQSVEnc=!valoreBitRateQSVEnc!"
                                @REM echo valoreBitRateQSVEnc = !valoreBitRateQSVEnc!
                                if !valoreBitRateQSVEnc! GEQ 100 if !valoreBitRateQSVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateQSVEnc!
                                                                                                        set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreBitRateQSVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                        goto fineQuantizzazioneQSVEncUpGrading_QSVEncUpGrading
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRQSVEncUpGrading_QSVEncUpGrading
                                                                                                              
                                )


:fineQuantizzazioneQSVEncUpGrading_QSVEncUpGrading



echo.
echo !t50!
echo.
echo 1) Best 
echo 2) Higher 
echo 3) High 
echo 4) Balanced 
echo 5) Fast 
echo 6) Faster 
echo 7) Fastest 
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto QualitFastestQSVEncUpGrading_QSVEncUpGrading
if errorlevel 6 goto QualitFasterQSVEncUpGrading_QSVEncUpGrading
if errorlevel 5 goto QualitFastQSVEncUpGrading_QSVEncUpGrading
if errorlevel 4 goto QualitBalancedtQSVEncUpGrading_QSVEncUpGrading
if errorlevel 3 goto QualitHighQSVEncUpGrading_QSVEncUpGrading
if errorlevel 2 goto QualitHigherQSVEncUpGrading_QSVEncUpGrading
if errorlevel 1 goto QualitBestQSVEncUpGrading_QSVEncUpGrading


:QualitBestQSVEncUpGrading_QSVEncUpGrading
set "SettaggioQualitaQSvenc=--quality best"
set "QualitySetting=best"
goto fineQualitCodificaQSVEncUpGrading_QSVEncUpGrading

:QualitHigherQSVEncUpGrading_QSVEncUpGrading
set "SettaggioQualitaQSvenc=--quality higher"
set "QualitySetting=higher"
goto fineQualitCodificaQSVEncUpGrading_QSVEncUpGrading

:QualitHighQSVEncUpGrading_QSVEncUpGrading
set "SettaggioQualitaQSvenc=--quality high"
set "QualitySetting=high"
goto fineQualitCodificaQSVEncUpGrading_QSVEncUpGrading

:QualitBalancedtQSVEncUpGrading_QSVEncUpGrading
set "SettaggioQualitaQSvenc=--quality balanced"
set "QualitySetting=balanced"
goto fineQualitCodificaQSVEncUpGrading_QSVEncUpGrading

:QualitFastQSVEncUpGrading_QSVEncUpGrading
set "SettaggioQualitaQSvenc=--quality fast"
set "QualitySetting=fast"
goto fineQualitCodificaQSVEncUpGrading_QSVEncUpGrading

:QualitFasterQSVEncUpGrading_QSVEncUpGrading
set "SettaggioQualitaQSvenc=--quality faster"
set "QualitySetting=faster"
goto fineQualitCodificaQSVEncUpGrading_QSVEncUpGrading

:QualitFastestQSVEncUpGrading_QSVEncUpGrading
set "SettaggioQualitaQSvenc=--quality fastest"
set "QualitySetting=fastest"
goto fineQualitCodificaQSVEncUpGrading_QSVEncUpGrading


:fineQualitCodificaQSVEncUpGrading_QSVEncUpGrading
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaQSvenc!




echo.
echo !t71!
echo !t72!
echo.
echo 1) QSVEnc Color Correction 
echo 2) LibPlacebo Color Correction 

echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto LibPlaceboColorCorrectionUpGradingQSVEnc_QSVEncUpGrading
if errorlevel 1 goto QSVEncColorCorrectionUpGrading_QSVEncUpGrading


:QSVEncColorCorrectionUpGrading_QSVEncUpGrading
set "QSVEncColorCorrectionSystem=--vpp-colorspace colorprim=bt709:bt2020,transfer=bt709:smpte2084,matrix=bt709:bt2020nc --vpp-tweak brightness=0.1,contrast=1.2,saturation=1.1"
set "QSVEncUpgrader=QSVEnc Color Correction"
goto QSVEncFineSelezioneUpGrader2_QSVEncUpGrading

:LibPlaceboColorCorrectionUpGradingQSVEnc_QSVEncUpGrading
set "QSVEncColorCorrectionSystem=--vpp-libplacebo-tonemapping src_csp=sdr,dst_csp=hdr10"
set "QSVEncUpgrader=LibPlacebo Color Correction"


:QSVEncFineSelezioneUpGrader2_QSVEncUpGrading
echo.
echo !t73! !QSVEncUpgrader!
echo.
echo !t43! !QSVEncColorCorrectionSystem!



:sceltadenoiser
set conv3d1080p=
set pmd1080p=
set /a unicopassaggio=0


if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t55!"
    if errorlevel 2 goto conv3dChoosenNoQSVEncUpGrading_QSVEncUpGrading
    if errorlevel 1 goto conv3dChoosenYesQSVEncUpGrading_QSVEncUpGrading
)

echo.
CHOICE /N /C:SN /M "!t55!

if errorlevel 2 goto conv3dChoosenNoQSVEncUpGrading_QSVEncUpGrading
if errorlevel 1 goto conv3dChoosenYesQSVEncUpGrading_QSVEncUpGrading

:conv3dChoosenNoQSVEncUpGrading_QSVEncUpGrading
set "conv3d1080p=N"
goto sceltaDeniserPMDQSVEncUpGrading_QSVEncUpGrading

:conv3dChoosenYesQSVEncUpGrading_QSVEncUpGrading
set "conv3d1080p=S"



:sceltaDeniserPMDQSVEncUpGrading_QSVEncUpGrading
if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t56!"
    if errorlevel 2 goto PMDChoosenNoQSVEncUpGrading_QSVEncUpGrading
    if errorlevel 1 goto PMDChoosenYesQSVEncUpGrading_QSVEncUpGrading
)
echo.
CHOICE /N /C:SN /M "!t56!"

if errorlevel 2 goto PMDChoosenNoQSVEncUpGrading_QSVEncUpGrading
if errorlevel 1 goto PMDChoosenYesQSVEncUpGrading_QSVEncUpGrading

:PMDChoosenNoQSVEncUpGrading_QSVEncUpGrading
set "pmd1080p=N"
goto assegnazioneDenoisesQSVEncUpGrading_QSVEncUpGrading

:PMDChoosenYesQSVEncUpGrading_QSVEncUpGrading
set "pmd1080p=S"


:assegnazioneDenoisesQSVEncUpGrading_QSVEncUpGrading
set /A nvdenv=0

if !conv3d1080p!==S if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00 --vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==S if !pmd1080p!==N ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==N ( 
                                        set "nvdenoiser=" 
                                        set "nvdenv=1"
                                        set "unicopassaggio=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: Nessun Denoiser 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )


if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t57!"
    if errorlevel 2 goto ApplicaMiglioramentoDettagliQSVEncNo_QSVEncUpGrading
    if errorlevel 1 goto ApplicaMiglioramentoDettagliQSVEncSi_QSVEncUpGrading
)

CHOICE /N /C:SN /M "!t57!"

if errorlevel 2 goto ApplicaMiglioramentoDettagliQSVEncNo_QSVEncUpGrading
if errorlevel 1 goto ApplicaMiglioramentoDettagliQSVEncSi_QSVEncUpGrading

:ApplicaMiglioramentoDettagliQSVEncNo_QSVEncUpGrading
set "miglioramento1080p=N"
goto fineSceltaMigliaramentiQSVEnc_QSVEncUpGrading

:ApplicaMiglioramentoDettagliQSVEncSi_QSVEncUpGrading
set "miglioramento1080p=S"

:fineSceltaMigliaramentiQSVEnc_QSVEncUpGrading
if !miglioramento1080p!==S ( 
                                set "edgeleveling=--vpp-edgelevel strength=10.0,threshold=24.0,black=6,white=0" 
                                echo.
                                echo QSVEnc !t58!
                                echo.
                                )
if !miglioramento1080p!==N ( 
                                set "edgeleveling=" 
                                echo.
                                echo QSVEnc !t59!
                                echo.
                                )





echo.
echo !t75!
echo.


set file_senza_virgolette=%NomeFile:"=%
rem echo %file_senza_virgolette%

set file_senza_estensione=%file_senza_virgolette:.mkv=%
rem echo %file_senza_estensione%

set fileoutput2160p="%file_senza_estensione%_UpGraded_10bit_hdr10.mkv"

rem echo fileoutput2160p = %fileoutput2160p%


set fileoutput2160p_senza_virgolette=%fileoutput2160p:"=% 
rem echo %fileoutput2160p_senza_virgolette%

for %%i in ("%fileoutput2160p_senza_virgolette%") do (  
                                                        set "solo_nome_file=%%~ni"
                                                        rem echo Nome file: !solo_nome_file!

                                                        set "solo_estensione_file=%%~xi"
                                                        rem echo Estensione: !solo_estensione_file!
                                                    )

set fileoutput2160p_rinominato=!solo_nome_file!_rinominato!solo_estensione_file!

rem echo fileoutput2160p_rinominato = %fileoutput2160p_rinominato%

if exist ".\temp\Temp_HDR10_Stream.txt" ( del .\temp\Temp_HDR10_Stream.txt )
if exist ".\temp\durata_film.txt" ( del .\temp\durata_film.txt )
if exist ".\temp\crop.txt" ( del .\temp\crop.txt )
if exist ".\temp\risultato_multiplo.txt" ( del .\temp\risultato_multiplo.txt )
if exist ".\temp\crop_multiplo.txt" ( del .\temp\crop_multiplo.txt )
if exist ".\temp\crop_finale.txt" ( del .\temp\crop_finale.txt )

rem pause 

".\bin\qsvencc\QSVEncC64.exe" --avsw --device auto -i %NomeFile%  !cropff!  --output-res !width4k!x!height4k! --video-metadata clear --metadata clear --chapter-copy -c hevc !tipoQuantizzazioneQSVEnc! !SettaggioQualitaQSVEnc! --la-depth 32  --level auto  --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display "G(13250,34500)B(7500,3000)R(34000,16000)WP(15635,16450)L(10000000,1)" --max-cll "1000,400" --output-depth 10  --avsync cfr --psnr --ssim     -m default_mode:infer_no_subs    !nvdenoiser!  !QSVEncColorCorrectionSystem!  --vpp-resize algo=lanczos4  !edgeleveling!   --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o %fileoutput2160p%

ren %fileoutput2160p% "%fileoutput2160p_rinominato%"


echo.
echo !t76!
echo.



goto fineinfovideo_QSVEncUpGrading




:novideofile2160p_QSVEncUpGrading
echo !t63!
echo.


:fineinfovideo_QSVEncUpGrading

if exist ".\saved\settings.dat" (
                                for /f "tokens=1,2 delims=|" %%a in (.\saved\settings.dat) do (
                                                                                                    rem echo %%a
                                                                                                    rem echo %%b
                                                                                                    set /a "shst=%%b"
                                                                                                    rem echo !shst!
                                                                                                    rem pause
                                                                                                    if !shst!==1 (
                                                                                                                echo !t77!
                                                                                                                echo.
                                                                                                                shutdown /s
                                                                                                                set /a "delay=10"
                                                                                                                timeout /t !delay!
                                                                                                                exit
                                                                                                                )
                                                                                                                            
                                                                                                    )                                                                                                  
                                                                                                )

if exist ".\temp\Temp_HDR10_Stream.txt" ( del .\temp\Temp_HDR10_Stream.txt )
if exist ".\temp\durata_film.txt" ( del .\temp\durata_film.txt )
if exist ".\temp\crop.txt" ( del .\temp\crop.txt )
if exist ".\temp\risultato_multiplo.txt" ( del .\temp\risultato_multiplo.txt )
if exist ".\temp\crop_multiplo.txt" ( del .\temp\crop_multiplo.txt )
if exist ".\temp\crop_finale.txt" ( del .\temp\crop_finale.txt )
      




set waitenter=
set /P waitenter=!t65!
Endlocal
goto menuiniziale








rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:QSVEncUpScaling

cls
setLocal EnableExtensions EnableDelayedExpansion



for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoQSVEncUpScaling
)

if %lingua%==inglese (
    goto caricalinguaingleseQSVEncUpScaling
)



:caricalinguaingleseQSVEncUpScaling
@REM set t1=Insert Hardware Video Encoding Info UpScaling and UpGrading from 1080p 8 bit or 10 bit SDR to 2160p 10 bit HDR and Saving to Disk

set t2=Drag Here the Video File 1080p 8 bit or 10 bit SDR to Convert to 2160p 10 bit HDR:  
@REM set t211=Video File 1080p 8 bit or 10 bit SDR to Convert to 2160p 10 bit HDR:  

set t3=File does not exist 
set t4=Info Video:  

set t5=The Inserted Video is 1080p 8bit SDR 
set t511=The Inserted Video is 1080p 10bit SDR 

set t6=The Inserted Video isn't 1080p 8bit or 10bit SDR 
set t7=Video Duration in seconds:
set t8=Video Duration in Minutes:
set t9=Interval between Frames for Crop Detection:
set t10= seconds
set t11=Black Bands Detection Started....
set t12=Crop Detection to Frame
set t13=to seconds
set t14=Done...
set t15=Original 2160p Video Width: 
set t16=Original 2160p Video Height:
set t17=Original Video 1080p Width Without Black Bars:
set t18=Original Video 1080p Height Without Black Bars:

set t171=Output Video 1080p Width Without Black Bars:
set t181=Outout Video 1080p Height Without Black Bars:

set t19=Adapting Video Resolution to Full 1080p Format...

set t191=Final 1080p Output Video Width:
set t192=Final 1080p Output Video Height:
set t20=Final 2160p Output Video Width:
set t21=Final 2160p Output Video Height:

set t22=Settings of Black Bands to Crop are Correct (Yes/No):
set t23=Manually Entering Black Band Values to Crop... 
set t24=Enter the Upper Black Band Value: 
set t25=Error Entering Upper Black Band Value... It's Not a Number. 
set t26=Enter the Lower Black Band Value: 
set t27=Error Entering Lower Black Band Value... It's Not a Number.
set t28=Enter the Left Black Band Value: 
set t29=Error Entering Left Black Band Value... It's Not a Number.
set t30=Enter the Right Black Band Value: 
set t31=Error Entering Right Black Band Value... It's Not a Number.
set t32=Upper Black Band:
set t33=Lower Black Band:
set t34=Left Black Band:
set t35=Right Black Band:
set t36=1080p Original Video Width without Black Bars:
set t37=1080p Original Video Height without Black Bars:

@REM set t361=1080p Video Width without Black Bars:
@REM set t371=1080p Video Height without Black Bars

set t38=Select Graphic Card you want to Encode with:
set t39=Choose (1/2):
set t40=Select Encoding Type:
set t41=Error Entering Quantization Value... Not a Number. 
set t42=Quantization Value Set to:
set t43=Encoding Settings:
set t44=Enter Quantization value Minimum 10 Maximum 28:
set t45=Quantization Value Out of  Limits  10 / 28  Re-enter^!
set t46=Enter BitRate Value kbs Minimum 100 Maximum 50000:
set t47=Error Entering BitRate Value... It's Not a Number. 
set t48=BitRate Value Set to:
set t49=BitRate Value Out of Limits  100 / 50000  Re-enter^!
set t50=Select Encoding Quality:
set t51=- Worst Quality
set t52=- Best Quality
set t53=Choose (1/2/3/4/5/6/7):
set t54=Quality Set to:
set t55=Apply Convolution3D denoiser Yes/No: 
set t56=Apply PMD denoiser Yes/No: 
set t57=Apply Detail Enhancement Yes/No:  
set t58=Enhancement Detail: Yes 
set t59=Enhancement Detail: No 
set t60=Info
set t61=Videos to Encode Saved!
set t62=Do You Want to Insert Another Video to Encode (Yes/No):
set t63=The dragged file is not a video!
set t64=Choose (1/2/3/4):
set t65=Press Enter to back to Main Menu. 

set t66=Video Width
set t67=Video Height
set t68=Video Codec
set t69=Details Video Codec
set t70=Video Format 
set t71=Configuration Settings to convert video from 8bit or 10bit SDR to 10bit HDR
set t72=Select Encoding UpGrader:
set t73=Settings UpGrader:
set t74=Choose (1/2/3):

set t75=Configuration UpScaling and UpGrading from 1080p 8 or 10 bit SDR to 2160p 10 bit HDR 
set t76=Select Operations to Perform:
set t77=1) First Pass Encode for Upscaling and a Second Pass Encode to Clean Up the Video and Enhance Details
set t78=2) Cleanup, Detail Enhancement and Upscaling in a Single Encode

set t79=UpScaling Started.... 
set t80=Denoiser and Detail Enhancement Application Started.... 
set t81=Encoding Finished...
set t82=Now the PC will be turned off... 

goto avvio_QSVEncUpScaling




:caricalinguaitalianoQSVEncUpScaling
@REM set t1=Inserimento Info Codifica Hardware Video UpScaling e UpGrading da 1080p 8 bit o 10 bit SDR a 2160p 10 bit HDR e Salvataggio su Disco.

set t2=Trascina Qui il File Video 1080p 8 bit o 10 bit SDR da Convertire in 2160p 10 bit HDR:  
@REM set t211=File Video 1080p 8 bit o [923m10 bit SDR da Convertire in 2160p 10 bit HDR:  

set t3=File Inesistente 
set t4=Informazioni Video:  

set t5=Il Video inserito e' 1080p 8bit SDR 
set t511=Il Video inserito e' 1080p 10bit SDR 

set t6=Il Video inserito non e' 1080p 8bit o 10bit SDR 

set t7=Durata del Video in secondi:
set t8=Durata del video in Minuti:
set t9=Intervallo tra i Fotogrammi per il Rilevamento del crop:
set t10= secondi
set t11=Rilevamento Bande Nere Iniziato....
set t12=Rilevazione crop fotogramma
set t13=a secondi
set t14=Eseguita...
set t15=Larghezza Video 2160p Originale:
set t16=Altezza Video 2160p Originale:
set t17=Larghezza Video Originale 1080p  Senza Barre Nere:
set t18=Altezza Video Originale 1080p  Senza Barre Nere:

set t171=Larghezza Video 1080p  Senza Barre Nere:
set t181=Altezza Video 1080p  Senza Barre Nere:

set t19=Adattamento della Risoluzione del Video al Pieno Formato 1080p..

set t191=Larghezza Finale Video 1080p:
set t192=Altezza Finale Video 1080p:
set t20=Larghezza Finale Video 2160p:
set t21=Altezza Finale Video 2160p:

set t22=Le Impostazioni delle Bande Nere da Tagliare sono Corrette (Si/No):
set t23=Inserimento Manuale Valori Bande Nere da Tagliare.. 
set t24=Inserisci il Valore della Banda Nera Superiore: 
set t25=Errore nell'Inserimento del Valore della Banda Nera Superiore... Non e' un Numero. 
set t26=Inserisci il Valore della Banda Nera Inferiore: 
set t27=Errore nell'Inserimento del Valore della Banda Nera Inferiore... Non e' un Numero. 
set t28=Inserisci il Valore della Banda Nera Sinistra: 
set t29=Errore nell'Inserimento del Valore della Banda Nera Sinistra... Non e' un Numero. 
set t30=Inserisci il Valore della Banda Nera Destra: 
set t31=Errore nell'Inserimento del Valore della Banda Nera Destra... Non e' un Numero. 
set t32=Banda Nera Superiore:
set t33=Banda Nera Inferiore:
set t34=Banda Nera Sinistra:
set t35=Banda Nera Destra:
set t36=Larghezza Video Originale 1080p senza Bande Nere:
set t37=Altezza Video Originale 1080p senza Bande Nere:

@REM set t361=Larghezza Video 1080p senza Bande Nere:
@REM set t371=Altezza Video 1080p senza Bande Nere:

set t38=Selezionare Scheda Grafica con cui Eseguire la Codifica:
set t39=Scegli (1/2):
set t40=Selezionare tipo di Codifica:
set t41=Errore nell'Inserimento del Valore della Quantizzazione... Non e' un Numero. 
set t42=Valore Quantizzazzione Impostato a:
set t43=Parametri per codifica:

set t44=Inserire Valore Quantizzazione Minimo 10 Massimo 28:
set t45=Valore Quantizzazzione al di fuori dei  Limiti  10 / 28  Reinserire^!
set t46=Inserire Valore BitRate kbs Minimo 100 Massimo 50000:
set t47=Errore nell'Inserimento del Valore del BitRate... Non e' un Numero. 
set t48=Valore BitRate Impostato a:
set t49=Valore  BitRate al di fuori dei  Limiti  100 / 50000  Reinserire^!

set t50=Selezionare Qualita' Codifica:
set t51=- Peggiore Qualita'
set t52=- Migliore Qualita'
set t53=Scegli (1/2/3/4/5/6/7):
set t54=Qualita' Impostata su:
set t55=Applicare il denoiser Convolution3D Si/No: 
set t56=Applicare il denoiser PMD Si/No: 
set t57=Applicare il Miglioramento Dettagli Si/No:  
set t58=Miglioramento Dettagli: Si 
set t59=Miglioramento Dettagli: No 
set t60=Informazioni
set t61=Video da Codificare Salvate!
set t62=Vuoi Inserire un altro Video da Codificare (Si/No):
set t63=Il file trascinato non e' un video!
set t64=Scegli (1/2/3/4):
set t65=Premi Invio per tornare al Menu' Principale.  

set t66=Larghezza Video
set t67=Altezza Video
set t68=Codec Video
set t69=Codec Video Dettagli
set t70=Format Video 
set t71=Configurazione Parametri per convertire il video da 8bit o 10bit SDR a 10bit HDR
set t72=Selezionare UpGrader Codifica:
set t73=UpGrader Impostato:
set t74=Scegli (1/2/3):


set t75=Configurazione Operazione di UpScaling e UpGrading da 1080p 8 o 10 bit SDR a 2160p 10 bit HDR 
set t76=Selezionare Operazioni da Eseguire:
set t77=1) Fare Prima Codifica per UpScaling e Seconda Codifica per Ripulire il Video e Migliorare i Dettagli
set t78=2) Ripulire, Migliorare i Dettagli e Upscaling in un Unica Codifica 

set t79=UpScaling Iniziato.... 
set t80=Applicazione Denoiser e Miglioramento Dettagli Iniziato.... 
set t81=Codifica Terminata...
set t82=Il PC ora verra' Spento... 

goto avvio_QSVEncUpScaling

:avvio_QSVEncUpScaling


set /a "numeromovie=1"


:altrivideodainserireNVEnc_QSVEncUpScaling


set NomeFile1080p=
rem set MetadatiStreamHDR10=

set /P NomeFile1080p=!t2!
rem echo Hai digitato: %NomeFile%
rem pause

set "NomeFileSorgente=!NomeFile1080p:"=!"
@REM echo NomeFileSorgente = !NomeFileSorgente!
set "NomeFile=^"!NomeFileSorgente!^""
@REM echo NomeFile = !NomeFile!
@REM rem pause


if exist !NomeFile! ( goto infovideo_QSVEncUpScaling ) else ( 
                                                        echo.
                                                        echo !t3!
                                                        echo.
                                                        goto fineinfovideo_QSVEncUpScaling
                                                        )    



:infovideo_QSVEncUpScaling
echo.
echo !t4!
echo.

.\bin\ffprobe -v error -hide_banner -select_streams v:0 -show_entries stream=width,height,codec_name,codec_long_name,pix_fmt,color_space,color_transfer,color_primaries -of default=noprint_wrappers=1 !NomeFile! > ".\temp\Temp_HDR10_Stream.txt"

set /A x1=1
set /A nohdrcs=0
set /A nohdrct=0
set /A nohdrcp=0
set /A wv=0
set /a hv=0
set /A fv=0

rem echo nohdr = %nohdr%

for /f "tokens=1,2 delims==" %%a in (.\temp\Temp_HDR10_Stream.txt) do (if !x1!==3 ( 
                                                                            echo !t66! "%%a" = %%b  
                                                                            set /A "widthvideo=%%b"
                                                                            rem echo widthvideo = !widthvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !widthvideo! LEQ 1920 if !widthvideo! GEQ 1000 (set /A "wv=1"
                                                                                                                                rem echo wv = !wv!
                                                                                                                                )
                                                                            )
                                                                if !x1!==4 ( 
                                                                            echo !t67! "%%a" = %%b  
                                                                            set /A "heightvideo=%%b"
                                                                            rem echo heightvideo = !heightvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !heightvideo! LEQ 1080 if !heightvideo! GEQ 700 (set /A "hv=1"
                                                                                                        rem echo hv = !hv!
                                                                                                        )
                                                                            )                                                           
                                                                if !x1!==6 ( 
                                                                            echo Color Space "%%a" = %%b  
                                                                            set "colorsp=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colorsp!==bt709 (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorsp!==unknown (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorsp!==reserved (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                    
                                                                            ) 
                                                                if !x1!==7 ( 
                                                                            echo Color Transfer "%%a" = %%b  
                                                                            set "colortr=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colortr!==bt709 (set /A "nohdrct=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colortr!==unknown (set /A "nohdrct=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colortr!==reserved (set /A "nohdrct=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                    
                                                                            ) 
                                                                if !x1!==8 ( 
                                                                            echo Color Primaries "%%a" = %%b  
                                                                            set "colorpr=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colorpr!==bt709 (set /A "nohdrcp=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorpr!==unknown (set /A "nohdrcp=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorpr!==reserved (set /A "nohdrcp=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                
                                                                            )    
                                                                if !x1!==1 ( 
                                                                            echo !t68! "%%a" = %%b  
                                                                            )       
                                                                if !x1!==2 ( 
                                                                            echo !t69! "%%a" = %%b  
                                                                            )   
                                                                if !x1!==5 ( 
                                                                            echo !t70! "%%a" = %%b  
                                                                            set "formatvideo=%%b"
                                                                            rem echo formatvideo = !formatvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !formatvideo!==yuv420p (set /A "fv=1"
                                                                                                        rem echo fv = !fv!
                                                                                                        )
                                                                            if !formatvideo!==yuv420p10le (set /A "fv=1"
                                                                                                            rem echo fv = !fv!
                                                                                                            )
                                                                            )
                                                                set /A x1+=1                                                            
)
echo.

if !x1!==1 goto :novideofile1080p_QSVEncUpScaling


if !nohdrcs!==1 if !nohdrct!==1 if !nohdrcp!==1 if !wv!==1 if !hv!==1 if !fv!==1 ( 
                                                                                   if !formatvideo!==yuv420p10le (
                                                                                                                    echo !t511!
                                                                                                                    goto rilevazionebandenere_QSVEncUpScaling
                                                                                                                    ) 
                                                                                   if !formatvideo!==yuv420p (                                 
                                                                                                                echo !t5!
                                                                                                                goto rilevazionebandenere_QSVEncUpScaling
                                                                                                                )
                                                                                   ) 


echo !t6!
echo.
goto fineinfovideo_QSVEncUpScaling


:rilevazionebandenere_QSVEncUpScaling

.\bin\ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 !NomeFile!  > ".\temp\durata_film.txt"


set /a contatore=1
for /f "tokens=1 delims=." %%a in (.\temp\durata_film.txt) do  (
                                                        echo. 
                                                        echo !t7! %%a
                                                        set /a "secondi=%%a"
                                                        set /a "minuti=!secondi!/60"
                                                        echo !t8! !minuti!
                                                        set /a "intervallo_tagli=!secondi!/11"
                                                        echo !t9! !intervallo_tagli!!t10!
                                                        echo.
                                                        echo !t11!
                                                        echo.

                                                        

                                                        FOR /L %%a IN (1, 1, 10) DO (
                                                                                    rem echo %%a
                                                                                    set /a "secondi=%%a*!intervallo_tagli!"
                                                                                    rem echo !secondi!

                                                                                    if !formatvideo!==yuv420p (
                                                                                                                set /a "ca=16"
                                                                                                                rem echo !ca!
                                                                                                                    
                                                                                                                set /a "cb=2"
                                                                                                                rem echo !cb!
                                                                                                                    
                                                                                                                set /a "cc=0"
                                                                                                                rem echo !cc!

                                                                                                                set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                                                rem echo !cr!
                                                                                                                )

                                                                                    if !formatvideo!==yuv420p10le  ( 
                                                                                                                    set /a "ca=72"
                                                                                                                    rem echo !ca!
                                                                                                                    
                                                                                                                    set /a "cb=2"
                                                                                                                    rem echo !cb!
                                                                                                                    
                                                                                                                    set /a "cc=0"
                                                                                                                    rem echo !cc!

                                                                                                                    set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                                                    rem echo !cr!
                                                                                                                    )                                                                                                                

                                    
                                                                                
                                                                                
                                                                                    .\bin\ffmpeg -ss !secondi! -hide_banner -nostats -i !NomeFile! -vframes 10 -vf !cr! -f null - 2> ".\temp\crop.txt"
                                                                                    
                                                                                    findstr /r "Parsed_cropdetect_0" .\temp\crop.txt >> .\temp\risultato_multiplo.txt   
                                                                                    
                                                                                    echo !t12! %%a !t13! !secondi! !t14!
                                                                                    
                                                                                    )       
                                                                                       

                                                                                    for /f "tokens=1,2 delims==" %%a in (.\temp\risultato_multiplo.txt) do ( echo %%b >> .\temp\crop_multiplo.txt )
                                                                                    
                                                                                    set /a "maxfrequenza=0"

                                                                                    for /f "delims=" %%a in (.\temp\crop_multiplo.txt) do ( 
                                                                                                                                    set "cropconfront=%%a"
                                                                                                                                    rem echo "!cropconfront!"
                                                                                                                                    
                                                                                                                                    set /a "contatorfrequenza=0"
                                                                                                                                    for /f "delims=" %%b in (.\temp\crop_multiplo.txt) do (
                                                                                                                                                                                    set "dato_da_verificare=%%b"
                                                                                                                                                                                    rem echo cropconfront = "!cropconfront!"
                                                                                                                                                                                    rem echo dato_da_verificare = "!dato_da_verificare!"
                                                                                                                                                                                    if !cropconfront!==!dato_da_verificare! ( set /a "contatorfrequenza+=1")
                                                                                                                                                                                    )
                                                                                                                                    if !maxfrequenza! LSS !contatorfrequenza! ( 
                                                                                                                                                                                set /a "maxfrequenza=!!contatorfrequenza!!"
                                                                                                                                                                                set "cropd=!cropconfront!"
                                                                                                                                                                                )
                                                                                                                                    

                                                                                                                                    rem if !cropconfront! in (elenco_crop_frequenza.txt) ()
                                                                                                                                    rem echo !cropconfront!:!contatorfrequenza! >> elenco_crop_frequenza.txt

                                                                                                                                    )

                                                                                    rem echo crop piu' frequente = !cropd! con grequenza = !maxfrequenza!
                                                                                    echo !cropd! > .\temp\crop_finale.txt

                                                                                    for /f "tokens=1,2,3,4 delims=:" %%a in (.\temp\crop_finale.txt) do  ( 
                                                                                                                                                    rem set /a "mwidth=%%a"
                                                                                                                                                    rem echo mwidth = !mwidth!

                                                                                                                                                    rem set /a "mheight=%%b"
                                                                                                                                                    rem echo mheight = !mheight!

                                                                                                                                                    rem set /a "mx=%%c"
                                                                                                                                                    rem echo mx = !mx!

                                                                                                                                                    rem set /a "my=%%d"
                                                                                                                                                    rem echo my = !my!

                                                                                                                                                    if !contatore!==1 ( 
                                                                                                                                                                set /a "wmax=%%a" 
                                                                                                                                                                set /a "hmax=%%b"
                                                                                                                                                                set /a "xmin=%%c"
                                                                                                                                                                set /a "ymin=%%d"
                                                                                                                                                                set /a "mwidth=%%a"
                                                                                                                                                                set /a "mheight=%%b"
                                                                                                                                                                set /a "mx=%%c"
                                                                                                                                                                set /a "my=%%d"
                                                                                                                                                                set /a "contatore+=1"
                                                                                                                                                                )
                                                                                                                                                    
                                                                                                                                                    rem if %%b gtr !hmax! if %%c gtr !xmin! if %%d gtr !ymin! 

                                                                                                                                                    if %%a geq !wmax! if %%b geq !hmax! ( 
                                                                                                                                                                        set /a "wmax=%%a" 
                                                                                                                                                                        set /a "hmax=%%b"
                                                                                                                                                                        set /a "xmin=%%c"
                                                                                                                                                                        set /a "ymin=%%d"
                                                                                                                                                                        set /a "mwidth=%%a"
                                                                                                                                                                        set /a "mheight=%%b"
                                                                                                                                                                        set /a "mx=%%c"
                                                                                                                                                                        set /a "my=%%d"
                                                                                                                                                                        )
                                                                                                                                                    )
                                                                                    echo.
                                                                                    
                                                                                    set /a "mwidth=!mwidth!/2*2"
                                                                                    set /a "mheight=!mheight!/2*2"

                                                                                    set /a "csup=!my!/2*2"
                                                                                    rem echo csup = !csup!
                                                                                                                                    
                                                                                    set /a "csin=!mx!/2*2"
                                                                                    rem echo csin = !csin!

                                                                                    set /a "cinf=(!heightvideo!-!mheight!-!my!)/2*2"
                                                                                    rem echo movieheightreal = !movieheightreal!
                                                                                    rem echo cinf = !cinf!
                                                                                    set /a "cdes=(!widthvideo!-!mwidth!-!mx!)/2*2"
                                                                                    rem echo cdes = !cdes!

                                                                                    echo Crop Settings: --crop !csin!,!csup!,!cdes!,!cinf!    
                                                                                    set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
                                                                                    echo.  
                                                                                    
                                                                                    echo !t17!  !mwidth! 
                                                                                    echo !t18!  !mheight! 
                                                                                    echo.

                                                                                    set /a "larghezza1080pnvenc=1920"
                                                                                    set /a "altezza1080pnvenc=1080"
                                                                                    @REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
                                                                                    @REM echo altezza1080pnvenc = !altezza1080pnvenc!                                    

                                                                                    set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!mwidth!"
                                                                                    set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!mheight!"
                                                                                    @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
                                                                                    @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

                                                                                    if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                                                                                                        @REM echo dentro il 1o if
                                                                                                                                                                        set /a "width2k=!mwidth!"
                                                                                                                                                                        set /a "height2k=!mheight!"
                                                                                                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                                                                                                set /a "width2k=!mwidth!"
                                                                                                                                                                                                                                                                set /a "height2k=!mheight!"
                                                                                                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                                                                                                        set /a "width2k=!mwidth!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        set /a "height2k=!mheight!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "width2k=!mwidth!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "height2k=!mheight!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                                                                                                                set /a "width2k=!mwidth!"
                                                                                                                                                                                                                                                                set /a "height2k=!mheight!"
                                                                                                                                                                                                                                                                )
                                                                                                                                                                        
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                                                                                                        set /a "width2k=!mwidth!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        set /a "height2k=!mheight!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.                         

                                                                                        echo !t191!  !width2k! 
                                                                                        echo !t192!  !height2k!    
                                                                                        echo.

                                                                                        set /a "width4k=width2k*2"
                                                                                        set /a "height4k=height2k*2"

                                                                                        echo !t20!  !width4k! 
                                                                                        echo !t21!  !height4k!    
                                                                                        echo.
                                                                                    )  
                                                        )                          
                                                  

:cropmanuale_QSVEncUpScaling

set /a "csup=0"
set /a "cinf=0"
set /a "csin=0"
set /a "cdes=0"
set /a "bandasuperiore=0"
set /a "bandainferiore=0"
set /a "bandasinistra=0"
set /a "bandadestra=0"
set /a "differenzialelarghezza1080pnvenc=0"
set /a "differenzialealtezza1080pnvenc=0"
if exist ".\temp\Temp_HDR10_Stream.txt" ( del ".\temp\Temp_HDR10_Stream.txt" ) 
if exist ".\temp\durata_film.txt" ( del ".\temp\durata_film.txt" )
if exist ".\temp\crop.txt" ( del ".\temp\crop.txt" )
if exist ".\temp\risultato_multiplo.txt" ( del ".\temp\risultato_multiplo.txt" )
if exist ".\temp\crop_multiplo.txt" ( del ".\temp\crop_multiplo.txt" )
if exist ".\temp\crop_finale.txt" ( del ".\temp\crop_finale.txt" )

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t22!"   
    if errorlevel 2 goto cropmanualeNVEnc_QSVEncUpScaling
    if errorlevel 1 goto finecropNVEncUpScaling_QSVEncUpScaling
)

CHOICE /N /C:SN /M "!t22!"   

if errorlevel 2 goto cropmanualeNVEnc_QSVEncUpScaling
if errorlevel 1 goto finecropNVEncUpScaling_QSVEncUpScaling


:cropmanualeNVEnc_QSVEncUpScaling
echo.
echo !t23!
echo.

:banda_superiore_QSVEncUpScaling
set /p "bandasuperiore=!t24!"
SET "var="&for /f "delims=0123456789" %%i in ("!bandasuperiore!") do set var=!bandasuperiore!
if defined var (
                echo.
                echo !t25!
                echo.
                goto banda_superiore_QSVEncUpScaling
                ) else (
                        set /a "csup=!bandasuperiore!/2*2"
                        )

echo.
:banda_inferiore_QSVEncUpScaling
set /p "bandainferiore=!t26!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandainferiore!") do set var=!bandainferiore!
if defined var (
                echo.
                echo !t27!
                echo.
                goto banda_inferiore_QSVEncUpScaling
                ) else (
                        set /a "cinf=!bandainferiore!/2*2"
                        )


echo.
:banda_sinistra_QSVEncUpScaling
set /p "bandasinistra=!t28!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandasinistra!") do set var=!bandasinistra!
if defined var (
                echo.
                echo !t29!
                echo.
                goto banda_sinistra_QSVEncUpScaling
                ) else (
                        set /a "csin=!bandasinistra!/2*2"
                        )

                        
echo.
:banda_destra_QSVEncUpScaling
set /p "bandadestra=!t30!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandadestra!") do set var=!bandadestra!
if defined var (
                echo.
                echo !t31!
                echo.
                goto banda_destra_QSVEncUpScaling
                ) else (
                        set /a "cdes=!bandadestra!/2*2"
                        )


set /a "larghezza1080pnvenc=1920"
set /a "altezza1080pnvenc=1080"
@REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
@REM echo altezza1080pnvenc = !altezza1080pnvenc!                                    

set /a "mwidth=!widthvideo!/2*2"
set /a "mheight=!heightvideo!/2*2"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "mwidthc=!mwidth!-!csin!-!cdes!"
set /a "mheightc=!mheight!-!csup!-!cinf!"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!mwidthc!"
set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!mheightc!"
@REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
@REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

echo.
echo !t32!  !csup! 
echo !t33!  !cinf! 
echo !t34!  !csin! 
echo !t35!  !cdes! 
echo.


set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
echo Crop Settings: !cropff!
echo.

echo !t36!  !mwidthc! 
echo !t37!  !mheightc! 
echo.



if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                        @REM echo dentro il 1o if
                                                                                        set /a "width2k=!mwidthc!"
                                                                                        set /a "height2k=!mheightc!"
                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                set /a "width2k=!mwidthc!"
                                                                                                                                                                                set /a "height2k=!mheightc!"
                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                        set /a "width2k=!mwidthc!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                        set /a "height2k=!mheightc!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                set /a "width2k=!mwidthc!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                set /a "height2k=!mheightc!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                )
                                                                                        if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                        set /a "width2k=!mwidthc!"
                                                                                                                                                                        set /a "height2k=!mheightc!"
                                                                                                                                                                        )
                                                                                                                                                                        
                                                                                        if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                set /a "width2k=!mwidthc!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                set /a "height2k=!mheightc!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.                         

                                                                                        echo !t191!  !width2k! 
                                                                                        echo !t192!  !height2k!    
                                                                                        echo.

                                                                                        set /a "width4k=width2k*2"
                                                                                        set /a "height4k=height2k*2"

                                                                                        echo !t20!  !width4k! 
                                                                                        echo !t21!  !height4k!    
                                                                                        echo.
                                                                                    ) 

goto cropmanuale_QSVEncUpScaling

:finecropNVEncUpScaling_QSVEncUpScaling




:InserimentoImpostazioniQSVEnc_QSVEncUpScaling


echo.
echo !t40!
echo.
echo 1) CQP 
echo 2) ICQ 
echo 3) LA-ICQ 
echo 4) VBR 
echo.
CHOICE /N /C:1234 /M "!t64!"

if errorlevel 4 goto CodificaVBRQSVEnc_QSVEncUpScaling
if errorlevel 3 goto CodificaLAICQQSVEnc_QSVEncUpScaling
if errorlevel 2 goto CodificaICQQSVEnc_QSVEncUpScaling
if errorlevel 1 goto CodificaCQPQSVEnc_QSVEncUpScaling


:CodificaCQPQSVEnc_QSVEncUpScaling
set "TipoCodificaQSVEnc=--cqp "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc_QSVEncUpScaling

:CodificaICQQSVEnc_QSVEncUpScaling
set "TipoCodificaQSVEnc=--icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc_QSVEncUpScaling

:CodificaLAICQQSVEnc_QSVEncUpScaling
set "TipoCodificaQSVEnc=--la-icq "
set /a "quantizzazioneQSVEnc=1"
goto inserimentoValoriCQPVBRQSVEnc_QSVEncUpScaling

:CodificaVBRQSVEnc_QSVEncUpScaling
set "TipoCodificaQSVEnc=--vbr "
set /a "quantizzazioneQSVEnc=0"
goto inserimentoValoriCQPVBRQSVEnc_QSVEncUpScaling


:inserimentoValoriCQPVBRQSVEnc_QSVEncUpScaling

if !quantizzazioneQSVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneQSVEnc=!t44! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneQSVEnc!") do set var=!valoreQuantizzazioneQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                goto inserimentoValoriCQPVBRQSVEnc_QSVEncUpScaling
                                                ) 

                                set /a "valoreQuantizzazioneQSVEnc=!valoreQuantizzazioneQSVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneQSVEnc!
                                if !valoreQuantizzazioneQSVEnc! GEQ 10 if !valoreQuantizzazioneQSVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneQSVEnc!
                                                                                                                set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreQuantizzazioneQSVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                                goto fineQuantizzazioneQSVEnc_QSVEncUpScaling
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRQSVEnc_QSVEncUpScaling
                                                                                                                        
                                )



if !quantizzazioneQSVEnc!==0 (
                                echo.
                                set /p "valoreBitRateQSVEnc=!t46! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateQSVEnc!") do set var=!valoreBitRateQSVEnc!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                goto inserimentoValoriCQPVBRQSVEnc_QSVEncUpScaling
                                                ) 
                                set /a "valoreBitRateQSVEnc=!valoreBitRateQSVEnc!"
                                @REM echo valoreBitRateQSVEnc = !valoreBitRateQSVEnc!
                                if !valoreBitRateQSVEnc! GEQ 100 if !valoreBitRateQSVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateQSVEnc!
                                                                                                        set "tipoQuantizzazioneQSVEnc=!TipoCodificaQSVEnc!!valoreBitRateQSVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneQSVEnc!
                                                                                                        goto fineQuantizzazioneQSVEnc_QSVEncUpScaling
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRQSVEnc_QSVEncUpScaling
                                                                                                              
                                )


:fineQuantizzazioneQSVEnc_QSVEncUpScaling



echo.
echo !t50!
echo.
echo 1) Best 
echo 2) Higher 
echo 3) High 
echo 4) Balanced 
echo 5) Fast 
echo 6) Faster 
echo 7) Fastest 
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto QualitFastestQSVEnc_QSVEncUpScaling
if errorlevel 6 goto QualitFasterQSVEnc_QSVEncUpScaling
if errorlevel 5 goto QualitFastQSVEnc_QSVEncUpScaling
if errorlevel 4 goto QualitBalancedtQSVEnc_QSVEncUpScaling
if errorlevel 3 goto QualitHighQSVEnc_QSVEncUpScaling
if errorlevel 2 goto QualitHigherQSVEnc_QSVEncUpScaling
if errorlevel 1 goto QualitBestQSVEnc_QSVEncUpScaling


:QualitBestQSVEnc_QSVEncUpScaling
set "SettaggioQualitaQSvenc=--quality best"
set "QualitySetting=best"
goto fineQualitCodificaQSVEnc_QSVEncUpScaling

:QualitHigherQSVEnc_QSVEncUpScaling
set "SettaggioQualitaQSvenc=--quality higher"
set "QualitySetting=higher"
goto fineQualitCodificaQSVEnc_QSVEncUpScaling

:QualitHighQSVEnc_QSVEncUpScaling
set "SettaggioQualitaQSvenc=--quality high"
set "QualitySetting=high"
goto fineQualitCodificaQSVEnc_QSVEncUpScaling

:QualitBalancedtQSVEnc_QSVEncUpScaling
set "SettaggioQualitaQSvenc=--quality balanced"
set "QualitySetting=balanced"
goto fineQualitCodificaQSVEnc_QSVEncUpScaling

:QualitFastQSVEnc_QSVEncUpScaling
set "SettaggioQualitaQSvenc=--quality fast"
set "QualitySetting=fast"
goto fineQualitCodificaQSVEnc_QSVEncUpScaling

:QualitFasterQSVEnc_QSVEncUpScaling
set "SettaggioQualitaQSvenc=--quality faster"
set "QualitySetting=faster"
goto fineQualitCodificaQSVEnc_QSVEncUpScaling

:QualitFastestQSVEnc_QSVEncUpScaling
set "SettaggioQualitaQSvenc=--quality fastest"
set "QualitySetting=fastest"
goto fineQualitCodificaQSVEnc_QSVEncUpScaling


:fineQualitCodificaQSVEnc_QSVEncUpScaling
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaQSvenc!



echo.
echo !t71!
echo !t72!
echo.
echo 1) QSVEnc Color Correction 
echo 2) LibPlacebo Color Correction 

echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto LibPlaceboColorCorrectionQSVEnc_QSVEncUpScaling
if errorlevel 1 goto QSVEncColorCorrection_QSVEncUpScaling


:QSVEncColorCorrection_QSVEncUpScaling
set "QSVEncColorCorrectionSystem=--vpp-colorspace colorprim=bt709:bt2020,transfer=bt709:smpte2084,matrix=bt709:bt2020nc --vpp-tweak brightness=0.1,contrast=1.2,saturation=1.1"
set "QSVEncUpgrader=QSVEnc Color Correction"
goto QSVEncFineSelezioneUpGrader_QSVEncUpScaling

:LibPlaceboColorCorrectionQSVEnc_QSVEncUpScaling
set "QSVEncColorCorrectionSystem=--vpp-libplacebo-tonemapping src_csp=sdr,dst_csp=hdr10"
set "QSVEncUpgrader=LibPlacebo Color Correction"


:QSVEncFineSelezioneUpGrader_QSVEncUpScaling
echo.
echo !t73! !QSVEncUpgrader!
echo.
echo !t43! !QSVEncColorCorrectionSystem!



:sceltadenoiserQSVEnc
set conv3d1080p=
set pmd1080p=
set /a unicopassaggio=0


if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t55!"
    if errorlevel 2 goto conv3dChoosenNoQSVEnc_QSVEncUpScaling
    if errorlevel 1 goto conv3dChoosenYesQSVEnc_QSVEncUpScaling
)

echo.
CHOICE /N /C:SN /M "!t55!"

if errorlevel 2 goto conv3dChoosenNoQSVEnc_QSVEncUpScaling
if errorlevel 1 goto conv3dChoosenYesQSVEnc_QSVEncUpScaling

:conv3dChoosenNoQSVEnc_QSVEncUpScaling
set "conv3d1080p=N"
goto sceltaDeniserPMDQSVEnc_QSVEncUpScaling

:conv3dChoosenYesQSVEnc_QSVEncUpScaling
set "conv3d1080p=S"



:sceltaDeniserPMDQSVEnc_QSVEncUpScaling
if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t56!"
    if errorlevel 2 goto PMDChoosenNoQSVEnc_QSVEncUpScaling
    if errorlevel 1 goto PMDChoosenYesQSVEnc_QSVEncUpScaling
)
echo.
CHOICE /N /C:SN /M "!t56!"

if errorlevel 2 goto PMDChoosenNoQSVEnc_QSVEncUpScaling
if errorlevel 1 goto PMDChoosenYesQSVEnc_QSVEncUpScaling

:PMDChoosenNoQSVEnc_QSVEncUpScaling
set "pmd1080p=N"
goto assegnazioneDenoisesQSVEnc_QSVEncUpScaling

:PMDChoosenYesQSVEnc_QSVEncUpScaling
set "pmd1080p=S"


:assegnazioneDenoisesQSVEnc_QSVEncUpScaling
set /A nvdenv=0

if !conv3d1080p!==S if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00 --vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==S if !pmd1080p!==N ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==N ( 
                                        set "nvdenoiser=" 
                                        set "nvdenv=1"
                                        set "unicopassaggio=1"
                                        echo.
                                        echo QSVEnc Denoiser Settings: Nessun Denoiser 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )

@REM pause

if %lingua%==inglese (    
    CHOICE /N /C:YN /M "!t57!"
    if errorlevel 2 goto ApplicaMiglioramentoDettagliQSVEncNo_QSVEncUpScaling
    if errorlevel 1 goto ApplicaMiglioramentoDettagliQSVEncSi_QSVEncUpScaling
)

CHOICE /N /C:SN /M "!t57!"

if errorlevel 2 goto ApplicaMiglioramentoDettagliQSVEncNo_QSVEncUpScaling
if errorlevel 1 goto ApplicaMiglioramentoDettagliQSVEncSi_QSVEncUpScaling

:ApplicaMiglioramentoDettagliQSVEncNo_QSVEncUpScaling
set "miglioramento1080p=N"
goto fineSceltaMigliaramentiQSCEnc_QSVEncUpScaling

:ApplicaMiglioramentoDettagliQSVEncSi_QSVEncUpScaling
set "miglioramento1080p=S"

:fineSceltaMigliaramentiQSCEnc_QSVEncUpScaling
if !miglioramento1080p!==S ( 
                                set "edgeleveling=--vpp-edgelevel strength=10.0,threshold=24.0,black=6,white=0" 
                                echo.
                                echo QSVEnc !t58!
                                echo.
                                )
if !miglioramento1080p!==N ( 
                                set "edgeleveling=" 
                                echo.
                                echo QSVEnc !t59!
                                echo.
                                )


@REM pause

if NOT DEFINED nvdenoiser if NOT DEFINED edgeleveling (
                                                        set "unicopassaggio=1"
                                                        goto fineConfigurazioneOperazioniUpScalingQSVEnc_QSVEncUpScaling
                                                        )

echo.
echo !t75!
echo !t76!
echo.
echo !t77!
echo !t78!

echo.
CHOICE /N /C:123 /M "!t39!"

if errorlevel 2 goto OperazioniUpScalingSingolaCodificaQSVEnc_QSVEncUpScaling
if errorlevel 1 goto OperazioniUpScalingDoppiaCodificaQSVEnc_QSVEncUpScaling

:OperazioniUpScalingSingolaCodificaQSVEnc_QSVEncUpScaling
set "unicopassaggio=1"
goto fineConfigurazioneOperazioniUpScalingQSVEnc_QSVEncUpScaling

:OperazioniUpScalingDoppiaCodificaQSVEnc_QSVEncUpScaling
set "unicopassaggio=0"

:fineConfigurazioneOperazioniUpScalingQSVEnc_QSVEncUpScaling






echo.
echo !t79!
echo.


set file_senza_virgolette=%NomeFile:"=%
rem echo %file_senza_virgolette%

set file_senza_estensione=%file_senza_virgolette:.mkv=%
rem echo %file_senza_estensione%

set fileoutput2160p="%file_senza_estensione%_UpScaled.mkv"

@REM echo miglioramento1080p = !miglioramento1080p!
@REM echo.
@REM pause 


if !miglioramento1080p!==S (
                                @REM echo dento if S
                                set fileoutput2160pdetailed2="!file_senza_estensione!_UpScaled 2160p.mkv"
                                @REM echo fileoutput2160pdetailed2 = !fileoutput2160pdetailed2!
                                set fileoutput2160pdetailed="!file_senza_estensione!_UpScaled 2160p_pul_leggera.mkv"
                                @REM echo fileoutput2160pdetailed = !fileoutput2160pdetailed!
                                )

if !miglioramento1080p!==N  (
                                @REM echo dento if N
                                set fileoutput2160pdetailed2="!file_senza_estensione!_UpScaled 2160p.mkv"
                                @REM echo fileoutput2160pdetailed2 = !fileoutput2160pdetailed2!
                                set fileoutput2160pdetailed="!file_senza_estensione!_UpScaled 2160p_pul_leggera.mkv"
                                @REM echo fileoutput2160pdetailed = !fileoutput2160pdetailed!
                                )


set fileoutput2160pdetailed_senza_virgolette=!fileoutput2160pdetailed:"=! 
rem echo !fileoutput2160pdetailed_senza_virgolette!


for %%i in ("!fileoutput2160pdetailed_senza_virgolette!") do (  
                                                                set "solo_nome_file=%%~ni"
                                                                rem echo Nome file: !solo_nome_file!

                                                                set "solo_estensione_file=%%~xi"
                                                                rem echo Estensione: !solo_estensione_file!
                                                                )

set fileoutput2160pdetailed_rinominato=!solo_nome_file!_rinominato!solo_estensione_file!

rem echo %fileoutput2160pdetailed_rinominato%



set fileoutput2160pdetailed2_senza_virgolette=!fileoutput2160pdetailed2:"=! 
rem echo %fileoutput2160pdetailed2_senza_virgolette%

for %%i in ("!fileoutput2160pdetailed2_senza_virgolette!") do (  
                                                                set "solo_nome_file=%%~ni"
                                                                rem echo Nome file: !solo_nome_file!

                                                                set "solo_estensione_file=%%~xi"
                                                                rem echo Estensione: !solo_estensione_file!
                                                                )

set fileoutput2160pdetailed2_rinominato=!solo_nome_file!_rinominato!solo_estensione_file!

rem echo %fileoutput2160pdetailed2_rinominato%

if exist "Temp_HDR10_Stream.txt" ( del Temp_HDR10_Stream.txt )
if exist "durata_film.txt" ( del durata_film.txt )
if exist "crop.txt" ( del crop.txt )
if exist "risultato_multiplo.txt" ( del risultato_multiplo.txt )
if exist "crop_multiplo.txt" ( del crop_multiplo.txt )
if exist "crop_finale.txt" ( del crop_finale.txt )

if !unicopassaggio!==1 ( goto codificaunicopassaggioQSVEnc_QSVEncUpScaling )

rem echo fileoutput2160p = %fileoutput2160p%
rem echo fileoutput2160pdetailed = %fileoutput2160pdetailed%

".\bin\qsvencc\QSVEncC64.exe" --avsw --device auto -i !NomeFile!  --output-res !width4k!x!height4k!  !nvcrop! --video-metadata clear --metadata clear --chapter-copy -c hevc !tipoQuantizzazioneQSVEnc! !SettaggioQualitaQSvenc! --la-depth 32 --level auto --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display "G(13250,34500)B(7500,3000)R(34000,16000)WP(15635,16450)L(10000000,1)" --max-cll "1000,400"  --output-depth 10   --avsync cfr   --psnr --ssim     -m default_mode:infer_no_subs   !QSVEncColorCorrectionSystem!  --vpp-resize algo=lanczos4  --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o !fileoutput2160p!

echo.
echo !t80!
echo.

".\bin\qsvencc\QSVEncC64.exe" --avhw --device auto -i !fileoutput2160p!  --crop 0,0,0,0  --video-metadata clear --metadata clear --chapter-copy -c hevc !tipoQuantizzazioneQSVEnc! !SettaggioQualitaQSvenc! --la-depth 32 --level auto --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display copy --max-cll copy --output-depth 10    --avsync cfr   --psnr --ssim   -m default_mode:infer_no_subs  !nvdenoiser! !edgeleveling!  --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off  --log-level info --log ".\codifica_hardware_out_log.txt" -o !fileoutput2160pdetailed!

ren !fileoutput2160pdetailed! "!fileoutput2160pdetailed_rinominato!"

if !unicopassaggio!==0 ( goto fineupscalingdoppiopassaggioQSVEnc )

:codificaunicopassaggioQSVEnc_QSVEncUpScaling

".\bin\qsvencc\QSVEncC64.exe" --avsw --device auto -i !NomeFile!  --output-res !width4k!x!height4k!  !nvcrop! --video-metadata clear --metadata clear --chapter-copy -c hevc !tipoQuantizzazioneQSVEnc! !SettaggioQualitaQSvenc! --la-depth 32 --level auto --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display "G(13250,34500)B(7500,3000)R(34000,16000)WP(15635,16450)L(10000000,1)" --max-cll "1000,400"  --output-depth 10   --avsync cfr  --psnr --ssim     -m default_mode:infer_no_subs    !QSVEncColorCorrectionSystem!   --vpp-resize algo=lanczos4  !nvdenoiser! !edgeleveling!  --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o !fileoutput2160pdetailed2!

ren !fileoutput2160pdetailed2! "!fileoutput2160pdetailed2_rinominato!"

:fineupscalingdoppiopassaggioQSVEnc

echo.
echo !t81!
echo.

goto fineinfovideo_QSVEncUpScaling


rem//////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////



:novideofile1080p_QSVEncUpScaling
echo !t63!
echo.



:fineinfovideo_QSVEncUpScaling

if exist ".\saved\settings.dat" (
                                for /f "tokens=1,2 delims=|" %%a in (.\saved\settings.dat) do (
                                                                                                    rem echo %%a
                                                                                                    rem echo %%b
                                                                                                    set /a "shst=%%b"
                                                                                                    rem echo !shst!
                                                                                                    rem pause
                                                                                                    if !shst!==1 (
                                                                                                                echo !t82!
                                                                                                                echo.
                                                                                                                shutdown /s
                                                                                                                set /a "delay=10"
                                                                                                                timeout /t !delay!
                                                                                                                exit
                                                                                                                )
                                                                                                                            
                                                                                                    )                                                                                                  
                                                                                                )



if exist ".\temp\Temp_HDR10_Stream.txt" ( del .\temp\Temp_HDR10_Stream.txt )
if exist ".\temp\durata_film.txt" ( del .\temp\durata_film.txt )
if exist ".\temp\crop.txt" ( del .\temp\crop.txt )
if exist ".\temp\risultato_multiplo.txt" ( del .\temp\risultato_multiplo.txt )
if exist ".\temp\crop_multiplo.txt" ( del .\temp\crop_multiplo.txt )
if exist ".\temp\crop_finale.txt" ( del .\temp\crop_finale.txt )
      




set waitenter=
set /P waitenter=!t65!
Endlocal
goto menuiniziale





rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:NVEncDownGrade1080p10bitSDRto1080p8bitSDR

cls
setLocal EnableExtensions EnableDelayedExpansion


for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoNVEncDownGrade1080p10bitSDRto1080p8bitSDR
)

if %lingua%==inglese (
    goto caricalinguaingleseNVEncDownGrade1080p10bitSDRto1080p8bitSDR
)



:caricalinguaingleseNVEncDownGrade1080p10bitSDRto1080p8bitSDR
@REM set t1=Insert Hardware Video Encoding Info DownGrading from 1080p 10 bit SDR to 1080p 8 bit SDR and Saving to Disk

set t2=Drag Here the Video File 1080p 10 bit SDR to Convert to 8 bit:  
@REM set t211=File 1080p 10 bit SDR to Convert to 8 bit:  

set t3=File does not exist 
set t4=Info Video:  
set t5=The Inserted Video is 1080p 10bit SDR 
set t6=The Inserted Video isn't 1080p 10bit SDR 
set t7=Video Duration in seconds:
set t8=Video Duration in Minutes:
set t9=Interval between Frames for Crop Detection:
set t10= seconds
set t11=Black Bands Detection Started....
set t12=Crop Detection to Frame
set t13=to seconds
set t14=Done...
set t15=Input Video 1080p Width: 
set t16=Input Video 1080p Height:
set t17=Output Video 1080p Width Without Black Bars:
set t18=Outout Video 1080p Height Without Black Bars:
set t19=Adapting Video Resolution to Full 1080p Format...
set t20=Final Output Video Width 1080p:
set t21=Final Output Video Height 1080p:
set t22=Settings of Black Bands to Crop are Correct (Yes/No):
set t23=Manually Entering Black Band Values to Crop... 
set t24=Enter the Upper Black Band Value: 
set t25=Error Entering Upper Black Band Value... It's Not a Number. 
set t26=Enter the Lower Black Band Value: 
set t27=Error Entering Lower Black Band Value... It's Not a Number.
set t28=Enter the Left Black Band Value: 
set t29=Error Entering Left Black Band Value... It's Not a Number.
set t30=Enter the Right Black Band Value: 
set t31=Error Entering Right Black Band Value... It's Not a Number.
set t32=Upper Black Band:
set t33=Lower Black Band:
set t34=Left Black Band:
set t35=Right Black Band:
set t36=Original Video Width 1080p Without Black Bars:
set t37=Original Video Height 1080p Without Black Bars:
set t38=Select Graphic Card you want to Encode with:
set t39=Choose (1/2):
set t40=Select Encoding Type:
set t41=Error Entering Quantization Value... Not a Number. 
set t42=Quantization Value Set to:
set t43=Encoding Settings:
set t44=Enter Quantization value Minimum 10 Maximum 28:
set t45=Quantization Value Out of  Limits  10 / 28  Re-enter^!
set t46=Enter BitRate Value kbs Minimum 100 Maximum 50000:
set t47=Error Entering BitRate Value... It's Not a Number. 
set t48=BitRate Value Set to:
set t49=BitRate Value Out of Limits  100 / 50000  Re-enter^!
set t50=Select Encoding Quality:
set t51=- Worst Quality
set t52=- Best Quality
set t53=Choose (1/2/3/4/5/6/7):
set t54=Quality Set to:
set t55=Apply Convolution3D denoiser Yes/No: 
set t56=Apply PMD denoiser Yes/No: 
set t57=Apply Detail Enhancement Yes/No:  
set t58=Enhancement Detail: Yes 
set t59=Enhancement Detail: No 
set t60=Info
set t61=Videos to Encode Saved!
set t62=Do You Want to Insert Another Video to Encode (Yes/No):
set t63=The dragged file is not a video!
set t64=Choose (1/2/3/4):
set t65=Press Enter toback to Main Menu.   

set t66=Video Width
set t67=Video Height
set t68=Video Codec
set t69=Details Video Codec
set t70=Video Format 

set t71=DownGrading Started.... 
set t72=Encoding Finished...
set t1000=Now the PC will be turned off... 

goto avvio_NVEncDownGrade1080p10bitSDRto1080p8bitSDR




:caricalinguaitalianoNVEncDownGrade1080p10bitSDRto1080p8bitSDR
@REM set t1=Inserimento Info Codifica Hardware Video DownGrading da 1080p 10 bit SDR a 1080p 8 bit SDR e Salvataggio su Disco.

set t2=Trascina Qui il File Video 1080p 10 bit SDR da Convertire a 8 bit: 
@REM set t211=File Video 1080p 10 bit SDR da Convertire a 8 bit:  

set t3=File Inesistente 
set t4=Informazioni Video:  
set t5=Il Video inserito e' 1080p 10bit SDR 
set t6=Il Video inserito non e' 1080p 10bit SDR 
set t7=Durata del Video in secondi:
set t8=Durata del video in Minuti:
set t9=Intervallo tra i Fotogrammi per il Rilevamento del crop:
set t10= secondi
set t11=Rilevamento Bande Nere Iniziato....
set t12=Rilevazione crop fotogramma
set t13=a secondi
set t14=Eseguita...
set t15=Larghezza Video 1080p Originale: 
set t16=Altezza Video 1080p Originale:
set t17=Larghezza Video 1080p Senza Barre Nere:
set t18=Altezza Video 1080p Senza Barre Nere:
set t19=Adattamento della Risoluzione del Video al Pieno Formato 1080p..
set t20=Larghezza Finale Video di Output 1080p:
set t21=Altezza Finale Video di Output 1080p:
set t22=Le Impostazioni delle Bande Nere da Tagliare sono Corrette (Si/No):
set t23=Inserimento Manuale Valori Bande Nere da Tagliare.. 
set t24=Inserisci il Valore della Banda Nera Superiore: 
set t25=Errore nell'Inserimento del Valore della Banda Nera Superiore... Non e' un Numero. 
set t26=Inserisci il Valore della Banda Nera Inferiore: 
set t27=Errore nell'Inserimento del Valore della Banda Nera Inferiore... Non e' un Numero. 
set t28=Inserisci il Valore della Banda Nera Sinistra: 
set t29=Errore nell'Inserimento del Valore della Banda Nera Sinistra... Non e' un Numero. 
set t30=Inserisci il Valore della Banda Nera Destra: 
set t31=Errore nell'Inserimento del Valore della Banda Nera Destra... Non e' un Numero. 
set t32=Banda Nera Superiore:
set t33=Banda Nera Inferiore:
set t34=Banda Nera Sinistra:
set t35=Banda Nera Destra:
set t36=Larghezza Video Originale 1080p Senza Barre Nere:
set t37=Altezza Video Originale 1080p Senza Barre Nere:
set t38=Selezionare Scheda Grafica con cui Eseguire la Codifica:
set t39=Scegli (1/2):
set t40=Selezionare tipo di Codifica:
set t41=Errore nell'Inserimento del Valore della Quantizzazione... Non e' un Numero. 
set t42=Valore Quantizzazzione Impostato a:
set t43=Parametri per codifica:
set t44=Inserire Valore Quantizzazione Minimo 10 Massimo 28:
set t45=Valore Quantizzazzione al di fuori dei  Limiti  10 / 28  Reinserire^!
set t46=Inserire Valore BitRate kbs Minimo 100 Massimo 50000:
set t47=Errore nell'Inserimento del Valore del BitRate... Non e' un Numero. 
set t48=Valore BitRate Impostato a:
set t49=Valore  BitRate al di fuori dei  Limiti  100 / 50000  Reinserire^!
set t50=Selezionare Qualita' Codifica:
set t51=- Peggiore Qualita'
set t52=- Migliore Qualita'
set t53=Scegli (1/2/3/4/5/6/7):
set t54=Qualita' Impostata su:
set t55=Applicare il denoiser Convolution3D Si/No: 
set t56=Applicare il denoiser PMD Si/No: 
set t57=Applicare il Miglioramento Dettagli Si/No:  
set t58=Miglioramento Dettagli: Si 
set t59=Miglioramento Dettagli: No 
set t60=Informazioni
set t61=Video da Codificare Salvate!
set t62=Vuoi Inserire un altro Video da Codificare (Si/No):
set t63=Il file trascinato non e' un video!
set t64=Scegli (1/2/3/4):
set t65=Premi Invio per tornare al Menu' Principale.  

set t66=Larghezza Video
set t67=Altezza Video
set t68=Codec Video
set t69=Codec Video Dettagli
set t70=Format Video 

set t71=DownGrading Iniziato.... 
set t72=Codifica Terminata...
set t1000=Il PC ora verra' Spento... 

goto avvio_NVEncDownGrade1080p10bitSDRto1080p8bitSDR


:avvio_NVEncDownGrade1080p10bitSDRto1080p8bitSDR


set /a "numeromovie=1"




set NomeFile2160ppuliziadettaggli=
rem set MetadatiStreamHDR10=

set /P NomeFile2160ppuliziadettaggli=!t2! 
rem echo Hai digitato: %NomeFile%
rem pause

set "NomeFileSorgente=!NomeFile2160ppuliziadettaggli:"=!"
@REM echo NomeFileSorgente = !NomeFileSorgente!
set "NomeFile=^"!NomeFileSorgente!^""
@REM echo NomeFile = !NomeFile!
rem pause


if exist !NomeFile! ( goto infovideo_NVEncDownGrade1080p10bitSDRto1080p8bitSDR ) else ( 
                                                        echo.
                                                        echo !t3!
                                                        echo.
                                                        goto fineinfovideo_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
                                                        )    



:infovideo_NVEncDownGrade1080p10bitSDRto1080p8bitSDR

echo.
echo !t4!
echo.

.\bin\ffprobe -v error -hide_banner -select_streams v:0 -show_entries stream=width,height,codec_name,codec_long_name,pix_fmt,color_space,color_transfer,color_primaries -of default=noprint_wrappers=1 !NomeFile! > ".\temp\Temp_HDR10_Stream.txt"

set /A x1=1
set /A nohdrcs=0
set /A nohdrct=0
set /A nohdrcp=0
set /A wv=0
set /a hv=0
set /A fv=0
set def=
rem echo nohdr = %nohdr%

for /f "tokens=1,2 delims==" %%a in (.\temp\Temp_HDR10_Stream.txt) do (if !x1!==3 ( 
                                                                            echo !t66! "%%a" = %%b  
                                                                            set /A "widthvideo=%%b"
                                                                            @REM echo widthvideo = !widthvideo!

                                                                            if !widthvideo! LEQ 1920 if !widthvideo! GEQ 1000 (set /A "wv=1"
                                                                                                                                @REM echo wv = !wv!
                                                                                                                                set "def=1080p"
                                                                                                                                )
                                                                            )
                                                                if !x1!==4 ( 
                                                                            echo !t67! "%%a" = %%b  
                                                                            set /A "heightvideo=%%b"
                                                                            @REM echo heightvideo = !heightvideo!
          
                                                                            if !heightvideo! LEQ 1080 if !heightvideo! GEQ 700 (set /A "hv=1"
                                                                                                                                @REM echo hv = !hv!
                                                                                                                                )
                                                                            )                                                           
                                                                if !x1!==6 ( 
                                                                            echo Color Space "%%a" = %%b  
                                                                            set "colorsp=%%b"
                                                                            @REM echo colorsp = !colorsp!
                                                                            if !colorsp!==bt709 (set /A "nohdrcs=1"
                                                                                                    @REM echo nohdrcs = !nohdrcs!
                                                                                                    )
                                                                            if !colorsp!==unknown (set /A "nohdrcs=1"
                                                                                                    @REM echo nohdrcs = !nohdrcs!
                                                                                                    )
                                                                            if !colorsp!==reserved (set /A "nohdrcs=1"
                                                                                                    @REM echo nohdrcs = !nohdrcs!
                                                                                                    )                    
                                                                            ) 
                                                                if !x1!==7 ( 
                                                                            echo Color Transfer "%%a" = %%b  
                                                                            set "colortr=%%b"
                                                                            @REM echo colortr = !colortr!
                                                                            if !colortr!==bt709 (set /A "nohdrct=1"
                                                                                                    @REM echo nohdrct = !nohdrct!
                                                                                                    )
                                                                            if !colortr!==unknown (set /A "nohdrct=1"
                                                                                                    @REM echo nohdrct = !nohdrct!
                                                                                                    )
                                                                            if !colortr!==reserved (set /A "nohdrct=1"
                                                                                                    @REM echo nohdrct = !nohdrct!
                                                                                                    )
                                                                            ) 
                                                                if !x1!==8 ( 
                                                                            echo Color Primaries "%%a" = %%b  
                                                                            set "colorpr=%%b"
                                                                            @REM echo colorpr = !colorpr!
                                                                            if !colorpr!==bt709 (set /A "nohdrcp=1"
                                                                                                    @REM echo nohdrcp = !nohdrcp!
                                                                                                    )      
                                                                            if !colorpr!==unknown (set /A "nohdrcp=1"
                                                                                                    @REM echo nohdrcp = !nohdrcp!
                                                                                                    )
                                                                            if !colorpr!==reserved (set /A "nohdrcp=1"
                                                                                                    @REM echo nohdrcp = !nohdrcp!
                                                                                                    )     
                                                                            )    
                                                                if !x1!==1 ( 
                                                                            echo !t68! "%%a" = %%b  
                                                                            )       
                                                                if !x1!==2 ( 
                                                                            echo !t69! "%%a" = %%b  
                                                                            )   
                                                                if !x1!==5 ( 
                                                                            echo !t70! "%%a" = %%b  
                                                                            set "formatvideo=%%b"
                                                                            @REM echo formatvideo = !formatvideo!
                                                                            if !formatvideo!==yuv420p10le (set /A "fv=1"
                                                                                                            @REM echo fv = !fv!
                                                                                                            )
                                                                            )
                                                                set /A x1+=1                                                            
)
echo.

if !x1!==1 goto :novideofile1080p10bitSDR


if !nohdrcs!==1 if !nohdrct!==1 if !nohdrcp!==1 if !wv!==1 if !hv!==1 if !fv!==1 ( 
                                                                                   echo !t5!
                                                                                   echo. 
                                                                                   goto RilevazioneBandeNere_NVEncDownGrade1080p10bitSDRto1080p8bitSDR                                                                   
                                                                                   ) 


echo !t6!
echo.
goto fineinfovideo_NVEncDownGrade1080p10bitSDRto1080p8bitSDR

echo.


:RilevazioneBandeNere_NVEncDownGrade1080p10bitSDRto1080p8bitSDR

.\bin\ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 !NomeFile!  > ".\temp\durata_film.txt"

set /a contatore=1
for /f "tokens=1 delims=." %%a in (.\temp\durata_film.txt) do  (
                                                        echo. 
                                                        echo !t7! %%a
                                                        set /a "secondi=%%a"
                                                        set /a "minuti=!secondi!/60"
                                                        echo !t8! !minuti!
                                                        set /a "intervallo_tagli=!secondi!/11"
                                                        echo !t9! !intervallo_tagli!!t10!
                                                        echo.
                                                        echo !t11!
                                                        echo.

                                                        

                                                        FOR /L %%a IN (1, 1, 10) DO (
                                                                                    rem echo %%a
                                                                                    set /a "secondi=%%a*!intervallo_tagli!"
                                                                                    rem echo !secondi!

                                                                                    
                                                                                    set /a "ca=16"
                                                                                    rem echo !ca!
                                                                                                                    
                                                                                    set /a "cb=2"
                                                                                    rem echo !cb!
                                                                                                                    
                                                                                    set /a "cc=0"
                                                                                    rem echo !cc!

                                                                                    set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                    rem echo !cr!
        
                                                                                
                                                                                    .\bin\ffmpeg -ss !secondi! -hide_banner -nostats -i !NomeFile! -vframes 10 -vf !cr! -f null - 2> ".\temp\crop.txt"
                                                                                    
                                                                                    findstr /r "Parsed_cropdetect_0" .\temp\crop.txt >> .\temp\risultato_multiplo.txt   
                                                                                    
                                                                                    echo !t12! %%a !t13! !secondi! !t14!
                                                                                    
                                                                                    )       
                                                                                       

                                                                                    for /f "tokens=1,2 delims==" %%a in (.\temp\risultato_multiplo.txt) do ( echo %%b >> .\temp\crop_multiplo.txt )
                                                                                    
                                                                                    set /a "maxfrequenza=0"

                                                                                    for /f "delims=" %%a in (.\temp\crop_multiplo.txt) do ( 
                                                                                                                                    set "cropconfront=%%a"
                                                                                                                                    rem echo "!cropconfront!"
                                                                                                                                    
                                                                                                                                    set /a "contatorfrequenza=0"
                                                                                                                                    for /f "delims=" %%b in (.\temp\crop_multiplo.txt) do (
                                                                                                                                                                                    set "dato_da_verificare=%%b"
                                                                                                                                                                                    rem echo cropconfront = "!cropconfront!"
                                                                                                                                                                                    rem echo dato_da_verificare = "!dato_da_verificare!"
                                                                                                                                                                                    if !cropconfront!==!dato_da_verificare! ( set /a "contatorfrequenza+=1")
                                                                                                                                                                                    )
                                                                                                                                    if !maxfrequenza! LSS !contatorfrequenza! ( 
                                                                                                                                                                                set /a "maxfrequenza=!contatorfrequenza!"
                                                                                                                                                                                set "cropd=!cropconfront!"
                                                                                                                                                                                )
                                                                                                                                    

                                                                                                                                    rem if !cropconfront! in (elenco_crop_frequenza.txt) ()
                                                                                                                                    rem echo !cropconfront!:!contatorfrequenza! >> elenco_crop_frequenza.txt

                                                                                                                                    )

                                                                                    rem echo crop piu' frequente = !cropd! con grequenza = !maxfrequenza!
                                                                                    echo !cropd! > .\temp\crop_finale.txt

                                                                                    for /f "tokens=1,2,3,4 delims=:" %%a in (.\temp\crop_finale.txt) do  ( 
                                                                                                                                                    rem set /a "mwidth=%%a"
                                                                                                                                                    rem echo mwidth = !mwidth!

                                                                                                                                                    rem set /a "mheight=%%b"
                                                                                                                                                    rem echo mheight = !mheight!

                                                                                                                                                    rem set /a "mx=%%c"
                                                                                                                                                    rem echo mx = !mx!

                                                                                                                                                    rem set /a "my=%%d"
                                                                                                                                                    rem echo my = !my!

                                                                                                                                                    if !contatore!==1 ( 
                                                                                                                                                                set /a "wmax=%%a" 
                                                                                                                                                                set /a "hmax=%%b"
                                                                                                                                                                set /a "xmin=%%c"
                                                                                                                                                                set /a "ymin=%%d"
                                                                                                                                                                set /a "mwidth=%%a"
                                                                                                                                                                set /a "mheight=%%b"
                                                                                                                                                                set /a "mx=%%c"
                                                                                                                                                                set /a "my=%%d"
                                                                                                                                                                set /a "contatore+=1"
                                                                                                                                                                )
                                                                                                                                                    
                                                                                                                                                    rem if %%b gtr !hmax! if %%c gtr !xmin! if %%d gtr !ymin! 

                                                                                                                                                    if %%a geq !wmax! if %%b geq !hmax! ( 
                                                                                                                                                                        set /a "wmax=%%a" 
                                                                                                                                                                        set /a "hmax=%%b"
                                                                                                                                                                        set /a "xmin=%%c"
                                                                                                                                                                        set /a "ymin=%%d"
                                                                                                                                                                        set /a "mwidth=%%a"
                                                                                                                                                                        set /a "mheight=%%b"
                                                                                                                                                                        set /a "mx=%%c"
                                                                                                                                                                        set /a "my=%%d"
                                                                                                                                                                        )
                                                                                                                                                    )
                                                                                    echo.
                                                                                    set /a "csup=!my!"
                                                                                    rem echo csup = !csup!
                                                                                                                                    
                                                                                    set /a "csin=!mx!"
                                                                                    rem echo csin = !csin!

                                                                                    set /a "cinf=!heightvideo!-!mheight!-!my!"
                                                                                    rem echo movieheightreal = !movieheightreal!
                                                                                    rem echo cinf = !cinf!
                                                                                    set /a "cdes=!widthvideo!-!mwidth!-!mx!"
                                                                                    rem echo cdes = !cdes!

                                                                                    echo !t15! !widthvideo!  
                                                                                    echo !t16! !heightvideo!  
                                                                                    echo.

                                                                                    echo Crop Settings: --crop !csin!,!csup!,!cdes!,!cinf!  
                                                                                    set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"  
                                                                                    echo.  

                                                                                    set /a "height2k=(!heightvideo!-!csup!-!cinf!)/2*2"
                                                                                    set /a "width2k=(!widthvideo!-!csin!-!cdes!)/2*2"

                                                                                    echo !t17! !width2k!  
                                                                                    echo !t18! !height2k!  
                                                                                    echo.

                                                                                    @REM echo Larghezza Video Originale 1080p Senza Barre Nere:  !mwidth! 
                                                                                    @REM echo Altezza Video Originale 1080p Senza Barre Nere:  !mheight! 
                                                                                    @REM echo.

                                                                                    set /a "larghezza1080pnvenc=1920"
                                                                                    set /a "altezza1080pnvenc=1080"
                                                                                    @REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
                                                                                    @REM echo altezza1080pnvenc = !altezza1080pnvenc!                                    

                                                                                    set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!mwidth!"
                                                                                    set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!mheight!"
                                                                                    @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
                                                                                    @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

                                                                                    if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                                                                                                        @REM echo dentro il 1o if
                                                                                                                                                                        set /a "width2k=!mwidth!"
                                                                                                                                                                        set /a "height2k=!mheight!"
                                                                                                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                                                                                                set /a "width2k=!mwidth!"
                                                                                                                                                                                                                                                                set /a "height2k=!mheight!"
                                                                                                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                                                                                                        set /a "width2k=!mwidth!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        set /a "height2k=!mheight!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "width2k=!mwidth!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "height2k=!mheight!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                                                                                                                set /a "width2k=!mwidth!"
                                                                                                                                                                                                                                                                set /a "height2k=!mheight!"
                                                                                                                                                                                                                                                                )
                                                                                                                                                                        
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                                                                                                        set /a "width2k=!mwidth!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        set /a "height2k=!mheight!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.                         

                                                                                        echo !t20!  !width2k! 
                                                                                        echo !t21!  !height2k!    
                                                                                        echo.

                                                                                        @REM set /a "width4k=width2k*2"
                                                                                        @REM set /a "height4k=height2k*2"

                                                                                        @REM echo Larghezza Finale Video 2160p =  !width4k! 
                                                                                        @REM echo Altezza Finale Video 2160p =  !height4k!    
                                                                                        echo.

                                                                                    ) 
                                                        )                          

:cropmanuale_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
set /a "csup=0"
set /a "cinf=0"
set /a "csin=0"
set /a "cdes=0"
set /a "bandasuperiore=0"
set /a "bandainferiore=0"
set /a "bandasinistra=0"
set /a "bandadestra=0"
set /a "differenzialelarghezza1080pnvenc=0"
set /a "differenzialealtezza1080pnvenc=0"
if exist ".\temp\Temp_HDR10_Stream.txt" ( del ".\temp\Temp_HDR10_Stream.txt" ) 
if exist ".\temp\durata_film.txt" ( del ".\temp\durata_film.txt" )
if exist ".\temp\crop.txt" ( del ".\temp\crop.txt" )
if exist ".\temp\risultato_multiplo.txt" ( del ".\temp\risultato_multiplo.txt" )
if exist ".\temp\crop_multiplo.txt" ( del ".\temp\crop_multiplo.txt" )
if exist ".\temp\crop_finale.txt" ( del ".\temp\crop_finale.txt" )


if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t22!"   
    if errorlevel 2 goto cropmanualeNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
    if errorlevel 1 goto finecropNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
)

CHOICE /N /C:SN /M "!t22!"   

if errorlevel 2 goto cropmanualeNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
if errorlevel 1 goto finecropNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR


:cropmanualeNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
echo.
echo !t23!
echo.

:banda_superiore_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
set /p "bandasuperiore=!t24!"
SET "var="&for /f "delims=0123456789" %%i in ("!bandasuperiore!") do set var=!bandasuperiore!
if defined var (
                echo.
                echo !t25!
                echo.
                goto banda_superiore_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
                ) else (
                        set /a "csup=!bandasuperiore!/2*2"
                        )

echo.


:banda_inferiore_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
set /p "bandainferiore=!t26!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandainferiore!") do set var=!bandainferiore!
if defined var (
                echo.
                echo !t27!
                echo.
                goto banda_inferiore_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
                ) else (
                        set /a "cinf=!bandainferiore!/2*2"
                        )


echo.
:banda_sinistra_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
set /p "bandasinistra=!t28!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandasinistra!") do set var=!bandasinistra!
if defined var (
                echo.
                echo !t29!
                echo.
                goto banda_sinistra_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
                ) else (
                        set /a "csin=!bandasinistra!/2*2"
                        )

                        
echo.
:banda_destra_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
set /p "bandadestra=!t30!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandadestra!") do set var=!bandadestra!
if defined var (
                echo.
                echo !t31!
                echo.
                goto banda_destra_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
                ) else (
                        set /a "cdes=!bandadestra!/2*2"
                        )


set /a "larghezza1080pnvenc=1920"
set /a "altezza1080pnvenc=1080"
@REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
@REM echo altezza1080pnvenc = !altezza1080pnvenc!                                    

set /a "mwidth=!widthvideo!/2*2"
set /a "mheight=!heightvideo!/2*2"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "mwidthc=!mwidth!-!csin!-!cdes!"
set /a "mheightc=!mheight!-!csup!-!cinf!"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "width2k=!mwidthc!"
set /a "height2k=!mheightc!"

set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!mwidthc!"
set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!mheightc!"
@REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
@REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

echo.
echo !t32!  !csup! 
echo !t33!  !cinf! 
echo !t34!  !csin! 
echo !t35!  !cdes! 
echo.


set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
echo Crop Settings: !cropff!
echo.

echo !t36!  !width2k! 
echo !t37!  !height2k! 
echo.



if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                        @REM echo dentro il 1o if
                                                                                        set /a "width2k=!mwidthc!"
                                                                                        set /a "height2k=!mheightc!"
                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                set /a "width2k=!mwidthc!"
                                                                                                                                                                                set /a "height2k=!mheightc!"
                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                        set /a "width2k=!mwidthc!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                        set /a "height2k=!mheightc!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                set /a "width2k=!mwidthc!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                set /a "height2k=!mheightc!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                )
                                                                                        if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                        set /a "width2k=!mwidthc!"
                                                                                                                                                                        set /a "height2k=!mheightc!"
                                                                                                                                                                        )
                                                                                                                                                                        
                                                                                        if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                set /a "width2k=!mwidthc!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                set /a "height2k=!mheightc!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.

                                                                                        echo !t20!  !width2k! 
                                                                                        echo !t21!  !height2k!    
                                                                                        echo.

                                                                                        @REM set /a "width4k=width2k*2"
                                                                                        @REM set /a "height4k=height2k*2"

                                                                                        @REM echo Larghezza Finale Video 2160p =  !width4k! 
                                                                                        @REM echo Altezza Finale Video 2160p =  !height4k!    
                                                                                        @REM echo.
                                                                                    ) 

goto cropmanuale_NVEncDownGrade1080p10bitSDRto1080p8bitSDR

:finecropNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR


rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


:InserimentoImpostazioniNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR

echo.
echo !t40!
echo.
echo 1) CQP 
echo 2) VBR 
echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto CodificaVBRNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
if errorlevel 1 goto CodificaCQPNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR

:CodificaVBRNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "TipoCodificaNVEnc=--vbr "
set /a "quantizzazioneNVEnc=0"
goto inserimentoValoriCQPVBRNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR

:CodificaCQPNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "TipoCodificaNVEnc=--cqp "
set /a "quantizzazioneNVEnc=1"

:inserimentoValoriCQPVBRNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR

if !quantizzazioneNVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneNVEnc=!t44! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneNVEnc!") do set var=!valoreQuantizzazioneNVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                goto inserimentoValoriCQPVBRNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
                                                ) 

                                set /a "valoreQuantizzazioneNVEnc=!valoreQuantizzazioneNVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneNVEnc!
                                if !valoreQuantizzazioneNVEnc! GEQ 10 if !valoreQuantizzazioneNVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneNVEnc!
                                                                                                                set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreQuantizzazioneNVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                                goto fineQuantizzazioneNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
                                                                                                                        
                                )



if !quantizzazioneNVEnc!==0 (
                                echo.
                                set /p "valoreBitRateNVEnc=!t46! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateNVEnc!") do set var=!valoreBitRateNVEnc!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                goto inserimentoValoriCQPVBRNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
                                                ) 
                                set /a "valoreBitRateNVEnc=!valoreBitRateNVEnc!"
                                @REM echo valoreBitRateNVEnc = !valoreBitRateNVEnc!
                                if !valoreBitRateNVEnc! GEQ 100 if !valoreBitRateNVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateNVEnc!
                                                                                                        set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreBitRateNVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                        goto fineQuantizzazioneNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
                                                                                                              
                                )


:fineQuantizzazioneNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR


echo.
echo !t50!
echo.
echo 1) P1 !t51!
echo 2) P2 
echo 3) P3 
echo 4) P4 
echo 5) P5 
echo 6) P6 
echo 7) P7 !t52!
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto P7NVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
if errorlevel 6 goto P6NVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
if errorlevel 5 goto P5NVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
if errorlevel 4 goto P4NVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
if errorlevel 3 goto P3NVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
if errorlevel 2 goto P2NVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
if errorlevel 1 goto P1NVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR


:P7NVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "SettaggioQualitaNVEnc=--preset P7"
set "QualitySetting=P7"
goto fineQualitCodificaNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR

:P6NVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "SettaggioQualitaNVEnc=--preset P6"
set "QualitySetting=P6"
goto fineQualitCodificaNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR

:P5NVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "SettaggioQualitaNVEnc=--preset P5"
set "QualitySetting=P5"
goto fineQualitCodificaNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR

:P4NVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "SettaggioQualitaNVEnc=--preset P4"
set "QualitySetting=P4"
goto fineQualitCodificaNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR

:P3NVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "SettaggioQualitaNVEnc=--preset P3"
set "QualitySetting=P3"
goto fineQualitCodificaNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR

:P2NVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "SettaggioQualitaNVEnc=--preset P2"
set "QualitySetting=P2"
goto fineQualitCodificaNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR

:P1NVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "SettaggioQualitaNVEnc=--preset P1"
set "QualitySetting=P1"
goto fineQualitCodificaNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR


:fineQualitCodificaNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaNVEnc!


set conv3d1080p=
set pmd1080p=

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t55!"
    if errorlevel 2 goto conv3dChoosenNoNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
    if errorlevel 1 goto conv3dChoosenYesNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
)

echo.
CHOICE /N /C:SN /M "!t55!"

if errorlevel 2 goto conv3dChoosenNoNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
if errorlevel 1 goto conv3dChoosenYesNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR

:conv3dChoosenNoNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "conv3d1080p=N"
goto sceltaDeniserPMDNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR

:conv3dChoosenYesNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "conv3d1080p=S"



:sceltaDeniserPMDNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t56!"
    if errorlevel 2 goto PMDChoosenNoNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
    if errorlevel 1 goto PMDChoosenYesNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
)

echo.
CHOICE /N /C:SN /M "!t56!"

if errorlevel 2 goto PMDChoosenNoNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
if errorlevel 1 goto PMDChoosenYesNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR

:PMDChoosenNoNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "pmd1080p=N"
goto assegnazioneDenoisesNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR

:PMDChoosenYesNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "pmd1080p=S"


:assegnazioneDenoisesNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
set /A nvdenv=0

if !conv3d1080p!==S if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00 --vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )
if !conv3d1080p!==S if !pmd1080p!==N ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )
if !conv3d1080p!==N if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )
if !conv3d1080p!==N if !pmd1080p!==N ( 
                                        set "nvdenoiser=" 
                                        set "nvdenv=1"
                                        set "unicopassaggio=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: Nessun Denoiser 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )

@REM pause


echo.

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t57!"
    if errorlevel 2 goto ApplicaMiglioramentoDettagliNVEncNo_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
    if errorlevel 1 goto ApplicaMiglioramentoDettagliNVEncSi_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
)

CHOICE /N /C:SN /M "!t57!"

if errorlevel 2 goto ApplicaMiglioramentoDettagliNVEncNo_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
if errorlevel 1 goto ApplicaMiglioramentoDettagliNVEncSi_NVEncDownGrade1080p10bitSDRto1080p8bitSDR

:ApplicaMiglioramentoDettagliNVEncNo_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "miglioramento1080p=N"
goto fineSceltaMigliaramentiNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR

:ApplicaMiglioramentoDettagliNVEncSi_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
set "miglioramento1080p=S"

:fineSceltaMigliaramentiNVEnc_NVEncDownGrade1080p10bitSDRto1080p8bitSDR
if !miglioramento1080p!==S ( 
                                set "edgeleveling=--vpp-edgelevel strength=10.0,threshold=24.0,black=6,white=0" 
                                echo.
                                echo NVEnc !t58!
                                echo.
                                )
if !miglioramento1080p!==N ( 
                                set "edgeleveling=" 
                                echo.
                                echo NVEnc !t59!
                                echo.
                                )


@REM pause


echo.
echo !t71!
echo.


set file_senza_virgolette=%NomeFile:"=%
rem echo %file_senza_virgolette%

set file_senza_estensione=%file_senza_virgolette:.mkv=%
rem echo %file_senza_estensione%

set fileoutput2160p="%file_senza_estensione%_DownGraded_1080p_8_bit_SDR.mkv"
rem echo fileoutput2160p = %fileoutput2160p%



set fileoutput2160p_senza_virgolette=%fileoutput2160p:"=% 
rem echo %fileoutput2160p_senza_virgolette%

for %%i in ("%fileoutput2160p_senza_virgolette%") do (  
                                                        set "solo_nome_file=%%~ni"
                                                        rem echo Nome file: !solo_nome_file!

                                                        set "solo_estensione_file=%%~xi"
                                                        rem echo Estensione: !solo_estensione_file!
                                                    )

set fileoutput2160p_rinominato=!solo_nome_file!_rinominato!solo_estensione_file!
rem echo %fileoutput2160p_rinominato%

if exist "Temp_HDR10_Stream.txt" ( del Temp_HDR10_Stream.txt )
if exist "durata_film.txt" ( del durata_film.txt )
if exist "crop.txt" ( del crop.txt )
if exist "risultato_multiplo.txt" ( del risultato_multiplo.txt )
if exist "crop_multiplo.txt" ( del crop_multiplo.txt )
if exist "crop_finale.txt" ( del crop_finale.txt )


".\bin\nvenc\NVEncC64.exe" --avhw --device 0 -i %NomeFile%  --output-res !width2k!x!height2k! !cropff! --output-depth 8 --video-metadata clear --metadata clear --chapter-copy -c hevc !tipoQuantizzazioneNVEnc! --bref-mode disabled !SettaggioQualitaNVEnc! --tier high --lookahead 32 --aq --aq-temporal --aq-strength 15 --level auto --chromaloc auto --colorrange auto --colormatrix  bt709 --transfer bt709 --colorprim bt709 --multipass None --mv-precision Q-pel  --avsync cfr   --vpp-resize algo=lanczos4  !nvdenoiser!  !edgeleveling!  --log-level info --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off  --log ".\codifica_hardware_out_log.txt" -o %fileoutput2160p%

ren %fileoutput2160p% "%fileoutput2160p_rinominato%"

echo.
echo !t72!
echo.

goto fineinfovideo_NVEncDownGrade1080p10bitSDRto1080p8bitSDR


:novideofile2160p_InserimentoCodificaHardwarePuliziaPiuMiglioramentoDettagli
echo !t63!
echo.


:fineinfovideo_NVEncDownGrade1080p10bitSDRto1080p8bitSDR

if exist ".\saved\settings.dat" (
                                for /f "tokens=1,2 delims=|" %%a in (.\saved\settings.dat) do (
                                                                                                    rem echo %%a
                                                                                                    rem echo %%b
                                                                                                    set /a "shst=%%b"
                                                                                                    rem echo !shst!
                                                                                                    rem pause
                                                                                                    if !shst!==1 (
                                                                                                                echo !t1000!
                                                                                                                echo.
                                                                                                                shutdown /s
                                                                                                                set /a "delay=10"
                                                                                                                timeout /t !delay!
                                                                                                                exit
                                                                                                                )
                                                                                                                            
                                                                                                    )                                                                                                  
                                                                                                )

if exist ".\temp\Temp_HDR10_Stream.txt" ( del .\temp\Temp_HDR10_Stream.txt )
if exist ".\temp\durata_film.txt" ( del .\temp\durata_film.txt )
if exist ".\temp\crop.txt" ( del .\temp\crop.txt )
if exist ".\temp\risultato_multiplo.txt" ( del .\temp\risultato_multiplo.txt )
if exist ".\temp\crop_multiplo.txt" ( del .\temp\crop_multiplo.txt )
if exist ".\temp\crop_finale.txt" ( del .\temp\crop_finale.txt )
      




set waitenter=
set /P waitenter=!t65!
Endlocal
goto menuiniziale









rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:NVEncUpScaling1080p10bitHDR

cls
setLocal EnableExtensions EnableDelayedExpansion



for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoNVEncUpScaling1080p10bitHDR
)

if %lingua%==inglese (
    goto caricalinguaingleseNVEncUpScaling1080p10bitHDR
)



:caricalinguaingleseNVEncUpScaling1080p10bitHDR
@REM set t1=Insert Hardware Video Encoding Info UpScaling from 1080p 10 bit HDR to 2160p 10 bit HDR and Saving to Disk

set t2=Drag Here the Video File 1080p 10 bit HDR to Convert to 2160p 10 bit HDR:  
@REM set t211=Video File 1080p 10 bit HDR to Convert to 2160p 10 bit HDR:  

set t3=File does not exist 
set t4=Info Video:  

set t5=The Inserted Video is 1080p 10bit HDR 
@REM set t511=The Inserted Video is 2160p 10bit SDR 

set t6=The Inserted Video isn't 1080p 10bit HDR 
set t7=Video Duration in seconds:
set t8=Video Duration in Minutes:
set t9=Interval between Frames for Crop Detection:
set t10= seconds
set t11=Black Bands Detection Started....
set t12=Crop Detection to Frame
set t13=to seconds
set t14=Done...
set t15=Original 2160p Video Width: 
set t16=Original 2160p Video Height:
set t17=Original Video 1080p Width Without Black Bars:
set t18=Original Video 1080p Height Without Black Bars:

set t171=Output Video 1080p Width Without Black Bars:
set t181=Outout Video 1080p Height Without Black Bars:

set t19=Adapting Video Resolution to Full 1080p Format...

set t191=Final 1080p Output Video Width:
set t192=Final 1080p Output Video Height:
set t20=Final 2160p Output Video Width:
set t21=Final 2160p Output Video Height:

set t22=Settings of Black Bands to Crop are Correct (Yes/No):
set t23=Manually Entering Black Band Values to Crop... 
set t24=Enter the Upper Black Band Value: 
set t25=Error Entering Upper Black Band Value... It's Not a Number. 
set t26=Enter the Lower Black Band Value: 
set t27=Error Entering Lower Black Band Value... It's Not a Number.
set t28=Enter the Left Black Band Value: 
set t29=Error Entering Left Black Band Value... It's Not a Number.
set t30=Enter the Right Black Band Value: 
set t31=Error Entering Right Black Band Value... It's Not a Number.
set t32=Upper Black Band:
set t33=Lower Black Band:
set t34=Left Black Band:
set t35=Right Black Band:
set t36=2160p Original Video Width without Black Bars:
set t37=2160p Original Video Height without Black Bars:

@REM set t361=1080p Video Width without Black Bars:
@REM set t371=1080p Video Height without Black Bars

set t38=Select Graphic Card you want to Encode with:
set t39=Choose (1/2):
set t40=Select Encoding Type:
set t41=Error Entering Quantization Value... Not a Number. 
set t42=Quantization Value Set to:
set t43=Encoding Settings:
set t44=Enter Quantization value Minimum 10 Maximum 28:
set t45=Quantization Value Out of  Limits  10 / 28  Re-enter^!
set t46=Enter BitRate Value kbs Minimum 100 Maximum 50000:
set t47=Error Entering BitRate Value... It's Not a Number. 
set t48=BitRate Value Set to:
set t49=BitRate Value Out of Limits  100 / 50000  Re-enter^!
set t50=Select Encoding Quality:
set t51=- Worst Quality
set t52=- Best Quality
set t53=Choose (1/2/3/4/5/6/7):
set t54=Quality Set to:
set t55=Apply Convolution3D denoiser Yes/No: 
set t56=Apply PMD denoiser Yes/No: 
set t57=Apply Detail Enhancement Yes/No:  
set t58=Enhancement Detail: Yes 
set t59=Enhancement Detail: No 
set t60=Info
set t61=Videos to Encode Saved!
set t62=Do You Want to Insert Another Video to Encode (Yes/No):
set t63=The dragged file is not a video!
set t64=Choose (1/2/3/4):
set t65=Press Enter toback to Main Menu.  

set t66=Video Width
set t67=Video Height
set t68=Video Codec
set t69=Details Video Codec
set t70=Video Format 
set t71=Configuration Settings to convert video from 8bit or 10bit SDR to 10bit HDR
set t72=Select Encoding UpGrader:
set t73=Settings UpGrader:
set t74=Choose (1/2/3):

set t75=Configuration UpScaling from 1080p 10 bit HDR to 2160p 10 bit HDR 
set t76=Select Operations to Perform:
set t77=1) First Pass Encode for Upscaling and a Second Pass Encode to Clean Up the Video and Enhance Details
set t78=2) Cleanup, Detail Enhancement and Upscaling in a Single Encode

set t79=UpScaling Started.... 
set t80=Denoiser and Detail Enhancement Application Started........ 
set t81=Encoding Finished...
set t1000=Now the PC will be turned off... 

goto avvio_NVEncUpScaling1080p10bitHDR




:caricalinguaitalianoNVEncUpScaling1080p10bitHDR
@REM set t1=Inserimento Info Codifica Hardware Video UpScaling da 1080p 10 bit HDR a 2160p 10 bit HDR e Salvataggio su Disco.

set t2=Trascina Qui il File Video 1080p 10 bit HDR da Convertire in 2160p 10 bit HDR:  
@REM set t211=File Video 1080p 10 bit HDR da Convertire in 2160p 10 bit HDR:  

set t3=File Inesistente 
set t4=Informazioni Video:  

set t5=Il Video inserito e' 1080p 10bit HDR 
@REM set t511=Il Video inserito e' 2160p 10bit SDR 

set t6=Il Video inserito non e' 1080p 10bit HDR 

set t7=Durata del Video in secondi:
set t8=Durata del video in Minuti:
set t9=Intervallo tra i Fotogrammi per il Rilevamento del crop:
set t10= secondi
set t11=Rilevamento Bande Nere Iniziato....
set t12=Rilevazione crop fotogramma
set t13=a secondi
set t14=Eseguita...
set t15=Larghezza Video 2160p Originale:
set t16=Altezza Video 2160p Originale:
set t17=Larghezza Video Originale 1080p  Senza Barre Nere:
set t18=Altezza Video Originale 1080p  Senza Barre Nere:

set t171=Larghezza Video 1080p  Senza Barre Nere:
set t181=Altezza Video 1080p  Senza Barre Nere:

set t19=Adattamento della Risoluzione del Video al Pieno Formato 1080p..

set t191=Larghezza Finale Video 1080p:
set t192=Altezza Finale Video 1080p:
set t20=Larghezza Finale Video 2160p:
set t21=Altezza Finale Video 2160p:

set t22=Le Impostazioni delle Bande Nere da Tagliare sono Corrette (Si/No):
set t23=Inserimento Manuale Valori Bande Nere da Tagliare.. 
set t24=Inserisci il Valore della Banda Nera Superiore: 
set t25=Errore nell'Inserimento del Valore della Banda Nera Superiore... Non e' un Numero. 
set t26=Inserisci il Valore della Banda Nera Inferiore: 
set t27=Errore nell'Inserimento del Valore della Banda Nera Inferiore... Non e' un Numero. 
set t28=Inserisci il Valore della Banda Nera Sinistra: 
set t29=Errore nell'Inserimento del Valore della Banda Nera Sinistra... Non e' un Numero. 
set t30=Inserisci il Valore della Banda Nera Destra: 
set t31=Errore nell'Inserimento del Valore della Banda Nera Destra... Non e' un Numero. 
set t32=Banda Nera Superiore:
set t33=Banda Nera Inferiore:
set t34=Banda Nera Sinistra:
set t35=Banda Nera Destra:
set t36=Larghezza Video Originale 2160p senza Bande Nere:
set t37=Altezza Video Originale 2160p senza Bande Nere:

@REM set t361=Larghezza Video 1080p senza Bande Nere:
@REM set t371=Altezza Video 1080p senza Bande Nere:

set t38=Selezionare Scheda Grafica con cui Eseguire la Codifica:
set t39=Scegli (1/2):
set t40=Selezionare tipo di Codifica:
set t41=Errore nell'Inserimento del Valore della Quantizzazione... Non e' un Numero. 
set t42=Valore Quantizzazzione Impostato a:
set t43=Parametri per codifica:

set t44=Inserire Valore Quantizzazione Minimo 10 Massimo 28:
set t45=Valore Quantizzazzione al di fuori dei  Limiti  10 / 28  Reinserire^!
set t46=Inserire Valore BitRate kbs Minimo 100 Massimo 50000:
set t47=Errore nell'Inserimento del Valore del BitRate... Non e' un Numero. 
set t48=Valore BitRate Impostato a:
set t49=Valore  BitRate al di fuori dei  Limiti  100 / 50000  Reinserire^!

set t50=Selezionare Qualita' Codifica:
set t51=- Peggiore Qualita'
set t52=- Migliore Qualita'
set t53=Scegli (1/2/3/4/5/6/7):
set t54=Qualita' Impostata su:
set t55=Applicare il denoiser Convolution3D Si/No: 
set t56=Applicare il denoiser PMD Si/No: 
set t57=Applicare il Miglioramento Dettagli Si/No:  
set t58=Miglioramento Dettagli: Si 
set t59=Miglioramento Dettagli: No 
set t60=Informazioni
set t61=Video da Codificare Salvate!
set t62=Vuoi Inserire un altro Video da Codificare (Si/No):
set t63=Il file trascinato non e' un video!
set t64=Scegli (1/2/3/4):
set t65=Premi Invio per tornare al Menu' Principale.  

set t66=Larghezza Video
set t67=Altezza Video
set t68=Codec Video
set t69=Codec Video Dettagli
set t70=Format Video 
set t71=Configurazione Parametri per convertire il video da 8bit o 10bit SDR a 10bit HDR
set t72=Selezionare UpGrader Codifica:
set t73=UpGrader Impostato:
set t74=Scegli (1/2/3):

set t75=Configurazione Operazione di UpScaling da 1080p 10 bit HDR a 2160p 10 bit HDR 
set t76=Selezionare Operazioni da Eseguire:
set t77=1) Fare Prima Codifica per UpScaling e Seconda Codifica per Ripulire il Video e Migliorare i Dettagli
set t78=2) Ripulire, Migliorare i Dettagli e Upscaling in un Unica Codifica 

set t79=UpScaling Iniziato.... 
set t80=Applicazione Denoiser e Miglioramento Dettagli Iniziato.... 
set t81=Codifica Terminata...
set t1000=Il PC ora verra' Spento... 

goto avvio_NVEncUpScaling1080p10bitHDR

:avvio_NVEncUpScaling1080p10bitHDR




set /a "numeromovie=1"


:altrivideodainserire_NVEncUpScaling1080p10bitHDR


set NomeFile2160ppuliziadettaggli=
rem set MetadatiStreamHDR10=

set /P NomeFile2160ppuliziadettaggli=!t2!
rem echo Hai digitato: %NomeFile%
rem pause

set "NomeFileSorgente=!NomeFile2160ppuliziadettaggli:"=!"
@REM echo NomeFileSorgente = !NomeFileSorgente!
set "NomeFile=^"!NomeFileSorgente!^""
@REM echo NomeFile = !NomeFile!
rem pause


if exist !NomeFile! ( goto infovideo_NVEncUpScaling1080p10bitHDR ) else ( 
                                                        echo.
                                                        echo !t3!
                                                        echo.
                                                        goto fineinfovideo_NVEncUpScaling1080p10bitHDR
                                                        )    

:infovideo_NVEncUpScaling1080p10bitHDR
echo.
echo !t4!
echo.

.\bin\ffprobe -v error -hide_banner -select_streams v:0 -show_entries stream=width,height,codec_name,codec_long_name,pix_fmt,color_space,color_transfer,color_primaries -of default=noprint_wrappers=1 !NomeFile! > ".\temp\Temp_HDR10_Stream.txt"

set /A x1=1
set /A nohdrcs=0
set /A nohdrct=0
set /A nohdrcp=0
set /A wv=0
set /a hv=0
set /A fv=0

rem echo nohdr = %nohdr%

for /f "tokens=1,2 delims==" %%a in (.\temp\Temp_HDR10_Stream.txt) do (if !x1!==3 ( 
                                                                            echo !t66! "%%a" = %%b  
                                                                            set /A "widthvideo=%%b"
                                                                            rem echo widthvideo = !widthvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !widthvideo! LEQ 1920 if !widthvideo! GEQ 1000 (set /A "wv=1"
                                                                                                                                rem echo wv = !wv!
                                                                                                                                )
                                                                            )
                                                                if !x1!==4 ( 
                                                                            echo !t67! "%%a" = %%b  
                                                                            set /A "heightvideo=%%b"
                                                                            rem echo heightvideo = !heightvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !heightvideo! LEQ 1080 if !heightvideo! GEQ 700 (set /A "hv=1"
                                                                                                        rem echo hv = !hv!
                                                                                                        )
                                                                            )                                                           
                                                                if !x1!==6 ( 
                                                                            echo Color Space "%%a" = %%b  
                                                                            set "colorsp=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colorsp!==bt2020nc (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorsp!==unknown (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorsp!==reserved (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                    
                                                                            ) 
                                                                if !x1!==7 ( 
                                                                            echo Color Transfer "%%a" = %%b  
                                                                            set "colortr=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colortr!==smpte2084 (set /A "nohdrct=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                 
                                                                            ) 
                                                                if !x1!==8 ( 
                                                                            echo Color Primaries "%%a" = %%b  
                                                                            set "colorpr=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colorpr!==bt2020 (set /A "nohdrcp=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            )    
                                                                if !x1!==1 ( 
                                                                            echo !t68! "%%a" = %%b  
                                                                            )       
                                                                if !x1!==2 ( 
                                                                            echo !t69! "%%a" = %%b  
                                                                            )   
                                                                if !x1!==5 ( 
                                                                            echo !t70! "%%a" = %%b  
                                                                            set "formatvideo=%%b"
                                                                            rem echo formatvideo = !formatvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !formatvideo!==yuv420p10le (set /A "fv=1"
                                                                                                        rem echo fv = !fv!
                                                                                                        )
                                                                            )
                                                                set /A x1+=1                                                            
)
echo.

if !x1!==1 goto :novideofile1080p_NVEncUpScaling1080p10bitHDR


if !nohdrcs!==1 if !nohdrct!==1 if !nohdrcp!==1 if !wv!==1 if !hv!==1 if !fv!==1 ( 
                                                                                   echo !t5!
                                                                                   goto rilevazionebandenere_NVEncUpScaling1080p10bitHDR
                                                                                   ) 


echo !t6!
echo.
goto fineinfovideo_NVEncUpScaling1080p10bitHDR



:rilevazionebandenere_NVEncUpScaling1080p10bitHDR

.\bin\ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 %NomeFile%  > ".\temp\durata_film.txt"


set /a contatore=1
for /f "tokens=1 delims=." %%a in (.\temp\durata_film.txt) do  (
                                                        echo. 
                                                        echo !t7! %%a
                                                        set /a "secondi=%%a"
                                                        set /a "minuti=!secondi!/60"
                                                        echo !t8! !minuti!
                                                        set /a "intervallo_tagli=!secondi!/11"
                                                        echo !t9! !intervallo_tagli!!t10!
                                                        echo.
                                                        echo !t11!
                                                        echo.

                                                        

                                                        FOR /L %%a IN (1, 1, 10) DO (
                                                                                    rem echo %%a
                                                                                    set /a "secondi=%%a*!intervallo_tagli!"
                                                                                    rem echo !secondi!

                                                                                    
                                                                                    set /a "ca=72"
                                                                                    rem echo !ca!
                                                                                                                    
                                                                                    set /a "cb=2"
                                                                                    rem echo !cb!
                                                                                                                    
                                                                                    set /a "cc=0"
                                                                                    rem echo !cc!

                                                                                    set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                    rem echo !cr!

                                                                                    .\bin\ffmpeg -ss !secondi! -hide_banner -nostats -i %NomeFile% -vframes 10 -vf !cr! -f null - 2> ".\temp\crop.txt"
                                                                                    
                                                                                    findstr /r "Parsed_cropdetect_0" .\temp\crop.txt >> .\temp\risultato_multiplo.txt   
                                                                                    
                                                                                    echo !t12! %%a !t13! !secondi! !t14!
                                                                                    
                                                                                    )       
                                                                                       

                                                                                    for /f "tokens=1,2 delims==" %%a in (.\temp\risultato_multiplo.txt) do ( echo %%b >> .\temp\crop_multiplo.txt )
                                                                                    
                                                                                    set /a "maxfrequenza=0"

                                                                                    for /f "delims=" %%a in (.\temp\crop_multiplo.txt) do ( 
                                                                                                                                    set "cropconfront=%%a"
                                                                                                                                    rem echo "!cropconfront!"
                                                                                                                                    
                                                                                                                                    set /a "contatorfrequenza=0"
                                                                                                                                    for /f "delims=" %%b in (.\temp\crop_multiplo.txt) do (
                                                                                                                                                                                    set "dato_da_verificare=%%b"
                                                                                                                                                                                    rem echo cropconfront = "!cropconfront!"
                                                                                                                                                                                    rem echo dato_da_verificare = "!dato_da_verificare!"
                                                                                                                                                                                    if !cropconfront!==!dato_da_verificare! ( set /a "contatorfrequenza+=1")
                                                                                                                                                                                    )
                                                                                                                                    if !maxfrequenza! LSS !contatorfrequenza! ( 
                                                                                                                                                                                set /a "maxfrequenza=!!contatorfrequenza!!"
                                                                                                                                                                                set "cropd=!cropconfront!"
                                                                                                                                                                                )
                                                                                                                                    

                                                                                                                                    rem if !cropconfront! in (elenco_crop_frequenza.txt) ()
                                                                                                                                    rem echo !cropconfront!:!contatorfrequenza! >> elenco_crop_frequenza.txt

                                                                                                                                    )

                                                                                    rem echo crop piu' frequente = !cropd! con grequenza = !maxfrequenza!
                                                                                    echo !cropd! > .\temp\crop_finale.txt

                                                                                    for /f "tokens=1,2,3,4 delims=:" %%a in (.\temp\crop_finale.txt) do  ( 
                                                                                                                                                    rem set /a "mwidth=%%a"
                                                                                                                                                    rem echo mwidth = !mwidth!

                                                                                                                                                    rem set /a "mheight=%%b"
                                                                                                                                                    rem echo mheight = !mheight!

                                                                                                                                                    rem set /a "mx=%%c"
                                                                                                                                                    rem echo mx = !mx!

                                                                                                                                                    rem set /a "my=%%d"
                                                                                                                                                    rem echo my = !my!

                                                                                                                                                    if !contatore!==1 ( 
                                                                                                                                                                set /a "wmax=%%a" 
                                                                                                                                                                set /a "hmax=%%b"
                                                                                                                                                                set /a "xmin=%%c"
                                                                                                                                                                set /a "ymin=%%d"
                                                                                                                                                                set /a "mwidth=%%a"
                                                                                                                                                                set /a "mheight=%%b"
                                                                                                                                                                set /a "mx=%%c"
                                                                                                                                                                set /a "my=%%d"
                                                                                                                                                                set /a "contatore+=1"
                                                                                                                                                                )
                                                                                                                                                    
                                                                                                                                                    rem if %%b gtr !hmax! if %%c gtr !xmin! if %%d gtr !ymin! 

                                                                                                                                                    if %%a geq !wmax! if %%b geq !hmax! ( 
                                                                                                                                                                        set /a "wmax=%%a" 
                                                                                                                                                                        set /a "hmax=%%b"
                                                                                                                                                                        set /a "xmin=%%c"
                                                                                                                                                                        set /a "ymin=%%d"
                                                                                                                                                                        set /a "mwidth=%%a"
                                                                                                                                                                        set /a "mheight=%%b"
                                                                                                                                                                        set /a "mx=%%c"
                                                                                                                                                                        set /a "my=%%d"
                                                                                                                                                                        )
                                                                                                                                                    )
                                                                                    echo.
                                                                                    
                                                                                    set /a "mwidth=!mwidth!/2*2"
                                                                                    set /a "mheight=!mheight!/2*2"

                                                                                    set /a "csup=!my!/2*2"
                                                                                    rem echo csup = !csup!
                                                                                                                                    
                                                                                    set /a "csin=!mx!/2*2"
                                                                                    rem echo csin = !csin!

                                                                                    set /a "cinf=(!heightvideo!-!mheight!-!my!)/2*2"
                                                                                    rem echo movieheightreal = !movieheightreal!
                                                                                    rem echo cinf = !cinf!
                                                                                    set /a "cdes=(!widthvideo!-!mwidth!-!mx!)/2*2"
                                                                                    rem echo cdes = !cdes!

                                                                                    echo Crop Settings: --crop !csin!,!csup!,!cdes!,!cinf!    
                                                                                    set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
                                                                                    echo.  
                                                                                    
                                                                                    echo !t17!  !mwidth! 
                                                                                    echo !t18!  !mheight! 
                                                                                    echo.

                                                                                    set /a "larghezza1080pnvenc=1920"
                                                                                    set /a "altezza1080pnvenc=1080"
                                                                                    @REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
                                                                                    @REM echo altezza1080pnvenc = !altezza1080pnvenc!                                    

                                                                                    set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!mwidth!"
                                                                                    set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!mheight!"
                                                                                    @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
                                                                                    @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

                                                                                    if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                                                                                                        @REM echo dentro il 1o if
                                                                                                                                                                        set /a "width2k=!mwidth!"
                                                                                                                                                                        set /a "height2k=!mheight!"
                                                                                                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                                                                                                set /a "width2k=!mwidth!"
                                                                                                                                                                                                                                                                set /a "height2k=!mheight!"
                                                                                                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                                                                                                        set /a "width2k=!mwidth!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        set /a "height2k=!mheight!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "width2k=!mwidth!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "height2k=!mheight!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                                                                                                                set /a "width2k=!mwidth!"
                                                                                                                                                                                                                                                                set /a "height2k=!mheight!"
                                                                                                                                                                                                                                                                )
                                                                                                                                                                        
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                                                                                                        set /a "width2k=!mwidth!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        set /a "height2k=!mheight!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.                         

                                                                                        echo !t191!  !width2k! 
                                                                                        echo !t192!  !height2k!    
                                                                                        echo.

                                                                                        set /a "width4k=width2k*2"
                                                                                        set /a "height4k=height2k*2"

                                                                                        echo !t20!  !width4k! 
                                                                                        echo !t21!  !height4k!    
                                                                                        echo.
                                                                                    )  
                                                        )                          
                                                  

:cropmanuale_NVEncUpScaling1080p10bitHDR
set /a "csup=0"
set /a "cinf=0"
set /a "csin=0"
set /a "cdes=0"
set /a "bandasuperiore=0"
set /a "bandainferiore=0"
set /a "bandasinistra=0"
set /a "bandadestra=0"
set /a "differenzialelarghezza1080pnvenc=0"
set /a "differenzialealtezza1080pnvenc=0"
if exist ".\temp\Temp_HDR10_Stream.txt" ( del ".\temp\Temp_HDR10_Stream.txt" ) 
if exist ".\temp\durata_film.txt" ( del ".\temp\durata_film.txt" )
if exist ".\temp\crop.txt" ( del ".\temp\crop.txt" )
if exist ".\temp\risultato_multiplo.txt" ( del ".\temp\risultato_multiplo.txt" )
if exist ".\temp\crop_multiplo.txt" ( del ".\temp\crop_multiplo.txt" )
if exist ".\temp\crop_finale.txt" ( del ".\temp\crop_finale.txt" )

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t22!"   
    if errorlevel 2 goto cropmanualeinsval_NVEncUpScaling1080p10bitHDR
    if errorlevel 1 goto finecropmanuale_NVEncUpScaling1080p10bitHDR
)

CHOICE /N /C:SN /M "!t22!"   

if errorlevel 2 goto cropmanualeinsval_NVEncUpScaling1080p10bitHDR
if errorlevel 1 goto finecropmanuale_NVEncUpScaling1080p10bitHDR


:cropmanualeinsval_NVEncUpScaling1080p10bitHDR
echo.
echo !t23!
echo.

:banda_superiore_NVEncUpScaling1080p10bitHDR
set /p "bandasuperiore=!t24!"
SET "var="&for /f "delims=0123456789" %%i in ("!bandasuperiore!") do set var=!bandasuperiore!
if defined var (
                echo.
                echo !t25!
                echo.
                goto banda_superiore_NVEncUpScaling1080p10bitHDR
                ) else (
                        set /a "csup=!bandasuperiore!/2*2"
                        )

echo.
:banda_inferiore_NVEncUpScaling1080p10bitHDR
set /p "bandainferiore=!t26!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandainferiore!") do set var=!bandainferiore!
if defined var (
                echo.
                echo !t27!
                echo.
                goto banda_inferiore_NVEncUpScaling1080p10bitHDR
                ) else (
                        set /a "cinf=!bandainferiore!/2*2"
                        )


echo.
:banda_sinistra_NVEncUpScaling1080p10bitHDR
set /p "bandasinistra=!t28!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandasinistra!") do set var=!bandasinistra!
if defined var (
                echo.
                echo !t29!
                echo.
                goto banda_sinistra_NVEncUpScaling1080p10bitHDR
                ) else (
                        set /a "csin=!bandasinistra!/2*2"
                        )

                        
echo.
:banda_destra__NVEncUpScaling1080p10bitHDR
set /p "bandadestra=!t30!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandadestra!") do set var=!bandadestra!
if defined var (
                echo.
                echo !t31!
                echo.
                goto banda_destra__NVEncUpScaling1080p10bitHDR
                ) else (
                        set /a "cdes=!bandadestra!/2*2"
                        )


set /a "larghezza1080pnvenc=1920"
set /a "altezza1080pnvenc=1080"
@REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
@REM echo altezza1080pnvenc = !altezza1080pnvenc!                                    

set /a "mwidth=!mwidth!/2*2"
set /a "mheight=!mheight!/2*2"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "mwidthc=!mwidth!-!csin!-!cdes!"
set /a "mheightc=!mheight!-!csup!-!cinf!"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!mwidthc!"
set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!mheightc!"
@REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
@REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

echo.
echo !t32!  !csup! 
echo !t33!  !cinf! 
echo !t34!  !csin! 
echo !t35!  !cdes! 
echo.


set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
echo Crop Settings: !cropff!
echo.

echo !t17!  !mwidthc! 
echo !t18!  !mheightc! 
echo.



if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                        @REM echo dentro il 1o if
                                                                                        set /a "width2k=!mwidthc!"
                                                                                        set /a "height2k=!mheightc!"
                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                set /a "width2k=!mwidthc!"
                                                                                                                                                                                set /a "height2k=!mheightc!"
                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                        set /a "width2k=!mwidthc!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                        set /a "height2k=!mheightc!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                set /a "width2k=!mwidthc!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                set /a "height2k=!mheightc!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                )
                                                                                        if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                        set /a "width2k=!mwidthc!"
                                                                                                                                                                        set /a "height2k=!mheightc!"
                                                                                                                                                                        )
                                                                                                                                                                        
                                                                                        if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                set /a "width2k=!mwidthc!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                set /a "height2k=!mheightc!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.                         

                                                                                        echo !t191!  !width2k! 
                                                                                        echo !t192!  !height2k!    
                                                                                        echo.

                                                                                        set /a "width4k=width2k*2"
                                                                                        set /a "height4k=height2k*2"

                                                                                        echo !t20!  !width4k! 
                                                                                        echo !t21!  !height4k!    
                                                                                        echo.
                                                                                    ) 

goto cropmanuale_NVEncUpScaling1080p10bitHDR

:finecropmanuale_NVEncUpScaling1080p10bitHDR





rem//////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////


:InserimentoImpostazioniNVEnc__NVEncUpScaling1080p10bitHDR

echo.
echo !t40!
echo.
echo 1) CQP 
echo 2) VBR 
echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto CodificaVBRNVEnc__NVEncUpScaling1080p10bitHDR
if errorlevel 1 goto CodificaCQPNVEnc__NVEncUpScaling1080p10bitHDR

:CodificaVBRNVEnc__NVEncUpScaling1080p10bitHDR
set "TipoCodificaNVEnc=--vbr "
set /a "quantizzazioneNVEnc=0"
goto inserimentoValoriCQPVBRNVEnc__NVEncUpScaling1080p10bitHDR

:CodificaCQPNVEnc__NVEncUpScaling1080p10bitHDR
set "TipoCodificaNVEnc=--cqp "
set /a "quantizzazioneNVEnc=1"

:inserimentoValoriCQPVBRNVEnc__NVEncUpScaling1080p10bitHDR

if !quantizzazioneNVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneNVEnc=!t44! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneNVEnc!") do set var=!valoreQuantizzazioneNVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                goto inserimentoValoriCQPVBRNVEnc__NVEncUpScaling1080p10bitHDR
                                                ) 

                                set /a "valoreQuantizzazioneNVEnc=!valoreQuantizzazioneNVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneNVEnc!
                                if !valoreQuantizzazioneNVEnc! GEQ 10 if !valoreQuantizzazioneNVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneNVEnc!
                                                                                                                set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreQuantizzazioneNVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                                goto fineQuantizzazioneNVEnc__NVEncUpScaling1080p10bitHDR
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRNVEnc__NVEncUpScaling1080p10bitHDR
                                                                                                                        
                                )



if !quantizzazioneNVEnc!==0 (
                                echo.
                                set /p "valoreBitRateNVEnc=!t46! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateNVEnc!") do set var=!valoreBitRateNVEnc!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                goto inserimentoValoriCQPVBRNVEnc__NVEncUpScaling1080p10bitHDR
                                                ) 
                                set /a "valoreBitRateNVEnc=!valoreBitRateNVEnc!"
                                @REM echo valoreBitRateNVEnc = !valoreBitRateNVEnc!
                                if !valoreBitRateNVEnc! GEQ 100 if !valoreBitRateNVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateNVEnc!
                                                                                                        set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreBitRateNVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                        goto fineQuantizzazioneNVEnc__NVEncUpScaling1080p10bitHDR
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRNVEnc__NVEncUpScaling1080p10bitHDR
                                                                                                              
                                )


:fineQuantizzazioneNVEnc__NVEncUpScaling1080p10bitHDR



echo.
echo !t50!
echo.
echo 1) P1 !t51!
echo 2) P2 
echo 3) P3 
echo 4) P4 
echo 5) P5 
echo 6) P6 
echo 7) P7 !t52!
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto P7NVEnc__NVEncUpScaling1080p10bitHDR
if errorlevel 6 goto P6NVEnc__NVEncUpScaling1080p10bitHDR
if errorlevel 5 goto P5NVEnc__NVEncUpScaling1080p10bitHDR
if errorlevel 4 goto P4NVEnc__NVEncUpScaling1080p10bitHDR
if errorlevel 3 goto P3NVEnc__NVEncUpScaling1080p10bitHDR
if errorlevel 2 goto P2NVEnc__NVEncUpScaling1080p10bitHDR
if errorlevel 1 goto P1NVEnc__NVEncUpScaling1080p10bitHDR


:P7NVEnc__NVEncUpScaling1080p10bitHDR
set "SettaggioQualitaNVEnc=--preset P7"
set "QualitySetting=P7"
goto fineQualitCodificaNVEnc__NVEncUpScaling1080p10bitHDR

:P6NVEnc__NVEncUpScaling1080p10bitHDR
set "SettaggioQualitaNVEnc=--preset P6"
set "QualitySetting=P6"
goto fineQualitCodificaNVEnc__NVEncUpScaling1080p10bitHDR

:P5NVEnc__NVEncUpScaling1080p10bitHDR
set "SettaggioQualitaNVEnc=--preset P5"
set "QualitySetting=P5"
goto fineQualitCodificaNVEnc__NVEncUpScaling1080p10bitHDR

:P4NVEnc__NVEncUpScaling1080p10bitHDR
set "SettaggioQualitaNVEnc=--preset P4"
set "QualitySetting=P4"
goto fineQualitCodificaNVEnc__NVEncUpScaling1080p10bitHDR

:P3NVEnc__NVEncUpScaling1080p10bitHDR
set "SettaggioQualitaNVEnc=--preset P3"
set "QualitySetting=P3"
goto fineQualitCodificaNVEnc__NVEncUpScaling1080p10bitHDR

:P2NVEnc__NVEncUpScaling1080p10bitHDR
set "SettaggioQualitaNVEnc=--preset P2"
set "QualitySetting=P2"
goto fineQualitCodificaNVEnc__NVEncUpScaling1080p10bitHDR

:P1NVEnc__NVEncUpScaling1080p10bitHDR
set "SettaggioQualitaNVEnc=--preset P1"
set "QualitySetting=P1"
goto fineQualitCodificaNVEnc__NVEncUpScaling1080p10bitHDR


:fineQualitCodificaNVEnc__NVEncUpScaling1080p10bitHDR
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaNVEnc!



:sceltadenoiser
set conv3d1080p=
set pmd1080p=
set /a unicopassaggio=0

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t55!"
    if errorlevel 2 goto conv3dChoosenNoNVEnc__NVEncUpScaling1080p10bitHDR
    if errorlevel 1 goto conv3dChoosenYesNVEncUpScaling2__NVEncUpScaling1080p10bitHDR
)

echo.
CHOICE /N /C:SN /M "!t55!"

if errorlevel 2 goto conv3dChoosenNoNVEnc__NVEncUpScaling1080p10bitHDR
if errorlevel 1 goto conv3dChoosenYesNVEncUpScaling2__NVEncUpScaling1080p10bitHDR

:conv3dChoosenNoNVEnc__NVEncUpScaling1080p10bitHDR
set "conv3d1080p=N"
goto sceltaDeniserPMDNVEnc__NVEncUpScaling1080p10bitHDR

:conv3dChoosenYesNVEncUpScaling2__NVEncUpScaling1080p10bitHDR
set "conv3d1080p=S"



:sceltaDeniserPMDNVEnc__NVEncUpScaling1080p10bitHDR

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t56!"
    if errorlevel 2 goto PMDChoosenNoNVEnc__NVEncUpScaling1080p10bitHDR
    if errorlevel 1 goto PMDChoosenYesNVEnc__NVEncUpScaling1080p10bitHDR
)

echo.
CHOICE /N /C:SN /M "!t56!"

if errorlevel 2 goto PMDChoosenNoNVEnc__NVEncUpScaling1080p10bitHDR
if errorlevel 1 goto PMDChoosenYesNVEnc__NVEncUpScaling1080p10bitHDR

:PMDChoosenNoNVEnc__NVEncUpScaling1080p10bitHDR
set "pmd1080p=N"
goto assegnazioneDenoisesNVEnc__NVEncUpScaling1080p10bitHDR

:PMDChoosenYesNVEnc__NVEncUpScaling1080p10bitHDR
set "pmd1080p=S"


:assegnazioneDenoisesNVEnc__NVEncUpScaling1080p10bitHDR
set /A nvdenv=0

if !conv3d1080p!==S if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00 --vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!.
                                        )
if !conv3d1080p!==S if !pmd1080p!==N ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )
if !conv3d1080p!==N if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )
if !conv3d1080p!==N if !pmd1080p!==N ( 
                                        set "nvdenoiser=" 
                                        set "nvdenv=1"
                                        set "unicopassaggio=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: Nessun Denoiser 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )

@REM pause


echo.

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t57!"
    if errorlevel 2 goto ApplicaMiglioramentoDettagliNVEncNo__NVEncUpScaling1080p10bitHDR
    if errorlevel 1 goto ApplicaMiglioramentoDettagliNVEncSI__NVEncUpScaling1080p10bitHDR
)

CHOICE /N /C:SN /M "!t57!"

if errorlevel 2 goto ApplicaMiglioramentoDettagliNVEncNo__NVEncUpScaling1080p10bitHDR
if errorlevel 1 goto ApplicaMiglioramentoDettagliNVEncSI__NVEncUpScaling1080p10bitHDR

:ApplicaMiglioramentoDettagliNVEncNo__NVEncUpScaling1080p10bitHDR
set "miglioramento1080p=N"
goto fineSceltaMigliaramentiNVEnc__NVEncUpScaling1080p10bitHDR

:ApplicaMiglioramentoDettagliNVEncSI__NVEncUpScaling1080p10bitHDR
set "miglioramento1080p=S"

:fineSceltaMigliaramentiNVEnc__NVEncUpScaling1080p10bitHDR
if !miglioramento1080p!==S ( 
                                set "edgeleveling=--vpp-edgelevel strength=10.0,threshold=24.0,black=6,white=0" 
                                echo.
                                echo NVEnc !t58!
                                echo.
                                )
if !miglioramento1080p!==N ( 
                                set "edgeleveling=" 
                                echo.
                                echo NVEnc !t59!
                                echo.
                                )


@REM pause


if !nvdenoiser!==nessuno if !edgeleveling!==nessuno (
                                                        set "unicopassaggio=1"
                                                        goto fineConfigurazioneOperazioniUpScalingNVEnc_NVEncUpScaling1080p10bitHDR
                                                        )

echo.
echo !t75!
echo !t76!
echo.
echo !t77!
echo !t78!

echo.
CHOICE /N /C:123 /M "!t39!"

if errorlevel 2 goto OperazioniUpScalingSingolaCodificaNvEnc_NVEncUpScaling1080p10bitHDR
if errorlevel 1 goto OperazioniUpScalingDoppiaCodificaNvEnc_NVEncUpScaling1080p10bitHDR

:OperazioniUpScalingSingolaCodificaNvEnc_NVEncUpScaling1080p10bitHDR
set "unicopassaggio=1"
goto fineConfigurazioneOperazioniUpScalingNVEnc_NVEncUpScaling1080p10bitHDR

:OperazioniUpScalingDoppiaCodificaNvEnc_NVEncUpScaling1080p10bitHDR
set "unicopassaggio=0"

:fineConfigurazioneOperazioniUpScalingNVEnc_NVEncUpScaling1080p10bitHDR




echo.
echo !t79!
echo.

set file_senza_virgolette=%NomeFile:"=%
rem echo %file_senza_virgolette%

set file_senza_estensione=%file_senza_virgolette:.mkv=%
rem echo %file_senza_estensione%

set fileoutput2160p="%file_senza_estensione%_UpScaled.mkv"

@REM echo miglioramento1080p = !miglioramento1080p!
@REM echo.
@REM pause 


if !miglioramento1080p!==S (
                                @REM echo dento if S
                                set fileoutput2160pdetailed2="!file_senza_estensione!_UpScaled 2160p.mkv"
                                @REM echo fileoutput2160pdetailed2 = !fileoutput2160pdetailed2!
                                set fileoutput2160pdetailed="!file_senza_estensione!_UpScaled 2160p_pul_leggera.mkv"
                                @REM echo fileoutput2160pdetailed = !fileoutput2160pdetailed!
                                )

if !miglioramento1080p!==N  (
                                @REM echo dento if N
                                set fileoutput2160pdetailed2="!file_senza_estensione!_UpScaled 2160p.mkv"
                                @REM echo fileoutput2160pdetailed2 = !fileoutput2160pdetailed2!
                                set fileoutput2160pdetailed="!file_senza_estensione!_UpScaled 2160p_pul_leggera.mkv"
                                @REM echo fileoutput2160pdetailed = !fileoutput2160pdetailed!
                                )


set fileoutput2160pdetailed_senza_virgolette=!fileoutput2160pdetailed:"=! 
rem echo !fileoutput2160pdetailed_senza_virgolette!


for %%i in ("!fileoutput2160pdetailed_senza_virgolette!") do (  
                                                                set "solo_nome_file=%%~ni"
                                                                rem echo Nome file: !solo_nome_file!

                                                                set "solo_estensione_file=%%~xi"
                                                                rem echo Estensione: !solo_estensione_file!
                                                                )

set fileoutput2160pdetailed_rinominato=!solo_nome_file!_rinominato!solo_estensione_file!

rem echo %fileoutput2160pdetailed_rinominato%



set fileoutput2160pdetailed2_senza_virgolette=!fileoutput2160pdetailed2:"=! 
rem echo %fileoutput2160pdetailed2_senza_virgolette%

for %%i in ("!fileoutput2160pdetailed2_senza_virgolette!") do (  
                                                                set "solo_nome_file=%%~ni"
                                                                rem echo Nome file: !solo_nome_file!

                                                                set "solo_estensione_file=%%~xi"
                                                                rem echo Estensione: !solo_estensione_file!
                                                                )

set fileoutput2160pdetailed2_rinominato=!solo_nome_file!_rinominato!solo_estensione_file!

rem echo %fileoutput2160pdetailed2_rinominato%

if exist ".\temp\Temp_HDR10_Stream.txt" ( del .\temp\Temp_HDR10_Stream.txt )
if exist ".\temp\durata_film.txt" ( del .\temp\durata_film.txt )
if exist ".\temp\crop.txt" ( del .\temp\crop.txt )
if exist ".\temp\risultato_multiplo.txt" ( del .\temp\risultato_multiplo.txt )
if exist ".\temp\crop_multiplo.txt" ( del .\temp\crop_multiplo.txt )
if exist ".\temp\crop_finale.txt" ( del .\temp\crop_finale.txt )

if !unicopassaggio!==1 ( goto codificaunicopassaggio1080p10bitHDR_NVEncUpScaling1080p10bitHDR )

rem echo fileoutput2160p = %fileoutput2160p%
rem echo fileoutput2160pdetailed = %fileoutput2160pdetailed%

".\bin\nvenc\NVEncC64.exe" --avsw --device 0 -i !NomeFile!  --output-res !width4k!x!height4k!  !cropff! --video-metadata clear --metadata clear --chapter-copy -c hevc !tipoQuantizzazioneNVEnc! --bref-mode disabled !SettaggioQualitaNVEnc! --lookahead 32 --aq --aq-temporal --aq-strength 15  --profile main10 --level auto --tier high --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display copy --max-cll copy  --output-depth 10 --multipass None --mv-precision Q-pel --avsync cfr --psnr --ssim     -m default_mode:infer_no_subs      --vpp-resize algo=lanczos4  --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o !fileoutput2160p!

echo.
echo !t80!
echo.

".\bin\nvenc\NVEncC64.exe" --avhw --device 0 -i !fileoutput2160p!  --crop 0,0,0,0  --video-metadata clear --metadata clear --chapter-copy -c hevc !tipoQuantizzazioneNVEnc! --bref-mode disabled !SettaggioQualitaNVEnc! --tier high --lookahead 32 --aq --aq-temporal --aq-strength 15 --level auto --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display copy --max-cll copy --output-depth 10 --multipass None --mv-precision Q-pel --avsync cfr     -m default_mode:infer_no_subs  !nvdenoiser! !edgeleveling!  --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off  --log-level info --log ".\codifica_hardware_out_log.txt" -o !fileoutput2160pdetailed!

ren !fileoutput2160pdetailed! "!fileoutput2160pdetailed_rinominato!"

if !unicopassaggio!==0 ( goto fineupscalingdoppiopassaggio1080p10bitHDR_NVEncUpScaling1080p10bitHDR )

:codificaunicopassaggio1080p10bitHDR_NVEncUpScaling1080p10bitHDR

".\bin\nvenc\NVEncC64.exe" --avsw --device 0 -i !NomeFile!  --output-res !width4k!x!height4k!  !cropff! --video-metadata clear --metadata clear --chapter-copy -c hevc !tipoQuantizzazioneNVEnc! --bref-mode disabled !SettaggioQualitaNVEnc! --lookahead 32 --aq --aq-temporal --aq-strength 15  --profile main10 --level auto --tier high --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display copy --max-cll copy  --output-depth 10 --multipass None --mv-precision Q-pel --avsync cfr --psnr --ssim     -m default_mode:infer_no_subs      --vpp-resize algo=lanczos4  !nvdenoiser! !edgeleveling!  --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o !fileoutput2160pdetailed2!

ren !fileoutput2160pdetailed2! "!fileoutput2160pdetailed2_rinominato!"

:fineupscalingdoppiopassaggio1080p10bitHDR_NVEncUpScaling1080p10bitHDR

echo.
echo !t81!
echo.



goto fineinfovideo_NVEncUpScaling1080p10bitHDR




:novideofile1080p_NVEncUpScaling1080p10bitHDR
echo !t63!
echo.


:fineinfovideo_NVEncUpScaling1080p10bitHDR

if exist ".\saved\settings.dat" (
                                for /f "tokens=1,2 delims=|" %%a in (.\saved\settings.dat) do (
                                                                                                    rem echo %%a
                                                                                                    rem echo %%b
                                                                                                    set /a "shst=%%b"
                                                                                                    rem echo !shst!
                                                                                                    rem pause
                                                                                                    if !shst!==1 (
                                                                                                                echo !t1000!
                                                                                                                echo.
                                                                                                                shutdown /s
                                                                                                                set /a "delay=10"
                                                                                                                timeout /t !delay!
                                                                                                                exit
                                                                                                                )
                                                                                                                            
                                                                                                    )                                                                                                  
                                                                                                )

if exist ".\temp\Temp_HDR10_Stream.txt" ( del .\temp\Temp_HDR10_Stream.txt )
if exist ".\temp\durata_film.txt" ( del .\temp\durata_film.txt )
if exist ".\temp\crop.txt" ( del .\temp\crop.txt )
if exist ".\temp\risultato_multiplo.txt" ( del .\temp\risultato_multiplo.txt )
if exist ".\temp\crop_multiplo.txt" ( del .\temp\crop_multiplo.txt )
if exist ".\temp\crop_finale.txt" ( del .\temp\crop_finale.txt )
      




set waitenter=
set /P waitenter=!t65!
Endlocal
goto menuiniziale







rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:TaglioSpezzoneVideo

cls
setLocal EnableExtensions EnableDelayedExpansion


for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoTaglioSpezzoneVideo
)

if %lingua%==inglese (
    goto caricalinguaingleseTaglioSpezzoneVideo
)



:caricalinguaingleseTaglioSpezzoneVideo
set t1=Cutting a Clip from a Video File.....  
set t2=Drag the Input Video File to Cut a Clip:  
set t3=Input Video File does not Exist. 
set t4=Now you need to insert the Points where you want to Cut the Clip...  
set t5=Enter the Minutes of the Starting Point of the Cut:  
set t6=Enter the Seconds of the Starting Point of the Cut:  
set t7=Enter the Minutes of the End Point of the Cut:  
set t8=Enter the Seconds of the End Point of the Cut:  
set t9=Starting Point of the Cut in Seconds:
set t10=End Point of the Cut in Seconds:
set t11=Video Clip Cutting Started....
set t12=Video Clip Cutting Completed.
set t13=Press Enter to Back to Main Menu:  
set t14=Entered Value is not a Number....
goto finecaricamentolinguaTaglioSpezzoneVideo



:caricalinguaitalianoTaglioSpezzoneVideo
set t1=Taglio di Uno Spezzone da un File Video.....  
set t2=Trascina Qui il File Video di Input da cui tagliare uno Spezzone:  
set t3=File Video di Input Inesistente. 
set t4=Ora vanno Inseriti i Punti in cui Tagliare lo Spezzone...  
set t5=Inserire i Minuti del Punto Iniziale del Taglio:  
set t6=Inserire i Secondi del Punto Iniziale del Taglio:  
set t7=Inserire i Minuti del Punto Finale del Taglio:  
set t8=Inserire i Secondi del Punto Finale del Taglio:  
set t9=Punto Inziale Taglio in Secondi:
set t10=Punto Finale Taglio in Secondi:
set t11=Avvio Taglio Spezzone Video Iniziato....
set t12=Taglio Spezzone Video Terminato.
set t13=Premi Invio per tornare al Menu' Principale:  

set t14=Il Valore Inserito non e' un Numero....
goto finecaricamentolinguaTaglioSpezzoneVideo


:finecaricamentolinguaTaglioSpezzoneVideo





set NomeFileSorgenteFFmpeg=
set NomeFileOutputFFmpeg=





echo !t1!
echo.

set /P NomeFileSorgenteFFmpeg=!t2!
rem echo Hai digitato: %NomeFile%
rem pause

if exist %NomeFileSorgenteFFmpeg% ( goto InserimentoInfoTaglio ) else ( 
                                                                            echo.
                                                                            echo !t3!
                                                                            echo.
                                                                            goto finerealehdrffpmegTaglio
                                                                            )    

:InserimentoInfoTaglio

echo.
echo !t4!

:inserimento_punto_iniziale_taglio_in_minuti
echo.
set /P puntoInizialeMinuti=!t5!
SET "var="&for /f "delims=0123456789" %%i in ("!puntoInizialeMinuti!") do set var=!puntoInizialeMinuti!
                                if defined var (
                                                echo.
                                                echo !t14!
                                                goto inserimento_punto_iniziale_taglio_in_minuti
                                                ) 
set /a InizioMinuti=!puntoInizialeMinuti!
@REM echo InizioMinuti=!puntoInizialeMinuti!


:inserimento_punto_iniziale_taglio_in_secondi
echo.
set /P puntoInizialeSecondi=!t6!
SET "var="&for /f "delims=0123456789" %%i in ("!puntoInizialeSecondi!") do set var=!puntoInizialeSecondi!
                                if defined var (
                                                echo.
                                                echo !t14!
                                                goto inserimento_punto_iniziale_taglio_in_secondi
                                                ) 
set /a InizioSecondi=!puntoInizialeSecondi!
@REM echo InizioSecondi=!puntoInizialeSecondi!


:inserimento_punto_finale_taglio_in_minuti
echo.
set /P puntoFinaleMinuti=!t7!
SET "var="&for /f "delims=0123456789" %%i in ("!puntoFinaleMinuti!") do set var=!puntoFinaleMinuti!
                                if defined var (
                                                echo.
                                                echo !t14!
                                                goto inserimento_punto_finale_taglio_in_minuti
                                                ) 
set /a FineMinuti=!puntoFinaleMinuti!
@REM echo FineMinuti=!puntoFinaleMinuti!


:inserimento_punto_finale_taglio_in_secondi
echo.
set /P puntoFinaleSecondi=!t8!
SET "var="&for /f "delims=0123456789" %%i in ("!puntoFinaleSecondi!") do set var=!puntoFinaleSecondi!
                                if defined var (
                                                echo.
                                                echo !t14!
                                                goto inserimento_punto_finale_taglio_in_secondi
                                                ) 
set /a FineSecondi=!puntoFinaleSecondi!
@REM echo FineSecondi=!puntoFinaleSecondi!

echo.
echo.
set /a InizioINSecondi=(!InizioMinuti!*60)+!InizioSecondi!
echo !t9! !InizioINSecondi!

echo.
set /a FineINSecondi=(!FineMinuti!*60)+!FineSecondi!
echo !t10! !FineINSecondi!


set file_senza_virgolette=%NomeFileSorgenteFFmpeg:"=%
@REM echo %file_senza_virgolette%

set file_senza_estensione=%file_senza_virgolette:.mkv=%
@REM echo %file_senza_estensione%

set fileoutput2160p="%file_senza_estensione%_Spezzone_Video_da_!InizioINSecondi!_secondi_a_!FineINSecondi!_secondi.mkv"
@REM echo fileoutput2160p = %fileoutput2160p%

echo.
echo.
echo !t11!

echo.

.\bin\ffmpeg   -hide_banner -stats -loglevel panic  -y -ss !InizioINSecondi! -to !FineINSecondi!    -i !NomeFileSorgenteFFmpeg!   -max_muxing_queue_size 1024 -map 0:0   -c:v copy -an -sn   !fileoutput2160p!


echo.
echo !t12!

echo.
echo.

:finerealehdrffpmegTaglio




set waitenter=
set /P waitenter=!t13!
Endlocal
goto puliziainiziale










rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

cls
setLocal EnableExtensions EnableDelayedExpansion


for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoNVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
)

if %lingua%==inglese (
    goto caricalinguaingleseNVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
)



:caricalinguaingleseNVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
@REM set t1=Insert Hardware Video Encoding Info DownGrading and DownScaling from 2160p 10 bit HDR to  1080p 8 bit SDR and Saving to Disk

set t2=Drag Here the Video File 2160p 10 bit HDR to Convert to 1080p 8 bit SDR:  
@REM set t211=Video File 2160p 10 bit HDR to Convert to  1080p 8 bit SDR:  

set t3=File does not exist 
set t4=Info Video:  
set t5=The Inserted Video is 2160p 10bit HDR 
set t6=The Inserted Video isn't 2160p 10bit HDR 
set t7=Video Duration in seconds:
set t8=Video Duration in Minutes:
set t9=Interval between Frames for Crop Detection:
set t10= seconds
set t11=Black Bands Detection Started....
set t12=Crop Detection to Frame
set t13=to seconds
set t14=Done...
set t15=Original 2160p Video Width: 
set t16=Original 2160p Video Height:
set t17=Output Video 2160p Width Without Black Bars:
set t18=Outout Video 2160p Height Without Black Bars:

set t171=Output Video 1080p Width Without Black Bars:
set t181=Outout Video 1080p Height Without Black Bars:

set t19=Adapting Video Resolution to Full 1080p Format...
set t20=Final 1080p Output Video Width:
set t21=Final 1080p Output Video Height:
set t22=Settings of Black Bands to Crop are Correct (Yes/No):
set t23=Manually Entering Black Band Values to Crop... 
set t24=Enter the Upper Black Band Value: 
set t25=Error Entering Upper Black Band Value... It's Not a Number. 
set t26=Enter the Lower Black Band Value: 
set t27=Error Entering Lower Black Band Value... It's Not a Number.
set t28=Enter the Left Black Band Value: 
set t29=Error Entering Left Black Band Value... It's Not a Number.
set t30=Enter the Right Black Band Value: 
set t31=Error Entering Right Black Band Value... It's Not a Number.
set t32=Upper Black Band:
set t33=Lower Black Band:
set t34=Left Black Band:
set t35=Right Black Band:
set t36=2160p Video Width without Black Bars:
set t37=2160p Video Height without Black Bars

set t361=1080p Video Width without Black Bars:
set t371=1080p Video Height without Black Bars

set t38=Select Graphic Card you want to Encode with:
set t39=Choose (1/2):
set t40=Select Encoding Type:
set t41=Error Entering Quantization Value... Not a Number. 
set t42=Quantization Value Set to:
set t43=Encoding Settings:
set t44=Enter Quantization value Minimum 10 Maximum 28:
set t45=Quantization Value Out of  Limits  10 / 28  Re-enter^!
set t46=Enter BitRate Value kbs Minimum 100 Maximum 50000:
set t47=Error Entering BitRate Value... It's Not a Number. 
set t48=BitRate Value Set to:
set t49=BitRate Value Out of Limits  100 / 50000  Re-enter^!
set t50=Select Encoding Quality:
set t51=- Worst Quality
set t52=- Best Quality
set t53=Choose (1/2/3/4/5/6/7):
set t54=Quality Set to:
set t55=Apply Convolution3D denoiser Yes/No: 
set t56=Apply PMD denoiser Yes/No: 
set t57=Apply Detail Enhancement Yes/No:  
set t58=Enhancement Detail: Yes 
set t59=Enhancement Detail: No 
set t60=Info
set t61=Videos to Encode Saved!
set t62=Do You Want to Insert Another Video to Encode (Yes/No):
set t63=The dragged file is not a video!
set t64=Choose (1/2/3/4):
set t65=Press Enter to back to Main Menu.  

set t66=Video Width
set t67=Video Height
set t68=Video Codec
set t69=Details Video Codec
set t70=Video Format 
set t71=Configuration Settings to convert video from 10bit HDR to 8bit SDR
set t72=Select Encoding DownGrader:
set t73=Settings DownGrader:

set t74=DownScaling and DownGrading Started.... 
set t75=Encoding Finished...
set t1000=Now the PC will be turned off... 

goto avvio_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR




:caricalinguaitalianoNVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
@REM set t1=Inserimento Info Codifica Hardware Video DownGrading e DownScalingda 2160p 10 bit HDR a 1080p 8 bit SDR e Salvataggio su Disco.

set t2=Trascina Qui il File Video 2160p 10 bit HDR da Convertire in 1080p 8 bit SDR:  
@REM set t211=File Video 2160p 10 bit HDR da Convertire in  1080p 8 bit SDR:  

set t3=File Inesistente 
set t4=Informazioni Video:  
set t5=Il Video inserito e' 2160p 10bit HDR 
set t6=Il Video inserito non e' 2160p 10bit HDR 
set t7=Durata del Video in secondi:
set t8=Durata del video in Minuti:
set t9=Intervallo tra i Fotogrammi per il Rilevamento del crop:
set t10= secondi
set t11=Rilevamento Bande Nere Iniziato....
set t12=Rilevazione crop fotogramma
set t13=a secondi
set t14=Eseguita...
set t15=Larghezza Video 2160p Originale:
set t16=Altezza Video 2160p Originale:
set t17=Larghezza Video 2160p  Senza Barre Nere:
set t18=Altezza Video 2160p  Senza Barre Nere:

set t171=Larghezza Video 1080p  Senza Barre Nere:
set t181=Altezza Video 1080p  Senza Barre Nere:

set t19=Adattamento della Risoluzione del Video al Pieno Formato 1080p..
set t20=Larghezza Finale Video 1080p:
set t21=Altezza Finale Video 1080p:
set t22=Le Impostazioni delle Bande Nere da Tagliare sono Corrette (Si/No):
set t23=Inserimento Manuale Valori Bande Nere da Tagliare.. 
set t24=Inserisci il Valore della Banda Nera Superiore: 
set t25=Errore nell'Inserimento del Valore della Banda Nera Superiore... Non e' un Numero. 
set t26=Inserisci il Valore della Banda Nera Inferiore: 
set t27=Errore nell'Inserimento del Valore della Banda Nera Inferiore... Non e' un Numero. 
set t28=Inserisci il Valore della Banda Nera Sinistra: 
set t29=Errore nell'Inserimento del Valore della Banda Nera Sinistra... Non e' un Numero. 
set t30=Inserisci il Valore della Banda Nera Destra: 
set t31=Errore nell'Inserimento del Valore della Banda Nera Destra... Non e' un Numero. 
set t32=Banda Nera Superiore:
set t33=Banda Nera Inferiore:
set t34=Banda Nera Sinistra:
set t35=Banda Nera Destra:
set t36=Larghezza Video 2160p senza Bande Nere:
set t37=Altezza Video 2160p senza Bande Nere:

set t361=Larghezza Video 1080p senza Bande Nere:
set t371=Altezza Video 1080p senza Bande Nere:

set t38=Selezionare Scheda Grafica con cui Eseguire la Codifica:
set t39=Scegli (1/2):
set t40=Selezionare tipo di Codifica:
set t41=Errore nell'Inserimento del Valore della Quantizzazione... Non e' un Numero. 
set t42=Valore Quantizzazzione Impostato a:
set t43=Parametri per codifica:

set t44=Inserire Valore Quantizzazione Minimo 10 Massimo 28:
set t45=Valore Quantizzazzione al di fuori dei  Limiti  10 / 28  Reinserire^!
set t46=Inserire Valore BitRate kbs Minimo 100 Massimo 50000:
set t47=Errore nell'Inserimento del Valore del BitRate... Non e' un Numero. 
set t48=Valore BitRate Impostato a:
set t49=Valore  BitRate al di fuori dei  Limiti  100 / 50000  Reinserire^!

set t50=Selezionare Qualita' Codifica:
set t51=- Peggiore Qualita'
set t52=- Migliore Qualita'
set t53=Scegli (1/2/3/4/5/6/7):
set t54=Qualita' Impostata su:
set t55=Applicare il denoiser Convolution3D Si/No: 
set t56=Applicare il denoiser PMD Si/No: 
set t57=Applicare il Miglioramento Dettagli Si/No:  
set t58=Miglioramento Dettagli: Si 
set t59=Miglioramento Dettagli: No 
set t60=Informazioni
set t61=Video da Codificare Salvate!
set t62=Vuoi Inserire un altro Video da Codificare (Si/No):
set t63=Il file trascinato non e' un video!
set t64=Scegli (1/2/3/4):
set t65=Premi Invio per tornare al Menu' Principale.  

set t66=Larghezza Video
set t67=Altezza Video
set t68=Codec Video
set t69=Codec Video Dettagli
set t70=Format Video 
set t71=Configurazione Parametri per convertire il video da 10bit HDR a 8bit SDR
set t72=Selezionare DownGrader Codifica:
set t73=DownGrader Impostato:

set t74=DownScaling e DownGrading Iniziati.... 
set t75=Codifica Terminata...
set t1000=Il PC ora verra' Spento... 


goto avvio_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:avvio_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR



set /a "numeromovie=1"


:altrivideodainserireNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR


set NomeFile2160ppuliziadettaggli=
rem set MetadatiStreamHDR10=

set /P NomeFile2160ppuliziadettaggli=!t2! 
rem echo Hai digitato: %NomeFile%
rem pause

set "NomeFileSorgente=!NomeFile2160ppuliziadettaggli:"=!"
@REM echo NomeFileSorgente = !NomeFileSorgente!
set "NomeFile=^"!NomeFileSorgente!^""
@REM echo NomeFile = !NomeFile!
@REM pause


if exist %NomeFile% ( goto infovideo_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR ) else ( 
                                                        echo.
                                                        echo !t3!
                                                        echo.
                                                        goto fineinfovideo_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
                                                        )    



:infovideo_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
echo.
echo !t4!
echo.

.\bin\ffprobe -v error -hide_banner -select_streams v:0 -show_entries stream=width,height,codec_name,codec_long_name,pix_fmt,color_space,color_transfer,color_primaries -of default=noprint_wrappers=1 !NomeFile! > ".\temp\Temp_HDR10_Stream.txt"

set /A x1=1
set /A nohdrcs=0
set /A nohdrct=0
set /A nohdrcp=0
set /A wv=0
set /a hv=0
set /A fv=0

rem echo nohdr = %nohdr%

for /f "tokens=1,2 delims==" %%a in (.\temp\Temp_HDR10_Stream.txt) do (if !x1!==3 ( 
                                                                            echo !t66! "%%a" = %%b  
                                                                            set /A "widthvideo=%%b"
                                                                            @REM echo widthvideo = !widthvideo!
                                                                            if !widthvideo! LEQ 3840 if !widthvideo! GEQ 2000 (set /A "wv=1"
                                                                                                                                @REM echo wv = !wv!
                                                                                                                                )
                                                                            )
                                                                if !x1!==4 ( 
                                                                            echo !t67! "%%a" = %%b  
                                                                            set /A "heightvideo=%%b"
                                                                            @REM echo heightvideo = !heightvideo!
                                                                            if !heightvideo! LEQ 2160 if !heightvideo! GEQ 1400 (set /A "hv=1"
                                                                                                                                @REM echo hv = !hv!
                                                                                                                                )
                                                                            )                                                           
                                                                if !x1!==6 ( 
                                                                            echo Color Space "%%a" = %%b  
                                                                            set "colorsp=%%b"
                                                                            @REM echo colorsp = !colorsp!
                                                                            if !colorsp!==bt2020nc (set /A "nohdrcs=1"
                                                                                                    @REM echo nohdrcs = !nohdrcs!
                                                                                                    )
                                                                            if !colorsp!==unknown (set /A "nohdrcs=1"
                                                                                                    @REM echo nohdrcs = !nohdrcs!
                                                                                                    )
                                                                            if !colorsp!==reserved (set /A "nohdrcs=1"
                                                                                                    @REM echo nohdrcs = !nohdrcs!
                                                                                                    )                    
                                                                            ) 
                                                                if !x1!==7 ( 
                                                                            echo Color Transfer "%%a" = %%b  
                                                                            set "colortr=%%b"
                                                                            @REM echo colortr = !colortr!
                                                                            if !colortr!==smpte2084 (set /A "nohdrct=1"
                                                                                                    @REM echo nohdrct = !nohdrct!
                                                                                                    )
                                                                            ) 
                                                                if !x1!==8 ( 
                                                                            echo Color Primaries "%%a" = %%b  
                                                                            set "colorpr=%%b"
                                                                            @REM echo colorpr = !colorpr!
                                                                            if !colorpr!==bt2020 (set /A "nohdrcp=1"
                                                                                                    @REM echo nohdrcp = !nohdrcp!
                                                                                                    )           
                                                                            )    
                                                                if !x1!==1 ( 
                                                                            echo !t68! "%%a" = %%b  
                                                                            )       
                                                                if !x1!==2 ( 
                                                                            echo !t69! "%%a" = %%b  
                                                                            )   
                                                                if !x1!==5 ( 
                                                                            echo !t70! "%%a" = %%b  
                                                                            set "formatvideo=%%b"
                                                                            @REM echo formatvideo = !formatvideo!
                                                                            if !formatvideo!==yuv420p10le (set /A "fv=1"
                                                                                                            @REM echo fv = !fv!
                                                                                                            )
                                                                            )
                                                                set /A x1+=1                                                            
)
echo.

if !x1!==1 goto :novideofile2160p_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR


if !nohdrcs!==1 if !nohdrct!==1 if !nohdrcp!==1 if !wv!==1 if !hv!==1 if !fv!==1 ( 
                                                                                   echo !t5!
                                                                                   goto RilevazioneBandeNere_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR                                                                    
                                                                                   ) 


echo !t6!
echo.
goto fineinfovideo_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

echo.

:RilevazioneBandeNere_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR  


.\bin\ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 !NomeFile!  > ".\temp\durata_film.txt"

set /a contatore=1
for /f "tokens=1 delims=." %%a in (.\temp\durata_film.txt) do  (
                                                        echo. 
                                                        echo !t7! %%a
                                                        set /a "secondi=%%a"
                                                        set /a "minuti=!secondi!/60"
                                                        echo !t8! !minuti!
                                                        set /a "intervallo_tagli=!secondi!/11"
                                                        echo !t9! !intervallo_tagli!!t10!
                                                        echo.
                                                        echo !t11!
                                                        echo.

                                                        

                                                        FOR /L %%a IN (1, 1, 10) DO (
                                                                                    rem echo %%a
                                                                                    set /a "secondi=%%a*!intervallo_tagli!"
                                                                                    rem echo !secondi!

                                                                                    
                                                                                    set /a "ca=72"
                                                                                    rem echo !ca!
                                                                                                                    
                                                                                    set /a "cb=2"
                                                                                    rem echo !cb!
                                                                                                                    
                                                                                    set /a "cc=0"
                                                                                    rem echo !cc!

                                                                                    set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                    rem echo !cr!
        
                                                                                
                                                                                    .\bin\ffmpeg -ss !secondi! -hide_banner -nostats -i %NomeFile% -vframes 10 -vf !cr! -f null - 2> ".\temp\crop.txt"
                                                                                    
                                                                                    findstr /r "Parsed_cropdetect_0" .\temp\crop.txt >> .\temp\risultato_multiplo.txt   
                                                                                    
                                                                                    echo !t12! %%a !t13! !secondi! !t14!
                                                                                    
                                                                                    )       
                                                                                       

                                                                                    for /f "tokens=1,2 delims==" %%a in (.\temp\risultato_multiplo.txt) do ( echo %%b >> .\temp\crop_multiplo.txt )
                                                                                    
                                                                                    set /a "maxfrequenza=0"

                                                                                    for /f "delims=" %%a in (.\temp\crop_multiplo.txt) do ( 
                                                                                                                                    set "cropconfront=%%a"
                                                                                                                                    rem echo "!cropconfront!"
                                                                                                                                    
                                                                                                                                    set /a "contatorfrequenza=0"
                                                                                                                                    for /f "delims=" %%b in (.\temp\crop_multiplo.txt) do (
                                                                                                                                                                                    set "dato_da_verificare=%%b"
                                                                                                                                                                                    rem echo cropconfront = "!cropconfront!"
                                                                                                                                                                                    rem echo dato_da_verificare = "!dato_da_verificare!"
                                                                                                                                                                                    if !cropconfront!==!dato_da_verificare! ( set /a "contatorfrequenza+=1")
                                                                                                                                                                                    )
                                                                                                                                    if !maxfrequenza! LSS !contatorfrequenza! ( 
                                                                                                                                                                                set /a "maxfrequenza=!contatorfrequenza!"
                                                                                                                                                                                set "cropd=!cropconfront!"
                                                                                                                                                                                )
                                                                                                                                    

                                                                                                                                    rem if !cropconfront! in (elenco_crop_frequenza.txt) ()
                                                                                                                                    rem echo !cropconfront!:!contatorfrequenza! >> elenco_crop_frequenza.txt

                                                                                                                                    )

                                                                                    rem echo crop piu' frequente = !cropd! con grequenza = !maxfrequenza!
                                                                                    echo !cropd! > .\temp\crop_finale.txt

                                                                                    for /f "tokens=1,2,3,4 delims=:" %%a in (.\temp\crop_finale.txt) do  ( 
                                                                                                                                                    rem set /a "mwidth=%%a"
                                                                                                                                                    rem echo mwidth = !mwidth!

                                                                                                                                                    rem set /a "mheight=%%b"
                                                                                                                                                    rem echo mheight = !mheight!

                                                                                                                                                    rem set /a "mx=%%c"
                                                                                                                                                    rem echo mx = !mx!

                                                                                                                                                    rem set /a "my=%%d"
                                                                                                                                                    rem echo my = !my!

                                                                                                                                                    if !contatore!==1 ( 
                                                                                                                                                                set /a "wmax=%%a" 
                                                                                                                                                                set /a "hmax=%%b"
                                                                                                                                                                set /a "xmin=%%c"
                                                                                                                                                                set /a "ymin=%%d"
                                                                                                                                                                set /a "mwidth=%%a"
                                                                                                                                                                set /a "mheight=%%b"
                                                                                                                                                                set /a "mx=%%c"
                                                                                                                                                                set /a "my=%%d"
                                                                                                                                                                set /a "contatore+=1"
                                                                                                                                                                )
                                                                                                                                                    
                                                                                                                                                    rem if %%b gtr !hmax! if %%c gtr !xmin! if %%d gtr !ymin! 

                                                                                                                                                    if %%a geq !wmax! if %%b geq !hmax! ( 
                                                                                                                                                                        set /a "wmax=%%a" 
                                                                                                                                                                        set /a "hmax=%%b"
                                                                                                                                                                        set /a "xmin=%%c"
                                                                                                                                                                        set /a "ymin=%%d"
                                                                                                                                                                        set /a "mwidth=%%a"
                                                                                                                                                                        set /a "mheight=%%b"
                                                                                                                                                                        set /a "mx=%%c"
                                                                                                                                                                        set /a "my=%%d"
                                                                                                                                                                        )
                                                                                                                                                    )
                                                                                    echo.
                                                                                    set /a "csup=!my!"
                                                                                    rem echo csup = !csup!
                                                                                                                                    
                                                                                    set /a "csin=!mx!"
                                                                                    rem echo csin = !csin!

                                                                                    set /a "cinf=!heightvideo!-!mheight!-!my!"
                                                                                    rem echo movieheightreal = !movieheightreal!
                                                                                    rem echo cinf = !cinf!
                                                                                    set /a "cdes=!widthvideo!-!mwidth!-!mx!"
                                                                                    rem echo cdes = !cdes!

                                                                                    echo !t15! !widthvideo!  
                                                                                    echo !t16! !heightvideo!  
                                                                                    echo.

                                                                                    echo Crop Settings: --crop !csin!,!csup!,!cdes!,!cinf!  
                                                                                    set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"  
                                                                                    echo.  

                                                                                    set /a "height4kcrop=(!heightvideo!-!csup!-!cinf!)/2*2"
                                                                                    set /a "width4kcrop=(!widthvideo!-!csin!-!cdes!)/2*2"

                                                                                    echo !t17! !width4kcrop!  
                                                                                    echo !t18! !height4kcrop!  
                                                                                    echo.

                                                                                    set /a "height1080p=!height4kcrop!/4*2"
                                                                                    set /a "width1080p=!width4kcrop!/4*2"
                                                                                    
                                                                                    echo !t171! !width1080p!  
                                                                                    echo !t181! !height1080p!  
                                                                                    echo.


                                                                                    set /a "larghezza1080pnvenc=1920"
                                                                                    set /a "altezza1080pnvenc=1080"
                                                                                    @REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
                                                                                    @REM echo altezza1080pnvenc = !altezza1080pnvenc!                                    

                                                                                    set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!width1080p!"
                                                                                    set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!height1080p!"
                                                                                    @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
                                                                                    @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

                                                                                    if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                                                                                                        @REM echo dentro il 1o if
                                                                                                                                                                        set /a "width2k=!width1080p!"
                                                                                                                                                                        set /a "height2k=!height1080p!"
                                                                                                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                                                                                                set /a "width2k=!width1080p!"
                                                                                                                                                                                                                                                                set /a "height2k=!height1080p!"
                                                                                                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo width1080p = !width1080p!
                                                                                                                                                                                                                                                                                                                                                        @REM echo height1080p = !height1080p!
                                                                                                                                                                                                                                                                                                                                                        set /a "width2k=!width1080p!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        set /a "height2k=!height1080p!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "width2k=!width1080p!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "height2k=!height1080p!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                                                                                                                set /a "width2k=!width1080p!"
                                                                                                                                                                                                                                                                set /a "height2k=!height1080p!"
                                                                                                                                                                                                                                                                )
                                                                                                                                                                        
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                                                                                                        set /a "width2k=!width1080p!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        set /a "height2k=!height1080p!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.                         

                                                                                        echo !t20!  !width2k! 
                                                                                        echo !t21!  !height2k!    
                                                                                        echo.

                                                                                        @REM set /a "width4k=width2k*2"
                                                                                        @REM set /a "height4k=height2k*2"

                                                                                        @REM echo Larghezza Finale Video 2160p:  !width4k! 
                                                                                        @REM echo Altezza Finale Video 2160p:  !height4k!    
                                                                                        @REM echo.
                                                                                    )

                                                                                    
                                                        )                          

:iniziocropdowngradeDownScale_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set /a "csup=0"
set /a "cinf=0"
set /a "csin=0"
set /a "cdes=0"
set /a "bandasuperiore=0"
set /a "bandainferiore=0"
set /a "bandasinistra=0"
set /a "bandadestra=0"
set /a "differenzialelarghezza1080pnvenc=0"
set /a "differenzialealtezza1080pnvenc=0"
if exist ".\temp\Temp_HDR10_Stream.txt" ( del ".\temp\Temp_HDR10_Stream.txt" ) 
if exist ".\temp\durata_film.txt" ( del ".\temp\durata_film.txt" )
if exist ".\temp\crop.txt" ( del ".\temp\crop.txt" )
if exist ".\temp\risultato_multiplo.txt" ( del ".\temp\risultato_multiplo.txt" )
if exist ".\temp\crop_multiplo.txt" ( del ".\temp\crop_multiplo.txt" )
if exist ".\temp\crop_finale.txt" ( del ".\temp\crop_finale.txt" )

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t22!"   
    if errorlevel 2 goto cropmanualeNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
    if errorlevel 1 goto finecropNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
)

CHOICE /N /C:SN /M "!t22!"   

if errorlevel 2 goto cropmanualeNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if errorlevel 1 goto finecropNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR


:cropmanualeNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
echo.
echo !t23!
echo.

:banda_superiore_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set /p "bandasuperiore=!t24!"
SET "var="&for /f "delims=0123456789" %%i in ("!bandasuperiore!") do set var=!bandasuperiore!
if defined var (
                echo.
                echo !t25!
                echo.
                goto banda_superiore_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
                ) else (
                        set /a "csup=!bandasuperiore!/2*2"
                        )

echo.
:banda_inferiore_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set /p "bandainferiore=!t26!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandainferiore!") do set var=!bandainferiore!
if defined var (
                echo.
                echo !t27!
                echo.
                goto banda_inferiore_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
                ) else (
                        set /a "cinf=!bandainferiore!/2*2"
                        )


echo.
:banda_sinistra_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set /p "bandasinistra=!t28!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandasinistra!") do set var=!bandasinistra!
if defined var (
                echo.
                echo !t29!
                echo.
                goto banda_sinistra_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
                ) else (
                        set /a "csin=!bandasinistra!/2*2"
                        )

                        
echo.
:banda_destra_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set /p "bandadestra=!t30!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandadestra!") do set var=!bandadestra!
if defined var (
                echo.
                echo !t31!
                echo.
                goto banda_destra_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
                ) else (
                        set /a "cdes=!bandadestra!/2*2"
                        )


set /a "larghezza1080pnvenc=3840"
set /a "altezza1080pnvenc=2160"
@REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
@REM echo altezza1080pnvenc = !altezza1080pnvenc!                                    

set /a "mwidth=!widthvideo!/2*2"
set /a "mheight=!heightvideo!/2*2"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "mwidthc=!mwidth!-!csin!-!cdes!"
set /a "mheightc=!mheight!-!csup!-!cinf!"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!mwidthc!"
set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!mheightc!"
@REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
@REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

echo.
echo !t32!  !csup! 
echo !t33!  !cinf! 
echo !t34!  !csin! 
echo !t35!  !cdes! 
echo.


set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
echo Crop Settings: !cropff!
echo.

echo !t36!  !mwidthc! 
echo !t37!  !mheightc! 
echo.

set /a "mwidthc1080p=!mwidthc!/2"
set /a "mheightc1080p=!mheightc!/2"

echo !t361!  !mwidthc1080p! 
echo !t371!  !mheightc1080p! 
echo.


if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                        @REM echo dentro il 1o if
                                                                                        set /a "width2k=!mwidthc!"
                                                                                        set /a "height2k=!mheightc!"
                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                set /a "width2k=!mwidthc!"
                                                                                                                                                                                set /a "height2k=!mheightc!"
                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                        set /a "width2k=!mwidthc!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                        set /a "height2k=!mheightc!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                set /a "width2k=!mwidthc!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                set /a "height2k=!mheightc!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                )
                                                                                        if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                        set /a "width2k=!mwidthc!"
                                                                                                                                                                        set /a "height2k=!mheightc!"
                                                                                                                                                                        )
                                                                                                                                                                        
                                                                                        if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                set /a "width2k=!mwidthc!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                set /a "height2k=!mheightc!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.                         

                                                                                        @REM echo Larghezza Finale Video 2160p:  !width2k! 
                                                                                        @REM echo Altezza Finale Video 2160p:  !height2k!    
                                                                                        @REM echo.

                                                                                        set /a "width2k=width2k/4*2"
                                                                                        set /a "height2k=height2k/4*2"

                                                                                        echo !t20!  !width2k! 
                                                                                        echo !t21!  !height2k!    
                                                                                        echo.

                                                                                        @REM set /a "width4k=width2k*2"
                                                                                        @REM set /a "height4k=height2k*2"

                                                                                        @REM echo Larghezza Finale Video 2160p:  !width4k! 
                                                                                        @REM echo Altezza Finale Video 2160p:  !height4k!    
                                                                                        @REM echo.
                                                                                    ) 

goto iniziocropdowngradeDownScale_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:finecropNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR



rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


:InserimentoImpostazioniNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR


echo.
echo !t40!
echo.
echo 1) CQP 
echo 2) VBR 
echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto CodificaVBRNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if errorlevel 1 goto CodificaCQPNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:CodificaVBRNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "TipoCodificaNVEnc=--vbr "
set /a "quantizzazioneNVEnc=0"
goto inserimentoValoriCQPVBRNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:CodificaCQPNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "TipoCodificaNVEnc=--cqp "
set /a "quantizzazioneNVEnc=1"

:inserimentoValoriCQPVBRNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

if !quantizzazioneNVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneNVEnc=!t44! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneNVEnc!") do set var=!valoreQuantizzazioneNVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                goto inserimentoValoriCQPVBRNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
                                                ) 

                                set /a "valoreQuantizzazioneNVEnc=!valoreQuantizzazioneNVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneNVEnc!
                                if !valoreQuantizzazioneNVEnc! GEQ 10 if !valoreQuantizzazioneNVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneNVEnc!
                                                                                                                set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreQuantizzazioneNVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                                goto fineQuantizzazioneNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
                                                                                                                        
                                )



if !quantizzazioneNVEnc!==0 (
                                echo.
                                set /p "valoreBitRateNVEnc=!t46! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateNVEnc!") do set var=!valoreBitRateNVEnc!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                goto inserimentoValoriCQPVBRNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
                                                ) 
                                set /a "valoreBitRateNVEnc=!valoreBitRateNVEnc!"
                                @REM echo valoreBitRateNVEnc = !valoreBitRateNVEnc!
                                if !valoreBitRateNVEnc! GEQ 100 if !valoreBitRateNVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateNVEnc!
                                                                                                        set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreBitRateNVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                        goto fineQuantizzazioneNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
                                                                                                              
                                )


:fineQuantizzazioneNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR



echo.
echo !t50!
echo.
echo 1) P1 !t51!
echo 2) P2 
echo 3) P3 
echo 4) P4 
echo 5) P5 
echo 6) P6 
echo 7) P7 !t52!
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto P7NVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if errorlevel 6 goto P6NVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if errorlevel 5 goto P5NVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if errorlevel 4 goto P4NVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if errorlevel 3 goto P3NVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if errorlevel 2 goto P2NVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if errorlevel 1 goto P1NVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR


:P7NVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "SettaggioQualitaNVEnc=--preset P7"
set "QualitySetting=P7"
goto fineQualitCodificaNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:P6NVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "SettaggioQualitaNVEnc=--preset P6"
set "QualitySetting=P6"
goto fineQualitCodificaNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:P5NVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "SettaggioQualitaNVEnc=--preset P5"
set "QualitySetting=P5"
goto fineQualitCodificaNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:P4NVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "SettaggioQualitaNVEnc=--preset P4"
set "QualitySetting=P4"
goto fineQualitCodificaNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:P3NVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "SettaggioQualitaNVEnc=--preset P3"
set "QualitySetting=P3"
goto fineQualitCodificaNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:P2NVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "SettaggioQualitaNVEnc=--preset P2"
set "QualitySetting=P2"
goto fineQualitCodificaNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:P1NVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "SettaggioQualitaNVEnc=--preset P1"
set "QualitySetting=P1"
goto fineQualitCodificaNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR


:fineQualitCodificaNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaNVEnc!


echo.
echo !t71!
echo !t72!
echo.
echo 1) NVEnc Color Correction 
echo 2) LibPlacebo Color Correction 

echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto LibPlaceboColorNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if errorlevel 1 goto NVEncColorCorrection_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:NVEncColorCorrection_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "NVEncColorCorrectionSystem=--vpp-colorspace hdr2sdr=hable,source_peak=1000,ldr_nits=100,a=0.22,b=0.3,c=0.1,d=0.2,e=0.01,f=0.3"
set "NVEncUpgrader=NVEnc Color Correction"
goto NVEncFineSelezioneUpGrader_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:LibPlaceboColorNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "NVEncColorCorrectionSystem=--vpp-libplacebo-tonemapping src_csp=dovi,dst_csp=sdr"
set "NVEncUpgrader=LibPlacebo Color Correction"

:NVEncFineSelezioneUpGrader_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
echo.
echo !t73! !NVEncUpgrader!
echo.
echo !t43! !NVEncColorCorrectionSystem!


:sceltadenoiser
set conv3d1080p=
set pmd1080p=

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t55!"
    if errorlevel 2 goto conv3dChoosenNoNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
    if errorlevel 1 goto conv3dChoosenYesNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
)

echo.
CHOICE /N /C:SN /M "!t55!"

if errorlevel 2 goto conv3dChoosenNoNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if errorlevel 1 goto conv3dChoosenYesNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:conv3dChoosenNoNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "conv3d1080p=N"
goto sceltaDeniserPMDNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:conv3dChoosenYesNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "conv3d1080p=S"



:sceltaDeniserPMDNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t56!"
    if errorlevel 2 goto PMDChoosenNoNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
    if errorlevel 1 goto PMDChoosenYesNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
)

echo.
CHOICE /N /C:SN /M "!t56!"

if errorlevel 2 goto PMDChoosenNoNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if errorlevel 1 goto PMDChoosenYesNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:PMDChoosenNoNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "pmd1080p=N"
goto assegnazioneDenoisesNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:PMDChoosenYesNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "pmd1080p=S"


:assegnazioneDenoisesNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set /A nvdenv=0

if !conv3d1080p!==S if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00 --vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )
if !conv3d1080p!==S if !pmd1080p!==N ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )
if !conv3d1080p!==N if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )
if !conv3d1080p!==N if !pmd1080p!==N ( 
                                        set "nvdenoiser=" 
                                        set "nvdenv=1"
                                        set "unicopassaggio=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: Nessun Denoiser 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )

@REM pause

echo.
if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t57!"
    if errorlevel 2 goto ApplicaMiglioramentoDettagliNVEncNo_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
    if errorlevel 1 goto ApplicaMiglioramentoDettagliNVEncSi_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
)
CHOICE /N /C:SN /M "!t57!"

if errorlevel 2 goto ApplicaMiglioramentoDettagliNVEncNo_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if errorlevel 1 goto ApplicaMiglioramentoDettagliNVEncSi_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:ApplicaMiglioramentoDettagliNVEncNo_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "miglioramento1080p=N"
goto fineSceltaMigliaramentiNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

:ApplicaMiglioramentoDettagliNVEncSi_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
set "miglioramento1080p=S"

:fineSceltaMigliaramentiNVEnc_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
if !miglioramento1080p!==S ( 
                                set "edgeleveling=--vpp-edgelevel strength=10.0,threshold=24.0,black=6,white=0" 
                                echo.
                                echo NVEnc !t58!
                                echo.
                                )
if !miglioramento1080p!==N ( 
                                set "edgeleveling=" 
                                echo.
                                echo NVEnc !t59!
                                echo.
                                )


@REM pause






echo.
echo !t74!
echo.


set file_senza_virgolette=%NomeFile:"=%
rem echo %file_senza_virgolette%

set file_senza_estensione=%file_senza_virgolette:.mkv=%
rem echo %file_senza_estensione%

set fileoutput2160p="%file_senza_estensione%_DownGraded_DownScaled_1080p_8_bit_SDR.mkv"
rem echo fileoutput2160p = %fileoutput2160p%



set fileoutput2160p_senza_virgolette=%fileoutput2160p:"=% 
rem echo %fileoutput2160p_senza_virgolette%

for %%i in ("%fileoutput2160p_senza_virgolette%") do (  
                                                        set "solo_nome_file=%%~ni"
                                                        rem echo Nome file: !solo_nome_file!

                                                        set "solo_estensione_file=%%~xi"
                                                        rem echo Estensione: !solo_estensione_file!
                                                    )

set fileoutput2160p_rinominato=!solo_nome_file!_rinominato!solo_estensione_file!
rem echo %fileoutput2160p_rinominato%

if exist "Temp_HDR10_Stream.txt" ( del Temp_HDR10_Stream.txt )
if exist "durata_film.txt" ( del durata_film.txt )
if exist "crop.txt" ( del crop.txt )
if exist "risultato_multiplo.txt" ( del risultato_multiplo.txt )
if exist "crop_multiplo.txt" ( del crop_multiplo.txt )
if exist "crop_finale.txt" ( del crop_finale.txt )


".\bin\nvenc\NVEncC64.exe" --avhw --device 0 -i %NomeFile%  --output-res !width2k!x!height2k! !cropff! --output-depth 8 --video-metadata clear --metadata clear --chapter-copy -c hevc !tipoQuantizzazioneNVEnc! --bref-mode disabled !SettaggioQualitaNVEnc! --tier high --lookahead 32 --aq --aq-temporal --aq-strength 15 --level auto --chromaloc auto --colorrange auto --colormatrix  bt709 --transfer bt709 --colorprim bt709 --multipass None --mv-precision Q-pel  --avsync cfr !NVEncColorCorrectionSystem! --vpp-resize algo=lanczos4 !nvdenoiser! !edgeleveling! --log-level info --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off  --log ".\codifica_hardware_out_log.txt" -o %fileoutput2160p%


ren %fileoutput2160p% "%fileoutput2160p_rinominato%"



echo.
echo !t75!
echo.


goto fineinfovideo_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR


rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
rem////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////





:novideofile2160p_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR
echo !t63!
echo.


:fineinfovideo_NVEncDownGradeDownScaled2160p10bitHDRto1080p8bitSDR

if exist ".\saved\settings.dat" (
                                for /f "tokens=1,2 delims=|" %%a in (.\saved\settings.dat) do (
                                                                                                    rem echo %%a
                                                                                                    rem echo %%b
                                                                                                    set /a "shst=%%b"
                                                                                                    rem echo !shst!
                                                                                                    rem pause
                                                                                                    if !shst!==1 (
                                                                                                                echo !t1000!
                                                                                                                echo.
                                                                                                                shutdown /s
                                                                                                                set /a "delay=10"
                                                                                                                timeout /t !delay!
                                                                                                                exit
                                                                                                                )
                                                                                                                            
                                                                                                    )                                                                                                  
                                                                                                )

if exist ".\temp\Temp_HDR10_Stream.txt" ( del .\temp\Temp_HDR10_Stream.txt )
if exist ".\temp\durata_film.txt" ( del .\temp\durata_film.txt )
if exist ".\temp\crop.txt" ( del .\temp\crop.txt )
if exist ".\temp\risultato_multiplo.txt" ( del .\temp\risultato_multiplo.txt )
if exist ".\temp\crop_multiplo.txt" ( del .\temp\crop_multiplo.txt )
if exist ".\temp\crop_finale.txt" ( del .\temp\crop_finale.txt )
      




set waitenter=
set /P waitenter=!t65!
Endlocal
goto menuiniziale









rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:NVEncDownGrade2160p10bitHDRto2160p8bitSDR

cls
setLocal EnableExtensions EnableDelayedExpansion


for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoNVEncDownGrade2160p10bitHDRto2160p8bitSDR
)

if %lingua%==inglese (
    goto caricalinguaingleseNVEncDownGrade2160p10bitHDRto2160p8bitSDR
)



:caricalinguaingleseNVEncDownGrade2160p10bitHDRto2160p8bitSDR
@REM set t1=Insert Hardware Video Encoding Info DownGrading from 2160p or 1080p 10 bit HDR to 8 bit SDR and Saving to Disk

set t2=Drag Here the Video File 2160p or 1080p 10 bit HDR to Convert to 8 bit SDR:  
@REM set t211=Video File 2160p or 1080p 10 bit HDR to Convert to 8 bit SDR:  

set t3=File does not exist 
set t4=Info Video:  
set t5=The Inserted Video is
set t6=The Inserted Video isn't
set t7=Video Duration in seconds:
set t8=Video Duration in Minutes:
set t9=Interval between Frames for Crop Detection:
set t10= seconds
set t11=Black Bands Detection Started....
set t12=Crop Detection to Frame
set t13=to seconds
set t14=Done...
set t15=Input Video Width 
set t16=Input Video Height
set t17=Output Video Width Without Black Bars
set t18=Outout Video Height Without Black Bars
set t19=Adapting Video Resolution to Full Format
set t20=Final Output Video Width
set t21=Final Output Video Height
set t22=Settings of Black Bands to Crop are Correct (Yes/No):
set t23=Manually Entering Black Band Values to Crop... 
set t24=Enter the Upper Black Band Value: 
set t25=Error Entering Upper Black Band Value... It's Not a Number. 
set t26=Enter the Lower Black Band Value: 
set t27=Error Entering Lower Black Band Value... It's Not a Number.
set t28=Enter the Left Black Band Value: 
set t29=Error Entering Left Black Band Value... It's Not a Number.
set t30=Enter the Right Black Band Value: 
set t31=Error Entering Right Black Band Value... It's Not a Number.
set t32=Upper Black Band:
set t33=Lower Black Band:
set t34=Left Black Band:
set t35=Right Black Band:
set t36=Original Video Width Without Black Bars
set t37=Original Video Height Without Black Bars
set t38=Select Graphic Card you want to Encode with:
set t39=Choose (1/2):
set t40=Select Encoding Type:
set t41=Error Entering Quantization Value... Not a Number. 
set t42=Quantization Value Set to:
set t43=Encoding Settings:
set t44=Enter Quantization value Minimum 10 Maximum 28:
set t45=Quantization Value Out of  Limits  10 / 28  Re-enter^!
set t46=Enter BitRate Value kbs Minimum 100 Maximum 50000:
set t47=Error Entering BitRate Value... It's Not a Number. 
set t48=BitRate Value Set to:
set t49=BitRate Value Out of Limits  100 / 50000  Re-enter^!
set t50=Select Encoding Quality:
set t51=- Worst Quality
set t52=- Best Quality
set t53=Choose (1/2/3/4/5/6/7):
set t54=Quality Set to:
set t55=Apply Convolution3D denoiser Yes/No: 
set t56=Apply PMD denoiser Yes/No: 
set t57=Apply Detail Enhancement Yes/No:  
set t58=Enhancement Detail: Yes 
set t59=Enhancement Detail: No 
set t60=Info
set t61=Videos to Encode Saved!
set t62=Do You Want to Insert Another Video to Encode (Yes/No):
set t63=The dragged file is not a video!
set t64=Choose (1/2/3/4):
set t65=Press Enter to back to Main Menu.  

set t66=Video Width
set t67=Video Height
set t68=Video Codec
set t69=Details Video Codec
set t70=Video Format 
set t71=Configuration Settings to convert video from 10bit HDR to 8bit SDR
set t72=Select Encoding DownGrader:
set t73=Settings DownGrader:

set t74=DownGrading Started.... 
set t75=Encoding Finished...
set t1000=Now the PC will be turned off... 

goto avvio_NVEncDownGrade2160p10bitHDRto2160p8bitSDR




:caricalinguaitalianoNVEncDownGrade2160p10bitHDRto2160p8bitSDR
@REM set t1=Inserimento Info Codifica Hardware Video DownGrading da 2160p o 1080p 10 bit HDR a 8 bit SDR e Salvataggio su Disco.

set t2=Trascina Qui il File Video 2160p o 1080p 10 bit HDR da Convertire a 8 bit SDR:  
@REM set t211=File Video 2160p o 1080p 10 bit HDR da Convertire a 8 bit SDR:  

set t3=File Inesistente 
set t4=Informazioni Video:  
set t5=Il Video inserito e'
set t6=Il Video inserito non e'
set t7=Durata del Video in secondi:
set t8=Durata del video in Minuti:
set t9=Intervallo tra i Fotogrammi per il Rilevamento del crop:
set t10= secondi
set t11=Rilevamento Bande Nere Iniziato....
set t12=Rilevazione crop fotogramma
set t13=a secondi
set t14=Eseguita...
set t15=Larghezza Video di Input 
set t16=Altezza Video di Input
set t17=Larghezza Video di Input Senza Barre Nere
set t18=Altezza Video di Input Senza Barre Nere
set t19=Adattamento della Risoluzione del Video al Pieno Formato
set t20=Larghezza Finale Video di Output
set t21=Altezza Finale Video di Output
set t22=Le Impostazioni delle Bande Nere da Tagliare sono Corrette (Si/No):
set t23=Inserimento Manuale Valori Bande Nere da Tagliare.. 
set t24=Inserisci il Valore della Banda Nera Superiore: 
set t25=Errore nell'Inserimento del Valore della Banda Nera Superiore... Non e' un Numero. 
set t26=Inserisci il Valore della Banda Nera Inferiore: 
set t27=Errore nell'Inserimento del Valore della Banda Nera Inferiore... Non e' un Numero. 
set t28=Inserisci il Valore della Banda Nera Sinistra: 
set t29=Errore nell'Inserimento del Valore della Banda Nera Sinistra... Non e' un Numero. 
set t30=Inserisci il Valore della Banda Nera Destra: 
set t31=Errore nell'Inserimento del Valore della Banda Nera Destra... Non e' un Numero. 
set t32=Banda Nera Superiore:
set t33=Banda Nera Inferiore:
set t34=Banda Nera Sinistra:
set t35=Banda Nera Destra:
set t36=Larghezza Video Originale Senza Barre Nere
set t37=Altezza Video Originale Senza Barre Nere
set t38=Selezionare Scheda Grafica con cui Eseguire la Codifica:
set t39=Scegli (1/2):
set t40=Selezionare tipo di Codifica:
set t41=Errore nell'Inserimento del Valore della Quantizzazione... Non e' un Numero. 
set t42=Valore Quantizzazzione Impostato a:
set t43=Parametri per codifica:
set t44=Inserire Valore Quantizzazione Minimo 10 Massimo 28:
set t45=Valore Quantizzazzione al di fuori dei  Limiti  10 / 28  Reinserire^!
set t46=Inserire Valore BitRate kbs Minimo 100 Massimo 50000:
set t47=Errore nell'Inserimento del Valore del BitRate... Non e' un Numero. 
set t48=Valore BitRate Impostato a:
set t49=Valore  BitRate al di fuori dei  Limiti  100 / 50000  Reinserire^!
set t50=Selezionare Qualita' Codifica:
set t51=- Peggiore Qualita'
set t52=- Migliore Qualita'
set t53=Scegli (1/2/3/4/5/6/7):
set t54=Qualita' Impostata su:
set t55=Applicare il denoiser Convolution3D Si/No: 
set t56=Applicare il denoiser PMD Si/No: 
set t57=Applicare il Miglioramento Dettagli Si/No:  
set t58=Miglioramento Dettagli: Si 
set t59=Miglioramento Dettagli: No 
set t60=Informazioni
set t61=Video da Codificare Salvate!
set t62=Vuoi Inserire un altro Video da Codificare (Si/No):
set t63=Il file trascinato non e' un video!
set t64=Scegli (1/2/3/4):
set t65=Premi Invio per tornare al Menu' Principale  

set t66=Larghezza Video
set t67=Altezza Video
set t68=Codec Video
set t69=Codec Video Dettagli
set t70=Format Video 
set t71=Configurazione Parametri per convertire il video da 10bit HDR a 8bit SDR
set t72=Selezionare DownGrader Codifica:
set t73=DownGrader Impostato:

set t74=DownGrading Iniziato.... 
set t75=Codifica Terminata...
set t1000=Il PC ora verra' Spento... 


goto avvio_NVEncDownGrade2160p10bitHDRto2160p8bitSDR

:avvio_NVEncDownGrade2160p10bitHDRto2160p8bitSDR

set /a "numeromovie=1"


:altrivideodainserire_NVEncDownGrade2160p10bitHDRto2160p8bitSDR


set NomeFile2160ppuliziadettaggli=
rem set MetadatiStreamHDR10=

set /P NomeFile2160ppuliziadettaggli=!t2!
rem echo Hai digitato: %NomeFile%
rem pause

set "NomeFileSorgente=!NomeFile2160ppuliziadettaggli:"=!"
@REM echo NomeFileSorgente = !NomeFileSorgente!
set "NomeFile=^"!NomeFileSorgente!^""
@REM echo NomeFile = !NomeFile!
rem pause


if exist %NomeFile% ( goto infovideo_NVEncDownGrade2160p10bitHDRto2160p8bitSDR ) else ( 
                                                        echo.
                                                        echo !t3!
                                                        echo.
                                                        goto fineinfovideo_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
                                                        )    




:infovideo_NVEncDownGrade2160p10bitHDRto2160p8bitSDR

echo.
echo !t4!
echo.

.\bin\ffprobe -v error -hide_banner -select_streams v:0 -show_entries stream=width,height,codec_name,codec_long_name,pix_fmt,color_space,color_transfer,color_primaries -of default=noprint_wrappers=1 %NomeFile% > ".\temp\Temp_HDR10_Stream.txt"

set /A x1=1
set /A nohdrcs=0
set /A nohdrct=0
set /A nohdrcp=0
set /A wv=0
set /a hv=0
set /A fv=0
set def=
rem echo nohdr = %nohdr%

for /f "tokens=1,2 delims==" %%a in (.\temp\Temp_HDR10_Stream.txt) do (if !x1!==3 ( 
                                                                            echo !t66! "%%a" = %%b  
                                                                            set /A "widthvideo=%%b"
                                                                            @REM echo widthvideo = !widthvideo!
                                                                            if !widthvideo! LEQ 3840 if !widthvideo! GEQ 2000 (set /A "wv=1"
                                                                                                                                @REM echo wv = !wv!
                                                                                                                                set "def=2160p"
                                                                                                                                )
                                                                            if !widthvideo! LEQ 1920 if !widthvideo! GEQ 1000 (set /A "wv=1"
                                                                                                                                @REM echo wv = !wv!
                                                                                                                                set "def=1080p"
                                                                                                                                )
                                                                            )
                                                                if !x1!==4 ( 
                                                                            echo !t67! "%%a" = %%b  
                                                                            set /A "heightvideo=%%b"
                                                                            @REM echo heightvideo = !heightvideo!
                                                                            if !heightvideo! LEQ 2160 if !heightvideo! GEQ 1400 (set /A "hv=1"
                                                                                                                                @REM echo hv = !hv!
                                                                                                                                )
                                                                            if !heightvideo! LEQ 1080 if !heightvideo! GEQ 700 (set /A "hv=1"
                                                                                                                                @REM echo hv = !hv!
                                                                                                                                )
                                                                            )                                                           
                                                                if !x1!==6 ( 
                                                                            echo Color Space "%%a" = %%b  
                                                                            set "colorsp=%%b"
                                                                            @REM echo colorsp = !colorsp!
                                                                            if !colorsp!==bt2020nc (set /A "nohdrcs=1"
                                                                                                    @REM echo nohdrcs = !nohdrcs!
                                                                                                    )
                                                                            if !colorsp!==unknown (set /A "nohdrcs=1"
                                                                                                    @REM echo nohdrcs = !nohdrcs!
                                                                                                    )
                                                                            if !colorsp!==reserved (set /A "nohdrcs=1"
                                                                                                    @REM echo nohdrcs = !nohdrcs!
                                                                                                    )                    
                                                                            ) 
                                                                if !x1!==7 ( 
                                                                            echo Color Transfer "%%a" = %%b  
                                                                            set "colortr=%%b"
                                                                            @REM echo colortr = !colortr!
                                                                            if !colortr!==smpte2084 (set /A "nohdrct=1"
                                                                                                    @REM echo nohdrct = !nohdrct!
                                                                                                    )
                                                                            ) 
                                                                if !x1!==8 ( 
                                                                            echo Color Primaries "%%a" = %%b  
                                                                            set "colorpr=%%b"
                                                                            @REM echo colorpr = !colorpr!
                                                                            if !colorpr!==bt2020 (set /A "nohdrcp=1"
                                                                                                    @REM echo nohdrcp = !nohdrcp!
                                                                                                    )           
                                                                            )    
                                                                if !x1!==1 ( 
                                                                            echo !t68! "%%a" = %%b  
                                                                            )       
                                                                if !x1!==2 ( 
                                                                            echo !t69! "%%a" = %%b  
                                                                            )   
                                                                if !x1!==5 ( 
                                                                            echo !t70! "%%a" = %%b  
                                                                            set "formatvideo=%%b"
                                                                            @REM echo formatvideo = !formatvideo!
                                                                            if !formatvideo!==yuv420p10le (set /A "fv=1"
                                                                                                            @REM echo fv = !fv!
                                                                                                            )
                                                                            )
                                                                set /A x1+=1                                                            
)
echo.

if !x1!==1 goto :novideofile2160p10080p_NVEncDownGrade2160p10bitHDRto2160p8bitSDR


if !nohdrcs!==1 if !nohdrct!==1 if !nohdrcp!==1 if !wv!==1 if !hv!==1 if !fv!==1 ( 
                                                                                   echo !t5! !def! 10bit HDR 
                                                                                   goto RilevazioneBandeNere_NVEncDownGrade2160p10bitHDRto2160p8bitSDR                                                                     
                                                                                   ) 


echo !t6! !def! 10bit HDR 
echo.
goto fineinfovideo_NVEncDownGrade2160p10bitHDRto2160p8bitSDR

echo


:RilevazioneBandeNere_NVEncDownGrade2160p10bitHDRto2160p8bitSDR

.\bin\ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 !NomeFile!  > ".\temp\durata_film.txt"

set /a contatore=1
for /f "tokens=1 delims=." %%a in (.\temp\durata_film.txt) do  (
                                                        echo. 
                                                        echo !t7! %%a
                                                        set /a "secondi=%%a"
                                                        set /a "minuti=!secondi!/60"
                                                        echo !t8! !minuti!
                                                        set /a "intervallo_tagli=!secondi!/11"
                                                        echo !t9! !intervallo_tagli!!t10!
                                                        echo.
                                                        echo !t11!
                                                        echo.

                                                        

                                                        FOR /L %%a IN (1, 1, 10) DO (
                                                                                    rem echo %%a
                                                                                    set /a "secondi=%%a*!intervallo_tagli!"
                                                                                    rem echo !secondi!

                                                                                    
                                                                                    set /a "ca=72"
                                                                                    rem echo !ca!
                                                                                                                    
                                                                                    set /a "cb=2"
                                                                                    rem echo !cb!
                                                                                                                    
                                                                                    set /a "cc=0"
                                                                                    rem echo !cc!

                                                                                    set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                    rem echo !cr!
        
                                                                                
                                                                                    .\bin\ffmpeg -ss !secondi! -hide_banner -nostats -i %NomeFile% -vframes 10 -vf !cr! -f null - 2> ".\temp\crop.txt"
                                                                                    
                                                                                    findstr /r "Parsed_cropdetect_0" .\temp\crop.txt >> .\temp\risultato_multiplo.txt   
                                                                                    
                                                                                    echo !t12! %%a !t13! !secondi! !t14!
                                                                                    
                                                                                    )       
                                                                                       

                                                                                    for /f "tokens=1,2 delims==" %%a in (.\temp\risultato_multiplo.txt) do ( echo %%b >> .\temp\crop_multiplo.txt )
                                                                                    
                                                                                    set /a "maxfrequenza=0"

                                                                                    for /f "delims=" %%a in (.\temp\crop_multiplo.txt) do ( 
                                                                                                                                    set "cropconfront=%%a"
                                                                                                                                    rem echo "!cropconfront!"
                                                                                                                                    
                                                                                                                                    set /a "contatorfrequenza=0"
                                                                                                                                    for /f "delims=" %%b in (.\temp\crop_multiplo.txt) do (
                                                                                                                                                                                    set "dato_da_verificare=%%b"
                                                                                                                                                                                    rem echo cropconfront = "!cropconfront!"
                                                                                                                                                                                    rem echo dato_da_verificare = "!dato_da_verificare!"
                                                                                                                                                                                    if !cropconfront!==!dato_da_verificare! ( set /a "contatorfrequenza+=1")
                                                                                                                                                                                    )
                                                                                                                                    if !maxfrequenza! LSS !contatorfrequenza! ( 
                                                                                                                                                                                set /a "maxfrequenza=!contatorfrequenza!"
                                                                                                                                                                                set "cropd=!cropconfront!"
                                                                                                                                                                                )
                                                                                                                                    

                                                                                                                                    rem if !cropconfront! in (elenco_crop_frequenza.txt) ()
                                                                                                                                    rem echo !cropconfront!:!contatorfrequenza! >> elenco_crop_frequenza.txt

                                                                                                                                    )

                                                                                    rem echo crop piu' frequente = !cropd! con grequenza = !maxfrequenza!
                                                                                    echo !cropd! > .\temp\crop_finale.txt

                                                                                    for /f "tokens=1,2,3,4 delims=:" %%a in (.\temp\crop_finale.txt) do  ( 
                                                                                                                                                    rem set /a "mwidth=%%a"
                                                                                                                                                    rem echo mwidth = !mwidth!

                                                                                                                                                    rem set /a "mheight=%%b"
                                                                                                                                                    rem echo mheight = !mheight!

                                                                                                                                                    rem set /a "mx=%%c"
                                                                                                                                                    rem echo mx = !mx!

                                                                                                                                                    rem set /a "my=%%d"
                                                                                                                                                    rem echo my = !my!

                                                                                                                                                    if !contatore!==1 ( 
                                                                                                                                                                set /a "wmax=%%a" 
                                                                                                                                                                set /a "hmax=%%b"
                                                                                                                                                                set /a "xmin=%%c"
                                                                                                                                                                set /a "ymin=%%d"
                                                                                                                                                                set /a "mwidth=%%a"
                                                                                                                                                                set /a "mheight=%%b"
                                                                                                                                                                set /a "mx=%%c"
                                                                                                                                                                set /a "my=%%d"
                                                                                                                                                                set /a "contatore+=1"
                                                                                                                                                                )
                                                                                                                                                    
                                                                                                                                                    rem if %%b gtr !hmax! if %%c gtr !xmin! if %%d gtr !ymin! 

                                                                                                                                                    if %%a geq !wmax! if %%b geq !hmax! ( 
                                                                                                                                                                        set /a "wmax=%%a" 
                                                                                                                                                                        set /a "hmax=%%b"
                                                                                                                                                                        set /a "xmin=%%c"
                                                                                                                                                                        set /a "ymin=%%d"
                                                                                                                                                                        set /a "mwidth=%%a"
                                                                                                                                                                        set /a "mheight=%%b"
                                                                                                                                                                        set /a "mx=%%c"
                                                                                                                                                                        set /a "my=%%d"
                                                                                                                                                                        )
                                                                                                                                                    )
                                                                                    echo.
                                                                                    set /a "csup=!my!"
                                                                                    rem echo csup = !csup!
                                                                                                                                    
                                                                                    set /a "csin=!mx!"
                                                                                    rem echo csin = !csin!

                                                                                    set /a "cinf=!heightvideo!-!mheight!-!my!"
                                                                                    rem echo movieheightreal = !movieheightreal!
                                                                                    rem echo cinf = !cinf!
                                                                                    set /a "cdes=!widthvideo!-!mwidth!-!mx!"
                                                                                    rem echo cdes = !cdes!

                                                                                    echo !t15! !def!: !widthvideo!  
                                                                                    echo !t16! !def!: !heightvideo!  
                                                                                    echo.

                                                                                    echo Crop Settings: --crop !csin!,!csup!,!cdes!,!cinf!  
                                                                                    set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"  
                                                                                    echo.  

                                                                                    set /a "height4kcrop=(!heightvideo!-!csup!-!cinf!)/2*2"
                                                                                    set /a "width4kcrop=(!widthvideo!-!csin!-!cdes!)/2*2"

                                                                                    echo !t17! !def!: !width4kcrop!  
                                                                                    echo !t18! !def!: !height4kcrop!  
                                                                                    echo.

                                                                                    if !def!==1080p (
                                                                                                    set /a "larghezza1080pnvenc=1920"
                                                                                                    set /a "altezza1080pnvenc=1080"
                                                                                                    @REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
                                                                                                    @REM echo altezza1080pnvenc = !altezza1080pnvenc!       
                                                                                                    )               

                                                                                    if !def!==2160p (
                                                                                                    set /a "larghezza1080pnvenc=3840"
                                                                                                    set /a "altezza1080pnvenc=2160"
                                                                                                    @REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
                                                                                                    @REM echo altezza1080pnvenc = !altezza1080pnvenc!       
                                                                                                    )                      

                                                                                    set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!width4kcrop!"
                                                                                    set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!height4kcrop!"
                                                                                    @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
                                                                                    @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

                                                                                    if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                                                                                                        @REM echo dentro il 1o if
                                                                                                                                                                        set /a "width4k=!width4kcrop!"
                                                                                                                                                                        set /a "height4k=!height4kcrop!"
                                                                                                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                                                                                                set /a "width4k=!width4kcrop!"
                                                                                                                                                                                                                                                                set /a "height4k=!height4kcrop!"
                                                                                                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo width4kcrop = !width4kcrop!
                                                                                                                                                                                                                                                                                                                                                        @REM echo height4kcrop = !height4kcrop!
                                                                                                                                                                                                                                                                                                                                                        set /a "width4k=!width4kcrop!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        set /a "height4k=!height4kcrop!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "width4k=!width4kcrop!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "height4k=!height4kcrop!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                                                                                                                set /a "width4k=!width4kcrop!"
                                                                                                                                                                                                                                                                set /a "height4k=!height4kcrop!"
                                                                                                                                                                                                                                                                )
                                                                                                                                                                        
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                                                                                                        set /a "width4k=!width4kcrop!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        set /a "height4k=!height4kcrop!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        )                                                                                        
                                                                                   

                                                                                        echo !t19! !def!..
                                                                                        echo.                         

                                                                                        echo !t20! !def!:  !width4k! 
                                                                                        echo !t21! !def!:  !height4k!    
                                                                                        echo.

                                                                                        @REM set /a "width4k=width2k*2"
                                                                                        @REM set /a "height4k=height2k*2"

                                                                                        @REM echo Larghezza Finale Video 2160p:  !width4k! 
                                                                                        @REM echo Altezza Finale Video 2160p:  !height4k!    
                                                                                        @REM echo.
                                                                                    )  
                                                       )                          

:inizioCropManuale_NVEncDownGrade2160p10bitHDRto2160p8bitSDR 

set /a "csup=0"
set /a "cinf=0"
set /a "csin=0"
set /a "cdes=0"
set /a "bandasuperiore=0"
set /a "bandainferiore=0"
set /a "bandasinistra=0"
set /a "bandadestra=0"
set /a "differenzialelarghezza1080pnvenc=0"
set /a "differenzialealtezza1080pnvenc=0"
if exist ".\temp\Temp_HDR10_Stream.txt" ( del ".\temp\Temp_HDR10_Stream.txt" ) 
if exist ".\temp\durata_film.txt" ( del ".\temp\durata_film.txt" )
if exist ".\temp\crop.txt" ( del ".\temp\crop.txt" )
if exist ".\temp\risultato_multiplo.txt" ( del ".\temp\risultato_multiplo.txt" )
if exist ".\temp\crop_multiplo.txt" ( del ".\temp\crop_multiplo.txt" )
if exist ".\temp\crop_finale.txt" ( del ".\temp\crop_finale.txt" )

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t22!"   
    if errorlevel 2 goto cropmanualeNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
    if errorlevel 1 goto finecropmanualeNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
)
CHOICE /N /C:SN /M "!t22!"   

if errorlevel 2 goto cropmanualeNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
if errorlevel 1 goto finecropmanualeNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR


:cropmanualeNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
echo.
echo !t23!
echo.

:banda_superiore_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
set /p "bandasuperiore=!t24!"
SET "var="&for /f "delims=0123456789" %%i in ("!bandasuperiore!") do set var=!bandasuperiore!
if defined var (
                echo.
                echo !t25!
                echo.
                goto banda_superiore_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
                ) else (
                        set /a "csup=!bandasuperiore!/2*2"
                        )

echo.
:banda_inferiore_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
set /p "bandainferiore=!t26!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandainferiore!") do set var=!bandainferiore!
if defined var (
                echo.
                echo !t27!
                echo.
                goto banda_inferiore_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
                ) else (
                        set /a "cinf=!bandainferiore!/2*2"
                        )


echo.
:banda_sinistra_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
set /p "bandasinistra=!t28!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandasinistra!") do set var=!bandasinistra!
if defined var (
                echo.
                echo !t29!
                echo.
                goto banda_sinistra_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
                ) else (
                        set /a "csin=!bandasinistra!/2*2"
                        )

                        
echo.
:banda_destra_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
set /p "bandadestra=!t30!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandadestra!") do set var=!bandadestra!
if defined var (
                echo.
                echo !t31!
                echo.
                goto banda_destra_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
                ) else (
                        set /a "cdes=!bandadestra!/2*2"
                        )


if !def!==1080p (
                set /a "larghezza1080pnvenc=1920"
                set /a "altezza1080pnvenc=1080"
                @REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
                @REM echo altezza1080pnvenc = !altezza1080pnvenc!       
                )               

if !def!==2160p (
                set /a "larghezza1080pnvenc=3840"
                set /a "altezza1080pnvenc=2160"
                @REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
                @REM echo altezza1080pnvenc = !altezza1080pnvenc!       
                )                                                       

set /a "width4kcrop=!widthvideo!/2*2"
set /a "height4kcrop=!heightvideo!/2*2"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "mwidthc=!width4kcrop!-!csin!-!cdes!"
set /a "mheightc=!height4kcrop!-!csup!-!cinf!"
@REM echo nuovo mwidhtc = !mwidthc!
@REM echo nuovo mheightc = !mheightc!

set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!mwidthc!"
set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!mheightc!"
@REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
@REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

echo.
echo !t32!  !csup! 
echo !t33!  !cinf! 
echo !t34!  !csin! 
echo !t35!  !cdes! 
echo.


set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
echo Crop Settings: !cropff!
echo.

echo !t36! !def!:  !mwidthc! 
echo !t37! !def!:  !mheightc! 
echo.

rem pause

if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                        @REM echo dentro il 1o if
                                                                                        set /a "width4k=!mwidthc!"
                                                                                        set /a "height4k=!mheightc!"
                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                set /a "width4k=!mwidthc!"
                                                                                                                                                                                set /a "height4k=!mheightc!"
                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                        set /a "width4k=!mwidthc!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                        set /a "height4k=!mheightc!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                set /a "width4k=!mwidthc!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                set /a "height4k=!mheightc!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                )
                                                                                        if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                        set /a "width4k=!mwidthc!"
                                                                                                                                                                        set /a "height4k=!mheightc!"
                                                                                                                                                                        )
                                                                                                                                                                        
                                                                                        if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                set /a "width4k=!mwidthc!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                set /a "height4k=!mheightc!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                )                                                                                        
                                                                                   

                                                                                        echo !t19! !def!..
                                                                                        echo.                         

                                                                                        echo !t20! !def!:  !width4k! 
                                                                                        echo !t21! !def!:  !height4k!    
                                                                                        echo.

                                                                                        @REM set /a "width4k=width2k*2"
                                                                                        @REM set /a "height4k=height2k*2"

                                                                                        @REM echo Larghezza Finale Video 2160p:  !width4k! 
                                                                                        @REM echo Altezza Finale Video 2160p:  !height4k!    
                                                                                        @REM echo.
                                                                                    ) 

goto inizioCropManuale_NVEncDownGrade2160p10bitHDRto2160p8bitSDR

:finecropmanualeNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR




:InserimentoImpostazioniNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR

echo.
echo !t40!
echo.
echo 1) CQP 
echo 2) VBR 
echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto CodificaVBRNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
if errorlevel 1 goto CodificaCQPNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR

:CodificaVBRNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "TipoCodificaNVEnc=--vbr "
set /a "quantizzazioneNVEnc=0"
goto inserimentoValoriCQPVBRNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR

:CodificaCQPNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "TipoCodificaNVEnc=--cqp "
set /a "quantizzazioneNVEnc=1"

:inserimentoValoriCQPVBRNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR

if !quantizzazioneNVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneNVEnc=!t44! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneNVEnc!") do set var=!valoreQuantizzazioneNVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                goto inserimentoValoriCQPVBRNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
                                                ) 

                                set /a "valoreQuantizzazioneNVEnc=!valoreQuantizzazioneNVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneNVEnc!
                                if !valoreQuantizzazioneNVEnc! GEQ 10 if !valoreQuantizzazioneNVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneNVEnc!
                                                                                                                set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreQuantizzazioneNVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                                goto fineQuantizzazioneNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
                                                                                                                        
                                )



if !quantizzazioneNVEnc!==0 (
                                echo.
                                set /p "valoreBitRateNVEnc=!t46! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateNVEnc!") do set var=!valoreBitRateNVEnc!
                                if defined var (
                                                echo.
                                                echo !47!
                                                goto inserimentoValoriCQPVBRNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
                                                ) 
                                set /a "valoreBitRateNVEnc=!valoreBitRateNVEnc!"
                                @REM echo valoreBitRateNVEnc = !valoreBitRateNVEnc!
                                if !valoreBitRateNVEnc! GEQ 100 if !valoreBitRateNVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateNVEnc!
                                                                                                        set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreBitRateNVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                        goto fineQuantizzazioneNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
                                                                                                              
                                )


:fineQuantizzazioneNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR


echo.
echo !t50!
echo.
echo 1) P1 !t51!
echo 2) P2 
echo 3) P3 
echo 4) P4 
echo 5) P5 
echo 6) P6 
echo 7) P7 !t52!
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto P7NVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
if errorlevel 6 goto P6NVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
if errorlevel 5 goto P5NVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
if errorlevel 4 goto P4NVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
if errorlevel 3 goto P3NVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
if errorlevel 2 goto P2NVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
if errorlevel 1 goto P1NVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR


:P7NVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "SettaggioQualitaNVEnc=--preset P7"
set "QualitySetting=P7"
goto fineQualitCodificaNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR

:P6NVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "SettaggioQualitaNVEnc=--preset P6"
set "QualitySetting=P6"
goto fineQualitCodificaNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR

:P5NVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "SettaggioQualitaNVEnc=--preset P5"
set "QualitySetting=P5"
goto fineQualitCodificaNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR

:P4NVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "SettaggioQualitaNVEnc=--preset P4"
set "QualitySetting=P4"
goto fineQualitCodificaNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR

:P3NVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "SettaggioQualitaNVEnc=--preset P3"
set "QualitySetting=P3"
goto fineQualitCodificaNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR

:P2NVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "SettaggioQualitaNVEnc=--preset P2"
set "QualitySetting=P2"
goto fineQualitCodificaNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR

:P1NVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "SettaggioQualitaNVEnc=--preset P1"
set "QualitySetting=P1"
goto fineQualitCodificaNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR


:fineQualitCodificaNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaNVEnc!



echo.
echo !t71!
echo !t72!
echo.
echo 1) NVEnc Color Correction 
echo 2) LibPlacebo Color Correction 

echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto LibPlaceboColorNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
if errorlevel 1 goto NVEncColorCorrection_NVEncDownGrade2160p10bitHDRto2160p8bitSDR

:NVEncColorCorrection_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "NVEncColorCorrectionSystem=--vpp-colorspace hdr2sdr=hable,source_peak=1000,ldr_nits=100,a=0.22,b=0.3,c=0.1,d=0.2,e=0.01,f=0.3"
set "NVEncUpgrader=NVEnc Color Correction"
goto NVEncFineSelezione_NVEncDownGrade2160p10bitHDRto2160p8bitSDR

:LibPlaceboColorNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "NVEncColorCorrectionSystem=--vpp-libplacebo-tonemapping src_csp=dovi,dst_csp=sdr"
set "NVEncUpgrader=LibPlacebo Color Correction"


:NVEncFineSelezione_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
echo.
echo !t73! !NVEncUpgrader!
echo.
echo !t43! !NVEncColorCorrectionSystem!



set conv3d1080p=
set pmd1080p=


if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t55!"
    if errorlevel 2 goto conv3dChoosenNoNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
    if errorlevel 1 goto conv3dChoosenYesNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
)

echo.
CHOICE /N /C:SN /M "!t55!"

if errorlevel 2 goto conv3dChoosenNoNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
if errorlevel 1 goto conv3dChoosenYesNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR

:conv3dChoosenNoNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "conv3d1080p=N"
goto sceltaDeniserPMDNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR

:conv3dChoosenYesNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "conv3d1080p=S"





:sceltaDeniserPMDNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t56!"
    if errorlevel 2 goto PMDChoosenNoNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
    if errorlevel 1 goto PMDChoosenYesNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
)

echo.
CHOICE /N /C:SN /M "!t56!"

if errorlevel 2 goto PMDChoosenNoNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
if errorlevel 1 goto PMDChoosenYesNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR

:PMDChoosenNoNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "pmd1080p=N"
goto assegnazioneDenoisesNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR

:PMDChoosenYesNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "pmd1080p=S"


:assegnazioneDenoisesNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
set /A nvdenv=0

if !conv3d1080p!==S if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00 --vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )
if !conv3d1080p!==S if !pmd1080p!==N ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )
if !conv3d1080p!==N if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )
if !conv3d1080p!==N if !pmd1080p!==N ( 
                                        set "nvdenoiser=" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: Nessun Denoiser 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )

@REM pause


echo.

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t57!"
    if errorlevel 2 goto ApplicaMiglioramentoDettagliNVEncNO_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
    if errorlevel 1 goto ApplicaMiglioramentoDettagliNVEncSi_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
)

CHOICE /N /C:SN /M "!t57!"

if errorlevel 2 goto ApplicaMiglioramentoDettagliNVEncNO_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
if errorlevel 1 goto ApplicaMiglioramentoDettagliNVEncSi_NVEncDownGrade2160p10bitHDRto2160p8bitSDR

:ApplicaMiglioramentoDettagliNVEncNO_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "miglioramento1080p=N"
goto fineSceltaMigliaramentiNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR

:ApplicaMiglioramentoDettagliNVEncSi_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
set "miglioramento1080p=S"

:fineSceltaMigliaramentiNVEnc_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
if !miglioramento1080p!==S ( 
                                set "edgeleveling=--vpp-edgelevel strength=10.0,threshold=24.0,black=6,white=0" 
                                echo.
                                echo NVEnc !t58!
                                echo.
                                )
if !miglioramento1080p!==N ( 
                                set "edgeleveling=" 
                                echo.
                                echo NVEnc !t59!
                                echo.
                                )


@REM pause




rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



echo.
echo !t74!
echo.


set file_senza_virgolette=%NomeFile:"=%
rem echo %file_senza_virgolette%

set file_senza_estensione=%file_senza_virgolette:.mkv=%
rem echo %file_senza_estensione%

set fileoutput2160p="%file_senza_estensione%_DownGraded_!def!_8_bit_SDR.mkv"
rem echo fileoutput2160p = %fileoutput2160p%



set fileoutput2160p_senza_virgolette=%fileoutput2160p:"=% 
rem echo %fileoutput2160p_senza_virgolette%

for %%i in ("%fileoutput2160p_senza_virgolette%") do (  
                                                        set "solo_nome_file=%%~ni"
                                                        rem echo Nome file: !solo_nome_file!

                                                        set "solo_estensione_file=%%~xi"
                                                        rem echo Estensione: !solo_estensione_file!
                                                    )

set fileoutput2160p_rinominato=!solo_nome_file!_rinominato!solo_estensione_file!
rem echo %fileoutput2160p_rinominato%

if exist ".\temp\Temp_HDR10_Stream.txt" ( del .\temp\Temp_HDR10_Stream.txt )
if exist ".\temp\durata_film.txt" ( del .\temp\durata_film.txt )
if exist ".\temp\crop.txt" ( del .\temp\crop.txt )
if exist ".\temp\risultato_multiplo.txt" ( del .\temp\risultato_multiplo.txt )
if exist ".\temp\crop_multiplo.txt" ( del .\temp\crop_multiplo.txt )
if exist ".\temp\crop_finale.txt" ( del .\temp\crop_finale.txt )


".\bin\nvenc\NVEncC64.exe" --avhw --device 0 -i %NomeFile%  --output-res !width4k!x!height4k! !cropff! --output-depth 8 --video-metadata clear --metadata clear --chapter-copy -c hevc !tipoQuantizzazioneNVEnc! --bref-mode disabled !SettaggioQualitaNVEnc! --tier high --lookahead 32 --aq --aq-temporal --aq-strength 15 --level auto --chromaloc auto --colorrange auto --colormatrix  bt709 --transfer bt709 --colorprim bt709 --multipass None --mv-precision Q-pel  --avsync cfr  !NVEncColorCorrectionSystem! !nvdenoiser!  !edgeleveling! --vpp-resize algo=lanczos4   --log-level info --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off  --log ".\codifica_hardware_out_log.txt" -o %fileoutput2160p%


ren %fileoutput2160p% "%fileoutput2160p_rinominato%"



echo.
echo !t75!
echo.


rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



goto fineinfovideo_NVEncDownGrade2160p10bitHDRto2160p8bitSDR



:novideofile2160p10080p_NVEncDownGrade2160p10bitHDRto2160p8bitSDR
echo !t63!
echo.




:fineinfovideo_NVEncDownGrade2160p10bitHDRto2160p8bitSDR


if exist ".\saved\settings.dat" (
                                for /f "tokens=1,2 delims=|" %%a in (.\saved\settings.dat) do (
                                                                                                    rem echo %%a
                                                                                                    rem echo %%b
                                                                                                    set /a "shst=%%b"
                                                                                                    rem echo !shst!
                                                                                                    rem pause
                                                                                                    if !shst!==1 (
                                                                                                                echo !t1000!
                                                                                                                echo.
                                                                                                                shutdown /s
                                                                                                                set /a "delay=10"
                                                                                                                timeout /t !delay!
                                                                                                                exit
                                                                                                                )
                                                                                                                            
                                                                                                    )                                                                                                  
                                                                                                )


if exist ".\temp\Temp_HDR10_Stream.txt" ( del .\temp\Temp_HDR10_Stream.txt )
if exist ".\temp\durata_film.txt" ( del .\temp\durata_film.txt )
if exist ".\temp\crop.txt" ( del .\temp\crop.txt )
if exist ".\temp\risultato_multiplo.txt" ( del .\temp\risultato_multiplo.txt )
if exist ".\temp\crop_multiplo.txt" ( del .\temp\crop_multiplo.txt )
if exist ".\temp\crop_finale.txt" ( del .\temp\crop_finale.txt )
      




set waitenter=
set /P waitenter=!t65!
Endlocal
goto menuiniziale






rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:ImpostazioniSpegnimentoPC
cls

setLocal EnableExtensions EnableDelayedExpansion


:leggilingua
for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaItalianoSpegnimentoPC
)

if %lingua%==inglese (
    goto caricalinguaIngleseSpegnimentoPC
)


:caricalinguaIngleseSpegnimentoPC
set t1=Settings to Shut Down Your PC When Encodings Are Completed... 
set t2=Reading PC Shutdown Settings... 
set t3=The PC will not shut down at the end of the encodings.
set t4=Do you want to Enable PC shutdown at the end of encondings ? (Yes/No): 
set t5=PC shutdown at end of encoding Disabled 
set t6=PC shutdown at end of encoding Enabled 
set t7=The PC will be turned off at the end of the encodings. 
set t8=Do you want to Disable PC shutdown at the end of encondings ? (Yes/No): 
set t9=Press Enter to back to Main Menu:  
goto finecarimentolinguaSpegnimentoPC


:caricalinguaItalianoSpegnimentoPC
set t1=Impostazioni Spegnimento PC a Codifiche Terminate... 
set t2=Lettura impostazioni Spegnimento PC.. 
set t3=Il PC non verra' Spento alla fine delle codifiche. 
set t4=Vuoi Attivare lo Spegnimento del PC a fine Codifica ? (Si/No): 
set t5=Spegnimento PC a fine Codifica Disattivato 
set t6=Spegnimento PC a fine Codifica Attivato 
set t7=Il PC verra' Spento alla fine delle codifiche. 
set t8=Vuoi Disattivare lo Spegnimento del PC a fine Codifica ? (Si/No): 
set t9=Premi Invio per tornare al menu' principale:  
goto finecarimentolinguaSpegnimentoPC

:finecarimentolinguaSpegnimentoPC


echo !t1!
echo.

rem pause

if exist ".\saved\settings.dat" (
                                    rem pause
                                    echo !t2!
                                    echo.

                                    for /f "tokens=1,2 delims=|" %%a in (.\saved\settings.dat) do  (
                                                                                                    rem echo %%a
                                                                                                    rem echo %%b
                                                                                                    set /a "shst=%%b"
                                                                                                    if !shst!==0 (
                                                                                                                    echo !t3!
                                                                                                                    echo.
                                                                                                                    
                                                                                                                    if !lingua!== inglese (
                                                                                                                        CHOICE /N /C:YN /M "!t4!"
                                                                                                                        if errorlevel 2 goto SpegnimentoPCFineCodificaNo
                                                                                                                        if errorlevel 1 goto SpegnimentoPCFineCodificaSi
                                                                                                                    )

                                                                                                                    CHOICE /N /C:SN /M "!t4!"

                                                                                                                    if errorlevel 2 goto SpegnimentoPCFineCodificaNo
                                                                                                                    if errorlevel 1 goto SpegnimentoPCFineCodificaSi

                                                                                                                    :SpegnimentoPCFineCodificaNo
                                                                                                                    echo.
                                                                                                                    echo !t5!
                                                                                                                    echo.
                                                                                                                    goto fineSettingsShutdown

                                                                                                                    :SpegnimentoPCFineCodificaSi
                                                                                                                    set "shutdownstate=shutdown|1"
                                                                                                                    echo !shutdownstate! > ".\saved\settings.dat"
                                                                                                                    echo.
                                                                                                                    echo !t6!
                                                                                                                    echo.
                                                                                                                    goto fineSettingsShutdown

                                                                                                                    )
                                                                                                    if !shst!==1 (
                                                                                                                    echo !t7!
                                                                                                                    echo.
                                                                                                                    
                                                                                                                    if !lingua!== inglese (
                                                                                                                        CHOICE /N /C:YN /M "!t8!"
                                                                                                                        if errorlevel 2 goto DisattivareSpegnimentoPCFineCodificaNo
                                                                                                                        if errorlevel 1 goto DisattivareSpegnimentoPCFineCodificaSi
                                                                                                                    )
                                                                                                                    CHOICE /N /C:SN /M "!t8!"

                                                                                                                    if errorlevel 2 goto DisattivareSpegnimentoPCFineCodificaNo
                                                                                                                    if errorlevel 1 goto DisattivareSpegnimentoPCFineCodificaSi

                                                                                                                    :DisattivareSpegnimentoPCFineCodificaNo
                                                                                                                    echo.
                                                                                                                    echo !t6!
                                                                                                                    echo.
                                                                                                                    goto fineSettingsShutdown

                                                                                                                    :DisattivareSpegnimentoPCFineCodificaSi
                                                                                                                    set "shutdownstate=shutdown|0"
                                                                                                                    echo !shutdownstate! > ".\saved\settings.dat"
                                                                                                                    echo.
                                                                                                                    echo !t5!
                                                                                                                    echo.
                                                                                                                    goto fineSettingsShutdown

                                                                                                                    )
                                                                                                    )                                
                                ) else (
                                        set "shutdownricreate=shutdown|0"
                                        echo !shutdownricreate! > ".\saved\settings.dat"
                                        )

rem pause

:fineSettingsShutdown

set waitenter=
set /P waitenter=!t9!
Endlocal
goto puliziainiziale






rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:NVEncPuliziaLeggeraDettagliMigliorati

cls
setLocal EnableExtensions EnableDelayedExpansion



for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoNVEncPuliziaLeggeraDettagliMigliorati
)
if %lingua%==inglese (
    goto caricalinguaingleseNVEncPuliziaLeggeraDettagliMigliorati
)


:caricalinguaingleseNVEncPuliziaLeggeraDettagliMigliorati
@REM set t1=Insert Hardware Video Encoding Info 2160p Light Denoiser, Detail Enhancement and Saving to Disk. 

set t2=Drag Here the Video File 2160p 10 bit HDR to apply a Light Denoiser and Enhance Details: 
@REM set t211=Video File 2160p 10 bit HDR to apply the Denoiser and Enhance Details: 


set t3=File does not exist 
set t4=Info Video:  

set t5=The Inserted Video is 2160p 10bit HDR 
@REM set t511=The Inserted Video is 2160p 10bit SDR 

set t6=The Inserted Video isn't 2160p 10bit HDR 
set t7=Video Duration in seconds:
set t8=Video Duration in Minutes:
set t9=Interval between Frames for Crop Detection:
set t10= seconds
set t11=Black Bands Detection Started....
set t12=Crop Detection to Frame
set t13=to seconds
set t14=Done...
set t15=Original 2160p Video Width: 
set t16=Original 2160p Video Height:
set t17=Original Video 2160p Width Without Black Bars:
set t18=Original Video 2160p Height Without Black Bars:

set t171=Output Video 1080p Width Without Black Bars:
set t181=Outout Video 1080p Height Without Black Bars:

set t19=Adapting Video Resolution to Full 2160p Format...
set t20=Final 2160p Output Video Width:
set t21=Final 2160p Output Video Height:

set t22=Settings of Black Bands to Crop are Correct (Yes/No):
set t23=Manually Entering Black Bands Values to Crop... 
set t24=Enter the Upper Black Band Value: 
set t25=Error Entering Upper Black Band Value... It's Not a Number. 
set t26=Enter the Lower Black Band Value: 
set t27=Error Entering Lower Black Band Value... It's Not a Number.
set t28=Enter the Left Black Band Value: 
set t29=Error Entering Left Black Band Value... It's Not a Number.
set t30=Enter the Right Black Band Value: 
set t31=Error Entering Right Black Band Value... It's Not a Number.
set t32=Upper Black Band:
set t33=Lower Black Band:
set t34=Left Black Band:
set t35=Right Black Band:
set t36=2160p Original Video Width without Black Bars:
set t37=2160p Original Video Height without Black Bars:

@REM set t361=1080p Video Width without Black Bars:
@REM set t371=1080p Video Height without Black Bars

set t38=Select Graphic Card you want to Encode with:
set t39=Choose (1/2):
set t40=Select Encoding Type:
set t41=Error Entering Quantization Value... Not a Number. 
set t42=Quantization Value Set to:
set t43=Encoding Settings:
set t44=Enter Quantization value Minimum 10 Maximum 28:
set t45=Quantization Value Out of  Limits  10 / 28  Re-enter^!
set t46=Enter BitRate Value kbs Minimum 100 Maximum 50000:
set t47=Error Entering BitRate Value... It's Not a Number. 
set t48=BitRate Value Set to:
set t49=BitRate Value Out of Limits  100 / 50000  Re-enter^!
set t50=Select Encoding Quality:
set t51=- Worst Quality
set t52=- Best Quality
set t53=Choose (1/2/3/4/5/6/7):
set t54=Quality Set to:
set t55=Apply Convolution3D denoiser Yes/No: 
set t56=Apply PMD denoiser Yes/No: 
set t57=Apply Detail Enhancement Yes/No:  
set t58=Enhancement Detail: Yes 
set t59=Enhancement Detail: No 
set t60=Info
set t61=Videos to Encode Saved!
set t62=Do You Want to Insert Another Video to Encode (Yes/No):
set t63=The dragged file is not a video!
set t64=Choose (1/2/3/4):
@REM set t65=Press Enter toback to Menu Inserting Encoding into the Queue and Saving to Disk:  

set t65=Press Enter to Back to Main Menu.  

set t66=Video Width
set t67=Video Height
set t68=Video Codec
set t69=Details Video Codec
set t70=Video Format 
set t71=Configuration Settings to convert video from 8bit or 10bit SDR to 10bit HDR
set t72=Select Encoding UpGrader:
set t73=Settings UpGrader:
set t74=Choose (1/2/3):

set t75=Encoding Finisher...
set t76=Light Clean and Enhancement Details Started.... 
set t1000=Now the PC will be turned off... 

goto avvio_NVEncPuliziaLeggeraDettagliMigliorati



:caricalinguaitalianoNVEncPuliziaLeggeraDettagliMigliorati
@REM set t1=Inserimento Info Codifica Hardware Video 2160p Denoiser Leggero, Miglioramento Dettagli e Salvataggio su Disco.

set t2=Trascina Qui il File Video 2160p 10 bit HDR a cui applicare un Leggero Denoiser e il Miglioramento Dettagli:  
@REM set t211=File Video 2160p 10 bit HDR a cui applicare il Denoiser e il Miglioramento Dettagli:  

set t3=File Inesistente 
set t4=Informazioni Video:  

set t5=Il Video inserito e' 2160p 10bit HDR 
@REM set t511=Il Video inserito e' 2160p 10bit SDR 

set t6=Il Video inserito non e' 2160p 10bit HDR 

set t7=Durata del Video in secondi:
set t8=Durata del video in Minuti:
set t9=Intervallo tra i Fotogrammi per il Rilevamento del crop:
set t10= secondi
set t11=Rilevamento Bande Nere Iniziato....
set t12=Rilevazione crop fotogramma
set t13=a secondi
set t14=Eseguita...
set t15=Larghezza Video 2160p Originale:
set t16=Altezza Video 2160p Originale:
set t17=Larghezza Video Originale 2160p  Senza Barre Nere:
set t18=Altezza Video Originale 2160p  Senza Barre Nere:

set t171=Larghezza Video 1080p  Senza Barre Nere:
set t181=Altezza Video 1080p  Senza Barre Nere:

set t19=Adattamento della Risoluzione del Video al Pieno Formato 2160p..
set t20=Larghezza Finale Video 2160p:
set t21=Altezza Finale Video 2160p:

set t22=Le Impostazioni delle Bande Nere da Tagliare sono Corrette (Si/No):
set t23=Inserimento Manuale Valori Bande Nere da Tagliare.. 
set t24=Inserisci il Valore della Banda Nera Superiore: 
set t25=Errore nell'Inserimento del Valore della Banda Nera Superiore... Non e' un Numero. 
set t26=Inserisci il Valore della Banda Nera Inferiore: 
set t27=Errore nell'Inserimento del Valore della Banda Nera Inferiore... Non e' un Numero. 
set t28=Inserisci il Valore della Banda Nera Sinistra: 
set t29=Errore nell'Inserimento del Valore della Banda Nera Sinistra... Non e' un Numero. 
set t30=Inserisci il Valore della Banda Nera Destra: 
set t31=Errore nell'Inserimento del Valore della Banda Nera Destra... Non e' un Numero. 
set t32=Banda Nera Superiore:
set t33=Banda Nera Inferiore:
set t34=Banda Nera Sinistra:
set t35=Banda Nera Destra:
set t36=Larghezza Video Originale 2160p senza Bande Nere:
set t37=Altezza Video Originale 2160p senza Bande Nere:

@REM set t361=Larghezza Video 1080p senza Bande Nere:
@REM set t371=Altezza Video 1080p senza Bande Nere:

set t38=Selezionare Scheda Grafica con cui Eseguire la Codifica:
set t39=Scegli (1/2):
set t40=Selezionare tipo di Codifica:
set t41=Errore nell'Inserimento del Valore della Quantizzazione... Non e' un Numero. 
set t42=Valore Quantizzazzione Impostato a:
set t43=Parametri per codifica:

set t44=Inserire Valore Quantizzazione Minimo 10 Massimo 28:
set t45=Valore Quantizzazzione al di fuori dei  Limiti  10 / 28  Reinserire^!
set t46=Inserire Valore BitRate kbs Minimo 100 Massimo 50000:
set t47=Errore nell'Inserimento del Valore del BitRate... Non e' un Numero. 
set t48=Valore BitRate Impostato a:
set t49=Valore  BitRate al di fuori dei  Limiti  100 / 50000  Reinserire^!

set t50=Selezionare Qualita' Codifica:
set t51=- Peggiore Qualita'
set t52=- Migliore Qualita'
set t53=Scegli (1/2/3/4/5/6/7):
set t54=Qualita' Impostata su:
set t55=Applicare il denoiser Convolution3D Si/No: 
set t56=Applicare il denoiser PMD Si/No: 
set t57=Applicare il Miglioramento Dettagli Si/No:  
set t58=Miglioramento Dettagli: Si 
set t59=Miglioramento Dettagli: No 
set t60=Informazioni
set t61=Video da Codificare Salvate!
set t62=Vuoi Inserire un altro Video da Codificare (Si/No):
set t63=Il file trascinato non e' un video!
set t64=Scegli (1/2/3/4):
@REM set t65=Premi Invio per tornare al menu' Inserimento Codifiche in Coda e Salvataggio sul Disco:  

set t65=Premi Invio per tornare al Menu' Principale.  

set t66=Larghezza Video
set t67=Altezza Video
set t68=Codec Video
set t69=Codec Video Dettagli
set t70=Format Video 
set t71=Configurazione Parametri per convertire il video da 8bit o 10bit SDR a 10bit HDR
set t72=Selezionare UpGrader Codifica:
set t73=UpGrader Impostato:
set t74=Scegli (1/2/3):

set t75=Codifica Terminata...
set t76=Pulizia Leggera e Miglioramento Dettagli Iniziati.... 
set t1000=Il PC ora verra' Spento... 

goto avvio_NVEncPuliziaLeggeraDettagliMigliorati

:avvio_NVEncPuliziaLeggeraDettagliMigliorati




set /a "numeromovie=1"



:altrivideodainserireNVEnc_NVEncPuliziaLeggeraDettagliMigliorati


set NomeFile=
rem set MetadatiStreamHDR10=

set /P NomeFile2160ppuliziadettaggli=!t2! 
rem echo Hai digitato: %NomeFile%
rem pause

set "NomeFileSorgente=!NomeFile2160ppuliziadettaggli:"=!"
@REM echo NomeFileSorgente = !NomeFileSorgente!
set "NomeFile=^"!NomeFileSorgente!^""
@REM echo NomeFile = !NomeFile!
rem pause


if exist !NomeFile! ( goto infovideo_NVEncPuliziaLeggeraDettagliMigliorati ) else ( 
                                                        echo.
                                                        echo !t3!
                                                        echo.
                                                        goto fineinfovideo_NVEncPuliziaLeggeraDettagliMigliorati
                                                        )    



:infovideo_NVEncPuliziaLeggeraDettagliMigliorati
echo.
echo !t4!
echo.

.\bin\ffprobe -v error -hide_banner -select_streams v:0 -show_entries stream=width,height,codec_name,codec_long_name,pix_fmt,color_space,color_transfer,color_primaries -of default=noprint_wrappers=1 !NomeFile! > "Temp_HDR10_Stream.txt"

set /A x1=1
set /A nohdrcs=0
set /A nohdrct=0
set /A nohdrcp=0
set /A wv=0
set /a hv=0
set /A fv=0

rem echo nohdr = %nohdr%

for /f "tokens=1,2 delims==" %%a in (Temp_HDR10_Stream.txt) do (if !x1!==3 ( 
                                                                            echo !t66! "%%a" = %%b  
                                                                            set /A "widthvideo=%%b"
                                                                            rem echo widthvideo = !widthvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !widthvideo! LEQ 3840 if !widthvideo! GEQ 2000 (set /A "wv=1"
                                                                                                                                rem echo wv = !wv!
                                                                                                                                )
                                                                            )
                                                                if !x1!==4 ( 
                                                                            echo !t67! "%%a" = %%b  
                                                                            set /A "heightvideo=%%b"
                                                                            rem echo heightvideo = !heightvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !heightvideo! LEQ 2160 if !heightvideo! GEQ 1400 (set /A "hv=1"
                                                                                                        rem echo hv = !hv!
                                                                                                        )
                                                                            )                                                           
                                                                if !x1!==6 ( 
                                                                            echo Color Space "%%a" = %%b  
                                                                            set "colorsp=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colorsp!==bt2020nc (set /A "nohdrcs=1"
                                                                                                    rem echo nohdr = !nohdr!
                                                                                                    )
                                                                            if !colorsp!==unknown (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorsp!==reserved (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                    
                                                                            ) 
                                                                if !x1!==7 ( 
                                                                            echo Color Transfer "%%a" = %%b  
                                                                            set "colortr=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colortr!==smpte2084 (set /A "nohdrct=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            ) 
                                                                if !x1!==8 ( 
                                                                            echo Color Primaries "%%a" = %%b  
                                                                            set "colorpr=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colorpr!==bt2020 (set /A "nohdrcp=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )           
                                                                            )    
                                                                if !x1!==1 ( 
                                                                            echo !t68! "%%a" = %%b  
                                                                            )       
                                                                if !x1!==2 ( 
                                                                            echo !t69! "%%a" = %%b  
                                                                            )   
                                                                if !x1!==5 ( 
                                                                            echo !t70! "%%a" = %%b  
                                                                            set "formatvideo=%%b"
                                                                            rem echo formatvideo = !formatvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !formatvideo!==yuv420p10le (set /A "fv=1"
                                                                                                            rem echo fv = !fv!
                                                                                                            )
                                                                            )
                                                                set /A x1+=1                                                            
)
echo.

if !x1!==1 goto novideofile2160p_NVEncPuliziaLeggeraDettagliMigliorati


if !nohdrcs!==1 if !nohdrct!==1 if !nohdrcp!==1 if !wv!==1 if !hv!==1 if !fv!==1 ( 
                                                                                   echo !t5!
                                                                                   @REM echo. 
                                                                                   goto rilevazionebandenere_NVEncPuliziaLeggeraDettagliMigliorati
                                                                                   ) 
echo !t6!
echo.
goto fineinfovideo_NVEncPuliziaLeggeraDettagliMigliorati


rem//////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////

:rilevazionebandenere_NVEncPuliziaLeggeraDettagliMigliorati

.\bin\ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 !NomeFile!  > ".\temp\durata_film.txt"

set /a contatore=1
for /f "tokens=1 delims=." %%a in (.\temp\durata_film.txt) do  (
                                                        echo. 
                                                        echo !t7! %%a
                                                        set /a "secondi=%%a"
                                                        set /a "minuti=!secondi!/60"
                                                        echo !t8! !minuti!
                                                        set /a "intervallo_tagli=!secondi!/11"
                                                        echo !t9! !intervallo_tagli!!t10!
                                                        echo.
                                                        echo !t11!
                                                        echo.

                                                        

                                                        FOR /L %%a IN (1, 1, 10) DO (
                                                                                    rem echo %%a
                                                                                    set /a "secondi=%%a*!intervallo_tagli!"
                                                                                    rem echo !secondi!

                                                                                    
                                                                                    set /a "ca=72"
                                                                                    rem echo !ca!
                                                                                                                    
                                                                                    set /a "cb=2"
                                                                                    rem echo !cb!
                                                                                                                    
                                                                                    set /a "cc=0"
                                                                                    rem echo !cc!

                                                                                    set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                    rem echo !cr!
        
                                                                                
                                                                                    .\bin\ffmpeg -ss !secondi! -hide_banner -nostats -i !NomeFile! -vframes 10 -vf !cr! -f null - 2> ".\temp\crop.txt"
                                                                                    
                                                                                    findstr /r "Parsed_cropdetect_0" .\temp\crop.txt >> .\temp\risultato_multiplo.txt   
                                                                                    
                                                                                    echo !t12! %%a !t13! !secondi! !t14!
                                                                                    
                                                                                    )       
                                                                                       

                                                                                    for /f "tokens=1,2 delims==" %%a in (.\temp\risultato_multiplo.txt) do ( echo %%b >> .\temp\crop_multiplo.txt )
                                                                                    
                                                                                    set /a "maxfrequenza=0"

                                                                                    for /f "delims=" %%a in (.\temp\crop_multiplo.txt) do ( 
                                                                                                                                    set "cropconfront=%%a"
                                                                                                                                    rem echo "!cropconfront!"
                                                                                                                                    
                                                                                                                                    set /a "contatorfrequenza=0"
                                                                                                                                    for /f "delims=" %%b in (.\temp\crop_multiplo.txt) do (
                                                                                                                                                                                    set "dato_da_verificare=%%b"
                                                                                                                                                                                    rem echo cropconfront = "!cropconfront!"
                                                                                                                                                                                    rem echo dato_da_verificare = "!dato_da_verificare!"
                                                                                                                                                                                    if !cropconfront!==!dato_da_verificare! ( set /a "contatorfrequenza+=1")
                                                                                                                                                                                    )
                                                                                                                                    if !maxfrequenza! LSS !contatorfrequenza! ( 
                                                                                                                                                                                set /a "maxfrequenza=!!contatorfrequenza!!"
                                                                                                                                                                                set "cropd=!cropconfront!"
                                                                                                                                                                                )
                                                                                                                                    

                                                                                                                                    rem if !cropconfront! in (elenco_crop_frequenza.txt) ()
                                                                                                                                    rem echo !cropconfront!:!contatorfrequenza! >> elenco_crop_frequenza.txt

                                                                                                                                    )

                                                                                    rem echo crop piu' frequente = !cropd! con grequenza = !maxfrequenza!
                                                                                    echo !cropd! > .\temp\crop_finale.txt

                                                                                    for /f "tokens=1,2,3,4 delims=:" %%a in (.\temp\crop_finale.txt) do  ( 
                                                                                                                                                    rem set /a "mwidth=%%a"
                                                                                                                                                    rem echo mwidth = !mwidth!

                                                                                                                                                    rem set /a "mheight=%%b"
                                                                                                                                                    rem echo mheight = !mheight!

                                                                                                                                                    rem set /a "mx=%%c"
                                                                                                                                                    rem echo mx = !mx!

                                                                                                                                                    rem set /a "my=%%d"
                                                                                                                                                    rem echo my = !my!

                                                                                                                                                    if !contatore!==1 ( 
                                                                                                                                                                set /a "wmax=%%a" 
                                                                                                                                                                set /a "hmax=%%b"
                                                                                                                                                                set /a "xmin=%%c"
                                                                                                                                                                set /a "ymin=%%d"
                                                                                                                                                                set /a "mwidth=%%a"
                                                                                                                                                                set /a "mheight=%%b"
                                                                                                                                                                set /a "mx=%%c"
                                                                                                                                                                set /a "my=%%d"
                                                                                                                                                                set /a "contatore+=1"
                                                                                                                                                                )
                                                                                                                                                    
                                                                                                                                                    rem if %%b gtr !hmax! if %%c gtr !xmin! if %%d gtr !ymin! 

                                                                                                                                                    if %%a geq !wmax! if %%b geq !hmax! ( 
                                                                                                                                                                        set /a "wmax=%%a" 
                                                                                                                                                                        set /a "hmax=%%b"
                                                                                                                                                                        set /a "xmin=%%c"
                                                                                                                                                                        set /a "ymin=%%d"
                                                                                                                                                                        set /a "mwidth=%%a"
                                                                                                                                                                        set /a "mheight=%%b"
                                                                                                                                                                        set /a "mx=%%c"
                                                                                                                                                                        set /a "my=%%d"
                                                                                                                                                                        )
                                                                                                                                                    )
                                                                                    echo.

                                                                                    set /a "mwidth=!mwidth!/2*2"
                                                                                    set /a "mheight=!mheight!/2*2"

                                                                                    set /a "csup=!my!"
                                                                                    rem echo csup = !csup!
                                                                                                                                    
                                                                                    set /a "csin=!mx!"
                                                                                    rem echo csin = !csin!

                                                                                    set /a "cinf=!heightvideo!-!mheight!-!my!"
                                                                                    rem echo movieheightreal = !movieheightreal!
                                                                                    rem echo cinf = !cinf!
                                                                                    set /a "cdes=!widthvideo!-!mwidth!-!mx!"
                                                                                    rem echo cdes = !cdes!

                                                                                    set /a "Width4k=!mwidth!"
                                                                                    set /a "height4k=!mheight!"
                                                                                    
                                                                                    echo Crop Setting: --crop !csin!,!csup!,!cdes!,!cinf!  
                                                                                    set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"  
                                                                                    echo.  
                                                                                    
                                                                                    echo !t17!  !width4k! 
                                                                                    echo !t18!  !height4k! 
                                                                                    echo.

                                                                                    set /a "larghezza2160pnvenc=3840"
                                                                                    set /a "altezza2160pnvenc=2160"
                                                                                    @REM echo larghezza2160pnvenc = !larghezza2160pnvenc!                                    
                                                                                    @REM echo altezza2160pnvenc = !altezza2160pnvenc!                                    

                                                                                    set /a "differenzialelarghezza2160pnvenc=!larghezza2160pnvenc!-!mwidth!"
                                                                                    set /a "differenzialealtezza2160pnvenc=!altezza2160pnvenc!-!mheight!"
                                                                                    @REM echo differenzialelarghezza2160pnvenc = !differenzialelarghezza2160pnvenc!                                                                
                                                                                    @REM echo differenzialealtezza2160pnvenc = !differenzialealtezza2160pnvenc!

                                                                                    if !differenzialelarghezza2160pnvenc!==0 if !differenzialealtezza2160pnvenc! GTR 0 (
                                                                                                                                                                        @REM echo dentro il 1o if
                                                                                                                                                                        set /a "width4k=!mwidth!"
                                                                                                                                                                        set /a "height4k=!mheight!"
                                                                                                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                                                                                                        if !differenzialelarghezza2160pnvenc! GTR 0 if !differenzialealtezza2160pnvenc!==0 (
                                                                                                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                                                                                                set /a "width4k=!mwidth!"
                                                                                                                                                                                                                                                                set /a "height4k=!mheight!"
                                                                                                                                                                                                                                                                ) else if !differenzialelarghezza2160pnvenc! LSS !differenzialealtezza2160pnvenc! (
                                                                                                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza2160pnvenc = !differenzialelarghezza2160pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza2160pnvenc = !differenzialealtezza2160pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                                                                                                        set /a "width4k=!mwidth!+!differenzialelarghezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        set /a "height4k=!mheight!+!differenzialelarghezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        @REM echo width4k = !width4k!
                                                                                                                                                                                                                                                                                                                                                        @REM echo height4k = !height4k!
                                                                                                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza2160pnvenc! GTR !differenzialealtezza2160pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "width4k=!mwidth!+!differenzialealtezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo width4k = !width4k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "height4k=!mheight!+!differenzialealtezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo height4k = !height4k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                if !differenzialelarghezza2160pnvenc!==0 if !differenzialealtezza2160pnvenc!==0 (   
                                                                                                                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                                                                                                                set /a "width4k=!mwidth!"
                                                                                                                                                                                                                                                                set /a "height4k=!mheight!"
                                                                                                                                                                                                                                                                )
                                                                                                                                                                        
                                                                                                                                                                                if !differenzialelarghezza2160pnvenc!==!differenzialealtezza2160pnvenc! (   
                                                                                                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                                                                                                        set /a "width4k=!mwidth!+differenzialelarghezza2160pnvenc"
                                                                                                                                                                                                                                                        set /a "height4k=!mheight!+differenzialelarghezza2160pnvenc"
                                                                                                                                                                                                                                                        )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.                         

                                                                                        echo !t20!  !width4k! 
                                                                                        echo !t21!  !height4k!    
                                                                                        echo.

                                                                                    ) 
                                                        )                          

:inizioinserimentomanualecrop_NVEncPuliziaLeggeraDettagliMigliorati
set /a "csup=0"
set /a "cinf=0"
set /a "csin=0"
set /a "cdes=0"
set /a "bandasuperiore=0"
set /a "bandainferiore=0"
set /a "bandasinistra=0"
set /a "bandadestra=0"
set /a "differenzialelarghezza1080pnvenc=0"
set /a "differenzialealtezza1080pnvenc=0"
if exist ".\temp\Temp_HDR10_Stream.txt" ( del .\temp\Temp_HDR10_Stream.txt )
if exist ".\temp\durata_film.txt" ( del .\temp\durata_film.txt )
if exist ".\temp\crop.txt" ( del .\temp\crop.txt )
if exist ".\temp\risultato_multiplo.txt" ( del .\temp\risultato_multiplo.txt )
if exist ".\temp\crop_multiplo.txt" ( del .\temp\crop_multiplo.txt )
if exist ".\temp\crop_finale.txt" ( del .\temp\crop_finale.txt )  

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t22!"   
    if errorlevel 2 goto inserimentomanualecrop_NVEncPuliziaLeggeraDettagliMigliorati
    if errorlevel 1 goto finecrop_NVEncPuliziaLeggeraDettagliMigliorati
)

CHOICE /N /C:SN /M "!t22!"   

if errorlevel 2 goto inserimentomanualecrop_NVEncPuliziaLeggeraDettagliMigliorati
if errorlevel 1 goto finecrop_NVEncPuliziaLeggeraDettagliMigliorati

:inserimentomanualecrop_NVEncPuliziaLeggeraDettagliMigliorati
echo.
echo !t23!
echo.

:banda_superiore_NVEncPuliziaLeggeraDettagliMigliorati
set /p "bandasuperiore=!t24!"
SET "var="&for /f "delims=0123456789" %%i in ("!bandasuperiore!") do set var=!bandasuperiore!
if defined var (
                echo.
                echo !t25!
                echo.
                goto banda_superiore_NVEncPuliziaLeggeraDettagliMigliorati
                ) else (
                        set /a "csup=!bandasuperiore!/2*2"
                        )

echo.
:banda_inferiore_NVEncPuliziaLeggeraDettagliMigliorati
set /p "bandainferiore=!t26!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandainferiore!") do set var=!bandainferiore!
if defined var (
                echo.
                echo !t27!
                echo.
                goto banda_inferiore_NVEncPuliziaLeggeraDettagliMigliorati
                ) else (
                        set /a "cinf=!bandainferiore!/2*2"
                        )


echo.
:banda_sinistra_NVEncPuliziaLeggeraDettagliMigliorati
set /p "bandasinistra=!t28!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandasinistra!") do set var=!bandasinistra!
if defined var (
                echo.
                echo !t29!
                echo.
                goto banda_sinistra_NVEncPuliziaLeggeraDettagliMigliorati
                ) else (
                        set /a "csin=!bandasinistra!/2*2"
                        )

                        
echo.
:banda_destra_NVEncPuliziaLeggeraDettagliMigliorati
set /p "bandadestra=!t30!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandadestra!") do set var=!bandadestra!
if defined var (
                echo.
                echo !t31!
                echo.
                goto banda_destra_NVEncPuliziaLeggeraDettagliMigliorati
                ) else (
                        set /a "cdes=!bandadestra!/2*2"
                        )


set /a "larghezza2160pnvenc=3840"
set /a "altezza2160pnvenc=2160"
@REM echo larghezza2160pnvenc = !larghezza2160pnvenc!                                    
@REM echo altezza2160pnvenc = !altezza2160pnvenc!                                    

set /a "mwidth=!widthvideo!/2*2"
set /a "mheight=!heightvideo!/2*2"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "mwidthc=!mwidth!-!csin!-!cdes!"
set /a "mheightc=!mheight!-!csup!-!cinf!"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "differenzialelarghezza2160pnvenc=!larghezza2160pnvenc!-!mwidthc!"
set /a "differenzialealtezza2160pnvenc=!altezza2160pnvenc!-!mheightc!"
@REM echo differenzialelarghezza2160pnvenc = !differenzialelarghezza2160pnvenc!                                                                
@REM echo differenzialealtezza2160pnvenc = !differenzialealtezza2160pnvenc!

echo.
echo !t32!  !csup! 
echo !t33!  !cinf! 
echo !t34!  !csin! 
echo !t35!  !cdes! 
echo.


set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
echo Crop Settings: !cropff!
echo.

echo !t17!  !mwidthc! 
echo !t18!  !mheightc! 
echo.



if !differenzialelarghezza2160pnvenc!==0 if !differenzialealtezza2160pnvenc! GTR 0 (
                                                                                        @REM echo dentro il 1o if
                                                                                        set /a "width4k=!mwidthc!"
                                                                                        set /a "height4k=!mheightc!"
                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                        if !differenzialelarghezza2160pnvenc! GTR 0 if !differenzialealtezza2160pnvenc!==0 (
                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                set /a "width4k=!mwidthc!"
                                                                                                                                                                                set /a "height4k=!mheightc!"
                                                                                                                                                                                ) else if !differenzialelarghezza2160pnvenc! LSS !differenzialealtezza2160pnvenc! (
                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza2160pnvenc = !differenzialelarghezza2160pnvenc!
                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza2160pnvenc = !differenzialealtezza2160pnvenc!
                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                        set /a "width4k=!mwidthc!+!differenzialelarghezza2160pnvenc!"
                                                                                                                                                                                                                                                                        set /a "height4k=!mheightc!+!differenzialelarghezza2160pnvenc!"
                                                                                                                                                                                                                                                                        @REM echo width4k = !width4k!
                                                                                                                                                                                                                                                                        @REM echo height4k = !height4k!
                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza2160pnvenc! GTR !differenzialealtezza2160pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                set /a "width4k=!mwidthc!+!differenzialealtezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo width4k = !width4k!
                                                                                                                                                                                                                                                                                                                                                                set /a "height4k=!mheightc!+!differenzialealtezza2160pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo height4k = !height4k!
                                                                                                                                                                                                                                                                                                                                                                )
                                                                                        if !differenzialelarghezza2160pnvenc!==0 if !differenzialealtezza2160pnvenc!==0 (   
                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                        set /a "width4k=!mwidthc!"
                                                                                                                                                                        set /a "height4k=!mheightc!"
                                                                                                                                                                        )
                                                                                                                                                                        
                                                                                        if !differenzialelarghezza2160pnvenc!==!differenzialealtezza2160pnvenc! (   
                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                set /a "width4k=!mwidthc!+differenzialelarghezza2160pnvenc"
                                                                                                                                                                set /a "height4k=!mheightc!+differenzialelarghezza2160pnvenc"
                                                                                                                                                                )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.                         

                                                                                        echo !t20!  !width4k! 
                                                                                        echo !t21!  !height4k!    
                                                                                        echo.

                                                                                    ) 

goto inizioinserimentomanualecrop_NVEncPuliziaLeggeraDettagliMigliorati


:finecrop_NVEncPuliziaLeggeraDettagliMigliorati


rem//////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////





:InserimentoImpostazioniNVEnc_NVEncPuliziaLeggeraDettagliMigliorati

echo.
echo !t40!
echo.
echo 1) CQP 
echo 2) VBR 
echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto CodificaVBRNVEnc_NVEncPuliziaLeggeraDettagliMigliorati
if errorlevel 1 goto CodificaCQPNVEnc_NVEncPuliziaLeggeraDettagliMigliorati

:CodificaVBRNVEnc_NVEncPuliziaLeggeraDettagliMigliorati
set "TipoCodificaNVEnc=--vbr "
set /a "quantizzazioneNVEnc=0"
goto inserimentoValoriCQPVBRNVEnc_NVEncPuliziaLeggeraDettagliMigliorati

:CodificaCQPNVEnc_NVEncPuliziaLeggeraDettagliMigliorati
set "TipoCodificaNVEnc=--cqp "
set /a "quantizzazioneNVEnc=1"

:inserimentoValoriCQPVBRNVEnc_NVEncPuliziaLeggeraDettagliMigliorati

if !quantizzazioneNVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneNVEnc=!t44! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneNVEnc!") do set var=!valoreQuantizzazioneNVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                goto inserimentoValoriCQPVBRNVEnc_NVEncPuliziaLeggeraDettagliMigliorati
                                                ) 

                                set /a "valoreQuantizzazioneNVEnc=!valoreQuantizzazioneNVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneNVEnc!
                                if !valoreQuantizzazioneNVEnc! GEQ 10 if !valoreQuantizzazioneNVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneNVEnc!
                                                                                                                set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreQuantizzazioneNVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                                goto fineQuantizzazioneNVEnc_NVEncPuliziaLeggeraDettagliMigliorati
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRNVEnc_NVEncPuliziaLeggeraDettagliMigliorati
                                                                                                                        
                                )



if !quantizzazioneNVEnc!==0 (
                                echo.
                                set /p "valoreBitRateNVEnc=!t46! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateNVEnc!") do set var=!valoreBitRateNVEnc!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                goto inserimentoValoriCQPVBRNVEnc_NVEncPuliziaLeggeraDettagliMigliorati
                                                ) 
                                set /a "valoreBitRateNVEnc=!valoreBitRateNVEnc!"
                                @REM echo valoreBitRateNVEnc = !valoreBitRateNVEnc!
                                if !valoreBitRateNVEnc! GEQ 100 if !valoreBitRateNVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateNVEnc!
                                                                                                        set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreBitRateNVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                        goto fineQuantizzazioneNVEnc_NVEncPuliziaLeggeraDettagliMigliorati
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRNVEnc_NVEncPuliziaLeggeraDettagliMigliorati
                                                                                                        
                                )


:fineQuantizzazioneNVEnc_NVEncPuliziaLeggeraDettagliMigliorati

echo.
echo !t50!
echo.
echo 1) P1 !t51!
echo 2) P2 
echo 3) P3 
echo 4) P4 
echo 5) P5 
echo 6) P6 
echo 7) P7 !t52!
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto P7NVEnc_NVEncPuliziaLeggeraDettagliMigliorati
if errorlevel 6 goto P6NVEnc_NVEncPuliziaLeggeraDettagliMigliorati
if errorlevel 5 goto P5NVEnc_NVEncPuliziaLeggeraDettagliMigliorati
if errorlevel 4 goto P4NVEnc_NVEncPuliziaLeggeraDettagliMigliorati
if errorlevel 3 goto P3NVEnc_NVEncPuliziaLeggeraDettagliMigliorati
if errorlevel 2 goto P2NVEnc_NVEncPuliziaLeggeraDettagliMigliorati
if errorlevel 1 goto P1NVEnc_NVEncPuliziaLeggeraDettagliMigliorati


:P7NVEnc_NVEncPuliziaLeggeraDettagliMigliorati
set "SettaggioQualitaNVEnc=--preset P7"
set "QualitySetting=P7"
goto fineQualitCodificaNVEnc_NVEncPuliziaLeggeraDettagliMigliorati

:P6NVEnc_NVEncPuliziaLeggeraDettagliMigliorati
set "SettaggioQualitaNVEnc=--preset P6"
set "QualitySetting=P6"
goto fineQualitCodificaNVEnc_NVEncPuliziaLeggeraDettagliMigliorati

:P5NVEnc_NVEncPuliziaLeggeraDettagliMigliorati
set "SettaggioQualitaNVEnc=--preset P5"
set "QualitySetting=P5"
goto fineQualitCodificaNVEnc_NVEncPuliziaLeggeraDettagliMigliorati

:P4NVEnc_NVEncPuliziaLeggeraDettagliMigliorati
set "SettaggioQualitaNVEnc=--preset P4"
set "QualitySetting=P4"
goto fineQualitCodificaNVEnc_NVEncPuliziaLeggeraDettagliMigliorati

:P3NVEnc_NVEncPuliziaLeggeraDettagliMigliorati
set "SettaggioQualitaNVEnc=--preset P3"
set "QualitySetting=P3"
goto fineQualitCodificaNVEnc_NVEncPuliziaLeggeraDettagliMigliorati

:P2NVEnc_NVEncPuliziaLeggeraDettagliMigliorati
set "SettaggioQualitaNVEnc=--preset P2"
set "QualitySetting=P2"
goto fineQualitCodificaNVEnc_NVEncPuliziaLeggeraDettagliMigliorati

:P1NVEnc_NVEncPuliziaLeggeraDettagliMigliorati
set "SettaggioQualitaNVEnc=--preset P1"
set "QualitySetting=P1"
goto fineQualitCodificaNVEnc_NVEncPuliziaLeggeraDettagliMigliorati


:fineQualitCodificaNVEnc_NVEncPuliziaLeggeraDettagliMigliorati
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaNVEnc!


rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

:sceltadenoiserNVEnc_NVEncPuliziaLeggeraDettagliMigliorati
set conv3d1080p=
set pmd1080p=

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t55!"
    if errorlevel 2 goto conv3dChoosenNoNVEnc_NVEncPuliziaLeggeraDettagliMigliorati
    if errorlevel 1 goto conv3dChoosenYesNVEnc_NVEncPuliziaLeggeraDettagliMigliorati
)

echo.
CHOICE /N /C:SN /M "!t55!"

if errorlevel 2 goto conv3dChoosenNoNVEnc_NVEncPuliziaLeggeraDettagliMigliorati
if errorlevel 1 goto conv3dChoosenYesNVEnc_NVEncPuliziaLeggeraDettagliMigliorati

:conv3dChoosenNoNVEnc_NVEncPuliziaLeggeraDettagliMigliorati
set "conv3d1080p=N"
goto sceltaDeniserPMDNVEnc_NVEncPuliziaLeggeraDettagliMigliorati

:conv3dChoosenYesNVEnc_NVEncPuliziaLeggeraDettagliMigliorati
set "conv3d1080p=S"


:sceltaDeniserPMDNVEnc_NVEncPuliziaLeggeraDettagliMigliorati

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t56!"
    if errorlevel 2 goto PMDChoosenNoNVEnc_NVEncPuliziaLeggeraDettagliMigliorati
    if errorlevel 1 goto PPMDChoosenYesNVEnc_NVEncPuliziaLeggeraDettagliMigliorati
)

echo.
CHOICE /N /C:SN /M "!t56!"

if errorlevel 2 goto PMDChoosenNoNVEnc_NVEncPuliziaLeggeraDettagliMigliorati
if errorlevel 1 goto PPMDChoosenYesNVEnc_NVEncPuliziaLeggeraDettagliMigliorati

:PMDChoosenNoNVEnc_NVEncPuliziaLeggeraDettagliMigliorati
set "pmd1080p=N"
goto assegnazioneDenoisesNVEnc_NVEncPuliziaLeggeraDettagliMigliorati

:PPMDChoosenYesNVEnc_NVEncPuliziaLeggeraDettagliMigliorati
set "pmd1080p=S"


:assegnazioneDenoisesNVEnc_NVEncPuliziaLeggeraDettagliMigliorati
set /A nvdenv=0

if !conv3d1080p!==S if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00 --vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==S if !pmd1080p!==N ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )
if !conv3d1080p!==N if !pmd1080p!==N ( 
                                        set "nvdenoiser=" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: Nessun Denoiser 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        echo.
                                        )

@REM pause




echo.
echo !t76!
echo.


set file_senza_virgolette=%NomeFile2160ppuliziadettaggli:"=%
rem echo %file_senza_virgolette%

set file_senza_estensione=%file_senza_virgolette:.mkv=%
rem echo %file_senza_estensione%

set fileoutput2160p="%file_senza_estensione%_Denoiser_Leggero_Dettagli_Migliorati.mkv"
rem echo fileoutput2160p = %fileoutput2160p%



set fileoutput2160p_senza_virgolette=%fileoutput2160p:"=% 
rem echo %fileoutput2160p_senza_virgolette%

for %%i in ("%fileoutput2160p_senza_virgolette%") do (  
                                                        set "solo_nome_file=%%~ni"
                                                        rem echo Nome file: !solo_nome_file!

                                                        set "solo_estensione_file=%%~xi"
                                                        rem echo Estensione: !solo_estensione_file!
                                                    )

set fileoutput2160p_rinominato=!solo_nome_file!_rinominato!solo_estensione_file!

if exist "Temp_HDR10_Stream.txt" ( del Temp_HDR10_Stream.txt )
if exist "durata_film.txt" ( del durata_film.txt )
if exist "crop.txt" ( del crop.txt )
if exist "risultato_multiplo.txt" ( del risultato_multiplo.txt )
if exist "crop_multiplo.txt" ( del crop_multiplo.txt )
if exist "crop_finale.txt" ( del crop_finale.txt )

rem echo %fileoutput2160p_rinominato%


".\bin\nvenc\NVEncC64.exe" --avsw --device 0 -i %NomeFile%  !cropff!  --output-res !width4k!x!height4k! --video-metadata clear --metadata clear --chapter-copy -c hevc !tipoQuantizzazioneNVEnc! --bref-mode disabled !SettaggioQualitaNVEnc! --lookahead 32 --aq --aq-temporal --aq-strength 15 --profile main10 --level auto --tier high --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display copy --max-cll copy --output-depth 10 --multipass None --mv-precision Q-pel --avsync cfr --psnr --ssim     -m default_mode:infer_no_subs    !nvdenoiser!  --vpp-resize algo=lanczos4  --vpp-edgelevel strength=10.0,threshold=24.0,black=6.0  --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o %fileoutput2160p%

ren %fileoutput2160p% "%fileoutput2160p_rinominato%"



echo.
echo !t75!
echo.

goto fineinfovideo_NVEncPuliziaLeggeraDettagliMigliorati




:novideofile2160p_NVEncPuliziaLeggeraDettagliMigliorati
echo !t63!
echo.


:fineinfovideo_NVEncPuliziaLeggeraDettagliMigliorati


if exist ".\temp\Temp_HDR10_Stream.txt" ( del .\temp\Temp_HDR10_Stream.txt )
if exist ".\temp\durata_film.txt" ( del .\temp\durata_film.txt )
if exist ".\temp\crop.txt" ( del .\temp\crop.txt )
if exist ".\temp\risultato_multiplo.txt" ( del .\temp\risultato_multiplo.txt )
if exist ".\temp\crop_multiplo.txt" ( del .\temp\crop_multiplo.txt )
if exist ".\temp\crop_finale.txt" ( del .\temp\crop_finale.txt )
      
if exist ".\saved\settings.dat" (
                                for /f "tokens=1,2 delims=|" %%a in (.\saved\settings.dat) do (
                                                                                                    rem echo %%a
                                                                                                    rem echo %%b
                                                                                                    set /a "shst=%%b"
                                                                                                    rem echo !shst!
                                                                                                    rem pause
                                                                                                    if !shst!==1 (
                                                                                                                echo !t1000!
                                                                                                                echo.
                                                                                                                shutdown /s
                                                                                                                set /a "delay=10"
                                                                                                                timeout /t !delay!
                                                                                                                exit
                                                                                                                )
                                                                                                                            
                                                                                                    )                                                                                                  
                                                                                                )



set waitenter=
set /P waitenter=!t65!
Endlocal
goto menuiniziale







rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:NVEncUpScaling

cls
setLocal EnableExtensions EnableDelayedExpansion



for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoNVEncUpScaling
)

if %lingua%==inglese (
    goto caricalinguaingleseNVEncUpScaling
)



:caricalinguaingleseNVEncUpScaling
@REM set t1=Insert Hardware Video Encoding Info UpScaling and UpGrading from 1080p 8 bit or 10 bit SDR to 2160p 10 bit HDR and Saving to Disk

set t2=Drag Here the Video File 1080p 8 bit or 10 bit SDR to Convert to 2160p 10 bit HDR:  
@REM set t211=Video File 1080p 8 bit or 10 bit SDR to Convert to 2160p 10 bit HDR:  

set t3=File does not exist 
set t4=Info Video:  

set t5=The Inserted Video is 1080p 8bit SDR 
set t511=The Inserted Video is 1080p 10bit SDR 

set t6=The Inserted Video isn't 1080p 8bit or 10bit SDR 
set t7=Video Duration in seconds:
set t8=Video Duration in Minutes:
set t9=Interval between Frames for Crop Detection:
set t10= seconds
set t11=Black Bands Detection Started....
set t12=Crop Detection to Frame
set t13=to seconds
set t14=Done...
set t15=Original 2160p Video Width: 
set t16=Original 2160p Video Height:
set t17=Original Video 1080p Width Without Black Bars:
set t18=Original Video 1080p Height Without Black Bars:

set t171=Output Video 1080p Width Without Black Bars:
set t181=Outout Video 1080p Height Without Black Bars:

set t19=Adapting Video Resolution to Full 1080p Format...

set t191=Final 1080p Output Video Width:
set t192=Final 1080p Output Video Height:
set t20=Final 2160p Output Video Width:
set t21=Final 2160p Output Video Height:

set t22=Settings of Black Bands to Crop are Correct (Yes/No):
set t23=Manually Entering Black Band Values to Crop... 
set t24=Enter the Upper Black Band Value: 
set t25=Error Entering Upper Black Band Value... It's Not a Number. 
set t26=Enter the Lower Black Band Value: 
set t27=Error Entering Lower Black Band Value... It's Not a Number.
set t28=Enter the Left Black Band Value: 
set t29=Error Entering Left Black Band Value... It's Not a Number.
set t30=Enter the Right Black Band Value: 
set t31=Error Entering Right Black Band Value... It's Not a Number.
set t32=Upper Black Band:
set t33=Lower Black Band:
set t34=Left Black Band:
set t35=Right Black Band:
set t36=1080p Original Video Width without Black Bars:
set t37=1080p Original Video Height without Black Bars:

@REM set t361=1080p Video Width without Black Bars:
@REM set t371=1080p Video Height without Black Bars

set t38=Select Graphic Card you want to Encode with:
set t39=Choose (1/2):
set t40=Select Encoding Type:
set t41=Error Entering Quantization Value... Not a Number. 
set t42=Quantization Value Set to:
set t43=Encoding Settings:
set t44=Enter Quantization value Minimum 10 Maximum 28:
set t45=Quantization Value Out of  Limits  10 / 28  Re-enter^!
set t46=Enter BitRate Value kbs Minimum 100 Maximum 50000:
set t47=Error Entering BitRate Value... It's Not a Number. 
set t48=BitRate Value Set to:
set t49=BitRate Value Out of Limits  100 / 50000  Re-enter^!
set t50=Select Encoding Quality:
set t51=- Worst Quality
set t52=- Best Quality
set t53=Choose (1/2/3/4/5/6/7):
set t54=Quality Set to:
set t55=Apply Convolution3D denoiser Yes/No: 
set t56=Apply PMD denoiser Yes/No: 
set t57=Apply Detail Enhancement Yes/No:  
set t58=Enhancement Detail: Yes 
set t59=Enhancement Detail: No 
set t60=Info
set t61=Videos to Encode Saved!
set t62=Do You Want to Insert Another Video to Encode (Yes/No):
set t63=The dragged file is not a video!
set t64=Choose (1/2/3/4):
set t65=Press Enter to back to Main Menu.  

set t66=Video Width
set t67=Video Height
set t68=Video Codec
set t69=Details Video Codec
set t70=Video Format 
set t71=Configuration Settings to convert video from 8bit or 10bit SDR to 10bit HDR
set t72=Select Encoding UpGrader:
set t73=Settings UpGrader:
set t74=Choose (1/2/3):

set t75=Configuration UpScaling and UpGrading from 1080p 8 or 10 bit SDR to 2160p 10 bit HDR 
set t76=Select Operations to Perform:
set t77=1) First Pass Encode for Upscaling and a Second Pass Encode to Clean Up the Video and Enhance Details
set t78=2) Cleanup, Detail Enhancement and Upscaling in a Single Encode

set t79=UpScaling Started.... 
set t80=Denoiser and Detail Enhancement Application Started.... 
Set t81=Encoding Finished....  
set t1000=Now the PC will be turned off... 

goto avvio_NVEncUpScaling




:caricalinguaitalianoNVEncUpScaling
@REM set t1=Inserimento Info Codifica Hardware Video UpScaling e UpGrading da 1080p 8 bit o 10 bit SDR a 2160p 10 bit HDR e Salvataggio su Disco.

set t2=Trascina Qui il File Video 1080p 8 bit o [923m10 bit SDR da Convertire in 2160p 10 bit HDR:  
@REM set t211=File Video 1080p 8 bit o [923m10 bit SDR da Convertire in 2160p 10 bit HDR:  

set t3=File Inesistente 
set t4=Informazioni Video:  

set t5=Il Video inserito e' 1080p 8bit SDR 
set t511=Il Video inserito e' 1080p 10bit SDR 

set t6=Il Video inserito non e' 1080p 8bit o 10bit SDR 

set t7=Durata del Video in secondi:
set t8=Durata del video in Minuti:
set t9=Intervallo tra i Fotogrammi per il Rilevamento del crop:
set t10= secondi
set t11=Rilevamento Bande Nere Iniziato....
set t12=Rilevazione crop fotogramma
set t13=a secondi
set t14=Eseguita...
set t15=Larghezza Video 2160p Originale:
set t16=Altezza Video 2160p Originale:
set t17=Larghezza Video Originale 1080p  Senza Barre Nere:
set t18=Altezza Video Originale 1080p  Senza Barre Nere:

set t171=Larghezza Video 1080p  Senza Barre Nere:
set t181=Altezza Video 1080p  Senza Barre Nere:

set t19=Adattamento della Risoluzione del Video al Pieno Formato 1080p..

set t191=Larghezza Finale Video 1080p:
set t192=Altezza Finale Video 1080p:
set t20=Larghezza Finale Video 2160p:
set t21=Altezza Finale Video 2160p:

set t22=Le Impostazioni delle Bande Nere da Tagliare sono Corrette (Si/No):
set t23=Inserimento Manuale Valori Bande Nere da Tagliare.. 
set t24=Inserisci il Valore della Banda Nera Superiore: 
set t25=Errore nell'Inserimento del Valore della Banda Nera Superiore... Non e' un Numero. 
set t26=Inserisci il Valore della Banda Nera Inferiore: 
set t27=Errore nell'Inserimento del Valore della Banda Nera Inferiore... Non e' un Numero. 
set t28=Inserisci il Valore della Banda Nera Sinistra: 
set t29=Errore nell'Inserimento del Valore della Banda Nera Sinistra... Non e' un Numero. 
set t30=Inserisci il Valore della Banda Nera Destra: 
set t31=Errore nell'Inserimento del Valore della Banda Nera Destra... Non e' un Numero. 
set t32=Banda Nera Superiore:
set t33=Banda Nera Inferiore:
set t34=Banda Nera Sinistra:
set t35=Banda Nera Destra:
set t36=Larghezza Video Originale 1080p senza Bande Nere:
set t37=Altezza Video Originale 1080p senza Bande Nere:

@REM set t361=Larghezza Video 1080p senza Bande Nere:
@REM set t371=Altezza Video 1080p senza Bande Nere:

set t38=Selezionare Scheda Grafica con cui Eseguire la Codifica:
set t39=Scegli (1/2):
set t40=Selezionare tipo di Codifica:
set t41=Errore nell'Inserimento del Valore della Quantizzazione... Non e' un Numero. 
set t42=Valore Quantizzazzione Impostato a:
set t43=Parametri per codifica:

set t44=Inserire Valore Quantizzazione Minimo 10 Massimo 28:
set t45=Valore Quantizzazzione al di fuori dei  Limiti  10 / 28  Reinserire^!
set t46=Inserire Valore BitRate kbs Minimo 100 Massimo 50000:
set t47=Errore nell'Inserimento del Valore del BitRate... Non e' un Numero. 
set t48=Valore BitRate Impostato a:
set t49=Valore  BitRate al di fuori dei  Limiti  100 / 50000  Reinserire^!

set t50=Selezionare Qualita' Codifica:
set t51=- Peggiore Qualita'
set t52=- Migliore Qualita'
set t53=Scegli (1/2/3/4/5/6/7):
set t54=Qualita' Impostata su:
set t55=Applicare il denoiser Convolution3D Si/No: 
set t56=Applicare il denoiser PMD Si/No: 
set t57=Applicare il Miglioramento Dettagli Si/No:  
set t58=Miglioramento Dettagli: Si 
set t59=Miglioramento Dettagli: No 
set t60=Informazioni
set t61=Video da Codificare Salvate!
set t62=Vuoi Inserire un altro Video da Codificare (Si/No):
set t63=Il file trascinato non e' un video!
set t64=Scegli (1/2/3/4):
set t65=Premi Invio per tornare al Menu' Principale.  

set t66=Larghezza Video
set t67=Altezza Video
set t68=Codec Video
set t69=Codec Video Dettagli
set t70=Format Video 
set t71=Configurazione Parametri per convertire il video da 8bit o 10bit SDR a 10bit HDR
set t72=Selezionare UpGrader Codifica:
set t73=UpGrader Impostato:
set t74=Scegli (1/2/3):


set t75=Configurazione Operazione di UpScaling e UpGrading da 1080p 8 o 10 bit SDR a 2160p 10 bit HDR 
set t76=Selezionare Operazioni da Eseguire:
set t77=1) Fare Prima Codifica per UpScaling e Seconda Codifica per Ripulire il Video e Migliorare i Dettagli
set t78=2) Ripulire, Migliorare i Dettagli e Upscaling in un Unica Codifica 

set t79=UpScaling Iniziato.... 
set t80=Applicazione Denoiser e Miglioramento Dettagli Iniziato.... 
Set t81=Codifica Terminata....  
set t1000=Il PC ora verra' Spento... 

goto avvio_NVEncUpScaling

:avvio_NVEncUpScaling





set /a "numeromovie=1"


:altrivideodainserireNVEnc_NVEncUpScaling


set NomeFile1080p=
rem set MetadatiStreamHDR10=
set /P NomeFile1080p=!t2!
rem echo Hai digitato: %NomeFile%
rem pause

set "NomeFileSorgente=!NomeFile1080p:"=!"
@REM echo NomeFileSorgente = !NomeFileSorgente!
set "NomeFile=^"!NomeFileSorgente!^""
@REM echo NomeFile = !NomeFile!
@REM rem pause


if exist !NomeFile! ( goto infovideo_NVEncUpScaling ) else ( 
                                                        echo.
                                                        echo !t3!
                                                        echo.
                                                        goto fineinfovideo_NVEncUpScaling
                                                        )    



:infovideo_NVEncUpScaling
echo.
echo !t4!
echo.

.\bin\ffprobe -v error -hide_banner -select_streams v:0 -show_entries stream=width,height,codec_name,codec_long_name,pix_fmt,color_space,color_transfer,color_primaries -of default=noprint_wrappers=1 !NomeFile! > ".\temp\Temp_HDR10_Stream.txt"

set /A x1=1
set /A nohdrcs=0
set /A nohdrct=0
set /A nohdrcp=0
set /A wv=0
set /a hv=0
set /A fv=0

rem echo nohdr = %nohdr%

for /f "tokens=1,2 delims==" %%a in (.\temp\Temp_HDR10_Stream.txt) do (if !x1!==3 ( 
                                                                            echo !t66! "%%a" = %%b  
                                                                            set /A "widthvideo=%%b"
                                                                            rem echo widthvideo = !widthvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !widthvideo! LEQ 1920 if !widthvideo! GEQ 1000 (set /A "wv=1"
                                                                                                                                rem echo wv = !wv!
                                                                                                                                )
                                                                            )
                                                                if !x1!==4 ( 
                                                                            echo !t67! "%%a" = %%b  
                                                                            set /A "heightvideo=%%b"
                                                                            rem echo heightvideo = !heightvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !heightvideo! LEQ 1080 if !heightvideo! GEQ 700 (set /A "hv=1"
                                                                                                        rem echo hv = !hv!
                                                                                                        )
                                                                            )                                                           
                                                                if !x1!==6 ( 
                                                                            echo Color Space "%%a" = %%b  
                                                                            set "colorsp=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colorsp!==bt709 (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorsp!==unknown (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorsp!==reserved (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                    
                                                                            ) 
                                                                if !x1!==7 ( 
                                                                            echo Color Transfer "%%a" = %%b  
                                                                            set "colortr=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colortr!==bt709 (set /A "nohdrct=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colortr!==unknown (set /A "nohdrct=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colortr!==reserved (set /A "nohdrct=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                    
                                                                            ) 
                                                                if !x1!==8 ( 
                                                                            echo Color Primaries "%%a" = %%b  
                                                                            set "colorpr=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colorpr!==bt709 (set /A "nohdrcp=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorpr!==unknown (set /A "nohdrcp=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorpr!==reserved (set /A "nohdrcp=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                
                                                                            )    
                                                                if !x1!==1 ( 
                                                                            echo !t68! "%%a" = %%b  
                                                                            )       
                                                                if !x1!==2 ( 
                                                                            echo !t69! "%%a" = %%b  
                                                                            )   
                                                                if !x1!==5 ( 
                                                                            echo !t70! "%%a" = %%b  
                                                                            set "formatvideo=%%b"
                                                                            rem echo formatvideo = !formatvideo!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !formatvideo!==yuv420p (set /A "fv=1"
                                                                                                        rem echo fv = !fv!
                                                                                                        )
                                                                            if !formatvideo!==yuv420p10le (set /A "fv=1"
                                                                                                            rem echo fv = !fv!
                                                                                                            )
                                                                            )
                                                                set /A x1+=1                                                            
)
echo.

if !x1!==1 goto :novideofile1080p_NVEncUpScaling


if !nohdrcs!==1 if !nohdrct!==1 if !nohdrcp!==1 if !wv!==1 if !hv!==1 if !fv!==1 ( 
                                                                                   if !formatvideo!==yuv420p10le (
                                                                                                                    echo !t511! 
                                                                                                                    goto rilevazionebandenere_NVEncUpScaling
                                                                                                                    ) 
                                                                                   if !formatvideo!==yuv420p (                                 
                                                                                                                echo !t5!
                                                                                                                goto rilevazionebandenere_NVEncUpScaling
                                                                                                                )
                                                                                   ) 


echo !t6!
echo.
goto fineinfovideo_NVEncUpScaling


:rilevazionebandenere_NVEncUpScaling

.\bin\ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 !NomeFile!  > ".\temp\durata_film.txt"


set /a contatore=1
for /f "tokens=1 delims=." %%a in (.\temp\durata_film.txt) do  (
                                                        echo. 
                                                        echo !t7! %%a
                                                        set /a "secondi=%%a"
                                                        set /a "minuti=!secondi!/60"
                                                        echo !t8! !minuti!
                                                        set /a "intervallo_tagli=!secondi!/11"
                                                        echo !t9! !intervallo_tagli!!t10!
                                                        echo.
                                                        echo !t11!
                                                        echo.

                                                        

                                                        FOR /L %%a IN (1, 1, 10) DO (
                                                                                    rem echo %%a
                                                                                    set /a "secondi=%%a*!intervallo_tagli!"
                                                                                    rem echo !secondi!

                                                                                    if !formatvideo!==yuv420p (
                                                                                                                set /a "ca=16"
                                                                                                                rem echo !ca!
                                                                                                                    
                                                                                                                set /a "cb=2"
                                                                                                                rem echo !cb!
                                                                                                                    
                                                                                                                set /a "cc=0"
                                                                                                                rem echo !cc!

                                                                                                                set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                                                rem echo !cr!
                                                                                                                )

                                                                                    if !formatvideo!==yuv420p10le  ( 
                                                                                                                    set /a "ca=72"
                                                                                                                    rem echo !ca!
                                                                                                                    
                                                                                                                    set /a "cb=2"
                                                                                                                    rem echo !cb!
                                                                                                                    
                                                                                                                    set /a "cc=0"
                                                                                                                    rem echo !cc!

                                                                                                                    set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                                                    rem echo !cr!
                                                                                                                    )                                                                                                                

                                    
                                                                                
                                                                                
                                                                                    .\bin\ffmpeg -ss !secondi! -hide_banner -nostats -i !NomeFile! -vframes 10 -vf !cr! -f null - 2> ".\temp\crop.txt"
                                                                                    
                                                                                    findstr /r "Parsed_cropdetect_0" .\temp\crop.txt >> .\temp\risultato_multiplo.txt   
                                                                                    
                                                                                    echo !t12! %%a !t13! !secondi! !t14!
                                                                                    
                                                                                    )       
                                                                                       

                                                                                    for /f "tokens=1,2 delims==" %%a in (.\temp\risultato_multiplo.txt) do ( echo %%b >> .\temp\crop_multiplo.txt )
                                                                                    
                                                                                    set /a "maxfrequenza=0"

                                                                                    for /f "delims=" %%a in (.\temp\crop_multiplo.txt) do ( 
                                                                                                                                    set "cropconfront=%%a"
                                                                                                                                    rem echo "!cropconfront!"
                                                                                                                                    
                                                                                                                                    set /a "contatorfrequenza=0"
                                                                                                                                    for /f "delims=" %%b in (.\temp\crop_multiplo.txt) do (
                                                                                                                                                                                    set "dato_da_verificare=%%b"
                                                                                                                                                                                    rem echo cropconfront = "!cropconfront!"
                                                                                                                                                                                    rem echo dato_da_verificare = "!dato_da_verificare!"
                                                                                                                                                                                    if !cropconfront!==!dato_da_verificare! ( set /a "contatorfrequenza+=1")
                                                                                                                                                                                    )
                                                                                                                                    if !maxfrequenza! LSS !contatorfrequenza! ( 
                                                                                                                                                                                set /a "maxfrequenza=!!contatorfrequenza!!"
                                                                                                                                                                                set "cropd=!cropconfront!"
                                                                                                                                                                                )
                                                                                                                                    

                                                                                                                                    rem if !cropconfront! in (elenco_crop_frequenza.txt) ()
                                                                                                                                    rem echo !cropconfront!:!contatorfrequenza! >> elenco_crop_frequenza.txt

                                                                                                                                    )

                                                                                    rem echo crop piu' frequente = !cropd! con grequenza = !maxfrequenza!
                                                                                    echo !cropd! > .\temp\crop_finale.txt

                                                                                    for /f "tokens=1,2,3,4 delims=:" %%a in (.\temp\crop_finale.txt) do  ( 
                                                                                                                                                    rem set /a "mwidth=%%a"
                                                                                                                                                    rem echo mwidth = !mwidth!

                                                                                                                                                    rem set /a "mheight=%%b"
                                                                                                                                                    rem echo mheight = !mheight!

                                                                                                                                                    rem set /a "mx=%%c"
                                                                                                                                                    rem echo mx = !mx!

                                                                                                                                                    rem set /a "my=%%d"
                                                                                                                                                    rem echo my = !my!

                                                                                                                                                    if !contatore!==1 ( 
                                                                                                                                                                set /a "wmax=%%a" 
                                                                                                                                                                set /a "hmax=%%b"
                                                                                                                                                                set /a "xmin=%%c"
                                                                                                                                                                set /a "ymin=%%d"
                                                                                                                                                                set /a "mwidth=%%a"
                                                                                                                                                                set /a "mheight=%%b"
                                                                                                                                                                set /a "mx=%%c"
                                                                                                                                                                set /a "my=%%d"
                                                                                                                                                                set /a "contatore+=1"
                                                                                                                                                                )
                                                                                                                                                    
                                                                                                                                                    rem if %%b gtr !hmax! if %%c gtr !xmin! if %%d gtr !ymin! 

                                                                                                                                                    if %%a geq !wmax! if %%b geq !hmax! ( 
                                                                                                                                                                        set /a "wmax=%%a" 
                                                                                                                                                                        set /a "hmax=%%b"
                                                                                                                                                                        set /a "xmin=%%c"
                                                                                                                                                                        set /a "ymin=%%d"
                                                                                                                                                                        set /a "mwidth=%%a"
                                                                                                                                                                        set /a "mheight=%%b"
                                                                                                                                                                        set /a "mx=%%c"
                                                                                                                                                                        set /a "my=%%d"
                                                                                                                                                                        )
                                                                                                                                                    )
                                                                                    echo.
                                                                                    
                                                                                    set /a "mwidth=!mwidth!/2*2"
                                                                                    set /a "mheight=!mheight!/2*2"

                                                                                    set /a "csup=!my!/2*2"
                                                                                    rem echo csup = !csup!
                                                                                                                                    
                                                                                    set /a "csin=!mx!/2*2"
                                                                                    rem echo csin = !csin!

                                                                                    set /a "cinf=(!heightvideo!-!mheight!-!my!)/2*2"
                                                                                    rem echo movieheightreal = !movieheightreal!
                                                                                    rem echo cinf = !cinf!
                                                                                    set /a "cdes=(!widthvideo!-!mwidth!-!mx!)/2*2"
                                                                                    rem echo cdes = !cdes!

                                                                                    echo Crop Settings: --crop !csin!,!csup!,!cdes!,!cinf!    
                                                                                    set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
                                                                                    echo.  
                                                                                    
                                                                                    echo !t17!  !mwidth! 
                                                                                    echo !t18!  !mheight! 
                                                                                    echo.

                                                                                    set /a "larghezza1080pnvenc=1920"
                                                                                    set /a "altezza1080pnvenc=1080"
                                                                                    @REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
                                                                                    @REM echo altezza1080pnvenc = !altezza1080pnvenc!                                    

                                                                                    set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!mwidth!"
                                                                                    set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!mheight!"
                                                                                    @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
                                                                                    @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

                                                                                    if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                                                                                                        @REM echo dentro il 1o if
                                                                                                                                                                        set /a "width2k=!mwidth!"
                                                                                                                                                                        set /a "height2k=!mheight!"
                                                                                                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                                                                                                set /a "width2k=!mwidth!"
                                                                                                                                                                                                                                                                set /a "height2k=!mheight!"
                                                                                                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                                                                                                        set /a "width2k=!mwidth!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        set /a "height2k=!mheight!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "width2k=!mwidth!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                set /a "height2k=!mheight!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                                                                                                                set /a "width2k=!mwidth!"
                                                                                                                                                                                                                                                                set /a "height2k=!mheight!"
                                                                                                                                                                                                                                                                )
                                                                                                                                                                        
                                                                                                                                                                                if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                                                                                                        set /a "width2k=!mwidth!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        set /a "height2k=!mheight!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                                                                                                        )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.                         

                                                                                        echo !t191!  !width2k! 
                                                                                        echo !t192!  !height2k!    
                                                                                        echo.

                                                                                        set /a "width4k=width2k*2"
                                                                                        set /a "height4k=height2k*2"

                                                                                        echo !t20!  !width4k! 
                                                                                        echo !t21!  !height4k!    
                                                                                        echo.
                                                                                    )  
                                                        )                          
                                                  

:cropmanuale_NVEncUpScaling

set /a "csup=0"
set /a "cinf=0"
set /a "csin=0"
set /a "cdes=0"
set /a "bandasuperiore=0"
set /a "bandainferiore=0"
set /a "bandasinistra=0"
set /a "bandadestra=0"
set /a "differenzialelarghezza1080pnvenc=0"
set /a "differenzialealtezza1080pnvenc=0"
if exist ".\temp\Temp_HDR10_Stream.txt" ( del ".\temp\Temp_HDR10_Stream.txt" ) 
if exist ".\temp\durata_film.txt" ( del ".\temp\durata_film.txt" )
if exist ".\temp\crop.txt" ( del ".\temp\crop.txt" )
if exist ".\temp\risultato_multiplo.txt" ( del ".\temp\risultato_multiplo.txt" )
if exist ".\temp\crop_multiplo.txt" ( del ".\temp\crop_multiplo.txt" )
if exist ".\temp\crop_finale.txt" ( del ".\temp\crop_finale.txt" )

if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t22!"   
    if errorlevel 2 goto cropmanualeNVEnc_NVEncUpScaling
    if errorlevel 1 goto finecropNVEncUpScaling_NVEncUpScaling
)

CHOICE /N /C:SN /M "!t22!"   

if errorlevel 2 goto cropmanualeNVEnc_NVEncUpScaling
if errorlevel 1 goto finecropNVEncUpScaling_NVEncUpScaling


:cropmanualeNVEnc_NVEncUpScaling
echo.
echo !t23!
echo.

:banda_superiore_NVEncUpScaling
set /p "bandasuperiore=!t24!"
SET "var="&for /f "delims=0123456789" %%i in ("!bandasuperiore!") do set var=!bandasuperiore!
if defined var (
                echo.
                echo !t25!
                echo.
                goto banda_superiore_NVEncUpScaling
                ) else (
                        set /a "csup=!bandasuperiore!/2*2"
                        )

echo.
:banda_inferiore_NVEncUpScaling
set /p "bandainferiore=!t26!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandainferiore!") do set var=!bandainferiore!
if defined var (
                echo.
                echo !t27!
                echo.
                goto banda_inferiore_NVEncUpScaling
                ) else (
                        set /a "cinf=!bandainferiore!/2*2"
                        )


echo.
:banda_sinistra_NVEncUpScaling
set /p "bandasinistra=!t28!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandasinistra!") do set var=!bandasinistra!
if defined var (
                echo.
                echo !t29!
                echo.
                goto banda_sinistra_NVEncUpScaling
                ) else (
                        set /a "csin=!bandasinistra!/2*2"
                        )

                        
echo.
:banda_destra_NVEncUpScaling
set /p "bandadestra=!t30!"  
SET "var="&for /f "delims=0123456789" %%i in ("!bandadestra!") do set var=!bandadestra!
if defined var (
                echo.
                echo !t31!
                echo.
                goto banda_destra_NVEncUpScaling
                ) else (
                        set /a "cdes=!bandadestra!/2*2"
                        )


set /a "larghezza1080pnvenc=1920"
set /a "altezza1080pnvenc=1080"
@REM echo larghezza1080pnvenc = !larghezza1080pnvenc!                                    
@REM echo altezza1080pnvenc = !altezza1080pnvenc!                                    

set /a "mwidth=!widthvideo!/2*2"
set /a "mheight=!heightvideo!/2*2"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "mwidthc=!mwidth!-!csin!-!cdes!"
set /a "mheightc=!mheight!-!csup!-!cinf!"
@REM echo nuovo mwidht = !mwidth!
@REM echo nuovo mheight = !mheight!

set /a "differenzialelarghezza1080pnvenc=!larghezza1080pnvenc!-!mwidthc!"
set /a "differenzialealtezza1080pnvenc=!altezza1080pnvenc!-!mheightc!"
@REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!                                                                
@REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!

echo.
echo !t32!  !csup! 
echo !t33!  !cinf! 
echo !t34!  !csin! 
echo !t35!  !cdes! 
echo.


set "cropff=--crop !csin!,!csup!,!cdes!,!cinf!"
echo Crop Settings: !cropff!
echo.

echo !t36!  !mwidthc! 
echo !t37!  !mheightc! 
echo.



if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc! GTR 0 (
                                                                                        @REM echo dentro il 1o if
                                                                                        set /a "width2k=!mwidthc!"
                                                                                        set /a "height2k=!mheightc!"
                                                                                        )                        
                                                                                                                                                                                                                                                                                
                                                                                        if !differenzialelarghezza1080pnvenc! GTR 0 if !differenzialealtezza1080pnvenc!==0 (
                                                                                                                                                                                @REM echo dentro il 2o if
                                                                                                                                                                                set /a "width2k=!mwidthc!"
                                                                                                                                                                                set /a "height2k=!mheightc!"
                                                                                                                                                                                ) else if !differenzialelarghezza1080pnvenc! LSS !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                        @REM echo dentro il 2o if 2o else
                                                                                                                                                                                                                                                                        @REM echo differenzialelarghezza1080pnvenc = !differenzialelarghezza1080pnvenc!
                                                                                                                                                                                                                                                                        @REM echo differenzialealtezza1080pnvenc = !differenzialealtezza1080pnvenc!
                                                                                                                                                                                                                                                                        @REM echo mwidth = !mwidth!
                                                                                                                                                                                                                                                                        @REM echo mheight = !mheight!
                                                                                                                                                                                                                                                                        set /a "width2k=!mwidthc!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                        set /a "height2k=!mheightc!+!differenzialelarghezza1080pnvenc!"
                                                                                                                                                                                                                                                                        @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                        @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                        ) else if !differenzialelarghezza1080pnvenc! GTR !differenzialealtezza1080pnvenc! (
                                                                                                                                                                                                                                                                                                                                                                @REM echo dentro il 2o if 3o else
                                                                                                                                                                                                                                                                                                                                                                set /a "width2k=!mwidthc!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo width2k = !width2k!
                                                                                                                                                                                                                                                                                                                                                                set /a "height2k=!mheightc!+!differenzialealtezza1080pnvenc!"
                                                                                                                                                                                                                                                                                                                                                                @REM echo height2k = !height2k!
                                                                                                                                                                                                                                                                                                                                                                )
                                                                                        if !differenzialelarghezza1080pnvenc!==0 if !differenzialealtezza1080pnvenc!==0 (   
                                                                                                                                                                        @REM echo dentro 0 0
                                                                                                                                                                        set /a "width2k=!mwidthc!"
                                                                                                                                                                        set /a "height2k=!mheightc!"
                                                                                                                                                                        )
                                                                                                                                                                        
                                                                                        if !differenzialelarghezza1080pnvenc!==!differenzialealtezza1080pnvenc! (   
                                                                                                                                                                @REM echo dentro 0 0
                                                                                                                                                                set /a "width2k=!mwidthc!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                set /a "height2k=!mheightc!+differenzialelarghezza1080pnvenc"
                                                                                                                                                                )                                                                                        
                                                                                   

                                                                                        echo !t19!
                                                                                        echo.                         

                                                                                        echo !t191!  !width2k! 
                                                                                        echo !t192!  !height2k!    
                                                                                        echo.

                                                                                        set /a "width4k=width2k*2"
                                                                                        set /a "height4k=height2k*2"

                                                                                        echo !t20!  !width4k! 
                                                                                        echo !t21!  !height4k!    
                                                                                        echo.
                                                                                    ) 

goto cropmanuale_NVEncUpScaling

:finecropNVEncUpScaling_NVEncUpScaling


rem//////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////


:InserimentoImpostazioniNVEnc_NVEncUpScaling


echo.
echo !t40!
echo.
echo 1) CQP 
echo 2) VBR 
echo.
CHOICE /N /C:12 /M "!t39!"

if errorlevel 2 goto CodificaVBRNVEnc_NVEncUpScaling
if errorlevel 1 goto CodificaCQPNVEnc_NVEncUpScaling

:CodificaVBRNVEnc_NVEncUpScaling
set "TipoCodificaNVEnc=--vbr "
set /a "quantizzazioneNVEnc=0"
goto inserimentoValoriCQPVBRNVEnc_NVEncUpScaling

:CodificaCQPNVEnc_NVEncUpScaling
set "TipoCodificaNVEnc=--cqp "
set /a "quantizzazioneNVEnc=1"

:inserimentoValoriCQPVBRNVEnc_NVEncUpScaling

if !quantizzazioneNVEnc!==1 (
                                echo.
                                set /p "valoreQuantizzazioneNVEnc=!t44! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreQuantizzazioneNVEnc!") do set var=!valoreQuantizzazioneNVEnc!
                                if defined var (
                                                echo.
                                                echo !t41!
                                                goto inserimentoValoriCQPVBRNVEnc_NVEncUpScaling
                                                ) 

                                set /a "valoreQuantizzazioneNVEnc=!valoreQuantizzazioneNVEnc!"
                                @REM echo valoreQuantizzazione = !valoreQuantizzazioneNVEnc!
                                if !valoreQuantizzazioneNVEnc! GEQ 10 if !valoreQuantizzazioneNVEnc! LEQ 28 (
                                                                                                                echo.
                                                                                                                echo !t42! !valoreQuantizzazioneNVEnc!
                                                                                                                set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreQuantizzazioneNVEnc!"
                                                                                                                echo.
                                                                                                                echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                                goto fineQuantizzazioneNVEnc_NVEncUpScaling
                                                                                                                ) 
                                echo.
                                echo !t45!
                                goto inserimentoValoriCQPVBRNVEnc_NVEncUpScaling
                                                                                                                        
                                )



if !quantizzazioneNVEnc!==0 (
                                echo.
                                set /p "valoreBitRateNVEnc=!t46! " 
                                SET "var="&for /f "delims=0123456789" %%i in ("!valoreBitRateNVEnc!") do set var=!valoreBitRateNVEnc!
                                if defined var (
                                                echo.
                                                echo !t47!
                                                goto inserimentoValoriCQPVBRNVEnc_NVEncUpScaling
                                                ) 
                                set /a "valoreBitRateNVEnc=!valoreBitRateNVEnc!"
                                @REM echo valoreBitRateNVEnc = !valoreBitRateNVEnc!
                                if !valoreBitRateNVEnc! GEQ 100 if !valoreBitRateNVEnc! LEQ 50000 (
                                                                                                        echo.
                                                                                                        echo !t48! !valoreBitRateNVEnc!
                                                                                                        set "tipoQuantizzazioneNVEnc=!TipoCodificaNVEnc!!valoreBitRateNVEnc!"
                                                                                                        echo.
                                                                                                        echo !t43! !tipoQuantizzazioneNVEnc!
                                                                                                        goto fineQuantizzazioneNVEnc_NVEncUpScaling
                                                                                                        ) 
                                echo.
                                echo !t49!
                                goto inserimentoValoriCQPVBRNVEnc_NVEncUpScaling
                                                                                                              
                                )


:fineQuantizzazioneNVEnc_NVEncUpScaling


echo.
echo !t50!
echo.
echo 1) P1 !t51!
echo 2) P2 
echo 3) P3 
echo 4) P4 
echo 5) P5 
echo 6) P6 
echo 7) P7 !t52!
echo.
CHOICE /N /C:1234567 /M "!t53!"

if errorlevel 7 goto P7NVEnc_NVEncUpScaling
if errorlevel 6 goto P6NVEnc_NVEncUpScaling
if errorlevel 5 goto P5NVEnc_NVEncUpScaling
if errorlevel 4 goto P4NVEnc_NVEncUpScaling
if errorlevel 3 goto P3NVEnc_NVEncUpScaling
if errorlevel 2 goto P2NVEnc_NVEncUpScaling
if errorlevel 1 goto P1NVEnc_NVEncUpScaling


:P7NVEnc_NVEncUpScaling
set "SettaggioQualitaNVEnc=--preset P7"
set "QualitySetting=P7"
goto fineQualitCodificaNVEnc_NVEncUpScaling

:P6NVEnc_NVEncUpScaling
set "SettaggioQualitaNVEnc=--preset P6"
set "QualitySetting=P6"
goto fineQualitCodificaNVEnc_NVEncUpScaling

:P5NVEnc_NVEncUpScaling
set "SettaggioQualitaNVEnc=--preset P5"
set "QualitySetting=P5"
goto fineQualitCodificaNVEnc_NVEncUpScaling

:P4NVEnc_NVEncUpScaling
set "SettaggioQualitaNVEnc=--preset P4"
set "QualitySetting=P4"
goto fineQualitCodificaNVEnc_NVEncUpScaling

:P3NVEnc_NVEncUpScaling
set "SettaggioQualitaNVEnc=--preset P3"
set "QualitySetting=P3"
goto fineQualitCodificaNVEnc_NVEncUpScaling

:P2NVEnc_NVEncUpScaling
set "SettaggioQualitaNVEnc=--preset P2"
set "QualitySetting=P2"
goto fineQualitCodificaNVEnc_NVEncUpScaling

:P1NVEnc_NVEncUpScaling
set "SettaggioQualitaNVEnc=--preset P1"
set "QualitySetting=P1"
goto fineQualitCodificaNVEnc_NVEncUpScaling


:fineQualitCodificaNVEnc_NVEncUpScaling
echo.
echo !t54! !QualitySetting!
echo.
echo !t43! !SettaggioQualitaNVEnc!


echo.
echo !t71!
echo !t72!
echo.
echo 1) NVEnc Color Correction 
echo 2) LibPlacebo Color Correction 
echo 3) NVidia Color Correction 

echo.
CHOICE /N /C:123 /M "!t74!"

if errorlevel 3 goto NVidiaColorCorrection_NVEncUpScaling
if errorlevel 2 goto LibPlaceboColorCorrectionNVEnc_NVEncUpScaling
if errorlevel 1 goto NVEncColorCorrection_NVEncUpScaling

:NVEncColorCorrection_NVEncUpScaling
set "NVEncColorCorrectionSystem=--vpp-colorspace colorprim=bt709:bt2020,transfer=bt709:smpte2084,matrix=bt709:bt2020nc --vpp-tweak brightness=0.1,contrast=1.2,saturation=1.1"
set "NVEncUpgrader=NVEnc Color Correction"
goto NVEncFineSelezioneUpGrader_NVEncUpScaling

:LibPlaceboColorCorrectionNVEnc_NVEncUpScaling
set "NVEncColorCorrectionSystem=--vpp-libplacebo-tonemapping src_csp=sdr,dst_csp=hdr10"
set "NVEncUpgrader=LibPlacebo Color Correction"
goto NVEncFineSelezioneUpGrader_NVEncUpScaling

:NVidiaColorCorrection_NVEncUpScaling
set "NVEncColorCorrectionSystem=--vpp-ngx-truehdr"
set "NVEncUpgrader=NVidia Color Correction"

:NVEncFineSelezioneUpGrader_NVEncUpScaling
echo.
echo !t73! !NVEncUpgrader!
echo.
echo !t43! !NVEncColorCorrectionSystem!



:sceltadenoiser
set conv3d1080p=
set pmd1080p=
set /a unicopassaggio=0

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t55!"
    if errorlevel 2 goto conv3dChoosenNoNVEnc_NVEncUpScaling
    if errorlevel 1 goto conv3dChoosenYesNVEnc_NVEncUpScaling
)

echo.
CHOICE /N /C:SN /M "!t55!"

if errorlevel 2 goto conv3dChoosenNoNVEnc_NVEncUpScaling
if errorlevel 1 goto conv3dChoosenYesNVEnc_NVEncUpScaling

:conv3dChoosenNoNVEnc_NVEncUpScaling
set "conv3d1080p=N"
goto sceltaDeniserPMDNVEnc_NVEncUpScaling

:conv3dChoosenYesNVEnc_NVEncUpScaling
set "conv3d1080p=S"



:sceltaDeniserPMDNVEnc_NVEncUpScaling

if %lingua%==inglese (
    echo.    
    CHOICE /N /C:YN /M "!t56!"
    if errorlevel 2 goto PMDChoosenNoNVEnc_NVEncUpScaling
    if errorlevel 1 goto PMDChoosenYesNVEnc_NVEncUpScaling
)

echo.
CHOICE /N /C:SN /M "!t56!"

if errorlevel 2 goto PMDChoosenNoNVEnc_NVEncUpScaling
if errorlevel 1 goto PMDChoosenYesNVEnc_NVEncUpScaling

:PMDChoosenNoNVEnc_NVEncUpScaling
set "pmd1080p=N"
goto assegnazioneDenoisesNVEnc_NVEncUpScaling

:PMDChoosenYesNVEnc_NVEncUpScaling
set "pmd1080p=S"


:assegnazioneDenoisesNVEnc_NVEncUpScaling
set /A nvdenv=0

if !conv3d1080p!==S if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00 --vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )
if !conv3d1080p!==S if !pmd1080p!==N ( 
                                        set "nvdenoiser=--vpp-convolution3d matrix=simple,ythresh=1.50,cthresh=2.00,t_ythresh=1.50,t_cthresh=2.00" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )
if !conv3d1080p!==N if !pmd1080p!==S ( 
                                        set "nvdenoiser=--vpp-pmd apply_count=10,strength=50,threshold=50" 
                                        set "nvdenv=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: !nvdenoiser! 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )
if !conv3d1080p!==N if !pmd1080p!==N ( 
                                        set "nvdenoiser=" 
                                        set "nvdenv=1"
                                        set "unicopassaggio=1"
                                        echo.
                                        echo NVEnc Denoiser Settings: Nessun Denoiser 
                                        rem echo nvdenoiser = !nvdenoiser!
                                        )

@REM pause


echo.
if %lingua%==inglese (
    CHOICE /N /C:YN /M "!t57!"
    if errorlevel 2 goto ApplicaMiglioramentoDettagliNVEncNo_NVEncUpScaling
    if errorlevel 1 goto ApplicaMiglioramentoDettagliNVEncSi_NVEncUpScaling
)
CHOICE /N /C:SN /M "!t57!"

if errorlevel 2 goto ApplicaMiglioramentoDettagliNVEncNo_NVEncUpScaling
if errorlevel 1 goto ApplicaMiglioramentoDettagliNVEncSi_NVEncUpScaling

:ApplicaMiglioramentoDettagliNVEncNo_NVEncUpScaling
set "miglioramento1080p=N"
goto fineSceltaMigliaramentiNVEnc_NVEncUpScaling

:ApplicaMiglioramentoDettagliNVEncSi_NVEncUpScaling
set "miglioramento1080p=S"

:fineSceltaMigliaramentiNVEnc_NVEncUpScaling
if !miglioramento1080p!==S ( 
                                set "edgeleveling=--vpp-edgelevel strength=10.0,threshold=24.0,black=6,white=0" 
                                echo.
                                echo NVEnc !t58!
                                echo.
                                )
if !miglioramento1080p!==N ( 
                                set "edgeleveling=" 
                                echo.
                                echo NVEnc !t59!
                                echo.
                                )


@REM pause


if NOT DEFINED nvdenoiser if NOT DEFINED edgeleveling  (
                                                        set "unicopassaggio=1"
                                                        goto fineConfigurazioneOperazioniUpScalingNVEnc_NVEncUpScaling
                                                        )


echo.
echo !t75!
echo !t76!
echo.
echo !t77!
echo !t78!

echo.
CHOICE /N /C:123 /M "!t39!"

if errorlevel 2 goto OperazioniUpScalingSingolaCodificaNvEnc_NVEncUpScaling
if errorlevel 1 goto OperazioniUpScalingDoppiaCodificaNvEnc_NVEncUpScaling

:OperazioniUpScalingSingolaCodificaNvEnc_NVEncUpScaling
set "unicopassaggio=1"
goto fineConfigurazioneOperazioniUpScalingNVEnc_NVEncUpScaling

:OperazioniUpScalingDoppiaCodificaNvEnc_NVEncUpScaling
set "unicopassaggio=0"

:fineConfigurazioneOperazioniUpScalingNVEnc_NVEncUpScaling







echo.
echo !t79!
echo.


set file_senza_virgolette=%NomeFile:"=%
rem echo %file_senza_virgolette%

set file_senza_estensione=%file_senza_virgolette:.mkv=%
rem echo %file_senza_estensione%

set fileoutput2160p="%file_senza_estensione%_UpScaled.mkv"

@REM echo miglioramento1080p = !miglioramento1080p!
@REM echo.
@REM pause 


if !miglioramento1080p!==S (
                                @REM echo dento if S
                                set fileoutput2160pdetailed2="!file_senza_estensione!_UpScaled 2160p.mkv"
                                @REM echo fileoutput2160pdetailed2 = !fileoutput2160pdetailed2!
                                set fileoutput2160pdetailed="!file_senza_estensione!_UpScaled 2160p_pul_leggera.mkv"
                                @REM echo fileoutput2160pdetailed = !fileoutput2160pdetailed!
                                )

if !miglioramento1080p!==N  (
                                @REM echo dento if N
                                set fileoutput2160pdetailed2="!file_senza_estensione!_UpScaled 2160p.mkv"
                                @REM echo fileoutput2160pdetailed2 = !fileoutput2160pdetailed2!
                                set fileoutput2160pdetailed="!file_senza_estensione!_UpScaled 2160p_pul_leggera.mkv"
                                @REM echo fileoutput2160pdetailed = !fileoutput2160pdetailed!
                                )


set fileoutput2160pdetailed_senza_virgolette=!fileoutput2160pdetailed:"=! 
rem echo !fileoutput2160pdetailed_senza_virgolette!


for %%i in ("!fileoutput2160pdetailed_senza_virgolette!") do (  
                                                                set "solo_nome_file=%%~ni"
                                                                rem echo Nome file: !solo_nome_file!

                                                                set "solo_estensione_file=%%~xi"
                                                                rem echo Estensione: !solo_estensione_file!
                                                                )

set fileoutput2160pdetailed_rinominato=!solo_nome_file!_rinominato!solo_estensione_file!

rem echo %fileoutput2160pdetailed_rinominato%



set fileoutput2160pdetailed2_senza_virgolette=!fileoutput2160pdetailed2:"=! 
rem echo %fileoutput2160pdetailed2_senza_virgolette%

for %%i in ("!fileoutput2160pdetailed2_senza_virgolette!") do (  
                                                                set "solo_nome_file=%%~ni"
                                                                rem echo Nome file: !solo_nome_file!

                                                                set "solo_estensione_file=%%~xi"
                                                                rem echo Estensione: !solo_estensione_file!
                                                                )

set fileoutput2160pdetailed2_rinominato=!solo_nome_file!_rinominato!solo_estensione_file!

rem echo %fileoutput2160pdetailed2_rinominato%

if exist "Temp_HDR10_Stream.txt" ( del Temp_HDR10_Stream.txt )
if exist "durata_film.txt" ( del durata_film.txt )
if exist "crop.txt" ( del crop.txt )
if exist "risultato_multiplo.txt" ( del risultato_multiplo.txt )
if exist "crop_multiplo.txt" ( del crop_multiplo.txt )
if exist "crop_finale.txt" ( del crop_finale.txt )

if !unicopassaggio!==1 ( goto codificaunicopassaggio_NVEncUpScaling )

rem echo fileoutput2160p = %fileoutput2160p%
rem echo fileoutput2160pdetailed = %fileoutput2160pdetailed%

".\bin\nvenc\NVEncC64.exe" --avsw --device 0 -i !NomeFile!  --output-res !width4k!x!height4k!  !nvcrop! --video-metadata clear --metadata clear --chapter-copy -c hevc !tipoQuantizzazioneNVEnc! --bref-mode disabled !SettaggioQualitaNVEnc! --lookahead 32 --aq --aq-temporal --aq-strength 15  --profile main10 --level auto --tier high --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display "G(13250,34500)B(7500,3000)R(34000,16000)WP(15635,16450)L(10000000,1)" --max-cll "1000,400"  --output-depth 10 --multipass None --mv-precision Q-pel --avsync cfr --psnr --ssim     -m default_mode:infer_no_subs    !NVEncColorCorrectionSystem!   --vpp-resize algo=lanczos4  --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o !fileoutput2160p!

echo.
echo !t80!
echo.

".\bin\nvenc\NVEncC64.exe" --avhw --device 0 -i !fileoutput2160p!  --crop 0,0,0,0  --video-metadata clear --metadata clear --chapter-copy -c hevc !tipoQuantizzazioneNVEnc! --bref-mode disabled !SettaggioQualitaNVEnc! --tier high --lookahead 32 --aq --aq-temporal --aq-strength 15 --level auto --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display copy --max-cll copy --output-depth 10 --multipass None --mv-precision Q-pel --avsync cfr     -m default_mode:infer_no_subs  !nvdenoiser! !edgeleveling!  --psnr --ssim --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off  --log-level info --log ".\codifica_hardware_out_log.txt" -o !fileoutput2160pdetailed!

ren !fileoutput2160pdetailed! "!fileoutput2160pdetailed_rinominato!"

if !unicopassaggio!==0 ( goto fineupscalingdoppiopassaggio )

:codificaunicopassaggio_NVEncUpScaling

".\bin\nvenc\NVEncC64.exe" --avsw --device 0 -i !NomeFile!  --output-res !width4k!x!height4k!  !nvcrop! --video-metadata clear --metadata clear --chapter-copy -c hevc !tipoQuantizzazioneNVEnc! --bref-mode disabled !SettaggioQualitaNVEnc! --lookahead 32 --aq --aq-temporal --aq-strength 15  --profile main10 --level auto --tier high --chromaloc auto --colorrange auto --colormatrix bt2020nc --transfer smpte2084 --colorprim bt2020 --master-display "G(13250,34500)B(7500,3000)R(34000,16000)WP(15635,16450)L(10000000,1)" --max-cll "1000,400"  --output-depth 10 --multipass None --mv-precision Q-pel --avsync cfr   !nvdenoiser! !edgeleveling! --psnr --ssim     -m default_mode:infer_no_subs    !NVEncColorCorrectionSystem!  --vpp-resize algo=lanczos4  !edgeleveling!  --thread-affinity process=All --thread-priority process=abovenormal  --thread-throttling main=off,input=off,encoder=off,output=off   --log ".\codifica_hardware_out_log.txt" --log-level info -o !fileoutput2160pdetailed2!

ren !fileoutput2160pdetailed2! "!fileoutput2160pdetailed2_rinominato!"

:fineupscalingdoppiopassaggio

echo.
echo !t81!
echo.

goto fineinfovideo_NVEncUpScaling




rem//////////////////////////////////////////////////////////////////////////////////////////////
rem/////////////////////////////////////////////////////////////////////////////////////////////





:novideofile1080p_NVEncUpScaling
echo !t63!
echo.



:fineinfovideo_NVEncUpScaling

if exist ".\saved\settings.dat" (
                                for /f "tokens=1,2 delims=|" %%a in (.\saved\settings.dat) do (
                                                                                                    rem echo %%a
                                                                                                    rem echo %%b
                                                                                                    set /a "shst=%%b"
                                                                                                    rem echo !shst!
                                                                                                    rem pause
                                                                                                    if !shst!==1 (
                                                                                                                echo !t1000!
                                                                                                                echo.
                                                                                                                shutdown /s
                                                                                                                set /a "delay=10"
                                                                                                                timeout /t !delay!
                                                                                                                exit
                                                                                                                )
                                                                                                                            
                                                                                                    )                                                                                                  
                                                                                                )

if exist ".\temp\Temp_HDR10_Stream.txt" ( del .\temp\Temp_HDR10_Stream.txt )
if exist ".\temp\durata_film.txt" ( del .\temp\durata_film.txt )
if exist ".\temp\crop.txt" ( del .\temp\crop.txt )
if exist ".\temp\risultato_multiplo.txt" ( del .\temp\risultato_multiplo.txt )
if exist ".\temp\crop_multiplo.txt" ( del .\temp\crop_multiplo.txt )
if exist ".\temp\crop_finale.txt" ( del .\temp\crop_finale.txt )
      




set waitenter=
set /P waitenter=!t65!
Endlocal
goto menuiniziale





rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:conversioneaudio

cls
setLocal EnableExtensions EnableDelayedExpansion

for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoconversioneaudio
)

if %lingua%==inglese (
    goto caricalinguaingleseconversioneaudio
)



:caricalinguaingleseconversioneaudio
set t1=Drag the Audio File (.thd/.flac/.wav/.dts/.eac3/.ac3 ext/.aac) Here to Convert in AC-3 or AAC Format:  
set t2=The File does not Exist 
set t3=Info Audio File:
set t4=Audio Format
set t5=Details Audio Codec
set t6=Channels Number
set t7=Entered File is not an Audio Track in Format .thd/.flac/.wav/.dts/.eac3/.ac3 ext.
set t8=Channels Set in Output File
set t9=BitRate Set in Output File
set t10=Conversion Started...
set t11=Conversion Finished...
set t12=Press Enter to Back to Main Menu:  
set t13=Select Output Audio Format: 
set t14=Select Format (1/2):
set t15=Output Audio Format:
set t16=Select Output Channels Number: 
set t17=Same as Input File 
set t18=Select (1/2/3): 
set t19=Output Channels Number:
set t20=DTS 5.1 Channel Settings Correction System 
set t21=Input Audio File is DTS 5.1 what is Real Channels Settings 
set t22=You can see it just with Audacity 
set t23=Audio Channles Correction System Set 
set t24=Audio Channels Settings Same as Format AC3 
goto finecaricamentolinguaconversioneaudio



:caricalinguaitalianoconversioneaudio
set t1=Trascina Qui il File Audio (.thd/.flac/.wav/.dts/.eac3/.ac3 ext/.aac) che vuoi Convertire in formato AC-3 o AAC:  
set t2=File Inesistente 
set t3=Informazioni File Audio:
set t4=Formato Audio
set t5=Codec Audio Dettagli
set t6=Numero Canali
set t7=Il file inserito non e' una traccia audio .thd/.flac/.wav/.dts/.eac3/.ac3 ext.
set t8=Canali Impostati nel File di Output
set t9=BitRate Impostato nel File di Output
set t10=Conversione Iniziata...
set t11=Conversione Terminata.
set t12=Premi Invio per tornare al Menu' Principale:  
set t13=Selezionare il Formato Audio di Output: 
set t14=Selezionare Formato (1/2):
set t15=Formato Audio di Output:
set t16=Selezionare il Numero di Canali di Output: 
set t17=Uguale al File di Input  
set t18=Selezionare (1/2/3): 
set t19=Numero di Canali di Output:
set t20=Sistema di Correzione Impostazione Canali DTS 5.1 
set t21=Il File Audio di Input e' DTS 5.1 qual e' la Disposizione Reale dei Canali 
set t22=Puoi vederlo solo con Audacity 
set t23=Correzione Impostazioni Canali Audio Impostata 
set t24=Impostazioni Canali Audio Uguale al Formato AC3 
goto finecaricamentolinguaconversioneaudio


:finecaricamentolinguaconversioneaudio




set NomeFileAudio=
set /a line_count=0

set /P NomeFileAudio=!t1!


if exist %NomeFileAudio% ( goto selezionareNumeroCanaliFormato ) else ( 
                                                                        echo.
                                                                        echo !t2!
                                                                        echo.
                                                                        goto fineconvaudio
                                                                        )    

:selezionareNumeroCanaliFormato
echo.
echo !t13!
echo.
echo 1) AC-3 
echo 2) AAC 
echo.
CHOICE /N /C:12 /M "!t14! "

if errorlevel 2 goto selezionatoFormatoAAC
if errorlevel 1 goto selezionatoFormatoAC3

:selezionatoFormatoAAC
set "outputFormat=aac"
set "audioOutputFortmatType=.AAC"
echo.
echo !t15! .AAC
goto selezioneNumeroCanaliOutput

:selezionatoFormatoAC3
set "outputFormat=ac3"
set "audioOutputFortmatType=.AC3"
echo.
echo !t15! .AC3
goto selezioneNumeroCanaliOutput


:selezioneNumeroCanaliOutput
echo.
echo !t16!
echo.
echo 1) !t17!
echo 2) 5.1 
echo 3) 2.0 
echo.
CHOICE /N /C:123 /M "!t18! "

if errorlevel 3 goto selezionatoNumeroCanaliDue
if errorlevel 2 goto selezionatoNumeroCanaliSei
if errorlevel 1 goto selezionatoNumeroCanaliUguali

:selezionatoNumeroCanaliUguali
set /a "outputChannelNumber=0"
echo.
echo !t19! !t17!
goto iniziocodificaaudio

:selezionatoNumeroCanaliSei
set /a "outputChannelNumber=6"
echo.
echo !t19! 6
goto iniziocodificaaudio

:selezionatoNumeroCanaliDue
set /a "outputChannelNumber=2"
echo.
echo !t19! 2
goto iniziocodificaaudio


:iniziocodificaaudio
rem elimino virgolette
set NomeFileAudiosv=%NomeFileAudio:"=%
rem copio nel file
echo %NomeFileAudiosv% > "nomefileaudiot.txt"

findstr /n /c:".aac" nomefileaudiot.txt > aacesiste.txt
findstr /n /c:".ac3" nomefileaudiot.txt > ac3esiste.txt
findstr /n /c:".dts" nomefileaudiot.txt > dtsesiste.txt
findstr /n /c:".eac3" nomefileaudiot.txt > eac3esiste.txt
findstr /n /c:".wav" nomefileaudiot.txt > wavesiste.txt
findstr /n /c:".thd" nomefileaudiot.txt > thdesiste.txt
findstr /n /c:".flac" nomefileaudiot.txt > flacesiste.txt

set "temp_variable="
set "tipofilesorgente="


for /f "tokens=*" %%a in (aacesiste.txt) do (
    set "temp_variable=%%a"
    rem echo temp variabile = !temp_variable!
    if !temp_variable! neq "" (
                            set "tipofilesorgente=ac3"
                            rem echo Il file sorgente e' ac3
                            rem echo.
                            set "NomeFileAudiosvse=%NomeFileAudiosv:.aac=%"
                            rem echo Solo nome file Sorgente = !NomeFileAudiosvse!
                            rem echo.
                            goto fineverifiche
                            )
)

for /f "tokens=*" %%a in (ac3esiste.txt) do (
    set "temp_variable=%%a"
    rem echo temp variabile = !temp_variable!
    if !temp_variable! neq "" (
                            set "tipofilesorgente=ac3"
                            rem echo Il file sorgente e' ac3
                            rem echo.
                            set "NomeFileAudiosvse=%NomeFileAudiosv:.ac3=%"
                            rem echo Solo nome file Sorgente = !NomeFileAudiosvse!
                            rem echo.
                            goto fineverifiche
                            )
)



for /f "tokens=*" %%a in (dtsesiste.txt) do (
    set "temp_variable=%%a"
    rem echo temp variabile = !temp_variable!
    if !temp_variable! neq "" (
                            set "tipofilesorgente=dts"
                            rem echo Il file sorgente e' dts
                            rem echo.
                            set "NomeFileAudiosvse=%NomeFileAudiosv:.dts=%"
                            rem echo Solo nome file Sorgente = !NomeFileAudiosvse!
                            rem echo.
                            goto fineverifiche
                            )
)


for /f "tokens=*" %%a in (eac3esiste.txt) do (
    set "temp_variable=%%a"
    rem echo temp variabile = !temp_variable!
    if !temp_variable! neq "" (
                            set "tipofilesorgente=eac3"
                            rem echo Il file sorgente e' eac3
                            rem echo.
                            set "NomeFileAudiosvse=%NomeFileAudiosv:.eac3=%"
                            rem echo Solo nome file Sorgente = !NomeFileAudiosvse!
                            rem echo.
                            goto fineverifiche
                            )

)

for /f "tokens=*" %%a in (wavesiste.txt) do (
    set "temp_variable=%%a"
    rem echo temp variabile = !temp_variable!
    if !temp_variable! neq "" (
                            set "tipofilesorgente=wav"
                            rem echo Il file sorgente e' wav
                            rem echo.
                            set "NomeFileAudiosvse=%NomeFileAudiosv:.wav=%"
                            rem echo Solo nome file Sorgente = !NomeFileAudiosvse!
                            rem echo.
                            goto fineverifiche
                            )

)

for /f "tokens=*" %%a in (thdesiste.txt) do (
    set "temp_variable=%%a"
    rem echo temp variabile = !temp_variable!
    if !temp_variable! neq "" (
                            set "tipofilesorgente=thd"
                            rem echo Il file sorgente e' ac3
                            rem echo.
                            set "NomeFileAudiosvse=%NomeFileAudiosv:.thd=%"
                            rem echo Solo nome file Sorgente = !NomeFileAudiosvse!
                            rem echo.
                            goto fineverifiche
                            )
)

for /f "tokens=*" %%a in (flacesiste.txt) do (
    set "temp_variable=%%a"
    rem echo temp variabile = !temp_variable!
    if !temp_variable! neq "" (
                            set "tipofilesorgente=flac"
                            rem echo Il file sorgente e' ac3
                            rem echo.
                            set "NomeFileAudiosvse=%NomeFileAudiosv:.flac=%"
                            rem echo Solo nome file Sorgente = !NomeFileAudiosvse!
                            rem echo.
                            goto fineverifiche
                            )
)

:fineverifiche

if !tipofilesorgente! equ "" (
                                goto noaudiotrack
                                )



rem ffprobe -v error -hide_banner -select_streams a:0 -show_streams -of default=noprint_wrappers=1  -i %NomeFileAudio%

.\bin\ffprobe -v error -hide_banner -select_streams a:0 -show_entries stream=codec_name,codec_long_name,channels,bit_rate -of default=noprint_wrappers=1  -i %NomeFileAudio% > "infoAudioFile.txt"

echo.
echo !t3!
echo.
set /a contatoreAudio=1

for /f "tokens=1,2 delims==" %%a in (infoAudioFile.txt) do (
                                                            if !contatoreAudio!==1 (
                                                                                    set "aNome=%%a"
                                                                                    rem echo !aNome!
                                                                                    set "aTipo=%%b"
                                                                                    rem echo !aTipo!
                                                                                    echo !t4! "!aNome!" = !aTipo!
                                                                                    )
                                                            if !contatoreAudio!==2 (
                                                                                    set "aNomel=%%a"
                                                                                    rem echo !aNomel!
                                                                                    set "aTipol=%%b"
                                                                                    rem echo !aTipol!
                                                                                    echo !t5! "!aNomel!" = !aTipol!
                                                                                    )
                                                            if !contatoreAudio!==3 (
                                                                                    set "canali=%%a"
                                                                                    rem echo !canali!
                                                                                    set /a "canalin=%%b"
                                                                                    rem echo !canalin!
                                                                                    echo !t6! "!canali!" = !canalin!

                                                                                    if !outputChannelNumber!==0 ( 
                                                                                                                set /a "canalic=%%b" 
                                                                                                                @REM echo numero canali output = !canalic!
                                                                                                                )
                                                                                    if !outputChannelNumber!==6 if !canalin! GEQ 6 ( 
                                                                                                                                    set /a "canalic=6" 
                                                                                                                                    @REM echo numero canali output = !canalic!
                                                                                                                                    )
                                                                                    if !outputChannelNumber!==6 if !canalin! LSS 6 ( 
                                                                                                                                    set /a "canalic=2" 
                                                                                                                                    @REM echo numero canali output = !canalic!
                                                                                                                                    )
                                                                                    if !outputChannelNumber!==2 if !canalin! GTR 2 ( 
                                                                                                                                    set /a "canalic=2" 
                                                                                                                                    @REM echo numero canali output = !canalic!
                                                                                                                                    )
                                                                                    )

                                                            if !contatoreAudio!==4 (
                                                                                    set "br=%%a"
                                                                                    rem echo !br!
                                                                                    set "brn=%%b"
                                                                                    rem echo brn = !brn!
                                                                                    set "brv=!brn!"
                                                                                    rem echo brv = !brv!
                                                                                    set "btrc=N/A"
                                                                                    if !brv!==!btrc! ( 
                                                                                                    rem echo siamo nell'if 
                                                                                                    set "brnp=variabile" 
                                                                                                    echo Bit Rate Audio "!br!" = !brnp!
                                                                                                    set /a "brnc=640000"
                                                                                                    @REM echo brnc = !brnc!
                                                                                                    ) 
                                                                                                    
                                                                                    if !brv! neq !btrc! ( 
                                                                                                        rem echo siamo nell'else
                                                                                                        set /a "brnp=!brv!" 
                                                                                                        echo Bit Rate Audio "!br!" = !brnp!
                                                                                                        set /a "brnc=!brv!"
                                                                                                        @REM echo brnc = !brnc!
                                                                                                        )
                                                                                    rem echo brnp = !brnp!
                                                                                    rem echo brnc = !brnc!
                                                                                    rem echo !brn!
                                                                                    if !brnc! GTR 640000 ( 
                                                                                                            rem echo siamo nell'if 
                                                                                                            set /a "brc=640000"
                                                                                                            @REM echo brc = !brc!
                                                                                                            ) else ( 
                                                                                                                    rem echo siamo nell'else
                                                                                                                    set /a "brc=!brnc!" 
                                                                                                                    @REM echo brc = !brc!
                                                                                                                    )
                                                                                    if !brnc! GTR 192000 if !outputFormat!==aac ( 
                                                                                                                                rem echo siamo nell'if 
                                                                                                                                set /a "brc=192000"
                                                                                                                                @REM set /a "brc=96000"
                                                                                                                                @REM echo brc = !brc!
                                                                                                                                ) 
                                                                                    if !brnc! GTR 128000 if !brnc! LSS 192000 if !outputFormat!==aac ( 
                                                                                                                                                    rem echo siamo nell'if 
                                                                                                                                                    set /a "brc=128000"
                                                                                                                                                    @REM echo brc = !brc!
                                                                                                                                                    ) 
                                                                                    if !brnc! GTR 96000 if !brnc! LSS 128000 if !outputFormat!==aac ( 
                                                                                                                                                    rem echo siamo nell'if 
                                                                                                                                                    set /a "brc=96000"
                                                                                                                                                    @REM echo brc = !brc!
                                                                                                                                                    ) 
                                                                                    if !brnc! LSS 96000 if !outputFormat!==aac ( 
                                                                                                                                rem echo siamo nell'if 
                                                                                                                                set /a "brc=96000"
                                                                                                                                @REM echo brc = !brc!
                                                                                                                                ) 
                                                                                    if !brnc! GTR 192000 if !outputFormat!==ac3 ( 
                                                                                                                                rem echo siamo nell'if 
                                                                                                                                set /a "brc=640000"
                                                                                                                                @REM set /a "brc=96000"
                                                                                                                                @REM echo brc = !brc!
                                                                                                                                ) 
                                                                                    if !brnc! GTR 128000 if !brnc! LSS 192000 if !outputFormat!==ac3 ( 
                                                                                                                                                    rem echo siamo nell'if 
                                                                                                                                                    set /a "brc=512000"
                                                                                                                                                    @REM echo brc = !brc!
                                                                                                                                                    ) 
                                                                                    if !brnc! GTR 96000 if !brnc! LSS 128000 if !outputFormat!==ac3 ( 
                                                                                                                                                    rem echo siamo nell'if 
                                                                                                                                                    set /a "brc=448000"
                                                                                                                                                    @REM echo brc = !brc!
                                                                                                                                                    ) 
                                                                                    if !brnc! LSS 96000 if !outputFormat!==ac3 ( 
                                                                                                                                rem echo siamo nell'if 
                                                                                                                                set /a "brc=320000"
                                                                                                                                @REM echo brc = !brc!
                                                                                                                                ) 
                                                                                                            

                                                                                    rem pause                   
                                                                                    )
                                                          
                                                                set /a contatoreAudio+=1                                                                                 
                                                                )


rem echo contatoreAudio = !contatoreAudio!

if !contatoreAudio!==1 (
                        goto noaudiotrack
                        ) else (
                                goto conversioneaudiodo
                                )


goto fineconvaudio


:noaudiotrack
echo.
echo !t7!
echo.
goto fineconvaudio

Endlocal

:conversioneaudiodo
echo.
echo !t8! !audioOutputFortmatType! = !canalic!
echo !t9! !audioOutputFortmatType! = !brc!
echo.
echo !t10!
echo.

if !outputFormat!==aac if !aTipo!==ac3 or if !aTipo!==flac or if !aTipo!==thd or if !aTipo!==wav or if !aTipo!==eac3 if !canalic!==6 (
    set "filtro_da_ac3_a_aac=-af "channelmap=2^|0^|1^|4^|5^|3:5.1^""
    @REM echo filtro_da_ac3_a_aac = !filtro_da_ac3_a_aac!
)


if !outputFormat!==ac3 if !aTipo!==aac if !canalic!==6 (
    set "filtro_da_aac_a_ac3=-af "channelmap=1^|2^|0^|5^|3^|4:5.1^""
    @REM echo filtro_da_aac_a_ac3 = !filtro_da_aac_a_ac3!
)

if !outputFormat!==aac if !aTipo!==dts if !canalic!==6 (
    set "filtro_da_dts_a_aac="
    @REM echo filtro_da_aac_a_ac3 = !filtro_da_aac_a_ac3!
)

if !outputFormat!==ac3 if !aTipo!==dts if !canalic!==6 (
    set "filtro_da_dts_a_ac3=-af "channelmap=1^|2^|0^|5^|3^|4:5.1^""
    @REM echo filtro_da_aac_a_ac3 = !filtro_da_aac_a_ac3!
)

rem da dts a ac3
if !outputFormat!==ac3 if !aTipo!==dts if !canalic!==6 (
    goto conversioneDaDTSaAC3
) 
goto fineCorrezioneDTS

:conversioneDaDTSaAC3
echo !t20!
echo !t21!
echo !t22!
echo.
echo 1) L - R - C - LFE - Ls - Rs
echo 2) C - L - R - Ls - Rs - LFE
echo.
CHOICE /N /C:12 /M "!t14! "

if errorlevel 2 goto impostazioneDTSSCorretta
if errorlevel 1 goto impostazioneDTSSbagliata

:impostazioneDTSSCorretta
set "filtro_da_dts_a_ac3=-af "channelmap=1^|2^|0^|5^|3^|4:5.1^""
echo.
echo !t23!
echo.
goto fineCorrezioneDTS

:impostazioneDTSSbagliata
echo.
echo !t24!
echo.
set "filtro_da_dts_a_ac3="

:fineCorrezioneDTS

@REM echo .\bin\ffmpeg.exe -y -loglevel verbose -hide_banner -stats -i !NomeFileAudio! !filtro_da_aac_a_ac3! -strict -2 -acodec !outputFormat! -ab !brc! -ac !canalic! "!NomeFileAudiosvse!_convertito.!outputFormat!"
.\bin\ffmpeg.exe -y -loglevel panic -hide_banner -stats -i !NomeFileAudio! !filtro_da_dts_a_ac3! -acodec !outputFormat! -ab !brc! -ac !canalic! "!NomeFileAudiosvse!_convertito.!outputFormat!"
goto subitodopofineconversioneaudio


if !outputFormat!==aac if !aTipo!==dts if !canalic!==6 (
    set "filtro_da_dts_a_aac="
    @REM echo filtro_da_aac_a_ac3 = !filtro_da_aac_a_ac3!
)

rem da dts a aac
if !outputFormat!==aac if !aTipo!==dts if !canalic!==6 (
    @REM echo .\bin\ffmpeg.exe -y -loglevel verbose -hide_banner -stats -i !NomeFileAudio! !filtro_da_aac_a_ac3! -strict -2 -acodec !outputFormat! -ab !brc! -ac !canalic! "!NomeFileAudiosvse!_convertito.!outputFormat!"
    .\bin\ffmpeg.exe -y -loglevel panic -hide_banner -stats -i !NomeFileAudio! !filtro_da_dts_a_aac! -acodec !outputFormat! -ab !brc! -ac !canalic! "!NomeFileAudiosvse!_convertito.!outputFormat!"
    goto subitodopofineconversioneaudio
)

rem da aac a ac3
if !outputFormat!==ac3 if !aTipo!==aac (
    @REM echo .\bin\ffmpeg.exe -y -loglevel verbose -hide_banner -stats -i !NomeFileAudio! !filtro_da_aac_a_ac3! -strict -2 -acodec !outputFormat! -ab !brc! -ac !canalic! "!NomeFileAudiosvse!_convertito.!outputFormat!"
    .\bin\ffmpeg.exe -y -loglevel panic -hide_banner -stats -i !NomeFileAudio! !filtro_da_aac_a_ac3! -strict -2 -acodec !outputFormat! -ab !brc! -ac !canalic! "!NomeFileAudiosvse!_convertito.!outputFormat!"
    goto subitodopofineconversioneaudio
) 



rem da ac3 a aac
@REM echo.\bin\ffmpeg.exe -y -loglevel verbose -hide_banner -stats -i !NomeFileAudio! !filtro_da_ac3_a_aac! -acodec !outputFormat! -ab !brc! -ac !canalic! "!NomeFileAudiosvse!_convertito.!outputFormat!"
.\bin\ffmpeg.exe -y -loglevel panic -hide_banner -stats -i !NomeFileAudio! !filtro_da_ac3_a_aac! -acodec !outputFormat! -ab !brc! -ac !canalic! "!NomeFileAudiosvse!_convertito.!outputFormat!"

:subitodopofineconversioneaudio

echo.
echo !t11!



:fineconvaudio

if exist "nomefileaudiot.txt" ( 
                                del nomefileaudiot.txt
                                )
if exist "infoAudioFile.txt" ( 
                                del infoAudioFile.txt
                                )
if exist "aacesiste.txt" ( 
                            del aacesiste.txt
                            )
if exist "ac3esiste.txt" ( 
                            del ac3esiste.txt
                            )
if exist "dtsesiste.txt" (
                            del dtsesiste.txt
                            )
if exist "eac3esiste.txt" (
                            del eac3esiste.txt
                            )
if exist "wavesiste.txt" (
                            del wavesiste.txt
                            )
if exist "thdesiste.txt" (
                            del thdesiste.txt
                            )
if exist "flacesiste.txt" (
                            del flacesiste.txt
                            )

echo.
set waitenter=
set /P waitenter=!t12!
Endlocal
goto puliziainiziale






rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:deleteHDR10plus
cls
setLocal EnableExtensions EnableDelayedExpansion

for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianodeleteDV
)

if %lingua%==inglese (
    goto caricalinguainglesedeleteDV
)



:caricalinguainglesedeleteDV
set t1=Drag the Video File .hevc Here to Delete HDR10+ Metadata:  
set t2=The File does not Exist 
set t3=HDR10+ Metadata Removal from .hevc Video Track Started:  
set t4=Removal Finished.  
set t5=Press Enter to Back to Main Menu:  
goto finecaricamentolinguadeleteDV



:caricalinguaitalianodeleteDV
set t1=Trascina Qui il File Video .hevc da cui Cancellare i Metadati HDR10+:  
set t2=File Inesistente 
set t3=Cancellazione Metadati HDR10+ da traccia video .hevc Iniziata:  
set t4=Cancellazione Terminata.  
set t5=Premi Invio per tornare al Menu' Principale:  
goto finecaricamentolinguadeleteDV


:finecaricamentolinguadeleteDV


set NomeFileDeleteHDR10plus=

set /P NomeFileDeleteHDR10plus=!t1!
rem echo %NomeFileDeleteHDR10plus%

if exist %NomeFileDeleteHDR10plus% ( goto cancellazioneHDR10PlusMetadata ) else ( 
                                                        echo.
                                                        echo !t2!
                                                        echo.
                                                        goto finecancellazioneHDR10PlusMetadata
                                                        )    
:cancellazioneHDR10PlusMetadata
set NomeFileDeleteHDR10plussa=%NomeFileDeleteHDR10plus:"=%
rem echo %NomeFileDeleteHDR10plussa%

set NomeFileDeleteHDR10plussae=%NomeFileDeleteHDR10plussa:.hevc=%
rem echo %NomeFileDeleteHDR10plussae%

set NomeFileDeleteHDR10plusmet="%NomeFileDeleteHDR10plussae%_No_HDR10_Plus.hevc"
rem echo %NomeFileDeleteHDR10plusmet%

echo.
echo !t3!
echo.
.\bin\hdr10plus_tool remove %NomeFileDeleteHDR10plus% -o %NomeFileDeleteHDR10plusmet%

echo !t4!
echo.

:finecancellazioneHDR10PlusMetadata

set waitenter=
set /P waitenter=!t5!
Endlocal
goto puliziainiziale




rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:deleteDV
cls
setLocal EnableExtensions EnableDelayedExpansion

for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianodeleteDV
)

if %lingua%==inglese (
    goto caricalinguainglesedeleteDV
)



:caricalinguainglesedeleteDV
set t1=Drag the Video File .hevc Here to Delete Dolby Vision Metadata::  
set t2=The File does not Exist 
set t3=Dolby Vision Metadata Removal from .hevc Video Track Started:  
set t4=Removal Finished.  
set t5=Press Enter to Back to Main Menu:  
goto finecaricamentolinguadeleteDV



:caricalinguaitalianodeleteDV
set t1=Trascina Qui il File Video .hevc da cui Cancellare i Metadati Dolby Vision:  
set t2=File Inesistente 
set t3=Cancellazione Metadati Dolby Vision da traccia video .hevc Iniziata:  
set t4=Cancellazione Terminata.  
set t5=Premi Invio per tornare al Menu' Principale:  
goto finecaricamentolinguadeleteDV


:finecaricamentolinguadeleteDV


set NomeFileDeleteDV=

set /P NomeFileDeleteDV=!t1!
rem echo %NomeFileDeleteDV%

if exist %NomeFileDeleteDV% ( goto cancellazioneDolbyVisionMetadata ) else ( 
                                                        echo.
                                                        echo !t2!
                                                        echo.
                                                        goto finecancellazioneDolbyVisionMetadata
                                                        )    
:cancellazioneDolbyVisionMetadata
set NomeFileDeleteDVsa=%NomeFileDeleteDV:"=%
rem echo %NomeFileDeleteDVsa%

set NomeFileDeleteDVsae=%NomeFileDeleteDVsa:.hevc=%
rem echo %NomeFileDeleteDVsae%

set NomeFileDeleteDVmet="%NomeFileDeleteDVsae%_No_Dolby_Vision.hevc"
rem echo %NomeFileDeleteDVmet%

echo.
echo !t3!
echo.
.\bin\dovi_tool remove %NomeFileDeleteDV% -o %NomeFileDeleteDVmet%

echo !t4!
echo.

:finecancellazioneDolbyVisionMetadata

set waitenter=
set /P waitenter=!t5!
Endlocal
goto puliziainiziale




rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:detectcrop
cls

setLocal EnableExtensions EnableDelayedExpansion


for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianodetectcrop
)

if %lingua%==inglese (
    goto caricalinguainglesedetectcrop
)



:caricalinguainglesedetectcrop
set t1=Drag the Video File .mkv Here to Detect crop:  
set t2=Video Width
set t3=Video Height
set t4=Video Format

set t5=Video Duration in seconds =
set t6=Video Duration in Minutes =
set t7=Interval between Frames for Crop Detection =
set t8=seconds
set t9=Crop Detection Started:
set t10=Crop Detection Frame
set t11=to seconds
set t12=Done...
set t13=The File does not Exist 
set t60=Press Enter to Back to Main Menu:  
goto finecaricamentolinguadetectcrop



:caricalinguaitalianodetectcrop
set t1=Trascina Qui il File Video .mkv su cui Rilevare il Crop:  
set t2=Larghezza Video
set t3=Altezza Video
set t4=Formato Video

set t5=Durata del Video in secondi =
set t6=Durata del video in Minuti =
set t7=Intervallo tra i Fotogrammi per il Rilevamento del Crop =
set t8=secondi
set t9=Rilevamento Crop Iniziato:
set t10=Rilevazione Crop Fotogramma
set t11=a secondi
set t12=Eseguita...
set t13=File Inesistente 
set t60=Premi Invio per tornare al Menu' Principale:  
goto finecaricamentolinguadetectcrop


:finecaricamentolinguadetectcrop




set NomeFiletocrop=
set /P NomeFiletocrop=!t1!

if exist !NomeFiletocrop! ( goto iniziorilevazionecrop ) else ( 
                                                        echo.
                                                        echo !t13!
                                                        echo.
                                                        goto finerilevamentocrop
                                                        )    


:iniziorilevazionecrop 
.\bin\ffprobe -v error -hide_banner -select_streams v:0 -show_entries stream=width,height,pix_fmt -of default=noprint_wrappers=1 %NomeFiletocrop% > ".\temp\Temp_HDR10_Stream.txt"

set /A x1=1
set /A moviewidthreal=0
set /A movieheightreal=0

echo.

for /f "tokens=1,2 delims==" %%a in (.\temp\Temp_HDR10_Stream.txt) do (if !x1!==1 (
                                                                            set /A "moviewidthreal=%%b" 
                                                                            rem echo moviewidthreal = !moviewidthreal!
                                                                            echo !t2! "%%a" = %%b  
                                                                            )
                                                                if !x1!==2 (
                                                                            set /A "movieheightreal=%%b" 
                                                                            rem echo movieheightreal = !movieheightreal!
                                                                            echo !t3! "%%a" = %%b  
                                                                            )
                                                                if !x1!==3 (
                                                                            set "formatvideo=%%b" 
                                                                            rem echo formatvideo = !formatvideo!
                                                                            echo !t4! "%%a" = %%b  
                                                                            )
                                                                set /A x1+=1
                                                                )           



.\bin\ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 %NomeFiletocrop%  > ".\temp\durata_film.txt"

set /a contatore=1
for /f "tokens=1 delims=." %%a in (.\temp\durata_film.txt) do  (
                                                        echo. 
                                                        echo !t5! %%a
                                                        set /a "secondi=%%a"
                                                        set /a "minuti=!secondi!/60"
                                                        echo !t6! !minuti!
                                                        set /a "intervallo_tagli=!secondi!/11"
                                                        echo !t7! !intervallo_tagli! !t8!
                                                        echo.
                                                        echo !t9!
                                                        echo.

                                                        

                                                        FOR /L %%a IN (1, 1, 10) DO (
                                                                                    rem echo %%a
                                                                                    set /a "secondi=%%a*!intervallo_tagli!"
                                                                                    rem echo !secondi!

                                                                                    if !formatvideo!==yuv420p (
                                                                                                                set /a "ca=16"
                                                                                                                rem echo !ca!
                                                                                                                    
                                                                                                                set /a "cb=2"
                                                                                                                rem echo !cb!
                                                                                                                    
                                                                                                                set /a "cc=0"
                                                                                                                rem echo !cc!

                                                                                                                set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                                                rem echo !cr!
                                                                                                                )

                                                                                    if !formatvideo!==yuv420p10le  ( 
                                                                                                                    set /a "ca=72"
                                                                                                                    rem echo !ca!
                                                                                                                    
                                                                                                                    set /a "cb=2"
                                                                                                                    rem echo !cb!
                                                                                                                    
                                                                                                                    set /a "cc=0"
                                                                                                                    rem echo !cc!

                                                                                                                    set "cr=cropdetect=!ca!:!cb!:!cc!"
                                                                                                                    rem echo !cr!
                                                                                                                    )                                                                                                                

                                    
                                                                                
                                                                                
                                                                                    .\bin\ffmpeg -ss !secondi! -hide_banner -nostats -i %NomeFiletocrop% -vframes 10 -vf !cr! -f null - 2> ".\temp\crop.txt"
                                                                                    
                                                                                    findstr /r "Parsed_cropdetect_0" .\temp\crop.txt >> .\temp\risultato_multiplo.txt   
                                                                                    
                                                                                    echo !t10! %%a !t11! !secondi! !t12!
                                                                                    
                                                                                    )       
                                                                                       

                                                                                    for /f "tokens=1,2 delims==" %%a in (.\temp\risultato_multiplo.txt) do ( echo %%b >> .\temp\crop_multiplo.txt )
                                                                                    
                                                                                    set /a "maxfrequenza=0"

                                                                                    for /f "delims=" %%a in (.\temp\crop_multiplo.txt) do ( 
                                                                                                                                    set "cropconfront=%%a"
                                                                                                                                    rem echo "!cropconfront!"
                                                                                                                                    
                                                                                                                                    set /a "contatorfrequenza=0"
                                                                                                                                    for /f "delims=" %%b in (.\temp\crop_multiplo.txt) do (
                                                                                                                                                                                    set "dato_da_verificare=%%b"
                                                                                                                                                                                    rem echo cropconfront = "!cropconfront!"
                                                                                                                                                                                    rem echo dato_da_verificare = "!dato_da_verificare!"
                                                                                                                                                                                    if !cropconfront!==!dato_da_verificare! ( set /a "contatorfrequenza+=1")
                                                                                                                                                                                    )
                                                                                                                                    if !maxfrequenza! LSS !contatorfrequenza! ( 
                                                                                                                                                                                set /a "maxfrequenza=!!contatorfrequenza!!"
                                                                                                                                                                                set "cropd=!cropconfront!"
                                                                                                                                                                                )
                                                                                                                                    

                                                                                                                                    rem if !cropconfront! in (elenco_crop_frequenza.txt) ()
                                                                                                                                    rem echo !cropconfront!:!contatorfrequenza! >> elenco_crop_frequenza.txt

                                                                                                                                    )

                                                                                    rem echo crop piu' frequente = !cropd! con grequenza = !maxfrequenza!
                                                                                    echo !cropd! > .\temp\crop_finale.txt

                                                                                    for /f "tokens=1,2,3,4 delims=:" %%a in (.\temp\crop_finale.txt) do  ( 
                                                                                                                                                    rem set /a "mwidth=%%a"
                                                                                                                                                    rem echo mwidth = !mwidth!

                                                                                                                                                    rem set /a "mheight=%%b"
                                                                                                                                                    rem echo mheight = !mheight!

                                                                                                                                                    rem set /a "mx=%%c"
                                                                                                                                                    rem echo mx = !mx!

                                                                                                                                                    rem set /a "my=%%d"
                                                                                                                                                    rem echo my = !my!

                                                                                                                                                    if !contatore!==1 ( 
                                                                                                                                                                set /a "wmax=%%a" 
                                                                                                                                                                set /a "hmax=%%b"
                                                                                                                                                                set /a "xmin=%%c"
                                                                                                                                                                set /a "ymin=%%d"
                                                                                                                                                                set /a "mwidth=%%a"
                                                                                                                                                                set /a "mheight=%%b"
                                                                                                                                                                set /a "mx=%%c"
                                                                                                                                                                set /a "my=%%d"
                                                                                                                                                                set /a "contatore+=1"
                                                                                                                                                                )
                                                                                                                                                    
                                                                                                                                                    rem if %%b gtr !hmax! if %%c gtr !xmin! if %%d gtr !ymin! 

                                                                                                                                                    if %%a geq !wmax! if %%b geq !hmax! ( 
                                                                                                                                                                        set /a "wmax=%%a" 
                                                                                                                                                                        set /a "hmax=%%b"
                                                                                                                                                                        set /a "xmin=%%c"
                                                                                                                                                                        set /a "ymin=%%d"
                                                                                                                                                                        set /a "mwidth=%%a"
                                                                                                                                                                        set /a "mheight=%%b"
                                                                                                                                                                        set /a "mx=%%c"
                                                                                                                                                                        set /a "my=%%d"
                                                                                                                                                                        )
                                                                                                                                                    )
                                                                                    echo.
                                                                                    echo FFmpeg Crop Settings: crop=!mwidth!:!mheight!:!mx!:!my!    
                                                                                    echo.
                                                                                    set /a "csup=!my!"
                                                                                    rem echo csup = !csup!
                                                                                                                                    
                                                                                    set /a "csin=!mx!"
                                                                                    rem echo csin = !csin!

                                                                                    set /a "cinf=!movieheightreal!-!mheight!-!my!"
                                                                                    rem echo movieheightreal = !movieheightreal!
                                                                                    rem echo cinf = !cinf!
                                                                                    set /a "cdes=!moviewidthreal!-!mwidth!-!mx!"
                                                                                    rem echo cdes = !cdes!

                                                                                    echo NVEnc Crop Settings: --crop !csin!,!csup!,!cdes!,!cinf!    
                                                                                    echo.  
                                                                                    
                                                                                    ) 
                                                        )          

:finerilevamentocrop
if exist ".\temp\Temp_HDR10_Stream.txt" ( del .\temp\Temp_HDR10_Stream.txt )
if exist ".\temp\durata_film.txt" ( del .\temp\durata_film.txt )
if exist ".\temp\crop.txt" ( del .\temp\crop.txt )
if exist ".\temp\risultato_multiplo.txt" ( del .\temp\risultato_multiplo.txt )
if exist ".\temp\crop_multiplo.txt" ( del .\temp\crop_multiplo.txt )
if exist ".\temp\crop_finale.txt" ( del .\temp\crop_finale.txt )



set waitenter=
set /P waitenter=!t60!
Endlocal
goto puliziainiziale




rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:avviaregmkv
cls
setLocal EnableExtensions EnableDelayedExpansion

for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoavviaregmkv
)

if %lingua%==inglese (
    goto caricalinguaingleseavviaregmkv
)



:caricalinguaingleseavviaregmkv
set t1=GmkvExtractGUI App Started...
set t2=Extract tracks and Close it when Finished to back
set t3=control to this application....  

set t6=Press Enter to Back to Main Menu:  
goto finecaricamentolinguaavviaregmkv



:caricalinguaitalianoavviaregmkv
set t1=Avviata l'app GmkvExtractGUI...
set t2=Estrai le tracce e quando finito chiudila per ridare
set t3=il controllo a questa applicazione....  

set t6=Premi Invio per tornare al Menu' Principale:  
goto finecaricamentolinguaavviaregmkv


:finecaricamentolinguaavviaregmkv


echo.
echo !t1!
echo !t2!
echo !t3!
echo.

.\bin\gMKVExtractGUI

set waitenter=
set /P waitenter=!t6!
Endlocal
goto puliziainiziale


rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:estrazioneHDR10plusdaMKV
cls
setLocal EnableExtensions EnableDelayedExpansion

for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoestrazioneHDR10plusdaMKV
)

if %lingua%==inglese (
    goto caricalinguaingleseestrazioneHDR10plusdaMKV
)



:caricalinguaingleseestrazioneHDR10plusdaMKV
set t1=Drag the H265 .mkv File Here to Extract HDR10+ Metadata: 
set t2=The File does not Exist 
set t4=HDR10+ Metadata Extraction Started:  
set t5=Extraction Finished.  
set t6=Press Enter to Back to Main Menu:  
goto finecaricamentolinguaestrazioneHDR10plusdaMKV



:caricalinguaitalianoestrazioneHDR10plusdaMKV
set t1=Trascina Qui il File Video .mkv da cui Estrarre i Metadati HDR10+: 
set t2=File Inesistente 
set t4=Estrazione Metadati HDR10+ Iniziata:  
set t5=Estrazione Terminata.  
set t6=Premi Invio per tornare al Menu' Principale:  
goto finecaricamentolinguaestrazioneHDR10plusdaMKV


:finecaricamentolinguaestrazioneHDR10plusdaMKV



set NomeFileHDR10plusmet=
set /P NomeFileHDR10plusmet=!t1!

if exist %NomeFileHDR10plusmet% ( goto estrazioneHDR10plusdaMKVsegment ) else ( 
                                                        echo.
                                                        echo !t2!
                                                        echo.
                                                        goto fineestrazioneHDR10plusdaMKVsegment
                                                        )    
:estrazioneHDR10plusdaMKVsegment
set NomeFileHDR10plusmetsa=%NomeFileHDR10plusmet:"=%
rem echo %NomeFileHDR10plusmetsa%

set NomeFileHDR10plusmetsae=%NomeFileHDR10plusmetsa:.mkv=%
rem echo %NomeFileHDR10plusmetsae%

set NomeFileIniettatoHDR10plusmet="%NomeFileHDR10plusmetsae%_Metadati_Hdr10+.json"
rem echo %NomeFileIniettatoHDR10plusmet%

echo.
echo !t4!
echo.
.\bin\ffmpeg -hide_banner -stats -loglevel panic -i %NomeFileHDR10plusmet% -map 0:v:0 -c copy -bsf:v hevc_mp4toannexb -f hevc - | .\bin\hdr10plus_tool extract -o %NomeFileIniettatoHDR10plusmet% -
echo.
echo !t5!
echo.

:fineestrazioneHDR10plusdaMKVsegment

set waitenter=
set /P waitenter=!t6!
Endlocal
goto puliziainiziale




rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:estrazioneDVdaMKV
cls
setLocal EnableExtensions EnableDelayedExpansion

setLocal EnableExtensions EnableDelayedExpansion

for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoestrazioneDVdaMKV
)

if %lingua%==inglese (
    goto caricalinguaingleseestrazioneDVdaMKV
)



:caricalinguaingleseestrazioneDVdaMKV
set t1=Drag the H265 .mkv File Here to Extract Dolby Vision Metadata: 
set t2=The File does not Exist 
set t4=Dolby Vision Metadata Extraction Started:  
set t5=Extraction Finished.  
set t6=Press Enter to Back to Main Menu:  
goto finecaricamentolinguaestrazioneDVdaMKV



:caricalinguaitalianoestrazioneDVdaMKV
set t1=Trascina Qui il File Video .mkv da cui Estrarre i Metadati Dolby Vision: 
set t2=File Inesistente 
set t4=Estrazione Metadati Dolby Vision Iniziata:  
set t5=Estrazione Terminata.  
set t6=Premi Invio per tornare al Menu' Principale:  
goto finecaricamentolinguaestrazioneDVdaMKV


:finecaricamentolinguaestrazioneDVdaMKV


set NomeFileDVmet=
set /P NomeFileDVmet=!t1!

if exist %NomeFileDVmet% ( goto estrazioneDVdaMKVsegment ) else ( 
                                                        echo.
                                                        echo !t2!
                                                        echo.
                                                        goto fineestrazioneDVdaMKVsegment
                                                        )    
:estrazioneDVdaMKVsegment
set NomeFileDVmetsa=%NomeFileDVmet:"=%
rem echo %NomeFileDVmetsa%

set NomeFileDVmetsae=%NomeFileDVmetsa:.mkv=%
rem echo %NomeFileDVmetsae%

set NomeFileIniettatoDVmet="%NomeFileDVmetsae%_Dolby_Vision_RPU.bin"
rem echo %NomeFileIniettatoDVmet%

echo.
echo !t4!
echo.
.\bin\ffmpeg -hide_banner -stats -loglevel panic -i %NomeFileDVmet% -c:v copy -bsf:v hevc_mp4toannexb -f hevc - | .\bin\dovi_tool extract-rpu - -o %NomeFileIniettatoDVmet%
echo.
echo !t5!
echo.

:fineestrazioneDVdaMKVsegment

set waitenter=
set /P waitenter=!t6!
Endlocal
goto puliziainiziale




rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:iniettarehdr10plus
cls
setLocal EnableExtensions EnableDelayedExpansion

for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoiniettarehdr10plus
)

if %lingua%==inglese (
    goto caricalinguaingleseiniettarehdr10plus
)



:caricalinguaingleseiniettarehdr10plus
set t1=Drag the H265 .hevc file Here to Inject Metadata HDR10+: 
set t2=The File does not Exist 
set t3=Drag the HDR10+ Metadata in Textual Format .json Here:  
set t4=HDR10+ Metadata Injection Started:  
set t5=Injection Finished.  
set t6=Press Enter to Back to Main Menu:  
goto finecaricamentolinguainiettarehdr10plus



:caricalinguaitalianoiniettarehdr10plus
set t1=Trascina Qui il File H265 .hevc a cui Iniettare i Metadati HDR10+: 
set t2=File Inesistente 
set t3=Trascina Qui il File dei Metadati HDR10+ in Formato Testuale .json:  
set t4=Iniezione Metadati HDR10+ Iniziata:  
set t5=Iniezione Terminata.  
set t6=Premi Invio per tornare al Menu' Principale:  
goto finecaricamentolinguainiettarehdr10plus


:finecaricamentolinguainiettarehdr10plus


set NomeFileHdr10plus=
set /P NomeFileHdr10plus=!t1!

if exist %NomeFileHdr10plus% ( goto iniettareHDR10plus ) else ( 
                                                        echo.
                                                        echo !t2!
                                                        echo.
                                                        goto fineiniettareHDR10plus
                                                        )    
:iniettareHDR10plus
set NomeFileHdr10plussa=%NomeFileHdr10plus:"=%
rem echo %NomeFileHdr10plussa%

set NomeFileHdr10plussae=%NomeFileHdr10plussa:.hevc=%
rem echo %NomeFileHdr10plussae%

set NomeFileIniettatoHdr10plus="%NomeFileHdr10plussae%_HDR10+.hevc"
rem echo %NomeFileIniettatoHdr10plus%
echo.
set NomeFileMetHdr10plus=
set /P NomeFileMetHdr10plus=!t3!
rem echo %NomeFileMetHdr10plus%

if exist %NomeFileMetHdr10plus% ( goto iniettareHDR10plusMetadati ) else ( 
                                                        echo.
                                                        echo !t2!
                                                        echo.
                                                        goto fineiniettareHDR10plus
                                                        )    
:iniettareHDR10plusMetadati
echo.
echo !t4!
echo.
.\bin\hdr10plus_tool inject -i %NomeFileHdr10plus% -j %NomeFileMetHdr10plus% -o %NomeFileIniettatoHdr10plus%
echo.
echo !t5!
echo.

:fineiniettareHDR10plus

set waitenter=
set /P waitenter=!t6!
Endlocal
goto puliziainiziale



rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:iniettaredv
cls
setLocal EnableExtensions EnableDelayedExpansion

for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoiniettaredv
)

if %lingua%==inglese (
    goto caricalinguaingleseiniettaredv
)



:caricalinguaingleseiniettaredv
set t1=Drag the H265 .hevc file Here to Inject Metadata Dolby Vision: 
set t2=The File does not Exist 
set t3=Drag the Dolby Vision Metadata in Binary Format .bin Here:  
set t4=Dolby Vision Metadata Injection Started:  
set t5=Injection Finished.  
set t6=Press Enter to Back to Main Menu:  
goto finecaricamentolinguainiettaredv



:caricalinguaitalianoiniettaredv
set t1=Trascina Qui il File H265 .hevc a cui Iniettare i Metadati Dolby Vision: 
set t2=File Inesistente 
set t3=Trascina Qui il File dei Metadati Dolby Vision in Formato Binario .bin:  
set t4=Iniezione Metadati Dolby Vision Iniziata:  
set t5=Iniezione Terminata.  
set t6=Premi Invio per tornare al Menu' Principale:  
goto finecaricamentolinguainiettaredv


:finecaricamentolinguainiettaredv

set NomeFileDV=
set /P NomeFileDV=!t1!

if exist %NomeFileDV% ( goto iniettareDVbinario ) else ( 
                                                        echo.
                                                        echo !t2!
                                                        echo.
                                                        goto fineiniettareDVbinario
                                                        )    
:iniettareDVbinario
set NomeFileDVsa=%NomeFileDV:"=%
rem echo %NomeFileDV%

set NomeFileDVsae=%NomeFileDVsa:.hevc=%
rem echo %NomeFileDVsa%

set NomeFileIniettato="%NomeFileDVsae%_DV.hevc"
rem echo %NomeFileIniettato%

echo.
set NomeFileDVbin=
set /P NomeFileDVbin=!t3!
rem echo %NomeFileDVbin%

if exist %NomeFileDVbin% ( goto iniezioneDolbyVision ) else ( 
                                                        echo.
                                                        echo !t2!
                                                        echo.
                                                        goto fineiniettareDVbinario
                                                        )    
:iniezioneDolbyVision
echo.
echo !t4!
echo.
.\bin\dovi_tool inject-rpu -i %NomeFileDV% --rpu-in %NomeFileDVbin% -o %NomeFileIniettato%
echo.

echo !t5!
echo.

:fineiniettareDVbinario

set waitenter=
set /P waitenter=!t6!
Endlocal
goto puliziainiziale


rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:convertdv
cls
setLocal EnableExtensions EnableDelayedExpansion


for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianoconvertdv
)

if %lingua%==inglese (
    goto caricalinguaingleseconvertdv
)


:caricalinguaingleseconvertdv
set t1=Drag Here the Metadati Dolby Vision Textual Format File .xml:  
set t2=The File does not Exist 
set t3=Dolby Vision Metadata Conversion Started:  
set t4=Conversion Complete!  
set t5=Press Enter to Back to Main Menu.  
goto finecaricamentolinguaconvertdv



:caricalinguaitalianoconvertdv
set t1=Trascina Qui il File in Formato Testuale .xml dei Metadati Dolby Vision:  
set t2=File Inesistente 
set t3=Coversione Metadati Dolby Vision iniziata:  
set t4=Coversione Terminata!  
set t5=Premi Invio per tornare al Menu' Principale.  
goto finecaricamentolinguaconvertdv


:finecaricamentolinguaconvertdv


set NomeFileDV=
rem set MetadatiStreamHDR10=

set /P NomeFileDV=!t1!
rem echo %NomeFileDV%

if exist %NomeFileDV% ( goto conversioneDVdaTestoaBinario ) else ( 
                                                        echo.
                                                        echo !t2!
                                                        echo.
                                                        goto fineconvertdv
                                                        )    
:conversioneDVdaTestoaBinario
set NomeFileDVsxml=%NomeFileDV:.xml=%
rem echo %NomeFileDVsxml%

set NomeFileDVsxmlf=%NomeFileDVsxml:"=%
rem echo %NomeFileDVsxmlf%

set NomeNomeFileDVbin=%NomeFileDVsxmlf%.bin
rem echo %NomeNomeFileDVbin%

set NomeFileDVbinario="%NomeNomeFileDVbin%"
rem echo %NomeFileDVbinario%

echo.
echo !t3!
echo.
.\bin\dovi_tool generate --xml %NomeFileDV% -o %NomeFileDVbinario% 
echo.
echo !t4!
echo.

:fineconvertdv


set waitenter=
set /P waitenter=!t5!
Endlocal
goto puliziainiziale




rem -------------------------------------------------------------------------------------------------------------------------------
rem -------------------------------------------------------------------------------------------------------------------------------
:hdr10reader
cls
setLocal EnableExtensions EnableDelayedExpansion


for /f "tokens=1 delims=" %%a in (.\saved\language.dat) do  (
                                                                @REM echo %%a
                                                                set "lingua=%%a"
                                                                @REM echo lingua_memorizzata = !lingua!
                                                            )

if %lingua%==italiano (
    goto caricalinguaitalianohdr10reader
    )

if %lingua%==inglese (
    goto caricalinguainglesehdr10reader
    )



:caricalinguainglesehdr10reader
set t1=Drah Here the Video File for Extraction of HDR10 Metadata:  
set t2=The File does not Exist 
set t3=Info Video:  
set t4=Video Width
set t5=Video Height
set t6=Video Codec
set t7=Details Video Codec
set t8=Video Format
set t9=Dolby Vision Metadata Presents    
set t10=HDR10+ Metadata Presents  
set t11=The Video Has No Master Display Metadata
set t12=The dragged file is not a video!
set t13=The video is not HDR
set t14=Press Enter to Back to Main Menu.  
goto finecaricamentolinguahdr10reader



:caricalinguaitalianohdr10reader
set t1=Trascina Qui il File Video per Estrazione Metadati HDR10:  
set t2=File Inesistente 
set t3=Informazioni Video:  
set t4=Larghezza Video
set t5=Altezza Video
set t6=Codec Video
set t7=Codec Video Dettagli
set t8=Formato Video
set t9=Metadati Dolby Vision Presenti    
set t10=Metadati HDR10+ Presenti   
set t11=Il Video non ha Metadati Master Display
set t12=Il file trascinato non e' un video!
set t13=Il Video non e' HDR
set t14=Premi Invio per tornare al Menu' Principale.  

goto finecaricamentolinguahdr10reader


:finecaricamentolinguahdr10reader


set NomeFile=
rem set MetadatiStreamHDR10=

set /P NomeFile=!t1!
rem echo Hai digitato: %NomeFile%
rem pause

if exist %NomeFile% ( goto inizioestrazione ) else ( 
                                                        echo.
                                                        echo !t2!
                                                        echo.
                                                        goto finerealehdr 
                                                        )    


:inizioestrazione
echo.
echo !t3!
echo.

.\bin\ffprobe -v error -hide_banner -select_streams v:0 -show_entries stream=width,height,codec_name,codec_long_name,pix_fmt,color_space,color_transfer,color_primaries -of default=noprint_wrappers=1 %NomeFile% > ".\temp\Temp_HDR10_Stream.txt"

set /A x1=1
set /A nohdrcs=0
set /A nohdrct=0
set /A nohdrcp=0

rem echo nohdr = %nohdr%

for /f "tokens=1,2 delims==" %%a in (.\temp\Temp_HDR10_Stream.txt) do (if !x1!==3 ( 
                                                                            echo !t4! "%%a" = %%b  
                                                                            )
                                                                if !x1!==4 ( 
                                                                            echo !t5! "%%a" = %%b  
                                                                            )                                                           
                                                                if !x1!==6 ( 
                                                                            echo Color Space "%%a" = %%b  
                                                                            set "colorsp=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colorsp!==bt709 (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorsp!==unknown (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorsp!==reserved (set /A "nohdrcs=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                    
                                                                            ) 
                                                                if !x1!==7 ( 
                                                                            echo Color Transfer "%%a" = %%b  
                                                                            set "colortr=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colortr!==bt709 (set /A "nohdrct=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colortr!==unknown (set /A "nohdrct=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colortr!==reserved (set /A "nohdrct=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                    
                                                                            ) 
                                                                if !x1!==8 ( 
                                                                            echo Color Primaries "%%a" = %%b  
                                                                            set "colorpr=%%b"
                                                                            rem echo nohdr = !nohdr!
                                                                            rem echo colorsp = !colorsp!
                                                                            if !colorpr!==bt709 (set /A "nohdrcp=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorpr!==unknown (set /A "nohdrcp=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )
                                                                            if !colorpr!==reserved (set /A "nohdrcp=1"
                                                                                                rem echo nohdr = !nohdr!
                                                                                                )                
                                                                            )    
                                                                if !x1!==1 ( 
                                                                            echo !t6! "%%a" = %%b  
                                                                            )       
                                                                if !x1!==2 ( 
                                                                            echo !t7! "%%a" = %%b  
                                                                            )   
                                                                if !x1!==5 ( 
                                                                            echo !t8! "%%a" = %%b  
                                                                            )
                                                                set /A x1+=1                                                            
)
echo.

if !x1!==1 goto :novideofile

rem echo nohdr = !nohdr!
rem echo nohdr = %nohdr%
if !nohdrcs!==1 if !nohdrct!==1 if !nohdrcp!==1 goto finehdr






.\bin\ffprobe -loglevel panic -select_streams 0 -show_frames -read_intervals %%+#1 -show_entries frame=side_data_list -of default=noprint_wrappers=1 %NomeFile% > ".\temp\Temp_HDR10.txt"


set /A x2=1
set /A dvp=0
set /A hdr10pp=0

set redx=
set redy=
set greenx=
set greeyx=
set bx=
set by=
set wpx=
set wpy=
set minl=
set maxl=
set maxc=
set maxa=
set /A maxcpresent=0
set /A maxapresent=0


findstr /c:"Mastering display metadata" .\temp\Temp_HDR10.txt > .\temp\Temp_HDR10_Finale.txt
findstr /c:"red_x"  .\temp\Temp_HDR10.txt >>  .\temp\Temp_HDR10_Finale.txt
findstr /c:"red_y"  .\temp\Temp_HDR10.txt >>  .\temp\Temp_HDR10_Finale.txt
findstr /c:"green_x"  .\temp\Temp_HDR10.txt >>  .\temp\Temp_HDR10_Finale.txt
findstr /c:"green_y"  .\temp\Temp_HDR10.txt >>  .\temp\Temp_HDR10_Finale.txt
findstr /c:"blue_x"  .\temp\Temp_HDR10.txt >>  .\temp\Temp_HDR10_Finale.txt
findstr /c:"blue_y"  .\temp\Temp_HDR10.txt >>  .\temp\Temp_HDR10_Finale.txt
findstr /c:"white_point_x"  .\temp\Temp_HDR10.txt >>  .\temp\Temp_HDR10_Finale.txt
findstr /c:"white_point_y"  .\temp\Temp_HDR10.txt >>  .\temp\Temp_HDR10_Finale.txt
findstr /c:"min_luminance"  .\temp\Temp_HDR10.txt >>  .\temp\Temp_HDR10_Finale.txt
findstr /c:"max_luminance"  .\temp\Temp_HDR10.txt >>  .\temp\Temp_HDR10_Finale.txt
findstr /c:"Content light level metadata"  .\temp\Temp_HDR10.txt >>  .\temp\Temp_HDR10_Finale.txt
findstr /c:"max_content"  .\temp\Temp_HDR10.txt >>  .\temp\Temp_HDR10_Finale.txt
findstr /c:"max_average"  .\temp\Temp_HDR10.txt >>  .\temp\Temp_HDR10_Finale.txt

findstr /c:"HDR Dynamic Metadata SMPTE2094-40 (HDR10+)"  .\temp\Temp_HDR10.txt >>  .\temp\Temp_HDR10_Finale.txt
findstr /c:"Dolby Vision Metadata"  .\temp\Temp_HDR10.txt >>  .\temp\Temp_HDR10_Finale.txt

rem elimina le prime righe che corrispondono alle stringhe tra le virgolette"
rem findstr /V "TAG:timecode="  .\temp\Temp_HDR10.txt > Temp_HDR10p.txt
rem findstr /V "side_data_type=H.26[45] User Data Unregistered SEI message" Temp_HDR10p.txt > Temp_HDR10f.txt

rem del ".\temp\Temp_HDR10.txt"


for /f "tokens=1,2 delims==,/" %%a in ( .\temp\Temp_HDR10_Finale.txt) do ( 
                                                            if !x2!==1 (
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=Dolby Vision Metadata"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==1 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        goto solodv
                                                                                                        )
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=HDR Dynamic Metadata SMPTE2094-40 (HDR10+)"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==1 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        goto solohdr10plus
                                                                                                        )

                                                                        echo %%b
                                                                        echo.
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==2 ( 
                                                                        echo %%a = %%b  
                                                                        set "redx=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==3 ( 
                                                                        echo %%a = %%b  
                                                                        set "redy=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==4 ( 
                                                                        echo %%a = %%b  
                                                                        set "greenx=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==5 ( 
                                                                        echo %%a = %%b  
                                                                        set "greeny=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==6 ( 
                                                                        echo %%a = %%b  
                                                                        set "bx=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==7 ( 
                                                                        echo %%a = %%b  
                                                                        set "by=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==8 ( 
                                                                        echo %%a = %%b  
                                                                        set "wpx=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==9 ( 
                                                                        echo %%a = %%b  
                                                                        set "wpy=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==10 ( 
                                                                        echo %%a = %%b  
                                                                        set "minl=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==11 ( 
                                                                        echo %%a = %%b  
                                                                        set "maxl=%%b"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==12 (
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=Dolby Vision Metadata"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==12 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        set /a dvp=1
                                                                                                        ) 
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=HDR Dynamic Metadata SMPTE2094-40 (HDR10+)"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==12 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        set /a hdr10pp=1
                                                                                                        )
                                                                        if !dvp!==1 ( 
                                                                                    echo.
                                                                                    echo !t9!
                                                                                    )
                                                                        if !hdr10pp!==1 ( 
                                                                                        echo.
                                                                                        echo !t10!
                                                                                        )
                                                                        
                                                                        if !dvp!==0 if !hdr10pp!==0 (
                                                                                                echo.
                                                                                                echo %%b
                                                                                                echo.
                                                                                                rem echo !x2!
                                                                                                )
                                                                        
                                                                        )
                                                            if !x2!==13 (
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=Dolby Vision Metadata"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==13 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        set /a dvp=1
                                                                                                        ) 
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=HDR Dynamic Metadata SMPTE2094-40 (HDR10+)"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==13 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        set /a hdr10pp=1
                                                                                                        )
                                                                        if !dvp!==1 ( 
                                                                                    echo.
                                                                                    echo !t9!
                                                                                    )
                                                                        if !hdr10pp!==1 ( 
                                                                                        echo.
                                                                                        echo !t10!
                                                                                        )
                                                                        
                                                                        if !dvp!==0 if !hdr10pp!==0 ( 
                                                                                                echo %%a = %%b  
                                                                                                set "maxc=%%b"
                                                                                                set "maxcpresent=1"
                                                                                                rem echo !x2!
                                                                                                )
                                                                        )
                                                            if !x2!==14 ( 
                                                                        echo %%a = %%b  
                                                                        set "maxa=%%b"
                                                                        set "maxapresent=1"
                                                                        rem echo !x2!
                                                                        )
                                                            if !x2!==15 (
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=Dolby Vision Metadata"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==15 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        set /a dvp=1
                                                                                                        ) 
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=HDR Dynamic Metadata SMPTE2094-40 (HDR10+)"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==15 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        set /a hdr10pp=1
                                                                                                        )
                                                                        if !dvp!==1 ( 
                                                                                    echo.
                                                                                    echo !t9!
                                                                                    )
                                                                        if !hdr10pp!==1 ( 
                                                                                        echo.
                                                                                        echo !t10!
                                                                                        )
                                                                        )
                                                            if !x2!==16 (
                                                                        set "dvver=%%b"
                                                                        rem echo dvver = !dvver!
                                                                        set "dvc=Dolby Vision Metadata"
                                                                        rem echo dvc = !dvc!
                                                                        if !x2!==16 if !dvver!==!dvc!  (  
                                                                                                        rem echo dvver = !dvver!
                                                                                                        set /a dvp=1
                                                                                                        ) 
                                                                        if !dvp!==1 ( 
                                                                                    echo.
                                                                                    echo !t9!
                                                                                    )
                                                                        )
                                                            set /A x2+=1
)

rem echo maxapresent = %maxapresent%
rem echo maxcpresent = %maxcpresent%


if %maxapresent%==1 if %maxcpresent%==1 (
                                        echo.
                                        echo FFmpeg Settings x265:  
                                        echo master-display=G^(!greenx!,!greeny!^)B^(!bx!,!by!^)R^(!redx!,!redy!^)WP^(!wpx!,!wpy!^)L^(!maxl!,!minl!^):max-cll=!maxc!,!maxa!
                                        echo.
                                        echo NVEnc Settings x265:  
                                        echo --master-display ^"G^(!greenx!,!greeny!^)B^(!bx!,!by!^)R^(!redx!,!redy!^)WP^(!wpx!,!wpy!^)L^(!maxl!,!minl!^)^" --max-cll ^"!maxc!,!maxa!^"  
                                        echo.
                                        )

if %maxapresent%==0 if %maxcpresent%==0 (
                                        echo.
                                        echo FFmpeg Settings x265:  
                                        echo master-display=G^(!greenx!,!greeny!^)B^(!bx!,!by!^)R^(!redx!,!redy!^)WP^(!wpx!,!wpy!^)L^(!maxl!,!minl!^)
                                        echo.
                                        echo NVEnc Settings x265:  
                                        echo --master-display ^"G^(!greenx!,!greeny!^)B^(!bx!,!by!^)R^(!redx!,!redy!^)WP^(!wpx!,!wpy!^)L^(!maxl!,!minl!^)^"  
                                        echo.
                                        )


goto finerealehdr


:solohdr10plus
echo !t11!
echo.
goto finerealehdr

:solodv
echo !t11!
echo.
goto finerealehdr

:novideofile
echo !t12!
echo.
goto finerealehdr

:finehdr
echo !t13!
echo.


:finerealehdr

if exist ".\temp\Temp_HDR10_Stream.txt" ( 
                                    del .\temp\Temp_HDR10_Stream.txt 
                                    ) 
if exist ".\temp\Temp_HDR10.txt" ( 
                            del .\temp\Temp_HDR10.txt 
                            )
if exist ".\temp\Temp_HDR10_Finale.txt" ( 
                                    del .\temp\Temp_HDR10_Finale.txt 
                                    )



set waitenter=
set /P waitenter=!t14!
Endlocal
goto puliziainiziale
rem master-display=G(13250,34500)B(7500,3000)R(34000,16000)WP(15635,16450)L(10000000,1):max-cll=978,233



:finescript
cls